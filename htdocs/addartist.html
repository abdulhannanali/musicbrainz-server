%# vi: set ts=2 sw=2 ft=mason :
<%args>
$name => ""
$sortname => ""
$type => 0
$resolution => ""
$begindate_y => ""
$begindate_m => ""
$begindate_d => ""
$enddate_y => ""
$enddate_m => ""
$enddate_d => ""
$typechanged => 0
$notetext => ""
$initial_name => ""
$confirm => ""
</%args>
<%perl>


MusicBrainz::IsSingleLineString($name)
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsSingleLineString($sortname)
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsSingleLineString($resolution)
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($type) && Artist::IsValidType($type)
	or return $m->comp("/comp/badargs", 1, 1);

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");

# Try to load the named artist by name. If an artist comes up, give the user a stern warning
# about adding a duplicate artist.
my ($samecheck, $same) = (1,0);
my $ar = Artist->new($mb->{DBH});
if ($name)
{
	  my $artists = $ar->GetArtistsFromName($name);
		if (scalar(@$artists))
		{
			  foreach my $item (@$artists)
				{
						$same = lc($item->GetName) eq lc($name);
						$samecheck = ($same && $resolution ne '' && $confirm ne '') ? 1 : 0 if ($same);
						if ($same)
						{
							 $ar = $item;
							 last;
						}
				}
		}
}

# If anything has been filled in, the user has clicked 'submit'.
# We only accept valid dates or no dates at all.
if ($name =~ m/\S/ 
    and $samecheck
		and not $typechanged
	  and MusicBrainz::IsValidDateOrEmpty($begindate_y, $begindate_m, $begindate_d)
	  and MusicBrainz::IsValidDateOrEmpty($enddate_y, $enddate_m, $enddate_d)
	  and MusicBrainz::IsDateEarlierThan($begindate_y, $begindate_m, $begindate_d,
	  																		$enddate_y, $enddate_m, $enddate_d)
  	and Artist::IsValidType($type) )
{
  # If the artist is not deemed to be the same as another artist, don't save the comment
  $resolution = "" if (!$same);

	my $ret = $m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_ADD_ARTIST,
				# --
				name => $name,
				sortname => $sortname,
				artist_type => $type,
				artist_resolution => $resolution,
				artist_begindate => [ $begindate_y, $begindate_m, $begindate_d ],
				artist_enddate => [ $enddate_y, $enddate_m, $enddate_d ],
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;

			# Return the mods inserted - see below
			@mods;
		},
	) or return;

	my $url = "/search.html";
	(my $addmod) = grep { $_->Type eq &ModDefs::MOD_ADD_ARTIST } @$ret;
	$url = "/showartist.html?artistid=" . $addmod->GetRowId
		if $addmod;
	$m->comp("/comp/redirect", $url);

	die "Shouldn't get here";
}

my $error_msg;
unless (
		MusicBrainz::IsValidDateOrEmpty($begindate_y, $begindate_m, $begindate_d)
	and MusicBrainz::IsValidDateOrEmpty($enddate_y, $enddate_m, $enddate_d)
	and MusicBrainz::IsDateEarlierThan($begindate_y, $begindate_m, $begindate_d,
																			$enddate_y, $enddate_m, $enddate_d) )
{
	$error_msg = 'Please enter valid dates';
}

</%perl>

<& /comp/sidebar, title => 'Add Artist' &>

<& /comp/stylemenu &>

<h2>Add Artist</h2>

% if (defined $error_msg) {
	<p style="color: red">
		<% $error_msg %>
	</p>
% }

% if ($ar->GetId) {
	<div style="border-width: 2px; border-style: dotted; border-color: red; margin: 1em; padding: 1em;">
  <p>
  <span style="color: red; font-weight: bold;">Warning!</span> You are attempting to add the artist "<% $name %>"
	which is very similar, if not exactly the same as the existing artist <a href="/artist/<% $ar->GetMBId %>.html"><% $ar->GetName %></a>.
	</p>

	<p>
	If you are certain that you want to add this artist, please check the <b>confirm</b> checkbox below,
	and submit this page again.
  </p>

% if (!$resolution && lc($ar->GetName) eq lc($name)) {
     <p>
     You <b>must</b> provide a comment to distinguish this new artist from artist <a href="/artist/<% $ar->GetMBId %>.html"><% $ar->GetName %></a>.
     </p>
% }
	</div>
% }

<p>
	You are about to add an artist to MusicBrainz.&nbsp;
</p>

<& /mod/edit-artist/main-form,
		action			=> '/addartist.html',
		name				=> $name || $initial_name,
		sortname		=> $sortname,
		type				=> $type,
		resolution	=> $resolution,
		begindate		=> [ $begindate_y, $begindate_m, $begindate_d ],
		enddate			=> [ $enddate_y, $enddate_m, $enddate_d ],
		notetext		=> $notetext,
		confirm     => $same,
&>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$albumid => ""
$mbid => ""
$disciddetail => ""
</%args>
<%perl>

if ($mbid ne "")
{
	MusicBrainz::IsGUID($mbid)
		or return $m->comp("/comp/badargs", 1, 1);
} else {
	MusicBrainz::IsNonNegInteger($albumid) && $albumid
		or return $m->comp("/comp/badargs", 1, 1);
}

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
if ($mbid ne "")
{
	$al->SetMBId($mbid);
} else {
	$al->SetId($albumid);
}
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album #$albumid not found",
		1, 1,
	);

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist not found",
		1, 1,
	);

</%perl>

<& /comp/sidebar, title => "Album Details: " . $al->GetName &>

<& /comp/albuminfo, album => $al &>
<& /comp/artistinfo, artist => $ar &>

<%perl>
$al->GetDiscidCount;
my @ids = @{ $al->GetDiscIDs };

use List::Util qw( max );
my $maxtracks = max(map { $_->GetCDTOC->GetTrackCount } @ids);

</%perl>

% if (@ids) {
<p>
	Show Disc ID detail:
	<a href="?albumid=<% $al->GetId %>&amp;disciddetail=times">times</a>
	| <a href="?albumid=<% $al->GetId %>&amp;disciddetail=sectors">sectors</a>
	| <a href="?albumid=<% $al->GetId %>&amp;disciddetail=both">both</a>
</p>

% if ($disciddetail) {
<table>
	<tr>
		<td>DiscID</td>
		<td>Tracks</td>
		<td>Total Length</td>
% for (1..$maxtracks) {
		<td align="center"><% $_ %></td>
% }
	</tr>
% my $row = 0;
% for my $cdtoc (map { $_->GetCDTOC } @ids) {
% my $style = (++$row % 2 ? "background-color: #eee" : "");
	<tr style="<% $style |n %>">
		<td><a href="/showcdtoc.html?id=<% $cdtoc->GetId %>" title="FreeDB Id: <% $cdtoc->GetFreeDBID %>"><% $cdtoc->GetDiscID %></a></td>
		<td><% $cdtoc->GetTrackCount %></td>
% if ($disciddetail =~ /(times|both)/) {
		<td><% Track::FormatTrackLength($cdtoc->GetLeadoutOffset/75*1000) %></td>
% for (@{ $cdtoc->GetTrackLengths }) {
		<td><% Track::FormatTrackLength($_/75*1000) %></td>
% }
% }
% if ($disciddetail =~ /(both)/) {
	</tr>
	<tr style="<% $style |n %>">
		<td align="right" colspan="2">Sector offsets: &nbsp; </td>
% }
% if ($disciddetail =~ /(sectors|both)/) {
		<td><% $cdtoc->GetLeadoutOffset %></td>
% for (@{ $cdtoc->GetTrackOffsets }) {
		<td><% $_ %></td>
% }
% }
	</tr>
% }
</table>

<p>
	(<a href="?albumid=<% $al->GetId %>">Hide Disc ID detail</a>)
</p>
% }

% }

<& /comp/footer &>

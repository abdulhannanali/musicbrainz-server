<%perl>

# This script is designed as a pass-through script. All the data passed
# in gets passed along unmodified, with the exception of the artistfield.
# Which field/var to use, depends on the mode -- normally argument
# new0 should be used, except for the add track to MAC case.
# $argname specifies the name of the argument to perform the artist search on
# $dest_argname is the name of the argument where the sortname of a new
#               artist should be stored.

my ($mb, $i, $j, $mod, $new, @names, $ar, $arg, $argname, $dest_argname);
my ($sortname, $name, $key, $found, $mode, $num_found, $id);

if (!exists $ARGS{new0} || $ARGS{new0} eq '' ||
    !exists $ARGS{mode} || $ARGS{mode} eq '')
{
    mc_comp("/comp/badargs");
    return undef;
}
$mode = $ARGS{mode};

$argname = "new0";
$dest_argname = "extra0-0";
mc_comp("/comp/sidebar", title=>'Select Artist for Album Move') 
    if ($mode eq 'move');
mc_comp("/comp/sidebar", title=>'Select Artist for Change to Single Artist')
    if ($mode eq 'tosac');
mc_comp("/comp/sidebar", title=>'Select Artist for Album Merge') 
    if ($mode eq 'merge');
mc_comp("/comp/sidebar", title=>'Select Artist for Track Change') 
    if ($mode eq 'track');
if ($mode eq 'addtrack')
{
   mc_comp("/comp/sidebar", title=>'Select Artist for Track Addition');
   $argname = "extra0-2";
   $dest_argname = "extra0-3";
}
$arg = $ARGS{$argname};

$mb = new MusicBrainz;
$mb->Login();

$ar = Artist->new($mb->{DBH});
@names = $ar->FindArtist($arg);

$found = 0;
foreach $key (@names)
{
    if (lc($key) eq lc($arg))
    {
       $found = 1;
       last;
    }
}
$num_found = scalar(@names);
</%perl>

A search on <font class="bold"><% $arg %></font>
has turned up the following matching artists that are similar to the 
artist name that you just entered. 

% if ($mode eq 'move') {
Please choose one of the artists below, and click Finish>> to
move album <span class="bold"><% $ARGS{album} %></span> to the selected artist:
% } elsif ($mode eq 'tosac') {
Please choose one of the artists below, and click Finish>> to
change the multiple artist album <span class="bold"><% $ARGS{album} %></span> to the selected single artist:
% } elsif ($mode eq 'merge') {
Please choose one of the artists below, and click Finish>> to
merge artist <span class="bold"><% $ARGS{prev0} %></span> with the selected artist:
% } elsif ($mode eq 'addtrack') {
Please choose one of the artists below, and click Finish>> to
add this track to album <span class="bold"><% $ARGS{prev0} %></span> with the selected artist:
% } else {
Please choose one of the artists below, and click Finish>> to
move track <span class="bold"><% $ARGS{prev0} %></span> to the selected artist:
% }

<form method="POST" action="/bare/enter_mod.html" NAME="ArtistFilter"
      enctype="application/x-www-form-urlencoded" class="formstyle">

% if (!$found && $mode ne 'merge') {
   <& /comp/tablebegin, title=>'New Artist', gattrs=>'width="100%"' &>
   <table width="100%"> <tr>
   <th width="50%">Artist Sortname</th>
   <th width="50%">Artist Name</th>
   </tr>
   <td>
   <input type="radio" name="<% $argname %>" 
          value="<% $arg %>" CHECKED>&nbsp;<% $arg %>
   </td><td>
   Enter artist name if different from sort name:<br>
   <input type="text" name="<% $dest_argname %>" SIZE=15> 
   </td></tr></table>
   <& /comp/tableend &>
%}

% if ($num_found > 0) {

    <& /comp/tablebegin, title=>'Existing Artists', gattrs=>'width="100%"' &>
    <table width="100%"> <tr>
    <th width="50%">Artist Sortname</th>
    <th width="50%">Artist Name</th>
    </tr>

<%perl>
    for($i = 0;; $i++)
    {
        $id = shift @names;
        last if not defined $id;
        $name = shift @names;
        last if not defined $name;
        $sortname = shift @names;
        last if not defined $sortname;
        mc_out("<tr><td>");
        mc_out(qq\<input type="radio" name="$argname" 
               value="$name"\);
        mc_out(" CHECKED") if ($i == 0 && $found);
        mc_out(">&nbsp;$sortname</td><td>$name</td></tr>");
    }
    mc_out("</table>");
    mc_comp("/comp/tableend");
}

if ($num_found == 0 && $mode eq 'merge') 
{
</%perl>
    <& /comp/tablebegin, title=>'No Artists Found', gattrs=>'width="100%"' &>
    <br>&nbsp;&nbsp;<span class="bold">No artists found.</span>
    Please <a href="<% $ARGS{url} %>">try again</a>.<p><br>
    <& /comp/tableend &>
<%perl>
}

foreach $key (keys %ARGS)
{
    next if ($key eq $argname);

</%perl>
    <input type="hidden" name="<% $key %>" value="<% $ARGS{$key} %>">
<%perl>
}
$mb->Logout();
</%perl>

<input type="submit" value="Finish>>" name="Finish">
</form>


%# vi: set ts=8 sw=4 ft=mason :
<%args>
@artistfilter_dontshow => ()
</%args>
<%perl>

# This script is designed as a pass-through script. All the data passed
# in gets passed along unmodified, with the exception of the artistfield.
# Which field/var to use, depends on the mode -- normally argument
# new0 should be used, except for the add track to MAC case.
# $argname specifies the name of the argument to perform the artist search on
# $dest_argname is the name of the argument where the sortname of a new
#               artist should be stored.

my ($mb, $i, $j, $mod, $new, $arg, $argname, $dest_argname, $key);
my ($sortname, $name, $mode, $id, $eng, $ar);
my ($artist, @names);

if (!exists $ARGS{new0} || $ARGS{new0} eq '' ||
    !exists $ARGS{mode} || $ARGS{mode} eq '')
{
    mc_comp("/comp/badargs", 1, 1);
    return undef;
}
$mode = $ARGS{mode};

$argname = "new0";
$dest_argname = "extra0-0";
mc_comp("/comp/sidebar", title=>'Select Artist for Album Move') 
    if ($mode eq 'move');
mc_comp("/comp/sidebar", title=>'Select Artist for Change to Single Artist')
    if ($mode eq 'tosac');
mc_comp("/comp/sidebar", title=>'Select Artist for Artist Merge') 
    if ($mode eq 'merge');
mc_comp("/comp/sidebar", title=>'Select Artist for Track Change') 
    if ($mode eq 'track');
if ($mode eq 'addtrack')
{
   mc_comp("/comp/sidebar", title=>'Select Artist for Track Addition');
   $argname = "extra0-2";
   $dest_argname = "extra0-3";
}
$arg = $ARGS{$argname};

$mb = mc_comp("/comp/dblogin");

my %dontshow = map { $_=>1 } @artistfilter_dontshow;

$ar = Artist->new($mb->{DBH});
# try to load the artist. If that artist is not found, then try a search
if ($ar->LoadFromName($arg))
{
    $artist = { name=>$ar->GetName(), 
                sortname=>$ar->GetSortName(), 
		id=>$ar->GetId() };

    $artist = undef
	if $dontshow{ $artist->{id} };
}

{
    $eng = SearchEngine->new($mb->{DBH});
    $eng->Table("Artist");

    $eng->Search(
	query => $arg,
	limit => 0,
    );
    
    while (my $row = $eng->NextRow)
    {
	next if $dontshow{ $row->{artistid} };
	next if $artist and $row->{artistid} eq $artist->{id};
	push @names, {
	    id		=> $row->{'artistid'},
	    name	=> $row->{'artistname'},
	    sortname	=> $row->{'artistsortname'},
	};
    }
}

</%perl>

<p>
A search on <font class="bold"><% $arg %></font>
has turned up the following matching artists that are similar to the 
artist name that you just entered. 
</p>

<%perl>
# If we're merging an album, and we didn't find any matches, complain.
if (!defined $artist && scalar(@names) == 0 && 
   ($mode eq 'merge' || $mode eq 'move')) 
{
    </%perl>
    <& /comp/tablebegin, title=>'No Artists Found', gattrs=>'width="100%"' &>
    <p style="margin: 1em">
	<span class="bold">No artists found.</span>&nbsp;
	Please <a href="<% $ARGS{url} %>">try again</a>.
    </p>
    <& /comp/tableend &>
%   return undef;
    <%perl>
}

</%perl>

<p>
% if ($mode eq 'move') {
Please choose one of the artists below, and click Finish &gt;&gt; to
move album <span class="bold"><% $ARGS{album} %></span> to the selected artist:
% } elsif ($mode eq 'tosac') {
Please choose one of the artists below, and click Finish &gt;&gt; to
change the multiple artist album <span class="bold"><% $ARGS{album} %></span> to the selected single artist:
% } elsif ($mode eq 'merge') {
Please choose one of the artists below, and click Finish &gt;&gt; to
merge artist <span class="bold"><% $ARGS{prev0} %></span> with the selected artist:
% } elsif ($mode eq 'addtrack') {
Please choose one of the artists below, and click Finish &gt;&gt; to
add this track to album <span class="bold"><% $ARGS{prev0} %></span> with the selected artist:
% } else {
Please choose one of the artists below, and click Finish &gt;&gt; to
move track <span class="bold"><% $ARGS{prev0} %></span> to the selected artist:
% }
</p>

<form method="POST" action="/bare/enter_mod.html" NAME="ArtistFilter"
      enctype="application/x-www-form-urlencoded" class="formstyle">

% if (defined $artist || scalar(@names) > 0) {
    <& /comp/tablebegin, title=>'Matching Artists', gattrs=>'width="100%"' &>
    <table width="100%"> <tr>
    <th width="50%">Artist Sortname</th>
    <th width="50%">Artist Name</th>
    </tr>

%   if (defined $artist) {
       <tr><td>
       <input type="radio" name="<% $argname %>" value="<% $artist->{name} |h %>"
       CHECKED>&nbsp;<% $artist->{sortname} %></td>
       <td><a href="showartist.html?artistid=<% $artist->{id} %>"><% $artist->{name} %></a></td>
       </tr>
%   }
%   $i = 0;
%   foreach $name (@names) {
        <tr><td>
        <input type="radio" name="<% $argname %>" value="<% $name->{name} |h %>"
%       if ($i == 0 && !defined $artist) {
           CHECKED
%       }
	>&nbsp;<% $name->{sortname} %></td>
	<td><a href="showartist.html?artistid=<% $name->{id} %>"><% $name->{name} %></a></td>
	</tr>
%       $i++;
%   }
    </table>
    <& /comp/tableend &>
    <%perl>
}

# If were doing anything but merging, give the user the option to create
# a new artist
if ($mode ne 'merge') 
{
   </%perl>
   <& /comp/tablebegin, title=>'New Artist', gattrs=>'width="100%"' &>
   <table width="100%"> <tr>
   <th width="50%">Artist Sortname</th>
   <th width="50%">Artist Name</th>
   </tr>
   <td>
   <input type="radio" name="<% $argname %>" 
%       if (not defined($artist) and not @names) {
           checked
%       }
          value="<% $arg |h %>">&nbsp;<% $arg %>
   </td><td>
   Enter artist name if different from sort name:<br>
   <input type="text" name="<% $dest_argname %>"
	style="width: 100%"
	value="<% $ARGS{$dest_argname} || '' %>"
	> 
   </td></tr></table>
   <& /comp/tableend &>
   <%perl>
}

foreach $key (keys %ARGS)
{
    next if ($key eq $argname);

</%perl>
    <input type="hidden" name="<% $key %>" value="<% $ARGS{$key} |h %>">
<%perl>
}
$mb->Logout();
</%perl>

<input type="submit" value="Finish &gt;&gt;" name="Finish">
</form>

<& /comp/movefocus, "ArtistFilter", $argname, 0 &>
<& /comp/footer &>

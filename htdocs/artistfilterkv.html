%# vi: set ts=4 sw=4 ft=mason :
<%perl>

# This script is designed as a pass-through script. All the data passed
# in gets passed along unmodified, with the exception of the SortName
# and ArtistName fields.

my ($mb, $i, $j, $mod, $new, @names, $ar, $name, $key, $sortnamevalue);
my ($sortname, $artist, $mode, $id, $artistnamevalue, $eng);

# Find which key value pairs contain the artist and sort names
foreach $key (keys %ARGS)
{
    if ($ARGS{$key} eq 'SortName')
    {
       $key =~ m/key(\d?)/;
       $sortnamevalue = "value$1"; 
       $name = $ARGS{"value$1"};
    }
    if ($ARGS{$key} eq 'ArtistName')
    {
       $key =~ m/key(\d?)/;
       $artistnamevalue = "value$1"; 
    }
    last if (defined $sortnamevalue && defined $artistnamevalue);
}

# Check to make sure we found the name
if (!defined $name || !defined $artistnamevalue || !defined $sortnamevalue)
{
    mc_comp("/comp/sidebar", title=>'Error');
    mc_comp("/comp/badargs");
    return undef;
}

# Do some housekeeping
mc_comp("/comp/sidebar", title=>$ARGS{title});

$mb = mc_comp("/comp/dblogin");

$ar = Artist->new($mb->{DBH});
# try to load the artist. If that artist is not found, then try a search
if ($ar->LoadFromName($name))
{
    $artist = { name=>$ar->GetName(),
                sortname=>$ar->GetSortName(),
                id=>$ar->GetId() };
}
else
{
    $artist = undef;

    $eng = SearchEngine->new($mb->{DBH});
    $eng->Table("Artist");

    $eng->Search(
		query => $name,
		limit => 0,
    );

    while (my $row = $eng->NextRow)
    {
		push @names, {
			id		=> $row->{'artistid'},
			name	=> $row->{'artistname'},
			sortname=> $row->{'artistsortname'},
		};
    }
}

# Present the found results to the user
</%perl>

A search on <font class="bold"><% $name %></font>
has turned up the following matching artists that are similar to the 
artist name that you just entered. 

Please choose one of the artists below, and then click Finish &gt;&gt;.

<form method="POST" action="/bare/enter_kv_mod.html" NAME="ArtistFilter"
      enctype="application/x-www-form-urlencoded" class="formstyle">

% if (defined $artist || scalar(@names) > 0) {

    <& /comp/tablebegin, title=>'Existing Artists', gattrs=>'width="100%"' &>
    <table width="100%"> <tr>
    <th width="50%">Artist Sortname</th>
    <th width="50%">Artist Name</th>
    </tr>

%   if (defined $artist) {
       <tr><td>
       <input type="radio" name="<% $artistnamevalue %>" value="<% $artist->{name} |h %>"
       CHECKED>&nbsp;<% $artist->{sortname} %></td><td><% $artist->{name} %>
       </td></tr>
%   }

<%perl>
    $i = 0;
    foreach $key (@names)
    {
        mc_out("<tr><td>");
        mc_out(qq\<input type="radio" name="$artistnamevalue"
                  value="$key->{name}"\);
        mc_out(" CHECKED") if ($i == 0 && !defined $artist);
        mc_out(">&nbsp;$key->{name}</td><td>$key->{sortname}</td></tr>");
    }
    mc_out("</table>");
    mc_comp("/comp/tableend");
}

if (!defined $artist) {
   </%perl>
   <& /comp/tablebegin, title=>'New Artist', gattrs=>'width="100%"' &>
   <table width="100%"> <tr>
   <th width="50%">Artist Sortname</th>
   <th width="50%">Artist Name</th>
   </tr>
   <td>
   <input type="radio" name="<% $artistnamevalue %>" 
          value="<% $name %>" CHECKED>&nbsp;<% $name %>
   </td><td>
   Enter artist name if different from sort name:<br>
   <input type="text" name="<% $sortnamevalue %>" SIZE=15> 
   </td></tr></table>
   <& /comp/tableend &>
   <%perl>
}

foreach $key (keys %ARGS)
{
    next if ($key eq "title");
    next if ($key eq $sortnamevalue);
    next if ($key eq $artistnamevalue);

</%perl>
    <input type="hidden" name="<% $key %>" value="<% $ARGS{$key} %>">
<%perl>
}
$mb->Logout();
</%perl>

<input type="submit" value="Finish &gt;&gt;" name="Finish">
</form>

<& /comp/footer &>

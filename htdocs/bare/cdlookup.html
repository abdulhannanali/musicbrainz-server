%# vi: set ts=2 sw=2 ft=mason :
<%args>
$id
$tracks=>""
$toc=>""
</%args>
<%perl>
use CGI;

# For some reason, in order to precompile, $r needs to be declared:
use vars qw( $r );

my ($mb, $al, $url, $album, $valid, $di);


$valid = $id;
$valid =~ tr/_.\-A-Za-z0-9//d;

if (!defined $id || $id eq '')
{
    $m->comp("/comp/sidebar", title=>"Lookup Error");
    $m->out("This page needs the id argument.");
    $m->comp("/comp/footer");
}
elsif (length($id) != 28 || substr($id, -1, 1) ne "-" || $valid ne "")
{
    $m->comp("/comp/sidebar", title=>"Lookup Error");
    $m->out("The disk id you are trying to lookup ($id) is invalid.");
    $m->comp("/comp/footer");
}
else
{
    $mb = $m->comp("/comp/dblogin");
    $di = Discid->new($mb->{DBH});
    $album = $di->GetAlbumFromDiscid($id);
    if (defined $album)
    {
        $url = "/showalbum.html?albumid=$album";
    }
    else
    {
        if ($tracks eq '' || $toc eq '')
        {
            $m->comp("/comp/sidebar", title=>"CD Not Found");
            $m->out("This CD was not found.<p>");
            $m->out(qq|NOTE: If you pass the toc and tracks argument 
                      to this page, you will be automatically redirected
                      to the proper submit page)|);
            $m->comp("/comp/footer");

            $url = "";
        }
        else
        {
            # redirect to submit
            $toc = CGI::escape($toc);
            $url = "/cdi/submit.html?id=$id&tracks=$tracks&toc=$toc&notfound=1";
        }
    }

    if ($url ne "")
    {
        $r->method('GET');
        $r->headers_in->unset('Content-length');
        
        $r->content_type('text/html; charset=UTF-8');
        $r->header_out(Location=>$url);
        $r->status(302);
    }

    $mb->Logout();
}

</%perl>

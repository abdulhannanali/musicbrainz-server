<%perl>

sub CheckArg
{
    my ($args, $name) = @_;

    if (!defined($args->{$name}))
    {
       print STDERR "enter_kv_mod: $name not defined\n";
       return 0;
    }
    return 1;
}
   
my ($mb, $i, $j, $mod, $new, $modid, $depmod, $url);

print STDERR "enter_kv_mod: ==========================================================\n";
print STDERR Data::Dumper->Dump([%ARGS], ["ARGS"]);

$mb = new MusicBrainz;
$mb->Login();

print STDERR "Sanity check\n";
if (CheckArg(\%ARGS, 'column') &&
    CheckArg(\%ARGS, 'key0') &&
    CheckArg(\%ARGS, 'value0') &&
    CheckArg(\%ARGS, 'prev') &&
    CheckArg(\%ARGS, 'artist') &&
    CheckArg(\%ARGS, 'type') &&
    CheckArg(\%ARGS, 'table') &&
    CheckArg(\%ARGS, 'id')) 
{
    print STDERR "Sanity check ok\n";
    for($i = 0;; $i++)
    {
        last if (!exists $ARGS{"key$i"} || !exists $ARGS{"value$i"});

        $new .= $ARGS{"key$i"} . "=" . $ARGS{"value$i"} . "\n";
    }

    print STDERR join(" - ", $ARGS{'table'}, 
       $ARGS{'column'}, $ARGS{'artist'}, 
       $ARGS{'type'}, $ARGS{'id'},
       $ARGS{'prev'}, $new, $session{uid}) . "\nNew:\n$new\n";

    $mod = Moderation->new($mb->{DBH});
    $mod = $mod->CreateModerationObject($ARGS{'type'});
    if (defined $mod)
    {
        print STDERR "Created moderation\n";
        $mod->SetTable($ARGS{'table'});
        $mod->SetColumn($ARGS{'column'});
        $mod->SetArtist($ARGS{'artist'});
        $mod->SetType($ARGS{'type'});
        $mod->SetRowId($ARGS{'id'});
        $mod->SetPrev($ARGS{'prev'});
        $mod->SetNew($new);
        $mod->SetModerator($session{uid});
        $mod->SetDepMod(0);

        # Do the prevote action (like insert data)
        $mod->PreVoteAction();

        # And now determine if there are any dependencies
        $mod->DetermineDependencies();

        # Go to the item that we just inserted...
        if ($mod->GetType() == ModDefs::MOD_ADD_ALBUM)
        {
            if ($mod->GetNew() =~ /^AlbumId=(.*)$/m)
            {
               $ARGS{url} = "/showalbum.html?albumid=$1";
            }
        }
        if ($mod->GetType() == ModDefs::MOD_ADD_ARTIST)
        {
            if ($mod->GetNew() =~ /^ArtistId=(.*)$/m)
            {
               $ARGS{url} = "/showartist.html?artistid=$1";
            }
        }
        print STDERR "Insert moderation\n";
        $modid = $mod->InsertModeration();
    }
}
print STDERR "enter_kv_mod done: =====================================================\n";
$mb->Logout();

$r->method('GET');
$r->headers_in->unset('Content-length');

$r->content_type('text/html');

if (exists $ARGS{choice} && lc($ARGS{choice}) eq 'no')
{
    $url = $ARGS{alturl};
}
else
{
    $url = $ARGS{url};
}

if ($url =~ s/&modid=\d*//g)
{
   $url .= "&modid=$modid" if (defined $modid);
}

# And if we have nothing, go to search...
if ($url eq '')
{
    $url = "/search.html";
}

$r->header_out(Location=>$url);
$r->status(302);

</%perl>

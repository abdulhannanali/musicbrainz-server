<%perl>

sub CheckKVArg
{
    my ($args, $name) = @_;

    if (!defined($args->{$name}))
    {
#       print STDERR "enter_kv_mod: $name not defined\n";
       return 0;
    }
    return 1;
}
   
my ($mb, $i, $j, $mod, $new, $modid, $depmod, $url, $sql);

$mb = mc_comp("/comp/dblogin");
$sql = Sql->new($mb->{DBH});

if (!exists $ARGS{confirm0} || $ARGS{confirm0} eq 'yes')
{
   # Untag the tagged albums
   delete $session{tagged_albums};

   #print STDERR "Sanity check\n";
   if (CheckKVArg(\%ARGS, 'column') &&
       CheckKVArg(\%ARGS, 'key0') &&
       CheckKVArg(\%ARGS, 'value0') &&
       CheckKVArg(\%ARGS, 'prev') &&
       CheckKVArg(\%ARGS, 'artist') &&
       CheckKVArg(\%ARGS, 'type') &&
       CheckKVArg(\%ARGS, 'table') &&
       CheckKVArg(\%ARGS, 'id')) 
   {
       for($i = 0;; $i++)
       {
           my $value;
           last if (!exists $ARGS{"key$i"} || !exists $ARGS{"value$i"});

           $value = $ARGS{"value$i"};
           $value =~ s/^\s*(.*?)\s*$/$1/;
           $new .= $ARGS{"key$i"} . "=$value\n";
       }

       #print STDERR "$new\n\n";
       #print STDERR join(" - ", $ARGS{'table'}, 
       #   $ARGS{'column'}, $ARGS{'artist'}, 
       #   $ARGS{'type'}, $ARGS{'id'},
       #   $ARGS{'prev'}, $new, $session{uid}) . "\nNew:\n$new\n";

       $mod = Moderation->new($mb->{DBH});
       $mod = $mod->CreateModerationObject($ARGS{'type'});
       if (defined $mod)
       {
           $mod->SetTable($ARGS{'table'});
           $mod->SetColumn($ARGS{'column'});
           $mod->SetArtist($ARGS{'artist'});
           $mod->SetType($ARGS{'type'});
           $mod->SetRowId($ARGS{'id'});
           $mod->SetPrev($ARGS{'prev'});
           $mod->SetNew($new);
           $mod->SetModerator($session{uid});
           $mod->SetDepMod(0);

           eval
           {
               $sql->Begin;
       
               # Do the prevote action (like insert data)
               if (!$mod->PreVoteAction())
               {
                   # If the PreVoteAction, failed, give the user an error.
                   mc_comp("/comp/sidebar", title=>"Insert moderation error",
                           expand=>'moderate');
    
                   mc_out("<p>Insert moderation error: ");
                   if (defined $mod->GetError())
                   {
                       mc_out($mod->GetError());
                   }
                   else
                   {
                       mc_out("Unknown error.\n");
                   }
                   mc_comp("/comp/footer");
                   return undef;
               }
    
               # And now determine if there are any dependencies
               $mod->DetermineDependencies();
    
               # Go to the item that we just inserted...
               if ($mod->GetType() == ModDefs::MOD_ADD_ALBUM)
               {
                   if ($mod->GetNew() =~ /^AlbumId=(.*)$/m)
                   {
                      $ARGS{url} = "/showalbum.html?albumid=$1";
                   }
               }
               if ($mod->GetType() == ModDefs::MOD_ADD_ARTIST)
               {
                   if ($mod->GetNew() =~ /^ArtistId=(.*)$/m)
                   {
                      $ARGS{url} = "/showartist.html?artistid=$1";
                   }
               }
               $modid = $mod->InsertModeration($session{privs});
    
               $sql->Commit;
           };
           if ($@)
           {
               my $err = $@;

               $sql->Rollback;
               mc_comp("/comp/sidebar", expand=>"moderation", 
                                       title=>'Moderation Error');
               mc_out("<b>A database error occurred.</b><pre>($err)</pre>");
               mc_comp("/comp/footer");
               return undef;
           }
       }
   }
   $mb->Logout();
}
else
{
    print STDERR "Mod not confirmed\n";
}

$r->method('GET');
$r->headers_in->unset('Content-length');

$r->content_type('text/html; charset=UTF-8');

if (exists $ARGS{choice} && lc($ARGS{choice}) eq 'no')
{
    $url = $ARGS{alturl};
}
else
{
    $url = $ARGS{url};
}

if ($url =~ s/&modid=\d*//g)
{
   $url .= "&modid=$modid" if (defined $modid);
}

# And if we have nothing, go to search...
if ($url eq '')
{
    $url = "/search.html";
}

$r->header_out(Location=>$url);
$r->status(302);

</%perl>

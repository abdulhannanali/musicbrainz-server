<%perl>

sub CheckArg
{
    my ($args, $index, $name) = @_;

    if (!defined($args->{($name . $index)}))
    {
       #print STDERR "enter_mod: $name$index not defined\n";
       return 0;
    }
    return 1;
}

my ($mb, $i, $j, $mod, $new, $modid, $depmod, $url, $sql);

#print STDERR "enter_mod: =============================================================\n";
#print STDERR Data::Dumper->Dump([%ARGS], ["ARGS"]);

$mb = mc_comp("/comp/dblogin");
$mod = Moderation->new($mb->{DBH});
$sql = Sql->new($mb->{DBH});

for($i = 0;; $i++)
{
#    print STDERR "Sanity check: $i\n";
    if ($ARGS{('new' . $i)} eq 'DELETE' && 
        $ARGS{('confirm' . $i)} ne 'yes')
    {
#        print STDERR "mod was not confirmed\n";
        last;
    }

    $depmod = 0;
    last if (!CheckArg(\%ARGS, $i, 'column'));
    last if (!CheckArg(\%ARGS, $i, 'new'));
    last if (!CheckArg(\%ARGS, $i, 'prev'));
    last if (!CheckArg(\%ARGS, $i, 'artist'));
    last if (!CheckArg(\%ARGS, $i, 'type'));
    last if (!CheckArg(\%ARGS, $i, 'table'));
    last if (!CheckArg(\%ARGS, $i, 'id'));
    if ($ARGS{('new' . $i)} eq '')
    {
#        print STDERR "enter_mod: empty new$i\n";
        next;
    }
    next if ($ARGS{('new' . $i)} eq $ARGS{('prev' . $i)});
    if (defined($ARGS{('depmod' . $i)}))
    {
       $depmod = $ARGS{('depmod' . $i)};
    }

    $new = $ARGS{'new' . $i}; 
    for($j = 0; ; $j++)
    {
        if (defined($ARGS{"extra$i-$j"}) && 
            $ARGS{"extra$i-$j"} ne '')
        {
            $new .= "\n" . $ARGS{"extra$i-$j"};
        }
        else
        {
            last;
        }
    }
#    print STDERR "Sanity check ok: $i\n";

#    print STDERR join(" - ", $ARGS{('table' . $i)}, 
#       $ARGS{('column' . $i)}, $ARGS{('artist' . $i)}, 
#       $ARGS{('type' . $i)}, $ARGS{('id' . $i)},
#       $ARGS{('prev' . $i)}, $new, $session{uid}, $depmod) . "\n";
    $mod->SetTable($ARGS{('table' . $i)});
    $mod->SetColumn($ARGS{('column' . $i)});
    $mod->SetArtist($ARGS{('artist' . $i)});
    $mod->SetType($ARGS{('type' . $i)});
    $mod->SetRowId($ARGS{('id' . $i)});
    $mod->SetPrev($ARGS{('prev' . $i)});
    $mod->SetNew($new);
    $mod->SetModerator($session{uid});
    $mod->SetDepMod($depmod);
#    print STDERR "Insert mod\n";

    eval
    {
        $sql->Begin;

        $modid = $mod->InsertModeration($session{privs});
        $modid = ($depmod == 0) ? $modid : $depmod;

        $sql->Commit;
    };
    if ($@)
    {
        my $err = $@;
        $sql->Rollback;
        mc_comp("/comp/sidebar", expand=>"moderation", 
                                title=>'Moderation Error');
        mc_out("<b>A database error occurred.</b><pre>($err)</pre>");
        mc_comp("/comp/footer");
        return undef;
    }
}
#print STDERR "enter_mod done: ========================================================\n";

$mb->Logout();

$r->method('GET');
$r->headers_in->unset('Content-length');

$r->content_type('text/html');

if (exists $ARGS{choice} && lc($ARGS{choice}) eq 'no')
{
    $url = $ARGS{alturl};
}
else
{
    $url = $ARGS{url};
}

if ($url =~ s/&modid=\d*//g)
{
    $url .= "&modid=$modid" if (defined $modid);
}

# And if we still don't have a valid place to go, go to the search page.
if ($url eq '')
{
    $url = "/search.html";
}

$r->header_out(Location=>$url);
$r->status(302);

</%perl>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$uid
$modid
$text
</%args>

<%perl>

use URI::Escape;

if ($text =~ /href\s*?=\s*?"(.*?)"/)
{
    my $addr = $1;

    if ($addr =~ /(^http:|^[^\/]|@)/)
    {
   		my $url = "/mod/addnote.html?modid=$modid&uid=$uid&text=" .
			uri_escape($text);
         $r->method('GET');
         $r->headers_in->unset('Content-length');
         $r->content_type('text/html; charset=UTF-8');
         $r->header_out(Location=>$url);
         $r->status(302);
     
         return undef;
     }
}

my ($mb, $mod, $sql);

$mb = $m->comp("/comp/dblogin");
$mod = Moderation->new($mb->{DBH});
$sql = Sql->new($mb->{DBH});

eval
{
    $sql->Begin;
    $mod->InsertModerationNote($modid, $uid, $text);
    $sql->Commit;
};
if ($@)
{
    my $err = $@;
    $sql->Rollback;
	</%perl>

	<& /comp/header_small, title => "Error adding moderation note" &>

	<p class="notice">
		An error occurred whilst saving your moderation note.&nbsp;
		Sorry.
	</p>

	<!-- <% $err %> -->

	<& /comp/footer_small &>

	<%perl>
    return undef;
}

</%perl>

<html>
<body>
<script type="text/javascript"><!--
window.close();
//--></script>
</body>
</html>

%# vi: set ts=4 sw=4 ft=mason :
<%perl>

my $ok = 0;
my $confirm = 0;
my $email = "";

if (&DBDefs::DB_READ_ONLY)
{
    $ok = 0;
}
elsif (defined $ARGS{User} && $ARGS{User} ne '' &&
       defined $ARGS{Password} && $ARGS{Password} ne '')
{
    my $mb = $m->comp("/comp/dblogin");
    my $ui = UserStuff->new($mb->{DBH});
    
	my $userobj = $ui->Login($ARGS{User}, $ARGS{Password});

    if ($userobj)
    {
		$userobj->SetSession;
		$session{'ipmask'} = $r->connection->remote_ip
			if $ARGS{OnlyThisIP};
		$userobj->SetPermanentCookie(only_this_ip => $ARGS{OnlyThisIP})
			if $ARGS{PermanentCookie};
		$ok = 1;
    }
}

my $url = $ARGS{url};
$url = "/search.html"
	unless defined $url;

# The MB Tagger still uses its own made-up encoding mechanism...
$url =~ s/\@Q\@/?/g;
$url =~ s/\@A\@/&/g;

# Prevent confusing redirect loops
$url = "/search.html"
	if $url =~ m[/(login|logout)\.html];

if (!$ok)
{
	$url = "/login.html?badlogin=1"
		. "&url=" . uri_escape($url)
		;
}
else
{
	$url = "/login.html?confirm=1"
		. "&email=" . uri_escape($email)
		. "&url=" . uri_escape($url)
		if $confirm;
}

return $m->comp("/comp/redirect", $url);

</%perl>

<%perl>

my ($mb, $user, $ok, $cookie, $privs, $uid, $url);

$ok = undef;
if (DBDefs::DB_READ_ONLY)
{
    $ok = 0;
}
elsif (defined $ARGS{User} && $ARGS{User} ne '' &&
       defined $ARGS{Password} && $ARGS{Password} ne '')
{
    $mb = MusicBrainz->new();
    $mb->Login();
    $user = UserStuff->new($mb->{DBH});
    
    ($ok, $user, $privs, $uid) = $user->Login($ARGS{User}, $ARGS{Password});
    if ($ok)
    {
        tie %HTML::Mason::Commands::session, 
           'Apache::Session::File', undef, 
           {
              Directory => DBDefs::SESSION_DIR,
              LockDirectory   => DBDefs::LOCK_DIR,
           };
        $cookie = new CGI::Cookie (-name=>'AF_SID',
                -value=>$HTML::Mason::Commands::session{_session_id},
                -path => '/',); 
        $r->headers_out->add('Set-cookie' => $cookie); 
        $session{user} = $user;
        $session{privs} = $privs;
        $session{uid} = $uid;  
        print STDERR "Login: $uid\n";
    }
    $mb->Logout();
}    

if (exists $ARGS{url})
{
    $url = $ARGS{url};
}
else
{
    $url = "/search.html";
}

if (!$ok)
{
    $url =~ s/\?/\@Q\@/g; 
    $url =~ s/\&/\@A\@/g; 
    $url = "/login.html?badlogin=1&url=$url";
}
else
{
    $url =~ s/\@Q\@/\?/g; 
    $url =~ s/\@A\@/\&/g; 
}
untie %HTML::Mason::Commands::session;

$r->method('GET');
$r->headers_in->unset('Content-length');
$r->content_type('text/html');
$r->header_out(Location=>$url);
$r->status(302);

</%perl>

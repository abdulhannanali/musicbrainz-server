%# vi: set ts=4 sw=4 ft=mason :
<%perl>

use URI::Escape;

my ($mb, $user, $ok, $privs, $uid, $url, $confirm, $email, $ui);

$ok = undef;
if (DBDefs::DB_READ_ONLY)
{
    $ok = 0;
}
elsif (defined $ARGS{User} && $ARGS{User} ne '' &&
       defined $ARGS{Password} && $ARGS{Password} ne '')
{
    $mb = mc_comp("/comp/dblogin");
    $ui = UserStuff->new($mb->{DBH});
    
    ($ok, $user, $privs, $uid, $email, $confirm) = $ui->Login($ARGS{User}, 
                                                             $ARGS{Password});
    if ($ok)
    {
        $ui->SetSession(\%session, $user, $privs, $uid, !$email || $confirm);
    }
    $mb->Logout();
}    

if (exists $ARGS{url})
{
    $url = $ARGS{url};
}
else
{
    $url = "/search.html";
}

if (!$ok)
{
    $url =~ s/\?/\@Q\@/g; 
    $url =~ s/\&/\@A\@/g; 
    $url = "/login.html?badlogin=1&url=$url";
}
else
{
    $url =~ s/\@Q\@/\?/g; 
    $url =~ s/\@A\@/\&/g; 
    $email = uri_escape($email);
    $url = "/login.html?confirm=1&email=$email&url=$url" if ($confirm);
}

$r->method('GET');
$r->headers_in->unset('Content-length');
$r->content_type('text/html; charset=UTF-8');
$r->header_out(Location=>$url);
$r->status(302);

</%perl>

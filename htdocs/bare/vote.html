%# vi: set ts=4 sw=4 ft=mason :
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my %votemap = (
	'yes'	=> &ModDefs::VOTE_YES,
	'no'	=> &ModDefs::VOTE_NO,
	'abs'	=> &ModDefs::VOTE_ABS,
);

my $url = $ARGS{url};

my %votes;

while (my ($key, $vote) = each %ARGS)
{
    my ($modid) = $key =~ /^rowid(\d+)$/
		or next;
	$vote = $votemap{$vote};
	$votes{$modid} = $vote
		if defined $vote;
}

%votes or return $m->comp("/comp/redirect", $url);

my $mb = $m->comp("/comp/dblogin");
my $v = MusicBrainz::Server::Vote->new($mb->{DBH});
my $sql = Sql->new($mb->{DBH});

eval
{
    $sql->Begin;
	$v->InsertVotes(\%votes, $session{uid});
    $sql->Commit;
};

if ($@)
{
    my $err = $@;
    $sql->Rollback;

	$m->comp("/comp/sidebar", expand=>"moderation", 
                            title=>'Insert Vote Error');
    $m->out("<b>A database error occurred.</b><pre>($err)</pre>");
	$m->comp("/comp/footer");
    return undef;
}

return $m->comp("/comp/redirect", $url);

</%perl>

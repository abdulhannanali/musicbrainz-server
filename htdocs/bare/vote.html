<%perl>

my ($mb, $mod, $key, @yeslist, @nolist, @abslist, $sql);
my $url = $ARGS{url};

foreach $key (keys %ARGS)
{
    if ($key =~ /^rowid(\d*)$/)
    {
       push @yeslist, $1 if ($ARGS{$key} eq 'yes');
       push @nolist, $1 if ($ARGS{$key} eq 'no');
       push @abslist, $1 if ($ARGS{$key} eq 'abs');
    }
}

$mb = mc_comp("/comp/dblogin");
$mod = Moderation->new($mb->{DBH});
$sql = Sql->new($mb->{DBH});

eval
{
    $sql->Begin;
    $mod->InsertVotes($session{uid}, \@yeslist, \@nolist, \@abslist);
    $sql->Commit;
};
if ($@)
{
    my $err = $@;
    $sql->Rollback;

    mc_comp("/comp/sidebar", expand=>"moderation", 
                            title=>'Insert Vote Error');
    mc_out("<b>A database error occurred.</b><pre>($err)</pre>");
    mc_comp("/comp/footer");
    return undef;
}

$mb->Logout();

$r->method('GET');
$r->headers_in->unset('Content-length');

$r->content_type('text/html');
$r->header_out(Location=>$url);
$r->status(302);

</%perl>

<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Returns a CDInfo xml document about the releases of a given discid.
	#
	# $Id$
	#
</%perl>
<%args>

	$id => ""
	$discid => ""

</%args>
%	$discid ||= $id;
%
% 	$r->content_type("text/xml; charset=ISO-8859-1");
% 	$m->clear_buffer;

<!DOCTYPE CDInfo SYSTEM "http://www.musicbrainz.org/dtd/CDInfo.dtd">s
<!-- This data is covered by the OpenContent license. -->
<!-- Please see http://opencontent.org/opl.shtml for details. -->

<?xml version="1.0" encoding="ISO-8859-1"?>

<%perl>

	my $MakeCDInfo = sub
	{
		my ($mb, $discid) = @_;
		my ($artist, $release, $di);
		my ($out, @tracks);

		$artist = MusicBrainz::Server::Artist->new($mb->{DBH});
		$release = MusicBrainz::Server::Release->new($mb->{DBH});
			$di = MusicBrainz::Server::ReleaseCDTOC->new($mb->{DBH});

		my $releaseids = $di->GetReleaseIDsFromDiscID($discid);
		if (not @$releaseids)
		{
			return "<CDInfo />";
		}

		# TODO cdtoc multiple releases
		my $releaseid = $releaseids->[0];
		$release->SetId($releaseid);
		if (!defined $release->LoadFromId())
		{
			print STDERR "Cannot load release $releaseid\n";
			return "<CDInfo />";
		}


		$artist = $release->GetArtist();
		$artist->SetId($artist);
		if (!defined $artist->LoadFromId())
		{
			print STDERR "Cannot load artist $artist\n";
			return "<CDInfo />";
		}

		$out .= "<CDInfo>\n  <Title>" . $release->GetName();
		$out .= "</Title>\n  <NumTracks>" . $release->GetTrackCount();
		$out .= "</NumTracks>\n";

		$out .= "  <IdInfo>\n";
			for my $ref ($release->GetDiscIDs)
		{
			$out .= "    <DiskId>\n";
			$out .= "      <Id>" . $ref->GetDiscID . "</Id>\n";
			{
				my ($sec, $i);

				$i = 0;
							$out .= "      <TOC First=\"" . $ref->GetFirstTrack . "\" Last=\"";
							$out .= $ref->GetLastTrack . "\">\n";
							my @toc = ($ref->GetLeadoutOffset, @{ $ref->GetTrackOffsets });

				foreach $sec (@toc)
				{
					$out .= "        <Offset Num=\"" . $i . "\">" .
							$sec . "</Offset>\n";
					$i++;
				}
				$out .= "      </TOC>\n";
			}
			$out .= "    </DiskId>\n";
		}
		$out .= "  </IdInfo>\n";

		my $num = 1;
		@tracks = $release->LoadTracks();
		if (scalar(@tracks) == 0)
		{
			print STDERR "Cannot load tracks for release $releaseid\n";
			return "<CDInfo />";
		}

		if (!$release->HasMultipleTrackArtists)
		{
			$out .= "  <SingleArtistCD>\n";
			$out .= "    <Artist>" . $artist->GetName() . "</Artist>\n";

			for my $track (@tracks)
			{
				$out .= "    <Track Num=\"$num\">\n";
				$out .= "      <Name>" . $track->GetName() . "</Name>\n";
				$out .= "    </Track>\n";
				$num++;
			}
			$out .= "  </SingleArtistCD>\n";
		}
		else
		{
			$out .= "  <MultipleArtistCD>\n";

			for my $track (@tracks)
			{
				$out .= "    <Track Num=\"$num\">\n";
				$out .= "      <Artist>" . $track->GetArtistName() . "</Artist>\n";
				$out .= "      <Name>" . $track->GetName() . "</Name>\n";
				$out .= "    </Track>\n";
				$num++;
			}
			$out .= "  </MultipleArtistCD>\n";
		}

		$out .= "</CDInfo>";

		return $out;
	};

	my $mb = $m->comp("/comp/dblogin");
	$m->out(&$MakeCDInfo($mb, $discid));
	$mb->Logout();

</%perl>

%# vi: set ts=4 sw=4 ft=mason :

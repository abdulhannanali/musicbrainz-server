%# vi: set ts=4 sw=4 ft=mason :
<%args>
$reltype => undef
$relstatus => undef
$artists => ""
</%args>
<%perl>

MusicBrainz::IsNonNegInteger($reltype) or $reltype = 0;
$reltype >= Album::ALBUM_ATTR_SECTION_TYPE_START or $reltype = 0;
$reltype <= Album::ALBUM_ATTR_SECTION_TYPE_END or $reltype = 0;

MusicBrainz::IsNonNegInteger($relstatus) or $relstatus = 0;
$relstatus >= Album::ALBUM_ATTR_SECTION_STATUS_START or $relstatus = 0;
$relstatus <= Album::ALBUM_ATTR_SECTION_STATUS_END or $relstatus = 0;

$artists = ""
	unless $artists eq "single" or $artists eq "all";

my ($mb, $row, $ind, $i, $offset, $page, $al, $rows);
my $max_items = 50;

$m->comp("/comp/sidebar", title=>'Browse Releases');

$ind = $ARGS{index};
$offset = $ARGS{offset};
$page = $ARGS{page};
$offset = ($page-1) * $max_items if not defined $offset and defined $page;
$offset = 0 if not defined $offset;
$offset = 0 if $offset < 0;

$m->comp("/comp/framedboxbegin", width=>"100%");
$m->comp("/comp/browsebox", ind=>$ind, page=>"/browsevarious.html?reltype=$reltype&relstatus=$relstatus&artists=$artists");
$m->comp("/comp/framedboxend");

$m->out("<p style='text-align: center'>");
for my $rt (0, Album::ALBUM_ATTR_SECTION_TYPE_START ..  Album::ALBUM_ATTR_SECTION_TYPE_END)
{
	my $name = ($rt ? Album->GetAttributeName($rt) : "All");
	$m->out(" | ") if $rt;
	$m->out("<b>") if $rt == $reltype;
	$m->out("<a href='/browsevarious.html?reltype=$rt&amp;relstatus=$relstatus&amp;artists=$artists&amp;index=$ind'>$name</a>");
	$m->out("</b>") if $rt == $reltype;
}
$m->out("</p>");

$m->out("<p style='text-align: center'>");
for my $rt (0, Album::ALBUM_ATTR_SECTION_STATUS_START ..  Album::ALBUM_ATTR_SECTION_STATUS_END)
{
	my $name = ($rt ? Album->GetAttributeName($rt) : "All");
	$m->out(" | ") if $rt;
	$m->out("<b>") if $rt == $relstatus;
	$m->out("<a href='/browsevarious.html?reltype=$reltype&amp;relstatus=$rt&amp;artists=$artists&amp;index=$ind'>$name</a>");
	$m->out("</b>") if $rt == $relstatus;
}
$m->out("</p>");

$m->out("<p style='text-align: center'>");
for ("all=All Artists", "=Various Artists", "single=Single Artist")
{
	my ($v, $name) = split /=/, $_;
	my $on = ($artists eq $v);
	$m->out(" | ") if $v ne "all";
	$m->out("<b>") if $on;
	$m->out("<a href='/browsevarious.html?reltype=$reltype&amp;relstatus=$relstatus&amp;artists=$v&amp;index=$ind'>$name</a>");
	$m->out("</b>") if $on;
}
$m->out("</p>");

if ($reltype or $relstatus or $ind ne "" or not $artists)
{

$mb = $m->comp("/comp/dblogin");
$al = Album->new($mb->{DBH});
$al->SetId(&ModDefs::VARTIST_ID);

my ($num_albums, @info) = $al->GetVariousDisplayList($ind, $offset, $reltype, $relstatus, $artists);

$m->comp("/comp/framedboxbegin", width=>"100%");
if ($num_albums > 0)
{
    </%perl>
    <& /comp/pageselector, numitems=>$num_albums,
                           numlinks=>6,
                           snaptoend=>2,
                           offset=>$offset,
                           pagesize=>$max_items,
						   url=>"/browsevarious.html",
						   args=>{
							   index	=>$ind,
							   reltype	=>$reltype,
							   relstatus=>$relstatus,
							   artists	=>$artists,
						   },
						   &>
    <& /comp/modnotice &>

%   $rows = $max_items / 2;
    <p><table align="center" width="100%" bgcolor="#f0efff">
%   for($i = 0; $i < $rows; $i++) {
%      $row = $info[$i];  
%      last if (!defined $row);
       <tr>
          <td width="1%" valign="top">
             <% ($i + 1 + $offset) %>.
          </td>
%         if ($$row[2]) {
             <td valign=top width="50%" bgcolor="#FFFFCC">
%         } else {
             <td valign=top width="50%">
%         }
            <a href="/showalbum.html?albumid=<% $$row[0] %>"><% $$row[1]  %></a>
          </td>
          <td width="1%" valign="top">
%           $row = $info[$i + $rows];  
%           if (defined $row) {
                <% ($i + 1 + $rows + $offset) %>.
                </td>
%               if ($$row[2]) {
                   <td valign=top width="50%" bgcolor="#FFFFCC">
%               } else {
                   <td valign=top width="50%">
%               }
                <a href="/showalbum.html?albumid=<% $$row[0] %>"><% $$row[1]  %></a>
%           } else {
                &nbsp;</td><td>&nbsp;
%           }
         </td>
      </tr>
%    }
    </table>
    <& /comp/pageselector, numitems=>$num_albums,
                           numlinks=>6,
                           snaptoend=>2,
                           offset=>$offset,
                           pagesize=>$max_items,
						   url=>"/browsevarious.html",
						   args=>{
							   index	=>$ind,
							   reltype	=>$reltype,
							   relstatus=>$relstatus,
							   artists	=>$artists,
						   },
						   &>
%} else {
%   $ind =~ s/_/?/g;
%   $ind =~ s/ /_/g;
    <p><table align="center" width="100%" bgcolor="#f0efff">
    <tr><td align="center">
		No
		<% ($reltype || $relstatus) ? "matching" : "" %>
		<% $artists eq "all" ? ""
			: $artists eq "single" ? "single artist"
			: "various artist" %>
		albums
		<% length($ind) ? "start with <b>$ind</b>" : "" |n %>
    </td></tr>
    </table>
%   }
<& /comp/framedboxend &>

% } else {

	<p style="text-align: center">
		Please choose some filter criteria.
	</p>

% }

<div class='LinksRow'>[ <a href=\"/addalbum.html?artistid=1\">Add New Album</a> ]</div>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$reltype => undef
$relstatus => undef
</%args>
<%perl>

MusicBrainz::IsNonNegInteger($reltype) or $reltype = 0;
$reltype >= Album::ALBUM_ATTR_SECTION_TYPE_START or $reltype = 0;
$reltype <= Album::ALBUM_ATTR_SECTION_TYPE_END or $reltype = 0;

MusicBrainz::IsNonNegInteger($relstatus) or $relstatus = 0;
$relstatus >= Album::ALBUM_ATTR_SECTION_STATUS_START or $relstatus = 0;
$relstatus <= Album::ALBUM_ATTR_SECTION_STATUS_END or $relstatus = 0;

my ($mb, @info, $row, $ind, $i, $offset, $page, $num_albums, $al, $rows);
my $max_items = 50;

$m->comp("/comp/sidebar", title=>'Browse Various Artist Albums');
$m->out("<p>[ <a href=\"/addalbum.html?artistid=1\">Add New Album</a> ]<p>");

$ind = $ARGS{index};
$offset = $ARGS{offset};
$page = $ARGS{page};
$offset = ($page-1) * $max_items if not defined $offset and defined $page;
$offset = 0 if not defined $offset;
$offset = 0 if $offset < 0;

$m->comp("/comp/framedboxbegin", width=>"100%");
$m->comp("/comp/browsebox", ind=>$ind, page=>"/browsevarious.html?reltype=$reltype&relstatus=$relstatus");
$m->comp("/comp/framedboxend");

$m->out("<p style='text-align: center'>");
for my $rt (0, Album::ALBUM_ATTR_SECTION_TYPE_START ..  Album::ALBUM_ATTR_SECTION_TYPE_END)
{
	my $name = ($rt ? Album->GetAttributeName($rt) : "All");
	$m->out(" | ") if $rt;
	$m->out("<b>") if $rt == $reltype;
	$m->out("<a href='/browsevarious.html?reltype=$rt&amp;relstatus=$relstatus&amp;index=$ind'>$name</a>");
	$m->out("</b>") if $rt == $reltype;
}
$m->out("</p>");

$m->out("<p style='text-align: center'>");
for my $rt (0, Album::ALBUM_ATTR_SECTION_STATUS_START ..  Album::ALBUM_ATTR_SECTION_STATUS_END)
{
	my $name = ($rt ? Album->GetAttributeName($rt) : "All");
	$m->out(" | ") if $rt;
	$m->out("<b>") if $rt == $relstatus;
	$m->out("<a href='/browsevarious.html?reltype=$reltype&amp;relstatus=$rt&amp;index=$ind'>$name</a>");
	$m->out("</b>") if $rt == $relstatus;
}
$m->out("</p>");

$mb = $m->comp("/comp/dblogin");
$al = Album->new($mb->{DBH});
$al->SetId(ModDefs::VARTIST_ID);

($num_albums, @info) = $al->GetVariousDisplayList($ind, $offset, $reltype, $relstatus);

$m->comp("/comp/framedboxbegin", width=>"100%");
if ($num_albums > 0)
{
    </%perl>
    <& /comp/pageselector, numitems=>$num_albums,
                           numlinks=>6,
                           snaptoend=>2,
                           offset=>$offset,
                           pagesize=>$max_items,
						   url=>"/browsevarious.html?index=$ind&reltype=$reltype&relstatus=$relstatus" &>
    <& /comp/modnotice &>

%   $rows = $max_items / 2;
    <p><table align="center" width="100%" bgcolor="#f0efff">
%   for($i = 0; $i < $rows; $i++) {
%      $row = $info[$i];  
%      last if (!defined $row);
       <tr>
          <td width="1%" valign="top">
             <% ($i + 1 + $offset) %>.
          </td>
%         if ($$row[2]) {
             <td valign=top width="50%" bgcolor="#FFFFCC">
%         } else {
             <td valign=top width="50%">
%         }
            <a href="/showalbum.html?albumid=<% $$row[0] %>"><% $$row[1]  %></a>
          </td>
          <td width="1%" valign="top">
%           $row = $info[$i + $rows];  
%           if (defined $row) {
                <% ($i + 1 + $rows + $offset) %>.
                </td>
%               if ($$row[2]) {
                   <td valign=top width="50%" bgcolor="#FFFFCC">
%               } else {
                   <td valign=top width="50%">
%               }
                <a href="/showalbum.html?albumid=<% $$row[0] %>"><% $$row[1]  %></a>
%           } else {
                &nbsp;</td><td>&nbsp;
%           }
         </td>
      </tr>
%    }
    </table>
%} else {
%   $ind =~ s/_/?/g;
%   $ind =~ s/ /_/g;
    <p><table align="center" width="100%" bgcolor="#f0efff">
    <tr><td align="center">
      No matching various artist albums start with the letters <b><% $ind %></b>.
    </td></tr>
    </table>
%   }
<& /comp/framedboxend &>

% $mb->Logout;
<& /comp/footer &>

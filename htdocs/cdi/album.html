%# vi: set ts=4 sw=4 ft=mason :
<%args>
$id
$toc
$tracks
$artist=>''
</%args>
<%perl>

my ($num_tracks, $i, $mb, $ar, $al, $modpending); 

$m->comp('/comp/sidebar', title=>'Submit CD: Select Album');

if (!defined $artist || $artist eq '')
{
    $m->out("Please select an artist name. Click on the " . 
          "Back button in your browser and try again.");
}
else
{
    $mb = $m->comp("/comp/dblogin");
    $ar = Artist->new($mb->{DBH});

    my (%unused, $first, $found, $artistname, @ids_tracks_seqs, @albumlist);
    
    $first = 1;
    $found = 0;
   
    $ar->SetId($artist);
    $ar->LoadFromId();
	$m->comp("/comp/artisttitle", artist => $ar, showmodlinks => 0);

    @albumlist = sort { $a->{name} cmp $b->{name} } $ar->GetAlbums(0, 1);
    for(;;)
    {
        my ($trackid, $name, $seq, $num_tracks, $albumname);
       
        $al = shift @albumlist;
        last if (!defined $al);
        $num_tracks = $al->GetTrackCount();
        if ($num_tracks == $tracks)
        {
            if ($first)
            {
               $first = 0;
               $found = 1;
</%perl>
               Please examine the albums listed below. If one of
               the track listings matches the CD that you are
               submitting, click on <b>Select Album</b> next to
               the matching album. If none of the listed albums
               match, click on <b>Album not listed</b>.
               If you're unsure as to which one to pick or you have
               questions about this step, please check out our
               <a href="/cd_submission.html">CD Submission</a> document
               for more details on the submission process. The CD Index
               Id for the CD you're submitting is <b><% $id %></b> .<p>

               <form method="POST" action="/cdi/enter.html"
                  enctype="application/x-www-form-urlencoded" class="formstyle">
               <input type="hidden" name="artist" value="<% $artist %>">
               <input type="hidden" name="id" value="<% $id %>">
               <input type="hidden" name="toc" value="<% $toc %>">
               <input type="hidden" name="tracks" value="<% $tracks %>">
               <table width="100%"><tr><td align=right>
               <input type="submit" value="Album not listed &gt;&gt;" name="Select">
               </td></tr></table>
               </form>
%           }    

            <form method="POST" action="/cdi/found.html"
                  enctype="application/x-www-form-urlencoded" class="formstyle">
              <table width="100%">
              <tr>
                <td width="100%">
					<& /comp/album, artist=>$ar, album=>$al, showmodlinks=>0 &>
                </td>
                <td align="right" valign="top">
                   <input type="submit" value="Select <% $albumname %> &gt;&gt;" 
                          name="Select">
                   <input type="hidden" name="album" value="<% $al->GetId() %>">
                   <input type="hidden" name="id" value="<% $id %>">
                   <input type="hidden" name="toc" value="<% $toc %>">
                   <input type="hidden" name="tracks" value="<% $tracks %>">
                </td>
              </tr>
              </table>
            </form>
<%perl>
        }
        else
        {
            my $key = $al->GetId();

            $unused{$key} = { name => $al->GetName(), tracks => $num_tracks };
        }
    }
</%perl>
    
    <form method="POST" action="/cdi/enter.html"
       enctype="application/x-www-form-urlencoded" class="formstyle">
    <input type="hidden" name="artist" value="<% $artist %>">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="toc" value="<% $toc %>">
    <input type="hidden" name="tracks" value="<% $tracks %>">
    <table width="100%"><tr><td align=right>
    <input type="submit" value="Album not listed &gt;&gt;" name="Select">
    </td></tr></table>
    </form>

%   if (scalar(keys(%unused)) > 0) {
        The following albums in MusicBrainz are not applicable
        because they have a different number of tracks than
        than the album you are submitting:<p>
%       foreach $i (keys(%unused))
%       {
           <a href="/showalbum.html?albumid=<% $i %>">
           <% $unused{$i}->{name} %></a> has
           <% $unused{$i}->{tracks} %> tracks.<br>
%       }
        <p>Even though there may be an album listed with the same 
        name as you are submitting, there sometimes are different
        editions of the same album that have a different number 
        of tracks.
%   }
    
%   if (!$found) {
        There were no albums with <% $tracks %> tracks found. Please click 
        <font class="bold">Album not listed</font>.
%   }

%   $mb->Logout;
% }

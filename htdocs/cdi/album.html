%# vi: set ts=4 sw=4 ft=mason :
<%args>
$id
$toc
$tracks
$artist=>''
</%args>
<%perl>

my ($num_tracks, $i, $mb, $ar, $al, $modpending); 

$m->comp('/comp/sidebar', title=>'Submit CD: Select Album');

if (!defined $artist || $artist eq '')
{
    $m->out("Please select an artist name. Click on the " . 
          "Back button in your browser and try again.");
}
else
{
    $mb = $m->comp("/comp/dblogin");
    $ar = Artist->new($mb->{DBH});

    my (%unused, $first, $found, $artistname, @ids_tracks_seqs, @albumlist);
    
    $first = 1;
    $found = 0;
   
    $ar->SetId($artist);
    $ar->LoadFromId();
	$m->comp("/comp/artisttitle", artist => $ar, showmodlinks => 0);

    @albumlist = sort { $a->{name} cmp $b->{name} } $ar->GetAlbums(0, 1);
    for(;;)
    {
        my ($trackid, $name, $seq, $num_tracks, $albumname);
       
        $al = shift @albumlist;
        last if (!defined $al);
        $num_tracks = $al->GetTrackCount();
        if ($num_tracks == $tracks)
        {
            if ($first)
            {
               $first = 0;
               $found = 1;
</%perl>

			<p>
               Please examine the albums listed below.&nbsp; If one of
               the track listings matches the CD that you are
               submitting, click on <b>Select Album</b> next to
               the matching album.&nbsp; If none of the listed albums
               match, click on <b>Album not listed</b>.&nbsp;
               If you're unsure as to which one to pick or you have
               questions about this step, please check out our
               <a href="/cd_submission.html">CD Submission</a> document
               for more details on the submission process.&nbsp; The CD Index
			   ID for the CD you're submitting is <b><% $id %></b>.&nbsp;
			</p>

               <form method="POST" action="/cdi/enter.html"
                  enctype="application/x-www-form-urlencoded" class="formstyle">
				<p style="text-align: right">
               <input type="hidden" name="artist" value="<% $artist %>">
               <input type="hidden" name="id" value="<% $id %>">
               <input type="hidden" name="toc" value="<% $toc %>">
               <input type="hidden" name="tracks" value="<% $tracks %>">
               <input type="submit" value="Album not listed &gt;&gt;">
			   </p>
               </form>
%           }    

              <table width="100%">
              <tr>
                <td width="100%">
					<& /comp/album, artist=>$ar, album=>$al, showmodlinks=>0 &>
                </td>
                <td align="right" valign="top">
            <form method="POST" action="/cdi/found.html"
                  enctype="application/x-www-form-urlencoded" class="formstyle">
                   <input type="submit" value="Select <% $albumname %> &gt;&gt;">
                   <input type="hidden" name="album" value="<% $al->GetId() %>">
                   <input type="hidden" name="id" value="<% $id %>">
                   <input type="hidden" name="toc" value="<% $toc %>">
                   <input type="hidden" name="tracks" value="<% $tracks %>">
            </form>
                </td>
              </tr>
              </table>
<%perl>
        }
        else
        {
            my $key = $al->GetId();

            $unused{$key} = { name => $al->GetName(), tracks => $num_tracks };
        }
    }
</%perl>
    
    <form method="POST" action="/cdi/enter.html"
       enctype="application/x-www-form-urlencoded" class="formstyle">
	<p style="text-align: right">
    <input type="hidden" name="artist" value="<% $artist %>">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="toc" value="<% $toc %>">
    <input type="hidden" name="tracks" value="<% $tracks %>">
    <input type="submit" value="Album not listed &gt;&gt;">
	</p>
    </form>

%   if (scalar(keys(%unused)) > 0) {
	<p>
        The following albums in MusicBrainz are not applicable
        because they have a different number of tracks than
        than the album you are submitting:</p>
		<ul>
%       foreach $i (keys(%unused))
%       {
			<li><a href="/showalbum.html?albumid=<% $i %>">
           <% $unused{$i}->{name} %></a> has
			<% $unused{$i}->{tracks} %> tracks.</li>
%       }
		</ul>
        <p>Even though there may be an album listed with the same 
        name as you are submitting, there sometimes are different
        editions of the same album that have a different number 
		of tracks.</p>
%   }
    
%   if (!$found) {
	<p>
        There were no albums with <% $tracks %> tracks found.&nbsp; Please click 
		<b>Album not listed</b>.
	</p>
%   }

% }

%# vi: set ts=4 sw=4 ft=mason :
<%args>

	$language_new => undef
	$script_new => undef

	$submitvalue => ""
	$expand_lists => 0
	$confirm => 0

	$tracks
</%args>
<%perl>

	# remove arguments that only are used on this page
	# from the add release workflow arguments.
	my %args = %ARGS;
	delete $args{"language_new"};
	delete $args{"expand_lists"};
	delete $args{"script_new"};
	delete $args{"submitvalue"};

	# Handle the different types of submit buttons
	if ($submitvalue ne "")
	{
		if ($submitvalue =~ /Show (Reduced|Full) Lists/i)
		{
			$expand_lists = !$expand_lists;
		}
		elsif ($submitvalue =~ /Guess/i)
		{
			$script_new = undef;
			$language_new = undef;
		}
		else
		{
			# Check we have chosen a language and a script (or that we have chosen
			# "I don't know"). If all OK, return true.
			last if (not defined $language_new);
			last unless ($language_new eq "" or MusicBrainz::IsNonNegInteger($language_new));

			last if (not defined $script_new);
			last unless ($script_new eq "" or MusicBrainz::IsNonNegInteger($script_new));

			return 1;
		}
	}

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# compile a flat-text of the release fields.
	my @text = map { $ARGS{"track$_"} } (0..$tracks);
	unshift @text, $ARGS{"albumname"};

	# let's see if we have to guess language or script from
	# the title fields of this release.
	unless (MusicBrainz::IsNonNegInteger($script_new))
	{
		$script_new = MusicBrainz::Server::Script->GuessFromText($mb->{DBH}, \@text);
		$script_new = ($script_new ? $script_new->GetId : "");
	}

	unless (MusicBrainz::IsNonNegInteger($language_new))
	{
		$language_new = MusicBrainz::Server::Language->GuessFromTextAndScript($mb->{DBH}, \@text, $script_new);
		$language_new = ($language_new ? $language_new->GetId : "");
	}

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Select Release Language/Script" &>

	<form method="post" action="/cdi/selectattr.html" name="AutoChange">

		<& /comp/layout/editformbegin, title => "Select Release Language/Script" &>

		<table class="formstyle">
			<tr>
				<td class="instructions" colspan="2">
					<ul>
						<li>
							Please choose the <a href="/doc/AlbumLanguage">script and language</a>
							of the track titles.</li>
					</ul>
				</td>
			</tr>

			<& /edit/albumlanguage/form,
				add_language => 1,
				language_curr => $language_new,
				script_curr => $script_new,
				expand_lists => $expand_lists,
			&>
		</table>
		<%perl>

			$m->comp("/comp/args-to-hidden-fields.inc", %args);

		</%perl>

		<& /comp/movefocus, "AutoChange", 0 &>
	</form>
	<& /comp/layout/editformend &>

<& /comp/footer &>

<%perl>
	# this tells /cdi/selectattr.html to stop validation
	# at this form, until values were given.
	return 0;
</%perl>
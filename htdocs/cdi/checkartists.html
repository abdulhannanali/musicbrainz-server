%# vi: set ts=4 sw=4 ft=mason :
<%perl>

my $mb = $m->comp("/comp/dblogin");

my $search;
my $track;
my %args;

$args{"tracks"} = $ARGS{"tracks"};
$args{"toc"} = $ARGS{"toc"};
$args{"id"} = $ARGS{"id"};
$args{"noncd"} = $ARGS{"noncd"};
$args{"artist"} = $ARGS{"artist"};
$args{"title"} = $ARGS{"title"};

for (my $i = 0; $i < $ARGS{"tracks"}; $i++) 
{
    $args{"track$i"} = $ARGS{"track$i"};
    $args{"tracklength$i"} = $ARGS{"tracklength$i"};
    $args{"artistname$i"} = $ARGS{"artistname$i"};
    $args{"sortname$i"} = $ARGS{"sortname$i"};
    $args{"artist$i"} = $ARGS{"artist$i"};
} 

if (exists $ARGS{"selectedartist"})
{
    my $i = $ARGS{"track"};
    $args{"artist$i"} = $ARGS{"selectedartist"};
    delete $args{"artistname$i"};
    delete $args{"sortname$i"};
    $args{"track"} = ++$ARGS{"track"};
    
}
elsif (exists $ARGS{"newartistname"} && exists $ARGS{"newartistsortname"})
{
    my $i = $ARGS{"track"};
    delete $args{"artist$i"};
    $args{"artistname$i"} = $ARGS{"newartistname"};
    $args{"sortname$i"} = $ARGS{"newartistsortname"};
    $args{"track"} = ++$ARGS{"track"};
}

if (exists $ARGS{"search"})
{
    $search = $ARGS{"search"};
    $track = "";
    $args{"track"} = $ARGS{"track"};
}
else
{
    my $i = $ARGS{"track"} || 0;
    while (1)
    {
        $search = $ARGS{"artistname$i"};
        $track = $ARGS{"track$i"};
        $args{"track"} = $i++;
        
        last if ($args{"track"} >= $args{"tracks"});
        
        my $ar = Artist->new($mb->{DBH}); 
        my $ar_list = $ar->GetArtistsFromName($search); 
        
        last if (scalar @$ar_list != 1 || @$ar_list[0]->GetName ne $search);
    }
}

if ($args{"track"} >= $args{"tracks"})
{
    delete $args{"track"};
    return $m->comp("/cdi/selectattr.html", %args); 
}

</%perl>

<& /comp/sidebar, title=>'Select Track Artist' &>

<fieldset>
        <legend>Select Artist for current track</legend>
        <div class="padleft">
                Please search for the artist to whom you'd like to add the current track: 
        </div>
	<div class="padlefttop">
		<div class="oldtextfield"><% $args{"track"} + 1 %>. <% $args{"artistname" . $args{"track"}} %> - <strong><% $track %></strong></div>
	</div>
</fieldset> 

<& /comp/artistfilter,
	search => $search,
	allowcreate => 1,
	url => "/cdi/checkartists.html",
	arglist => \%args,
	&>

<& /comp/footer &>

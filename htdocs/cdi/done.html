<%perl>

my ($id, $tracks, $artist, $artistname, $sortname, $title);
my ($error, $i, $artistid, $albumid, $new, $mb, $toc);

$mb = new MusicBrainz;
mc_comp("/comp/sidebar", title=>'New CD Submission');

# Do a bunch of error checking
$id = $ARGS{'id'};
$tracks = $ARGS{'tracks'};
$toc = $ARGS{'toc'};
$artist = $ARGS{'artist'};
$artistname = $ARGS{'artistname'};
$sortname = $ARGS{'sortname'};
$title = $ARGS{'title'};

$error = 0;
$error = 1 if (!defined $artist && !defined $artistname);
$error = 2 if (!defined $id || $id eq '');
$error = 3 if (!defined $toc || $toc eq '');
$error = 4 if (!defined $tracks || $tracks eq 0);
for($i = 0; $i < $tracks && !$error; $i++)
{
    if (!exists $ARGS{"track$i"} || $ARGS{"track$i"} eq '')
    {
       $error = 5 + $i;
    }
}

if ($error)
{
</%perl>
    <FONT SIZE=+1 COLOR=RED>
    Error (<% $error %>):
    </FONT>
    Please make sure that you fill out all the fields in the form.
    Please press the Back button in your Browser and try again.
    </TD></TR></TABLE>
<%perl>
}
else
{
    my ($in, $mod);

    $mb->Login();

    if (!defined $artist)
    {
       $new = "Artist=$artistname\nSortname=$sortname\n";
    }
    $new .= "AlbumName=$title\nNumTracks=$tracks\nCDIndexId=$id\nTOC=$toc\n";
    for($i = 0; $i < $tracks; $i++)
    {
        $new .= "Track" . ($i + 1) . "=" . $ARGS{"track$i"} . "\n";
        if ($artist == Artist::VARTIST_ID)
        {
            $new .= "Artist" . ($i + 1) . "=" . $ARGS{"artistname$i"} . "\n";
            $new .= "Sortname" . ($i + 1) . "=" . $ARGS{"sortname$i"} . "\n";
        } 
    }

    $mod = Moderation->new($mb->{DBH});
    $mod = $mod->CreateModerationObject(ModDefs::MOD_ADD_ALBUM);
    if (defined $mod)
    {
        $mod->SetTable('Artist');
        $mod->SetColumn('Name');
        $mod->SetPrev("");
        $mod->SetNew($new);
        $mod->SetType(ModDefs::MOD_ADD_ALBUM);
        
        # TODO set moderator
        $mod->SetModerator($session{uid});
        $mod->SetDepMod(0);

        # if we already have an artist id, set it here
        $mod->SetArtist($artist) if (defined $artist);
        $mod->PreVoteAction();

        if ($mod->GetNew() =~ /^_albumid=(.*)$/m)
        {
           $albumid = $1;
        }
        if ($mod->GetNew() =~ /^_artistid=(.*)$/m)
        {
           $artistid = $1;
        }

        if (defined $artistid && defined $albumid)
        {
            $mod->SetArtist($artistid);
            $mod->SetRowId($artistid);
            $mod->InsertModeration(); 

            mc_out("Thank you for your submission!<p><br>");

            my ($al, $ar);

            $ar = Artist->new($mb->{DBH});
            $ar->SetId($artistid);
            if ($ar->LoadFromId())
            {
                $al = Album->new($mb->{DBH});
                $al->SetArtist($artistid);
                $al->SetId($albumid);
                if ($al->LoadFromId())
                {
                    mc_out("<hr>Here is the album you inserted:<p><br>");
                    mc_comp("/comp/artisttitle", artist=>$ar);
                    mc_comp("/comp/album", album=>$al, artist=>$ar);
                }
            }
        }
        else
        {
            mc_out("An error occurred during the data insertion: ");
            mc_out("$mod->{error}\n<p>");
        }
    }
    $mb->Logout;
}
</%perl>

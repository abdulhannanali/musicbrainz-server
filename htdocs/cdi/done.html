%# vi: set ts=4 sw=4 ft=mason :
<%args>
$id=>""
$tracks=>0
$toc=>""
$freedbid=>""
$freedbcat=>""
$artist=>undef
$artistname=>""
$sortname=>""
$title=>""
$durations=>""
$attrtype=>0
$attrstatus=>0
$noncd=>0
$notetext => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

$m->comp("/comp/sidebar", title=>'New CD Submission');

use DebugLog;
if (my $d = DebugLog->open)
{
    $d->stamp("cdi/done.html");
    $d->dumper([\%ARGS], ['*ARGS']);
    $d->dumpstring($toc, '$toc') if $toc;
    $d->close;
}

# Do a bunch of error checking

my $error = 0;
$error = 1 if (!defined $artist && $artistname eq '');
$error = 2 if ($id eq '' && $freedbid eq '' && $noncd == 0);
$error = 3 if ($toc eq '' && $freedbid eq '' && $noncd == 0);
$error = 4 if ($freedbid ne '' && $durations eq '');
$error = 5 if ($tracks eq 0);
$error = 6 if (!defined $artist && $artistname =~ /various artists/i);
$error = 7 if ($attrtype == 0 || $attrstatus == 0);
for (my $i = 0; $i < $tracks && !$error; $i++)
{
    if (!exists $ARGS{"track$i"} || $ARGS{"track$i"} eq '')
    {
       $error = 7 + $i;
    }
}

my $mb = $m->comp("/comp/dblogin");

if ($error > 0 && $error != 6)
{
</%perl>
    <FONT SIZE="+1" COLOR=RED>
    Error (<% $error %>):
    </FONT>
    Please make sure that you fill out all the fields in the form.
    Please press the Back button in your Browser and try again.
    </TD></TR></TABLE>
<%perl>
}
elsif ($error == 6)
{
</%perl>
    You cannot insert a Various Artists albums using the single artist
    submission form. Please go back to the beginning of the submission
    process and choose a Multiple Artist CD.
    </TD></TR></TABLE>
<%perl>
}
else
{
    my (@offsets, @durations);

    if ($durations ne '')
    {
        @durations = split / /, $durations;
    }

    if ($toc ne '')
    {
        @offsets = split / /, $toc;
        shift @offsets; # first
        shift @offsets; # last
        my $leadout = shift @offsets;
        push @offsets, $leadout;
    }

	my $new = "";

    if (!defined $artist)
    {
       $artistname =~ s/^\s*(.*?)\s*$/$1/;
       $sortname =~ s/^\s*(.*?)\s*$/$1/;
       $new = "Artist=$artistname\nSortname=$sortname\n";
    }

    $new .= "AlbumName=$title\nNumTracks=$tracks\n";
    $new .= "Attributes=$attrtype,$attrstatus\n";
    $new .= "CDIndexId=$id\n" if ($id ne '');
    $new .= "TOC=$toc\n" if ($toc ne '');
    $new .= "FreedbId=$freedbid\n" if ($freedbid ne '');
    $new .= "FreedbCat=$freedbcat\n" if ($freedbcat ne '');

    for (my $i = 0; $i < $tracks; $i++)
    {
        $ARGS{"track$i"} =~ s/^\s*(.*?)\s*$/$1/;
        $new .= "Track" . ($i + 1) . "=" . $ARGS{"track$i"} . "\n";
        if ($toc ne '')
        {
           my $dur = int((($offsets[$i+1] - $offsets[$i])*1000)/75);
           $new .= "TrackDur" . ($i + 1) . "=" . $dur . "\n";
        }
        if ($durations ne '')
        {
           $new .= "TrackDur" . ($i + 1) . "=" . $durations[$i] . "\n";
        }
        if ($artist == &ModDefs::VARTIST_ID)
        {
            $ARGS{"artistname$i"} =~ s/^\s*(.*?)\s*$/$1/;
            $ARGS{"sortname$i"} =~ s/^\s*(.*?)\s*$/$1/;
            $new .= "Artist" . ($i + 1) . "=" . $ARGS{"artistname$i"} . "\n";
            $new .= "Sortname" . ($i + 1) . "=" . $ARGS{"sortname$i"} . "\n";
        }
    }

    my $in = Insert->new($mb->{DBH});
	my ($artistid, $albumid, $mods) = $in->InsertAlbumModeration(
		$new, $session{uid}, $session{privs}, $artist,
	);

	if ($mods and @$mods and $notetext =~ /\S/)
	{
		# TODO no error checking yet on adding the mod note
		my $sql = Sql->new($mb->{DBH});
		eval {
			$sql->Begin;
			$mods->[0]->InsertNote($session{'uid'}, $notetext);
			$sql->Commit;
		};
		eval { $sql->Rollback } if $@ ne "";
	}

    if (defined $artistid && defined $albumid)
    {
		$m->out("<p>Thank you for your submission!</p>");

        my ($al, $ar);

        $ar = Artist->new($mb->{DBH});
        $ar->SetId($artistid);
        if ($ar->LoadFromId())
        {
            $al = Album->new($mb->{DBH});
            $al->SetArtist($artistid);
            $al->SetId($albumid);
            if ($al->LoadFromId())
            {
                $m->out("<p>Here is the album you inserted:</p>");
                $m->comp("/comp/artisttitle", artist=>$ar, link=>1);

				$m->comp(
					"/comp/album",
					album => $al,
					artist => $ar,
					showids => 1,
					mbtagger => $session{mbt},
				);
            }
        }
    }
    else
    {
        $m->out("An error occurred during the data insertion:<br>");
        $m->out("<pre>" . $in->GetError() . "</pre>");
    }
}
$mb->Logout;
</%perl>

<%perl>

my ($o, $mb, $error, $ar, $al, $tr, $di); 
my ($tracks, $i, $artistname, $sortname);
my ($toc, $title, $album, $id, $artist);
my ($sth, $rv);

$mb = new MusicBrainz;
mc_comp("/comp/sidebar", title=>'New CD Submission Completed');

# Do a bunch of error checking
$id = $ARGS{'id'};
$tracks = $ARGS{'tracks'};
$toc = $ARGS{'toc'};
$artist = $ARGS{'artist'};
$artistname = $ARGS{'artistname'};
$sortname = $ARGS{'sortname'};
$title = $ARGS{'title'};

$error = 0;
$error = 1 if (!defined $artist && !defined $artistname);
$error = 1 if (!defined $id || $id eq '');
$error = 1 if (!defined $toc || $toc eq '');
$error = 1 if (!defined $tracks || $tracks eq 0);
for($i = 0; $i < $tracks && !$error; $i++)
{
    if (!exists $ARGS{"track$i"})
    {
       $error = 1;
    }
}

if ($error)
{
</%perl>
    <FONT SIZE=+1 COLOR=RED>
    Error:
    </FONT>
    Please make sure that you fill out all the fields in the form.
    Please press the Back button in your Browser and try again.
    </TD></TR></TABLE>
<%perl>
}
else
{
    $mb->Login();
    $ar = Artist->new($mb->{DBH});
    $al = Album->new($mb->{DBH});
    $tr = Track->new($mb->{DBH});
    $di = Diskid->new($mb->{DBH});

    if (defined $artistname)
    {
        $ar->SetName($artistname);
        $ar->SetSortName($sortname);
        $artist = $ar->Insert();
        if (not defined $artist)
        {
            mc_out("Failed to insert a new artist into the database.<br>");
        }
    }

    if (defined $artist)
    {
        my @albums;

        @albums = $ar->GetAlbumsByName($title);
        for(;;)
        {
            $album = shift @albums;
            last if (!defined $album);
            if ($album->GetTrackCount() == $tracks)
            {
                mc_out(qq/That CD already exists in the CD Index. 
                          <p>If this is a different CD, please vary the 
                          title of the CD slightly to indicate how this CD 
                          is different from the existing CD./);
                last;
            }
        }

        if (!defined $album)
        {
            $al->SetName($title);
            $al->SetArtist($artist);
            $album = $al->Insert();
            if (!defined $album)
            {
                mc_out("Failed to insert a new album into the database.<br>");
            }
            else
            {
               for($i = 0; $i < $tracks; $i++)
               {
                   $tr->SetId(0);
                   $tr->SetName($ARGS{"track$i"});
                   $tr->SetSequence($i + 1);
                   $tr->Insert($al, $ar);
               }
    
               $di->Insert($id, $album, $toc);
        
               mc_out(qq/Thank you for your submission.<p> You will
                         now be able to request the information for this CD./);
            }
         }
    }
    $mb->Logout;
}
</%perl>

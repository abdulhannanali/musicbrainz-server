%# vi: set ts=4 sw=4 ft=mason :
<%args>
$tracks
$id
$toc
$artist=>0
$freedb=>0
$noncd=>0
</%args>
<%perl>

unless (MusicBrainz::IsNonNegInteger($tracks) and $tracks >= 1 and $tracks <= 99)
{
	$m->comp("/comp/redirect", '/edit/album/add.html?artistid=' . $artist . '&error=1');
	return;
}

my ($mb);
my ($i, $artistname, $modpending, $ar);
my ($dbh, $sth, $rv);

$m->comp("/comp/sidebar", title=>'Enter Release Information');

if ($artist > 0)
{
   $mb = $m->comp("/comp/dblogin");
   $ar = Artist->new($mb->{DBH});
   $ar->SetId($artist);
   $ar->LoadFromId();
   $artistname = $ar->GetName();
   if (!defined $artistname)
   {
       $artistname = 'Tabasco bondage action';
   }
   $mb->Logout;
}

$m->comp("/comp/stylemenu");

my $lookup;
if ($freedb)
{
   my $fdb = FreeDB->new($mb->{DBH});
   $lookup = $fdb->Lookup($id, $toc);
   if (!$lookup)
   {
       $lookup = undef;
   }
}

</%perl>

% if (defined $lookup) {
     Found CD <font class="bold"><% $lookup->{album} %></font>
     by <font class="bold"><% $lookup->{artist} %></font> at
     <a href="http://www.freedb.org">FreeDB.org</a>.<p>
     Please check the information below for accuracy and correct any
     mistakes you may find:<p>

% } else {
%    if ($freedb) {
         This CD was not found at FreeDB.<p>
%    } else {
%        if ($noncd) {
            Please enter the album information below:
%        } else {
            Please enter the CD information below, or
            click on FreeDB lookup to attempt to load the data for
            this CD from FreeDB:<p>
%        }
%        if (!$freedb && !$noncd) {
           <form method="POST" action="/cdi/enter.html"
                 enctype="application/x-www-form-urlencoded" class="formstyle">
           <input type="hidden" name="id" value="<% $id %>">
           <input type="hidden" name="toc" value="<% $toc %>">
           <input type="hidden" name="tracks" value="<% $tracks %>">
           <input type="hidden" name="freedb" value="1">
%        if ($artist > 0) {
           <input type="hidden" name="artist" value="<% $artist %>">
%        }
           <input type="submit" value="FreeDB Lookup">
           </form>
%        }

%    }
% }

<br/>&nbsp;

<script type="text/javascript" src="/scripts/entervalidate.js"></script>
<form method="POST" action="/cdi/selectattr.html"
	enctype="application/x-www-form-urlencoded" 
	onsubmit="return validate(this);">

	<& /comp/autofixmenu &>

	<fieldset>
		<legend>Enter Release Information</legend>
		<table>
			<tr>
				<td><label for="cdi_enter_artistname">Artist:</label></td>
				<td>
% if ($artist <= 0) {
%    if (!defined $lookup) {
				<input 	type="text" name="artistname" class="textfield"
						id="cdi_enter_artistname"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255"></td>
%    } else {
				<input	type="text" name="artistname" class="textfield"
						id="cdi_enter_artistname"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255"
						value="<% $lookup->{artist} %>"></td>
%    }
			</tr>
			<tr>
				<td><label for="cdi_enter_sortname">Sort Name:</label></td>
				<td>
%    if (!defined $lookup) {
				<input 	type="text" name="sortname" class="textfield"
						id="cdi_enter_sortname"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255">
%    } else {
%        my ($sortname, $st);
%        $st = Style->new;
%        $sortname = $st->MakeDefaultSortname($lookup->{artist});
				 <input type="text" name="sortname" class="textfield" 
						id="cdi_enter_sortname"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255"
						value="<% $sortname %>"></td>
%    }
% } else {
			<span class="bold"><% $artistname %></span>
			<input type="hidden" name="artist" value="<% $artist %>">
% }
</td></tr>

% if ($noncd) {
			<tr>
				<td><label for="cdi_enter_title">Album Title:</label></td>
				<td>
% } else {
			<tr>
				<td><label for="cdi_enter_title">CD Title:</label></td>
				<td>
% }
% if (!defined $lookup) {
				<input  type="text" name="title" class="textfield"
						id="cdi_enter_title"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255"></td>
% } else {
				<input  type="text" name="title" class="textfield"
						id="cdi_enter_title"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255"
						value="<% $lookup->{album} %>"></td>
% }
				
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_ALBUM, 'title<% $i %>');
					-->
					</script></td>
			</tr>

% for($i = 0; $i < $tracks; $i++) {
    		<tr>
				<td><label for="cdi_enter_track<% $i %>">Track <% $i + 1 %>:</label></td>
				<td>
%     if (!defined $lookup) {
					 <input type="text" name="track<% $i %>" class="textfield"
					 		id="cdi_enter_track<% $i %>"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="50" maxlength="255"></td>
%     } else {
%        my $ar = $lookup->{tracks};
					 <input type="text" name="track<% $i %>" class="textfield"
					 		id="cdi_enter_track<% $i %>"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="50" maxlength="255"
							value="<% $$ar[$i]->{track} %>"></td>
%     }
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_TRACK, 'track<% $i %>');
					-->
					</script></td>
			</tr>
% }
			<tr>
				<td>&nbsp;</td>
				<td>&nbsp;</td>
				<td>
					<script type="text/javascript">
					<!--
						function doGuessAll(theForm) {
							doAlbumName(theForm, 'title');
% for($i = 0; $i < $tracks; $i++) {
							doTrackName(theForm, 'track<% $i %>');
% }
						}
						af_writeButton(AF_BTN_ALL, AF_BTNTEXT_ALBUMANDTRACKS);
					-->
					</script></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td colspan="2"><input type="submit" class="button" value="Next &raquo;"></td>
			</tr>
		</table>
		<input type="hidden" name="id" value="<% $id %>">
		<input type="hidden" name="toc" value="<% $toc %>">
		<input type="hidden" name="tracks" value="<% $tracks %>">
		<input type="hidden" name="noncd" value="<% $noncd %>">
	</fieldset>
</form>

<& /comp/footer &>

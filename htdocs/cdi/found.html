%# vi: set ts=2 sw=2 ft=mason :
<%args>
$id
$toc
$album
$tracks
</%args>

<%perl>

$m->comp("/comp/sidebar", title=>'Found CD');

my $mb = $m->comp("/comp/dblogin");
my $sql = Sql->new($mb->{DBH});
require MusicBrainz::Server::AlbumCDTOC;
my $alcdtoc = MusicBrainz::Server::AlbumCDTOC->new($mb->{DBH});

eval
{
   $sql->Begin();
	 $alcdtoc->Insert($album, $toc);
   $sql->Commit();
};
if ($@)
{
   $m->out("A database error occurred: $@");
	 eval { $sql->Rollback() };
   $mb->Logout;
   return undef;
}

</%perl>
 
<p>
	Thank you for your submission.&nbsp;
	A new association has been entered into the database.
</p>
<p>
	You will now be able to request the information for this CD.
</p>

<%perl>

{
	my $al = Album->new($mb->{DBH});
	$al->SetId($album);
	$al->LoadFromId
		or last;

	my $ar = Artist->new($mb->{DBH});
	$ar->SetId($al->GetArtist);
	$ar->LoadFromId
		or last;

	$m->comp("/comp/artisttitle", artist=>$ar, link=>1);
	$m->comp("/comp/album", album=>$al, artist=>$ar);
}

$mb->Logout;

</%perl>

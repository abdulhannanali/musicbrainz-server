%# vi: set ts=2 sw=2 ft=mason :
<%args>
$id
$toc
$album
$tracks
</%args>
<%perl>

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
$al->SetId($album);
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album #$album not found in the database.",
		1, 1,
	);
	
return $m->comp("/comp/error",
	"Disc IDs can't be added to $al->{name} albums.",
	1, 1,
	) if $al->IsNonAlbumTracks;

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist #".$al->GetArtist." not found in the database.",
		1, 1,
	);

my @ret = $m->comp(
	"/comp/entermods",
	DBH => $mb->{DBH},
	sub => sub {
		my @mods = Moderation->InsertModeration(
			DBH	=> $mb->{DBH},
			uid	=> $session{uid},
			privs => $session{privs},
			type => &ModDefs::MOD_ADD_DISCID,
			# --
			album => $al,
			toc => $toc,
		);
	},
);

$m->comp("/comp/sidebar", title => 'CD TOC Added');

</%perl>
 
<p>
	Thank you for your submission.&nbsp;
% if (@ret) {
	A new association has been entered into the database.
% }
</p>
<p>
	You will now be able to request the information for this CD.
</p>

<& /comp/artisttitle, artist => $ar, link => 1 &>
<& /comp/album,
	album => $al,
	artist => $ar,
	showids => 1,
	showtag => 1,
	showreleases => 1,
	&>

<& /comp/footer &>

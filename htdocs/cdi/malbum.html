<%args>
$id
$toc
$search
$tracks
</%args>
<%perl>

my ($mb, $ar, $al, $album, @albums, $num); 
$mb = new MusicBrainz;

mc_comp('/comp/sidebar', title=>'Submit CD: Select Album');

if (!defined $search || $search eq '')
{
    mc_out("Please enter the CD name. Click on the " .
           "Back button in your browser and try again.");
    return;
}

if (!exists $ARGS{toc} || $ARGS{toc} eq '' ||
    !exists $ARGS{id} || $ARGS{id} eq '' ||
    !exists $ARGS{tracks} || $ARGS{tracks} eq '')
{
    mc_comp("/comp/badargs");
    return;
}

my (@row, @ids, %labels);
my (%unused, $first, $found);

$first = 1;
$found = 0;

$mb->Login;

$ar = Artist->new($mb->{DBH});
$ar->SetId(Artist::VARTIST_ID);
$ar->LoadFromId();

$al = Album->new($mb->{DBH});
@albums = $al->SearchByName($search, 1);

if (scalar(@albums) > 0)
{
    my @row;
    my $i;

    foreach $album (@albums)
    {
        $al->SetId($$album[0]);

        next if (!defined $al->LoadFromId());
        
        delete $al->{trackcount};
        $num = $al->GetTrackCount();
        if ($num == $tracks)
        {
            if ($first)
            {
               $first = 0;
               $found = 1;
               mc_out(qq|Please examine the CDs listed below. If one of 
                         the track listings matches the CD that you are 
                         submitting, click on <font class="bold">Select 
                         CD</font> next to 
                         the matching album. If none of the listed CD 
                         match, click on <font class="bold">New CD</font>,
                         at the bottom of this page:<br>|);
            }

</%perl>
            <form method="POST" action="found.html" 
                  enctype="application/x-www-form-urlencoded">
               <table width="100%">
               <tr>
                 <td width="100%">
                    <& /comp/album, artist=>$ar, album=>$al, nomod=>1 &>
                 </td>
                 <td align="right" valign="top">
                    <input type="submit" name="Submit" value="Select CD>>">
                    <input type="hidden" name="id" value="<% $id %>">
                    <input type="hidden" name="album" 
                           value="<% $al->GetId() %>">
                    <input type="hidden" name="toc" value="<% $toc %>">
                    <input type="hidden" name="tracks" value="<% $tracks %>">
                 </td>
               </tr>
               </table>

            </form>
<%perl>
        }
        else
        {
            my $key = $al->GetId();

            $unused{$key} = { name => $al->GetName(), tracks => $num };
        }
    }

</%perl>
%   if (scalar(%unused) > 0) {

        The following CDs are not applicable 
        because they have a different number of tracks than 
        than the CD you are submitting:<p>

%       foreach $i (keys(%unused)) {
           <a href="/showalbum.html?albumid=<% $i %>">
           <% $unused{$i}->{name} %></a> has 
           <% $unused{$i}->{tracks} %> tracks.<br>
%       }

        <p>Even though there may be a CD listed with the same
        name as you are submitting, there sometimes are different
        editions of the same CD that have a different number
        of tracks.
%   }

    <p>If the CD is not listed above 
    you may either try the search again, 
    or click on <font class="bold">New CD</font> to enter the information 
    for this 
    CD. Please make sure to search carefully before you go 
    through the effort to add a new CD.

% } else {

    There were no CDs found given the keywords 
    <font class="bold"><% $search %></font>. You may either try again, 
    or click on <font class="bold">New CD</font> to enter the information 
    for this 
    CD. Please make sure to search carefully before you go 
    through the effort to add a new CD.

% }

<p>
<form method="POST" action="menter.html" 
   enctype="application/x-www-form-urlencoded">
    <table width="100%"><tr><td align=right>
        <input type="submit" name="Submit" value="New CD>>">
    </td></tr></table>
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="tracks" value="<% $tracks %>">
    <input type="hidden" name="toc" value="<% $toc %>">
</form>

<hr><b>Start another CD search:</b><p>

<form method="POST" action="malbum.html" 
   enctype="application/x-www-form-urlencoded">
    <input type="submit" name="Submit" value="Search >>">
    <input type="text" name="search" size="25">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="tracks" value="<% $tracks %>">
    <input type="hidden" name="toc" value="<% $toc %>">
</form>

% $mb->Logout;

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$id
$toc
$search
$tracks
</%args>
<%perl>

my ($mb, $ar, $al, $album, @albums, $num); 

$m->comp('/comp/sidebar', title=>'Submit CD: Select Album');

if (!defined $search || $search eq '')
{
    $m->out("Please enter the CD name. Click on the " .
           "Back button in your browser and try again.");
	$m->comp("/comp/footer");
    return undef;
}

if (!exists $ARGS{toc} || $ARGS{toc} eq '' ||
    !exists $ARGS{id} || $ARGS{id} eq '' ||
    !exists $ARGS{tracks} || $ARGS{tracks} eq '')
{
    $m->comp("/comp/badargs", 1, 1);
    return undef;
}

my (@row, @ids, %labels);
my (%unused, $first, $found);

$first = 1;
$found = 0;

$mb = $m->comp("/comp/dblogin");

$ar = Artist->new($mb->{DBH});
$ar->SetId(&ModDefs::VARTIST_ID);
$ar->LoadFromId();

$al = Album->new($mb->{DBH});

my $eng = SearchEngine->new($mb->{DBH}, "album");

$eng->Search(
	query => $search,
	limit => 0,
);

if ($eng->Rows > 0)
{
    my @row;
    my $i;

    while (my $row = $eng->NextRow)
    {
        $al->SetId($row->{'albumid'});

        next if (!defined $al->LoadFromId());
        
        delete $al->{trackcount};
        $num = $al->GetTrackCount();
        if ($num == $tracks)
        {
            if ($first)
            {
               $first = 0;
               $found = 1;
               $m->out(qq|Please examine the CDs listed below. If one of 
                         the track listings matches the CD that you are 
                         submitting, click on <font class="bold">Select 
                         CD</font> next to 
                         the matching album. If none of the listed CD 
                         match, click on <font class="bold">New CD</font>,
                         at the bottom of this page. If you're unsure as 
                         to which one to pick or you have questions about 
                         this step, please check out our 
                         <a href="/cd_submission.html">CD Submission</a> 
                         document for more details on the submission 
                         process. The CD Index Id for the CD you're 
                         submitting is <b>$id</b> .<br>|);
            }

</%perl>
            <form method="POST" action="found.html" 
                  enctype="application/x-www-form-urlencoded">
               <table width="100%">
               <tr>
                 <td width="100%">
					<& /comp/album, artist=>$ar, album=>$al, showmodlinks=>0 &>
                 </td>
                 <td align="right" valign="top">
                    <input type="submit" value="Select CD &gt;&gt;">
                    <input type="hidden" name="id" value="<% $id %>">
                    <input type="hidden" name="album" 
                           value="<% $al->GetId() %>">
                    <input type="hidden" name="toc" value="<% $toc %>">
                    <input type="hidden" name="tracks" value="<% $tracks %>">
                 </td>
               </tr>
               </table>

            </form>
<%perl>
        }
        else
        {
            my $key = $al->GetId();

            $unused{$key} = { name => $al->GetName(), tracks => $num };
        }
    }

</%perl>
%   if (scalar(%unused) > 0) {

        The following CDs are not applicable 
        because they have a different number of tracks than 
        than the CD you are submitting:<p>

%       foreach $i (keys(%unused)) {
           <a href="/showalbum.html?albumid=<% $i %>">
           <% $unused{$i}->{name} %></a> has 
           <% $unused{$i}->{tracks} %> tracks.<br>
%       }

        <p>Even though there may be a CD listed with the same
        name as you are submitting, there sometimes are different
        editions of the same CD that have a different number
        of tracks.  If you have questions about this step, please 
        check out our <a href="/cd_submission.html">CD Submission</a> document
        for more details on the submission process.<p>
%   }

    <p>If the CD is not listed above 
    you may either try the search again, 
    or click on <font class="bold">New CD</font> to enter the information 
    for this 
    CD. Please make sure to search carefully before you go 
    through the effort to add a new CD.

% } else {

    There were no CDs found given the keywords 
    <font class="bold"><% $search %></font>. You may either try again, 
    or click on <font class="bold">New CD</font> to enter the information 
    for this 
    CD. Please make sure to search carefully before you go 
    through the effort to add a new CD.

% }

<p>
<form method="POST" action="menter.html" 
   enctype="application/x-www-form-urlencoded">
    <table width="100%"><tr><td align=right>
        <input type="submit" value="New CD &gt;&gt;">
    </td></tr></table>
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="tracks" value="<% $tracks %>">
    <input type="hidden" name="toc" value="<% $toc %>">
</form>

<hr><b>Start another CD search:</b><p>

<form method="POST" action="malbum.html" 
   enctype="application/x-www-form-urlencoded">
    <input type="submit" value="Search &gt;&gt;">
    <input type="text" name="search" size="25">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="tracks" value="<% $tracks %>">
    <input type="hidden" name="toc" value="<% $toc %>">
</form>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$tracks
$id
$toc
$artist=>0
$freedb=>0
$parse_artist_track=>""
$parse_track_artist=>""
$sep=>"/"
$noncd=>0
</%args>
<%perl>

unless (MusicBrainz::IsNonNegInteger($tracks) and $tracks >= 1 and $tracks <= 99)
{
	$m->comp("/comp/redirect", '/edit/album/add.html?artistid=' . $artist . '&error=1');
	return;
}

my $mb = new MusicBrainz;

my $lookup;
if ($freedb)
{
   my $fdb = FreeDB->new($mb->{DBH});
   $lookup = $fdb->Lookup($id, $toc);
   if (!$lookup)
   {
       $lookup = undef;
   }
}

</%perl>
<& /comp/sidebar, title=>'Enter Release Information' &>

<& /comp/stylemenu &>

<script type="text/javascript" src="/scripts/entervalidate.js"></script>

% if (defined $lookup) {
     Found CD <font class="bold"><% $lookup->{album} %></font>
     by <font class="bold"><% $lookup->{artist} %></font> at
     <a href="http://www.freedb.org">FreeDB.org</a>.<p>
% } else {
%    if ($freedb) {
         This CD was not found at FreeDB.<p>
%    } else {
%        if ($noncd) {
            Please enter the album information below:<p>
%        } else {
            Please enter the CD information below, or
            click on FreeDB lookup to attempt to load the data for
            this CD from FreeDB:<p>
%        }
%        if (!$freedb && !$noncd) {
           <form method="POST" action="/cdi/menter.html"
                 enctype="application/x-www-form-urlencoded" class="formstyle">
           <input type="hidden" name="id" value="<% $id %>">
           <input type="hidden" name="toc" value="<% $toc %>">
           <input type="hidden" name="tracks" value="<% $tracks %>">
           <input type="hidden" name="freedb" value="1">
           <input type="submit" value="FreeDB Lookup">
           </form>
%        }

%    }
% }

% if (defined $lookup) {
  <table width="400">
     <tr colspan="5">
     If the track names and artist names are the same for all the tracks
     below or if the track and artist names are reversed, then use the
     buttons below to reload this page.<p>

     Choose which way to display the artist and track names, and also
     select a character that is used to separate the artist from the
     track names in this album.<p>

     Current settings: <span class="bold">
%    if ($parse_artist_track ne "") {
        Artist/Track</span>, separated by
%    } else {
        Track/Artist</span>, separated by
%    }
     <span class="bold"><% $sep %></span><p>

     </tr>
     <tr><td align="center">
     <form method="POST" action="/cdi/menter.html"
           enctype="application/x-www-form-urlencoded" class="formstyle">
        Reload CD Info,<br> and display as:<br><br>
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="toc" value="<% $toc %>">
        <input type="hidden" name="tracks" value="<% $tracks %>">
        <input type="hidden" name="freedb" value="1">
        <input type="submit" value="Artist / Track" name="parse_artist_track">
     </td><td align="center">
        use separator:<br><br>
        <input type="text" name="sep" size="3">
     </form>
     </td><td align="center">
        <img src="/images/black_pixel.gif" height="40" width="1" alt="">
     </td><td align="center">
     <form method="POST" action="/cdi/menter.html"
           enctype="application/x-www-form-urlencoded" class="formstyle">
        Reload CD Info,<br> and display as:<br><br>
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="toc" value="<% $toc %>">
        <input type="hidden" name="tracks" value="<% $tracks %>">
        <input type="hidden" name="freedb" value="1">
        <input type="submit" value="Track / Artist" name="parse_track_artist">
     </td><td align="center">
        use separator:<br><br>
        <input type="text" name="sep" size="3">
      </form>
     </td></tr>
  </table>
% }

% if (defined $lookup) {
     <p>Please check the information below for accuracy and correct any
     mistakes you may find:<p>
% }

<form method="POST" action="/cdi/selectattr.html"
	enctype="application/x-www-form-urlencoded"
	onsubmit="return validate(this);">

	<& /comp/autofixmenu &>

	<fieldset>
		<legend>Enter Release Information</legend>
		<table>
			<tr>
%  if ($noncd) {
      			<td colspan="2"><label for="cdi_menter_title"><b>Album Title:</label></td>
%  } else {
      			<td colspan="2"><label for="cdi_menter_title"><b>CD Title:</label></td>
%  }				
%    if (!defined $lookup) {
				<td><input 	type="text" name="title" class="textfield"
						id="cdi_menter_title"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255"></td>
%    } else {
				<td><input 	type="text" name="title" class="textfield"
						id="cdi_menter_title"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="50" maxlength="255"
						value="<% $lookup->{album} %>"></td>
%    }
%    if (!$toc) {
				<td>&nbsp;</td>
%    }
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_ALBUM, 'title');
					-->
					</script></td>
			</tr>

<%perl>
for my $i ( 0 .. $tracks-1 )
{
	my ($artistname, $sortname, $trackname) = ("", "", "");

   if (defined $lookup)
   {
	   $artistname = $trackname = $lookup->{tracks}[$i]{'track'};

       if ($trackname =~ /(.*)\s*\Q$sep\E\s*(.*)/)
       {
           if (defined $1 && defined $2)
           {
              $artistname = ($parse_artist_track ne '') ? $1 : $2;
              $trackname = ($parse_artist_track ne '') ? $2 : $1;
           }
       }

	   MusicBrainz::TrimInPlace($artistname, $trackname);
       my $st = Style->new;
       $sortname = $st->MakeDefaultSortname($artistname);
   }
</%perl>

			<tr><td>&nbsp;</td></tr>
			<tr>
				<td valign="top"><label for="cdi_menter_track<% $i %>"><b><% $i + 1 %></label></td>
				<td align="right" valign="top">Track Name:</td>
				<td>
					<input	type="text" name="track<% $i %>" class="textfield"
							id="cdi_menter_track<% $i %>"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="50" maxlength="255"
							value="<% $trackname %>">
				</td>
% if (!$toc) {
				<td>
					<input	type="text" name="tracklength<% $i %>" class="textfield"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="4"
							value="?:??">
% }
				</td>
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_TRACK, 'track<% $i %>');
					-->
					</script></td>
			</tr>
			<tr>
				<td colspan="2" align="right" valign="top">Artist Name:</td>
				<td><input	type="text" name="artistname<% $i %>" class="textfield"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="50" maxlength="255"
							value="<% $artistname %>"></td>
% if (!$toc) {
				<td>&nbsp;</td>
% }
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_ARTIST, 'artistname<% $i %>');
					-->
					</script></td>
			</tr>
			<tr>
				<td colspan="2" align="right" valign="top">Sort Name:</td>
				<td><input	type="text" name="sortname<% $i %>" class="textfield"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="50" maxlength="255"
							value="<% $sortname %>"></td>
% if (!$toc) {
				<td>&nbsp;</td>
% }
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_SORTGUESS, 'artistname<% $i %>', 'sortname<% $i %>');
						af_writeButton(AF_BTN_SORTCOPY, 'artistname<% $i %>', 'sortname<% $i %>');
					-->
					</script></td>
			</tr>
% }
			<tr>
% if (!$toc) {
				<td colspan="4"></td>
% } else {
				<td colspan="3"></td>
% }
				<td>
					<script type="text/javascript">
					<!--
						function doGuessAll(theForm) {
							doAlbumName(theForm, 'title');
% for my $i ( 0 .. $tracks-1 ) {
							doTrackName(theForm, 'track<% $i %>');
							doArtistName(theForm, 'artistname<% $i %>');
							doSortNameGuess(theForm, 'artistname<% $i %>', 'sortname<% $i %>');
% }
						}
						af_writeButton(AF_BTN_ALL, AF_BTNTEXT_ALBUMARTISTSORTNAMEANDTRACKS);
					-->
					</script></td>
			</tr>
			<tr>
				<td colspan="2"></td>
				<td colspan="2"><input type="submit" class="button" value="Next &raquo;"></td>
			</tr>
		</table>
	</fieldset>

	<input type="hidden" name="artist" value="<% &ModDefs::VARTIST_ID %>">
	<input type="hidden" name="id" value="<% $id %>">
	<input type="hidden" name="toc" value="<% $toc %>">
	<input type="hidden" name="tracks" value="<% $tracks %>">
	<input type="hidden" name="noncd" value="<% $noncd %>">
</form>

<& /comp/footer &>

<%args>
$tracks
$id
$toc
$artist=>0
$freedb=>0
$parse_artist_track=>""
$parse_track_artist=>""
$sep=>""
</%args>
<%perl>

my ($mb); 
my ($i, $modpending, $ar);
my ($dbh, $sth, $rv);

$mb = new MusicBrainz;
mc_comp("/comp/sidebar", title=>'Enter CD Information');

mc_comp("/comp/stylemenu");

$sep = '/' unless $sep ne '';

my $lookup;
if ($freedb)
{
   my $fdb = FreeDB->new($mb->{DBH});
   $lookup = $fdb->Lookup($id, $toc);
   if (!$lookup)
   {
       $lookup = undef;
   }
}

</%perl>

<& /comp/cdi/entervalidate, formname=>"EnterCD", ismac=>1, 
                            tracks=>$tracks &>

% if (defined $lookup) {
     Found CD <font class="bold"><% $lookup->{album} %></font>
     by <font class="bold"><% $lookup->{artist} %></font> at
     <a href="http://www.freedb.org">FreeDB.org</a>.<p>
% } else {
%    if ($freedb) {
         This CD was not found at FreeDB.<p>
%    } else {
         Please enter the CD information below, or
         click on FreeDB lookup to attempt to load the data for
         this CD from FreeDB:<p>
%        if (!$freedb) {
           <form method="POST" action="/cdi/menter.html" Name="FreeDBLookup"
                 enctype="application/x-www-form-urlencoded" class="formstyle">
           <input type="hidden" name="id" value="<% $id %>">
           <input type="hidden" name="toc" value="<% $toc %>">
           <input type="hidden" name="tracks" value="<% $tracks %>">
           <input type="hidden" name="freedb" value="1">
           <input type="submit" value="FreeDB Lookup" name="Next">
           </form>
%        }

%    }
% }

% if (defined $lookup) {
  <table width="400">
     <tr colspan="5">
     If the track names and artist names are the same for all the tracks
     below or if the track and artist names are reversed, then use the
     buttons below to reload this page.<p>

     Choose which way to display the artist and track names, and also
     select a character that is used to seperate the artist from the 
     track names in this album.<p>

     Current settings: <span class="bold">
%    if ($parse_artist_track ne "") {
        Artist/Track</span>, seperated by 
%    } else {
        Track/Artist</span>, seperated by 
%    }
     <span class="bold"><% $sep %></span><p>

     </tr>
     <tr><td align="center">
     <form method="POST" action="/cdi/menter.html" Name="FreeDBLookup"
           enctype="application/x-www-form-urlencoded" class="formstyle">
        Reload CD Info,<br> and display as:<br><br>
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="toc" value="<% $toc %>">
        <input type="hidden" name="tracks" value="<% $tracks %>">
        <input type="hidden" name="freedb" value="1">
        <input type="submit" value="Artist / Track" name="parse_artist_track">
     </td><td align="center">
        use seperator:<br><br>
        <input type="text" name="sep" size="3">
     </form>
     </td><td align="center">
        <img src="/images/black_pixel.gif" height="40" width="1">
     </td><td align="center">
     <form method="POST" action="/cdi/menter.html" Name="FreeDBLookup"
           enctype="application/x-www-form-urlencoded" class="formstyle">
        Reload CD Info,<br> and display as:<br><br>
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="toc" value="<% $toc %>">
        <input type="hidden" name="tracks" value="<% $tracks %>">
        <input type="hidden" name="freedb" value="1">
        <input type="submit" value="Track / Artist" name="parse_track_artist">
     </td><td align="center">
        use seperator:<br><br>
        <input type="text" name="sep" size="3">
      </form>
     </td></tr>
  </table>
% }

% if (defined $lookup) {
     <p>Please check the information below for accuracy and correct any
     mistakes you may find:<p>
% }

<form method="POST" action="/cdi/done.html" Name="EnterCD"
      enctype="application/x-www-form-urlencoded" class="formstyle">

<table>
<tr>
   <td colspan="2" align="right" valign="top">CD Title:</td>
   <td>
%    if (!defined $lookup) {
          <input type="text" name="title" size="50" maxlength="255"><p>
%    } else {
          <input type="text" name="title" size="50" maxlength="255"
                value="<% $lookup->{album} %>"><p>
%    }
   </td>
</tr>

<%perl>
my ($artistname, $sortname, $trackname, $temp, $array);

if ($sep eq ')' || $sep eq '(' || $sep eq '*' || 
    $sep eq '?' || $sep eq '+' || $sep eq '.' ||
    $sep eq '[' || $sep eq ']' || $sep eq '.')
{
   $sep = "\\$sep";
}

for($i = 0; $i < $tracks; $i++) 
{
   $artistname = $trackname = "";
   if (defined $lookup)
   {
       my $exp;

       $array = $lookup->{tracks};
       $temp = $$array[$i]->{track};
       $artistname = $trackname = $temp;

       $exp = '(.*)\s*'.$sep.'\s*(.*)';
       if ($temp =~ m|$exp|)
       {
           if (defined $1 && defined $2)
           {
              $artistname = ($parse_artist_track ne '') ? $1 : $2;
              $trackname = ($parse_artist_track ne '') ? $2 : $1;
           }
       }

       $artistname =~ s/^\s*(.*?)\s*$/$1/;
       $trackname =~ s/^\s*(.*?)\s*$/$1/;
       my $st = Style->new;
       $sortname = $st->MakeDefaultSortname($artistname); 
   }
   
</%perl>
    <tr>
       <td valign="top"><font class="bold">Track <% $i + 1 %>:</font></td>
      <td align="right" valign="top">Track Name:</td>
      <td>
         <input type="text" name="track<% $i %>" size="50" maxlength="255"
                value="<% $trackname %>">
      </td>
    </tr>

    <tr>
      <td colspan="2" align="right" valign="top">Artist Name:</td>
      <td><input type="text" name="artistname<% $i %>" size="50" maxlength="255"
                value="<% $artistname %>"></td>
    </tr>

    <tr>
      <td colspan="2" align="right" valign="top">Sort Name:</td>
      <td><input type="text" name="sortname<% $i %>" size="50" maxlength="255"
                value="<% $sortname %>"><p></td>
    </tr>
% }
</table>

<input type="hidden" name="artist" value="<% Artist::VARTIST_ID %>">
<input type="hidden" name="id" value="<% $id %>">
<input type="hidden" name="toc" value="<% $toc %>">
<input type="hidden" name="tracks" value="<% $tracks %>">
<input type="submit" value="Next>>" name="Next"
       onClick="return validate(form);">
</form>

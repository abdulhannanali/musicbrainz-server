<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Search for releases of a given artist to attribute a DiscID to.
	#
	# $Id$
	#
</%perl>
<%args>

	$discid => undef
	$toc => undef
	$tracks => undef
	$artistid => 0
	$showallreleases => 0

</%args>
<%perl>

	# only logged in users with a valid e-mail address can
	# see this page.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	$m->comp("/comp/sidebar-notitle", pagetitle => "Select Release");

	# make sure we got a valid toc parameter
	MusicBrainz::Server::Validation::IsSingleLineString($toc) && $toc ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>toc</strong> is missing or has a wrong format.");

	# make sure we got a valid releaseid parameter
	MusicBrainz::Server::Validation::IsSingleLineString($discid) && $discid ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>discid</strong> is missing or has a wrong format.");

	# make sure we got a valid tracks parameter
	MusicBrainz::Server::Validation::IsNonNegInteger($tracks) && $tracks
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>tracks</strong> is missing or has a wrong format.");

	# make sure we got a valid releaseid parameter
	MusicBrainz::Server::Validation::IsNonNegInteger($artistid) && $artistid
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>artistid</strong> is missing or has a wrong format.");

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");
	my $artist = $m->comp("/comp/loadartist", $mb, $artistid);

	# output the artist header
	$m->comp("/comp/artisttitle", artist => $artist, showmodlinks => 1, link => 1);
	$m->out('<br/>');

	# get all releases, and sort out the unapplicable ones
	my ( $release, @foundreleases, %unused);
	my @releaselist = sort { $a->{name} cmp $b->{name} } $artist->GetAlbums(0, 1);
	for(;;)
	{
		$release = shift @releaselist;
		last if (!defined $release);
		next if $release->IsNonAlbumTracks;
		if ($release->GetTrackCount() == $tracks)
		{
			push @foundreleases, $release
		}
		else
		{
			my $key = $release->GetId();
			$unused{$key} = $release;
		}
	}

	if (@foundreleases > 0)
	{
		my $foundnum = @foundreleases;

		my $title = "Artist has $foundnum release";
		$title .= ($foundnum == 1 ? "" : "s");
		$title .= " with $tracks track";
		$title .= ($tracks == 1 ? "" : "s");

</%perl>

	<& /comp/tablebegin, title => $title &>

		<& /comp/form/steps,
			steps => ["Lookup CD", "Select Artist", "Attach Disc ID"],
			curr => 2 &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li>
							Please examine the releases listed below. If one of
							the track listings matches the release that you are submitting,
							click on the <strong>Select Release &raquo;</strong>
							button next to the matching release to attach the
							table of contents information of your media to
							this release.</li>
						<li>
							If none of the listed releases match, click on
							the <strong>Enter new Release &raquo;</strong> button
							below to enter your copy into MusicBrainz.</li>
						<li>
							If you are unsure as to which one to pick or you have
							questions about this step, please check out our <& /comp/linkdoc,
							"DiscSubmission", "CD Submission document" &> for more details
							on the submission process. The <& /comp/linkdoc, "DiscID",
							"Disc ID" &> for the CD you have looked up is <strong><% $discid %></strong>.</li>
					</ul>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

	<table cellspacing="0" cellpadding="0" border="0" width="80%">

%		foreach $release (@foundreleases)
%		{
%			my ($name, $releasename);

		<tr valign="top">
			<td width="100%">
				<& /comp/album,
					artist => $artist, album => $release,
					showmodlinks => 0, showrelationships => 0 &></td>

			<td>&nbsp;&nbsp;&nbsp;</td>
			<td align="right">
				<form method="post" action="/cdi/selectrelease.html">
					<input type="submit" class="button" value="Select Release &raquo;" />
					<input type="hidden" name="releaseid" value="<% $release->GetId() %>" />
					<input type="hidden" name="discid" value="<% $discid %>" />
					<input type="hidden" name="toc" value="<% $toc %>" />
					<input type="hidden" name="tracks" value="<% $tracks %>" />
				</form>
			</td>
		</tr>
%		}

	</table>

%	}
%	else
%	{

	<& /comp/tablebegin, title => "Artist has no releases with $tracks tracks" &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li>There were no releases with <% $tracks %> tracks found. </li>
						<li>Please click on the <strong>Enter new Release &raquo;</strong>
							button if you want to add your copy to MusicBrainz.</li>
					</ul>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

%	}

	<& /comp/tablebegin, title => "Enter new release" &>

		<& /comp/form/steps,
			steps => ["Lookup CD", "Select Artist", "Select Release", "Enter Information", "Finish"],
			curr => 2 &>

		<table class="formstyle">
			<tr>
				<td class="label">&nbsp;</td>
				<td>
					<form method="post" action="enter.html">
						<input type="submit" class="button" value="Enter new Release &raquo;">
						<input type="hidden" name="artistid" value="<% $artistid %>">
						<input type="hidden" name="discid" value="<% $discid %>">
						<input type="hidden" name="toc" value="<% $toc %>">
						<input type="hidden" name="hasmultipletrackartists" value="<% $artistid == &ModDefs::VARTIST_ID ? 1 : 0 %>">
						<input type="hidden" name="tracks" value="<% $tracks %>">
					</form>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>


%	# we got releases with different number of tracks
%	# list them, and explain why they are not applicable
%	# for the current DiscID
%   if (scalar(keys(%unused)) > 0)
%	{

	<& /comp/tablebegin, title => "Releases with different number of tracks" &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li><strong>What if my release is listed here?</strong>
							The following releases of this artist are not applicable
							because they have a different number of tracks than
							the CD you are submitting. Even though there may be
							a release listed with the same name, there sometimes are
							different editions of the same release which have a
							different number of tracks. (Example: International
							vs. Japan releases / Remastered editions with bonus tracks etc.)</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="searchresults">
			<tr class="searchresultsheader">
				<td width="40">Tracks:</td>
				<td>Release Title:</td>
			</tr>

%		# sort unapplicable releases by name.
%		my @sortedkeys = sort {
%			(lc($unused{$a}->GetName) cmp
%			 lc($unused{$b}->GetName))
%
%		} keys %unused;
%
%		my $i = 0;
%		foreach my $releaseid ( @sortedkeys )
%		{
%			$release = $unused{$releaseid};
%
%			if ($i == 10)
%			{
%				if (!$showallreleases)
%				{

			<tr>
				<td>&nbsp;</td>
				<td>
					<form action="searchartistrelease.html" method="get">
						<div>
							<input type="submit" value="Show all releases &raquo;" />

							<& /comp/form/hiddenfield, "discid", $discid &>
							<& /comp/form/hiddenfield, "toc", $toc &>
							<& /comp/form/hiddenfield, "tracks", $tracks &>
							<& /comp/form/hiddenfield, "artistid", $artistid &>
							<& /comp/form/hiddenfield, "showallreleases", 1 &>
						</div>
					</form>
				</td>
			</tr>
%					last;
%				}
%			}
			<tr class="searchresults<% $i++ % 2 == 0 ? "even" : "odd" %>">
				<td width="40"><img src="/images/notes.gif" alt="" title="Tracks" /> <% $release->GetTrackCount %></td>
				<td><& /comp/linkrelease, release => $release, strong => 0 &></td>
			</tr>
%       }

		</table>

	<& /comp/tableend &>

%   }

	<& /comp/js/diffcollapse &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

%# vi: set ts=4 sw=4 ft=mason :
<%args>

	$discid
	$toc
	$search
	$tracks => ""

</%args>

	<& /comp/sidebar-notitle, pagetitle => "Search for Release" &>

<%perl>

	# make sure we got a valid toc parameter
	MusicBrainz::IsSingleLineString($toc) && $toc ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>toc</strong> is missing or has a wrong format.");

	# make sure we got a valid releaseid parameter
	MusicBrainz::IsSingleLineString($discid) && $discid ne ""
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>discid</strong> is missing or has a wrong format.");

	# make sure we got a valid tracks parameter
	MusicBrainz::IsNonNegInteger($tracks) && $tracks
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>tracks</strong> is missing or has a wrong format.");

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# Maintain a list of Artists cached by ID.
	my $GetCachedArtist = do
	{
		my %cache;
		sub
		{
			my ($id) = @_;
			return $cache{$id} if (exists $cache{$id});
			my $artist = $m->comp("/comp/loadartist", $mb, $id);
			return ($cache{$id} = $artist);
		};
	};

	my (%usedartists,  %unusedartists);
	my ($countused,  $countunused);

	# Search for releases using the SearchEngine
	my $eng = SearchEngine->new($mb->{DBH}, "album");
	$eng->Search(
		query => $search,
		limit => 0,
	);

	if ($eng->Rows > 0)
	{
		my @row;
		while (my $row = $eng->NextRow)
		{
			my $release = $m->comp("/comp/loadrelease", $mb, $row->{'albumid'});
			next if $release->IsNonAlbumTracks;

			# TODO move this method to somewhere more suitable
			$release->{_name_} = Moderation->_normalise_strings($release->GetName);

			my $artistid = $release->GetArtist;
			my $artist = &$GetCachedArtist($artistid);

			if ($release->GetTrackCount() == $tracks)
			{
				unless ($usedartists{$artistid})
				{
					$usedartists{$artistid} = $artist;
					$artist->{_sortname_} = Moderation->_normalise_strings($artist->GetSortName);
				}

				push @{ $usedartists{$artistid}{_releases_} }, $release;
				$countused++;
			}
			else
			{
				unless ($unusedartists{$artistid})
				{
					$unusedartists{$artistid} = $artist;
					$artist->{_sortname_} = Moderation->_normalise_strings($artist->GetSortName);
				}

				push @{ $unusedartists{$artistid}{_releases_} }, $release;
				$countunused++;
			}
		}
	}

	if ($countused)
	{
		my $title = "Found $countused release";
		$title .= ($countused == 1 ? "" : "s");
		$title .= " with $tracks track";
		$title .= ($tracks == 1 ? "" : "s");

</%perl>

	<& /comp/tablebegin, title => $title &>

		<& /comp/form/steps,
			steps => ["Lookup CD", "Select Release", "Attach Disc ID"],
			curr => 1 &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li>
							Please examine the releases listed below. If one of
							the track listings matches the release that you are submitting,
							click on the <strong>Select Release &raquo;</strong>
							button next to the matching release to attach the
							table of contents information of your media to
							this release.</li>
						<li>
							If none of the listed releases match, click on
							the <strong>Enter new Release &raquo;</strong> button
							below to enter your copy into MusicBrainz.</li>
						<li>
							If you are unsure as to which one to pick or you have
							questions about this step, please check out our <& /comp/linkdoc,
							"DiscSubmission", "CD Submission document" &> for more details
							on the submission process. The <& /comp/linkdoc, "DiscID",
							"Disc ID" &> for the CD you have looked up is <strong><% $discid %></strong>.</li>
					</ul>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

	<table cellspacing="0" cellpadding="0" border="0" width="80%">

%		for my $artist (sort { $a->{_sortname_} cmp $b->{_sortname_} } values %usedartists)
%		{
		<tr valign="top">
			<td width="100%" colspan="3">

%				# render artist link only, instead of comp/artisttitle
				<div style="margin-bottom: 3px">Artist:
					<& /comp/linkartist, artist => $artist &>
				</div>
			</td>
		</tr>

%			for my $release (sort { $a->{_name_} cmp $b->{_name_} } @{ $artist->{_releases_} })
%			{

		<tr valign="top">
			<td width="100%" style="padding-left: 47px">
				<& /comp/album, album => $release, artist => $artist, showmodlinks => 0 &>
			</td>
			<td>&nbsp;&nbsp;&nbsp;</td>
			<td align="right">
				<form method="post" action="/cdi/selectrelease.html">
					<input type="submit" class="button" value="Select Release &raquo;" />
					<input type="hidden" name="releaseid" value="<% $release->GetId() %>" />
					<input type="hidden" name="discid" value="<% $discid %>" />
					<input type="hidden" name="toc" value="<% $toc %>" />
					<input type="hidden" name="tracks" value="<% $tracks %>" />
				</form>
			</td>
		</tr>

%			}
%		}
</%perl>

	</table>


%	}
%	elsif ($search ne "")
%	{

	<& /comp/tablebegin, title => "No releases matching the search found with $tracks tracks" &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li>There were no releases with <% $tracks %> tracks found. </li>
						<li>Please click on the <strong>Enter new Release &raquo;</strong>
							button if you want to add your copy to MusicBrainz.</li>
					</ul>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

%	}

</%perl>

	<& /comp/tablebegin, title => "Search for Release" &>

		<table class="formstyle">
			<tr>
				<td class="label">Search for:</td>
				<td>
					<form method="post" action="searchrelease.html">
						<input type="text" name="search" size="25" value="<% $search %>">
						<input type="submit" value="Search &raquo;">
						<input type="hidden" name="discid" value="<% $discid %>">
						<input type="hidden" name="tracks" value="<% $tracks %>">
						<input type="hidden" name="toc" value="<% $toc %>">
					</form>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

%	if ($search ne "")
%	{

	<& /comp/tablebegin, title => "Enter new release" &>

		<& /comp/form/steps,
			steps => ["Lookup CD", "Select Release", "Enter Information", "Finish"],
			curr => 1 &>

		<table class="formstyle">
			<tr>
				<td class="label">&nbsp;</td>
				<td>
					<form method="post" action="enter.html">
						<input type="submit" class="button" value="Enter new Release &raquo;" />
						<input type="hidden" name="artistid" value="<% &ModDefs::VARTIST_ID %>" />
						<input type="hidden" name="discid" value="<% $discid %>" />
						<input type="hidden" name="toc" value="<% $toc %>" />
						<input type="hidden" name="tracks" value="<% $tracks %>" />
						<input type="hidden" name="hasmultipletrackartists" value="0" />
					</form>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>


%	}

%   if ($countunused)
%	{

	<& /comp/tablebegin, title => "Found $countunused Releases with different number of tracks" &>

		<table class="formstyle">
			<tr>
				<td>
					<ul>
						<li><strong>What if my release is listed here?</strong>
							The following releases are not applicable because
							they have a different number of tracks than
							the CD you are submitting. Even though there may be
							a release listed with the same name, there sometimes are
							different editions of the same release which have a
							different number of tracks. (Example: International
							vs. Japan releases / Remastered editions with bonus tracks etc.)</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="searchresults">
			<tr class="searchresultsheader">
				<td width="40">Tracks:</td>
				<td>Release Title:</td>
				<td>Release Artist:</td>
			</tr>
<%perl>

		my $i = 0;
		for my $artist (sort { $a->{_sortname_} cmp $b->{_sortname_} } values %unusedartists)
		{
			for my $release (sort { $a->{_name_} cmp $b->{_name_} } @{ $artist->{_releases_} })
			{

</%perl>
			<tr class="searchresults<% $i++ % 2 == 0 ? "even" : "odd" %>">
				<td width="40"><img src="/images/notes.gif" alt="" title="Tracks" /> <% $release->GetTrackCount %></td>
				<td><& /comp/linkrelease, release => $release, strong => 0 &></td>
				<td><& /comp/linkartist, artist => $artist, strong => 0 &></td>
			</tr>
%       	}
%		}

		</table>

	<& /comp/tableend &>

%   }


	<script type="text/javascript" src="/scripts/collapsereleases.js"></script>

<& /comp/footer &>

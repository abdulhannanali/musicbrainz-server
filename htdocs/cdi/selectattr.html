%# vi: set ts=4 sw=4 ft=mason :
<%perl>

$m->comp("check-all-entered", %ARGS) or return;

$m->comp("check-TracksNamedWithSequence", %ARGS) or return
	unless $ARGS{"force-TracksNamedWithSequence"};

$m->comp("check-macsac", %ARGS) or return
	unless $ARGS{"force-macsac"};

$m->comp("check-language-and-script", %ARGS) or return;

$m->comp("check-releases", %ARGS) or return;

my $mb = $m->comp("/comp/dblogin");
$m->comp("/comp/sidebar", title=>'Select Album Attributes');

# Calculate the disc length so we can guess what type of release this is
my $disclength;

if (my $dur = $ARGS{durations})
{
	$disclength = 0;
	$disclength += $1 while $dur =~ /(\d+)/g;
}
elsif (my $toc = $ARGS{toc})
{
	my %p = MusicBrainz::Server::CDTOC->ParseTOC($toc);
	$disclength = $p{leadoutoffset} / 75 * 1000 if %p;
}
else
{
	$disclength = 0;
	for(my $i = 0; $i < $ARGS{"tracks"}; $i++)
	{
		my $length = Track::UnformatTrackLength($ARGS{"tracklength$i"});
		$disclength += $length if $length > 0;
	}
}

# Always default to not selecting any attributes
my @attr = (0,0);

# Guess the release type
#
#my @attr = (Album::ALBUM_ATTR_ALBUM, Album::ALBUM_ATTR_OFFICIAL);
#
#$attr[0] = Album::ALBUM_ATTR_COMPILATION
#	if $ARGS{artist} == &ModDefs::VARTIST_ID;
#
#$attr[0] = Album::ALBUM_ATTR_SINGLE
#	if ($disclength ? ($disclength < 30*60*1000) : ($ARGS{tracks} <= 5));
#
#$attr[0] = Album::ALBUM_ATTR_EP
#	if $ARGS{title} =~ /\bEP\b/i;

my $selected_index = 0;

</%perl>

<form method="POST" action="/cdi/done.html" Name="SelectAttrs"
      enctype="application/x-www-form-urlencoded" class="formstyle">
	
% my @focus_to;
	<& /comp/albumattrform,
		adding				=> 1,
		albumname			=> $ARGS{'title'},
		multi_album			=> undef,
		disclength			=> Track::FormatTrackLength($disclength),
		type_value			=> undef,
		status_value		=> undef,
		type_fieldname		=> "attrtype",
		status_fieldname	=> "attrstatus",
		focus_to			=> \@focus_to,
	&>

% for my $key (keys %ARGS) {
	<input type="hidden" name="<% $key %>" value="<% $ARGS{$key} %>">
% }
</form>

<& /comp/movefocus, "SelectAttrs", @focus_to &>

<& /comp/footer &>

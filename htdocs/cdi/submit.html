<%perl>

sub CheckTOC
{
   my ($toc) = @_;

   my @parts = split / /, $toc;

   return 0 if $parts[0] != 1;
   return 0 if $parts[1] < 1;
   return 0 if $parts[1] > 99;
   return 0 if $parts[1] != scalar(@parts) - 3;
   return 0 if $parts[2] <= $parts[scalar(@parts) - 1]; 

   for (3 .. (scalar(@parts) - 2))
   {
       return 0 if ($parts[$_] >= $parts[$_ + 1]);
   }

   return 1;
}

my ($o, $mb, $di, $num_tracks, $notfound);
my ($i, $sth, $album, $valid, $id, $tracks, $toc); 

$m->comp("/comp/sidebar", title=>"Lookup/Submit a CD");

$id = $ARGS{'id'};
$tracks = $ARGS{'tracks'};
$toc = $ARGS{'toc'};
$notfound = $ARGS{'notfound'};

$valid = $id;
$valid =~ tr/_.\-A-Za-z0-9//d;

if (!defined $id || $id eq '' ||
    !defined $tracks || $tracks eq '' ||
    !defined $toc || $toc eq '')
{
    $m->out("The Disc id, TOC and the number of tracks need to be passed in ");
    $m->out("as part of the page URL. Without this information you ");
    $m->out("cannot use these pages to submit a CD. Please use ");
    $m->out("<a href=\"/addalbum.html?artistid=0\">this page</a> ");
    $m->out("instead.");
}
elsif (length($id) == 32 || !defined $toc || $toc eq '')
{
    $m->out('Please <a href="/download.html">download</a> the latest client software.');
}
elsif (length($id) != 28 || substr($id, -1, 1) ne "-" || $valid ne "")
{
    $m->out("The disk id you are trying to submit ($id) is invalid.");
}
elsif (!CheckTOC($toc))
{
    $m->out("The TOC (table of contents) you are trying to submit ($toc) is invalid.");
}
else
{
    $mb = $m->comp("/comp/dblogin");
    $di = Discid->new($mb->{DBH});
    $album = $di->GetAlbumFromDiscid($id);
    if (defined $album)
    {
        my ($al, $ar);

        $al = Album->new($mb->{DBH});
        $al->SetId($album);
        if ($al->LoadFromId())
        {
            $ar = Artist->new($mb->{DBH});
            $ar->SetId($al->GetArtist());
            if ($ar->LoadFromId())
            {
                $m->out("Found album:<p>");
                $m->comp("/comp/artisttitle", artist=>$ar);
                $m->comp("/comp/album", album=>$al, artist=>$ar);
            }
            else
            {
                $m->out("Could not load artist for the album.");
            }
        }
        else
        {
            $m->out("Could not load album.");
        }
    } 
    else 
    {
</%perl> 
        <table>
        <tr>
        <td valign="top" width="50%">
%       if ($notfound) {
            The CD you tried to look up was not found. Please use the
            form below to submit this CD to MusicBrainz.
%       }
        Please follow the instructions below:
        <p>
%       if (!exists $session{user}) {
            <font class="bold">Note:</font> Please 
            log in to get credit for your submission. 
            <p>
% }
        </td>
        <td align="center" width="50%">
%       if (!exists $session{user}) {
            <& /comp/tablebegin, title=>'Moderator Login' &>
            <& /comp/loginbox &>
            <& /comp/tableend &>
% }
        </td>
        </tr>
        </table>

        <center>
        Does the CD have a single artist or multiple artists (compilation)?
        </center>
        <p>
        
        <table cellspacing=0 width="100%">
        <tr>
        <th bgcolor="#FFBA58" valign=top>
        Single Artist CDs
        </th>
        <th bgcolor="#FFBA58" valign=top>
        &nbsp;
        </th>
        <th bgcolor="#FFBA58">
        Multiple Artists CDs (Compilations)
        </th>
        </tr>
        <td align=center>
                                 
        <form method="POST" action="/cdi/artist.html"
              enctype="application/x-www-form-urlencoded" class="formstyle">
        
        <br>Enter the name of the <font color=red>Artist</font><br> and
        click on <b>search</b>:<p>
        
        <input type="text" name="search" size="30">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="toc" value="<% $toc %>">
        <input type="hidden" name="tracks" value="<% $tracks %>">
        <input type="submit" value="Search">
        </form>
        
        </td><td bgcolor="#FFBA58">&nbsp;</td><td align=center valign=top>
        
        <form method="POST" action="/cdi/malbum.html"
              enctype="application/x-www-form-urlencoded" class="formstyle">
        
            <br>Enter the name of the <font color=red>CD</font><br> and
        click on <b>search</b>:<p>
        
        <input type="text" name="search" size="30">
        <input type="hidden" name="id" value="<% $id %>">
        <input type="hidden" name="toc" value="<% $toc %>">
        <input type="hidden" name="tracks" value="<% $tracks %>">
        <input type="submit" value="Search">
        </form>
        
        </td></tr></table>
    
        <center>
        <br><br>
        All data submitted to MusicBrainz will be covered by the 
        <a href="http://opencontent.org/opl.shtml">OpenContent</a> license.
        </center>
%   }
%   $mb->Logout;
% }

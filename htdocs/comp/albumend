<%args>
$artist
$album
$showids=>1
$showreleases=>0
$nomod
</%args>

<%perl>

my (@ids, $id, $rows, $id_numtracks, $numtracks, $duration);

$numtracks = $album->GetTrackCount();

if ($showids)
{
   my $di = Discid->new($album->{DBH});
   @ids = $di->GetDiscidFromAlbum($album->GetId());
}

if (scalar(@ids) > 0) 
{
    $rows = 0;
    foreach $id (@ids)
    {
       $m->out("<tr>");
       if ($album->GetArtist() == &ModDefs::VARTIST_ID) 
       {
          $m->out('<td colspan="3" ');
       }
       else
       {
          $m->out('<td colspan="2" ');
       }
       if ($id->{toc} =~ /^\d* (\d*)/)
       {
          $id_numtracks = $1;
       }
       else
       {
          $id_numtracks = undef;
       }
       if ($id->{toc} =~ /^\d* \d* (\d*)/)
       {
           my $length_in_secs = ($1 / 75);
           $duration = int($length_in_secs / 60) . ":" . 
                           sprintf("%02d",($length_in_secs % 60));
       }
       else
       {
           $duration = undef;
       }

       $m->out($id->{modpending} ? ' bgcolor="#FFFFCC"' : ' bgcolor="#ffecd6"');
       $m->out('>');
       $m->out("CD Index Id: ");

       if (defined $id_numtracks && $id_numtracks != $numtracks)
       {
           $m->out('<font color="red">');
       }
       $m->out($id->{discid});
       if (defined $id_numtracks && $id_numtracks != $numtracks)
       {
           $m->out("</font><br>This id belongs to an album that " .
                  "has $id_numtracks tracks.");
       }

       $m->out('</td><td bgcolor="#ffecd6">');
       if ($duration)
       {
           $m->out("$duration");
       }

       $m->out("</td>");
       if (exists $session{user} && !$nomod) 
       {
           $m->out("<td nowrap align=\"center\" bgcolor=\"#ffecd6\">");
           $m->out("<a href=\"/movediscid.html?discid=$id->{discid}&amp;albumid=");
           $m->out($album->GetId() . "\">Move</a> | ");
           $m->out("<a href=\"/remdiscid.html?discid=$id->{discid}&amp;albumid=");
           $m->out($album->GetId() . "\">Del</a>");
           $m->out("</td>");
       }
       $m->out("</tr>");

       $rows++;
    }

}

if ($showreleases and not $album->IsNonAlbumTracks)
{
	my @releases;
	@releases = $album->Releases;
	my %country_names;
	my $country_obj = MusicBrainz::Server::Country->new($album->{DBH})
		if @releases;

	my $span = 3;
	++$span if $album->GetArtist == &ModDefs::VARTIST_ID;
	++$span unless $nomod;

	$m->out("<tr bgcolor='#ffffff'><td colspan=$span><table>");

	for my $rel (@releases)
	{
		# Country
		my $cid = $rel->GetCountry;
		my $name = (
			$country_names{$cid} ||= do {
				my $c = $country_obj->newFromId($cid);
				$c ? $c->GetName : "?";
			}
		);

		# Date
		my $date = $m->scomp("/comp/releasedate", $rel);

		my $mp = ($rel->GetModPending ? " class='mp'" : "");
		$m->out("<tr$mp><td>$date</td><td>-</td><td>".html_escape($name)."</td></tr>");
	}

	$m->out("<tr><td colspan=2>No release information available</td></tr>")
		unless @releases;

	$m->out("</table></td></tr>");
}

</%perl>
  </table>
</td></tr>
</table> 
% if (exists $session{user} && !$nomod) {
  <table width="100%"><tr><td align="center">
%    if (!$album->IsNonAlbumTracks()) {
         [
%        if ($album->CanAddTrack) {
             <a href="/addtrack.html?album=<% $album->GetId() %>">Add track</a> | 
%        }
           <a href="/movealbum.html?album=<% $album->GetId() %>">Move</a> 
%            if ($album->GetArtist() != &ModDefs::VARTIST_ID) {
              | <a href="/tomac.html?album=<% $album->GetId() %>">Convert to multiple artists</a>
%            } else {
              | <a href="/tosac.html?album=<% $album->GetId() %>">Convert to single artist</a>
%            }
	 | <a href="/mod/edit-releases/index.html?album=<% $album->GetId %>">Edit releases</a>
         ]
%    } else {
         [ <a href="/addnonalbumtracks.html?artistid=<% $album->GetArtist %>">Add a non-album track</a> ]
%    }
</td></tr>
</table> 
% }
<p>

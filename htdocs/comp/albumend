<%args>
$artist
$album
$showids=>1
$showreleases=>0
$showmodlinks => 1
$showtrackartists => 0
</%args>
<%perl>

my $numtracks = $album->GetTrackCount;

my @ids;
if ($showids)
{
   @ids = @{ $album->GetDiscIDs };
}

if (scalar(@ids) > 0)
{
    foreach my $id (@ids)
    {
	my $cdtoc = $id->GetCDTOC;
    	my $duration = Track::FormatTrackLength($cdtoc->GetLeadoutOffset / 75 * 1000);
	my $id_numtracks = $cdtoc->GetTrackCount;
	my $discid = $cdtoc->GetDiscID;

       $m->out("<tr>");
       if ($album->HasMultipleTrackArtists || $showtrackartists)
       {
          $m->out('<td colspan="3" ');
       }
       else
       {
          $m->out('<td colspan="2" ');
       }

       $m->out($id->GetModPending ? ' bgcolor="#FFFFCC"' : ' bgcolor="#ffecd6"');
       $m->out('>');
       $m->out("Disc ID: ");

       if (defined $id_numtracks && $id_numtracks != $numtracks)
       {
           $m->out('<font color="red">');
       }
       $m->out("<a href='/showcdtoc.html?id=".$cdtoc->GetId."'>$discid</a>");
       if (defined $id_numtracks && $id_numtracks != $numtracks)
       {
           $m->out("</font><br>This id belongs to an album that " .
                  "has $id_numtracks tracks.");
       }

       $m->out('</td><td class="discidlength">');
       $m->out("$duration");

       $m->out("</td>");
       if ($session{uid} and $showmodlinks)
       {
	   my $tocid = $cdtoc->GetId;
           $m->out("<td nowrap align=\"center\" bgcolor=\"#ffecd6\">");
           $m->out("<a href=\"/edit/discid/move.html?tocid=$tocid&amp;albumid=");
           $m->out($album->GetId() . "\">Move</a> | ");
           $m->out("<a href=\"/edit/discid/remove.html?tocid=$tocid&amp;albumid=");
           $m->out($album->GetId() . "\">Del</a>");
           $m->out("</td>");
       }
       $m->out("</tr>");
    }
}

if ($showreleases and not $album->IsNonAlbumTracks)
{
	my @releases;
	@releases = $album->Releases;
	my %country_names;
	my $country_obj = MusicBrainz::Server::Country->new($album->{DBH})
		if @releases;

	my $span = 3;
	++$span if ($album->HasMultipleTrackArtists || $showtrackartists);
	++$span if $showmodlinks;

	$m->out("<tr bgcolor='#ffffff'><td colspan=$span>");
	$m->out("<p style='float: right; padding: 2px'>"
		. "<a href='/edit/albumreleases/index.html?album=" . $album->GetId . "'>"
		. "Edit releases</a></p>");
	$m->out("<table>");

	for my $rel (@releases)
	{
		# Country
		my $cid = $rel->GetCountry;
		my $name = (
			$country_names{$cid} ||= do {
				my $c = $country_obj->newFromId($cid);
				$c ? $c->GetName : "?";
			}
		);

		# Date
		my $date = $m->scomp("/comp/releasedate", $rel);

		my $mp = ($rel->GetModPending ? " class='mp'" : "");
		$m->out("<tr$mp><td>$date</td><td>-</td><td>".encode_entities($name)."</td></tr>");
	}

	$m->out("<tr><td colspan=2>No release information available</td></tr>")
		unless @releases;

	$m->out("</table></td></tr>");
}

</%perl>
  </table>
</td></tr>
</table>

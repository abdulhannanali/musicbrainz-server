<%perl>
 	# -----------------------------------------------------------------------------
 	#                               Musicbrainz.org
 	#                        Copyright (c) 2001 Robert Kaye
 	# -----------------------------------------------------------------------------
 	#  This software is provided "as is", without warranty of any kind, express or
 	#  implied, including  but not limited  to the warranties of  merchantability,
 	#  fitness for a particular purpose and noninfringement. In no event shall the
 	#  authors or  copyright  holders be  liable for any claim,  damages or  other
 	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
 	#  from,  out of  or in  connection with  the software or  the  use  or  other
 	#  dealings in the software.
 	#
 	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
 	#  Permits anyone the right to use and modify the software without limitations
 	#  as long as proper  credits are given  and the original  and modified source
 	#  code are included. Requires  that the final product, software derivate from
 	#  the original  source or any  software  utilizing a GPL  component, such  as
 	#  this, is also licensed under the GPL license.
 	# -----------------------------------------------------------------------------
 	#
 	# Summary:
 	# -----------------------------------------------------------------------------
 	# This component allows to search for, and pick an label in a workflow.
 	#
 	# $Id$
 	#
</%perl>
<%args>

	$search => ""
	$searchfieldname => "search"

	$labelfilter_selectedfield => "labelfilter_newlabelid"
	$labelfilter_field => "labelid"

	$cancelbutton => "Cancel"
	$selectbutton => "Select &raquo;"
	$addlabelbutton => "Add new label &raquo;"

	$searchbutton => "Search &raquo;"
	$searchagainbutton => "Search again &raquo;"

	$submitvalue => ""

	$defaultquery => ""
	$performsearch => 1
	@dontshow => ()

	$allowcreate => 1

</%args>
<%perl>

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# use query, or the defaultquery and perform the search.
	$search = $defaultquery if ($search eq "");

	# perform search, unless advised not to.
	my $engine = SearchEngine->new($mb->{DBH}, "label");
	$engine->Search(query => $search, limit => 0)
		if ($performsearch);

	my $searchperformed = $engine->Result != &SearchEngine::SEARCHRESULT_NOQUERY;

	# label reflects if the search has been performed before.
	my $searchlabel = "Search for label:";
	$searchbutton = $searchagainbutton
		if ($submitvalue ne "");


 	if ($submitvalue ne "" and $search eq "")
	{

</%perl>

		<tr>
			<td>&nbsp;</td>
			<td>
				<& /comp/form/feedbackbox, "warning", "Could not search for label:",
					"Please enter a search keyword to start the search." &>
			</td>
		</tr>

%	}

		<tr class="top">
			<td class="label">
				<label for="id_labelfiltersearch"><% $searchlabel %></label></td>
			<td class="field">
					<input type="text" name="<% $searchfieldname %>" id="id_labelfiltersearch" value="<% $search %>" size="40"
						title="Enter a search keyword here" />
			</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td class="submitbuttons">
				<input class="button" type="submit" name="submitvalue"
					value="<% $searchbutton |n %>" title="Search for label" />
				<input class="button" type="submit" name="submitvalue"
					value="<% $cancelbutton |n %>" />

%	# move the keyboard focus to the search field, or the
%	# first label result item.
%	$m->comp("/comp/form/focusfield", "id_labelfiltersearch") if (not $searchperformed);

			</td>
		</tr>

<%perl>

	if ($searchperformed)
	{
		# Retrieve all the results and weed out the "don't show" labels
		my @labelsremoved;
		my @r = do {
			my %dontshow = map { $_=>1 } @dontshow;
			my @r;
			while (my $row = $engine->NextRow)
			{
				if ($dontshow{ $row->{"labelid"} })
				{
					push @labelsremoved, $row->{"labelname"};
					next;
				}
				push @r, $row;
			}
			@r;
		};

		# if we have search results to display.
		if (@r)
		{

</%perl>

		<tr class="spaced">
			<td>&nbsp;</td>
			<td class="formsection">
				The following labels matched your keyword <strong><% $search %></strong>.
				Please select the label you require or try another query. (Hint: You can
				double-click on the radio button to submit the form.)</td>
		</tr>
		<tr class="top">
			<td class="label">
				<label>Found labels:</label></td>
			<td class="field">
				<table border="0" cellspacing="0" cellpadding="0" class="artistfilter-listing">


%				my $checked = ' checked="checked" ';
%				my $i = 0;
%				for my $row (@r)
%				{

				<tr class="row<% $i % 2 %>">
					<td class="radio">
						<input type="radio" name="<% $labelfilter_selectedfield %>"
%								$m->out(qq!id="$labelfilter_selectedfield$i"!) if ($i == 0);
							value="<% $row->{labelid} %>" <% $checked |n %>
							  ondblclick="this.form.submit()"
							  title="Select this label"
						/></td>
					<td class="no"><% $i += 1  %>:</td>
					<td class="link">
						<& /comp/linklabel,
							id => $row->{labelid},
							name => $row->{labelname},
							sortname => $row->{labelsortname},
							resolution => $row->{labelresolution},
							strong => 0 &></td>
				</tr>

%					$checked = "";
%				}

				</table>

				<& /comp/movefocus, id => $labelfilter_selectedfield."0" &>

				<input class="button" name="submitvalue" type="submit" value="<% $selectbutton |n %>"
					title="Choose the selected label"/>
			</td>
		</tr>

%		}
%		else
%		{

		<tr class="spaced top">
			<td class="label">
				No labels found:</td>
			<td class="formsection">
				No label found matching your keyword <strong><% $search %></strong>.
<%perl>

			if (scalar @labelsremoved == 1)
			{
				$m->out(sprintf qq!(Label %s was not shown.)!, $labelsremoved[0]);
			}
			elsif (scalar @labelsremoved)
			{
				$m->out(sprintf qq!(Labels %s were not shown.)!, join(", ", @labelsremoved));
			}

</%perl>

			</td>
		</tr>

<%perl>

 		}
 	}


	if ($searchperformed && $allowcreate)
	{

</%perl>

		<tr class="spaced top">
			<td class="label">
				Add new label?</td>
			<td>
				<& /comp/form/feedbackbox, "warning", "",
					qq!If you did not find the label you were looking for,
					you can search again with another keyword, or if you
					are sure the label was not yet added to the database,
					click on the <strong>Add new label &raquo;</strong> button! &>
			</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td style="padding-bottom: 20px">
				<input class="button" name="submitvalue" type="submit" value="<% $addlabelbutton |n %>"
						title="Add a new label to MusicBrainz" />
				<input type="hidden" name="labelfilter_field" value="<% $labelfilter_field %>" />
			</td>
		</tr>

%	}


%# vi: set ts=4 sw=4 ft=mason :

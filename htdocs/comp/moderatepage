<%args>
$type
$artistid=>0
$albumid=>0
$num=>10
</%args>

<%perl>

my ($mb, @info, $mod, $offset, $page, $comp, $obj);
my ($num_mods, $total_mods, $notes);
my $max_items = $num;

my $allow_skip = 1;
$allow_skip = 0 if $type == ModDefs::TYPE_NEW;
$allow_skip = 0 if $type == ModDefs::TYPE_FREEDB;

$offset = $ARGS{offset};
$offset = 0 if not $allow_skip;
$page = $ARGS{page};
$offset = ($page-1) * $max_items if not defined $offset and defined $page;
$offset = 0 if not defined $offset;
$offset = 0 if $offset < 0;  

$mb = mc_comp("/comp/dblogin");
$mod = Moderation->new($mb->{DBH});

my $show_button = 0;
if ($type == ModDefs::TYPE_NEW)
{
    ($num_mods, $total_mods, @info) = 
           $mod->GetModerationList($offset, $max_items, $session{uid}, $type);
    mc_comp("/comp/sidebar", title=>'Review Pending Moderations',
            expand=>"moderate"); 
}
elsif ($type == ModDefs::TYPE_VOTED)
{
    ($num_mods, $total_mods, @info) = 
           $mod->GetModerationList($offset, $max_items,
                                   $session{uid}, $type);
    mc_comp("/comp/sidebar", title=>'Review Old (Voted) Mods',
            expand=>"moderate"); 
}
elsif ($type == ModDefs::TYPE_MODERATOR)
{
	my $moderator = $ARGS{"moderator"} || $session{uid};
	$moderator = 0 + $moderator;
    ($num_mods, $total_mods, @info) = 
           $mod->GetModerationList($offset, $max_items,
                                   $session{uid}, $type, $moderator);
    mc_comp("/comp/sidebar", title=>'Review Moderation By Moderator',
            expand=>"moderate"); 
}
elsif ($type == ModDefs::TYPE_ARTIST)
{
    ($num_mods, $total_mods, @info) = 
           $mod->GetModerationList($offset, $max_items,
                                   $session{uid}, $type, $artistid);
    mc_comp("/comp/sidebar", title=>'Moderations by Artist',
            expand=>"moderate"); 
}
elsif ($type == ModDefs::TYPE_FREEDB)
{
    ($num_mods, $total_mods, @info) = 
           $mod->GetModerationList($offset, $max_items, $session{uid}, $type);
    mc_comp("/comp/sidebar", title=>'Moderations from FreeDB',
            expand=>"moderate"); 
}
else
{
    mc_comp("/comp/sidebar", title=>'Error', expand=>"moderate"); 
    mc_comp("/comp/badargs");
    $mb->Logout();
    return undef;
}

foreach $obj (@info)
{
    if ($obj->GetModerator() != $session{uid} &&
        $obj->GetVote() == ModDefs::VOTE_NOTVOTED &&
        $obj->GetStatus() == ModDefs::STATUS_OPEN)
    {
       $show_button = 1;
       last;
    }
}

if ($num_mods > 0)
{
   $notes = $mod->LoadModerationNotes($info[0]->GetId(), 
                                   $info[$num_mods-1]->GetId());
}
</%perl>

<table width="100%">
<tr>
<td width="20%" align="center" nowrap>
<% $total_mods + $offset %> mods 
<% $type == ModDefs::TYPE_NEW ? 'pending' : 'total' %>
</td>
<td width="80%" align="center" NOWRAP>
[ <a href="moderate.html?type=1">New Mods</a> |
<a href="moderate.html?type=5">New FreeDB Mods</a> |
<a href="moderate.html?type=3">My Mods</a> |
<a href="moderate.html?type=2">My Votes</a> |
<a href="jumpmod.html">Jump</a> |
<a href="mod_intro.html">Help</a> ]
</td>
</tr>
</table>

% if ($num_mods == 0) {
   <center>
   <br><br>
%  if ($type == ModDefs::TYPE_NEW) {
   There are no new moderations pending. <br>Please
   consider moderating the <a href="/moderate.html?type=5">FreeDB 
   moderations</a>.
%  } elsif ($type == ModDefs::TYPE_VOTED) {
   There are no old (voted on) moderations.
%  } elsif ($type == ModDefs::TYPE_ARTIST) {
   There are no moderations for this artist.
%  } elsif ($type == ModDefs::TYPE_FREEDB) {
   There are no freedb moderations pending.
%  } else {
   You have not entered any moderations.
%  }
   </center>
%  $mb->Logout();
%  return undef;
%}

% if ($allow_skip and ($total_mods > $max_items || $offset > 0)) {
<& /comp/framedboxbegin, width=>"100%" &>
<& /comp/pageselector, 
   url=>"moderate.html?type=$type"
   	. ($ARGS{moderator} ? "&moderator=$ARGS{moderator}" : "")
	. (($artistid > 0) ? "&artistid=$artistid" : ""),
   offset=>$offset,
   pagesize=>$max_items,
   numitems=>$total_mods+$offset,
&>
<& /comp/framedboxend &>
% }

<form method="POST" action="/bare/vote.html"
      enctype="application/x-www-form-urlencoded" class="formstyle"> 

<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0"
       BGCOLOR="#000000" WIDTH="100%">
<TR><TD width="100%">
<TABLE WIDTH="100%" BORDER="0" CELLSPACING="1" CELLPADDING="3">

<%perl>
for my $obj (@info)
{
   mc_comp("/comp/showmod", mod=>$obj, notes=>$notes);
}
</%perl>

</table>
</td></tr>
</table>

% if ($num_mods > 0 && $show_button) {
<table width="100%">
<tr>
  <td width="20%">
     &nbsp;
  </td>
  <td align=right>
     Click here to vote on the items on this page:
     <INPUT TYPE="hidden" NAME="url" 
            VALUE="<% $r->uri() . "?" . $r->args() %>">
     <INPUT TYPE="submit" NAME="Submit" VALUE="Submit">
  </td>
</tr>
</table>
%}

</form>


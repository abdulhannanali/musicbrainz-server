<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Render a track of a release
	#
	# $Id$
	#
</%perl>
<%args>

	$mb
	$artist
	$album
	$track
	$tindex

	$highlight
	$highlightonly => 0

	$puidcount => 0
	$hasannotation => 0

	$showeditlinks
	$mbt
	$showtrackartists
	$showrelationships
	
	$showratings => 0
</%args>
<%perl>

	# track artist are either shown, if there are track artists != release artist
	# or if the link "show track artists" was clicked.
	my $isva = $album->HasMultipleTrackArtists || $showtrackartists;

	# non-album tracks do not show a tracknumber
	# and the tracks title has to span 2 cells, because of that.
	my $nonalbum = $album->IsNonAlbumTracks;
	my $colspan = ($nonalbum ? qq!colspan="2"! : "");

	# start TR
	$m->out(sprintf qq!<tr class="track%s">\n!,
					($highlight and !$highlightonly ? " highlight" : ""));

	# 1. track number
 	unless ($nonalbum)
	{
		# Track Number field is modpending if the modpending flag is
		# raised on the AlbumJoin table.
    	$m->out(sprintf qq!<td class="no%s">%s!,
    					$track->GetAlbumJoinModPending ? " modpending" : "",
    					$track->GetSequence);

		# Accessibility: Removed the asterix (*) signs, uses bold font for
		# highlighting as well as colour.
		# $m->out(($hl ? "**" : "") . $track->GetSequence . ($hl ? "**" : ""));
		$m->out("</td>\n");
	}

	# 2. track title
	$m->out(sprintf qq!<td class="title%s" %s>\n!,
					($track->GetModPending ? " mp" : "")
				   .($isva ? " va" : ""),
					$nonalbum ? qq!colspan="2"! : "");


	# the windows-tagger works track based, show the tagger icon.
	if ($mbt && $showeditlinks and $track->GetId)
	{
        $m->out(qq!<a href="tag:! . $track->GetMBId() . ':' . $album->GetMBId() . qq!">!);
		$m->out(qq!<img src="/images/mblookup-tag.gif" alt="Tag" title="Tag the current track" !);
		$m->out(qq!height="13" width="28" border="0" /></a>&nbsp;!);
	}

	# if the track has a rowid, show track name as link, else text-only.
	if (MusicBrainz::Server::Validation::IsNonNegInteger($track->GetId) && $track->GetId)
	{
		$m->out(sprintf qq!<a href="/track/%s.html" title="">%s</a>!,
						$track->GetMBId,
						encode_entities($track->GetName));
	}
	else
	{
		$m->out(sprintf qq!%s!,
						encode_entities($track->GetName));
	}

	# render PUID/Annotation ID icons
	if ($puidcount > 0)
	{
		$m->out(qq!&nbsp;<img src="/images/puid.gif" alt="PUID" width="35" height="13" title="$puidcount PUIDs" />&nbsp;!);
	}
	if ($hasannotation)
	{
		$m->out(qq!&nbsp;<img src="/images/annotation.gif" alt="Annotation" width="57" height="13" title="This track has an annotation" />&nbsp;!);
	}

	# render ratings
	if ($showratings && $track->GetId)
	{
		$m->comp("/comp/ratingsbox", 
				entity_type => "track",
				entity_id	=> $track->GetId,
				small	=> 1,
				rating => $track->{rating},
				user_rating => $track->{user_rating},
		);
	}

	if ($track->GetId && $showrelationships)
	{
		$m->comp("/comp/release/track_relationships", mb => $mb, track => $track, showeditlinks => $showeditlinks);
	}

	$m->out("</td>\n");


	# 3. track artist
	if ($isva)
	{
		$m->out(qq!<td class="artist">!);

		if (MusicBrainz::Server::Validation::IsNonNegInteger($track->GetArtist) && $track->GetArtist)
		{
			my $artist = $m->comp("/comp/loadartist", $mb, $track->GetArtist);
	       	$m->comp("/comp/linkartist", artist => $artist, strong => 0, icon => 0);

			if (exists $session{user} and $showeditlinks)
			{
				$m->out(sprintf qq! (<a href="/edit/track/change.html?releaseid=%s&amp;tindex=%s&amp;solo=1">Change</a>)!,
								$album->GetId(),
								$tindex);
			}
		}
		else
		{
			$m->comp("/comp/linkartist", id => $track->GetArtist, name => $track->GetArtistName, strong => 0, icon => 0);
		}

		$m->out("</td>\n");
	}

	# 4. length
	my $tracklen = MusicBrainz::Server::Track::FormatTrackLength($track->GetLength);
	$m->out(sprintf qq!<td class="length%s">!, ($track->GetModPending ? " mp" : ""));
	$m->out(length($tracklen)==4 ? "&nbsp;" : "");
	$m->out($tracklen);
	$m->out("</td>\n");

	# 5. links
	if ($session{uid} and $showeditlinks)
	{
		$m->out(qq!<td class="links">!);
       	$m->out(sprintf qq!<a href="/edit/track/edit.html?releaseid=%s&amp;trackid=%s" title="%s">Edit</a>!,
				       	$album->GetId(),
				       	$track->GetId(),
				       	"Edit track title, number and length");
		if ($album->CanRemoveTrack($track->GetSequence))
		{
			$m->out(sprintf qq! | <a href="/edit/track/remove.html?releaseid=%s&amp;trackid=%s" title="%s">Remove</a>!,
							$album->GetId(),
							$track->GetId(),
							"Remove this track from the release");
		}
		else
		{
			$m->out(sprintf qq! | <span class="explain" title="%s">Remove</span>!,
							"Tracks cannot be removed from this release because of attached DiscIDs");
		}
		$m->out("</td>\n");
	}
	$m->out("</tr>\n");

</%perl>

%# vi: set ts=4 sw=4 ft=mason :

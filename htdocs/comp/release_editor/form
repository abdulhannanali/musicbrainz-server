<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Render the release editor form
	#
	# $Id$
	#
</%perl>
<%args>

	$mb

	# discid, toc for /cdi/enter.html
	$discid => ""
	$toc => ""
	$search => ""

	# artist
	$artistid => ""
	$artistname => ""

	# tracks
	$tracks
	$hasmultipletrackartists

	# releaseid for /edit/release/editall.html
	$releaseid => ""
	$releasename => ""

</%args>
<%perl>

	# returns the full name of the given track field
	# in the ARGS hash.
	sub getField {
		my ($i, $name) = @_;
		return sprintf("tr%d_%s", $i, $name);
    }


	my (%checkfields, %checkattributes, %checklanguage, %checkreleases);

	%checkfields = %{ $ARGS{"v::fields"} } if (ref $ARGS{"v::fields"} eq "HASH");
	%checklanguage = %{ $ARGS{"v::language"} } if (ref $ARGS{"v::language"} eq "HASH");
	%checkattributes = %{ $ARGS{"v::attributes"} } if (ref $ARGS{"v::attributes"} eq "HASH");
	%checkreleases = %{ $ARGS{"v::releases"} } if (ref $ARGS{"v::releases"} eq "HASH");

	my $editmode = $ARGS{"v::action"} ne "/cdi/enter.html";
	my $boxtitle = $editmode ? "Edit release" : "Add release";

	my $tabindex = 0;
	my $dummycounter = 0;
	my $labelfor;

	# Maintain a list of Artists cached by ID.
	my $GetCachedArtist = do
	{
		my %cache;
		sub
		{
			my ($id) = @_;
			return $cache{$id} if (exists $cache{$id});
			my $artist = $m->comp("/comp/loadartist", $mb, $id);
			return ($cache{$id} = $artist);
		};
	};

</%perl>

	<form method="post" action="<% $ARGS{"v::action"} %>">

		<& /comp/autofixmenu &>

		<script type="text/javascript" src="/scripts/entervalidate.js"></script>
		<script type="text/javascript" src="/scripts/editallconfig.js"></script>

		<& /comp/layout/editformbegin, title => $boxtitle, mp => $editmode &>

%			# this submit hidden field is needed, if the user submits the form
%			# with a RETURN while the cursor is in a field. It is ignored if
%			# another submit parameter was sent as well (e.g. if a button
%			# other than "Next " was clicked.
			<input type="submit" value="<% $ARGS{"SUBMIT_NEXT"} %>" style="display: none" />

			<& /comp/release_editor/steps, %ARGS, stepsleft => 2 &>

			<table class="formstyle release_editor">

%	if (!$ARGS{"v::edit_track_data"})
%	{

				<tr>
					<td colspan="3">&nbsp;</td>
					<td colspan="4">
						<& /comp/form/feedbackbox, "warning",
							qq! This release has one or more Disc IDs.!,
							qq!	Please note that you cannot add, remove,
								nor renumber tracks because of
								the attached Disc IDs. ! &>
					</td>
				</tr>

%	}

				<tr class="top">
					<td colspan="7" class="formsection">
						<div style="width: 600px; margin-bottom: 10px">
							The fields below allow you to enter track information, and to select
							track artists. Unless the release has attached Disc IDs, you can
							remove tracks by activating the remove button on the left of the track
							title fields. If you are editing a various artists release, or if
							you have choosen to display the track artists, you can activate
							the change button of the artists you would like to change. The page
							will present you choices of existing track artists, once you
							click on the button <strong>Continue &raquo;</strong>. Please use the
							<strong>Guess Case</strong> buttons (or the <strong>Guess All</strong>
							button for all fields) to fix common style errors.
						</div></td>
				</tr>

<%perl>

	# -------------------------------------------------------------------------
	# FREEDB IMPORT
	# -------------------------------------------------------------------------

</%perl>

			<& /comp/release_editor/form-freedblookup, %ARGS &>

<%perl>

	# -------------------------------------------------------------------------
	# SINGLE/MULTIPLETRACKARTISTS TOGGLE
	# -------------------------------------------------------------------------

</%perl>
				<tr id="releaseconfig" class="bottom">
					<td colspan="3">&nbsp;</td>
					<td colspan="2">
						<div id="releaseeditor::config" style="border: 1px dotted #000; padding: 5px; margin: 0px; margin-bottom: 15px">

						<& /comp/form/buttonsubmit,
							value => ($ARGS{"hasmultipletrackartists"}
								? $ARGS{"SUBMIT_ARTISTS_HIDE"}
								: $ARGS{"SUBMIT_ARTISTS_SHOW"}),
							enabled => ($artistid != &ModDefs::VARTIST_ID),
							title => ($artistid == &ModDefs::VARTIST_ID
									? "Releases attached to the special-case artist Various Artists need to have multiple track artists."
									: $ARGS{"hasmultipletrackartists"}
										? "Click this button if you want this release to have one artist for the release and tracks."
										: "Click this button if you want to specify track artists for the tracks other than the release artist."),
						&>

						</div>
					</td>
					<td>&nbsp;</td>
					<td class="linkedits">
%					if ($releaseid)
%					{
						Review edits:
%					}
					</td>
				</tr>

<%perl>
	# -------------------------------------------------------------------------
	# ARTIST NAME
	# -------------------------------------------------------------------------
	# the checkbox which triggers the release artist to be unset if the box
	# was checked. output the selected artist, highlight if it is an existing
	# or new artist which will be added upon submission.
	# $m->out('<span class="mp" title="Artist will be added upon submission">') if ($artistid eq "*");
	# $m->out('</span>') if ($artistid eq "*");

	# try to load the artist, if the artistid is given.
	my $release_artist = undef;
	if ($artistid ne "")
	{
		$release_artist = &$GetCachedArtist($ARGS{"artistid"});
	}

	my $artistlabel = "Artist";
	$artistlabel .= " [!]" if ($checkfields{"artistname"});


</%perl>

				<tr>
					<td class="label">
						<& /comp/form/label, title => $artistlabel &>
					</td>
					<td>&nbsp;</td>
					<td>

%	my $artist_edit = !defined $release_artist || $ARGS{"artistedit"};
%	if (defined $release_artist)
%	{

						<& /comp/form/checkbox-artistchange,
							name => "artistedit",
							checked => $artist_edit &>

%	}

					</td>
					<td colspan="2" id="release_artist::display::::">

%	if (!$artist_edit)
%	{
						<& /comp/linkartist, artist => $release_artist &>
						<& /comp/form/hiddenfield, artistname => $ARGS{"artistname"} &>
%	}
%	else
%	{
						<& /comp/form/textfield,
							name => "artistname",
							id => "id_artistname",
							tabindex => ++$tabindex,
							value => $ARGS{"artistname"},
							cssclass => ($checkfields{"artistname"} ? " missing" : "") &>
%	}
					</td>
					<td>
						<div id="release_artist::fields::::" style="<% $artist_edit ? '' : 'display: none' %>">
							<& /comp/form/jsbutton, id => "BTN_ARTIST::artistname" &>
							<& /comp/form/hiddenfield, artistid => $ARGS{"artistid"} &>
							<& /comp/form/hiddenfield, artistresolution => $ARGS{"artistresolution"} &>
						</div>
					</td>
					<td class="linkedits">
%					if ($releaseid)
%					{
						<& /comp/linkedits, type => "artist", id => $ARGS{"artistid"} &>
%					}
					</td>
				</tr>

<%perl>

	# -------------------------------------------------------------------------
	# RELEASE NAME
	# -------------------------------------------------------------------------

	my $releaselabel = "Release";
	$releaselabel .= " [!]" if ($checkfields{"releasename"});

</%perl>

%	if ($releaseid)
%	{
				<tr>
					<td colspan="3">&nbsp;</td>
					<td colspan="2">
						<& /comp/linkrelease, id => $ARGS{"releaseid"}, name => $ARGS{"releasename"} &>
					</td>
					<td>
					</td>
					<td class="linkedits">
						<& /comp/linkedits, type => "release", id => $ARGS{"releaseid"} &>
					</td>
				</tr>
%	}
				<tr>
					<td class="label">
						<& /comp/form/label, id => "id_releasename", title => $releaselabel &>
					</td>
					<td>&nbsp;</td>
					<td>&nbsp;</td>
					<td colspan="2" class="field">
						<& /comp/form/textfield,
							name => "releasename",
							id => "id_releasename",
							tabindex => ++$tabindex,
							value => $releasename,
							cssclass => ($checkfields{"releasename"} ? " missing" : "") &>
					</td>
					<td>
						<& /comp/form/jsbutton, id => "BTN_ALBUM::releasename" &>
					</td>
				</tr>

%	# -------------------------------------------------------------------------
%	# MAC/SAC WARNING
%	# -------------------------------------------------------------------------

	<& /comp/release_editor/form-macsac, %ARGS &>

<%perl>

	# define array to collect tracktimes
	my @tracktimes;
	for (my $i = 0; $i < $tracks; $i++)
	{
		my $trackid = $ARGS{"trackid$i"} || "";
		my $track = $ARGS{"track$i"} || "";
		my $trackdel = ($ARGS{"trackdel$i"} ? 1 : 0);
		my $trackseq = $ARGS{"trackseq$i"} || ($i+1);
		my $trackmp =  $ARGS{getField($i, "mp")};

		# TODO, get tracklength from toc
		my $tracktime = $ARGS{"tracklength$i"} || "?:??";
		push @tracktimes, $tracktime;

		my $artistidfield = getField($i, "artistid");
		my $artistnamefield = getField($i, "artistname");
		my $artistresolutionfield = getField($i, "artistresolution");
		my $artistvalue = $ARGS{$artistnamefield} || "";

		my $tracklabel = "Track";
		$tracklabel .= " [!]" if (not $trackdel and
								($checkfields{"badsequence"} or
								 $checkfields{"trackseq$i"} or
								 $checkfields{"track$i"} or
								 $checkfields{"tracklength$i"}));


</%perl>


%		# -------------------------------------------------------------------------
%		# TRACKNR, NAME, LENGTH
%		# -------------------------------------------------------------------------

				<tr id="tr<% $i %>_td" class="<% $i % 2 == 0 ? "even" : "odd" %>">
					<td class="label">

%		if ($hasmultipletrackartists)
%		{

						<% $i+1 %>: &nbsp;

%		}

						<& /comp/form/label, id => "id_t$i", title => $tracklabel &>

					</td>
					<td>
						<& /comp/form/tracknumberfield,
							name => "trackseq$i",
							tabindex => ++$tabindex,
							enabled => $ARGS{"v::edit_track_data"} && !$trackdel,
							value => $trackseq,
							cssclass => ($checkfields{"trackseq$i"} || $checkfields{"badsequence"} ? "-missing" : "") &>
					</td>
					<td>

%						# checkbox which can be used to delete a track
						<& /comp/form/checkbox-trackdelete,
							name => "trackdel$i",
							enabled => $ARGS{"v::edit_track_data"},
							checked => $trackdel &>
					</td>
					<td  class="field">
						<& /comp/form/textfield,
							name => "track$i",
							id => "id_t$i",
							tabindex => ++$tabindex,
							value => $track,
							enabled => !$trackdel,
							cssclass => ($checkfields{"track$i"} ? " missing" : "") &>
					</td>
					<td>
						<& /comp/form/tracktimefield,
							name => "tracklength$i",
							tabindex => ++$tabindex,
							value => $tracktime,
							enabled => $ARGS{"v::edit_track_data"} && !$trackdel,
							cssclass => ($checkfields{"tracklength$i"} ? " missing" : "") &>
					</td>
					<td>

%		# guess case button
%		if (!$trackdel)
%		{

						<& /comp/form/jsbutton, id => "BTN_TRACK::track$i" &>

%		}

						<& /comp/form/hiddenfield, "trackid$i", $trackid &>
					</td>
					<td class="linkedits">
%					if ($releaseid)
%					{
						<& /comp/linkedits, type => "track", id => $trackid, mp => $trackmp &>
%					}
					</td>
				</tr>

%		# -------------------------------------------------------------------------
%		# TRACK VALIDATION ERRORS
%		# -------------------------------------------------------------------------
%		if ($ARGS{"v::track$i"} ne "")
%		{

				<tr class="trackerror <% $i % 2 == 0 ? "even" : "odd" %>">
					<td colspan="3">&nbsp;</td>
					<td colspan="4" class="trackerror">

%			my @errors = split /\|/, $ARGS{"v::track$i"};
%			foreach my $err (@errors)
%			{

						&bull; <% $err %> <br/>

%			}

					</td>
				</tr>

%		}


%		# -------------------------------------------------------------------------
%		# MULTIPLETRACKARTISTS: ARTISTNAME FIELD,
%		# -------------------------------------------------------------------------
%
%		my $artistcss = $hasmultipletrackartists ? "" : "display: none";

%		# check, and load artist from track artist id.
%		my $track_artistid = $ARGS{$artistidfield};
%		my $track_artist = &$GetCachedArtist($track_artistid)
%			if ($track_artistid);

%		my $trackartistlabel = "Artist";
%		$trackartistlabel .= " [!]" if ($checkfields{$artistnamefield});

%		$artist_edit = !defined $track_artist || $ARGS{getField($i, "artistedit")};

				<tr id="track_artist::tr::<% $i %>::" style="<% $artistcss %>" class="trackartist <% $i % 2 == 0 ? "even" : "odd" %>">
					<td class="label">
						<& /comp/form/label, title => $trackartistlabel &>
					</td>
					<td>&nbsp;</td>
					<td>

%	if ($track_artistid)
%	{

						<& /comp/form/checkbox-artistchange,
							enabled => !$trackdel,
							name => getField($i, "artistedit"),
							checked => $artist_edit &>

%	}

					</td>
					<td id="track_artist::display::<% $i %>::">

%		# -------------------------------------------------------------------------
%		# DIV WHICH DISPLAYS THE CURRENT SELECTED ARTIST
%		# -------------------------------------------------------------------------
%		if (!$artist_edit)
%		{

						<& /comp/linkartist, artist => $track_artist &>
						<& /comp/form/hiddenfield, $artistnamefield => $track_artist->GetName &>

%		}
%		else
%		{

						<& /comp/form/textfield,
							name => $artistnamefield,
							id => "id_$artistnamefield",
							tabindex => ++$tabindex,
							value => $artistvalue,
							enabled => !$trackdel,
							cssclass => ($checkfields{$artistnamefield} ? " missing" : "") &>

%		}

					</td>
					<td>&nbsp;</td>
					<td class="field">
						<div id="track_artist::fields::<% $i %>::" style="<% $artist_edit ? '' : 'display: none' %>">
							<& /comp/form/jsbutton, id => "BTN_GUESSBOTH::".$artistnamefield."::track$i" &>

							<& /comp/form/hiddenfield, $artistidfield => $ARGS{$artistidfield} &>
							<& /comp/form/hiddenfield, $artistresolutionfield => $ARGS{$artistresolutionfield} &>
						</div>
					</td>
					<td class="linkedits">
%					if ($releaseid)
%					{
						<& /comp/linkedits, type => "artist", id => $track_artistid &>
%					}
					</td>
				</tr>

%		# -------------------------------------------------------------------------
%		# TRACK RELATIONSHIPS PLACEHOLDER
%		# -------------------------------------------------------------------------
				<tr style="display: none">
					<td colspan="3">&nbsp;</td>
					<td colspan="4" id="track::relationship::<% $i %>::" class="tr_relationships"></td>
				</tr>

%	}


%	# -------------------------------------------------------------------------
%	# GUESS ALL
%	# -------------------------------------------------------------------------

				<tr>
					<td colspan="3">&nbsp;</td>
					<td colspan="2"></td>
					<td colspan="2">
						<& /comp/form/jsbutton, id => "BTN_ALL" &>
					</td>
				</tr>


%	# -------------------------------------------------------------------------
%	# BAD SEQUENCE WARNING
%	# -------------------------------------------------------------------------
%	if ($checkfields{"badsequence"})
%	{

				<tr>
					<td colspan="3">&nbsp;</td>
					<td colspan="3">
						<& /comp/form/feedbackbox,
							"warning", "",
							qq!You need to enter a continuous list of
							sequence numbers. Please correct them and re-submit the form.! &>
					</td>
				</tr>

% 	}

%	# -------------------------------------------------------------------------
%	# MISSING FIELDS WARNING
%	# -------------------------------------------------------------------------
%	my $show = ((keys %checkattributes > 0) or
%		  	   (keys %checkfields > 0) or
%		       (keys %checklanguage > 0));

				<tr id="validatemessages" style="<% $show ? "" : "display: none" %>">
					<td colspan="3">&nbsp;</td>
					<td colspan="4">
						<& /comp/form/feedbackbox,
							"warning", "",
							qq!Please enter all the required elements of this release.
							   The missing (or wrong) input fields are marked with
							   a background color, and an exclamation mark [\!] in the
							   respective label.! &>
					</td>
				</tr>


%	# -------------------------------------------------------------------------
%	# RELEASE ATTRIBUTES
%	# -------------------------------------------------------------------------
	<& /comp/release_editor/form-attributes,
		%ARGS,
		artistid => $artistid,
		releasename => $releasename,
		tracktimes => \@tracktimes,
		checkattributes => \%checkattributes,
		tabindex => \$tabindex,
	&>

%	# -------------------------------------------------------------------------
%	# LANGUAGE/SCRIPT
%	# -------------------------------------------------------------------------
	<& /comp/release_editor/form-language-and-script,
		%ARGS,
		mb => $mb,
		tabindex => \$tabindex,
	&>

%	# -------------------------------------------------------------------------
%	# RELEASE EVENTS
%	# -------------------------------------------------------------------------
	<& /comp/release_editor/form-releases,
		%ARGS,
		checkreleases => \%checkreleases,
		tabindex => \$tabindex,
	&>

				<tr>
					<td colspan="7">&nbsp;</td>
				</tr>

				<tr>
					<td colspan="3">&nbsp;</td>
					<td colspan="4" class="submitbuttons">
						<& /comp/form/buttonsubmit,
							value => $ARGS{"SUBMIT_NEXT"},
							tabindex => ++$tabindex,
							id => "btnContinue" &>

						<& /comp/form/buttonsubmit,
							value => $ARGS{"SUBMIT_STARTOVER"},
							tabindex => ++$tabindex, &>

						<& /comp/form/buttonsubmit,
							value => $ARGS{"SUBMIT_CANCEL"},
							tabindex => ++$tabindex, &>

						<& /comp/form/buttonsubmit,
							value => $ARGS{"SUBMIT_ADDTRACK"},
							tabindex => ++$tabindex,
							enabled => $ARGS{"v::edit_track_data"},
							title => $ARGS{"v::edit_track_data"}
								? "Add a new track"
								: "Addition of new tracks disabled due to attached Disc ID(s)",
							id => "btnAddTrack" &>

					</td>
				</tr>
			</table>

		<& /comp/layout/editformend &>


%		# -------------------------------------------------------------------------
%		# HIDDEN FIELDS
%		# -------------------------------------------------------------------------
		<div>
			<& /comp/release_editor/form-hiddenfields, %ARGS &>
		</div>

	</form>

%# vi: set ts=4 sw=4 ft=mason :


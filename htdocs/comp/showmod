<%args>

	$mod
	$voter => $session{uid}
	$notes => []
	$voteflag => undef
	$inline => 0

</%args>
<%perl>

	my $voted = $mod->GetVote;
	$voted = &ModDefs::VOTE_NOTVOTED
		unless defined $voted;

	my $is_open = ($mod->GetStatus == &ModDefs::STATUS_OPEN);
	my $is_mine = ($mod->GetModerator == $session{uid});

	my $time = ($is_open ? $mod->GetExpireTime : $mod->GetCloseTime);
	$time = $m->comp("/comp/datetime", $time);
	$time =~ s/ /&nbsp;/gi;

	# Rough sketch of the layout of a moderation row:

	# ======orange===bar============================================================================+
	# By: modname   ID: ##### (am)| Type: mod type...	 |		1 yes, 1 no					  |
	# Expire[sd]: yyyymmdd.....   | Artist: name...	   | [ Add note | Send email | Delete mod ]  |
	# ----------------------------+-----------------------+-----------------------------------------+
	# previous value shown here   | New value shown here  |  [X] Yes [X] No [X] Abstain			 |
	# ======orange===bar============================================================================+

	# The bottom right cell may contain:
	#	Your vote: Yes
	# [] voting buttons... []
	# Open

</%perl>

%	unless ($inline)
%	{

	<tr>
		<td class="spacer" colspan="3" />
	</tr>

% 	}

	<tr class="showedit">
	   <td class="info">
	   		<table class="editfields">
	   			<tr>
	   				<td>
	   					<& /comp/linkuser,
							id => $mod->GetModerator,
							name => $mod->GetModeratorName,
							title => "Editor",
							shorten => 0,
							strong => 0 &></td>
				</tr>
			</table>

			<div class="attrlist">
	   			Edit ID: <a href="/show/edit/?editid=<% $mod->GetId %>"
						title="View details of this edit"><% $mod->GetId %></a><br/>

% 	if ($mod->GetLanguageId)
%	{
	   			Language: <% $mod->GetLanguage->GetName %><br/>
%	}

%	my $timelbl = ($is_open
%		? $mod->GetExpired ? "Expired" : "Expires"
%		: "Closed");

				<% $timelbl %>: <% $time |n %><br/>

		 	</div>
		</td>

		<td class="type">
			<%perl> $mod->ShowModType($m); </%perl></td>

		<td class="votehead">

%#	if ($is_mine or
%#		not $is_open or
%#		$voted != &ModDefs::VOTE_NOTVOTED)
%#	{
			<% $mod->GetYesVotes %> yes, <% $mod->GetNoVotes %> no
			<br />
%#	}

		[ <a href="/mod/addnote.html?modid=<% $mod->GetId %>" onclick="MyWindow=window.open('/mod/addnote.html?modid=<% $mod->GetId %>','AddNote','toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=400,height=150'); return false;">Add note</a>

% 	my $url = uri_escape($r->uri.'?'.$r->args);
% 	if (!$is_mine and
%		$is_open and
%		UserStuff->IsAutoMod($session{privs}) and
%		$mod->IsAutoModType($mod->GetType))
%	{
			   | <a href="/mod/approve.html?modid=<% $mod->GetId %>&amp;url=<% $url %>">Approve</a>
%	}

%	if ($is_mine and $is_open)
%	{
				| <a href="/mod/remove.html?modid=<% $mod->GetId %>&amp;url=<% $url %>">Delete mod</a>
% 	}
				]
	   </td>
	</tr>
	<tr class="showedit">
		<td class="oldvalue">
			<%perl>$mod->ShowPreviousValue($m, $inline);</%perl></td>

		<td class="newvalue">
			<%perl>$mod->ShowNewValue($m, $inline);</%perl></td>

		<td class="vote">

% 	unless ($voted == &ModDefs::VOTE_NOTVOTED)
%	{
			<% ($voter == $session{uid}) ? "Your" : "Their" %> vote:
			<% MusicBrainz::Server::Vote->GetVoteName($voted) %><br />
%	}

%	if (not $is_mine and
%		$is_open and
%		$session{has_confirmed_email})
%	{
%		$$voteflag = 1 if $voteflag;

			<& /mod/voting-buttons.inc, mod => $mod, vote => $voted, inline => $inline &>
%	}
%	else
%	{

			<% $mod->GetChangeName %>

%		unless ($session{has_confirmed_email})
%		{

			<span style="font-size: 8pt;">
				<br />(No email provided
				<br /> -- you cannot vote)
			</span>
%		}
%	}

		</td>
	</tr>

%	if (@$notes)
%	{

	<tr class="showedit">
		<td colspan="3" class="notes">

			 Notes:<br />

			 <table class="noteslist">

%		my $i = 0;
%		for my $note (@$notes)
%		{
%			my ($strong, $title) = (0, "Voter");
%			($strong, $title) = (1, "Editor") if ($note->GetUserId == $mod->GetModerator);

				<tr class="<% $i++ == 0 ? "first" : $i++ % 2 == 0 ? "even" : "odd" %>">
					<td class="noter">
						<& /comp/linkuser,
							id => $note->GetUserId,
							name => $note->GetUserName,
							strong => $strong,
							icon => 0,
							short => 1,
							title => $title &>:</td>
					<td class="text">

%			$m->out(qq!<span class="modbot">!) if ($note->GetUserId	== &ModDefs::MODBOT_MODERATOR);

						<% $note->GetTextAsHTML |n %>

%			$m->out(qq!</span>!) if ($note->GetUserId == &ModDefs::MODBOT_MODERATOR);

					</td>
					<td class="date">
%			if ($note->GetNoteTime ne "")
%			{
						<span class="date"><% $m->comp("/comp/datetime", $note->GetNoteTime) %></span>
%			}
					</td>
				</tr>
%		}
			</table>
		</td>
	</tr>

%	}

%# vi: set ts=4 sw=4 ft=mason :
<%args>

	$edit
	$voter => $session{"uid"}
	$notes => []
	$voteflag => undef
	$inline => 0

</%args>
<%perl>

	my $voted = $edit->GetVote;
	$voted = &ModDefs::VOTE_NOTVOTED
		unless defined $voted;

	my $is_open = ($edit->GetStatus == &ModDefs::STATUS_OPEN);
	my $is_mine = ($edit->GetModerator == $session{"uid"});

	my $time = ($is_open ? $edit->GetExpireTime : $edit->GetCloseTime);
	$time = $m->comp("/comp/datetime", $time);
	$time =~ s/ /&nbsp;/gi;

	# Rough sketch of the layout of a moderation row:

	# ======orange===bar=============================================================================+
	# By: modname   ID: ##### (am)| Type: mod type...	  |		1 yes, 1 no					         |
	# Expire[sd]: yyyymmdd.....   | Artist: name...	      | [ Add note | Send email | Cancel edit ]  |
	# ----------------------------+-----------------------+------------------------------------------+
	# previous value shown here   | New value shown here  |  [X] Yes [X] No [X] Abstain			     |
	# ======orange===bar=============================================================================+

	# The bottom right cell may contain:
	#	Your vote: Yes
	# [] voting buttons... []
	# Open

</%perl>

%	unless ($inline)
%	{

	<tr>
		<td class="spacer" colspan="3" />
	</tr>

% 	}

	<tr class="showedit">
	   <td class="info">
	   		<table class="editfields">
	   			<tr>
					<td class="lblinfo">Editor: </td>
					<td>
	   					<& /comp/linkuser,
							id => $edit->GetModerator,
							name => $edit->GetModeratorName,
							title => "Editor",
							shorten => 0,
							strong => 1 &>
					</td>
				</tr>
				<tr>
					<td class="lblinfo">Edit ID: </td>
					<td>
						<a href="/show/edit/?editid=<% $edit->GetId %>"
							title="View details of this edit"><% $edit->GetId %></a></td>
				</tr>

% 	if ($edit->GetLanguageId)
%	{

	   			<tr>
	   				<td class="lblinfo">Language: </td>
	   				<td>
	   					<% $edit->GetLanguage->GetName %></td>
	   			</tr>

%	}

% unless ($edit->GetStatus == &ModDefs::STATUS_TOBEDELETED) {
%	my $timelbl = ($is_open
%		? $edit->GetExpired ? "Expired" : "Expires"
%		: "Closed");

				<tr>
					<td class="lblinfo"><% $timelbl %>: </td>
					<td><% $time |n %></td>
				</tr>
% }
		 	</table>
		</td>

		<td class="type">
			<%perl> $edit->ShowModType($m); </%perl></td>

		<td class="votehead">

%	if ($is_mine or
%		not $is_open or
%		$voted != &ModDefs::VOTE_NOTVOTED)
%	{

			<% $edit->GetYesVotes %> yes : <% $edit->GetNoVotes %> no
			<br />

%	}

		[ <a href="/mod/addnote.html?modid=<% $edit->GetId %>" onclick="MyWindow=window.open('/mod/addnote.html?modid=<% $edit->GetId %>','AddNote','toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=200'); return false;">Add note</a>

% 	my $url = uri_escape($r->uri.'?'.$r->args);
% 	if ($is_open and
%		(UserStuff->IsAutoEditor($session{"orig_privs"}) or
%		 UserStuff->IsAutoEditor($session{"privs"})) and
%		$edit->IsAutoEditType($edit->GetType))
%	{

			   | <a href="/mod/approve.html?editid=<% $edit->GetId %>&amp;url=<% $url %>">Approve</a>

%	}

%	if ($is_mine and $is_open)
%	{

				| <a href="/mod/remove.html?editid=<% $edit->GetId %>&amp;url=<% $url %>">Cancel edit</a>

% 	}

				]
	   </td>
	</tr>
	<tr class="showedit">
		<td class="oldvalue">
			<%perl>$edit->ShowPreviousValue($m, $inline);</%perl></td>

		<td class="newvalue">
			<%perl>$edit->ShowNewValue($m, $inline);</%perl></td>

		<td class="vote">

% 	unless ($voted == &ModDefs::VOTE_NOTVOTED)
%	{
			<% ($voter == $session{"uid"}) ? "Your" : "Their" %> vote:
			<% MusicBrainz::Server::Vote->GetVoteName($voted) %><br />
%	}

%	if (not $is_mine and
%		$is_open and
%		$session{"has_confirmed_email"})
%	{
%		$$voteflag = 1 if $voteflag;

			<& /mod/voting-buttons.inc, edit => $edit, vote => $voted, inline => $inline &>

%	}
%	else
%	{

%		my $changename = $edit->GetChangeName;
%		$changename =~ s/ /&nbsp;/g;

		<% $changename |n %>

%		unless ($session{"has_confirmed_email"})
%		{

			<span style="font-size: 8pt;">
				<br />(No email provided
				<br /> -- you cannot vote)
			</span>

%		}
%	}

		</td>
	</tr>

%	if (@$notes)
%	{

	<tr class="showedit">
		<td colspan="3" class="notes">

			 Notes:<br />

			 <table class="noteslist" style="width: 100%">

%		my $i = 0;
%		for my $note (@$notes)
%		{
%			my ($strong, $title) = (0, "Voter");
%			($strong, $title) = (1, "Editor") if ($note->GetUserId == $edit->GetModerator);

				<tr class="noteslist <% $i++ == 0 ? "first" : $i++ % 2 == 0 ? "even" : "odd" %>">
					<td class="noter">
						<& /comp/linkuser,
							id => $note->GetUserId,
							name => $note->GetUserName,
							strong => $strong,
							icon => 0,
							shorten => 0,
							title => $title &>:</td>
					<td class="text">

%			if ($note->GetNoteTime ne "")
%			{

						<span class="date"><% $m->comp("/comp/datetime", $note->GetNoteTime) %></span>

%			}

%			$m->out(qq!<span class="modbot">!) if ($note->GetUserId	== &ModDefs::MODBOT_MODERATOR);

						<% $note->GetTextAsHTML |n %>

%			$m->out(qq!</span>!) if ($note->GetUserId == &ModDefs::MODBOT_MODERATOR);

					</td>
				</tr>

%		}

			</table>
		</td>
	</tr>

%	}

%# vi: set ts=4 sw=4 ft=mason :

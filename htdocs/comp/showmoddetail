<%perl>

	my $edit = shift
		or return;
	my $my_uid = $session{"uid"}
		or return;

	my $my_mod = ($edit->GetModerator == $my_uid);
	my $my_vote = $edit->VoteFromUser($my_uid);
	my $is_open = ($edit->GetStatus == &ModDefs::STATUS_OPEN);
	my $can_vote = UserStuff->CanVote;

	my $see_votes = 1; # ($my_mod or not $is_open);

	my $opentime = $edit->GetOpenTime;
	$opentime = $opentime ? $m->comp("/comp/datetime", $opentime) : "?";

	my $closetime = $edit->GetCloseTime;
	$closetime = $closetime ? $m->comp("/comp/datetime", $closetime) : "-";

	my $expiretime = $edit->GetExpireTime;
	$expiretime = $m->comp("/comp/datetime", $expiretime);

	my $expire_verb = ($edit->GetExpired ? "Expired" : "Expires");

	my $language = $edit->GetLanguage;
	my $quality = $edit->GetQuality;
	my $numvotes = $edit->GetNumVotesNeeded;
	my $expireaction = ModDefs::GetExpireActionText($edit->GetExpireAction);
    
	my @statuslinks = ();
	my $id = $edit->GetId;
	push @statuslinks, qq!<a href="/mod/approve.html?editid=$id">Approve</a>!
		if ($is_open and
			(UserStuff->IsAutoEditor($session{"orig_privs"}) or
		     UserStuff->IsAutoEditor($session{"privs"})) and
		    $edit->IsAutoEditType($edit->GetType));

	push @statuslinks, qq!<a href="/mod/remove.html?editid=$id">Cancel edit</a>!
		if ($my_mod and $is_open);

</%perl>

	<& /comp/tablebegin, title => "Edit information" &>

		<table class="formstyle" style="width: 100%;">
			<tr>
				<td class="label">Editor:</td>
				<td class="field">
					<& /comp/linkuser, id => $edit->GetModerator, name => $edit->GetModeratorName, shorten => 0 &></td>
			</tr>
			<tr>
				<td class="label">Edit ID:</td>
				<td><% $id %></td>
			</tr>
			<tr>
				<td class="label">Status:</td>
				<td>

%		my $changename = $edit->GetChangeName;
%		$changename =~ s/ /&nbsp;/g;

					<% $changename |n %>

%	if (@statuslinks > 0)
%	{
					&nbsp; [ <% join " | ", @statuslinks |n %> ]
%	}
				</td>
			</tr>

% 	if ($language)
%	{

			<tr>
				<td class="label">Language:</td>
				<td><% $language->GetName %></td>
			</tr>

% 	}

			<tr>
				<td class="label">Opened:</td>
				<td><% $opentime %></td>
			</tr>
			<tr>
				<td class="label"><% $expire_verb %>:</td>
				<td><% $expiretime %></td>
			</tr>
			<tr>
				<td class="label">Closed:</td>
				<td><% $closetime %></td>
			</tr>
% 	if ($quality)
%	{
			<tr>
				<td class="label">Conditions:</td>
				<td><% &ModDefs::GetQualityText($quality) %> quality level, 
                    <% $expireaction %> on expiration,
                    <% $numvotes %> unanimous votes to accept/reject</td>
			</tr>
% 	}

			<tr>
				<td></td>
				<td class="separator">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="2">&nbsp;</td>
			</tr>

			<tr class="top">
				<td class="label">Edit:</td>
				<td><%perl> $edit->ShowModType($m, 1); </%perl></td>
			</tr>

			<tr>
				<td colspan="2">&nbsp;</td>
			</tr>

			<tr class="top">
				<td class="label">Changes:</td>
				<td class="editchanges">
					<div>
						<%perl> $edit->ShowPreviousValue($m, 0); </%perl>
					</div>
					<div>
						<%perl> $edit->ShowNewValue($m, 0); </%perl>
					</div>
				</td>
			</tr>

% 	if (not $my_mod)
%	{


% 		if (not $edit->IsAutoEdit)
%		{
			<tr>
				<td></td>
				<td class="separator">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="2">&nbsp;</td>
			</tr>

			<tr class="top">
				<td class="label">My vote:</td>
%			if ($can_vote) {
				<td><%
					$my_vote ? $my_vote->GetVoteName
					: $is_open
						? "You have not voted yet. Please vote now!"
						: "You did not vote"
				%></td>
%			} else {
				<td>You cannot vote on this edit. (<a href="/doc/Voting">Details</a>)</td>
%			}
			</tr>
%		}

% 		if ($is_open && $can_vote)
%		{

			<tr>
				<td class="label">&nbsp;</td>
				<td class="moddetail">
					<form method="post" action="/bare/vote.html">
						<table>
							<tr>
								<td class="vote">
									<& /mod/voting-buttons.inc,
										edit => $edit,
										vote => ($my_vote ? $my_vote->GetVote : undef),
										labelnextline => 1 &></td>
								<td>
									<input type="hidden" name="url" value="/show/edit/?editid=<% $id %>" />
									<input type="submit" value="<% $my_vote ? "Change your vote &raquo;" : "Enter vote &raquo;" |n %>" /></td>
							</tr>
						</table>
					</form></td>
			</tr>

%		}
%	}


%	# Votes
%	if ($see_votes)
%	{

%		if (my @votes = $edit->Votes)
%		{
%			# Find the most recent vote by each voter.
%			# Mark the others as superseded.
%			my %mostrecent;
%			$mostrecent{ $_->GetUserId } = $_->GetId
%				for @votes;

			<tr class="top">
				<td class="label">Votes tally:</td>
				<td><% $edit->GetYesVotes %> Yes :
				<% $edit->GetNoVotes %> No</td>
			</tr>

% 			for my $v (@votes)
%			{
% 				my $is_latest = ($v->GetId == $mostrecent{ $v->GetUserId });


			<tr class="voteslist <% $is_latest ? "" : "supersededvote" %>">
				<td class="voter">
					<& /comp/linkuser,
						id=>$v->GetUserId,
						name => $v->GetUserName,
						icon => 0,
						shorten => 0,
						strong => 0,
						title => "Voter" &>:</td>
				<td class="vote">
					<span class="date">
						<% $m->comp("/comp/datetime", $v->GetVoteTime) %>
					</span>

					<% $v->GetVoteName %>
				</td>
			</tr>

% 			}
% 		}
% 	}



%	# Notes
			<tr>
				<td></td>
				<td class="separator">&nbsp;</td>
			</tr>
			<tr>
				<td colspan="2">&nbsp;</td>
			</tr>

			<tr class="top">
				<td class="label">Edit notes:</td>
				<td>
					[
						<a href="/mod/addnote.html?editid=<% $id %>" id="addnote-top" onclick="jsvoting.toggleNoteText(); return false;">Add note</a>

%						$m->out("&nbsp;|&nbsp;") if (@statuslinks);

						<% join "&nbsp;|&nbsp;", @statuslinks |n %>
					]
				</td>
			</tr>

%	my $i = 0;
%	if (my @notes = $edit->Notes)
%	{

%		for my $note (@notes)
%		{
%			my ($strong, $title) = (0, "Voter");
%			($strong, $title) = (1, "Editor") if ($note->GetUserId == $edit->GetModerator);

			<tr class="noteslist <% $i == 0 ? "first" : $i % 2 == 0 ? "even" : "odd" %>">
				<td class="noter">
					<& /comp/linkuser,
						id => $note->GetUserId,
						name => $note->GetUserName,
						strong => $strong,
						icon => 0,
						shorten => 0,
						title => $title &>:</td>

				<td class="text">


%			if ($note->GetNoteTime ne "")
%			{
					<span class="date"><% $m->comp("/comp/datetime", $note->GetNoteTime) %></span>
%			}

%			$m->out(qq!<span class="modbot">!) if ($note->GetUserId	== &ModDefs::MODBOT_MODERATOR);

					<% $note->GetTextAsHTML |n %>

%			$m->out(qq!</span>!) if ($note->GetUserId == &ModDefs::MODBOT_MODERATOR);



				</td>
			</tr>
			
%			$i++;
%		}
%	}
%	else
%	{

			<tr>
				<td></td>
				<td>(No notes)</td>
			</tr>

%	}

%	# Add user's own note box to end of list of edits
%	my ($strong, $title) = (0, "Voter");
%	($strong, $title) = (1, "Editor") if $my_mod;

			<tr class="noteslist <% $i == 0 ? "first" : ($i % 2 == 0 ? "even" : "odd") %>" style="display: none" id="noteblock">

				<td class="noter">
					<& /comp/linkuser,
						id => $my_uid,
						name => $session{"user"},
						strong => $strong,
						icon => 0,
						shorten => 0,
						title => $title &>:</td>
				<td class="text">
					<form method="post" action="/mod/addnote.html">
					<textarea name="notetext" id="notetext" rows="5" cols="40" style="width: 100%"></textarea>
					<p style="margin: 0pt; text-align: right;">
						<input type="hidden" value="<% $id %>" name="editid"/>
						<input type="submit" value="Add Note Â»" name="submitvalue"/>
						<input type="submit" value="Cancel" onclick="jsvoting.toggleNoteText(); return false;" />
					</p>
					</form>
				</td>
			</tr>



			<tr class="top">
				<td>&nbsp;</td>
				<td>
					[
						<a href="/mod/addnote.html?editid=<% $id %>" id="addnote-bottom" onclick="jsvoting.toggleNoteText(); return false;">Add note</a>

						<%perl>

						$m->out("&nbsp;|&nbsp;") if (@statuslinks);
						$m->out(join "&nbsp;|&nbsp;", @statuslinks);

						</%perl> ]
				</td>
			</tr>
		</table>

	<& /comp/tableend &>


%# vi: set ts=4 sw=4 ft=mason :

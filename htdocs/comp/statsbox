<%perl>

sub StatLine
{
    my ($title, $count) = @_;

    my $r = "<tr><TD valign=top align=right class=\"statsb\">$title</TD>";
    $r .= "<TD valign=top class=\"stats\">$count</td></tr>";
    return $r;
}

my $result = $m->cache(action=>'retrieve');
if (!defined($result) or 1) 
{
    print STDERR "got no stats from cache\n";
    my $mb = mc_comp("/comp/dblogin", quiet=>1);

    if (defined $mb)
    {
	my $stat = Statistic->new($mb->{DBH});
	my %stats = %{ $stat->FetchAllAsHashRef };

             $result = StatLine("Artists", $stats{'count.artist'});
             $result .= StatLine("Albums", $stats{'count.album'});
             $result .= StatLine("Tracks", $stats{'count.track'});
             $result .= StatLine("Discids", $stats{'count.discid'});
             $result .= StatLine("TRM Ids", $stats{'count.trm'});
             $result .= StatLine("Mods", $stats{'count.moderation'});
             $result .= StatLine("Users", $stats{'count.moderator'});

             $result = "<table>$result</table>";

        $m->cache(action=>'store', expire_next=>'hour', value=>$result);
        $mb->Logout();
    }
}
</%perl>

<table cellpadding="10" cellspacing="0" border="0">
<tr>
   <td>
      <table width="100%">
        <tr><td align="center" class="statsb"><% $result |n %></td></tr>
      </table>
   </td>
</tr>
</table>  

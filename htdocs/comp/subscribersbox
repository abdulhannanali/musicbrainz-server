<%args>

	$artist	=> undef
	$label	=> undef
	$editor	=> undef
	
	$title						# title of the box
	$allow_subscribe => 1		# display subscribe/unsubscribe links

</%args>
<%perl>

	my ($object, $type);
	($object, $type) = ($artist, "artist") if $artist;	
	($object, $type) = ($label, "label") if $label;	
	($object, $type) = ($editor, "editor") if $editor;

	defined $object 
		or return $m->comp("/comp/badargs", 1, 1);

	my $mb = $m->comp("/comp/dblogin");

	my @uids = $object->GetSubscribers;

	# compute subscribers list and check if some are privates
	my $my_uid = $session{uid} || 0;
	my $is_current_user_subscribed;
	my @public;
	my $private = 0;

	for my $uid (@uids)
	{
		my $user = UserStuff->newFromId($mb->{DBH}, $uid)
			or next;

		my $is_me = ($uid == $my_uid);
		my $is_public = ($is_me or UserPreference::get_for_user("subscriptions_public", $user));

		$is_current_user_subscribed = 1 if $is_me;

		if ($is_public)
		{
			my $n = MusicBrainz::Server::Validation::NormaliseSortText($user->GetName);
			push @public, [$user->GetId, $user->GetName, $n];
		}
		else
		{
			++$private;
		}
	}

	@public = sort { $a->[2] cmp $b->[2] } @public;

	my $private_str = sprintf "%d anonymous subscriber%s",
		$private, $private==1 ? "" : "s";

</%perl>

<& /comp/tablebegin, title=>$title &>

	<table width="100%" cellspacing="0" cellpadding="0">
		<tr>
			<td style="padding: 0px 4px">
				<%perl>
					if (@public)
					{
						my $i = 0;
						for (@public)
						{
							my ($uid, $name) = @$_;
							$m->out(", ") if $i;
							$m->out(qq|<a href="/show/user/?userid=$uid">$name</a>|);
							++$i;
						}
						$m->out(" plus $private_str") if $private;
						$m->out(".");
					}
					elsif ($private)
					{
						$m->out($private_str);
					}
					else
					{
						$m->out("none");
					}
				</%perl>
			</td>
		</tr>
%	if ($allow_subscribe)
%	{
		<tr>
			<td align="center">
				&nbsp;<br/>
%			if ($is_current_user_subscribed)
%			{
				<a href="/user/subscribe.html?<% $type %>id=<% $object->GetId %>&amp;unsubscribe=1"
					>Unsubscribe from this <% $type  %></a>
%			} 
%			else 
%			{
				<a href="/user/subscribe.html?<% $type %>id=<% $object->GetId %>"
					>Subscribe to this <% $type %></a>
%			}	

			</td>
		</tr>
%	}
	</table>

<& /comp/tableend &>

%# vi: set ts=4 sw=4 ft=mason :

<%args>
	$id => ""
	$showform => 0
	$newtags => undef
	$update => undef
</%args>

<%init>
	my $self = $m->request_comp;
	my $title = $self->attr('title');
	my $entitytype = $self->attr('entitytype');
</%init>

<%perl>

	# Check argument
	MusicBrainz::Server::Validation::IsNonNegInteger($id) && $id
		or return $m->comp("/comp/layout/badarguments", text => "Argument id is required");

	# Instantiate MusicBrainz object, and load entity
	my $mb = $m->comp("/comp/dblogin");
	my $entity = $m->comp("/comp/load$entitytype", $mb, $id);

	my $t = MusicBrainz::Server::Tag->new($mb->{DBH});

	if (defined $update) {
		$m->comp("/comp/checkloggedin", 1, 1)
			or return;
		$t->Update($newtags, $session{uid}, $entitytype, $id);
		$m->comp("/comp/redirect", "/show/$entitytype/tags.html?id=$id");
	}

	my $tags = $t->GetTagHashForEntity($entitytype, $entity->GetId, 100);

	if ($entitytype eq "artist") {
		$m->comp("/comp/sidebar-notitle", pagetitle => "$title: " . $entity->GetName);
		$m->comp("/comp/artisttitle", artist => $entity);
	}
	elsif ($entitytype eq "label") {
		$m->comp("/comp/sidebar-notitle", pagetitle => "$title: " . $entity->GetName);
		$m->comp("/comp/labeltitle", label => $entity);
	}
	else {
		$m->comp("/comp/sidebar", pagetitle => "$title: " . $entity->GetName);
	}

</%perl>

	<script type="text/javascript" src="/scripts/tags.js"></script>

	<p style="margin-bottom: 1em;">
		<% $t->GenerateTagCloud($tags, 12, 30) | n %>
	</p>

%	if ($session{uid}) {
%		if ($showform) {
%			my $rawtags = $t->GetRawTagsForEntity($entitytype, $entity->GetId, $session{uid});
			<form action="/show/<% $entitytype %>/tags.html" method="post">
				Tag this <% $entitytype %>:<br />
				<textarea rows="4" cols="40" name="newtags"><% join ", ", map { $_->{"name"} } @$rawtags %></textarea><br />
				<input type="submit" value="Tag" />
				<input type="hidden" name="update" value="1" />
				<input type="hidden" name="id" value="<% $entity->GetId %>" />
			</form>
%		} else {
			<div id="tagform">
				<p><a id="tagthis" class="<% $entitytype %>::<% $entity->GetId %>" href="/show/<% $entitytype %>/tags.html?id=<% $entity->GetId %>&amp;showform=1">Tag this <% $entitytype %></a></p>
			</div>
%		}
%	}

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

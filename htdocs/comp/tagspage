<%args>
	$id => ""
	$showform => 0
	$newtags => undef
	$update => undef
</%args>

<%init>
	my $self = $m->request_comp;
	my $title = $self->attr('title');
	my $entitytype = $self->attr('entitytype');
</%init>

<%perl>

	# Check argument
	MusicBrainz::Server::Validation::IsNonNegInteger($id) && $id
		or return $m->comp("/comp/layout/badarguments", text => "Argument id is required");

	# Instantiate MusicBrainz object, and load entity
	my $mb = $m->comp("/comp/dblogin");
	my $entity = $m->comp("/comp/load$entitytype", $mb, $id);

	my $t = MusicBrainz::Server::Tag->new($mb->{DBH});

	if (defined $update) {
		$m->comp("/comp/checkloggedin", 1, 1)
			or return;
		$t->Update($newtags, $session{uid}, $entitytype, $id);
		$m->comp("/comp/redirect", "/show/$entitytype/tags.html?id=$id");
	}

	my $tags = $t->GetTagHashForEntity($entitytype, $entity->GetId, 100);
	my $rawtags = undef;
	if ($session{uid}) 
	{
		$rawtags = $t->GetRawTagsForEntity($entitytype, $entity->GetId, $session{uid});
	}

	if ($entitytype eq "artist") {
		$m->comp("/comp/sidebar-notitle", pagetitle => "$title: " . $entity->GetName);
		$m->comp("/comp/artisttitle", artist => $entity, showratings => 1);
	}
	elsif ($entitytype eq "label") {
		$m->comp("/comp/sidebar-notitle", pagetitle => "$title: " . $entity->GetName);
		$m->comp("/comp/labeltitle", label => $entity, showratings => 1);
	}
	elsif ($entitytype eq "release") {
		$m->comp("/comp/sidebar-notitle", pagetitle => "$title: " . $entity->GetName);
		my $artist = $m->comp("/comp/loadartist", $mb, $entity->GetArtist);
		$m->comp("/comp/artisttitle", artist => $artist, showratings => 1);
		$m->comp("/comp/album", artist=>$artist, album => $entity, highlightonly => 1, showratings => 1);
	}
	else {
		$m->comp("/comp/sidebar-notitle", pagetitle => "$title: " . $entity->GetName);
		my $artist = $m->comp("/comp/loadartist", $mb, $entity->GetArtist);
		$m->comp("/comp/tracktitle", track => $entity, artist => $artist, showratings => 1);
	}

</%perl>

	<script type="text/javascript" src="/scripts/tags.js"></script>

	<div class="TagsBox">
    <p>
    [ Show: <a href="/show/tag/all.html">all tags</a> ]
    </p>

	<p style="margin-bottom: 1em; margin-top: 1em">
		<% $t->GenerateTagCloud($tags, $entitytype, 12, 30, $rawtags) | n %>
	</p>

%   if ($session{uid}) {
%       if ($showform) {
%           $rawtags = $t->GetRawTagsForEntity($entitytype, $entity->GetId, $session{uid}) if (!defined $rawtags);
            <div style="float: right">
				<ul>
                <li>Tags are comma separated.</li>
                <li>Only letters, numbers, spaces and - are allowed.</li>
				<li>See <& /comp/linkdoc, "FolksonomyTaggingSyntax", "tag syntax"  &> for details.</li>
                <li>To clear your tags, empty the text box and click Tag.</li>
                </ul>
            </div>
			<form action="/show/<% $entitytype %>/tags.html" method="post">
				Tag this <% $entitytype %>:<br />
				<textarea rows="4" cols="40" name="newtags"><% join ", ", map { $_->{"name"} } @$rawtags %></textarea><br />
				<input type="submit" value="Tag" />
				<input type="hidden" name="update" value="1" />
				<input type="hidden" name="id" value="<% $entity->GetId %>" />
			</form>
%       } else {
			<div id="tagform">
				<p><a id="tagthis" class="<% $entitytype %>::<% $entity->GetId %>" href="/show/<% $entitytype %>/tags.html?id=<% $entity->GetId %>&amp;showform=1">Tag this <% $entitytype %></a></p>
			</div>
%       }
%   } else  {
		<a href="/login.html">Log in</a> to tag this <% $entitytype %>.
%   }
	</div>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

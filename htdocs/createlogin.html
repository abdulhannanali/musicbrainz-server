<%perl>

my ($mb, $cookie);
my ($err, $user, $privs, $uid);

mc_comp('/comp/sidebar');

$mb = mc_comp("/comp/dblogin");
$user = UserStuff->new($mb->{DBH});

($err, $user, $privs, $uid) = $user->CreateLogin($ARGS{User}, $ARGS{Password}, 
                                        $ARGS{RetypePassword});
if ($err ne "")
{
    mc_out("<b>$err</b><p>");
    #this html displays the sidebar, the new_login should not do it again
    mc_comp('/newlogin.html', sidebar=>'0', url=>$ARGS{url});
}
else
{
    tie %HTML::Mason::Commands::session, 
       'Apache::Session::File', undef, 
       {
          Directory => DBDefs::SESSION_DIR,
          LockDirectory   => DBDefs::LOCK_DIR,
       };
    $cookie = new CGI::Cookie (-name=>'AF_SID',
            -value=>$HTML::Mason::Commands::session{_session_id},
            -path => '/',); 
    $r->headers_out->add('Set-cookie' => $cookie); 

    $session{user} = $user;
    $session{privs} = $privs;
    $session{uid} = $uid;  
    $session{expire} = time() + UserStuff::SESSION_SECONDS_TO_LIVE;  
    
    </%perl>
    
    <center>
       A new account has been created and you are 
       now logged into MusicBrainz!<p><br>
       
       Please update your <a href="/moderator.html?uid=<% $uid %>">profile</a>
       to let the other users know a little bit about you.
    </center>
    <br><br>
    <%perl>

    if (exists $ARGS{mbt})
    {
        </%perl>
        <center><b>Click <a href="#mbt_login">here</a> to enter login 
        information into the Options Dialog.
        </center>
        <%perl>

    }
    elsif (exists $ARGS{url})
    {
        my $url;
        $url = $ARGS{url};
        $url =~ s/\@Q\@/\?/g;
        $url =~ s/\@A\@/\&/g;
        mc_out("<center>Click <a href=\"$url\">here</a> to continue.</center>");
    }
    else
    {
        mc_comp('/comp/searchinternal');
    }
    untie %HTML::Mason::Commands::session;
}
$mb->Logout();

</%perl>

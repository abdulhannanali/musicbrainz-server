%# vi: set ts=4 sw=4 ft=mason :
<%perl>

my ($mb, $cookie);
my ($err, $user, $privs, $uid, $email, $ui);

mc_comp('/comp/sidebar');

$mb = mc_comp("/comp/dblogin");
$ui = UserStuff->new($mb->{DBH});
$email = $ARGS{EMail};

($err, $user, $privs, $uid) = $ui->CreateLogin($ARGS{User}, $ARGS{Password}, 
                                        $ARGS{RetypePassword});
if ($err ne "")
{
    mc_out("<b>$err</b><p>");
    #this html displays the sidebar, the new_login should not do it again
    mc_comp('/newlogin.html', sidebar=>'0', url=>$ARGS{url});
}
else
{
    $ui->SetSession(\%session, $user, $privs, $uid, !$email);
    
    </%perl>
    
    A new account has been created and you are 
    now logged into MusicBrainz!<p><br>

    <%perl>
    if ($email) 
    {
        my $info = $ui->GetUserInfo($uid);
        my $ret = $ui->SendVerificationEmail($info, $email);
        if ($ret)
        {
            </%perl>
            <p>
            The email verification mail could not be sent: <b><% $ret %></b>.
            Your email address has not been updated.
            </p>
            <%perl>
        }
        else
        {
            </%perl>
            <p>
            Since you have provided an email address, an email verification mail has been 
            sent to <b><% $email %></b>.
            Please check your mailbox and click on the link in the email to
            verify the new email address.
            </p>
            <%perl>
        }
    }
    </%perl>
    
    Please update your <a href="/moderator.html?uid=<% $uid %>">profile</a>
    to let the other users know a little bit about you.
    <br><br>
    <%perl>

    if (exists $ARGS{mbt} && $ARGS{mbt})
    {
        </%perl>
        <b>Click <a href="#mbt_login">here</a> to enter login 
        information into the Options Dialog.
        <%perl>

    }
    elsif (exists $ARGS{url})
    {
        my $url;
        $url = $ARGS{url};
        $url =~ s/\@Q\@/\?/g;
        $url =~ s/\@A\@/\&/g;
        mc_out("Click <a href=\"$url\">here</a> to continue.");
    }
    else
    {
        mc_comp('/comp/searchinternal');
    }
}
$mb->Logout();

</%perl>

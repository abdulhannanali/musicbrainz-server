<%perl>

my ($mb, $cookie);
my ($err, $user, $privs, $uid);

mc_comp('/comp/sidebar');

$mb = MusicBrainz::new();
$mb->Login();
$user = UserStuff->new($mb);

($err, $user, $privs, $uid) = $user->CreateLogin($ARGS{User}, $ARGS{Password}, 
                                        $ARGS{RetypePassword});
if ($err ne "")
{
    mc_out($err);
    #this html displays the sidebar, the new_login should not to it again
    mc_comp('/newlogin.html', sidebar=>'0');
}
else
{
    tie %HTML::Mason::Commands::session, 
       'Apache::Session::File', undef, 
       {
          Directory => DBDefs::SESSION_DIR,
          LockDirectory   => DBDefs::LOCK_DIR,
       };
    $cookie = new CGI::Cookie (-name=>'AF_SID',
            -value=>$HTML::Mason::Commands::session{_session_id},
            -path => '/',); 
    $r->headers_out->add('Set-cookie' => $cookie); 

    $session{user} = $user;
    $session{privs} = $privs;
    $session{uid} = $uid;  
    
    mc_out(qq/A new account has been created and you are 
              now logged into MusicBrainz!/);
    mc_comp('/comp/searchinternal');
    untie %HTML::Mason::Commands::session;
}
$mb->Logout();

</%perl>

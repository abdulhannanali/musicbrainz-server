%# vi: set ts=4 sw=4 ft=mason :
<%args>
$url => "/search.html"
</%args>
<%perl>

# Prevent confusing redirect loops
$url = "/search.html"
	if $url =~ m[/(login|logout)\.html];

my $mb = $m->comp("/comp/dblogin");
my $ui = UserStuff->new($mb->{DBH});
my $email = $ARGS{EMail};

my ($err, $user, $privs, $uid) = $ui->CreateLogin(
	$ARGS{User}, $ARGS{Password}, $ARGS{RetypePassword},
);
	
if ($err ne "")
{
	$m->comp('/comp/sidebar');
    $m->out("<b>$err</b><p>");
    #this html displays the sidebar, the new_login should not do it again
    $m->comp('/newlogin.html', sidebar=>'0', url => $url);
	return;
}

$ui->SetSession($user, $privs, $uid, !$email);
    
$m->comp('/comp/sidebar', title => "MusicBrainz account created!");

</%perl>
    
<p>
    A new account has been created and you are 
    now logged into MusicBrainz!
</p>

% if ($session{mbt}) {
<div class="notice">
	<p>To use the Tagger, you must now:</p>
	<ol>
		<li>Open the "Options" window</li>
		<li>Go to the "Login" tab</li>
		<li>Enter your MusicBrainz username and password there.</li>
	</ol>
	<p>
		The Tagger will not work until you have done this.&nbsp;
		<b><a href="#mbt_login">Set your login options now!</b>
	</a>
</div>
% }

    <%perl>
    if ($email) 
    {
		my $me = $ui->newFromId($uid) or die;
        my $ret = $me->SendVerificationEmail($email);
        if ($ret)
        {
            </%perl>
            <p>
            The email verification mail could not be sent: <b><% $ret %></b>.
            Your email address has not been updated.
            </p>
            <%perl>
        }
        else
        {
            </%perl>
            <p>
            Since you have provided an email address, an email verification mail has been 
            sent to <b><% $email %></b>.
            Please check your mailbox and click on the link in the email to
            verify the new email address.
            </p>
            <%perl>
        }
    }
    </%perl>
    
<p>
    Please <a href="/user/edit.html">update your profile</a>
    to let the other users know a little bit about you.
</p>

<p><a href="<% $url %>">Click here to continue</a>.</p>

<& /comp/footer &>

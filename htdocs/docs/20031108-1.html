%# vi: set ts=2 sw=2 ft=mason :
<& /comp/sidebar, title => "Dissecting a Tagger Session", head => '
<style type="text/css">

.HttpRequest
{
	margin: 1em;
	border: 1px solid #000;
	padding: 1em;
	color: green;
}

.HttpResponse
{
	margin: 1em;
	border: 1px solid #000;
	padding: 1em;
	color: blue;
}

.HttpRequest b, .HttpResponse b
{
	background: #ffc;
	color: red;
}

</style>
' &>

<%def .HttpRequest>
% (my $t = $_[0]) =~ s/\s+\z//;
% $t = html_escape($t) if $_[1];
<div class="HttpRequest"><pre><% $t |n %></pre></div>
</%def>

<%def .HttpResponse>
% (my $t = $_[0]) =~ s/\s+\z//;
% $t = html_escape($t) if $_[1];
<div class="HttpResponse"><pre><% $t |n %></pre></div>
</%def>

<p>
	This page describes at a technical level what happens when you use the Tagger;
	in particular, what information is sent and received over the Internet.&nbsp;
	To create this document I chose an audio file at random from my collection,
	and tagged it, whilst "sniffing" the network traffic involved.
</p>

<p>
	For a simpler overview of (part of) this process - namely, generating a
	TRM ID - please read
	<a href="/docs/20031108-2.html">How TRM Generation Works</a>.
</p>

<h2>Starting Off</h2>

<p>
	You load up the Tagger; the Tagger loads its default web page.&nbsp;
	This involves "normal web traffic", i.e. HTTP "GET" requests for HTML pages,
	CSS style sheets, etc., between your PC and the MusicBrainz Server.&nbsp;
	I've not shown "normal web traffic" here, as I'm assuming that you understand
	that.
</p>

<h2>Getting a TRM ID</h2>

<p>
	Next, you load your audio file into the tagger.&nbsp;
	The Tagger now Tagger analyses the audio file and comes with an
	<i>Audio signature</i>, which is a series of numbers representing things
	like the length of the audio signal, the frequency distribution, the beats
	detected, and so on.&nbsp;
	This isn't the TRM ID - to get a TRM ID, the Audio Signature is
	sent to the TRM Signature Server using an HTTP POST request, like so:
</p>

<& .HttpRequest, <<'EOF', 1
POST /cgi-bin/gateway/gateway?4447 HTTP/1.0
Host: trm.musicbrainz.org
Accept: */*
User-Agent: libmusicbrainz/2.1.0
Content-type: application/octet-stream
Content-length: 566

0000000: 4e310200 00030000 003f37f8 bf43e603  N1.......?7..C..
0000010: 4d4086ca ba4095dd 0e4095e1 f14092e7  M@...@...@...@..
0000020: 5a408dca 98408fdf 974094bc 90409a51  Z@...@...@...@.Q
0000030: 66409abf 194090d8 9f408c1e d1408729  f@...@...@...@.)
0000040: e1408ab8 6b408dbf 0f408f50 58409135  .@..k@...@.PX@.5
0000050: 7f408984 7f408e5c a4409401 6e408ae2  .@...@.\.@..n@..
0000060: ac4080f0 c5408233 ab408847 b2408f35  .@...@.3.@.G.@.5
0000070: 1a4090c0 0f408734 21408264 dd408204  .@...@.4!@.d.@..
0000080: fe40840d 264080be 124083bd ba4085b9  .@..&@...@...@..
0000090: 6e41dd9d e443a880 0040c849 fc406527  nA...C...@.I.@e'
00000a0: f040346c 0f404478 1240435b 51403cdd  .@4l.@Dx.@C[Q@<.
00000b0: 50402f11 9b401517 1c405426 97405ca4  P@/..@...@T&.@\.
00000c0: 9f404cf6 6a4050ed a3405542 f8405fcf  .@L.j@P..@UB.@_.
00000d0: 37404c3e 4f4052b9 09405773 da40594a  7@L>O@R..@Ws.@YJ
00000e0: 2e4078ef 3f405b24 da405925 bd405cfa  .@x.?@[$.@Y%.@\.
00000f0: fc405c19 fb406328 08406d8c 3c407d23  .@\..@c(.@m.<@}#
0000100: 48408349 79408727 2e408251 73408390  H@.Iy@.'.@.Qs@..
0000110: 354087f4 59408aa0 54000000 00000000  5@..Y@..T.......
0000120: 00000000 00000000 00000000 00000000  ................
0000130: 00000000 00000000 00000000 00000000  ................
0000140: 00000000 00000000 00000000 00000000  ................
0000150: 00000000 00000000 00000000 00000000  ................
0000160: 00000000 00000000 00000000 00000000  ................
0000170: 00000000 00000000 003d14b4 c23e9323  .........=...>.#
0000180: a73fb117 273ff2a8 87400a6f 16401116  .?..'?...@.o.@..
0000190: 9d4015f1 e7401f35 3140218f 67402a05  .@...@.51@!.g@*.
00001a0: a34030d2 884049f1 df4058f5 424063cf  .@0..@I..@X.B@c.
00001b0: 06407476 6640a3cc aa40e30a 4e40e484  .@tvf@...@..N@..
00001c0: 6240f635 a940fdd2 e9410013 40410151  b@.5.@...A..@A.Q
00001d0: f8410eec 7f4110ee 924123ac 3d4124a7  .A...A...A#.=A$.
00001e0: 6c413959 d74139ce db414b60 64414c6c  lA9Y.A9..AK`dALl
00001f0: a6415950 75415993 084172fe 52417339  .AYPuAY..Ar.RAs9
0000200: cc41747d 444175d9 2241774d aa41774d  .At}DAu."AwM.AwM
0000210: ff419cbb 7f419d15 9d49f798 6d000000  .A...A...I..m...
0000220: 0043b700 00454d50 54595f43 4f4c4c45  .C...EMPTY_COLLE
0000230: 4354494f 4e00                        CTION.
EOF
,&>

<p>
	The TRM Signature Server then returns a TRM ID, like this:
</p>

<& .HttpResponse, <<'EOF'
HTTP/1.1 200 OK
Date: Sat, 08 Nov 2003 15:28:36 GMT
Server: Apache/2.0.45 (Unix)
Connection: close
Content-Type: application/octet-stream

0000000: c2912c<b>0e</b> bfc291<b>2c</b> f9bfc2<b>91</b> 41f9bf<b>c2</b>  ..,....,....A...
0000010: 0541f9<b>bf</b> a40541<b>f9</b> 8ca405<b>41</b> f08ca4<b>05</b>  .A....A....A....
0000020: e6f08c<b>a4</b> 87e6f0<b>8c</b> 6487e6<b>f0</b> 3d6487<b>e6</b>  ........d...=d..
0000030: 9a3d64<b>87</b> 459a3d<b>64</b> 02459a<b>3d</b> 000245<b>9a</b>  .=d.E.=d.E.=..E.
EOF
,&>

<p>
	It seems that for some reason the response here is exactly four times
	longer than it needs to be; to get the TRM ID, discard the first three bytes
	of each group of four (I've represented this by highlighting the bytes to
	keep).&nbsp; So we end up with this:
</p>

<pre>
		0e 2c 91 c2
		bf f9 41 05
		a4 8c f0 e6
		87 64 3d 9a
</pre>

<p>
	Or as it's usually written:
	<b>0e2c91c2-bff9-4105-a48c-f0e687643d9a</b>.&nbsp;
	That's the TRM ID of this audio file.
</p>

<h2>Finding Out About the TRM ID</h2>

<p>
	Next, the Tagger asks the MusicBrainz Server what it knows (if anything) about
	that TRM ID, using the RDF query "TrackInfoFromTRMId":
</p>

<& .HttpRequest, <<'EOF'
POST /cgi%2dbin/mq%5f2%5f1.pl HTTP/1.0
Host: musicbrainz.org
Accept: */*
User-Agent: libmusicbrainz/2.1.0
Content-type: text/plain
Content-length: 586

&lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;
&lt;rdf:RDF xmlns:rdf = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;
         xmlns:dc  = &quot;http://purl.org/dc/elements/1.1/&quot;
         xmlns:mq  = &quot;http://musicbrainz.org/mm/mq-1.1#&quot;
         xmlns:mm  = &quot;http://musicbrainz.org/mm/mm-2.1#&quot;&gt;
&lt;mq:<b>TrackInfoFromTRMId</b>&gt;
   &lt;mm:trmid&gt;<b>0e2c91c2-bff9-4105-a48c-f0e687643d9a</b>&lt;/mm:trmid&gt;
   &lt;mq:artistName&gt;04&lt;/mq:artistName&gt;
   &lt;mq:albumName&gt;__NULL__&lt;/mq:albumName&gt;
   &lt;mq:trackName&gt;Big&lt;/mq:trackName&gt;
   &lt;mm:trackNum&gt;0&lt;/mm:trackNum&gt;
   &lt;mm:duration&gt;366511&lt;/mm:duration&gt;
&lt;/mq:TrackInfoFromTRMId&gt;
&lt;/rdf:RDF&gt;
EOF
,&>

<p>
	To which the MusicBrainz Server sends back a reply, which in my case was
	this:
</p>

<& .HttpResponse, <<'EOF', 1
HTTP/1.1 200 OK
Date: Sat, 08 Nov 2003 15:28:37 GMT
Server: Apache/1.3.27 (Unix) mod_perl/1.27
Content-Length: 347
Content-Type: text/plain; charset=ISO-8859-1
Connection: close

<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF xmlns:rdf = "http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:dc  = "http://purl.org/dc/elements/1.1/"
         xmlns:mq  = "http://musicbrainz.org/mm/mq-1.1#"
         xmlns:mm  = "http://musicbrainz.org/mm/mm-2.1#">
  <mq:Result>
    <mq:status>OK</mq:status>
  </mq:Result>
</rdf:RDF>
EOF
,&>

<p>
	which meant for me that the MusicBrainz Server knew nothing about that
	TRM ID.&nbsp; So, the Tagger moves the audio file into the "Unidentified"
	tab.
</p>

<h2>Doing a "Lookup"</h2>

<p>
	Next you do a "lookup" on the file, until you find the correct
	track.  Again, this involves lots of "normal web traffic", so I haven't
	listed that here.
</p>

<h2>Getting the Track Details</h2>

<p>
	Eventually you find the correct track and click the little "Tag" link next
	to it.&nbsp;  The link includes the IDs of both the track and album you've
	selected, which in my case were '135c1c48-1f99-4bb8-9e3e-612c223b44db' and
	'e10817cb-0bed-40cc-8ecb-87c349703198' respectively.&nbsp; The Tagger now
	shows the message "Downloading track details from MusicBrainz", whilst it
	asks about those album and track IDs using "QuickTrackInfoFromTrackId":
</p>

<& .HttpRequest, <<'EOF'
POST /cgi%2dbin/mq%5f2%5f1.pl HTTP/1.0
Host: musicbrainz.org
Accept: */*
User-Agent: libmusicbrainz/2.1.0
Content-type: text/plain
Content-length: 486

&lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;
&lt;rdf:RDF xmlns:rdf = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;
         xmlns:dc  = &quot;http://purl.org/dc/elements/1.1/&quot;
         xmlns:mq  = &quot;http://musicbrainz.org/mm/mq-1.1#&quot;
         xmlns:mm  = &quot;http://musicbrainz.org/mm/mm-2.1#&quot;&gt;
&lt;mq:<b>QuickTrackInfoFromTrackId</b>&gt;
   &lt;mm:trackid&gt;<b>135c1c48-1f99-4bb8-9e3e-612c223b44db</b>&lt;/mm:trackid&gt;
   &lt;mm:albumid&gt;<b>e10817cb-0bed-40cc-8ecb-87c349703198</b>&lt;/mm:albumid&gt;
&lt;/mq:QuickTrackInfoFromTrackId&gt;
&lt;/rdf:RDF&gt;
EOF
,&>

<p>
	To which the server replies:
</p>

<& .HttpResponse, <<'EOF'
HTTP/1.1 200 OK
Date: Sat, 08 Nov 2003 15:30:11 GMT
Server: Apache/1.3.27 (Unix) mod_perl/1.27
Content-Length: 639
Content-Type: text/plain; charset=ISO-8859-1
Connection: close

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;rdf:RDF xmlns:rdf = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;
         xmlns:dc  = &quot;http://purl.org/dc/elements/1.1/&quot;
         xmlns:mq  = &quot;http://musicbrainz.org/mm/mq-1.1#&quot;
         xmlns:mm  = &quot;http://musicbrainz.org/mm/mm-2.1#&quot;&gt;
  &lt;mq:Result&gt;
    &lt;mq:status&gt;OK&lt;/mq:status&gt;
    &lt;mq:artistName&gt;<b>New Fast Automatic Daffodils</b>&lt;/mq:artistName&gt;
    &lt;mq:albumName&gt;<b>Happy Daze</b>&lt;/mq:albumName&gt;
    &lt;mq:trackName&gt;<b>Big 5</b>&lt;/mq:trackName&gt;
    &lt;mm:trackNum&gt;<b>4</b>&lt;/mm:trackNum&gt;
    &lt;mm:duration&gt;<b>363306</b>&lt;/mm:duration&gt;
    &lt;mm:albumArtist&gt;<b>89ad4ac3-39f7-470e-963a-56509c546377</b>&lt;/mm:albumArtist&gt;
  &lt;/mq:Result&gt;
&lt;/rdf:RDF&gt;
EOF
,&>

<p>
	So the Tagger now has the names and IDs of the artist, album and
	track.&nbsp; It moves the file to the "Identified" tab.
</p>

<h2>Logging In</h2>

<p>
	When you click the "Submit TRMs" button, the Tagger sends any new TRM/Track
	information to the MusicBrainz Server.&nbsp;  But first, it needs to log in
	("AuthenticateQuery"):
</p>

<& .HttpRequest, <<'EOF'
POST /cgi%2dbin/mq%5f2%5f1.pl HTTP/1.0
Host: musicbrainz.org
Accept: */*
User-Agent: libmusicbrainz/2.1.0
Content-type: text/plain
Content-length: 375

&lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;
&lt;rdf:RDF xmlns:rdf = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;
         xmlns:dc  = &quot;http://purl.org/dc/elements/1.1/&quot;
         xmlns:mq  = &quot;http://musicbrainz.org/mm/mq-1.1#&quot;
         xmlns:mm  = &quot;http://musicbrainz.org/mm/mm-2.1#&quot;&gt;
&lt;mq:<b>AuthenticateQuery</b>&gt;
	&lt;mq:username&gt;<b>(your username)</b>&lt;/mq:username&gt;
&lt;/mq:AuthenticateQuery&gt;
&lt;/rdf:RDF&gt;
EOF
,&>

<p>
	The Server responds with a "Session ID" and an "Authentication
	Challenge".&nbsp; These are long strings of numbers, like GUIDs, but here
	I've replaced them by "...removed...":
</p>

<& .HttpResponse, <<'EOF'
HTTP/1.1 200 OK
Date: Sat, 08 Nov 2003 15:30:24 GMT
Server: Apache/1.3.27 (Unix) mod_perl/1.27
Content-Length: 509
Content-Type: text/plain; charset=ISO-8859-1
Connection: close

&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;rdf:RDF xmlns:rdf = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;
         xmlns:dc  = &quot;http://purl.org/dc/elements/1.1/&quot;
         xmlns:mq  = &quot;http://musicbrainz.org/mm/mq-1.1#&quot;
         xmlns:mm  = &quot;http://musicbrainz.org/mm/mm-2.1#&quot;&gt;
  &lt;mq:Result&gt;
    &lt;mq:status&gt;OK&lt;/mq:status&gt;
    &lt;mq:sessionId&gt;<b>...removed...</b>&lt;/mq:sessionId&gt;
    &lt;mq:authChallenge&gt;<b>...removed...</b>&lt;/mq:authChallenge&gt;
  &lt;/mq:Result&gt;
&lt;/rdf:RDF&gt;
EOF
,&>

<h2>Submitting TRMs</h2>

<p>
	Now the Tagger is ready to submit the TRM/Track data to the MusicBrainz
	Server.&nbsp; The POST request it sends includes a series of TRM ID / Track ID
	pairs (there is only one pair in this example), the "Session ID" we were given
	when we logged in, and a "Session Key" (which effectively is your
	password; it's a response to the "Authentication Challenge" we got just now).&nbsp;
	The RDF query used is "SubmitTRMList":
</p>

<& .HttpRequest, <<'EOF'
POST /cgi%2dbin/mq%5f2%5f1.pl HTTP/1.0
Host: musicbrainz.org
Accept: */*
User-Agent: libmusicbrainz/2.1.0
Content-type: text/plain
Content-length: 757

&lt;?xml version=&quot;1.0&quot; encoding=&quot;iso-8859-1&quot;?&gt;
&lt;rdf:RDF xmlns:rdf = &quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot;
         xmlns:dc  = &quot;http://purl.org/dc/elements/1.1/&quot;
         xmlns:mq  = &quot;http://musicbrainz.org/mm/mq-1.1#&quot;
         xmlns:mm  = &quot;http://musicbrainz.org/mm/mm-2.1#&quot;&gt;
&lt;mq:<b>SubmitTRMList</b>&gt;
&lt;mm:trmidList&gt;
&lt;rdf:Bag&gt;
&lt;rdf:li&gt;
&lt;mq:trmTrackPair&gt;
&lt;mm:trmid&gt;<b>0e2c91c2-bff9-4105-a48c-f0e687643d9a</b>&lt;/mm:trmid&gt;
&lt;mm:trackid&gt;<b>135c1c48-1f99-4bb8-9e3e-612c223b44db</b>&lt;/mm:trackid&gt;
&lt;/mq:trmTrackPair&gt;
&lt;/rdf:li&gt;
&lt;/rdf:Bag&gt;
&lt;/mm:trmidList&gt;
&lt;mq:sessionId&gt;<b>...removed...</b>&lt;/mq:sessionId&gt;
&lt;mq:sessionKey&gt;<b>...removed...</b>&lt;/mq:sessionKey&gt;
&lt;mq:clientVersion&gt;MusicBrainz Tagger/0.10.1&lt;/mq:clientVersion&gt;
&lt;/mq:SubmitTRMList&gt;
&lt;/rdf:RDF&gt;
EOF
,&>

<p>
	Finally the Server responds with a "success" message, indicating that it
	has now associated the given TRM ID with the given track (for each pair
	passed in).
</p>

<& .HttpResponse, <<'EOF', 1
HTTP/1.1 200 OK
Date: Sat, 08 Nov 2003 15:30:25 GMT
Server: Apache/1.3.27 (Unix) mod_perl/1.27
Content-Length: 347
Content-Type: text/plain; charset=ISO-8859-1
Connection: close

<?xml version="1.0" encoding="UTF-8"?>
<rdf:RDF xmlns:rdf = "http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:dc  = "http://purl.org/dc/elements/1.1/"
         xmlns:mq  = "http://musicbrainz.org/mm/mq-1.1#"
         xmlns:mm  = "http://musicbrainz.org/mm/mm-2.1#">
  <mq:Result>
    <mq:status>OK</mq:status>
  </mq:Result>
</rdf:RDF>
EOF
,&>

<& /comp/footer &>

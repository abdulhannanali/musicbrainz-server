<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page is the entry point for a the manual Add Release workflow.
	#
	# $Id$
	#
</%perl>
<%args>

	$artistid => undef
	$error => undef

	$tracks => ""

</%args>
<%perl>

	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	$m->comp("/comp/sidebar-notitle", pagetitle => "Add release");

	unless ($artistid)
	{
		$m->comp("/comp/tablebegin", title => "Add release");
		$m->out(qq!To add a release, please go to that artists main page,
					and click on the <strong>Add release</strong> link.!);
		$m->comp("/comp/tableend");

		$m->comp("/comp/tablebegin", title => "Search for an artist");
		$m->comp("/comp/lucenesearch");
		$m->comp("/comp/tableend");

		$m->comp("/comp/movefocus", "TextSearchForm", "search");

		$m->comp("/comp/footer");
		return;
	}


	(MusicBrainz::Server::Validation::IsGUID($artistid) ||
	MusicBrainz::Server::Validation::IsNonNegInteger($artistid)) && $artistid
		or return $m->comp("/comp/badargs", 0, 1);

	$artistid != &ModDefs::DARTIST_ID
		or return $m->comp(
			"/comp/error",
			"You cannot add a release to the 'Deleted Artist'.",
			0, 1,
		);

	my $mb = $m->comp("/comp/dblogin");

	my $ar = MusicBrainz::Server::Artist->new($mb->{DBH});
	if (MusicBrainz::Server::Validation::IsGUID($artistid))
    {
	    $ar->SetMBId($artistid);
	}
	else
	{
	    $ar->SetId($artistid);
	}
	$ar->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Artist #$artistid does not exist",
			0, 1,
		);
    $artistid = $ar->GetId();

</%perl>

	<& /comp/stylemenu &>
	<& /comp/layout/editformbegin, title => "Add release" &>


		<form method="post" id="AddAlbumForm" action="/cdi/enter.html">
			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>
								You are about to manually add a release to the artist
								<& /comp/linkartist, artist => $ar &>. Did you know that you can
								<a href="/freedb/freedb.html?search=<% uri_escape($ar->GetName()) %>">import
								releases from the FreeDB database</a>?</li>
							<li>
								Please read the <a href="/doc/StyleGuidelines">style guidelines</a>
								first, then enter the number of tracks on this release:</li>
						</ul>
					</td>
				</tr>
			</table>

			<table class="formstyle">

%	if ($error == 1)
%	{

				<tr>
					<td>&nbsp;</td>
					<td class="error">
						<& /comp/form/feedbackbox, "warning",
							"Your form submission contains errors: ",
							qq!Please specify the number of tracks of the release
							you would like to enter. You can add releases with any
							number of tracks.! &>
					</td>
				</tr>

%	}

				<tr>
					<td class="label">
						<label for="editalbum_tracks">Number of tracks:</label></td>
					<td>
						<input 	type="text" name="tracks" id="editalbum_tracks"
								size="3" value="<% $tracks %>" /></td>
				</tr>
				<tr>
					<td class="label">&nbsp;</td>
					<td>
						<input type="submit" class="button" value="Next &raquo;" />
					</td>
				</tr>
			</table>

			<div>
				<& /comp/form/hiddenfield, "id", "" &>
				<& /comp/form/hiddenfield, "toc", "" &>
				<& /comp/form/hiddenfield, "artistid", $artistid &>
				<& /comp/form/hiddenfield, "hasmultipletrackartists", ($artistid == &ModDefs::VARTIST_ID ? 1 : 0) &>
				<& /comp/form/focusfield, "tracks" &>
			</div>
		</form>

	<& /comp/layout/editformend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

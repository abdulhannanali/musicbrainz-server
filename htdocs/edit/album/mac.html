%# vi: set ts=2 sw=2 ft=mason :
<%args>
$album => undef
$notetext => ""
$movetova=>0
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($album) && $album
	or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
$al->SetId($album);
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album #$album does not exist",
		1, 1,
	);

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist does not exist",
		1, 1,
	);

my $url = (
	$ARGS{'movetracks'}
		? "/edit/track/change.html?album=" . $al->GetId
		: "/showalbum.html?albumid=" . $al->GetId
);

if ($ARGS{confirm})
{
  if (!$ARGS{'movetova'})
  {
    $m->comp(
      "/comp/redirect",
      $url
    );
    return;
  }
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_SAC_TO_MAC,
				# --
				album => $al,
				artist => $ar,
				movetova => $movetova,
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title => 'Convert Album to Multiple Artists' &>

<fieldset>
	<legend>Convert Album <% $al->GetName %> to Multiple Artists</legend>
	<div class="padleft">
		Are you sure you want to convert the album
		<a href="/showalbum.html?albumid=<% $al->GetId %>"><% $al->GetName %></a>,
		currently by
		<a href="/showartist.html?artistid=<% $ar->GetId %>"><% $ar->GetName %></a>,
		to multiple artists?
	</div>
	<div class="padlefttop">
		<table>
			<tr>
				<td>
					<form 	method="GET" action="<% $url %>"
							name="ModFormNo" 
							onsubmit="history.go(-1); return false">
						<input name="btnNo" type="submit" class="button" value="&laquo; NO">
					</form></td>
				<td> &nbsp; </td>
				<td>
					<form 	method="POST" action="/edit/album/mac.html"
							name="ModFormYes">
						<input type="hidden" name="album" value="<% $al->GetId %>">
						<input type="hidden" name="confirm" value="1">
						<input name="btnYes" type="submit" class="button" value="YES &raquo;">
					</td>
			</tr>
		</table>
    <fieldset>
	    <legend>Album artist</legend>
      <table>
        <tr>
            <td>
              <input type="radio" name="movetova" value="1" checked>
              set <a href="/showartist.html?artistid=1">Various Artists</a> as album artist
              <br/>
              <input type="radio" name="movetova" value="0">
              leave <a href="/showartist.html?artistid=<% $ar->GetId %>"><% $ar->GetName %></a> as album artist
            </td>
        </tr>
      </table>
    </fieldset>
    <fieldset>
	    <legend>Track artists</legend>
      <table>
        <tr>
            <td>
              <input type="radio" name="movetracks" value="0" checked>
              leave <a href="/showartist.html?artistid=<% $ar->GetId %>"><% $ar->GetName %></a> as track artist for all tracks
              <br/>
              <input type="radio" name="movetracks" value="1">
              move tracks to new artists
              <br/>
              <div style="margin-left: 2em">
              (MusicBrainz will walk you through each track in this album and allow you to move it to a new artist)
              </div>
            </td>
        </tr>
      </table>
    </fieldset>
	</div>
	<div class="padlefttop">
		<& /comp/notetext &>
	</div>
	</form>
</fieldset>

<& /comp/movefocus, "ModFormYes", "btnYes" &>
<& /comp/footer &>

<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows to move a release to another artist. It used to be
	# very similar to sac.html, but since SG5DR, this is not the case anymore.
	# This page handles single as well as batch album moves.
	#
	# $Id$
	#
</%perl>
<%args>

	# the album(s) list. TODO: change to release
	@album => ()
	@releaseid => ()

	# fields set by /comp/artistfilter
	$search => ""
	$artistfilter_newartistid => ""
	$newartistid => ""

	# default for move tracks flag
	$movetracks => 0

	# confirm, and edit note
	$submitvalue => ""
	$notetext => ""

</%args>
<%perl>

	# use new terminology, copy over entries from
	# album list to releaseid list.
	if (@releaseid < @album) { for (@album) { push @releaseid, $_; } }

	# only allow logged-in users to see this page.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# make sure we have at least one valid album id
	MusicBrainz::IsNonNegInteger($releaseid[0]) && $releaseid[0]
		or return $m->comp("/comp/badargs", 1, 1);

	# check volatile preferences (like autoeditor flag)
	$m->comp("/comp/user/check-volatile-preferences", %ARGS);

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# flag indicates batch or single release moves
	my $_isbatch = (scalar @releaseid > 1);
	my $_last = (scalar @releaseid) - 1;

	# Maintain a list of Artists cached by ID.
	my $GetCachedArtist = do
	{
		my %cache;
		sub
		{
			my ($id) = @_;
			return $cache{$id} if (exists $cache{$id});
			my $artist = $m->comp("/comp/loadartist", $mb, $id);
			return ($cache{$id} = $artist);
		};
	};

	# Maintain a list of Releases cached by ID.
	my $GetCachedRelease = do
	{
		my %cache;
		sub
		{
			my ($id) = @_;
			return $cache{$id} if (exists $cache{$id});
			my $release = $m->comp("/comp/loadrelease", $mb, $id);
			return ($cache{$id} = $release);
		};
	};

	# get list of artists and releases.
	my @_releases = map(&$GetCachedRelease($_), @releaseid);
	my @_artists = map(&$GetCachedArtist($_->GetArtist), @_releases);

	# form step 2/3: load selected artist from the database, and
	# fill in the required fields
	my $newartist = undef;
	$artistfilter_newartistid ||= $newartistid;
	if ($artistfilter_newartistid ne "")
	{
		$newartist = &$GetCachedArtist($artistfilter_newartistid);
		$newartistid = $newartist->GetId;
	}

	# form step 3/3: enter edit
	if ($submitvalue ne "")
	{
		if ($submitvalue =~ m/Cancel/i)
		{
			# redirect to this URI after everything is done
			my $url = $_isbatch ?
				"/edit/albumbatch/done.html" :
				"/release/".$_releases[0]->GetMBId.".html";

			$m->comp("/comp/redirect", $url);
		}

		# The add new artist button was pressed
		elsif ($submitvalue =~ m/Add New Artist/i)
		{
			# prepare returnurl for add artist form
			my $returnurl = "/edit/album/move.html";
			my %returnargs;
			$returnargs{"releaseid"} = \@releaseid;

			$returnurl = sprintf "$returnurl?%s&artistfilter_newartistid=", $m->comp("/comp/args-to-querystring.inc", %returnargs);
			$returnurl = uri_escape($returnurl);

			# prepare url for redirecting to artist form
			my $addartisturl = "/edit/artist/add.html?name=$search&returnurl=$returnurl";
			return $m->comp("/comp/redirect", $addartisturl);
		}

		# important: pressing the select other artist button or the
		# search button has to clear the selected artist possibly
		# selected before (or the first of the list of found artists
		# in the search results if the search was triggered
		# automatically).
		elsif ($submitvalue =~ m/Select Other Artist|Search/i)
		{
			$newartist = undef;
			$newartistid = undef;
		}

		elsif ($submitvalue =~ m/Enter Edit/i and
			   defined $newartist)
		{
			# redirect to this URI after everything is done
			my $url = $_isbatch ?
				"/show/artist/?artistid=$newartistid" :
				"/release/".$_releases[0]->GetMBId.".html";


			# prepare mods for each selected release
			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods;

					for my $al (@_releases)
					{
						next if $al->GetArtist == $newartistid;
						my $oldar = &$GetCachedArtist($al->GetArtist);

						# if in batch mode, always use default
						# -- MOVE tracks for single artist albums
						# -- NOT MOVE for multiple track artists albums
						my $mt = ($_isbatch ? ($al->HasMultipleTrackArtists ? 0 : 1) : $movetracks );

						my @push = Moderation->InsertModeration(
							DBH	=> $mb->{DBH},
							uid	=> $session{uid},
							privs => $session{privs},
							type => &ModDefs::MOD_MOVE_ALBUM,
							# --
							album => $al,
							oldartist => $oldar,

							artistid => $newartist->GetId,
							artistname => $newartist->GetName,
							artistsortname => $newartist->GetSortName,

							movetracks => $mt,
						);

						$push[0]->InsertNote($session{'uid'}, $notetext)
							if @push and $notetext =~ /\S/;

						push @mods, @push;
					}

					return @mods;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}
	}


	# RENDERING
	# -------------------------------------------------------------------------

	# start page header.
	my $title = sprintf "Move Release%s to another Artist", ($_isbatch ? "s" : "");
	$m->comp("/comp/sidebar-notitle", pagetitle => $title);

	# if in batch mode, let's see if we have to display
	# the pending edits message.
	my $mp = 0;
	if ($_isbatch)
	{
		for my $alid (@releaseid)
		{
			if (&$GetCachedRelease($alid)->GetModPending)
			{
				$mp = 1;
				last;
			}
		}
	}
	$m->comp("/comp/layout/editformbegin",
		title => $title,
		release => ($_isbatch ? undef : &$GetCachedRelease($releaseid[0])),
		mp => ($_isbatch ? $mp : undef),
		mp_type => &ModDefs::MOD_MOVE_ALBUM,
	);

</%perl>

		<form method="post" action="/edit/album/move.html" id="ConfirmForm">
			<script type="text/javascript" src="/scripts/editsuite.js"></script>

%	# if an artist was selected (or added), show confirm form.
%	if (defined $newartist)
%	{

			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>
								Are you sure you want to move the following
								release<% $_isbatch ? "s" : "" %> to the artist
								<& /comp/linkartist, artist => $newartist &>?</li>
						</ul>
					</td>
				</tr>
				<tr class="top">
					<td class="label">
						<label>Selected Releases:</label></td>
					<td>
						<table class="listingwide">
							<tr class="header">
								<td>Release Title</td>
								<td>Artist</td>
							</tr>
%		# show all current artists and releases
%		for (0 .. ($_last))
%		{
							<tr>
								<td style="padding-right: 20px">
									<& /comp/linkrelease, release => $_releases[$_] &></td>
								<td>
									<& /comp/linkartist, artist => $_artists[$_] &></td>
							</tr>
%		}
						</table>
					</td>
				</tr>
				<tr class="top">
					<td class="label">
						<label>Move Tracks:</label></td>
					<td>
%					# single release move
%					if (!$_isbatch) {
%						my $_isma = $_releases[0]->HasMultipleTrackArtists;

						<input type="radio" name="movetracks" value="0"
%							$m->out(qq! checked="checked" !) if ($_isma);
							/> Do not change track artists <br />

						<input type="radio" name="movetracks" value="1"
%							$m->out(qq! checked="checked" !) if (not $_isma);
							/> Move all tracks to artist <& /comp/linkartist, artist => $newartist &>
					</td>
				</tr>
				<tr class="spaced top">
%						if ($_isma) {
					<td class="label">
						<label style="color: red;">Warning:</label></td>
					<td>
						This release contains tracks attributed to different artists.
						This information will be lost and all tracks will have the
						<strong>same</strong> artist if you choose the <em>move
						all tracks to artist</em> option!

%						} else {
					<td class="label">
						<label>Note:</label></td>
					<td>
						If you do not move the tracks of a single artist release to the
						new artist, <strong>only</strong> the <& /comp/linkdoc, "ReleaseArtist",
						"release artist" &> will be changed! In most cases it is safe to
						keep the default selection.

%						}
%					} else {
						You have chosen to move more than one release to another
						artist. In this mode the defaults for moving <& /comp/linkdoc, "TrackArtist",
						"track artists" &> are applied. This means, for all releases
						with identical track and release artists, the tracks will be moved
						to the new artist, too. For releases with more than one artist,
						only the <& /comp/linkdoc, "ReleaseArtist", "release artist" &>
						will be changed.
%					}
					</td>
				</tr>

				<tr>
					<td>&nbsp;</td>
					<td class="notetext">
						<& /comp/notetext,
							notetext => $notetext, &></td>
				</tr>
			</table>

<%perl>
	}

	# else show /comp/artistfilter
	else
	{

		# search for target artist
		my $qar = &$GetCachedRelease($releaseid[0])->GetArtist;

</%perl>
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							Please review the documentation about <& /comp/linkdoc, "MoveReleaseEdit",
							"moving releases" &>, before entering this edit.</li>
						<li>
							When you're ready, search for the artist to which you want to move
							the selected release<% $_isbatch ? "s" : "" %> below.</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="formstyle">
			<tr class="top">
				<td class="label">
					<label>Selected Releases:</label></td>
				<td>
					<table class="listing">
						<tr class="header">
							<td>Release Title</td>
							<td>Artist</td>
						</tr>
%		# show all current artists and releases
%		for (0 .. ($_last))
%		{
						<tr>
							<td style="padding-right: 20px">
								<& /comp/linkrelease, release => $_releases[$_] &></td>
							<td>
								<& /comp/linkartist, artist => $_artists[$_] &></td>
						</tr>
%		}
					</table>

% # included &nbsp; for some vertical margin after the list of selected entities
					&nbsp;
				</td>
			</tr>

			<& /comp/artistfilter,
				search => $search,
				submitvalue => $submitvalue,

				defaultquery => $_isbatch ? "" : (&$GetCachedArtist($qar)->GetName),
				dontshow => $_isbatch ? [] : [ $qar ],

				url => "/edit/album/move.html",
				arglist => { releaseid => \@releaseid },
			&>

		</table>
%	}

% 	for (@_releases) {
			<input type="hidden" name="releaseid" value="<% $_->GetId %>">
% 	}
			<input type="hidden" name="newartistid" value="<% $newartistid %>" />


		</form>

	<& /comp/layout/editformend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

%# vi: set ts=4 sw=2 ft=mason :
%# move.html used to be very similar to sac.html,
%# since SG5DR, this is not the case anymore.
%# This page handles single as well as batch album moves.
<%args>
	# the album(s) list. TODO: change to release
	@releaseid => ()
	@album => ()

	# fields set by /comp/artistfilter
	$search => ""
	$selectedartist => ""
	$newartistid => ""

	# default for move tracks flag
	$movetracks => 0

	# confirm, and moderation note
	$confirm => undef
	$notetext => ""
</%args>
<%perl>
	# use new terminology, copy over entries from
	# album list to releaseid list.
	if (@releaseid < @album)
	{
		for (@album)
		{
			push @releaseid, $_;
		}
	}

	# only allow logged-in users to see this page.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# make sure we have at least one valid album id
	MusicBrainz::IsNonNegInteger($releaseid[0]) && $releaseid[0]
		or return $m->comp("/comp/badargs", 1, 1);

	# get database handle
	my $mb = $m->comp("/comp/dblogin");

	# flag indicates batch or single release moves
	my $_isbatch = (scalar @releaseid > 1);
	my $_last = (scalar @releaseid) - 1;

	# Maintain a list of Artists cached by ID.
	my $GetCachedArtist = do
	{
		my %cache;
		sub
		{
			my ($id) = @_;
			return $cache{$id} if (exists $cache{$id});
			my $artist = $m->comp("/comp/loadartist", $mb, $id);
			return ($cache{$id} = $artist);
		};
	};

	# Maintain a list of Releases cached by ID.
	my $GetCachedRelease = do
	{
		my %cache;
		sub
		{
			my ($id) = @_;
			return $cache{$id} if (exists $cache{$id});
			my $release = $m->comp("/comp/loadrelease", $mb, $id);
			return ($cache{$id} = $release);
		};
	};

	# get list of artists and releases.
	my @_releases = map(&$GetCachedRelease($_), @releaseid);
	my @_artists = map(&$GetCachedArtist($_->GetArtist), @_releases);

	# form step 2/3: load selected artist from the database, and
	# fill in the required fields
	my $newartist = undef;
	$selectedartist ||= $newartistid;
	if ($selectedartist ne "")
	{
		$newartist = &$GetCachedArtist($selectedartist);
		$newartistid = $newartist->GetId;
	}

	# form step 3/3: enter moderation
	if (defined $newartist && $confirm)
	{
		# redirect to this URI after everything is done
		my $url = $_isbatch ? "/showartist.html?artistid=$newartistid" : "/showalbum.html?albumid=$releaseid[0]";

		# if confirm does not contain YES, (=NO was pressed), redirect
		# back to calling page.
		if ($confirm !~ /yes/i)
		{
			$m->comp(
				"/comp/redirect",
				$url);
		}
		else
		{

			# prepare mods for each selected release
			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods;

					for my $al (@_releases)
					{
						next if $al->GetArtist == $newartistid;
						my $oldar = &$GetCachedArtist($al->GetArtist);

						# if in batch mode, always use default
						# -- MOVE tracks for single artist albums
						# -- NOT MOVE for multiple track artists albums
						my $mt = ($_isbatch ? ($al->HasMultipleTrackArtists ? 0 : 1) : $movetracks );

						my @push = Moderation->InsertModeration(
							DBH	=> $mb->{DBH},
							uid	=> $session{uid},
							privs => $session{privs},
							type => &ModDefs::MOD_MOVE_ALBUM,
							# --
							album => $al,
							oldartist => $oldar,

							artistid => $newartist->GetId,
							artistname => $newartist->GetName,
							artistsortname => $newartist->GetSortName,

							movetracks => $mt,
						);

						$push[0]->InsertNote($session{'uid'}, $notetext)
							if @push and $notetext =~ /\S/;

						push @mods, @push;
					}

					return @mods;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}

	}


	# RENDERING
	# -------------------------------------------------------------------------

	# start page header.
	my $title = sprintf "Move Album%s to another Artist", ($_isbatch ? "s" : "");
	$m->comp("/comp/sidebar-notitle", pagetitle => $title);

	# if in batch mode, let's see if we have to display
	# the pending moderations message.
	my $mp = 0;
	if ($_isbatch)
	{
		for my $alid (@releaseid)
		{
			if (&$GetCachedRelease($alid)->GetModPending)
			{
				$mp = 1;
				last;
			}
		}
	}
	$m->comp("/comp/layout/editformbegin",
		title => $title,
		release => ($_isbatch ? undef : &$GetCachedRelease($releaseid[0])),
		mp => ($_isbatch ? $mp : undef),
	);

	# if an artist was selected (or added), show confirm form.
	if (defined $newartist)
	{

</%perl>
		<!-- add editsuite for modnote resizer support -->
		<script type="text/javascript" src="/scripts/editsuite.js"></script>

		<form method="post" action="/edit/album/move.html" id="ConfirmForm">
			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>
								Are you sure you want to move the following
								release<% $_isbatch ? "s" : "" %> to the Artist
								<& /comp/linkartist, artist => $newartist &>?

								<ul style="margin-top: 5px">
									<%perl>
										# show all current artists and releases
										for (0 .. ($_last))
										{
											$m->out("<li>");
											$m->comp("/comp/linkrelease", release => $_releases[$_]);
											$m->out(" by ");
											$m->comp("/comp/linkartist", artist => $_artists[$_]);
											$m->out("</li>");
										}
									</%perl>
								</ul>
							</li>
						</ul>
					</td>
				</tr>
				<tr class="top">
					<td class="label">
						<label>Move Tracks:</label></td>
					<td>
%					# single release move
%					if (!$_isbatch) {
%						my $_isma = $_releases[0]->HasMultipleTrackArtists;

						<input type="radio" name="movetracks" value="0"
%							$m->out(qq! checked="checked" !) if ($_isma);
							/> Do not change track artists <br />

						<input type="radio" name="movetracks" value="1"
%							$m->out(qq! checked="checked" !) if (not $_isma);
							/> Move all tracks to artist <& /comp/linkartist, artist => $newartist &>
					</td>
				</tr>
				<tr class="spaced top">
%						if ($_isma) {
					<td class="label">
						<label style="color: red;">Warning:</label></td>
					<td>
						This release contains tracks attributed to different artists.
						This information will be lost and all tracks will have the
						<strong>same</strong> artist if you choose the <em>move
						all tracks to artist</em> option!

%						} else {
					<td class="label">
						<label>Note:</label></td>
					<td>
						If you do not move the tracks of a single
						artist release to the new artist, <strong>only</strong> the release artist
						will be changed! In most cases it is safe to keep the default selection.

%						}
%					} else {
						You have chosen to move more than one release to another
						artist. In this mode the defaults for moving track artist are applied.
						This means, for all releases with identical track and release artists,
						the tracks will be moved to the new artist, too. For releases with
						more than one artist, only the release artist will be changed.
%					}
					</td>
				</tr>
				<tr class="spaced">
					<td class="label">
						<label>Confirm:</label></td>
					<td class="field">
						<input class="button" type="submit" name="confirm" value="&laquo; NO" />
						<input class="button" type="submit" name="confirm" value="YES &raquo;" />

% 					for (@_releases) {

						<input type="hidden" name="releaseid" value="<% $_->GetId %>">

% 					}
						<input type="hidden" name="newartistid" value="<% $newartistid %>" />
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="notetext">
						<& /comp/notetext &>
					</td>
				</tr>
			</table>

<%perl>
	}

	# else show /comp/artistfilter
	else
	{

		# search for target artist
		my $qar = &$GetCachedRelease($releaseid[0])->GetArtist;

</%perl>
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							Please search for the artist to which you want to move
							the release<% $_isbatch ? "s" : "" %>:
							<ul style="margin-top: 5px">
								<%perl>

									# show all current artists and releases
									for (0 .. ($_last))
									{
										$m->out("<li>");
										$m->comp("/comp/linkrelease", release => $_releases[$_]);
										$m->out(" by ");
										$m->comp("/comp/linkartist", artist => $_artists[$_]);
										#$m->out($_ < $_last ? ($_ == $_last-1 ? " and " : ", ") : "");
										$m->out("</li>");
									}

								</%perl>
							</ul>
						</li>
					</ul>
				</td>
			</tr>

			<& /comp/artistfilter,
				search => $search,
				defaultquery => $_isbatch ? "" : (&$GetCachedArtist($qar)->GetName),
				dontshow => $_isbatch ? [] : [ $qar ],
				allowcreate => 1,
				url => "/edit/album/move.html",
				arglist => {
					album => \@releaseid
				},
			&>
		</table>
%	}

	<& /comp/layout/editformend &>

<& /comp/footer &>

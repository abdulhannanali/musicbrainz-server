%# vi: set ts=2 sw=2 ft=mason :
<%args>
	$album => undef	# TODO: change to $albumid

	$releaseid => undef
	$notetext => ""
	$confirm => ""
</%args>
<%perl>
	# use new terminolgy.
	$releaseid ||= $album;

	# only logged in users may proceed.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# make sure we got a valid releaseid parameter
	MusicBrainz::IsNonNegInteger($releaseid) && $releaseid
		or return $m->comp("/comp/badargs", 1, 1);

	# get database handle
	my $mb = $m->comp("/comp/dblogin");

	# load release by $releaseid parameter
	my $release = $m->comp("/comp/loadrelease", $mb, $releaseid);

	if ($confirm ne "")
	{
		# url after action
		my $url = "/showalbum.html?albumid=$releaseid";

		# NO button was pressed, redirect to release page
		return $m->comp("/comp/redirect", $url) if ($confirm =~ m/NO/);

		# YES button was pressed, enter edit.
		$m->comp(
			"/comp/entermods",
			DBH => $mb->{DBH},
			sub => sub {
				my @mods = Moderation->InsertModeration(
					DBH	=> $mb->{DBH},
					uid	=> $session{uid},
					privs => $session{privs},
					type => &ModDefs::MOD_REMOVE_ALBUM,
					# --
					album => $release,
				);

				$mods[0]->InsertNote($session{'uid'}, $notetext)
					if $mods[0]
					and $notetext =~ /\S/;
			},
			success_url => $url,
		) or return;

		die "Shouldn't get here";
	}
</%perl>


<& /comp/sidebar-notitle, pagetitle => "Confirm Release Removal" &>

	<& /comp/layout/editformbegin,
		title => "Confirm Release Removal",
		release => $release, &>

	<form method="post" action="/edit/album/remove.html" name="ConfirmForm">

		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							Are you sure you want to remove the release
							<& /comp/linkrelease, release => $release &> from
							MusicBrainz?
						</li>
						<li>
							If you <strong>added this Release by mistake</strong>, please
							follow the instructions in <a href="/doc/DeleteTheAccidentalEdit">
							How to delete an accidental edit</a>, to cancel the addition
							of this release. Removing pending edits, rather than entering new
							edits to remove it again helps to save valuable voter time.
						</li>
						<li>
							The removal of pending edits is immediate, while the
							the <a href="/doc/RemoveAlbum">Remove Release</a> edit
							type have to be voted on according to the
							<a href="/doc/ModerationFAQ#head-d9b521e9caacf43d4efefab55e3efb61044dc721">
							Voting Process</a>.
						</li>
					</ul>
				</td>
			</tr>
			<tr>
				<td class="label">
					<label for="id_btnyes">Confirm:</label>
				</td>
				<td>
					<input type="submit" class="button" name="confirm" id="id_btnyes" value="&laquo; NO" />
					<input type="submit" class="button" name="confirm" value="YES &raquo;" />
					<input type="hidden" name="releaseid" value="<% $releaseid %>" />
				</td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td class="notetext">
					<& /comp/notetext &>
				</td>
			</tr>
		</table>
		<& /comp/movefocus, "ModFormNo", 0 &>
	</form>

	<& /comp/layout/editformend &>

<& /comp/footer &>

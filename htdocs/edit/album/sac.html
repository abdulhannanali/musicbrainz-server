%# vi: set ts=2 sw=2 ft=mason :
%# Please note the VERY strong similarity between move.html and sac.html
<%args>
	# the album id TODO: albumid
	$album => ""
	$releaseid => ""

	# fields set by /comp/artistfilter
	$selectedartist => ""
	$newartistid => ""
	$search => ""

	# default for move tracks flag
	$movetracks => 1

	# submit, and moderation note
	$submit => undef
	$notetext => ""

</%args>
<%perl>
	$releaseid ||= $album;

	# only allow logged-in users to see this page.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# make sure we have at valid releaseid
	MusicBrainz::IsNonNegInteger($releaseid) && $releaseid
		or return $m->comp("/comp/badargs", 1, 1);

	# get database handle.
	my $mb = $m->comp("/comp/dblogin");

	# load release from $releaseid parameter
	my $release = $m->comp("/comp/loadrelease", $mb, $releaseid);

	# form step 2/3: load selected artist from the database, and
	# fill in the required fields
	my $newartist = undef;
	$selectedartist ||= $newartistid;
	if ($selectedartist ne "")
	{
		$newartist = $m->comp("/comp/loadartist", $mb, $selectedartist);
		$newartistid = $newartist->GetId;
	}

	# form step 3/3: enter moderation
	if (defined $newartist && $submit)
	{
		# next url after the operation
		my $url = "/release/". $release->GetMBId . ".html";

		# if submit does not contain YES, (=NO was pressed), redirect
		# back to calling page.
		if ($submit =~ m/Cancel/i)
		{
			$m->comp("/comp/redirect", $url);
			return;
		}
		else
		{
			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods = Moderation->InsertModeration(
						DBH	=> $mb->{DBH},
						uid	=> $session{uid},
						privs => $session{privs},
						type => &ModDefs::MOD_MAC_TO_SAC,
						# --
						album => $release,
						artistid => $newartist->GetId,
						artistname => $newartist->GetName,
						artistsortname => $newartist->GetSortName,
						movetracks => $movetracks,
					);

					$mods[0]->InsertNote($session{'uid'}, $notetext)
						if $mods[0]
						and $notetext =~ /\S/;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}
	}

	# start page header.
	$m->comp("/comp/sidebar-notitle", pagetitle => "Convert Release to Single Artist");
	$m->comp("/comp/layout/editformbegin",
		title => "Convert Release to Single Artist",
		release => $release
	);

	# if an artist was selected (or added), show confirm form.
	if (defined $newartist)
	{
</%perl>

		<!-- add editsuite for modnote resizer support -->
		<script type="text/javascript" src="/scripts/editsuite.js"></script>

		<form method="post" action="/edit/album/sac.html" id="ConfirmForm">
			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>Are you sure you want to convert the release
								<& /comp/linkrelease, release => $release &>,
								currently by <& /comp/linkartist, id => 1, name => "Various Artists" &>
								to artist <& /comp/linkartist, artist => $newartist &>?
							</li>
						</ul>
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="formsection">
						<span style="color: red; font-weight: bold;">Warning:</span> This release contains tracks
						attributed to multiple artists. If you proceed with this edit,
						all tracks artists will be replaced with the artist
						<& /comp/linkartist, artist => $newartist &>.

						If you only want to change the <& /comp/linkdoc, "ReleaseArtist", "Release Artist" &>,
						but not the <& /comp/linkdoc, "TrackArtist", "Track Artists" &>,
						use the <& /comp/linkdoc, "MoveReleaseEdit", "Move Release Edit" &> instead.


						<ul>
							<li><strong>
								<a href="/edit/album/move.html?album=<% $releaseid %>&newartistid=<% $newartistid %>"
									title="Move Release">Move Release</a></strong> (to another Artist).</a></li>
						</ul>
					</td>
				</tr>
				<tr class="spaced">
					<td class="label">
						<label>Confirm:</label></td>
					<td class="field">
						<input class="button" type="submit" name="submit" value="Cancel" />
						<input class="button" type="submit" name="submit" value="Enter Moderation" />
						<input type="hidden" name="releaseid" value="<% $release->GetId %>" />
						<input type="hidden" name="newartistid" value="<% $newartistid %>" />
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="notetext">
						<& /comp/notetext &>
					</td>
				</tr>
			</table>
		</form>
		<& /comp/movefocus, "ModFormYes", "btnYes" &>
<%perl>
	}

	# else show /comp/artistfilter
	else
	{
</%perl>
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							This wizard allows you to move the release and the
							tracks of <& /comp/linkrelease, release => $release &> to a
							single artist. Please review the <& /comp/linkdoc,
							"ReleaseArtistStyle", "Release Artist Style" &> and the
							general <& /comp/linkdoc, "StyleGuideline", "Style Guidelines" &>
							before entering this edit.
						</li>
						<li>
							Please enter the <& /comp/linkdoc, "ArtistName", "Artist Name" &>
							of the artist you would like to move this release to, and
							press <strong>Search</strong> to start the search.
						</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="formstyle">
			<& /comp/artistfilter,
				search => $search,
				url => "/edit/album/sac.html",
				submit => $submit,
				arglist => { album => $releaseid },
				allowcreate => 1,
			&>
			<tr>
				<td class="label">&nbsp;</td>
				<td class="field">
					<form method="post" action="/edit/album/sac.html" id="ConfirmForm">
						<input type="hidden" name="releaseid" value="<% $release->GetId %>" />
						<input type="hidden" name="newartistid" value="<% $release->GetArtist %>" />
						<input type="submit" name="submit" value="Cancel" />
					</form></td>
			</tr>
		</table>
%	}

	<& /comp/layout/editformend &>
<& /comp/footer &>

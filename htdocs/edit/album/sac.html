%# vi: set ts=2 sw=2 ft=mason :
%# Please note the VERY strong similarity between move.html and sac.html
<%args>
$album => ""
$selectedartist => ""
$newartistname => ""
$newartistsortname => ""
$newartistid => ""
$search => ""
$confirm => 0
$movetracks => 0
$notetext => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($album) && $album
	or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
$al->SetId($album);
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album #$album does not exist",
		1, 1,
	);

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist does not exist",
		1, 1,
	);

my $url = "/showalbum.html?albumid=$album";

if ($selectedartist ne "")
{
	MusicBrainz::IsNonNegInteger($selectedartist) && $selectedartist
		or return $m->comp("/comp/badargs", 1, 1);
	
	my $target = Artist->new($mb->{DBH});
	$target->SetId($selectedartist);
	$target->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Artist #$selectedartist not found.",
			1, 1,
		);

	$newartistname = $target->GetName;
	$newartistsortname = $target->GetSortName;
	$newartistid = $target->GetId;
}

if ($newartistname =~ /\S/ && $newartistsortname =~ /\S/ && !$confirm)
{
  </%perl>
  <& /comp/sidebar, title => 'Confirm Convert Album to Single Artist' &>

  <fieldset>
    <legend>Convert Album <% $al->GetName %> to single artist</legend>
    <div class="padleft">
      Are you sure you want to convert the album
      <a href="/showalbum.html?albumid=<% $al->GetId %>"><% $al->GetName %></a>,
      currently by 
      <a href="/showartist.html?artistid=1">Various Artists</a>,
      to artist <% $newartistname %>?
    </div>
    <div class="padlefttop">
      <table>
        <tr>
          <td>
            <form 	method="GET" action="<% $url %>"
                name="ModFormNo" 
                onsubmit="history.go(-1); return false">
              <input name="btnNo" type="submit" class="button" value="&laquo; NO">
            </form></td>
          <td> &nbsp; </td>
          <td>
            <form 	method="POST" action="/edit/album/sac.html"
                name="ModFormYes">
              <input type="hidden" name="album" value="<% $al->GetId %>">
              <input type="hidden" name="confirm" value="1">
              <input type="hidden" name="newartistname" value="<% $newartistname %>">
              <input type="hidden" name="newartistsortname" value="<% $newartistsortname %>">
              <input type="hidden" name="newartistid" value="<% $newartistid %>">
              <input name="btnYes" type="submit" class="button" value="YES &raquo;">
            </td>
        </tr>
      </table>
      <table>
        <tr>
           <td>
               <p style="margin: 0 2em 0 2em"><span style="color: red;">Warning:</span> This album contains tracks 
                   attributed to different artists. This information will be lost and all tracks will have 
                   the same artist if you choose move the tracks to artist <% $newartistname %>. To retain 
                   this information, use move album instead.
               </p>
           </td>
        </tr>
      </table>
    </div>
    <div class="padlefttop">
      <& /comp/notetext &>
    </div>
    </form>
  </fieldset>

  <& /comp/movefocus, "ModFormYes", "btnYes" &>
  <& /comp/footer &>
  <%perl>

  return undef;
}

if ($newartistname =~ /\S/ and $newartistsortname =~ /\S/)
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_MAC_TO_SAC,
				# --
				album => $al,
        artistid => $newartistid,
				artistname => $newartistname,
				artistsortname => $newartistsortname,
        movetracks => $movetracks,
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}
</%perl>

<& /comp/sidebar, title => "Change Album '${\ $al->GetName }' to Single Artist" &>

% if ($al->GetModPending) {
    <& /comp/modpending &>
% }

<fieldset>
	<legend>Change Album to single Artist</legend>
	<div class="padleft">
		Please search for the artist to which
		you want to move the album
		<a href="/showalbum.html?albumid=<% $album %>"><% $al->GetName %></a>.
	</div>
</fieldset>

<& /comp/artistfilter,
	search => $ARGS{'search'},
	allowcreate => 1,
	url => "/edit/album/sac.html",
	arglist => { album => $album },
	&>

<& /comp/footer &>

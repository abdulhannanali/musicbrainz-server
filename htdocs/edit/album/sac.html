%# vi: set ts=2 sw=2 ft=mason :
%# Please note the VERY strong similarity between move.html and sac.html
<%args>

	# the album id TODO: albumid
	$album => ""

	# fields set by /comp/artistfilter
	$selectedartist => ""
	$newartistid => ""

	$search => ""
	$confirm => undef
	$movetracks => 1
	$notetext => ""

</%args>
<%perl>

	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	MusicBrainz::IsNonNegInteger($album) && $album
		or return $m->comp("/comp/badargs", 1, 1);

	# get database handle.
	my $mb = $m->comp("/comp/dblogin");

	# load album from $album parameter
	my $al = Album->new($mb->{DBH});
	$al->SetId($album);
	$al->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Album #$album does not exist",
			1, 1,
		);

	# load artist from albumartist id.
	my $ar = Artist->new($mb->{DBH});
	$ar->SetId($al->GetArtist);
	$ar->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Artist does not exist",
			1, 1,
		);


	# next url after the operation
	my $url = "/showalbum.html?albumid=$album";

	# form step 2/3: load selected artist from the database, and
	# fill in the required fields
	my $newartist = undef;
	$newartistid = $selectedartist if ($selectedartist ne "");
	if ($newartistid ne "")
	{
		$newartist = Artist->new($mb->{DBH});
		$newartist->SetId($newartistid);

		MusicBrainz::IsNonNegInteger($newartistid) && $newartistid
			or return $m->comp("/comp/badargs", 1, 1);

		$newartist->LoadFromId
			or return $m->comp(
				"/comp/error",
				"Artist #$selectedartist not found.",
				1, 1,
			);
		$newartistid = $newartist->GetId;
	}


	# form step 3/3: enter moderation
	if (defined $newartist && $confirm)
	{
		if ($confirm !~ /yes/i)
		{
			$m->comp(
				"/comp/redirect",
				$url);
		}
		else
		{
			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods = Moderation->InsertModeration(
						DBH	=> $mb->{DBH},
						uid	=> $session{uid},
						privs => $session{privs},
						type => &ModDefs::MOD_MAC_TO_SAC,
						# --
						album => $al,
						artistid => $newartist->GetId,
						artistname => $newartist->GetName,
						artistsortname => $newartist->GetSortName,
						movetracks => $movetracks,
					);

					$mods[0]->InsertNote($session{'uid'}, $notetext)
						if $mods[0]
						and $notetext =~ /\S/;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}
	}

	# start page header.
	$m->comp("/comp/sidebar-notitle", pagetitle => "Convert Album to Single Artist");
	$m->comp("/comp/layout/editformbegin",
		title => "Convert Album to Multiple Artists",
		mp => $al->GetModPending,
		type => 'album',
		id => $al->GetId);

	# if an artist was selected (or added), show confirm form.
	if (defined $newartist)
	{
</%perl>

		<script type="text/javascript" src="/scripts/editsuite.js"></script>

		<form method="post" action="/edit/album/sac.html" id="ConfirmForm">
			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>Are you sure you want to convert the album
								<& /comp/album-link, album => $al, icon => 1 &>,
								currently by <& /comp/artist-link, id => 1, name => "Various Artists" &>
								to artist <& /comp/artist-link, artist => $newartist &>?
							</li>
						</ul>
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="formsection">
						<span style="color: red;">Warning:</span> This album contains tracks
						attributed to multiple artists. If you proceed with this edit,
						all tracks Artists will be replaced with the Artist
						<& /comp/artist-link, artist => $newartist &>

						If you only want to change the Album Artist, but not the Track Artists,
						use the edit type <strong><img src="/images/edit.gif" alt="" /><a
%	my $MOVE_ALBUM_URL = "/edit/album/move.html?album=$album&newartistid=$newartistid";
							href="<% $MOVE_ALBUM_URL %>" title="Move Album">Move Album</a></strong>
						instead.
					</td>
				</tr>
				<tr>
					<td class="label">
						<label>Confirm:</label></td>
					<td class="field">
						<input class="button" type="submit" name="confirm" value="&laquo; NO" />
						<input class="button" type="submit" name="confirm" value="YES &raquo;" />
						<input type="hidden" name="album" value="<% $al->GetId %>" />
						<input type="hidden" name="newartistid" value="<% $newartistid %>" />
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="notetext">
						<& /comp/notetext &>
					</td>
				</tr>
			</table>
		</form>
		<& /comp/movefocus, "ModFormYes", "btnYes" &>
<%perl>
	}

	# else show /comp/artistfilter
	else
	{
</%perl>
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>Please search for the artist to which you want to move the album
							<a href="/showalbum.html?albumid=<% $album %>"><% $al->GetName %></a>.
						</li>
					</ul>
				</td>
			</tr>
			<& /comp/artistfilter,
				search => $search,
				url => "/edit/album/sac.html",
				arglist => { album => $album },
				allowcreate => 1,
			&>
		</table>
%	}

	<& /comp/layout/editformend &>
<& /comp/footer &>

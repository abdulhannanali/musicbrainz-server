%# vi: set ts=2 sw=2 ft=mason :
%# Please note the VERY strong similarity between move.html and sac.html
<%args>
	# the album id TODO: albumid
	$album => ""
	$releaseid => ""

	# fields set by /comp/artistfilter
	$selectedartist => ""
	$newartistid => ""
	$search => ""

	# default for move tracks flag
	$movetracks => 1

	# confirm, and moderation note
	$confirm => undef
	$notetext => ""

</%args>
<%perl>
	$releaseid ||= $album;

	# only allow logged-in users to see this page.
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# make sure we have at valid releaseid
	MusicBrainz::IsNonNegInteger($releaseid) && $releaseid
		or return $m->comp("/comp/badargs", 1, 1);

	# get database handle.
	my $mb = $m->comp("/comp/dblogin");

	# load release from $releaseid parameter
	my $al = $m->comp("/comp/loadrelease", $mb, $releaseid);
	my $ar = $m->comp("/comp/loadartist", $mb, $al->GetArtist);

	# form step 2/3: load selected artist from the database, and
	# fill in the required fields
	my $newartist = undef;
	$selectedartist ||= $newartistid;
	if ($selectedartist ne "")
	{
		$newartist = $m->comp("/comp/loadartist", $mb, $selectedartist);
		$newartistid = $newartist->GetId;
	}

	# form step 3/3: enter moderation
	if (defined $newartist && $confirm)
	{
		# next url after the operation
		my $url = "/showalbum.html?albumid=$releaseid";

		# if confirm does not contain YES, (=NO was pressed), redirect
		# back to calling page.
		if ($confirm !~ /yes/i)
		{
			$m->comp("/comp/redirect", $url);
			return;
		}
		else
		{
			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods = Moderation->InsertModeration(
						DBH	=> $mb->{DBH},
						uid	=> $session{uid},
						privs => $session{privs},
						type => &ModDefs::MOD_MAC_TO_SAC,
						# --
						album => $al,
						artistid => $newartist->GetId,
						artistname => $newartist->GetName,
						artistsortname => $newartist->GetSortName,
						movetracks => $movetracks,
					);

					$mods[0]->InsertNote($session{'uid'}, $notetext)
						if $mods[0]
						and $notetext =~ /\S/;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}
	}

	# start page header.
	$m->comp("/comp/sidebar-notitle", pagetitle => "Convert Release to Single Artist");
	$m->comp("/comp/layout/editformbegin",
		title => "Convert Release to Single Artist",
		release => $al
	);

	# if an artist was selected (or added), show confirm form.
	if (defined $newartist)
	{
</%perl>

		<!-- add editsuite for modnote resizer support -->
		<script type="text/javascript" src="/scripts/editsuite.js"></script>

		<form method="post" action="/edit/album/sac.html" id="ConfirmForm">
			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>Are you sure you want to convert the release
								<& /comp/linkrelease, release => $al, icon => 1 &>,
								currently by <& /comp/linkartist, id => 1, name => "Various Artists" &>
								to artist <& /comp/linkartist, artist => $newartist &>?
							</li>
						</ul>
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="formsection">
						<span style="color: red;">Warning:</span> This release contains tracks
						attributed to multiple artists. If you proceed with this edit,
						all tracks Artists will be replaced with the Artist
						<& /comp/linkartist, artist => $newartist &>.

						If you only want to change the <a href="/doc/AlbumArtist">Release Artist</a>,
						but not the <a href="/doc/TrackArtist">Track Artists</a>,
						use the edit type <strong><img src="/images/edit.gif" alt="" /><a
%	my $MOVE_ALBUM_URL = "/edit/album/move.html?album=$releaseid&newartistid=$newartistid";
						href="<% $MOVE_ALBUM_URL %>" title="Move Release">Move Release</a></strong>
						instead.
					</td>
				</tr>
				<tr class="spaced">
					<td class="label">
						<label>Confirm:</label></td>
					<td class="field">
						<input class="button" type="submit" name="confirm" value="&laquo; NO" />
						<input class="button" type="submit" name="confirm" value="YES &raquo;" />
						<input type="hidden" name="releaseid" value="<% $al->GetId %>" />
						<input type="hidden" name="newartistid" value="<% $newartistid %>" />
					</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="notetext">
						<& /comp/notetext &>
					</td>
				</tr>
			</table>
		</form>
		<& /comp/movefocus, "ModFormYes", "btnYes" &>
<%perl>
	}

	# else show /comp/artistfilter
	else
	{
</%perl>
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							Please search for the artist to which you want to move the release
							<& /comp/linkrelease, release => $al &>.
						</li>
					</ul>
				</td>
			</tr>
			<& /comp/artistfilter,
				search => $search,
				url => "/edit/album/sac.html",
				arglist => { album => $releaseid },
				allowcreate => 1,
			&>
		</table>
%	}

	<& /comp/layout/editformend &>
<& /comp/footer &>

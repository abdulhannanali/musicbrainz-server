%# vi: set ts=4 sw=4 ft=mason :
<%args>
	$reset=>0
</%args>
<%perl>

	# only logged in users can see this page
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# get database handle
	my $mb = $m->comp("/comp/dblogin");

	my $referer = $r->headers_in->{"Referer"} || "";

	my @releaseids = split / /, $session{"tagged_albums"};
	@releaseids = () if $reset;

	my $id;
	foreach (keys %ARGS)
	{
		undef $id;
		$id = $1 if (/AlbumId(\d+)/);
		next if (!defined $id || $ARGS{$_} eq "");

		if ($ARGS{$_} eq "off")
		{
			my $i = 0;
			foreach (@releaseids)
			{
				if ($_ == $id)
				{
					splice(@releaseids, $i, 1);
					last;
				}
				$i++;
			}
		}
		else
		{
			push @releaseids, $id;
		}
	}

	# Remove dupes
	my %temp = ();
	@releaseids = grep { not $temp{$_}++ } @releaseids;
	$session{tagged_albums} = join " ", @releaseids;

	if (not @releaseids)
	{
		$m->comp("/comp/layout/badarguments",
			title => "No selected releases",
			text =>   "You have not selected any releases. Please go back"
					. " to the artist page and select some releases by activating"
					. " the checkbox in the orange release title.");
		return undef;
	}

	# load all releases
	my @releaseObjs = map {
		my $release = $m->comp("/comp/loadrelease", $mb, $_);
		$release;
	} @releaseids;

	# create hash of artistsids
	my %artistids;
	++$artistids{$_->GetArtist} for @releaseObjs;
	my $artistid = ((keys(%artistids) == 1) ? $releaseObjs[0]->GetArtist : undef);

	# if all releases are by one artist, the "add more" link
	# points to the artist page, else the general search.
	my $more_releases_url = "/search.html";
	$more_releases_url = "/showartist.html?artistid=$artistid" if $artistid;

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Release Batch Operations" &>

	<& /comp/tablebegin, title => "Release Batch Operations" &>

%#	[ <a href="<% $referer %>">Go back</a> | <a href="/search.html">Search</a> ]


	<table class="formstyle" id="albumbatch">
		<tr>
			<td colspan="2" class="instructions">
				<ul>
					<li>
						You have <strong>selected the releases shown below</strong>,
						and can now apply one of the <a href="/doc/EditType">EditTypes</a>
						listed in this box.
					</li>
					<li>
						Alternatively, You can <strong><a href="<% $more_releases_url %>">
						select more releases</a></strong> and then return on this
						page to perform the action on all the other releases
						as well.
					</li>
					<li>
					    If you want to <strong>remove one or more releases</strong> from
					    this list, deactivate the checkbox in the release title
					    and click on the "Update" button at the bottom of this page.
					</li>
				</ul>
			</td>
		</tr>
		<tr class="top">
			<td class="label">Merge:</td>
			<td>
				Merge all the selected releases into one release, preserving all
				<a href="/doc/PUID">PUIDs</a>, <a href="/doc/TRM">TRM IDs</a>
				and <a href="/doc/DiscID">Disc IDs</a>. If the target release
				you want to merge into is a Various Artists album, use the
				Various Artists Merge button, else the Single Artists button.

				<table border="0" cellspacing="0" cellpadding="0">
					<tr>
						<td>
							<form method="post" action="/edit/albumbatch/merge.html">
								<div>
% 	for (@releaseids) {
									<input type="hidden" name="album" value="<% $_ %>" />
% 	}
									<input type="hidden" name="mac" value="0" />
									<input type="submit" value="Single Artist &raquo;" <% (@releaseObjs < 2) ? ' disabled="disabled"' : "" %> />
								</div>
							</form>
						</td>
						<td>
							<form method="post" action="/edit/albumbatch/merge.html">
								<div>
% 	for (@releaseids) {
									<input type="hidden" name="album" value="<% $_ %>" />
% 	}
									<input type="hidden" name="mac" value="1" />
									<input type="submit" value="Various Artists &raquo;" <% (@releaseObjs < 2) ? ' disabled="disabled"' : "" %> />
								</div>
							</form>
						</td>
					</tr>
				</table>

% 	if (@releaseObjs < 2) {
				<div style="margin: 5px 0px; border: 1px dotted red; padding: 5px">
%		$m->out(sprintf qq!<form method="get" action="%s">!, ($artistid ? "/showartist.html" : "/search.html"));
						<div>
%		$m->out(qq!<input type="hidden" name="artistid" value="$artistid" />!) if ($artistid);
							<input type="submit" value="Select More &raquo;" />
							You have to select at least two releases for a merge edit.
						</div>
					</form>
				</div>
%	}
			</td>
		</tr>

		<tr class="top">
			<td class="label">Move:</td>
			<td>
				<form method="post" action="/edit/album/move.html">
					<div>
% for (@releaseids) {
						<input type="hidden" name="album" value="<% $_ %>" />
% }
						<input type="submit" value="Move &raquo;" />
					</div>
				</form>
			</td>
		</tr>

		<tr class="top">
			<td class="label">Remove:</td>
			<td>
				<form method="post" action="/edit/album/move.html">
					<div>
% for (@releaseids) {
						<input type="hidden" name="album" value="<% $_ %>" />
% }
						<input type="submit" value="Remove &raquo;" />
					</div>
				</form>
			</td>
		</tr>

		<tr class="top">
			<td class="label">Edit Attributes:</td>
			<td>
				<form method="post" action="/edit/album/editattributes.html">
					<div>
% for (@releaseids) {
						<input type="hidden" name="id" value="<% $_ %>" />
% }
						<input type="hidden" name="untag" value="1" />
						<input type="submit" value="Edit Attributes &raquo;" />
						Apply release attributes to all selected releases.
					</div>
				</form>
      		</td>
    	</tr>

		<tr class="top">
			<td class="label">Edit Language:</td>
			<td>
				<form method="post" action="/edit/albumlanguage/edit.html">
					<div>
% for (@releaseids) {
						<input type="hidden" name="id" value="<% $_ %>" />
% }
						<input type="hidden" name="untag" value="1" />
						<input type="submit" value="Edit Language &raquo;" />
						Change the language and/or script of all selected releases.
					</div>
				</form>
			</td>
		</tr>

		<tr class="top">
			<td class="label">Cancel:</td>
			<td>
				<form method=releaseObjs action="/edit/albumbatch/cancel.html">
					<div>
						<input type="hidden" name="url" value="<% $referer %>" />
						<input type="submit" name="Submit" value="Cancel &raquo;" />
						If you have changed your mind, or want to start over, click
						"Cancel" to stop this batch process.
					</div>
				</form>
			</td>
		</tr>
    </table>

	<& /comp/tableend &>


<%perl>

    # Sort by artist so that all the artists are sequential
    @releaseObjs = sort { $a->GetArtist() <=> $b->GetArtist()} @releaseObjs;

    my $ar = Artist->new($mb->{DBH});
	$ar->SetId(0);

	for my $release (@releaseObjs)
	{
		if ($ar->GetId != $release->GetArtist)
		{
			$ar = $m->comp("/comp/loadartist", $mb, $release->GetArtist);
			$m->comp("/comp/artisttitle", artist => $ar, showmodlinks => 0);
		}

	 	$m->comp("/comp/album",
			album => $release,
			artist => $ar,
			showids => 1,
			showtag => 1,
			tagchecked => 1,
			showmodlinks => 1,
		);
    }
</%perl>

	<form method="post" action="/edit/albumbatch/done.html" id="BatchOp">
		<div>
			<script type="text/javascript">
				document.writeln('<input type="submit" name="Submit" value="Update" />');
			</script>
			<input type="hidden" name="url" value="<% $referer %>" />
			<input type="hidden" name="reset" value="1" />

%  	for my $release (@releaseObjs) {
			<input type="hidden" name="AlbumId<% $release->GetId() %>" value="on" />
%  	}
		</div>
	</form>
	<script type="text/javascript" src="/scripts/collapsereleases.js"></script>

<& /comp/footer &>

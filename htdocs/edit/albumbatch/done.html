<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page shows the list of tagged_albums and allows to branch to
	# the available workflows.
	#
	# $Id$
	#
</%perl>
<%args>

	$reset => 0

</%args>
<%perl>

	# only logged in users can see this page
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	my $referer = $r->headers_in->{"Referer"} || "";

	my @releaseids = split / /, $session{"tagged_albums"};
	@releaseids = () if $reset;

	my $id;
	foreach (keys %ARGS)
	{
		undef $id;
		$id = $1 if (/releaseid(\d+)/);
		next if (!defined $id || $ARGS{$_} eq "");

		push @releaseids, $id;
	}

	# Remove dupes
	my %temp = ();
	@releaseids = grep { not $temp{$_}++ } @releaseids;
	$session{tagged_albums} = join " ", @releaseids;

	if (not @releaseids)
	{
		$m->comp("/comp/layout/badarguments",
			title => "No selected releases",
			text =>   "You have not selected any releases. Please go back"
					. " to the artist page and select some releases by activating"
					. " the checkbox in the orange release title.");
		return undef;
	}

	# load all releases
	my @releaseObjs = map {
		my $release = $m->comp("/comp/loadrelease", $mb, $_);
		$release;
	} @releaseids;

	# create hash of artistsids
	my %artistids;
	++$artistids{$_->GetArtist} for @releaseObjs;
	my $artistid = ((keys(%artistids) == 1) ? $releaseObjs[0]->GetArtist : undef);

	# if all releases are by one artist, the "add more" link
	# points to the artist page, else the general search.
	my $more_releases_url = "/search.html";
	$more_releases_url = "/show/artist/?artistid=$artistid" if $artistid;

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Release batch operations" &>

	<& /comp/tablebegin, title => "Release batch operations" &>

%#	[ <a href="<% $referer %>">Go back</a> | <a href="/search.html">Search</a> ]

		<table class="formstyle" id="releasebatch">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							You have <strong>selected the releases shown below</strong>,
							and can now apply one of the <& /comp/linkdoc, "EditType", "EditTypes" &>
							listed in this box.
						</li>
						<li>
							Alternatively, You can <strong>select more releases</strong> using
							<strong><a href="<% $more_releases_url %>">this link</a></strong>
							and return to this page to perform the action on all the other releases as well.
						</li>
						<li>
							If you want to <strong>remove one or more releases</strong> from
							this list, unselect these releases by unticking the respective checkbox
							in the release title and click on the "Update" button in the "With
							selected releases, do..." box.
						</li>
					</ul>
				</td>
			</tr>
			<tr class="top">
				<td class="label">Merge:</td>
				<td>
					Merge all the selected releases into one release, preserving all
					<& /comp/linkdoc, "PUID", "PUIDs" &>, <& /comp/linkdoc, "TRM", "TRM IDs" &>
					and <& /comp/linkdoc, "DiscID", "Disc IDs" &>. If the releases are
					Various Artists *or* you want the final destination to be Various
					Artists, use the Various Artists merge button, else use the
					single artist merge button.

					<table border="0" cellspacing="0" cellpadding="0">
						<tr>
							<td>
								<form method="post" action="/edit/albumbatch/merge.html">
									<div>

% 	for (@releaseids) { $m->comp("/comp/form/hiddenfield", "releaseid", $_); }

										<input type="hidden" name="mac" value="0" />
										<input type="submit" value="Single artist &raquo;" <% (@releaseObjs < 2) ? qq!disabled="disabled"! : "" |n %> />
									</div>
								</form>
							</td>
							<td>
								<form method="post" action="/edit/albumbatch/merge.html">
									<div>

% 	for (@releaseids) { $m->comp("/comp/form/hiddenfield", "releaseid", $_); }

										<input type="hidden" name="mac" value="1" />
										<input type="submit" value="Various artists &raquo;" <% (@releaseObjs < 2) ? qq!disabled="disabled"! : "" |n %> />
									</div>
								</form>
							</td>
						</tr>
					</table>

% 	if (@releaseObjs < 2)
%	{

					<div style="margin: 5px 0px; border: 1px dotted red; padding: 5px">

%		$m->out(sprintf qq!<form method="get" action="%s">!, ($artistid ? "/show/artist/" : "/search.html"));

							<div>

%		$m->out(qq!<input type="hidden" name="artistid" value="$artistid" />!) if ($artistid);

								<input type="submit" value="Select more &raquo;" />
								You have to select at least two releases for a merge edit.
							</div>
						</form>
					</div>

%	}

				</td>
			</tr>

			<tr class="top">
				<td class="label">Move:</td>
				<td>
					<form method="post" action="/edit/album/move.html">
						<div>

% 	for (@releaseids) { $m->comp("/comp/form/hiddenfield", "releaseid", $_); }

							<input type="submit" value="Move &raquo;" />
						</div>
					</form>
				</td>
			</tr>

			<tr class="top">
				<td class="label">Remove:</td>
				<td>
					<form method="post" action="/edit/albumbatch/remove.html">
						<div>

% 	for (@releaseids) { $m->comp("/comp/form/hiddenfield", "releaseid", $_); }

							<input type="submit" value="Remove &raquo;" />
						</div>
					</form>
				</td>
			</tr>

			<tr class="top">
				<td class="label">Edit attributes:</td>
				<td>
					<form method="post" action="/edit/album/editattributes.html">
						<div>

% 	for (@releaseids) { $m->comp("/comp/form/hiddenfield", "id", $_); }

							<input type="hidden" name="untag" value="1" />
							<input type="submit" value="Edit attributes &raquo;" />
							Apply release attributes to all selected releases.
						</div>
					</form>
				</td>
			</tr>

			<tr class="top">
				<td class="label">Edit language:</td>
				<td>
					<form method="post" action="/edit/albumlanguage/edit.html">
						<div>

% 	for (@releaseids) { $m->comp("/comp/form/hiddenfield", "id", $_); }

							<input type="hidden" name="untag" value="1" />
							<input type="submit" value="Edit language &raquo;" />
							Change the language and/or script of all selected releases.
						</div>
					</form>
				</td>
			</tr>

			<tr class="top">
				<td class="label">Cancel:</td>
				<td>
					<form method="post" action="/edit/albumbatch/cancel.html">
						<div>
							<input type="hidden" name="url" value="<% $referer %>" />
							<input type="submit" name="Submit" value="Cancel &raquo;" />
							If you have changed your mind, or want to start over, click
							"Cancel" to stop this batch process.
						</div>
					</form>
				</td>
			</tr>
		</table>
	<& /comp/tableend &>

	<form method="post" action="/edit/albumbatch/done.html">
	<& /comp/layout/editformbegin, title => "With selected releases, do...", mp => 1 &>
		<table>
			<tr>
				<td style="padding-right: 40px; white-space: nowrap">
					<img src="/images/es/minimize.gif" alt="Maximize all releases" />
					<a href="javascript:; //" onclick="collapsereleases.toggleAll(true); return false;">Maximize all</a></td>
				<td style="padding-right: 40px; white-space: nowrap">
					<img src="/images/es/maximize.gif" alt="Minimize all releases" />
					<a href="javascript:; //" onclick="collapsereleases.toggleAll(false); return false;">Minimize all</a></td>
				<td style="padding-right: 40px; ">
					<input type="hidden" name="url" value="<% $referer %>" />
					<input type="hidden" name="reset" value="1" />
					<input type="submit" value="Update" />
				</td>
			</tr>
		</table>

		<& /comp/js/diffcollapse &>

	<& /comp/layout/editformend &>

<%perl>

    # Sort by artist so that all the artists are sequential
    @releaseObjs = sort { $a->GetArtist() <=> $b->GetArtist()} @releaseObjs;

    my $ar = Artist->new($mb->{DBH});
	$ar->SetId(0);

	for my $release (@releaseObjs)
	{
		if ($ar->GetId != $release->GetArtist)
		{
			$ar = $m->comp("/comp/loadartist", $mb, $release->GetArtist);

			$m->out(qq!<div style="margin-bottom: 2px">Artist: !);
			$m->comp("/comp/linkartist", artist => $ar);
			$m->out("</div>");
		}

	 	$m->comp("/comp/album",
			album => $release,
			artist => $ar,
			showids => 1,
			showtag => 1,
			tagchecked => 1,
			showmodlinks => 1,
			showrelationships => 0,
		);
    }
</%perl>

	</form>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

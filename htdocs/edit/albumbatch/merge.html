<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows to merge one...many releases into one.
	#
	# $Id$
	#
</%perl>
<%args>

	@releaseid => ()
	@album => ()
	$mac => undef

	$merge_attributes => ""
	$merge_langscript => ""

	$submitvalue => ""
	$notetext => ""

</%args>

<%perl>

	# only logged in users can see this page
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# use new terminology, copy over entries from
	# album list to releaseid list.
	if (@releaseid < @album) { for (@album) { push @releaseid, $_; } }

	# check volatile preferences (like autoeditor flag)
	$m->comp("/comp/user/check-volatile-preferences", %ARGS);


	my $mb = $m->comp("/comp/dblogin");

	if (@releaseid < 2)
	{
		return $m->comp("/comp/layout/error",
			title => "No releases selected",
			text => "You have not selected any releases. Please go back"
				  . " to the artist page and select the releases you'd like to "
				  . " merge by clicking on the checkbox on the right hand side "
				  . " of the album title.");
	}
	for my $releaseid (@releaseid)
	{
		MusicBrainz::Server::Validation::IsNonNegInteger($releaseid) && $releaseid
			or return $m->comp("/comp/layout/badarguments",
				text => "One of the provided releaseids is invalid.");
	}

	my %artists;
	my @objs = map {
		my $release = $m->comp("/comp/loadrelease", $mb, $_);
		++$artists{$release->GetArtist()};
		$release;
	} @releaseid;


	my @errors = ();
	if ($submitvalue ne "")
	{
		push @errors, "Select how release attributes should be merged." if ($merge_attributes !~ /\A[01]\z/);
		push @errors, "Select how release script/language should be merged." if ($merge_langscript !~ /\A[01]\z/);

		my $url =
			(keys(%artists) == 1 and not $artists{&ModDefs::VARTIST_ID})
				? "/show/artist/?artistid=".(keys(%artists))[0]
				: "/search.html";

		if ($submitvalue =~ m/Cancel/i)
		{
			return $m->comp("/comp/redirect", "/edit/albumbatch/done.html");
		}
		elsif ($submitvalue =~ m/Top|Up|Down|Bottom/i)
		{
			# re-order releases
		}
		elsif (not @errors)
		{
			delete $session{tagged_albums};
			my $into = shift @objs;

			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods = Moderation->InsertModeration(
						DBH	=> $mb->{DBH},
						uid	=> $session{uid},
						privs => $session{privs},
						type => (
							$mac
							? &ModDefs::MOD_MERGE_ALBUM_MAC
							: &ModDefs::MOD_MERGE_ALBUM
						),
						# --
						albums => \@objs,
						into => $into,
						merge_attributes => $merge_attributes,
						merge_langscript => $merge_langscript,
					);

					$mods[0]->InsertNote($session{'uid'}, $notetext)
						if $mods[0]
						and $notetext =~ /\S/;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}
	}

	my $title = $mac
		? "Merge releases into various artists release"
		: "Merge releases";

</%perl>



<%def reOrderForm>
	<%perl>

		my ($mac, $objs, $text, $title, $thisrelease) = @_;

		$m->out(qq!<td>!);
		$m->out(qq!<form method="post" action="/edit/albumbatch/merge.html#albumrow!. $thisrelease->GetId .qq!">!);
		$m->out(qq!<div>!);
		for (@$objs)
		{
			$m->out(qq!<input type="hidden" name="releaseid" value="!.$_->GetId.qq!" />!);
		}
		$m->out(qq!<input type="hidden" name="mac" value="$mac" />!);
		$m->out(qq!<input class="button" type="submit" value="$text" title="$title" style="font-size: 11px; padding: 0px 5px" />!);
		$m->out(qq!</div>!);
		$m->out(qq!</form>!);
		$m->out(qq!</td>!);

	</%perl>
</%def>



<& /comp/sidebar-notitle, pagetitle =>  $title &>

	<& /comp/tablebegin, title => $title &>

<%perl>

	my (%merged, @id_numtracks);
	my ($id, $i, $release, @tracks, $track, @ids);

	my $artist = Artist->new($mb->{DBH});

	foreach $release (@objs)
	{
		@tracks = $release->LoadTracks();
		foreach $track (@tracks)
		{
			$merged{$track->GetSequence()}++;
		}

		for (@{ $release->GetDiscIDs })
		{
			my $num = $_->GetCDTOC->GetTrackCount;
	  		push @id_numtracks, $num;
		}
	}

	my $final = scalar(keys %merged);
	my $merge_ok = 1;

	foreach (@id_numtracks)
	{
	   if ($_ != $final)
	   {
		  $merge_ok = 0;
		  last;
	   }
	}

</%perl>

		<form method="post" action="/edit/albumbatch/merge.html" id="MergeConfirm">
			<script type="text/javascript" src="/scripts/editsuite.js"></script>

			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>
								Please review the document on <& /comp/linkdoc, "HowToMergeReleases",
								"how to merge releases" &> before entering this edit.</li>
							<li>
								Please make sure that the release you'd like to merge
								the others into is the topmost of the list. You can
								use the buttons to reorder the releases until they are in the
								required order. To complete the merge of the releases
								into one <% $mac ? "Various Artists" : "" %> release,
								click the "Enter Edit" button below.</li>
						</ul></td>
				</tr>

% 	if (not $merge_ok)
%	{

				<tr>
					<td class="label">&nbsp;</td>
					<td>
						<div style="border: 1px dotted red; padding: 5px; margin-bottom: 15px">
							<span style="font-weight: bold; color: red">Warning:</span>
							These releases cannot be merged, since some of the releases
							you have selected have a <strong>different number of tracks and
							attached Disc IDs</strong>. The merge operation adds the additional tracks of
							the other releases to the end of the target release, resulting
							(for the selected releases) in a target release length of <% $final %> tracks.
							This <strong>conflicts with the number of tracks</strong> of one or more of the
							attached Disc IDs.</li>
						</div></td>
				</tr>
% 	}

			</table>

			<table class="formstyle">

% 	if ($merge_ok)
%	{
%			if (@errors > 0)
%			{

				<tr>
					<td class="label">&nbsp;</td>
					<td class="error"><ul><li><%perl> $m->out(join("</li><li>", @errors)); </%perl></li></ul></td>
				</tr>

%			}

				<tr>
					<td class="label">Attributes:</td>
					<td>
						Please specify how the <& /comp/linkdoc, "ReleaseAttributes", "release attributes" &>
						should be merged (<b>required</b>)</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td>
						<input type="radio" name="merge_attributes" value="1" <% $merge_attributes eq "1" ? "checked" : "" %> />
						Merge release attributes.<br/>
						<input type="radio" name="merge_attributes" value="0" <% $merge_attributes eq "0" ? "checked" : "" %> />
						Keep release attributes of the target release.</td>
				</tr>

				<tr class="spaced">
					<td class="label">Language/Script:</td>
					<td>
						Please specify how the <& /comp/linkdoc, "ReleaseLanguage", "release language/script" &>
						should be merged (<b>required</b>)</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td>
						<input type="radio" name="merge_langscript" value="1" <% $merge_langscript eq "1" ? "checked" : "" %> />
						Merge languages/scripts.<br/>
						<input type="radio" name="merge_langscript" value="0" <% $merge_langscript eq "0" ? "checked" : "" %> />
						Keep language/script of the target release.</td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="notetext">

%		my @buttons = ();
%		push @buttons, ["Enter Edit", "btnYes"] if ($merge_ok);
%		push @buttons, ["Cancel", "btnCancel"];

						<& /comp/notetext,
							notetext => $notetext,
							buttons => \@buttons &>
				</tr>
%	}
%	else
%	{

				<tr>
					<td class="label">&nbsp;</td>
					<td>
						<input type="submit" name="submitvalue" value="Cancel" /></td>
				</tr>
%	}
			</table>

% 		for (@releaseid)
%		{

			<input type="hidden" name="releaseid" value="<% $_ %>" />

% 		}

			<input type="hidden" name="mac" value="<% $mac %>" />
		</form>

	<& /comp/tableend &>

<%perl>

	$i = 0;
	foreach $release (@objs)
	{
		if ($i == 1)
		{
			$m->out(qq!<div style="border: 1px dotted #000; padding: 5px; margin-bottom: 15px">!);
			$m->out(qq!  All of the following releases will be merged into the one above.!);
			$m->out(qq!</div>!);
		}
		if ($artist->GetId() != $release->GetArtist())
		{
			$artist = $m->comp("/comp/loadartist", $mb, $release->GetArtist());

			# render artist link only, instead of comp/artisttitle
			$m->out(qq!<div style="margin-bottom: 3px">Artist: !);
			$m->comp("/comp/linkartist", artist => $artist);
			$m->out(qq!</div>!);
		}

</%perl>

		<table>
			<tr id="albumrow<% $release->GetId %>" valign="top">
				<td style="width: 420px">
					<& /comp/album, album => $release, artist => $artist, showmodlinks => 0, showrelationships => 0 &></td>
				<td> &nbsp;</td>

<%perl>

			$m->comp("reOrderForm", $mac,
				[ @objs[$i, 0..$i-1, $i+1..$#objs ] ],
				"Top", "Move this release to the top of the list",
				$release,
			) if $i > 0;

			$m->comp("reOrderForm", $mac,
				[ @objs[0..$i-2, $i, $i-1, $i+1..$#objs ] ],
				"Up", "Move this release one position to the top",
				$release,
			) if $i > 0;

			$m->comp("reOrderForm", $mac,
				[ @objs[0..$i-1, $i+1, $i, $i+2..$#objs ] ],
				"Down", "Move this release one position to the bottom",
				$release,
			) if $i < $#objs;

			$m->comp("reOrderForm", $mac,
				[ @objs[0..$i-1, $i+1..$#objs, $i ] ],
				"Bottom", "Move this release to the bottom of the list",
				$release,
			) if $i < $#objs;

</%perl>

		   </tr>
       </table>

%	   $i++;
%	}


	<& /comp/js/diffcollapse &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

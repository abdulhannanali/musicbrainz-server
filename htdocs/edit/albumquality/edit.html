<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows editing the quality of a release
	#
	# $Id: edit.html 8548 2006-10-19 07:41:02Z dave $
	#
</%perl>
<%args>

	@id => ()

	$quality_new => undef

	$confirm => 0
	$untag => 0

	$submitvalue => ""
	$notetext => ""

</%args>
<%perl>

	# only logged in users can see this page
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# there has to be at least one release
	(@id > 0) or return $m->comp("/comp/badargs", 1, 1);

	# check volatile preferences (like autoeditor flag)
	$m->comp("/comp/user/check-volatile-preferences", %ARGS);

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# load 1..n releases from the database, and track
	# release artistids in artisthash
	my @releaseobjs = ();
	my %artisthash;
    my ($low, $hi) = (&ModDefs::QUALITY_HIGH, &ModDefs::QUALITY_LOW);
    my $quality;
	foreach my $releaseid (@id)
	{
		MusicBrainz::Server::Validation::IsNonNegInteger($releaseid) && $releaseid
			or return $m->comp("/comp/badargs", 1, 1);

		my $release = $m->comp("/comp/loadrelease", $mb, $releaseid);
		push @releaseobjs, $release;
        $quality = $release->GetQuality == &ModDefs::QUALITY_UNKNOWN ? &ModDefs::QUALITY_UNKNOWN_MAPPED : $release->GetQuality;
        $low = $low < $quality ? $low : $quality;
        $hi = $hi > $quality ? $hi : $quality;

		++$artisthash{$release->GetArtist};
	}

	$quality_new = 0 if (defined $quality_new and $quality_new eq "");

	my @errors = ();
    if (defined $quality_new && $quality_new <= $hi && $quality_new >= $low)
    {
        push @errors, qq|In order to batch change a number of releases, they must all be changed to
                         to a higher quality lever or a lower quality level. Lowering and raising
                         releases in one batch edit is not allowed. Also, all releases must change 
                         quality levels -- keeping releases the same in one batch is not allowed.|;
    }

	# we got a a form submission
	if ($submitvalue ne "")
	{
		push @errors, "Please select the quality of the selected releases." 
             if ($quality_new < &ModDefs::QUALITY_LOW || $quality_new > &ModDefs::QUALITY_HIGH);

		if ($submitvalue =~ /Cancel/i)
		{
			# prepare url for cancel redirct:
			# * only one release, redirect to the release
			# * multiple releases, redirect to the batchop page
			my $url =
				@id == 1
					? "/release/" . $releaseobjs[0]->GetMBId . ".html"
					: "/edit/albumbatch/done.html";

			$m->comp("/comp/redirect", $url);
		}
		elsif (@errors == 0)
		{
			# prepare url for enter mods redirct:
			# * only one release, redirect to the release
			# * to the artist of release 0, if it was found
			# * if neither case is satisfied, redirect to /search.html
			my $url =
				@id == 1
					? "/release/" . $releaseobjs[0]->GetMBId . ".html"
					: keys(%artisthash) == 1
						? "/show/artist/?artistid=" . $releaseobjs[0]->GetArtist
						: "/search.html";

			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods = Moderation->InsertModeration(
						DBH	=> $mb->{DBH},
						uid	=> $session{uid},
						privs => $session{privs},
						type => &ModDefs::MOD_CHANGE_RELEASE_QUALITY,
						# --
						releases => \@releaseobjs,
						quality => $quality_new,
					);

					$mods[0]->InsertNote($session{"uid"}, $notetext)
						if $mods[0]
						and $notetext =~ /\S/;

					delete $session{"tagged_albums"}
						if $untag;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}
	}
	else
	{
		# if we are editing one release, load the current values from
		# the database, else guess them from the list of releases.
		if (@releaseobjs == 1)
		{
			my $release = $releaseobjs[0];
			$quality_new = $release->GetQuality;
		}
	}

	if (not defined $quality_new)
	{
        $quality_new = &ModDefs::QUALITY_NORMAL;
    }

	# set the current values from the argument, or the first release handed in.
	my $quality_curr = (scalar(@releaseobjs) == 1) ? $releaseobjs[0]->GetQuality : -1;

	# see if one of the releases has a modpending flag.
	my $mp = grep { $_->GetLanguageModPending } @releaseobjs;

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Edit release quality" &>

	<!-- add editsuite for modnote resizer support -->
	<script type="text/javascript" src="/scripts/editsuite.js"></script>

	<form method="post" action="/edit/albumquality/edit.html" id="EditAlbumQualityForm">

%	if (@releaseobjs == 1)
%	{

		<& /comp/layout/editformbegin, title => "Edit release quality",
			release => $releaseobjs[0],
			mp_type => &ModDefs::MOD_CHANGE_RELEASE_QUALITY,
		&>

%	}
%	else
%	{

		<& /comp/layout/editformbegin, title => "Edit release data quality",
			mp_type => &ModDefs::MOD_CHANGE_RELEASE_QUALITY,
			mp => $mp,
		&>

%	}

		<table class="formstyle">
			<tr>
				<td class="instructions" colspan="2">
					<ul>
						<li>
							Please choose the <& /comp/linkdoc, "DataQuality", "quality" &>
							of the selected releases.</li>
					</ul>
				</td>
			</tr>

%	if (@errors)
%	{

			<tr>
				<td>&nbsp;</td>
				<td>
					<& /comp/form/feedbackbox,
						"warning", "Your form submission contains errors:",
						"<ul><li>"
					  . join ("</li><li>", @errors)
					  . "</li></ul>" &></td>
			</tr>

%	}

			<tr class="top">
				<td class="label">
					<label>Selected releases:</label></td>
				<td>
				<table class="releaselist">
					<tr class="header">
						<td>Release title:</td>
						<td>Quality:</td>
					</tr>

<%perl>

	my $n = 0;
	foreach my $release ( @releaseobjs )
	{
		$m->out("<tr>");

		# TODO: load artist for this?
		# $m->out(qq!<td style="padding-right: 40px">!);
		# $m->comp("/comp/linkartist", artist => $release->GetArtist);
		# $m->out(qq!</td><td style="padding-right: 40px">!);

		$m->out(qq!<td style="padding-right: 40px">!);
		$m->comp("/comp/form/currentvalue", release => $release, mp_type => &ModDefs::MOD_EDIT_ALBUM_LANGUAGE);
		$m->out(qq!</td><td style="padding-right: 40px">!);
		$m->out(ModDefs::GetQualityText($release->GetQuality));
		$m->out(qq!</td></tr>!);
	}

</%perl>

					</table>
				</td>
			</tr>

			<& /edit/albumquality/form,
				quality_curr	=> $quality_curr,
				quality_fieldname => "quality_new",
				notetext => $notetext,
			&>
		</table>

% 	foreach my $releaseid (@id)
%	{
%		$m->comp("/comp/form/hiddenfield", "id", $releaseid);
% 	}

		<& /comp/form/hiddenfield, "untag", $untag &>
		<& /comp/form/focusfield, "language_new" &>

		<& /comp/layout/editformend &>

	</form>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

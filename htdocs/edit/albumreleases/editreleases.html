<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Add, Remove and Change the release events of this release
	#
	# $Id$
	#
</%perl>
<%args>

	$releaseid
	$submitvalue => ""
    $force => 0

</%args>
<%perl>

	# let's see if we still got a session, else redirect
	# to the given releaseid.
	my $url = "/show/release/?releaseid=" . $releaseid;
	my $edit = $session{"editreleases"}{$releaseid}
		or return $m->comp("/comp/redirect", $url);

	# the user clicked on the cancel button, remove current
	# release from the session and show the release again.
	return $m->comp("/comp/redirect", "/edit/albumreleases/cancel.html?releaseid=".$releaseid)
		if ($submitvalue eq "Cancel");

	my $countries_menu = $m->comp("countries-menu.inc");
	my $countries_menu_2 = [ [ "", "[select a country]" ], @$countries_menu ];
	my $formats_menu = MusicBrainz::Server::ReleaseEvent::GetReleaseFormats();
    my $error;

	# Update releases
	my @errors = ();
	my $showforce = 0;
	my $releases = $edit->{"releases"};
	for my $rel (@$releases)
	{
		if (%ARGS)
		{
			$ARGS{"releasedel".$rel->{id}}
				? $rel->{"delete"} = 1
				: delete $rel->{"delete"};
			next if $rel->{"delete"};
		}

		# Force all the fields to either "", an integer, or "X" (invalid)
		my ($y, $mon, $d, $c) = map {
			my $v = $ARGS{$_.$rel->{id}};
			$v = "" if not defined $v;
			$v = "X" if $v ne ""
				and not MusicBrainz::Server::Validation::IsNonNegInteger($v);
			$v;
		} qw( y m d country );

		# Check the country
		$rel->{country} = $c
			if grep { $_->[0] == $c } @$countries_menu;

		my $labelname = $ARGS{"labelname" . $rel->{id}};
		$rel->{labelname} = $labelname if defined $labelname;
		my $orig_labelname = $ARGS{"orig_labelname" . $rel->{id}};
		$rel->{orig_labelname} = $orig_labelname if defined $orig_labelname;
		my $label = $ARGS{"label" . $rel->{id}};
		$rel->{label} = $label if defined $label;
		my $catno = $ARGS{"catno".$rel->{id}};
		$rel->{catno} = $catno if defined $catno;
		my $barcode = $ARGS{"barcode".$rel->{id}};
		$rel->{barcode} = $barcode if defined $barcode;
		my $format = $ARGS{"format".$rel->{id}};
		$rel->{format} = $format if defined $format;

		# Check the date
		if ($y >= 1900 and $y<= 2100)
		{
			if ($mon and $d)
			{
				require Date::Calc;
				unless (Date::Calc::check_date($y, $mon, $d))
				{
					$m->comp("/comp/sidebar", title => "Date error");
					</%perl>
					<p>
						Sorry, <% "$y-$mon-$d" %> is not a valid date.&nbsp;
						<a href="javascript:history.back()">Go back and try again</a>.
					</p>
					<%perl>
					$m->comp("/comp/footer");
					return;
				}
                # Check for the amazon bogus release date
				if (!$force && $y == 1990 && $mon == 10 && $d == 25)
				{
					push @errors, qq|Warning! "$y-$mon-$d" is the bogus date that Amazon gives to
                                all releases for which they don't know the actual date. If you're
                                certain that this date is correct, tick the confirmation checkbox
                                below.|;
					$showforce = 1;
				}
				@$rel{qw( year month day )} = ($y, $mon, $d);
			}
			elsif ($mon and $mon >= 1 and $mon <= 12)
			{
				@$rel{qw( year month day )} = ($y, $mon, "");
			}
			else
			{
				@$rel{qw( year month day )} = ($y, "", "");
			}
		}

		# Check the barcode
		$rel->{barcode} =~ s/(-|\s)+//g;
		if (MusicBrainz::Server::Validation::IsValidBarcode($rel->{barcode})) {
			push @errors, 'Barcode "' . $rel->{barcode} . '" should contain only numbers, please remove all non-numeric characters.';
			delete $ARGS{'continue'};
		}
		elsif (!$force) {
			if ($rel->{barcode} && !MusicBrainz::Server::Validation::IsValidEAN($rel->{barcode})) {
				push @errors, 'Barcode "' . $rel->{barcode} . '" is not a valid EAN barcode. If it\'s a different type of barcode, tick the confirmation checkbox below.';
				$showforce = 1;
			}
		}

		delete $ARGS{'continue'}
			if not $rel->{country}
			or not $rel->{year};
	}

	@$releases = grep {
		not $_->{'new'} or not $_->{"delete"}
	} @$releases;

	@$releases = sort {
		$a->{year} <=> $b->{year}
		or
		$a->{month} <=> $b->{month}
		or
		$a->{day} <=> $b->{day}
		or
		$a->{country} <=> $b->{country}
	} @$releases;

	my $focusfield;

	if ($ARGS{"AddARelease"} or @$releases == 0)
	{
		my $new_id = 0;
		for (@$releases)
		{
			$new_id = $_->{id} if $_->{id} < $new_id;
		}
		--$new_id;

		my @localtime = localtime;

		push @$releases, {
			new => 1,
			id => $new_id,
			country => UserPreference::get('default_country'),
			year => "", # $localtime[5]+1900,
			month => "", # $localtime[4]+1,
			day => "", # $localtime[3],
		};
		$focusfield = "y".$new_id;

		delete $ARGS{"continue"};
	}
	
	$focusfield ||= "y".$releases->[0]{id} if @$releases;
	$focusfield ||= "AddARelease";

	$session{"editreleases"}{$releaseid} = $edit; # write

	return $m->comp("/comp/redirect", "/edit/albumreleases/selectlabel.html?releaseid=".$releaseid)
		if $ARGS{"continue"} && ((@errors == 0) || !@errors);

	my $artist = MusicBrainz::Server::Artist->new(undef);
	$artist->SetId($edit->{"artist"}{"id"});
	$artist->SetName($edit->{"artist"}{"name"});
	$artist->SetSortName($edit->{"artist"}{"sortname"});

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Edit release events" &>

	<& /comp/stylemenu &>

	<script type="text/javascript" src="/scripts/jsselect.js"></script>
	<script type="text/javascript" src="/scripts/labeleditors.js"></script>
	<script type="text/javascript" src="/scripts/editreleasesconfig.js"></script>
	<script type="text/javascript" src="validate.js"></script>

	<form method="post"
		action="/edit/albumreleases/editreleases.html"
		id="EditReleasesForm"
		onsubmit="return checkEditReleasesForm(this)">

		<& /comp/layout/editformbegin,
			title => "Edit Release Events",
			mp => (grep { $_->{modpending} } @$releases) > 0,
		&>

		<table class="formstyle">
			<tr>
				<td class="instructions" colspan="2">
					<ul>
						<li>
							Each release event is made up of a <em>date</em> and a
							country. A <em>date</em> can be just a year (four digits
							please), or a year and a month, or a year and month and day.
						</li>
						<li>
							<strong>To remove</strong> a release event, click the respective checkbox on
							the right, and click on the button Continue - The release event
							will be marked for removal. Please note, that the release will not be
							removed right away, you'll have to confirm the removal of the
							event on the review page.
						</li>
						<li>
							<strong>To add</strong> a release event, click the "Add a release event"
							checkbox click on the button Continue - a new, empty set of
							fields will appear, and the country will be pre-selected to the
							country you have configured your user preferences.
						</li>
						<li>
							When you click <strong>Continue</strong> you'll be shown what changes you've made.
							Your changes will be entered as a single edit. If your edit
							consists only of <em>additions</em> (no changes, no deletes) it will
							be applied instantly.
						</li>
					</ul>
				</td>
			</tr>

			<tr>
				<td class="label">
					<label>Artist:</label></td>
				<td class="field">
					<& /comp/linkartist, artist => $artist &></td>
			</tr>
			<tr>
				<td class="label"><label>Release:</label></td>
				<td class="field">
					<& /comp/linkrelease, id => $edit->{'id'}, name => $edit->{'name'} &></td>
			</tr>

% 	if (@errors) {
			<tr>
				<td></td>
				<td class="error">
					<ul>
						<li>
							<%perl> $m->out(join "</li><li>", @errors), </%perl>
						</li>
					</ul>
				</td>
			</tr>
% 	}

			<tr>
				<td colspan="2" style="padding-top: 20px;">
					<table style="formstyle" border="0" cellspacing="0" cellpadding="0">
						<tr class="header">
							<td><strong>Date (<abbr title="Year">Y</abbr>/<abbr title="Month">M</abbr>/<abbr title="Day">D</abbr>):</strong></td>
							<td>Country:</td>
							<td colspan="2">Label:</td>
							<td>Catalog #:</td>
							<td>Barcode:</td>
							<td>Format:</td>
							<td>
								<span title="Activate the checkboxes below to remove release events" style="cursor: help">Remove</span></td>
						</tr>
<%perl>

	my $tabindex = 0;
	for my $rel (@$releases)
	{
		my $datecss = "";
		$m->out(sprintf "<tr %s>", ($rel->{modpending} ? qq! class="mp"!  : ""));

</%perl>
<td nowrap="nowrap">
	<& /comp/form/numberfield, type => "yearfield", name => "y" . $rel->{"id"},
		cssclass => $datecss, tabindex => ++$tabindex, value => $rel->{year} || '', size => 4, maxlength => 4 &>
	<& /comp/form/numberfield, type => "monthfield", name => "m" . $rel->{"id"},
		cssclass => $datecss, tabindex => ++$tabindex, value => $rel->{month} || '', size => 2, maxlength => 2 &>
	<& /comp/form/numberfield, type => "dayfield", name => "d" . $rel->{"id"},
		cssclass => $datecss, tabindex => ++$tabindex, value => $rel->{day} || '', size => 2, maxlength => 2 &></td>
<td>
	<select name="country<% $rel->{"id"} %>" class="country" tabindex="<% ++$tabindex %>">
		<& /comp/options, ($rel->{country} ? $countries_menu : $countries_menu_2), $rel->{country} &>
	</select></td>
<td id="labelcheckbox<%  $rel->{"id"} %>"></td>
<td>
	<& /comp/form/hiddenfield, "orig_labelname" . $rel->{"id"}, $rel->{orig_labelname} || '' &>
	<& /comp/form/hiddenfield, "label" . $rel->{"id"}, $rel->{label} || '' &>
	<span id="labelinput<%  $rel->{"id"} %>">
	<& /comp/form/numberfield, type => "shorttxtfield", name => "labelname" . $rel->{"id"}, cssclass => " labelname",
		tabindex => ++$tabindex, value => $rel->{labelname} || '', size => 15, maxlength => 255 &></div></td>
<td>
	<& /comp/form/numberfield, type => "shorttxtfield", name => "catno" . $rel->{"id"},
		tabindex => ++$tabindex, value => $rel->{catno} || '', size => 12, maxlength => 255 &></td>
<td>
	<& /comp/form/numberfield, type => "shorttxtfield", name => "barcode" . $rel->{"id"},
		tabindex => ++$tabindex, value => $rel->{barcode} || '', size => 12, maxlength => 255 &></td>
<td>
	<select name="format<% $rel->{"id"} %>" style="width: 9em" tabindex="<% ++$tabindex %>">
		<& /comp/options, $formats_menu, $rel->{format} &>
	</select></td>
<td align="center">
	<input type="checkbox" name="releasedel<% $rel->{"id"} %>" value="1" <% $rel->{'delete'} ? "checked" : "" %>
		title="Active this checkbox to remove this release event" tabindex="<% ++$tabindex %>" /></td>
</tr>
% 	}

% 	if (not @$releases)
%	{

						<tr>
							<td colspan="6">
								No release information available.&nbsp;
								Click "Add a release event" and "Continue" to add a release.</td>
						</tr>

% 	}

						<tr>
							<td colspan="6" class="padtop">
								<input type="checkbox" name="AddARelease" value="1" />
								Add a release event ...</td>
						</tr>
%   if ($showforce) {
						<tr>
                			<td colspan="6" class="padtop"><input type="checkbox" name="force"> Yes, I'm sure the information is correct.</td>
						</tr>
%   }
					</table>
				</td>
			</tr>
			<tr class="spaced">
				<td class="submitbuttons" colspan="2">
					<input type="submit" name="submitvalue" class="button" value="Continue &raquo;" />
					<input type="submit" name="submitvalue" class="button" value="Cancel" />
					<input type="hidden" name="releaseid" value="<% $releaseid %>" />
					<input type="hidden" name="continue" value="1" />
				</td>
			</tr>
		</table>
		<& /comp/layout/editformend &>
	</form>
	<& /comp/movefocus, "EditReleasesForm", $focusfield &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

%# vi: set ts=4 sw=4 ft=mason :
<%args>
	$albumid
</%args>
<%perl>
	# let's see if we still got a session, else redirect
	# to the given albumid.
	my $albumurl = "/showalbum.html?albumid=" . $albumid;
	my $edit = $session{"editreleases"}{$albumid}
		or return $m->comp("/comp/redirect", $albumurl);

	my $mb = $m->comp("/comp/dblogin");
	my $changes = 0;

	my $al = Album->new($mb->{DBH});
	$al->SetId($edit->{"id"});
	$al->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Album not found in the database.",
			1, 1,
		);

	my $ar = Artist->new($mb->{DBH});
	$ar->SetId($al->GetArtist);
	$ar->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Artist not found in the database.",
			1, 1,
		);

	my @releases = $al->Releases;
	my @tracks = $al->LoadTracks;
</%perl>

<& /comp/sidebar-notitle, pagetitle => "Edit Release Events: Review Changes" &>

	<& /comp/artisttitle, artist => $ar &>

	<& /comp/tablebegin, title => "Review Moderations" &>

	<div class="padleft">
		These are the moderations that will be entered into
		the system when you click "Enter Moderations":
	</div>
	<div class="padlefttop">
		<table class="listing">
			<tr class="header">
				<td class="left">Moderation</td>
				<td class="left">Old Value</td>
				<td class="left">New Value</td>
			</tr>

<%perl>

	my $countries_menu = $m->comp("countries-menu.inc");
	my %country_name = map { $_->[0], $_->[1] } @$countries_menu;

	for my $rel (@{ $edit->{releases} })
	{
		if ($rel->{"new"})
		{
			</%perl>
				<tr valign="top">
					<td class="left" style="padding-right: 40px">Add Release</td>
					<td class="left" style="padding-right: 40px">&nbsp;</td>
					<td class="left">
						Date: <& /comp/releasedate, @$rel{qw( year month day )} &> <br />
						Country: <% $country_name{$rel->{country}} || "?" %></td>
				</tr>
			<%perl>
			++$changes;
			next;
		}

		if ($rel->{'delete'})
		{
			</%perl>
				<tr valign="top">
					<td class="left" style="padding-right: 40px">Remove Release</td>
					<td class="left" style="padding-right: 40px">
						Date: <& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &><br />
						Country: <% $country_name{$rel->{orig_country}} || "?" %></td>
					<td class="left">&nbsp;</td>
				</tr>
			<%perl>
			++$changes;
			next;
		}

		next unless grep {
			$rel->{$_} != $rel->{"orig_".$_}
		} qw( year month day country );

		{
			</%perl>
				<tr valign="top">
					<td class="left" style="padding-right: 40px">Edit Release</td>
					<td class="left" style="padding-right: 40px">
						Date: <& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &><br />
						Country: <% $country_name{$rel->{orig_country}} || "?" %></td>
					<td class="left">
						Date: <& /comp/releasedate, @$rel{qw( year month day )} &><br />
						Country: <% $country_name{$rel->{country}} || "?" %></td>
				</tr>
			<%perl>
			++$changes;
		}
	}
</%perl>

% 	if (not $changes) {
			<tr>
				<td colspan="3" class="left">
					You have not made any changes!</td>
			</tr>
%	}
		</table>
	</div>

	<div class="padlefttop">
		<table>
			<tr>
				<td>
					<form method="get" action="editreleases.html">
						<div>
							<input type="submit" class="button" value="Keep Editing" />
							<input type="hidden" name="albumid" value="<% $albumid %>" />
						</div>
					</form></td>
				<td>
					<form method="get" action="index.html">
						<div>
							<input type="hidden" name="album" value="<% $albumid %>" />
							<input type="submit" class="button" value="Start Over" />
						</div>
					</form></td>
				<td>
					<form method="get" action="cancel.html">
						<div>
							<input type="submit" class="button" value="Abandon" />
							<input type="hidden" name="albumid" value="<% $albumid %>" />
						</div>
					</form></td>
			</tr>
		</table>
	</div>
	<& /comp/tableend &>


% 	if ($changes) {

	<& /comp/tablebegin, title => "Enter Moderations" &>

		<form method="post" action="enter.html">
			<div class="padlefttop">
				<& /comp/notetext &>
			</div>
			<div class="padlefttop">
				<input type="submit" class="button" value="Enter Moderations" />
				<input type="hidden" name="albumid" value="<% $albumid %>" />
			</div>
		</form>

	<& /comp/tableend &>
% 	}

<& /comp/footer &>

<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Review the changes made to the release events
	#
	# $Id$
	#
</%perl>
<%args>

	$releaseid
	$submitvalue => ""
	$notetext => ""

</%args>
<%perl>

	# let's see if we still got the required data in
	# the session, else redirect to the given releaseid.
	my $url = "/show/release/?releaseid=" . $releaseid;
	my $edit = $session{"editreleases"}{$releaseid}
		or return $m->comp("/comp/redirect", $url);

	# check volatile preferences (like autoeditor flag)
	$m->comp("/comp/user/check-volatile-preferences", %ARGS);

	# handle form submission
	if ($submitvalue ne "")
	{
		if ($submitvalue =~ m/Cancel/i)
		{
			return $m->comp("/comp/redirect", "/edit/albumreleases/cancel.html?releaseid=$releaseid");
		}
		elsif ($submitvalue =~ m/Start over/i)
		{
			# Erase editnote in session
			delete $edit->{"editnote"};
			$session{"editreleases"}{$releaseid} = $edit;

			return $m->comp("/comp/redirect", "/edit/albumreleases/index.html?releaseid=$releaseid");
		}
		elsif ($submitvalue =~ m/Enter edits/i)
		{
			return $m->comp(
				"/edit/albumreleases/enter.html",
				releaseid => $releaseid,
				notetext => $notetext,
			);
		}
		elsif ($submitvalue =~ m/Keep editing/i)
		{
			# Store editnote in session
			$edit->{"editnote"} = $notetext;
			$session{"editreleases"}{$releaseid} = $edit;

			return $m->comp("/comp/redirect", "/edit/albumreleases/editreleases.html?releaseid=$releaseid");
		}
	}

	my $mb = $m->comp("/comp/dblogin");
	my $changes = 0;

	my $release = $m->comp("/comp/loadrelease", $mb, $edit->{"id"});
	my $artist = $m->comp("/comp/loadartist", $mb, $release->GetArtist);

	my @tracks = $release->LoadTracks;

	$notetext = $edit->{"editnote"} if $notetext eq "";

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Edit Release Events: Review Changes" &>

	<& /comp/tablebegin, title => "Review edits" &>

		<div style="margin-left: 40px">
			These are the edits that will be entered into the system when you
			click on "Enter edits":

			<table class="listing" style="margin: 20px 0px">
				<tr class="header">
					<td class="left padright">Edit:</td>
					<td class="left padright">Change:</td>
				</tr>

<%perl>

	my @relEventsNew;

	my $countries_menu = $m->comp("countries-menu.inc");
	my %country_name = map { $_->[0], $_->[1] } @$countries_menu;

	for my $rel (@{ $edit->{releases} })
	{
		if ($rel->{'delete'})
		{
			</%perl>
				<tr valign="top">

					<td class="left padright">
						<& /comp/linkdoc, "RemoveReleaseEventsEdit", "Remove release events" &>
					</td>
					<td class="left padright">
						<& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &> -
						<% $country_name{$rel->{orig_country}} || "?" %> -
						<strong>Label:</strong>
%						if ($rel->{orig_label})
%						{
%							my $label = $m->comp("/comp/loadlabel", $mb, $rel->{orig_label});
							<& /comp/linklabel, label => $label &>
%						}
%						else
%						{
							?
%						}
						-
						<strong>Catalog #:</strong> <% $rel->{orig_catno} || "?" %> - 
						<strong>Barcode:</strong> <% $rel->{orig_barcode} || "?" %> -
						<strong>Format:</strong> <%
							$rel->{orig_format}
								? MusicBrainz::Server::ReleaseEvent::GetReleaseFormatName($rel->{orig_format})
								: "?" %>
					</td>
				</tr>
			<%perl>
			++$changes;
			next;
		}

		if ($rel->{"new"})
		{
			</%perl>
				<tr valign="top">
					<td class="left padright">
						<& /comp/linkdoc, "AddReleaseEventsEdit", "Add release events" &>
					</td>
					<td class="left">
						<& /comp/releasedate, @$rel{qw( year month day )} &> - 
						<% $country_name{$rel->{country}} || "?" %> - 
						<strong>Label:</strong>
%						if ($rel->{label})
%						{
%							my $label = $m->comp("/comp/loadlabel", $mb, $rel->{label});
							<& /comp/linklabel, label => $label &>
%						}
%						else
%						{
							?
%						}
						-
						<strong>Catalog #:</strong> <% $rel->{catno} || "?" %> - 
						<strong>Barcode:</strong> <% $rel->{barcode} || "?" %> -
						<strong>Format:</strong> <%
							$rel->{format}
								? MusicBrainz::Server::ReleaseEvent::GetReleaseFormatName($rel->{format})
								: "?" %>
					</td>
				</tr>
			<%perl>
			++$changes;

			my $rev = MusicBrainz::Server::ReleaseEvent->new($mb->{DBH});
			$rev->SetCountry($rel->{country});
			$rev->SetYMD(@$rel{qw( year month day )});
			$rev->SetLabel($rel->{label});
			$rev->SetLabelName($rel->{labelname});
			$rev->SetCatNo($rel->{catno});
			$rev->SetBarcode($rel->{barcode});
			$rev->SetFormat($rel->{format});
			push @relEventsNew, $rev;

			next;
		}

		my $rev = MusicBrainz::Server::ReleaseEvent->new($mb->{DBH});
		$rev->SetCountry($rel->{country});
		$rev->SetYMD(@$rel{qw( year month day )});
		$rev->SetLabel($rel->{label});
		$rev->SetLabelName($rel->{labelname});
		$rev->SetCatNo($rel->{catno});
		$rev->SetBarcode($rel->{barcode});
		$rev->SetFormat($rel->{format});
		push @relEventsNew, $rev;

		next if 
			int($rel->{orig_year}) == int($rel->{year}) and
			int($rel->{orig_month}) == int($rel->{month}) and
			int($rel->{orig_day}) == int($rel->{day}) and
			int($rel->{orig_country}) == int($rel->{country}) and
			int($rel->{orig_label}) == int($rel->{label}) and
			$rel->{orig_catno} eq $rel->{catno} and
			$rel->{orig_barcode} eq $rel->{barcode} and
			$rel->{orig_format} eq $rel->{format};

		{

</%perl>

				<tr valign="top">
					<td class="left padright">
						<& /comp/linkdoc, "EditReleaseEventsEdit", "Edit release events" &>
					</td>
					<td class="left padright">
						<& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &> - 
						<% $country_name{$rel->{orig_country}} || "?" %> - 
						<strong>Label:</strong>
%						if ($rel->{orig_label})
%						{
%							my $label = $m->comp("/comp/loadlabel", $mb, $rel->{orig_label});
							<& /comp/linklabel, label => $label &>
%						}
%						else
%						{
							?
%						}
						-
						<strong>Catalog #:</strong> <% $rel->{orig_catno} || "?" %> - 
						<strong>Barcode:</strong> <% $rel->{orig_barcode} || "?" %> -
						<strong>Format:</strong> <%
							$rel->{orig_format}
								? MusicBrainz::Server::ReleaseEvent::GetReleaseFormatName($rel->{orig_format})
								: "?" %>
						
						<br/>
						
						<& /comp/releasedate, @$rel{qw( year month day )} &> - 
						<% $country_name{$rel->{country}} || "?" %> - 
						<strong>Label:</strong>
%						if ($rel->{label})
%						{
%							my $label = $m->comp("/comp/loadlabel", $mb, $rel->{label});
							<& /comp/linklabel, label => $label &>
%						}
%						else
%						{
							?
%						}
						-
						<strong>Catalog #:</strong> <% $rel->{catno} || "?" %> - 
						<strong>Barcode:</strong> <% $rel->{barcode} || "?" %> -
						<strong>Format:</strong> <%
							$rel->{format}
								? MusicBrainz::Server::ReleaseEvent::GetReleaseFormatName($rel->{format})
								: "?" %>
					</td>
				</tr>

<%perl>

			++$changes;
		}
	}

</%perl>

% 	if (not $changes)
%	{

			<tr>
				<td colspan="3" class="left">
					You have not made any changes!</td>
			</tr>
%	}

			</table>
		</div>

	<& /comp/tableend &>


	<& /comp/tablebegin, title => "Preview release" &>

		<div style="margin: 0px 40px">
			<& /comp/artisttitle, artist => $artist, showlinks => 0, showmodlinks => 0 &>
			<& /comp/album,
				album => $release,
				artist => $artist,
				showlinks => 0,
				showmodlinks => 0,
				showreleases => 1,
				tracks => \@tracks,
				releaseevents => \@relEventsNew, &>
		</div>

	<& /comp/tableend &>

	<& /comp/tablebegin, title => "Enter edits" &>

		<script type="text/javascript" src="/scripts/editsuite.js"></script>

		<form method="post" action="review.html">
			<table class="formstyle">
				<tr>
					<td class="notetext">

%	my @buttons;
%	push @buttons, ["Enter edits Â»", "btnYes", !$changes];
%	push @buttons, ["Keep editing", ""];
%	push @buttons, ["Start over", ""];
%	push @buttons, ["Cancel", "btnCancel"];

						<& /comp/notetext,
							notetext => $notetext,
							buttons => \@buttons &>

						<input type="hidden" name="releaseid" value="<% $release->GetId %>" />
					</td>
				</tr>
			</table>
		</form>

	<& /comp/tableend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

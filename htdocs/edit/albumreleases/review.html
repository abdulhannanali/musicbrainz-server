<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Review the changes made to the release events
	#
	# $Id$
	#
</%perl>
<%args>

	$releaseid
	$notetext => ""

</%args>
<%perl>

	# let's see if we still got the required data in
	# the session, else redirect to the given releaseid.
	my $url = "/show/release/?releaseid=" . $releaseid;
	my $edit = $session{"editreleases"}{$releaseid}
		or return $m->comp("/comp/redirect", $url);

	# check volatile preferences (like autoeditor flag)
	$m->comp("/comp/user/check-volatile-preferences", %ARGS);


	my $mb = $m->comp("/comp/dblogin");
	my $changes = 0;

	my $release = $m->comp("/comp/loadrelease", $mb, $edit->{"id"});
	my $artist = $m->comp("/comp/loadartist", $mb, $release->GetArtist);

	my @releases = $release->Releases;
	my @tracks = $release->LoadTracks;

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Edit Release Events: Review Changes" &>

	<& /comp/tablebegin, title => "Review Changes" &>

	<div class="padleft">
		These are the edits that will be entered into
		the system when you click "Enter Edit":
	</div>

	<div class="padlefttop">
		<table class="listing" style="margin: 20px 0px">
			<tr class="header">
				<td class="left padright">Edit</td>
				<td class="left padright">Old Value</td>
				<td class="left padright">New Value</td>
			</tr>

<%perl>

	my @relEventsNew;

	my $countries_menu = $m->comp("countries-menu.inc");
	my %country_name = map { $_->[0], $_->[1] } @$countries_menu;

	for my $rel (@{ $edit->{releases} })
	{
		if ($rel->{'delete'})
		{
			</%perl>
				<tr valign="top">
					<td class="left padright">Remove Release</td>
					<td class="left padright">
						Date: <& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &><br />
						Country: <% $country_name{$rel->{orig_country}} || "?" %></td>
					<td class="left">&nbsp;</td>
				</tr>
			<%perl>
			++$changes;
			next;
		}

		if ($rel->{"new"})
		{
			</%perl>
				<tr valign="top">
					<td class="left padright">Add Release</td>
					<td class="left padright">&nbsp;</td>
					<td class="left">
						Date: <& /comp/releasedate, @$rel{qw( year month day )} &> <br />
						Country: <% $country_name{$rel->{country}} || "?" %></td>
				</tr>
			<%perl>
			++$changes;

			my $rev = MusicBrainz::Server::Release->new($mb->{DBH});
			$rev->SetCountry($rel->{country});
			$rev->SetYMD(@$rel{qw( year month day )});
			push @relEventsNew, $rev;

			next;
		}

		next unless grep {
			$rel->{$_} != $rel->{"orig_".$_}
		} qw( year month day country );

		{

</%perl>

				<tr valign="top">
					<td class="left" style="padding-right: 40px">Edit Release</td>
					<td class="left" style="padding-right: 40px">
						Date: <& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &><br />
						Country: <% $country_name{$rel->{orig_country}} || "?" %></td>
					<td class="left">
						Date: <& /comp/releasedate, @$rel{qw( year month day )} &><br />
						Country: <% $country_name{$rel->{country}} || "?" %></td>
				</tr>

<%perl>
			my $rev = MusicBrainz::Server::Release->new($mb->{DBH});
			$rev->SetCountry($rel->{country});
			$rev->SetYMD(@$rel{qw( year month day )});
			push @relEventsNew, $rev;

			++$changes;
		}
	}

</%perl>

% 	if (not $changes)
%	{

			<tr>
				<td colspan="3" class="left">
					You have not made any changes!</td>
			</tr>
%	}
		</table>
	</div>

	<div class="padlefttop">
		<table>
			<tr>
				<td>
					<form method="get" action="editreleases.html">
						<div>
							<input class="button" type="submit" value="Keep Editing" />
							<input type="hidden" name="releaseid" value="<% $releaseid %>" />
						</div>
					</form></td>
				<td>
					<form method="get" action="index.html">
						<div>
							<input type="hidden" name="releaseid" value="<% $releaseid %>" />
							<input class="button" type="submit" value="Start Over" />
						</div>
					</form></td>
			</tr>
		</table>
	</div>
	<& /comp/tableend &>


% 	if ($changes)
%	{

	<div style="margin-bottom: 3px">
		<& /comp/linkartist, artist => $artist &>
	</div>

	<div style="margin-bottom: 20px">

	<& /comp/album,
		album => $release,
		artist => $artist,
		showlinks => 0,
		showmodlinks => 0,
		showreleases => 1,
		tracks => \@tracks,
		releaseevents => \@relEventsNew, &>

	</div>

	<& /comp/tablebegin, title => "Enter Edit" &>

		<script type="text/javascript" src="/scripts/editsuite.js"></script>

		<form method="post" action="enter.html">
			<table class="formstyle">
				<tr>
					<td class="notetext">
						<& /comp/notetext,
							notetext => $notetext, &>

						<input type="hidden" name="releaseid" value="<% $release->GetId %>" /></td>
				</tr>
			</table>
		</form>

	<& /comp/tableend &>

% 	}

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

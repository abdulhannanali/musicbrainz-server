<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Add, Remove and Change the release events of this release
	#
	# $Id$
	#
</%perl>
<%args>

	$releaseid

	$search			=> undef
	$submit_search	=> undef
	$selected_label	=> undef

	$submit_select	=> undef
	$submit_cancel	=> undef
	$submit_add		=> undef
	
</%args>
<%perl>

	# let's see if we still got a session, else redirect
	# to the given releaseid.
	my $url = "/show/release/?releaseid=" . $releaseid;
	my $edit = $session{"editreleases"}{$releaseid}
		or return $m->comp("/comp/redirect", $url);

	if (defined $submit_add)
	{
		my $returnurl = uri_escape("/edit/albumreleases/selectlabel.html?releaseid=$releaseid&selected_label=");
		my $addlabelurl = "/edit/label/add.html?name=$search&returnurl=$returnurl";
		return $m->comp("/comp/redirect", $addlabelurl);
	}

	# the user clicked on the cancel button, remove current
	# release from the session and show the release again.
	return $m->comp("/comp/redirect", "/edit/albumreleases/cancel.html?releaseid=".$releaseid)
		if (defined $submit_cancel);

	my $countries_menu = $m->comp("countries-menu.inc");
	my %country_name = map { $_->[0], $_->[1] } @$countries_menu;

	# find the first release with missing label ID
	my $releases = $edit->{"releases"};
	my $find_label_for = undef;
	for my $rel (@$releases)
	{
		if ($rel->{labelname} && (!$rel->{label} || $rel->{labelname} ne $rel->{orig_labelname}))
		{
			if (defined $submit_select and defined $selected_label) 
			{
				$rel->{label} = $selected_label;
				$rel->{orig_labelname} = $rel->{labelname};
				$selected_label = undef;
				$search = undef;
			}
			else
			{
				$find_label_for = $rel;
				last;
			}
		}
		elsif ($rel->{labelname} eq "")
		{
			$rel->{label} = undef;
		}
	}
	
	$session{"editreleases"}{$releaseid} = $edit; # write

	# no labels found, redirect to review
	return $m->comp("/comp/redirect", "/edit/albumreleases/review.html?releaseid=".$releaseid)
		if not defined $find_label_for;

	$search = $find_label_for->{labelname}
		if not defined $search;

	# Instantiate MusicBrainz object
	my $mb = $m->comp("/comp/dblogin");

	# perform search
	my $engine = SearchEngine->new($mb->{DBH}, "label");
	$engine->Search(query => $search, limit => 0);

	my $searchperformed = $engine->Result != &SearchEngine::SEARCHRESULT_NOQUERY;
	my @found_labels;
	while (my $row = $engine->NextRow)
	{
		push @found_labels, $row;
	}
	
</%perl>

<& /comp/sidebar-notitle, pagetitle => "Edit release events" &>

	<& /comp/stylemenu &>

	<form method="post"	action="/edit/albumreleases/selectlabel.html" id="EditReleasesForm">

		<& /comp/layout/editformbegin, title => "Select Label" &>

		<table class="formstyle">
		
			<tr>
				<td class="instructions" colspan="2">
					<ul>
						<li>
							Select label for release event
							<strong><& /comp/releasedate, @$find_label_for{qw( year month day )} &> - 
							<% $country_name{$find_label_for->{country}} || "?" %></strong>.
						</li>
					</ul>
				</td>
			</tr>
		
			<tr class="top">
				<td class="label">
					<label for="id_artistfiltersearch">Search for label:</label></td>
				<td class="field">
						<input type="text" name="search" id="id_artistfiltersearch" value="<% $search %>" size="40"
							title="Enter a search keyword here" />
				</td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td class="submitbuttons">
					<input type="submit" name="submit_search" class="button" value="Search again &raquo;" />
					<input type="submit" name="submit_cancel" class="button" value="Cancel" />
				</td>
			</tr>
%			if (@found_labels)
%			{
				<tr class="spaced">
					<td>&nbsp;</td>
					<td class="formsection">
						The following labels matched your keyword <strong><% $search %></strong>.
						Please select the label you require or try another query.</td>
				</tr>
				<tr class="top">
					<td class="label">
						<label for="id_artistfiltersearch">Found labels:</label></td>
					<td class="field">
						<table border="0" cellspacing="0" cellpadding="0" class="artistfilter-listing">
%							my $checked = ' checked="checked" ';
%							my $i = 0;
%							for my $row (@found_labels)
%							{
								<tr class="row<% $i % 2 %>">
									<td class="radio">
										<input type="radio" name="selected_label"
											value="<% $row->{labelid} %>" <% $checked |n %>
											title="Select this label"
										/></td>
									<td class="no"><% $i += 1  %>:</td>
									<td class="link">
										<& /comp/linklabel,
											id => $row->{labelid},
											name => $row->{labelname},
											sortname => $row->{labelsortname},
											resolution => $row->{labelresolution},
											strong => 0 &></td>
								</tr>
%								$checked = "";
%							}
						</table>
					</td>
				</tr>
%			}
%			else 
%			{
				<tr class="spaced top">
					<td class="label">
						No labels found:</td>
					<td class="formsection">
						No label found matching your keyword <strong><% $search %></strong>.
				</tr>
%			}
			<tr>
				<td>&nbsp;</td>
				<td class="submitbuttons">
					<input type="submit" name="submit_select" class="button" value="Select &raquo;" />
				</td>
			</tr>

			<tr class="spaced top">
				<td class="label">
					Add new label?</td>
				<td>
					<& /comp/form/feedbackbox, "warning", "",
						qq!If you did not find the label you were looking for,
						you can search again with another keyword, or if you
						are sure the label was not yet added to the database,
						click on the <strong>Add new label &raquo;</strong> button! &>
				</td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td style="padding-bottom: 20px">
					<input class="button" name="submit_add" type="submit" value="Add new label &raquo;"
							title="Add a new label to MusicBrainz" />
				</td>
			</tr>

		</table>
		
		<& /comp/layout/editformend &>

		<input type="hidden" name="releaseid" value="<% $releaseid %>" />
		<input type="hidden" name="continue" value="1" />

	</form>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Edit an artist annotation.
	#
	# $URL$
	# $Id$
	#
</%perl>
<%args>
	$artistid => undef
	$annotationid => undef
	$annotationtext => undef
	$changelog => ""

	$submit => ""
</%args>
<%perl>
	# only logged in users may see this page
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	MusicBrainz::IsNonNegInteger($artistid) && $artistid
		or return $m->comp("/comp/layout/badarguments", "Artistid parameter is invalid");

	MusicBrainz::IsSingleLineString($changelog)
		or return $m->comp("/comp/layout/badarguments", "Changelog parameter is invalid");

	# Instantiate MusicBrainz object, and load the artist object
	my $mb = $m->comp("/comp/dblogin");
	my $artist = $m->comp("/comp/loadartist", $mb, $artistid);


	# Set an advisory lock to indicate that this page is currently being edited.
	# The lock times out after the given period of time and is only used to
	# inform the user. It cannot be relied on.
	# Memcached provides semaphores but we need the timeout mechanism of set()
	# here.
	my $sid = $session{_session_id};

	my $locked = MusicBrainz::Server::Annotation->LockedBy(
		&MusicBrainz::Server::Annotation::ARTIST_ANNOTATION,
		$artist->GetId,
		$sid,
	);

	MusicBrainz::Server::Annotation->GetLock(
		&MusicBrainz::Server::Annotation::ARTIST_ANNOTATION,
		$artist->GetId,
		$sid,
	);

	my $defaulttext = $annotationtext;
	my $not_most_recent = 0;
	my $origtext;

	if (MusicBrainz::IsNonNegInteger($annotationid))
	{
		my $old = MusicBrainz::Server::Annotation->new($mb->{DBH});
		$old->SetId($annotationid);
		$old->LoadFromId()
			or return $m->comp("/comp/badargs", 1, 1);

		$defaulttext = $old->GetText()
			unless defined $defaulttext;

		$origtext = $old->GetText();

		# Is this the most recent version?
		my $all_ids = MusicBrainz::Server::Annotation->GetAnnotationIDsForArtist($artist);
		$not_most_recent = 1 if ($all_ids->[0] != $annotationid);
	}

	$defaulttext = "" if (not defined $defaulttext);
	for ($defaulttext, $annotationtext, $origtext)
	{
		defined() or next;
		$_ = MusicBrainz::Server::Markup->normalise($_);
	}


	my $preview = 0;
	my $no_change = (
		defined($origtext)
			? $origtext eq $annotationtext
			: not $annotationtext =~ /\S/
	);

	if ($submit ne "")
	{
		my $url = "/showartist.html?artistid=$artistid";

		if ($submit =~ m/Cancel/i)
		{
			MusicBrainz::Server::Annotation->ReleaseLock(
				&MusicBrainz::Server::Annotation::ARTIST_ANNOTATION,
				$artist->GetId,
				$sid,
			);
			return $m->comp("/comp/redirect", $url);
		}
		elsif ($submit =~ m/Preview/i)
		{
			 $preview = 1;
		}
		else
		{

			# Update the annotation, but only if the annotation
			# has not been locked by another editor.
			if (defined $annotationtext and
				$locked eq $sid)
			{
				# Indicate that editing is done.
				# Other users might still be editing this page.
				MusicBrainz::Server::Annotation->ReleaseLock(
					&MusicBrainz::Server::Annotation::ARTIST_ANNOTATION,
					$artist->GetId,
					$sid,
				);

				return $m->comp("/comp/redirect", $url)
					if $no_change;

				$m->comp(
					"/comp/entermods",
					DBH => $mb->{DBH},
					sub => sub {
						my @mods = Moderation->InsertModeration(
							DBH	=> $mb->{DBH},
							uid	=> $session{uid},
							privs => $session{privs},
							type => &ModDefs::MOD_ADD_ARTIST_ANNOTATION,
							# --
							artistid => $artist->GetId,
							text => $annotationtext,
							changelog => $changelog
						);

						#$mods[0]->InsertNote($session{'uid'}, $changelog)
							#if $mods[0]
							#and $changelog =~ /\S/;
					},
					success_url => $url,
				) or return;

				die "Shouldn't get here";
			}
		}
	}
</%perl>


<& /comp/sidebar-notitle, pagetitle => "Edit Artist Annotation" &>

% 	if ($preview) {

	<& /comp/tablebegin, title => "Preview Annotation" &>

% 		my $tmp = MusicBrainz::Server::Annotation->newPreview($defaulttext);

		<table class="annotation">
			<tr class="header">

%		if ($no_change) {

				<td>Preview (You have not made any changes!)</td>

% 		} else {

				<td>Preview</td>
%		}

			</tr>
			<tr class="text">
				<td><% $tmp->GetTextAsHTML |n %></td>
			</tr>
		</table>

		<table class="annotation">
			<tr class="header">
				<td>Summary Preview</td>
			</tr>
			<tr class="text">
				<td><% $tmp->GetShortTextAsHTML(qq[(<a href="#">Read&nbsp;more&hellip;</a>)]) |n %></td>
			</tr>
		</table>

% 		if (defined $origtext) {

			<table class="annotation">
				<tr class="header">
					<td>
						Differences
						<& /edit/annotation/diff-legend &></td>
				</tr>
				<tr class="text">
					<td>
						<% MusicBrainz::Server::Markup->diff_as_html($origtext, $defaulttext) |n %></td>
				</tr>
			</table>
%		}

	<& /comp/tableend &>

% 	}


	<form method="post" action="/edit/annotation/artist/edit.html" id="EditAnnotationForm">
		<script type="text/javascript" src="/edit/annotation/wikitoolbar.js"></script>

		<& /comp/tablebegin, title => "Edit Artist Annotation" &>

			<table class="formstyle">
				<tr>
					<td class="instructions">
						<& /edit/annotation/wikiformat &>


%	# if the annotation is locked by someone else, do not allow
%	# editing it for a certain amount of time.
%	my $disabled = "";
%	$disabled = qq!disabled="disabled"! if ($locked and $locked ne $sid);

%	if ($disabled ne "") {

						<div style="border: 1px dotted red; padding: 5px; margin-top: 15px">
							<span style="color:red; font-weight: bold">Warning:</span>
							Someone else is currently editing this annotation!
							Please try again later.
							</span>
						</div>
%	}
%	if ($not_most_recent) {
						<div style="border: 1px dotted red; padding: 5px; margin-top: 15px">
							<span style="color:red; font-weight: bold">Warning:</span>
							You are not editing the most recent annotation for this artist.
							If you submit your changes, the most recent annotation will be
							overwritten!
							</span>
						</div>
%	}
					</td>
				</tr>
			</table>

			<table class="formstyle" style="width: 95%">
				<tr>
					<td>
						<textarea name="annotationtext" rows="15" cols="60"
							style="width: 100%" class="wikitext" <% $disabled %>><% $defaulttext %></textarea></td>
				</tr>
				<tr class="spaced">
					<td>
						Enter a description of your changes (optional):<br/>
						<input name="changelog" type="text" size="60" maxlength="255" <% $disabled %> value="<% $changelog %>" /></td>
				</tr>
				<tr>
					<td>
						<input type="submit" name="submit" value="Cancel" />&nbsp;
						<input type="submit" name="submit" value="Preview" <% $disabled %> />&nbsp;
						<input type="submit" name="submit" value="Enter Changes" <% $disabled %> />

						<input type="hidden" name="annotationid" value="<% $annotationid %>" />
						<input type="hidden" name="artistid" value="<% $artistid %>" /></td>
				</tr>
			</table>
			<& /comp/movefocus, "EditAnnotationForm", "annotationtext" &>

		<& /comp/tableend &>
	</form>

<& /comp/footer &>

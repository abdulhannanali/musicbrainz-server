<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Review the history of all artist annotations of the given artist.
	#
	# $URL$
	# $Id$
	#
</%perl>
<%args>
	$artistid => undef
	$expandids => undef
	$expand_all => undef
	$show_mods => undef
</%args>
<%perl>

	# only logged in users may see this page
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# redirect to moderations listing of this annotation object.
	if ($show_mods)
	{
		my %filter = (
			mod_type => [ &ModDefs::MOD_ADD_ARTIST_ANNOTATION ],
			artist_type => 3, # single artist
			artist_id => $artistid,
			orderby => "desc",
		);

		return $m->comp(
			"/comp/redirect",
			"/mod/search/results.html?" . $m->comp("/comp/args-to-querystring.inc", %filter)
		);
	}

	# redirect to moderations listing of this annotation object.
	MusicBrainz::IsNonNegInteger($artistid) && $artistid
		or return $m->comp("/comp/layout/badarguments", text => "The artistid argument is invalid.");

	# Instantiate MusicBrainz object, and load the artist object
	my $mb = $m->comp("/comp/dblogin");
	my $artist = $m->comp("/comp/loadartist", $mb, $artistid);

	# Load annotations.
	my %expand = map { $_ => 1 } split(' ', $expandids);
	my $annotations = MusicBrainz::Server::Annotation->GetAnnotationIDsForArtist($artist);

	# prepare page, and boxtitle
	my $title = "Artist Annotation History";
	$m->comp("/comp/sidebar-notitle", pagetitle => $title);
	$m->comp("/comp/tablebegin", title => $title);

	# render the annotation subject
	$m->comp("/edit/annotation/subject", title => "Review Annotation History for", artist => $artist);

	# options
	$m->out("<ul>");
	$m->out(sprintf qq!<li><a href="/edit/annotation/artist/history.html?artistid=$artistid%s">%s</a></li>!,
					$expand_all ? "" : "&amp;expand_all=1",
					$expand_all ? "Collapse list" : "Expand list");

	$m->out(qq!<li><a href="/edit/annotation/artist/history.html?artistid=$artistid&amp;show_mods=1">Show moderations</a></li>!);

 	unless (@$annotations)
 	{
		$m->out(qq!<li>No annotations available. <a href="/edit/annotation/artist/edit.html?artistid=$artistid">Add an annotation &raquo;</a></li>!);
 	}
	$m->out("</ul>");
	$m->comp("/comp/tableend");


	# render the list of annotations
	for (my $i=0; $i < @$annotations; $i++)
	{
		my $annotationid = @$annotations[$i];
		my $annotation = MusicBrainz::Server::Annotation->new($mb->{DBH});
		$annotation->SetId($annotationid);
		$annotation->LoadFromId()
			or next;

		# the annotations are sorted top-down, see if there is a previous
		# annotation (e.g. another item in the list) to diff against.
		my $previd = $annotations->[$i + 1];
		$previd = 0 if (not defined $previd);

		$m->comp("/edit/annotation/show",
			annotation => $annotation,
			show_log => 1,
			expand => $expand{$annotationid} || $expand_all,
			show_diff => $previd);

		$m->out("<br />");
	}

	$m->comp("/comp/footer");

</%perl>
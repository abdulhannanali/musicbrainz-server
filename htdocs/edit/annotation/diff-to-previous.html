%# vi: set ts=2 sw=2 ft=mason :
<%args>
$id => undef
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");

MusicBrainz::IsNonNegInteger($id) && $id
	or return $m->comp("/comp/badargs", 1, 1);

my $new = MusicBrainz::Server::Annotation->new($mb->{DBH});
$new->SetId($id);
$new->LoadFromId
	or return $m->comp("/comp/error", "Annotation #$id not found", 1, 1);

my $old = $new->GetPrevious;

my $ref = $m->comp('/edit/annotation/backreference', annotation => $new);
my $ar = $ref->{artist};
my $al = $ref->{album};

</%perl>
<& /comp/sidebar, title => 'Compare Annotations' &>

<p>Comparing annotations for <& /edit/annotation/subject, artist => $ar, album => $al &></p>

% if ($old) {

<p>Old version:</p>
<& /edit/annotation/show,
	annotation => $old,
	history_link => 1,
	expand => 0,
	show_log => 1,
	&>
<p>New version:</p>
<& /edit/annotation/show,
	annotation => $new,
	history_link => 1,
	expand => 0,
	show_log => 1,
	&>

<h2>Differences</h2>
<& diff-legend &>
<table class="Annotation">
	<tr class="AnnotationText">
		<td>
			<% MusicBrainz::Server::Markup->diff_as_html($old->GetText, $new->GetText) |n %>
		</td>
	</tr>
</table>

% } else {

<p>
	Can't show differences; this is the first version.
</p>

<& /edit/annotation/show,
	annotation => $new,
	history_link => 1,
	&>

% }

<& /comp/footer &>

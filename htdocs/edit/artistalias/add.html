%# vi: set ts=2 sw=2 ft=mason :
<%args>
$id => ""
$newartistalias => undef
$notetext => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($id) && $id
	or return $m->comp("/comp/badargs", 1, 1);

$id != &ModDefs::VARTIST_ID && $id != &ModDefs::DARTIST_ID
	or return $m->comp(
		"/comp/error",
		"You cannot add an alias to this artist.",
		1, 1,
	);

my $mb = $m->comp("/comp/dblogin");

my $ar = Artist->new($mb->{DBH});
$ar->SetId($id);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist #$id does not exist",
		1, 1,
	);

my $artistname = $ar->GetName();
my $sortname = $ar->GetSortName();
my $modpending = $ar->GetModPending();

my $url = "/showaliases.html?artistid=$id";

if ($newartistalias =~ /\S/ and MusicBrainz::IsSingleLineString($newartistalias))
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_ADD_ARTISTALIAS,
				# --
				artist => $ar,
				newalias => $newartistalias,
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>
<& /comp/sidebar, title => 'Add Artist Alias' &>

<& /comp/stylemenu &>

% if ($modpending) {
	<& /comp/modpending &>
% }

<form method="post" action="/edit/artistalias/add.html?id=<% $id %>" enctype="application/x-www-form-urlencoded">

	<& /comp/autofixmenu &>
	
	<fieldset class="formstyle">
		<legend>Add Artist Alias</legend>
		<p>
		    You're about to enter a new artist alias for:
		</p>
		<table class="formstyle" cellspacing="0">
			<tr>
				<td class="label"><label>Artist:</label></td>
				<td><a href="/artist/<% $ar->GetMBId %>.html"><% $ar->GetName %></a></td>
			</tr>
			<tr>
				<td class="label"><label for="id_newartistalias">New Alias:</label></td>
				<td>
					<input type="text" name="newartistalias" id="id_newartistalias"
						class="textfield" size="40" maxlength="255"
						value="<% $artistname %>" />
					<& /comp/form/jsbutton, id=>"BTN_ARTIST::newartistalias" &>
				</td>
			</tr>
			<tr>
				<td>&nbsp;</td>
	    			<td class="padtop"><& /comp/notetext &></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td class="padtop"><input type="submit" class="button" value="Submit" /></td>
			</tr>
		</table>
	</fieldset>
</form>

<& /comp/movefocus, id => "id_newartistalias" &>
<& /comp/footer &>

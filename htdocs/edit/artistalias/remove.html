%# vi: set ts=4 sw=4 ft=mason :
<%args>
$alias => ""
$notetext => ""
$btnNo => undef
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($alias) && $alias
	or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $al = Alias->new($mb->{DBH});
$al->SetTable("ArtistAlias");
$al->SetId($alias);

defined($al->LoadFromId)
	or return $m->comp(
		"/comp/error",
		"Alias #$alias does not exist",
		1, 1,
	);

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetRowId);

defined($ar->LoadFromId)
	or return $m->comp(
		"/comp/error",
		"Artist does not exist",
		1, 1,
	);

my $url = "/showaliases.html?artistid=" . $ar->GetId;

if (defined $btnNo)
{
	return $m->comp("/comp/redirect", $url); 
}

if ($ARGS{confirm})
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_REMOVE_ARTISTALIAS,
				# --
				artist => $ar,
				alias => $al,
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title => 'Confirm Artist Alias Removal' &>

<form method="post" action="/edit/artistalias/remove.html">
<fieldset class="formstyle">
	<legend>Confirm Artist Alias Removal</legend>
	
	<p>
		Are you sure you want to remove the alias 
		<strong><% $al->GetName %></strong>
		which points to artist
		<strong><% $ar->GetName %></strong>?
	</p>

	<div class="padlefttop">
		<input type="hidden" name="url" value="<% $url %>" />
		<input type="hidden" name="alias" value="<% $alias %>" />
		<input type="hidden" name="confirm" value="1" />
		<input name="btnNo" id="btnNo" type="submit" class="button" value="&laquo; NO" onclick="history.go(-1); return false" />
		<input name="btnYes" type="submit" class="button" value="YES &raquo;" />
	</div>
	
	<div class="padlefttop">
		<& /comp/notetext &>
	</div>

</fieldset>
</form>

<& /comp/movefocus, id => "btnNo" &>
<& /comp/footer &>

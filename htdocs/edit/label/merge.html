<%perl>
 	# -----------------------------------------------------------------------------
 	#                               Musicbrainz.org
 	#                        Copyright (c) 2001 Robert Kaye
 	# -----------------------------------------------------------------------------
 	#  This software is provided "as is", without warranty of any kind, express or
 	#  implied, including  but not limited  to the warranties of  merchantability,
 	#  fitness for a particular purpose and noninfringement. In no event shall the
 	#  authors or  copyright  holders be  liable for any claim,  damages or  other
 	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
 	#  from,  out of  or in  connection with  the software or  the  use  or  other
 	#  dealings in the software.
 	#
 	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
 	#  Permits anyone the right to use and modify the software without limitations
 	#  as long as proper  credits are given  and the original  and modified source
 	#  code are included. Requires  that the final product, software derivate from
 	#  the original  source or any  software  utilizing a GPL  component, such  as
 	#  this, is also licensed under the GPL license.
 	# -----------------------------------------------------------------------------
 	#
 	# Summary:
 	# -----------------------------------------------------------------------------
 	# Merge an label into another
 	#
 	# $Id$
 	#
</%perl>
<%args>

	$id => ""
	$labelid => undef

	# fields set by /comp/labelfilter
	$labelfilter_newlabelid => ""
	$newlabelid => ""
	$search => ""

	$submitvalue => ""
	$notetext => undef

</%args>
<%perl>

	$labelid ||= $id;

	# handle hidden field for javascript if form was
	# submitted using the radiobutton ondblclick.
	$submitvalue = (ref($submitvalue) eq "ARRAY" ? @$submitvalue[0] : $submitvalue);

	# only logged in users can see this page
	$m->comp("/comp/checkloggedin", 1, 1)
		or return;

	# check labelid argument
	MusicBrainz::Server::Validation::IsNonNegInteger($labelid) && $labelid
		or return $m->comp("/comp/layout/badarguments",
			text => "Argument <strong>labelid</strong> missing or invalid format.");

	# disallow merging special purpose labels
	$labelid != &ModDefs::DLABEL_ID
		or return $m->comp("/comp/layout/badarguments",
			text => "Merging the <strong>DELETED_LABEL</strong> or <strong>VARIOUS_LABELS</strong> is not allowed.");

	# check volatile preferences (like autoeditor flag)
	$m->comp("/comp/user/check-volatile-preferences", %ARGS);

	# Instantiate MusicBrainz object, load label from database
	my $mb = $m->comp("/comp/dblogin");
	my $label = $m->comp("/comp/loadlabel", $mb, $labelid);

	# form step 2/3: load selected label from the database, and
	# fill in the required fields
	my $newlabel = undef;
	$labelfilter_newlabelid ||= $newlabelid;
	if ($labelfilter_newlabelid ne "")
	{
		$newlabel = $m->comp("/comp/loadlabel", $mb, $labelfilter_newlabelid);
		$newlabelid = $newlabel->GetId;
	}

	# form step 3/3: enter edit
	if ($submitvalue ne "")
	{
		# next url after the operation
		my $url = "/label/". $label->GetMBId . ".html";

		# if Cancel was pressed, redirect to calling page.
		if ($submitvalue =~ m/Cancel/i)
		{
			$m->comp("/comp/redirect", $url);
			return;
		}
		elsif ($submitvalue =~ m/Search/i)
		{
			$newlabel = undef;
		}
		elsif (defined $newlabel and
			   defined $notetext)
		{
			$m->comp(
				"/comp/entermods",
				DBH => $mb->{DBH},
				sub => sub {
					my @mods = Moderation->InsertModeration(
						DBH	=> $mb->{DBH},
						uid	=> $session{uid},
						privs => $session{privs},
						type => &ModDefs::MOD_MERGE_LABEL,
						# --
						source => $label,
						target => $newlabel,
					);

					$mods[0]->InsertNote($session{'uid'}, $notetext)
						if $mods[0]
						and $notetext =~ /\S/;
				},
				success_url => $url,
			) or return;

			die "Shouldn't get here";
		}
	}

	# preset a meaningful search value. this triggers
	# comp/labelfilter to perform a search.
	$search = $label->GetName
		unless (defined $search and $search =~ /\S/);

	my $title = "Merge label ${\ $label->GetName } into another label";

</%perl>

<& /comp/sidebar-notitle, pagetitle =>  $title &>
	<& /comp/layout/editformbegin, title => $title, label => $label &>


		<!-- add editsuite for modnote resizer support -->
		<script type="text/javascript" src="/scripts/editsuite.js"></script>

		<form method="post" action="/edit/label/merge.html" id="ConfirmForm">


%	# if an label was selected (or added), show confirm form.
%	if (defined $newlabel)
%	{

			<table class="formstyle">
				<tr>
					<td colspan="2" class="instructions">
						<ul>
							<li>Are you sure you want to merge the label
								<& /comp/linklabel, label => $label &> into the
								label <& /comp/linklabel, label => $newlabel &>?
							</li>
						</ul></td>
				</tr>
				<tr>
					<td>&nbsp;</td>
					<td class="notetext">
						<& /comp/notetext,
							notetext => $notetext, &>

						<& /comp/form/hiddenfield, "newlabelid", $newlabel->GetId &>
						<& /comp/form/focusfield, "btnYes" &>
					</td>
				</tr>
			</table>



%	}
%	else
%	{

		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							This wizard allows you to merge the label <& /comp/linklabel,
							label => $label &> into another label. Please read the
							<& /comp/linkdoc, "StyleGuideline", "style guidelines" &>
							before entering this edit.</li>
						<li>
							Please enter the <& /comp/linkdoc, "LabelName", "label name" &>
							of the label you would like to merge this label into, and
							press <strong>Search</strong> to start the search.</li>
					</ul></td>
			</tr>
		</table>

		<table class="formstyle">
			<& /comp/labelfilter,
				search => $search,
				submitvalue => $submitvalue,
				dontshow => [$labelid],
				allowcreate => 0
			&>
		</table>

%	}

			<div>
				<& /comp/form/hiddenfield, "submitvalue", "Select &raquo;" &>
				<& /comp/form/hiddenfield, "labelid", $label->GetId &>
			</div>
		</form>

	<& /comp/layout/editformend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

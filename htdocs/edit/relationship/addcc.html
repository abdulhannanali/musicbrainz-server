%# vi: set ts=4 sw=4 ft=mason :
<%args>
	$id 		=> ''
	$type       => ''
    $name       => $name
	$url 	    => ''
    $license    => ''

	$submit 	=> ""
    $notetext   => ''
</%args>
<%perl>

my $linktypeid;
#$linktypeid = 'd9ea0f04-5abf-48a6-98ca-13fa4de7b678' if ($type eq 'album');
#$linktypeid = '87c9a8ed-36fc-4e39-8219-c5c63a755d56' if ($type eq 'track');

$linktypeid = 32 if ($type eq 'album'); 
$linktypeid = 21 if ($type eq 'track'); 

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");

if (!$type || !$id || !$name)
{
	</%perl>
    <& /comp/sidebar, title => 'Add a Creative Commons License' &>
    <p>
    To add a <a href="http://creativecommons.org">Creative Commons</a> <a href="http://creativecommons.org/about/licenses/meet-the-licenses">license</a> to an album or a track, first <a href="/search/textsearch.html">find
    the album or track</a> in the database and then click on the <i>add CC license</i> link in the
    album header or on the track detail page.
    </p>

	<br/>

	<& /comp/tablebegin, title => 'search' &>
    <& /comp/lucenesearch &>
	<& /comp/tableend &>

	<& /comp/footer &>
	<%perl>
	return undef;
}

if (!MusicBrainz::Server::LinkEntity->IsValidType($type))
{
    </%perl>
    <& /comp/sidebar, title => 'Error' &>
    <% $type %> is not a valid link type.
    <& /comp/footer &>
    <%perl>
    return undef;
}

# If we're passed an MBID, load the rowid and proceed as usual
if (MusicBrainz::Server::Validation::IsGUID($id))
{
	my $obj = $m->comp("/comp/load" . ($type == "album" ? "release" : $type), $mb, $id);
	$id = $obj->GetId();
}

my $obj = undef;
if (MusicBrainz::Server::Validation::IsNonNegInteger($id))
{
	$obj = MusicBrainz::Server::LinkEntity->newFromTypeAndId(
		$mb->{DBH},
		$type, $id);
}
elsif (MusicBrainz::Server::Validation::IsGUID($id))
{
	$obj = MusicBrainz::Server::LinkEntity->newFromTypeAndMBId(
		$mb->{DBH},
		$type, $id);
}
if (!defined $obj)
{
	</%perl>
	<& /comp/sidebar, title => 'Error' &>
	<% $type %> and id <% $id %> does not specify a valid entity.
	<& /comp/footer &>
	<%perl>
	return undef;
}

	# trim leading and trailing whitespaces
	MusicBrainz::Server::Validation::TrimInPlace($url)
		if defined $url;

my @links;
push @links, {
        type => $type,
        id => $id,
        obj => $obj,
        name => $obj->GetName,
    };
push @links, {
        type => 'url',
        id => undef,
        obj => undef,
        name => $url,
		url => $url,
		desc => "",
    };

my @types = ($type, 'url');

# Sanity check... this should be fine
MusicBrainz::Server::LinkEntity->ValidateTypes(\@types)
	or die;

# split license value
if ($license)
{
	my ($avail_attrs, $desc);
	($license, $avail_attrs, $desc) = split '\|', $license;
}

my $link = MusicBrainz::Server::LinkType->new($mb->{DBH}, \@types);
if ($url
	and $license
	and MusicBrainz::Server::URL->IsLegalURL($url))
{
	my $linktype = $link->newFromId($linktypeid);
	if ($linktype)
	{
		my $success_url = "/showrel.html?id=$id&type=$type";

		$m->comp(
			"/comp/entermods",
			DBH => $mb->{DBH},
			sub => sub {
				my @mods = Moderation->InsertModeration(
					DBH		   => $mb->{DBH},
					uid		   => $session{uid},
					privs	   => $session{privs},
					type	   => &ModDefs::MOD_ADD_LINK,
					# --
					entities   => \@links,
					linktype   => $linktype,
					url        => $url,
					attributes => [ { name=>'license', value=>$license } ]
				);

				$mods[0]->InsertNote($session{'uid'}, $notetext)
					if $mods[0]
					and $notetext =~ /\S/;
			},
			success_url => $success_url,
		) or return;

		die "Shouldn't get here";
	}
}
#my $root = $link->Root;

# Load the top level link attributes
my $attrType = MusicBrainz::Server::LinkAttr->new($mb->{DBH});
my $root = $attrType->Root;
my @children = $root->Children;
my @cclics;

foreach my $node (@children)
{
    if ($node->GetName =~ /license/)
    {
         my @lics = $node->Children;
         foreach my $child (@lics)
         {
             if ($child->GetName =~ /Creative Commons/)
             {
                 @cclics = $child->Children;
                 last;
             }
         }
         last;
    }
}

</%perl>
<& /comp/sidebar, title => 'Add a Creative Commons License' &>

<p>
	Select a <a href="http://creativecommons.org">Creative Commons</a> <a href="http://creativecommons.org/about/licenses/meet-the-licenses">license</a>
	and enter the URL where this <% $type %> can be downloaded. If possible, please link directly to a media file
	(e.g. mp3).
	Please note that the URL must be a valid
	URL, including the http:// or ftp:// protocol portion of the URL.
</p>
<br/>

<p>
    Please include a URL in the edit node that shows where this
    <% $type %> has been licensed under a CC license. If you do not include a URL
    to show this, your license link edit may not be approved by other moderators.
</p>

<form id="LinkSelectForm" method="post" action="/edit/relationship/addcc.html">
    <script type="text/javascript" src="/scripts/ar-frontend.js"></script>
	<fieldset>
		<legend>Add CC license to <% ucfirst($type) %></legend>

		<table>
			<tr>
				<td width="150"><label><% ucfirst($type) %>: </label></td>
				<td><b><% $name %></b></td>
			</tr>
			<tr>
				<td></td>
				<td><select name="license">
						<option value="">[select a license]</option>
%                       foreach my $node (@cclics) {
						    <option value="<% $node->GetId %>||<% $node->GetDescription %>"<% ($node->GetId == $license) ? ' SELECTED' : '' %>><% $node->GetName %></option>
%                       }
					</select>
% 					if ($submit && !$license) {
         			<div class="linkerror">Please select a license type from the list</div>
% 					}
					</td>
			</tr>
			<tr>
				<td><label>Url: </label></td>
				<td>
					<input type="text" name="url" size="40" value="<% $url or 'http://' %>"> (<b>required</b>)
%					if ($submit && (!defined $url || !MusicBrainz::Server::URL->IsLegalURL($url))) {
         			<div class="linkerror">Please enter a valid URL</div>
%					}
				</td>
			</tr>
		</table>

		<table>
			<tr valign="top">
				<td valign="top" width="150"><label>Description:</label></td>
				<td><div id="relationshipTypeDesc" class="relationshipTypeDesc">Please select a license.</span></td>
			</tr>
		</table>

		<div class="padlefttop">
		</div>

		<div class="padleft">
			<p/>
			<& /comp/notetext, notetext => $notetext &>

			<p>Adding a license URL as part of the edit note is <b>strongly encouraged</b>.</p>
		</div>

		<div class="padlefttop">
			<!-- internal fields which drive how the javascript function
				 interacts with the form elements -->
			<input type="hidden" name="int_isurlform" value="1">
			<input type="hidden" name="int_typedropdown" value="license">
			<input type="hidden" name="int_formsubmitted" value="<% $submit %>">

			<input type="hidden" name="id" value="<% $id %>">
			<input type="hidden" name="type" value="<% $type %>">
			<input type="hidden" name="name" value="<% $name %>">
			<input type="hidden" name="submit" value="1">
		</div>
	</fieldset>
</form>

<& /comp/footer &>

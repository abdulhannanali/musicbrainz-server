%# vi: set ts=4 sw=4 ft=mason :
<%args>
$type => ""
$id => ""
$confirm=>0
$notetext=>""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my @types = sort split '-', $type;

my $mb = $m->comp("/comp/dblogin");
my $link = MusicBrainz::Server::Link->new($mb->{DBH}, \@types);
if (!$link)
{
	</%perl>
    <& /comp/sidebar, title => 'Remove Link: error' &>
	<p>
	This page was passed invalid arguments. The type and id arguments need to be passed to this page.
	</p>
    <& /comp/footer &>
	<%perl>
	return;
}

my $node = $link->newFromId($id);
if (!$node)
{
	</%perl>
    <& /comp/sidebar, title => 'Remove Link: error' &>
	<p>
	The link you selected for removal no longer exists.
	</p>
    <& /comp/footer &>
	<%perl>
	return;
}

my @ents = $node->Entities();

if ($confirm)
{
	my $r = $m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_REMOVE_LINK,
				# --
				link => $node,
				types=> \@types,
			);

            $mods[0]->InsertNote($session{'uid'}, $notetext)
                if $mods[0] and $notetext =~ /\S/;
		},
	) or return;
	
	$m->comp(
		"/comp/redirect",
		"/showrel.html?id=".$ents[0]->GetId ."&type=". $types[0]
	);
	return;
}

</%perl>
<& /comp/sidebar, title => 'Remove Link' &>

<fieldset>
	<legend>Confirm Link Removal</legend>
	<div class="padleft">
		Are you sure you want to remove the <% ucfirst($type) %> link from 
		<a href="/show<% $types[0] %>.html?<% $types[0] %>id=<% $ents[0]->GetId %>"><% $ents[0]->GetName() %></a>
		to
		<a href="/show<% $types[1] %>.html?<% $types[1] %>id=<% $ents[1]->GetId %>"><% $ents[1]->GetName() %></a>?
	</div>
	<div class="padlefttop">
		<table>
			<tr>
				<td>
					<form 	method="GET" action="/show<% $types[0] %>.html"
							name="ModFormNo" 
							onsubmit="history.go(-1); return false">
						<input type="hidden" name="<% $types[0] %>id" value="<% $ents[0]->GetId %>">
						<input name="btnNo" type="submit" class="button" value="&laquo; NO">
					</form></td>
				<td> &nbsp; </td>
				<td>
					<form 	method="POST" action="/edit/relationship/remove.html"
							name="ModFormYes">
						<input type="hidden" name="type" value="<% $type %>">
						<input type="hidden" name="id" value="<% $id %>">
						<input type="hidden" name="confirm" value="1">
						<input name="btnYes" type="submit" class="button" value="YES &raquo;">
					</td>
			</tr>
		</table>
	</div>
	<div class="padlefttop">
		<& /comp/notetext &>
	</div>
	</form>
</fieldset>

<& /comp/movefocus, "ModFormYes", "btnYes" &>
<& /comp/footer &>

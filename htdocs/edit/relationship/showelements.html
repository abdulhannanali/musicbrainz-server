%# vi: set ts=4 sw=4 ft=mason :
<%args>
$type => ""
$id => ""
$name => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $recent_links = ($session{recent_links} ||= []);

if (
	MusicBrainz::Server::LinkEntity->IsValidType($type)
	and MusicBrainz::IsNonNegInteger($id)
	and $id
	and $name =~ /\S/
) {
	# Put ($type, $id) at top of recently related elements
	@$recent_links = grep {
		$_->[0] != $type or $_->[1] != $id
	} @$recent_links;
	unshift @$recent_links, [ $type, $id, $name ];
	splice(@$recent_links, 25) if @$recent_links > 25;

	# Force session save
	$session{recent_links} = $recent_links;
}

</%perl>
<& /comp/sidebar, title => 'Your selected elements' &>

% if (UserStuff->IsLinkModerator($session{privs}) or @$recent_links == 1) {
<div class="LinksRow"> [
%	if (UserStuff->IsLinkModerator($session{privs})) {
	    <a href="/edit/relationships/link_type_roots.html">Edit relationship types</a> 
%    }
%	if (UserStuff->IsLinkModerator($session{privs}) and @$recent_links == 1) {
	     |
%    }
%    if (@$recent_links == 1) {
	    <a href="/edit/relationship/addurl.html?id=<% $recent_links->[0][1] %>&type=<% $recent_links->[0][0] 
			   %>&name=<% $recent_links->[0][2] %>">Relate to URL</a> 
%    }
] </div>
% }

% if (@$recent_links < 2) {
	<p>
    You have no/too few elements (artist, album, track) selected. Go to an artist, album or track
	page and click on the <i>Add Relationship</i> link on that page to select an element.
	</p>
	<br/>
	<p align="center">
    <& /comp/tablebegin, title=>'Search', attrs=>"align=left", attrs=>'width="300"' &>
		<br/>
		<& /comp/lucenesearch, type=>'artist' &>
		<br/>
		&nbsp;
    <& /comp/tableend &>
	</p>
    <& /comp/footer &>
%   return undef;
% }

<p>
	To create a new relationship, select the two elements you want to 
	relate to each other (one in the left column and one in the right),
	then click "Next".
</p>

<form method="post" action="/edit/relationship/add.html">

	<table>
    	<col width="1em" valign="top">
		<col width="1em" valign="top">
		<col valign="top">
%		for (@$recent_links) {
		<tr>
			<td><input type="radio" name="link0" value="<% $_->[0] %>=<% $_->[1] %>"></td>
			<td><input type="radio" name="link1" value="<% $_->[0] %>=<% $_->[1] %>"></td>
			<td><% $_->[0] %> <a href="<%
				MusicBrainz::Server::LinkEntity->URLFromTypeAndId($_->[0], $_->[1])
			%>"><% $_->[2] %></a></td>
		</tr>
%		}
	</table>

	<p>
		<input type="submit" value="Next &gt;&gt;">
	</p>

</form>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$id => ""
$attrname => ""
$linkphrase => ""
$rlinkphrase => ""
$desc => ""
$parent => ""
$childorder => 0
$submit=>0
</%args>
<%perl>

MusicBrainz::Server::Validation::TrimInPlace($attrname);

$m->comp("/comp/checkloggedin", 1, 1)
	or return;
$m->comp("/comp/ar/CheckLinkModerator", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");
my $link = MusicBrainz::Server::LinkAttr->new($mb->{DBH})
	or return $m->comp("/comp/redirect", "/edit/relationships/link_type_roots.html");

my $node = $link->newFromMBId($id)
	or $m->comp(
		"/comp/redirect",
		"/edit/relationships/link_attrs.html"
	);

if ($attrname =~ /\S/ && $desc =~ /\S/)
{
	my $parent_node = $link->newFromMBId($parent)
		or $m->comp(
			"/comp/redirect",
			"/edit/relationships/link_attrs.html"
		);
 
	my $r = $m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_EDIT_LINK_ATTR,
				# --
				parent      => $parent_node,
				node        => $node,
				name        => $attrname,
				description => $desc,
				childorder	=> $childorder,
			);
		},
	) or return;
	
	my $newid;
	$newid = $r->[0]->GetRowId if @$r;

	$m->comp(
		"/comp/redirect",
		"/edit/relationships/link_attrs.html?new=$newid",
	);
}

my @p = $node->PathFromRoot;

my $linkattrs_root = MusicBrainz::Server::LinkAttr->new($mb->{DBH});
$linkattrs_root = $linkattrs_root->Root
	or die;

my $new = undef; 

</%perl>

<%def .ShowList>
% my ($level, $id, $parent, $node) = @_;
% my @children = $node->Children;
% if ($node->GetMBId ne $id) {
	<option value="<% $node->GetMBId %>"
		<% $node->GetMBId eq $parent ? "selected" : "" %>
		>
		<% "&nbsp;" x (4 * $level) | n %>
		<% $node->GetName %></option>
%		$m->comp(".ShowList", $level + 1, $id, $parent, $_)
%			for @children;
	</option>
% }
</%def> 

<& /comp/sidebar, title => 'Edit Attribute Type' &>

% if ($submit) {
%      if (!$attrname) {
         <p style="color: red;">Error: You must provide a link name.</p>
%      }
%      if (!$desc) {
         <p style="color: red;">Error: You must provide a description.</p>
%      }
% } else {
%      $attrname = $node->GetName;
%      MusicBrainz::Server::Validation::TrimInPlace($attrname);
%      $desc = $node->GetDescription;
%      $parent = $node->Parent->GetMBId;
%      $childorder = $node->GetChildOrder;
% }

% if ($attrname eq 'ROOT') {
	This link type cannot be edited.
    <& /comp/footer &>
%   return undef;
% }


<table>
<tr>
  <td>Parent path:</td><td> <% join " / ", map { encode_entities($_->GetName) } @p %></td>
</tr>
</table>
</p>

<form method="post" action="edit_link_attr.html" name="EditAttrTypeForm">
    <p>
       Enter the name of this link attribute:
    </p>
	<table>
	<tr>
		<td>Parent:</td>
		<td><select name="parent"><& .ShowList, 0, $id, $parent, $linkattrs_root &></select></td>
	</tr> 
	<tr>
	   <td>Child order:</td>
	   <td>
		<input type="text" name="childorder"
			maxlength="2" size="2"
			value="<% $childorder %>"
			>
	   </td>
    </tr>
	<tr>
	   <td>Name:</td>
	   <td>
		<input type="text" name="attrname"
			maxlength="255" size="40"
			value="<% $attrname %>"
			>
	   </td>
     </tr>
    </tr>
        <td valign="top">Description:</td>
        <td><textarea name="desc" rows="3" cols="40"><% $desc %></textarea></td>
    </tr>
	 <tr>
	   <td>&nbsp;</td>
	   <td>
	    <br/>
		<input type="hidden" name="id" value="<% $id %>">
		<input type="hidden" name="submit" value="1">
		<input type="submit">
		</td>
	  </tr>
	</table>
</form>

<p>
	<a href="/edit/relationships/link_attrs.html">Back</a>
</p>

<& /comp/movefocus, "EditAttrTypeForm", "attrname" &>
<& /comp/footer &>

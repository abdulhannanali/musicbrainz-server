%# vi: set ts=2 sw=2 ft=mason :
<%args>
$album => undef
$trackname => ""
$tracknum => ""
$search => ""
$selectedartist => ""
$newartistname => ""
$newartistsortname => ""
$notetext => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($album) && $album
	or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
$al->SetId($album);
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album #$album does not exist",
		1, 1,
	);

$m->comp("/comp/redirect", "/edit/track/addnonalbum.html?artist=" . $al->GetArtist)
	if $al->IsNonAlbumTracks;

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist does not exist",
		1, 1,
	);

my $url = "/showalbum.html?albumid=$album";

if ($selectedartist)
{
	my $selar = Artist->new($mb->{DBH});
	$selar->SetId($selectedartist);
	$selar->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Artist does not exist",
			1, 1,
		);
	$newartistname = $selar->GetName;
	$newartistsortname = $selar->GetSortName;
}

if ($ar->GetId != &ModDefs::VARTIST_ID)
{
	$newartistname = $ar->GetName;
	$newartistsortname = $ar->GetSortName;
}

if ($newartistname =~ /\S/ and $newartistsortname =~ /\S/
	and $trackname =~ /\S/ and $tracknum =~ /\S/
)
{
	MusicBrainz::IsNonNegInteger($tracknum) && $tracknum >= 1 && $tracknum <= 99
		or return $m->comp("/comp/badargs", 1, 1);

	$al->CanAddTrack($tracknum)
		or return $m->comp("/comp/error", "$@", 1, 1); # take safe copy of $@

	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_ADD_TRACK_KV,
				# --
				album => $al,
				trackname => $trackname,
				tracknum => $tracknum,
				artistname => $newartistname,
				artistsortname => $newartistsortname,
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title => 'Add Track' &>

<& /comp/stylemenu &>

% unless ($search =~ /\S/) {

<form method="post" action="/edit/track/add.html"
	name="AddTrackForm">

	<& /comp/autofixmenu &>

	<fieldset>
		<legend>Add Track</legend>

		<table>
			<tr>
				<td nowrap><label>Album:</label></td>
				<td rowspan="100"> &nbsp; </td>
				<td colspan="3"><a href="/showalbum.html?albumid=<% $album %>"><% $al->GetName %></a></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td><b>#:</b></td>
				<td colspan="3"><b>Name:</b></td>
			</tr>

			<tr>
				<td nowrap>
					<label for="edittrack_trackname">New Track Name:</label></td>	
				<td>
					<input 	type="text" name="tracknum" class="numberfield" 
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="2" value=""></td>
				<td>
					<input 	type="text" name="trackname" class="textfield"
							id="edittrack_trackname"
						 	onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						 	size="41" maxlength="255"
						 	value=""></td>
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_TRACK, 'trackname');
					-->
					</script></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td colspan="3"><small>Valid Track Numbers: 1-99</small></td>
			</tr>

% if ($ar->GetId == &ModDefs::VARTIST_ID) {

			<tr>
				<td nowrap>
					<label for="edittrack_search">Search for Artist:</label></td>
				<td colspan="2">
					<input  type="text" name="search" class="textfield"
							id="edittrack_search"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="50"></td>
				<td>
					<script type="text/javascript">
					<!--
						af_writeButton(AF_BTN_ARTIST, 'search');
					-->
					</script></td>
			</tr>
% }

			<tr>
				<td>&nbsp;</td>
				<td class="padtop" colspan="3">
					<& /comp/notetext &></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td class="padtop" colspan="3">
					<input type="hidden" name="album" value="<% $album %>">
					<input type="submit" class="button" value="Submit">
				</td>
			</tr>
		</table>
	</fieldset>
</form>

<& /comp/movefocus, "AddTrackForm", "trackname" &>

% } else {

	<fieldset>
		<legend>Select Artist for Add Track Moderation (VA)</legend>
		<div class="padleft">
			You have selected to add track
			#<% $tracknum %> '<% $trackname %>'
			to album <a href="/showalbum.html?albumid=<% $album %>"><% $al->GetName %></a>.&nbsp;
			Please search for this track's artist.
		</div>
	</fieldset>

	<& /comp/artistfilter,
		search => $ARGS{'search'},
		allowcreate => 1,
		url => "/edit/track/add.html",
		arglist => {
			album => $album,
			trackname => $trackname,
			tracknum => $tracknum,
		},
		&>
% }

<& /comp/footer &>

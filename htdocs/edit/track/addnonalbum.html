%# vi: set ts=2 sw=2 ft=mason :
<%args>
$artistid => undef
$numtracks => 1
@trackname => ()
$confirm => 0
$notetext => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($numtracks)
	&& $numtracks >= 1
	&& $numtracks <= 100
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($artistid) && $artistid
	or return $m->comp("/comp/badargs", 1, 1);

$artistid == &ModDefs::VARTIST_ID
	and return $m->comp("/comp/badargs", 1, 1);
$artistid == &ModDefs::DARTIST_ID
	and return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $artist = Artist->new($mb->{DBH});
$artist->SetId($artistid);
$artist->LoadFromId()
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);

if (@trackname == 0)
{
	for (my $i = 1; ; ++$i)
	{
		defined(my $n = $ARGS{"trackname$i"})
			or last;
		push @trackname, $n;
	}
}

my @names = grep /\S/, @trackname;
$numtracks = @names if $numtracks < @names;

if (@names and $confirm)
{

	unless ($notetext =~ /\S/)
  {
      </%perl>
      <& /comp/sidebar, title => "Add Non-Album Tracks - Error" &>

			<p class="error">
				You must provide a moderation note in order to add a non-album
				track!&nbsp; Please go back and enter a moderation note.
			</p>

      <& /comp/footer &>
      <%perl>

      return;
  }

	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			for my $name (@names)
			{
				my @mods = Moderation->InsertModeration(
					DBH	=> $mb->{DBH},
					uid	=> $session{uid},
					privs => $session{privs},
					type => &ModDefs::MOD_ADD_TRACK_KV,
					# --
					artist => $artist,
					trackname => $name,
				);

				$mods[0]->InsertNote($session{'uid'}, $notetext)
					if $mods[0]
					and $notetext =~ /\S/;
			}
		},
	) or return;

	my $al = Album->new($mb->{DBH});

	if (my @non = $al->FindNonAlbum($artistid))
	{
		$m->comp("/comp/redirect", "/showalbum.html?albumid=" . $non[0]->GetId);
	} else {
		$m->comp("/comp/redirect", "/showartist.html?artistid=$artistid");
	}

	die "Shouldn't get here";
}

for (@names[0..$numtracks-1])
{
	$_ = "" unless defined;
}

</%perl>

<& /comp/sidebar, title => "Add Non-Album Tracks" &>

<p>
	Please enter the name(s) of the track(s) you wish to
	add as non-album tracks of
	<b><% $artist->GetName %></b>.&nbsp;
	Just leave a track name blank if you don't want to
	add it.
</p>

<p>
   <span style="color: red;">Important!</span> Non-album tracks are designed for
   <b>tracks that have not been released on ANY album</b>. Demo tracks and
   promotional tracks that have never been released on an album are good
   candidates for non-album tracks. Most live versions or singles are released
   on <i>single CDs</i> -- to enter those tracks into MusicBrainz, <a
   href="/freedb/freedb.html?search=<% uri_escape($artist->GetName()) %>">import
	 the album from FreeDB</a> instead.
</p>

<p>
	To enter a non-album track you <b>must</b> provide a moderation note that
	lets the voters know why you think this is a non-album track. You're
	strongly encouraged to include a URL that will allow the voters to 
	evaluate the correctness of this moderation.
</p>



<& /comp/stylemenu &>

<form 	method="post" action="/edit/track/addnonalbum.html"
		name="AddAlbumTracks">

	<& /comp/autofixmenu &>

	<fieldset>
		<legend>Add Non-Album Tracks</legend>
		<table>
			<tr>
				<td>
					<label>Artist:</label></td>
				<td colspan="2">
					<a href="/showartist.html?artistid=<% $artistid %>"><% $artist->GetName() %></a></td>
			</tr>
% for (1 .. $numtracks) {
		<tr>
			<td>
				<label for="addnat_trackname<% $_ %>">Track Name:</label></td>
			<td>
				<input type="text" name="trackname<% $_ %>" class="textfield"
					id="addnat_trackname"
					onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
					size="50"
					value="<% $names[$_-1] %>">
			</td>
			<td><script type="text/javascript">
				<!--
					af_writeButton(AF_BTN_TRACK, 'trackname<% $_ %>');
				-->
				</script></td>
		</tr>

% }
		<tr>
			<td>&nbsp;</td>
			<td>
% my $nextnum = 5 * int( ($numtracks + 5) / 5);
				<a href="/edit/track/addnonalbum.html?artistid=<% $artistid %>&amp;numtracks=<% $nextnum %>">Add more fields to this form</a>
			</td>
			<td>
% if ($numtracks != 1) {
				<script type="text/javascript">
					<!--
						function doGuessAll(theForm) {
%	for (1 .. $numtracks) {
							doTrackName(theForm, 'trackname<% $_ %>');
%   }
						}
						af_writeButton(AF_BTN_ALL, AF_BTNTEXT_NONALBUMTRACKS);
					-->
				</script>
% }
			</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td class="padtop" colspan="2">
				<& /comp/notetext, required => 1 &></td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td class="padtop" colspan="2">
				<input type="hidden" name="artistid" value="<% $artistid %>">
				<input type="hidden" name="confirm" value="1">
				<input type="submit" class="button" value="Submit"></td>
		</tr>
	</table>
</form>

<& /comp/movefocus, "AddAlbumTracks", "trackname1" &>
<& /comp/footer &>

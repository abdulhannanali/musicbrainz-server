%# vi: set ts=4 sw=4 ft=mason :
<%args>
$TRMjoin => ""
$trackid => ""
$trmid => ""
$notetext => ""
</%args>
<%perl>

MusicBrainz::IsSingleLineString($trmid)
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($trackid) && $trackid
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($TRMjoin) && $TRMjoin
	or return $m->comp("/comp/badargs", 1, 1);

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");

my $tr = Track->new($mb->{DBH});
$tr->SetId($trackid);

$tr->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Track #$trackid not found",
		1, 1,
	);

my $url = "/showtrack.html?trackid=$trackid";

if ($ARGS{confirm})
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_REMOVE_TRMID,
				# --
				track => $tr,
				trm => $trmid,
				trmjoinid => $TRMjoin,
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title => 'Confirm TRM ID Removal' &>

<fieldset>
	<legend>Confirm TRM ID Removal</legend>
	<div class="padleft">
		Are you sure you want to remove TRM ID <% $trmid %>
		from track
		<span class="bold"><% $tr->GetName %></span>?
	</div>
	<div class="padlefttop">
		<table>
			<tr>
				<td>
					<form 	method="GET" action="<% $url %>"
							name="ModFormNo" 
							onsubmit="history.go(-1); return false">
						<input name="btnNo" type="submit" class="button" value="&laquo; NO">
					</form></td>
				<td> &nbsp; </td>
				<td>
					<form 	method="POST" action="/edit/trm/remove.html"
							name="ModFormYes">
						<input type="hidden" name="trackid" value="<% $trackid %>">
						<input type="hidden" name="trmid" value="<% $trmid %>">
						<input type="hidden" name="TRMjoin" value="<% $TRMjoin %>">
						<input type="hidden" name="confirm" value="1">
						<input name="btnYes" type="submit" class="button" value="YES &raquo;">
					</td>
			</tr>
		</table>
	</div>
	<div class="padlefttop">
		<& /comp/notetext &>
	</div>
	</form>
</fieldset>

<& /comp/movefocus, "ModFormYes", "btnYes" &>
<& /comp/footer &>

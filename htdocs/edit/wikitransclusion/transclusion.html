%# vi: set ts=2 sw=2 ft=mason :
<%args>
$action=>''
$page=>''
$revision=>''
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

</%perl>
<& /comp/sidebar, title => 'Wiki Transclusions' &>

% if (!UserStuff->IsWikiTranscluder($session{privs})) {
    <p><span style="color: red;">Error:</span> You must be a wiki transclusion editor to use this page.</p>
    <& /comp/footer &>
%   return undef;
% }

<%perl>


my $wt = MusicBrainz::Server::WikiTransclusion->new();
my $pages = $wt->GetPageIndex();
my $mb = $m->comp("/comp/dblogin");
if ($action eq 'remove')
{
   $m->out('<p class="notice">');
   if (!$page)
   {
       $m->out("Error: To remove a transclusion page, you must provide the page.\n\n");
   }
   else
   {
       my $prevrev = $pages->{$page};
       $wt->SetPage($page);
       if ($wt->Delete())
       {
           $m->out("Page $page has been deleted from the transclusion list and the cache.");
           $m->comp( "/comp/entermods",
                    DBH => $mb->{DBH},
                    sub => sub {
                       my @mods = Moderation->InsertModeration(
                       DBH	=> $mb->{DBH},
                       uid	=> $session{uid},
                       privs => $session{privs},
                       type => &ModDefs::MOD_CHANGE_WIKIDOC,
                       # --
                       page => $page,
                       rev => "",
                       prevrev => $prevrev
                       )
                    });
       }
       else
       {
           $m->out("Could not delete page $page -- please try again in a moment.");
       }
   }
   $m->out('</p>');
}

if ($action eq 'update')
{
   $m->out('<p class="notice">');
   if (!$page || !$revision)
   {
       $m->out("Error: To edit a transclusion page, you must provide the page and the revision.\n\n");
   }
   else
   {
       my $prevrev = $pages->{$page};
       $wt->SetPage($page);
       $wt->SetRevision($revision);
       if ($wt->Update())
       {
           $m->out("Page $page has been set to revision $revision and the index has been reloaded.");
           $m->comp( "/comp/entermods",
                    DBH => $mb->{DBH},
                    sub => sub {
                       my @mods = Moderation->InsertModeration(
                       DBH	=> $mb->{DBH},
                       uid	=> $session{uid},
                       privs => $session{privs},
                       type => &ModDefs::MOD_CHANGE_WIKIDOC,
                       # --
                       page => $page,
                       rev => $revision,
                       prevrev => $prevrev,
                       )
                    });
       }
       else
       {
           $m->out("Could not update page $page -- please try again in a moment.");
       }
   }
   $m->out('</p>');
}

$m->out("<p>Current transcluded wiki pages:</p>");
$m->out("<table><tr><td><b>Page</b></td><td><b>Wiki Page</b></td>");
$m->out("<td><b>Revision</b></td><td><b>Action</b></td></tr>");

# Re-fetch the index, just in case
$pages = $wt->GetPageIndex();
foreach my $page (sort keys %$pages)
{
   </%perl>
   <tr>
     <td><img src="/images/icon/extlink.gif"><a href="/doc/<% $page %>"><% $page %></a>&nbsp;</td>
     <td><a href="http://wiki.musicbrainz.org/<% $page %>"><% $page %></a>&nbsp;</td>
     <td align="center">
     <form method="post" action="/edit/wikitransclusion/transclusion.html"
               enctype="application/x-www-form-urlencoded" class="formstyle">
        <input type="text" name="revision" size="3" value="<% $pages->{$page} %>">
     </td><td>
        <input type="hidden" name="page" value="<% $page %>">
        <input type="hidden" name="action" value="update">
        <input type="submit" name="submit" value="Edit">
     </form>
     </td><td>
     <form method="post" action="/edit/wikitransclusion/transclusion.html"
               enctype="application/x-www-form-urlencoded" class="formstyle">
        <input type="hidden" name="page" value="<% $page %>">
        <input type="hidden" name="action" value="remove">
        <input type="submit" name="submit" value="Remove">
     </form>
     </td>
   </tr>
   <%perl>
}
$m->out("</table>");
</%perl>
<p>Note: If you want to clear the cached copy of a page, simply hit the Edit button without changing the revision.
</p>

<hr>
<p>
Enter the name and the revision of the wiki page to transclude:
</p>

<form method="post" action="/edit/wikitransclusion/transclusion.html"
      enctype="application/x-www-form-urlencoded" class="formstyle">
  <p>
  Page: <input type="text" name="page" size="20">
  Rev: <input type="text" name="revision" size="3">
  <input type="hidden" name="action" value="update">
  <input type="submit" name="submit" value="Add">
  </p>
</form>

<& /comp/footer &>

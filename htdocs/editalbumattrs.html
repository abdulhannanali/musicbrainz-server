<& /comp/sidebar, title=>'Edit Album Attributes', expand=>'moderate' &>

<%perl>

my ($mb, $id, $modpending, $al, $artist, $attr, 
    @attrs, $prev, $index, $url, $s); 

if (!exists $session{tagged_albums} &&
    !exists $ARGS{id} || $ARGS{id} eq '' ||
    !exists $ARGS{artist} || $ARGS{artist} eq '')
{
    mc_comp("/comp/badargs");
    return undef;
}

$mb = mc_comp("/comp/dblogin");
$al = Album->new($mb->{DBH});
$artist = $ARGS{artist};

if (exists $ARGS{"key0"})
{
    $prev = "";
    $modpending = 0;
    $s = 's';
}
else
{
    $s = '';
    $id = $ARGS{id};
    $url = $r->headers_in->{'Referer'};
    $url = "/showalbum.html?albumid=$id" if (not defined $url || $url eq '');

    $al->SetId($id);
    $al->LoadFromId();

    $prev = "";
    @attrs = sort { $a <=> $b} $al->GetAttributes();
    $prev = join ',', @attrs;

    $modpending = $al->GetAttributeModPending();
}

if (scalar(@attrs) == 0)
{
    @attrs = (Album::ALBUM_ATTR_ALBUM, Album::ALBUM_ATTR_OFFICIAL);
}

</%perl>

% if (!defined $session{user} || $session{user} eq '') {
    You must be logged in to edit the database.<p>
    <& /comp/tablebegin, title=>'Login' &>
    <& /comp/loginbox &>
    <& /comp/tableend &>
% } else {

% if ($modpending) {
    <& /comp/modpending &>
% } 

    <FORM METHOD="POST" ACTION="/bare/enter_kv_mod.html" 
          id="EditAlbumAttrsForm"
          ENCTYPE="application/x-www-form-urlencoded">  
    <input type="hidden" name="key0" value="AttrType">
    <input type="hidden" name="key1" value="AttrStatus">

% if (exists $ARGS{"key0"}) {

    <& /comp/albumattrform, mb=>$mb, albumname=>"", attrs=>\@attrs, 
                            field1=>"value0", field2=>"value1" &>

    <%perl>
    my ($i, $urlid);
    for($i = 0;; $i++)
    {
       if (exists $ARGS{"key$i"})
       {
           $urlid = $ARGS{"value$i"} if ($ARGS{"key$i"} eq "AlbumId0");
           </%perl>
           <input type="hidden" name="key<% $i + 2 %>" 
                  value="<% $ARGS{"key$i"} %>">
           <input type="hidden" name="value<% $i + 2 %>" 
                  value="<% $ARGS{"value$i"} %>">
           <%perl>
       }
       else
       {
           last;
       }
    }
    if ($artist == ModDefs::VARTIST_ID)
    {
        $url = "/showalbum.html?albumid=$urlid";
    }
    else
    {
        $url = "/showartist.html?artistid=$artist";
    }
    </%perl>

    <input type="hidden" name="id" value="0">
    <input type="hidden" name="prev" value="">
% } else {
    <& /comp/albumattrform, mb=>$mb, albumname=>$al->GetName(), attrs=>\@attrs, 
                            field1=>"value0", field2=>"value1" &>
    <input type="hidden" name="key2" value="AlbumId0">
    <input type="hidden" name="value2" value="<% $id %>">
    <input type="hidden" name="key3" value="AlbumName0">
    <input type="hidden" name="value3" value="<% $al->GetName() %>">
    <input type="hidden" name="id" value="<% $id %>">
    <input type="hidden" name="prev" value="<% $prev %>">
% }
    <input type="hidden" name="artist" value="<% $artist %>">
    <input type="hidden" name="type" 
           value="<% ModDefs::MOD_EDIT_ALBUMATTRS %>">
    <input type="hidden" name="table" value="Album">
    <input type="hidden" name="column" value="Attributes">
    <input type="hidden" name="url" value="<% $url %>">
    </form>
      
% }
% $mb->Logout();
<& /comp/footer &>

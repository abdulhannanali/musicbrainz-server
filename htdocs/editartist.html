%# vi: set ts=2 sw=2 ft=mason :
<%args>
$id => ""
$newname => ""
$newsortname => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($id) && $id
	or return $m->comp("/comp/badargs", 1, 1);

$id == ModDefs::DARTIST_ID
	and return $m->comp("/comp/badargs", 1, 1);

$id == ModDefs::VARTIST_ID
	and return $m->comp(
		"/comp/error",
    	"You cannot edit this artist.",
		1, 1,
	);

my $mb = $m->comp("/comp/dblogin");

my $ar = Artist->new($mb->{DBH});
$ar->SetId($id);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);

my $url = "/showartist.html?artistid=$id";

if (MusicBrainz::IsSingleLineString($newname)
	and $newname =~ /\S/
	and MusicBrainz::IsSingleLineString($newsortname)
	and $newsortname =~ /\S/)
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => ModDefs::MOD_EDIT_ARTISTNAME,
				# --
				artist => $ar,
				newname => $newname,
			) if $newname ne $ar->GetName;

			# If the above mod became a "merge", don't enter the "edit sortname"
			# mod.
			return if grep { $_->Type == &ModDefs::MOD_MERGE_ARTIST } @mods;

			my @mods2 = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => ModDefs::MOD_EDIT_ARTISTSORTNAME,
				# --
				artist => $ar,
				newname => $newsortname,
			) if $newsortname ne $ar->GetSortName;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title => 'Edit Artist Name' &>

<& /comp/stylemenu &>

<h2>Edit Artist Name</h2>

% if ($ar->GetModPending) {
    <& /comp/modpending &>
% }

<p>
    Use the fields below to enter a corrected name and/or sort name for
    this artist.&nbsp; If the the new artist name already exists in the database,
    the 'Edit Artist Name' modification will result in the albums from the
    old artist name being merged in with the albums for the new artist.
<p>

<script type="text/javascript" src="scripts/guess.js"></script>

<form method="post" action="/editartist.html"
	name="EditArtistForm"
	enctype="application/x-www-form-urlencoded"
	>

    <table width="100%">
		<tr>
			<td>
				Current Name:
			</td>
			<td>
				<% $ar->GetName  %>
			</td>
		</tr>
		<tr>
			<td>
				New Name:
			</td>
			<td>
				<input type="text" name="newname" size="40" value="<% $ar->GetName %>"> 
				<script type="text/javascript"><!--
        document.write(
          "&nbsp; <input type='button' value='Guess Case' " +
          "onclick='this.form.newname.value = GuessCase(this.form.newname.value)'>"
        )
				//--></script>
			</td>
		</tr>
		<tr>
			<td>
				Current Sort Name:
			</td>
			<td>
				<% $ar->GetSortName  %>
			</td>
		</tr>
		<tr>
			<td>
				New Sort Name:
			</td>
			<td>
				<input type="text" name="newsortname" size="40" value="<% $ar->GetSortName %>"> 
				<script type="text/javascript">
        document.write(
          "&nbsp; <input type='button' value='Guess' " +
          "onclick='this.form.newsortname.value = GuessSortname(this.form.newname.value)'>"
        )
				</script>
			</td>
		</tr>
		<tr>
			<td></td>
			<td>
				<b>Note</b>: Please view the Sortname help guide
				for more information on the artist sortname.
			</td>
		</tr>
		<tr>
			<td></td>
			<td>
				<input type="hidden" name="id" value="<% $id %>">    
				<input type="submit" value="Submit">    
			</td>
	</table>

</form>

<& /comp/movefocus, "EditArtistForm", "newname" &>
<& /comp/footer &>

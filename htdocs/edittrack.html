%# vi: set ts=2 sw=2 ft=mason :
<%args>
$album => undef
$track => undef
$newname => ""
$newseq => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($album) && $album
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($track) && $track
	or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
$al->SetId($album);
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album #$album does not exist",
		1, 1,
	);

my $tr = Track->new($mb->{DBH});
$tr->SetId($track);
$tr->SetAlbum($album);
$tr->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Track #$track on album #$album does not exist",
		1, 1,
	);

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist does not exist",
		1, 1,
	);

my $url = "/showalbum.html?albumid=$album";

if (MusicBrainz::IsSingleLineString($newname)
	and $newname =~ /\S/
	and (MusicBrainz::IsNonNegInteger($newseq) or $al->IsNonAlbumTracks))
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => ModDefs::MOD_EDIT_TRACKNAME,
				# --
				track => $tr,
				newname => $newname,
			) if $newname ne $tr->GetName;

			my @mods2 = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => ModDefs::MOD_EDIT_TRACKNUM,
				# --
				track => $tr,
				newseq => $newseq,
			) if not $al->IsNonAlbumTracks
				and $newseq != $tr->GetSequence;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title => 'Edit Track Name' &>

<& /comp/stylemenu &>

<h2>Edit Track Name</h2>

<script type="text/javascript" src="scripts/guess.js"></script>

<form method="post" action="/edittrack.html"
	name="EditTrackForm"
	enctype="application/x-www-form-urlencoded"
	>

	<table width="100%">
		<tr>
			<td>
				Current Name:
			</td>
			<td>
				<% $tr->GetName  %>
			</td>
		</tr>
		<tr>
			<td>
				New Name:
			</td>
			<td>
				<input type="text" name="newname" size="50" value="<% $tr->GetName %>">
			</td>
		</tr>

% unless ($al->IsNonAlbumTracks) {
		<tr>
			<td>
				Current Track Number:
			</td>
			<td>
				<% $tr->GetSequence %>
			</td>
		</tr>
		<tr>
			<td>
				New Track Number:
			</td>
			<td>
				<input type="text" name="newseq" size="5" value="<% $tr->GetSequence %>">
			</td>
		</tr>
% }

		<tr>
			<td colspan="2">
				<script type="text/javascript"><!--
				document.write(
					"<input type='button' value='Guess Case' " +
					"onclick='this.form.newname.value = GuessCase(this.form.newname.value)'>"
				);
				document.write(" &nbsp; ");
				//--></script>
				<input type="hidden" name="album" value="<% $album %>">
				<input type="hidden" name="track" value="<% $track %>">
				<input type="submit" value="Submit">
			</td>
		</tr>
	</table>

</form>

<& /comp/movefocus, "EditTrackForm", "newname" &>
<& /comp/footer &>

<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page provides charset options, if the data from freedb was not
	# guessed correctly.
	#
	# $Id$
	#
</%perl>
<%args>

	$enc => undef
	$ready => 0
	$tracks

</%args>
<%perl>

	# abort if the ready flag is not set.
	return $m->comp("/comp/redirect", "/freedb/freedb.html")
		if (not $ready);

	# prepare a data structure for the encoding process.
	require Encode;
	require Devel::Peek;

	my @pairs = (
		[ $ARGS{"artistname"}, "artistname" ],
		[ $ARGS{"albumname"}, "albumname" ],
		map {
			[ $ARGS{"track$_"}, "track$_" ]
		} 0 .. $tracks-1
	);

	if (defined $enc)
	{
		my $ok = 1;

		my %args = %ARGS;

		eval {
			for my $pair (@pairs)
			{
				my $t = $pair->[0];

				# Convert back to iso-8859-1
				Encode::from_to($t, "utf-8", "iso-8859-1", Encode::FB_CROAK);

				# Convert those bytes from this encoding to utf-8
				Encode::from_to($t, $enc, "utf-8", Encode::FB_CROAK);
				$args{"$pair->[1]"} = $t;
			}
		};
		if ($ok and $@ eq "")
		{
			return $m->comp("/freedb/review.html", %args);
		}
		else
		{

</%perl>

<& /comp/sidebar-notitle, pagetitle => "FreeDB Import: Encoding Errors" &>

	<& /comp/tablebegin, title => "Encoding Errors" &>

		<table class="formstyle">
			<tr>
				<td class="label"></td>
				<td>
					<& /comp/form/feedbackbox, "warning", "",
						"Errors were encountered during the conversion process." &>
				</td>
			</tr>
			<tr>
				<td></td>
				<td>
					<form method="post" action="review.html">
						<& /comp/args-to-hidden-fields.inc, %ARGS &>
						<& /comp/form/buttonsubmit, value => "Continue &raquo;" &>
					</form>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>

<& /comp/footer &>

<%perl>

			warn "error: $@\n" if $@;
			return;
		}
	}

	my %dec;
	my @failed;

	my @all = Encode->encodings(":all");
	@all = sort map { lc $_ } @all;

	for $enc (@all)
	{
		my @out;

		eval {
			for my $pair (@pairs)
			{
				my $t = $pair->[0];
				# Convert back to iso-8859-1
				Encode::from_to($t, "utf-8", "iso-8859-1", Encode::FB_CROAK);
				# Convert those bytes from this encoding to utf-8
				Encode::from_to($t, $enc, "utf-8", Encode::FB_CROAK);
				push @out, $t;
			}
			1;
		} or do {
			push @failed, $enc;
			next;
		};

		my $key = join "\n", @out;
		my $e = $dec{$key} ||= [ \@out, [] ];
		push @{ $e->[1] }, $enc;
	}

	my @dec = sort {
		$a->[1][0] cmp $b->[1][0]
	} values %dec;

</%perl>


<& /comp/sidebar-notitle, pagetitle => "FreeDB Import: Select Encoding" &>

%	if (@dec == 0)
%	{
%		$ARGS{"offer_charset"} = 0;

		<& /comp/tablebegin, title => "No other encodings available" &>

			<table class="formstyle">
				<tr>
					<td class="label"></td>
					<td>
						<& /comp/form/feedbackbox, "warning", "",
							"No other encodings available - perhaps the
							data is already using the correct encoding." &>
					</td>
				</tr>
				<tr>
					<td></td>
					<td>
						<form method="post" action="review.html">
							<& /comp/args-to-hidden-fields.inc, %ARGS &>
							<& /comp/form/buttonsubmit, value => "Go Back &raquo;" &>
						</form>
					</td>
				</tr>
			</table>

		<& /comp/tableend &>
		<& /comp/footer &>

%		return;
%	}

	<& /comp/tablebegin, title => "Please select the correct encoding" &>

%	for my $dec (@dec)
%	{
%		my ($strings, $encodings) = @$dec;

		<table class="formstyle">
			<tr>
				<td></td>
				<td>
					<& /comp/form/feedbackbox, "info", "",
						(join ", ", sort @$encodings) &>
				</td>
			</tr>
			<tr>
				<td class="label">Artist: </td>
				<td><% $strings->[0] %></td>
			</tr>
			<tr>
				<td class="label">Release: </td>
				<td><% $strings->[1] %></td>
			</tr>

%		for my $n (1..$tracks)
%		{
			<tr>
				<td class="label">Track <% $n %>:</td>
				<td><% $strings->[2+$n-1] %></td>
			</tr>
%		}

			<tr>
				<td></td>
				<td>
					<form method="post" action="charset.html">
						<& /comp/form/buttonsubmit, value => "Use this encoding" &>
						<& /comp/form/hiddenfield, "enc", $encodings->[0] &>
						<& /comp/args-to-hidden-fields.inc, %ARGS &>
					</form>
				</td>
			</tr>
		</table>
		<br />
		<br />

%	}

	<& /comp/tableend &>

%	if (@failed)
%	{
		<& /comp/tablebegin, title => "Failed Conversions" &>

		<table class="formstyle">
			<tr>
				<td class="label"></td>
				<td>
					<& /comp/form/feedbackbox, "warning", "",
						"The data is not in any of the following encodings,
						as attempting to use these encodings produced an error:
						".(join ", ", sort @failed)."." &>
				</td>
			</tr>
		</table>

		<& /comp/tableend &>

%	}


<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

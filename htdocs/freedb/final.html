%# vi: set ts=4 sw=4 ft=mason :
<%perl>

$session{"freedb_ready"}
	or return $m->comp("/comp/redirect", "/freedb/freedb.html");

# Format the data in %session into %ARGS

my $s = \%session;
my $l = $s->{"freedb_lookup"};

my %f = (
	albumname	=> $s->{"freedb_album"},
	freedbid	=> $l->{"freedbid"},
	freedbcat	=> $l->{"freedbcat"},
	tracks		=> $s->{"freedb_tracks"},
	durations	=> $l->{"durations"},
);

my $id = $s->{"freedb_artistid"};
my $va = (defined $id and $id == &ModDefs::VARTIST_ID);

if ($id)
{
	$f{"artist"} = $id;
} else {
	$f{"artistname"} = $s->{"freedb_artist"};
	$f{"sortname"} = $s->{"freedb_sortname"};
}

for my $i (0 .. $f{"tracks"}-1)
{
	$f{"track$i"} = $s->{"freedb_track$i"};

	if ($va)
	{
		# also: freedb_artistid$t (if existing artist)
		$f{"artistname$i"} = $s->{"freedb_artistname$i"};
		$f{"sortname$i"} = $s->{"freedb_sortname$i"};
	}
}

# Clear out FreeDB session data
$m->comp("cancel.html", "true");

# Finally call cdi/selectattr.html
return $m->comp("/cdi/selectattr.html", %f);

</%perl>

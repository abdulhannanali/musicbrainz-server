%# vi: set ts=4 sw=4 ft=mason :
<%args>
$t => undef
$auto => undef
$trackname => undef
$search => undef
</%args>
<%perl>

$session{"freedb_ready"}
	or return $m->comp("/comp/redirect", "/freedb/freedb.html");

MusicBrainz::IsNonNegInteger($t) and $t < $session{"freedb_tracks"}
	or return $m->comp("/comp/redirect", "/freedb/mac-edittracks.html");

# Chunks of code copied from changetrack.html :

# If the user had to click "swap", flip our "split order" flag
$session{'changetrack_splitorder'} = not $session{'changetrack_splitorder'}
	if $ARGS{'swapped'};

if (MusicBrainz::IsSingleLineString($trackname)
	and MusicBrainz::IsSingleLineString($search))
{
	$session{"freedb_track$t"} = $trackname;
	return $m->comp(
		"/comp/redirect",
		"/freedb/mac-selecttrackartist.html"
			. "?search=" . uri_escape($search)
			. "&t=$t"
			. "&auto=" . ($auto ? 1 : 0)
	);
}

# Scan through the track names and artists, and work out what the likely
# "split" sequence is, and what the most common track artist is.
my %trackartists;
my %split = map { $_ => 0 } (" - ", "-", " / ", "/", ": ", ":");

for my $i (0 .. $session{"freedb_tracks"}-1)
{
	for my $split (keys %split)
	{
		++$split{$split} if index($session{"freedb_track$i"}, $split) >= 0;
		++$trackartists{ $session{"freedb_artistname$i"} };
	}
}

my $mostcommonkey = sub {
	my $t = shift;
	my @k = sort { $t->{$a} <=> $t->{$b} } keys %$t;
	$k[-1];
};

my $split = $mostcommonkey->(\%split);
my $oldartist = $mostcommonkey->(\%trackartists);

# These are the existing values
my $oldtrackname = $session{"freedb_track$t"};
my $oldartistname = $session{"freedb_artistname$t"};
my $oldartistsortname = $session{"freedb_sortname$t"};

# Do a split on the track name
my ($splittrackname, $splitartistname) = split($split, $oldtrackname, 2);
($splittrackname, $splitartistname) = split(/\s+[\/-]\s+/, $oldtrackname, 2)
	unless defined $splitartistname;
my $did_split = defined $splitartistname;
($splittrackname, $splitartistname) = ($splitartistname, $splittrackname)
	if $session{'changetrack_splitorder'};

# Trim everything
for ($oldtrackname, $oldartistname, $splittrackname, $splitartistname)
{
	s/\A\s+//;
	s/\s+\z//;
	s/\s\s+/ /g; #/#
}

# Now work out what we think is the more likely - use the split values,
# or use the current values.
my ($newtrackname, $newartistname) = ($oldtrackname, $oldartistname);

if ($did_split
	and (
		$oldtrackname eq "Various Artists"
		or $oldartistname eq ""
		or $oldtrackname eq $oldartistname
		or $session{"freedb_artistid$t"} == &ModDefs::VARTIST_ID
		# or $track->GetArtist == $oldartist
	))
{
	$newtrackname = $splittrackname;
	$newartistname = $splitartistname;
}

</%perl>
<& /comp/sidebar, title => "FreeDB Import: Enter Track Name" &>

<& /comp/stylemenu &>

<form method="post" action="/freedb/mac-edittrack.html?t=<% $t %>&amp;auto=<% $a?1:0 %>"
	name="ChangeTrackForm">

	<& /comp/autofixmenu &>
	<fieldset>
		<legend>Enter Track Name</legend>
		<table>
			<tr>
				<td><label>Current Track Name:</label></td>
				<td><% $oldtrackname %></td>
			</tr>
			<tr>
				<td><label>Current Artist Name:</label></td>
				<td>
					<% $oldartistname %>
% if ($oldartistsortname ne $oldartistname) {
					(<% $oldartistsortname %>)
% }
				</td>
			</tr>
			<tr>
				<td class="padtop"><label>New Track Name:</label></td>
				<td class="padtop">
					<input type="text" name="trackname" class="textfield"
						onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
						size="40" maxlength="255"
						value="<% $newtrackname %>">
					<script language="javascript">
					<!--
						af_writeButton(AF_BTN_TRACK, 'trackname');
					-->
					</script></td>
			</tr>
			<tr>
				<td></td>
				<td>
					<script language="javascript">
					<!--
						af_writeButton(AF_BTN_USESWAP);
						af_writeButton(AF_BTN_USECURRENT);
% if ($did_split) {
						af_writeButton(AF_BTN_USESPLIT);
% }
						af_writeButton(AF_BTN_GUESSBOTH);
					-->
					</script></td>
					<noscript>
						<input type="reset" class="button" value="Use Guessed">
					</noscript></td>
			</tr>
			<tr>
				<td><label>Search for New Artist:</label></td>
				<td>
					<input  type="text" name="search" class="textfield"
							onFocus="myOnFocus(this)" onBlur="myOnBlur(this)"
							size="40" value="<% $newartistname %>">
					<script language="javascript">
					<!--
						af_writeButton(AF_BTN_ARTIST, 'search');
					-->
					</script></td>
			</tr>
			<tr>
				<td></td>
				<td class="padtop">
					<input type="hidden" name="swapped" value="0">
					<input type="submit" class="button" name="Submit" value="Submit">
				</td>
			</tr>
		</table>
	</fieldset>

	<input type="hidden" name="orig_artname" value="<% $oldartistname %>">
	<input type="hidden" name="orig_track" value="<% $oldtrackname %>">
% if ($did_split) {
	<input type="hidden" name="split_artname" value="<% $splitartistname %>">
	<input type="hidden" name="split_track" value="<% $splittrackname %>">
% }
</form>

<& /comp/backtolisting, "/freedb/mac-edittracks.html" &>
<& /comp/movefocus, "ChangeTrackForm", "trackname" &>
<& /comp/footer &>

<& /comp/footer &>

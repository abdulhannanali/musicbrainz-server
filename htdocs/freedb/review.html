<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page provides previews, how the data will be submitted to the
	# release editor, if the user chooses to import as single, or as various
	# artists.
	#
	# $Id$
	#
</%perl>
<%args>

	$releasename
	$artistname
	$tracks
	$offer_charset => 0
	$ready => 0
	$freedbcat
	$freedbid
	$durations => ""

</%args>
<%perl>

	return $m->comp("/comp/redirect", "/freedb/freedb.html")
		if (not $ready);

	# prepare submit to cdi/enter.html
	my $mb = $m->comp("/comp/dblogin");

	my %orig_args = %ARGS;

	# we don't need the durations anymore we have tracktimes to edit
	my $hasdurations = $durations ne "";
	delete $ARGS{"durations"};
	my %args = %ARGS;

	my @durations = split / /, $durations
		if ($hasdurations);

	my ($i, @t);
	for $i (0 .. $args{"tracks"}-1)
	{
		my $track = MusicBrainz::Server::Track->new($mb->{DBH});
		$track->SetId(-1);
		$track->SetName($args{"track$i"});
		$track->SetSequence(($i+1));
		$track->SetLength($durations[$i])
			if ($hasdurations);
		push @t, $track;
	}

	my $artist = MusicBrainz::Server::Artist->new($mb->{DBH});
	$artist->SetId(0);
	$artist->SetName($artistname);

	my $release = MusicBrainz::Server::Release->new($mb->{DBH});
	$release->SetId(0);
	$release->SetArtist(0);
	$release->SetName($releasename);
	# Hack.  Maybe $release->SetAlbumMeta(...) would be a better method
	$release->{trackcount} = (@t);
	$release->{discidcount} = 1;
	$release->{trmidcount} = 0;
	$release->{puidcount} = 0;

</%perl>

<& /comp/sidebar-notitle, pagetitle => "FreeDB import: Select artist type" &>

	<& /comp/tablebegin, title => "Select artist type" &>

		<& /comp/release_editor/steps, %ARGS, stepsleft => 3, freedbid => "-" &>

		<table class="formstyle">
			<tr>
				<td class="instructions">
					<ul>
						<li>
							<strong>Single artist or various artists? </strong>
							Are the tracks of this release credited to a single artist,
							or more than one? Please read the <& /comp/linkdoc,
							"ReleaseArtistStyle", "release artist style" &> for
							instructions on how to select the proper release
							artist.
						</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="formstyle">
			<tr class="top">
				<td class="label">Preview:</td>
				<td>
					<& /comp/linkartist, id => -1, name => $artistname &>
				</td>
			</tr>
			<tr class="top">
				<td class="label"></td>
				<td>
					<form method="post" action="/cdi/enter.html">

						<table width="600" cellspacing="0" cellpadding="0">
							<tr>
								<td>
								<& /comp/album,
									mb => $mb,
									album => $release,
									artist => $artist,
									showlinks => 0,
									showmodlinks => 0,
									showreleases => 0,
									showrelationships => 0,
									tracks => \@t,
								&>
								</td>
							</tr>
						</table>

						<div>

						<& /comp/form/buttonsubmit, value => "Import as single artist &raquo;" &>

%	for $i (0 .. $tracks-1)
%	{
%		$m->comp("/comp/form/hiddenfield",
%			"tracklength$i",
%			MusicBrainz::Server::Track::FormatTrackLength($durations[$i])
%		) if ($hasdurations);
%	}

%	# make sure we do not have these flag twice,
%	# or get rid of the freedb specific things.
%	delete $args{"hasmultipletrackartists"};
%	delete $args{"validate"};
%	delete $args{"artistid"};
%	delete $args{"sacartist"};
%	delete $args{"offer_charset"};
%	delete $args{"ready"};

							<& /comp/form/hiddenfield, "artistid", "0" &>
							<& /comp/form/hiddenfield, "sacartist", $artistname &>
							<& /comp/form/hiddenfield, "hasmultipletrackartists", "0" &>
							<& /comp/args-to-hidden-fields.inc, %args &>
						</div>
					</form>

					<br />
					<br />
					<br />
				</td>
			</tr>

<%perl>

 	# try to split to multiple artists
	%args = $m->comp("/comp/release_editor/convert-tomac", %ARGS);

	# prepare submit to cdi/enter.html
	@t = ();
	for $i (0 .. $tracks-1)
	{
		my $track = MusicBrainz::Server::Track->new($mb->{DBH});
		$track->SetId(-1);
		$track->SetName($args{"track$i"});
		$track->SetArtist(0);
		$track->SetArtistName($args{sprintf "tr%d_artistname", $i});
		$track->SetSequence(($i+1));
		$track->SetLength($durations[$i]) if ($hasdurations);
		push @t, $track;
	}

	$artist = MusicBrainz::Server::Artist->new($mb->{DBH});
	$artist->SetId(1);
	$artist->SetName("Various Artists");

	$release = MusicBrainz::Server::Release->new($mb->{DBH});
	$release->SetId(-2);
	$release->SetArtist(&ModDefs::VARTIST_ID);
	$release->SetName($releasename);
	$release->HasMultipleTrackArtists(1);
	# Hack.  Maybe $release->SetAlbumMeta(...) would be a better method
	$release->{trackcount} = (@t);
	$release->{discidcount} = 1;
	$release->{trmidcount} = 0;
	$release->{puidcount} = 0;

	my $btnimport = "Import as various artists &raquo;";
	if ($args{"tomac-failed"})
	{
		$btnimport = "Import as various artists anyway &raquo;";
	}

</%perl>

			<tr class="top">
				<td class="label">Preview:</td>
				<td>
					<& /comp/linkartist, id => &ModDefs::VARTIST_ID, name => "Various Artists" &>
				</td>
			</tr>
			<tr class="top">
				<td class="label"></td>
				<td>

					<form method="post" action="/cdi/enter.html">

						<table width="600" cellspacing="0" cellpadding="0">
							<tr>
								<td>
								<& /comp/album,
									mb => $mb,
									album => $release,
									artist => $artist,
									showlinks => 0,
									showmodlinks => 0,
									showreleases => 0,
									showtrackartists => 1,
									showrelationships => 0,
									tracks => \@t,
									showheader => 1,
								&>
								</td>
							</tr>
						</table>

						<div>

%	if ($args{"tomac-failed"})
%	{

						<& /comp/form/feedbackbox, "warning",
								"Encountered problems splitting artist and tracknames:",
							qq! Some or all of the tracks do not contain a known artist-
								and trackname split character (one of \"/\", \"-\").
								You can still import the release as various artists, but
								you will have to manually split the artist- and tracknames...! &>
%	}

%	# using a submit button != "submitbtn" will load cdi/enter.html without
%	# triggering the validation
						<& /comp/form/buttonsubmit, name => "submit", value => $btnimport &>

						<br/>
						<& /comp/form/checkbox, name => "swapartistandtracks", value => 1 &> Swap artist and track names

%	for $i (0 .. $tracks-1)
%	{
%		$m->comp("/comp/form/hiddenfield",
%			"tracklength$i",
%			MusicBrainz::Server::Track::FormatTrackLength($durations[$i])
%		) if ($hasdurations);
%	}

%	# make sure we do not have these flag twice,
%	# or get rid of the freedb specific things.
%	delete $args{"hasmultipletrackartists"};
%	delete $args{"validate"};
%	delete $args{"artistid"};
%	delete $args{"sacartist"};
%	delete $args{"offer_charset"};
%	delete $args{"ready"};

							<& /comp/form/hiddenfield, "artistid", &ModDefs::VARTIST_ID &>
							<& /comp/form/hiddenfield, "hasmultipletrackartists", "1" &>
							<& /comp/args-to-hidden-fields.inc, %args &>
						</div>
					</form>
				</td>
			</tr>
		</table>

	<& /comp/tableend &>


%	# offer charset
%	if ($offer_charset)
%	{
	<& /comp/tablebegin, title => "Select different encoding" &>

		<form method="post" action="charset.html">

			<table class="formstyle">
				<tr>
					<td class="instructions">
						<ul>
							<li>
								<strong>Does the data above look garbled? </strong>
								If the data above looks garbled, you can click on the
								button "Change character set" to get a list of previews
								in different encodings. If you find an entry that looks better
								you will be able to force using this encoding and return to this page.
							</li>
						</ul>
					</td>
				</tr>
			</table>

			<table class="formstyle">
				<tr>
					<td class="label">&nbsp;</td>
					<td>
						<input type="submit" class="button" value="Change character set &raquo;" />

%		                delete $orig_args{"enc"};

						<& /comp/args-to-hidden-fields.inc, %orig_args &>
					</td>
				</tr>
			</table>

		</form>

	<& /comp/tableend &>

% 	}

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

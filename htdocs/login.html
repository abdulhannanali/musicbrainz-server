%# vi: set ts=4 sw=4 ft=mason :
<%args>
	$badlogin => 0
	$confirm => 0
	$confirmed => 0
	$email => ""
	$url => ""
</%args>
<%perl>

	return $m->comp("/comp/redirect", "/search.html")
		if $session{uid};

	if ($url eq "")
	{
	   if (defined $r->headers_in->{"Referer"} &&
		   $r->headers_in->{"Referer"} ne "")
	   {
		   $url = $r->headers_in->{"Referer"};
		   $url = "/search.html" if ($url eq "/logout.html");
	   }
	   else
	   {
		   $url = "/search.html";
	   }
	}
	$m->comp("/comp/sidebar", noh1 => 1);


	if ($confirm)
	{

</%perl>

   <p><b>You have been logged in.</b></p>

   <h2>EMail address confirmation</h2>

   <p>However, we do not have a confirmed email address for you. Please
   check to make sure the email address below is valid and click on submit.
   If you wish to remove your email address, just leave the field below blank.
   </p>

   <p>
   If you give a valid email address, a confirmation email will be sent to
   the address provided. Please click on the link in the email to confirm
   your email address:
   </p>

   <& /comp/confirmemailbox, url => $url, email => $email  &>

%  } elsif ($confirmed) {

   <h2>EMail address confirmation</h2>

       <%perl>
       my ($ui, $mb, $info);
       $mb = $m->comp("/comp/dblogin");
       my $user = UserStuff->new($mb->{DBH});

       if (!$user->CheckEMailAddress($email))
       {
           </%perl>
           The email address you entered is not a valid email address. Please go back
           and enter a valid email address, or leave the email field blank for no email
           address.
           <& /comp/footer &>
           <%perl>
           $mb->Logout();
           return undef;
       }

       my $me = $user->newFromId($session{uid});
       if (!defined $me)
       {
           $m->out("User $session{uid} was not found.");
           $m->comp("/comp/footer");
           $mb->Logout();
           return undef;
       }

       if ($email eq '')
       {
           $me->SetUserInfo(email => "");
           </%perl>
           <p>Your email address has been removed.</p>
           <%perl>
       }
       else
       {
           my $ret = $me->SendVerificationEmail($email);
           if ($ret)
           {
               </%perl>
               <p>
               The email verification mail could not be sent: <b><% $ret %></b>.
               Your email address has not been updated.
               </p>
               <%perl>
           }
           else
           {
               </%perl>
               <p>
               The email verification mail has been sent to <b><% $email %></b>.
               Please check your mailbox and click on the link in the email to
               verify the new email address.
               </p>
               <%perl>
           }
       }

       </%perl>

       <p>[ <a href="<% $url %>">Continue</a> ]</p>

%  } else {

		<& /comp/tablebegin, title => "Login", align => "center" &>
			<& /comp/loginbox, url => $url, badlogin => $badlogin &>
		<& /comp/tableend &>
%  }
<& /comp/footer &>

%# vi: set ts=2 sw=2 ft=mason :
<%args>
$album => undef
$store => undef
$asin => undef
</%args>
<%perl>

defined($store)
	or goto REJECT;

my $ass_id = &DBDefs::AWS_ASSOCIATE_ID($store)
	or goto REJECT;
$ass_id = "" unless &DBDefs::AWS_USE_ASSOCIATE_IDS;

$asin =~ /\A\w{1,100}\z/
	or goto REJECT;

my $message = do {
	require POSIX;
	my $time = POSIX::strftime("%Y%m%d-%H%M%S", localtime);

	no warnings 'uninitialized';
	join "\t",
		"time=$time",
		"type=buy",
		"user=$session{user}",
		"album=$album",
		"store=$store",
		"asin=$asin",
		;
} . "\n";

eval { MusicBrainz::SimpleLog("/tmp/amazon-click.log", $message) };

</%perl>
<& /comp/header_small, title => "Redirecting to Amazon ..." &>

<form name="AddToCartForm" method="POST" action="http://<% $store %>/exec/obidos/dt/assoc/handle-buy-box=<% $asin %>">
	<p>
    <input type="hidden" name="asin.<% $asin %>" value="1">
    <input type="hidden" name="tag-value" value="<% $ass_id %>"> 
    <input type="hidden" name="tag_value" value="<% $ass_id %>">
    <input type="hidden" name="dev-tag-value" value="<% &DBDefs::AWS_DEVELOPER_ID %>">
		If you are not redirected shortly, please
    <input type="submit" name="submit.add-to-cart" value="click me">
	</p>
</form>

<script type="text/javascript">
document.forms.AddToCartForm.submit();
</script>

<& /comp/footer_small &>
<%perl>

return;

REJECT:
return $m->comp("/comp/redirect", "/");

</%perl>

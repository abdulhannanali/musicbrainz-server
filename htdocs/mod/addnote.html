%# vi: set ts=4 sw=4 ft=mason :
<%args>
$modid=>undef
$text=>""
</%args>
<%perl>

if (not $session{uid})
{
	</%perl>
	<& /comp/header_small, title => 'Add note to moderation' &>
	<p style="color: red; font-size: 150%">Oops!&nbsp; You're not logged in.</p>
	<p>Please log in before adding moderation notes.</p>
	<& /comp/footer_small &>
	<%perl>
	return;
}

MusicBrainz::IsNonNegInteger($modid) and $modid
	or $modid = 0;

my $mb = $m->comp("/comp/dblogin");
my $mod = undef;

if ($modid)
{
	$mod = Moderation->new($mb->{DBH});
	$mod = $mod->CreateFromId($modid);
}

if (not $mod)
{
	</%perl>
	<& /comp/header_small, title => 'Add note to moderation' &>
	<p>Bad or unknown moderation id.</p>
	<& /comp/footer_small &>
	<%perl>
	return;
}

if (MusicBrainz::IsSingleLineString($text)
	and $text =~ /\S/)
{
	my $sql = Sql->new($mb->{DBH});

	eval {
		$sql->Begin;
		$mod->InsertNote(
			$session{uid}, $text,
		);
		$sql->Commit;
	};

	if ($@)
	{
		my $err = $@;
		eval { $sql->Rollback };
		</%perl>

		<& /comp/header_small, title => "Error adding moderation note" &>

		<p class="notice">
			An error occurred whilst saving your moderation note.&nbsp;
			Sorry.
		</p>

		<!-- <% $err %> -->

		<& /comp/footer_small &>

		<%perl>
		return undef;
	}

	</%perl>
	<& /comp/header_small, title => 'Moderation note added' &>
	<script type="text/javascript"> window.close(); </script>
	<p>Note saved successfully.</p>
	<p><a href="/showmod.html?modid=<% $mod->GetId %>">Continue</a></p>
	<& /comp/footer_small &>
	<%perl>
	return;
}

my $ui = UserStuff->new($mb->{DBH});
my $me = $ui->newFromId($session{uid});

</%perl>
<& /comp/header_small, title => 'Add note to moderation' &>

<form method="post" action="/mod/addnote.html" name="ModNoteForm">

	<p style="margin: 0">
		Enter the note text below:
	</p>

	<p style="margin: 0.2em; width: 100%">
		<textarea name="text" rows="3" cols="40" style="width: 100%"
			><% $text %></textarea>
	</p>

	<p style="margin: 0; text-align: right">
		<input type="hidden" name="modid" value="<% $mod->GetId %>">
		<input type="submit" value="Submit">
	</p>

</form>

<& /comp/movefocus, "ModNoteForm", "text" &>
<& /comp/footer_small &>

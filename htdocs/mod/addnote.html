<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows to add a moderation note.
	#
	# $URL$
	# $Id$
	#
</%perl>
<%args>
	$modid => undef
	$editid => undef

	$text=>""
</%args>
<%perl>

	$editid ||= $modid;

if (not $session{uid})
{
	</%perl>
	<& /comp/header_small, title => 'Add note to moderation' &>
	<p style="color: red; font-size: 150%">Oops!&nbsp; You're not logged in.</p>
	<p>Please log in before adding moderation notes.</p>
	<& /comp/footer_small &>
	<%perl>
	return;
}

MusicBrainz::IsNonNegInteger($editid) and $editid
	or $editid = 0;

my $mb = $m->comp("/comp/dblogin");
my $edit = undef;

if ($editid)
{
	$edit = Moderation->new($mb->{DBH});
	$edit = $edit->CreateFromId($editid);
}

if (not $edit)
{
	</%perl>
	<& /comp/header_small, title => 'Add note to moderation' &>
	<p>Bad or unknown moderation id.</p>
	<& /comp/footer_small &>
	<%perl>
	return;
}

if (MusicBrainz::IsSingleLineString($text)
	and $text =~ /\S/)
{
	my $sql = Sql->new($mb->{DBH});

	eval {
		$sql->Begin;
		$edit->InsertNote(
			$session{uid}, $text,
		);
		$sql->Commit;
	};

	if ($@)
	{
		my $err = $@;
		eval { $sql->Rollback };
		</%perl>

		<& /comp/header_small, title => "Error adding moderation note" &>

		<p class="notice">
			An error occurred whilst saving your moderation note.&nbsp;
			Sorry.
		</p>

		<!-- <% $err %> -->

		<& /comp/footer_small &>

		<%perl>
		return undef;
	}

	</%perl>
	<& /comp/header_small, title => 'Moderation note added' &>
	<script type="text/javascript"> window.close(); </script>
	<p>Note saved successfully.</p>
	<p><a href="/showmod.html?editid=<% $edit->GetId %>">Continue</a></p>
	<& /comp/footer_small &>
	<%perl>
	return;
}

my $ui = UserStuff->new($mb->{DBH});
my $me = $ui->newFromId($session{uid});

</%perl>
<& /comp/header_small, title => 'Add note to moderation' &>

<form method="post" action="/mod/addnote.html" name="ModNoteForm">

	<p style="margin: 0">
		Enter the note text below:
	</p>

	<p style="margin: 0.2em; width: 100%">
		<textarea name="text" rows="3" cols="40" style="width: 100%"
			><% $text %></textarea>
	</p>

	<p style="margin: 0; text-align: right">
		<input type="hidden" name="editid" value="<% $edit->GetId %>">
		<input type="submit" value="Submit">
	</p>

</form>

<& /comp/movefocus, "ModNoteForm", "text" &>
<& /comp/footer_small &>

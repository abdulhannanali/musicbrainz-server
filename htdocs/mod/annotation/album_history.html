%# vi: set ts=2 sw=2 ft=mason :
<%args>
$albumid
$expandids => undef
$expand_all => undef
$show_mods => undef
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

if ($show_mods)
{
	my %filter = (
		mod_type				=> [ &ModDefs::MOD_ADD_ALBUM_ANNOTATION ],
		object_type			=> "album",
		object_id				=> $albumid,
		orderby					=> "desc",
	);

	return $m->comp(
		"/comp/redirect",
		"/mod/search/results.html?" . $m->comp("/comp/args-to-querystring.inc", %filter)
	);
}

MusicBrainz::IsNonNegInteger($albumid) && $albumid
	or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
$al->SetId($albumid);
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album #$albumid does not exist",
		1, 1,
	);

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist());
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"artist #" . $al->GetArtist() . " does not exist",
		1, 1,
	);

# Load annotations.

my %expand = map { $_ => 1 } split(' ', $expandids);
my $annotations = MusicBrainz::Server::Annotation->GetAnnotationIDsForAlbum($al);
#$expand{$annotations->[0]} = 1 unless defined $expandids;

</%perl>

<& /comp/sidebar, title => 'Annotation History for ' . $al->GetName() &>

<p>Annotations for <& /mod/annotation/subject, artist => $ar, album => $al &></p>

<p> [
% if ($expand_all) {
	<a href="/mod/annotation/album_history.html?albumid=<% $albumid %>">Collapse list</a>
% } else {
	<a href="/mod/annotation/album_history.html?albumid=<% $albumid %>&amp;expand_all=1">Expand list</a>
% }
	| <a href="/mod/annotation/album_history.html?albumid=<% $albumid %>&amp;show_mods=1">Show moderations</a>
] </p>

% unless ( @$annotations ) {
	<p>
		No annotations available.&nbsp;
		<a href="/mod/annotation/album_edit.html?albumid=<% $albumid
				%>">Add an annotation.</a>
	</p>
% }

% foreach my $annotation ( @$annotations ) {
%		my $an = MusicBrainz::Server::Annotation->new($mb->{DBH});
%		$an->SetId($annotation);
%		$an->LoadFromId();
	<& /mod/annotation/show, annotation => $an, show_log => 1,
		expand => $expand{$annotation} || $expand_all &>
	<br>
% }

<& /comp/footer &>

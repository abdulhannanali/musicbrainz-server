%# vi: set ts=4 sw=4 ft=mason :
<%perl>

my $edit = $session{"editalbum"}
	or return $m->comp("/comp/redirect", "/search.html");

my $mb = $m->comp("/comp/dblogin");
my $changes = 0;

my $al = Album->new($mb->{DBH});
$al->SetId($edit->{"id"});
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album not found in the database.",
		1, 1,
	);

my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);

my @tracks = $al->LoadTracks;

my $orig = $m->scomp(
	"/comp/album",
	album => $al,
	artist => $ar,
	showmodlinks => 0,
	tracks => \@tracks,
);

#$al->{attrs} = [ 0, &Album::ALBUM_ATTR_ALBUM, &Album::ALBUM_ATTR_BOOTLEG ];

</%perl>
<& /comp/sidebar, title => "Album Editor - Review Changes" &>

<h2>Changes</h2>

<table class="SpacedColumns TopAlignCells">
	<tr>
		<th>Change</th>
		<th>Old</th>
		<th>New</th>
	</tr>

<%perl>

if ($edit->{name} ne $edit->{orig_name})
{
	</%perl>
	<tr>
		<td>Edit Album Name</td>
		<td><a href="/showalbum.html?albumid=<% $edit->{'id'} %>"><% $edit->{orig_name} %></a></td>
		<td><b><% $edit->{name} %></b></td>
	</tr>
	<%perl>
	$al->SetName($edit->{name});
	++$changes;
}

my $old_attrs = join " ", sort grep { defined } @$edit{qw( orig_type orig_status )};
my $new_attrs = join " ", sort grep { defined } @$edit{qw( type status )};
if ($old_attrs ne $new_attrs)
{
	</%perl>
	<tr>
		<td>Edit Album Attributes</td>
	<%perl>
	for ($old_attrs, $new_attrs)
	{
		my @names = map {
			Album->GetAttributeName($_) || "#$_"
		} split ' ', $_;
		</%perl>
		<td><% @names ? join ", ", @names : "None" %></td>
%	}
	</tr>
	<%perl>
	$al->SetAttributes(split ' ', $new_attrs);
	++$changes;
}

for my $t (@{ $edit->{tracks} })
{
	if ($t->{"new"})
	{
		next if $t->{"name"} eq "";
		</%perl>
		<tr>
			<td>Add Track</td>
			<td></td>
			<td>Name: <% $t->{name} %><br>Track: <% $t->{seq} %></td>
		</tr>
		<%perl>
		# push Track object
		my $tr = Track->new($mb->{DBH});
		$tr->SetId(0);
		$tr->SetName($t->{name});
		$tr->SetSequence($t->{seq});
		push @tracks, $tr;
		++$changes;
		next;
	}
		
	(my $tr) = grep { $_->GetId == $t->{"id"} } @tracks
		or next;

	if ($t->{'delete'})
	{
		</%perl>
		<tr>
			<td>Remove Track</td>
			<td>Name: <a href="/showtrack.html?trackid=<% $t->{'id'} %>"><% $t->{orig_name} %></a>
				<br>Track: <% $t->{orig_seq} %></td>
			<td></td>
		</tr>
		<%perl>
		$tr->{"_delete"} = 1;
		++$changes;
		next;
	}

	if ($t->{name} ne $t->{orig_name})
	{
		</%perl>
		<tr>
			<td>Edit Track Name</td>
			<td><a href="/showtrack.html?trackid=<% $t->{'id'} %>"><% $t->{orig_name} %></a></td>
			<td><b><% $t->{name} %></b></td>
		</tr>
		<%perl>
		$tr->SetName($t->{name});
		++$changes;
	}

	if ($t->{seq} != $t->{orig_seq})
	{
		</%perl>
		<tr>
			<td>Edit Track Number</td>
			<td><b><% $t->{orig_seq} %></b><br>
				<a href="/showtrack.html?trackid=<% $t->{'id'} %>"><% $t->{name} %></a></td>
			<td><b><% $t->{seq} %></b></td>
		</tr>
		<%perl>
		$tr->SetSequence($t->{seq});
		++$changes;
	}
}

</%perl>

% if (not $changes) {
	<tr><td colspan="3">You have not made any changes!</td></tr>
% }

</table>

% if ($changes) {

<h2>Preview</h2>

<p><font size="+2">
	<a href="/showartist.html?artistid=<% $ar->GetId %>"
		><% $ar->GetName %></a>
</font></p>

<%perl>

@tracks = sort {
	$a->GetSequence <=> $b->GetSequence
	or
	$a->GetName cmp $b->GetName
} grep {
	not $_->{"_delete"}
} @tracks;

</%perl>

<& "/comp/album",
	album => $al,
	artist => $ar,
	showmodlinks => 0,
	tracks => \@tracks,
	&>
% }

<hr style="clear: both; margin: 2em 0">

<form method="get" action="sac-edittracks.html"
	style="float: left; margin-right: 2em">
	<input type="submit" value="Keep Editing">
</form>
<form method="get" action="index.html"
	style="float: left; margin-right: 2em">
	<input type="hidden" name="album" value="<% $edit->{'id'} %>">
	<input type="submit" value="Start Over">
</form>
<form method="get" action="cancel.html"
	style="float: left; margin-right: 2em">
	<input type="submit" value="Abandon">
</form>

% if ($changes) {
<form method="post" action="enter.html">
	<input type="submit" value="Enter Moderations">
	<p>
		If entering moderations, enter moderation note (optional):
	</p>

	<p>
		<textarea name="notetext" rows="3" cols="60"></textarea>
	</p>
% }

<& /comp/footer &>

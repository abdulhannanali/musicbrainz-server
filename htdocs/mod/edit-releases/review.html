%# vi: set ts=4 sw=4 ft=mason :
<%perl>

my $edit = $session{"editreleases"}
	or return $m->comp("/comp/redirect", "/search.html");

my $mb = $m->comp("/comp/dblogin");
my $changes = 0;


my $al = Album->new($mb->{DBH});
$al->SetId($edit->{"id"});
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album not found in the database.",
		1, 1,
	);
my $ar = Artist->new($mb->{DBH});
$ar->SetId($al->GetArtist);
$ar->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);
my @releases = $al->Releases;
my @tracks = $al->LoadTracks;

</%perl>
<& /comp/sidebar, title => "Releases Editor: Review Changes" &>

<& /comp/artisttitle, artist => $ar &>

<fieldset>
	<legend>Review Changes</legend>
	<div class="padleft">
		These are the moderations that will be entered into
		the system when you click "Enter Moderations":
	</div>
	<div class="padlefttop">
		<table border="0" cellspacing="0">
			<tr valign="top">
				<td><b>Moderation</td>
				<td rowspan="200">&nbsp;&nbsp;</td>
				<td><b>Old Value</td>
				<td rowspan="200">&nbsp;&nbsp;</td>
				<td><b>New Value</td>
			</tr>

<%perl>

my $countries_menu = $m->comp("countries-menu.inc");
my %country_name = map { $_->[0], $_->[1] } @$countries_menu;

for my $rel (@{ $edit->{releases} })
{
	if ($rel->{"new"})
	{
		</%perl>
			<tr>
				<td>Add Release</td>
				<td></td>
				<td>Date: <& /comp/releasedate, @$rel{qw( year month day )} &>
					&nbsp; Country: <% $country_name{$rel->{country}} || "?" %></td>
			</tr>
		<%perl>
		++$changes;
		next;
	}
		
	if ($rel->{'delete'})
	{
		</%perl>
			<tr>
				<td>Remove Release</td>
				<td>
					Date: <& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &>
					&nbsp; Country: <% $country_name{$rel->{orig_country}} || "?" %></td>
				<td>&nbsp;</td>
			</tr>
		<%perl>
		++$changes;
		next;
	}

	next unless grep {
		$rel->{$_} != $rel->{"orig_".$_}
	} qw( year month day country );

	{
		</%perl>
			<tr>
				<td>Edit Release</td>
				<td>
					Date: <& /comp/releasedate, @$rel{qw( orig_year orig_month orig_day )} &>
					&nbsp; Country: <% $country_name{$rel->{orig_country}} || "?" %></td>
				<td>
					Date: <& /comp/releasedate, @$rel{qw( year month day )} &>
					&nbsp; Country: <% $country_name{$rel->{country}} || "?" %></td>
			</tr>
		<%perl>
		++$changes;
	}
}
</%perl>

% if (not $changes) {
			<tr><td colspan="3">You have not made any changes!</td></tr>
% }
		</table>
	</div>
	<div class="padlefttop">
		<table>
			<tr>
				<td>
					<form method="GET" action="editreleases.html">
						<input type="submit" class="button" value="Keep Editing">
					</form></td>
				<td>
					<form method="GET" action="index.html">
						<input type="hidden" name="album" value="<% $edit->{'id'} %>">
						<input type="submit" class="button" value="Start Over">
					</form></td>
				<td>
					<form method="GET" action="cancel.html">
						<input type="submit" class="button" value="Abandon">
					</form></td>
			</tr>
		</table>
	</div>
</fieldset>

% if ($changes) {
<fieldset>
	<legend>Preview</legend>

	<form method="post" action="enter.html">
		<div class="padlefttop">
			<& /comp/notetext &>
		</div>
		<div class="padlefttop">
			<input type="submit" class="button" value="Enter Moderations">
		</div>
	</form>
</fieldset>
% }

<& /comp/footer &>

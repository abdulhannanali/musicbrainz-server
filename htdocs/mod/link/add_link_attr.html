%# vi: set ts=4 sw=4 ft=mason :
<%args>
$id => ""
$attrname => ""
$submit=>0
$desc => ""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;
$m->comp("/comp/ar/CheckLinkModerator", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");
my $link = MusicBrainz::Server::LinkAttr->new($mb->{DBH})
	or return $m->comp("/comp/redirect", "/mod/link/link_type_roots.html");

my $node = $link->newFromMBId($id)
	or $m->comp(
		"/comp/redirect",
		"/mod/link/link_attrs.html"
	);

if ($attrname =~ /\S/ && $desc =~ /\S/)
{
	my $r = $m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_ADD_LINK_ATTR,
				# --
				parent => $node,
				name => $attrname,
				description => $desc,
			);
		},
	) or return;
	
	my $newid;
	$newid = $r->[0]->GetRowId if @$r;

	$m->comp(
		"/comp/redirect",
		"/mod/link/link_attrs.html?new=$newid",
	);
}

my @p = $node->PathFromRoot;

</%perl>
<& /comp/sidebar, title => 'Add Link Attribute' &>

% if ($submit) {
%      if (!$attrname) {
         <p style="color: red;">Error: You must provide an attribute name.</p>
%      }
%      if (!$desc) {
         <p style="color: red;">Error: You must provide a description.</p>
%      }
% }

<table>
<tr>
  <td>Parent path:</td><td> <% join " / ", map { encode_entities($_->GetName) } @p %></td>
</tr>
</table>
</p>

<form method="post" action="/mod/link/add_link_attr.html"
	name="AddAttrTypeForm"
	>

	<p>
	Enter the name of this link attribute:
	</p>

	<table>
	<tr>
	   <td>Name:</td>
	   <td>
		<input type="text" name="attrname"
			maxlength="255" size="40"
			value="<% $attrname %>"
			>
	   </td>
     </tr>
    </tr>
        <td valign="top">Description:</td>
        <td><textarea name="desc" rows="3" cols="40"><% $desc %></textarea></td>
    </tr>
	 <tr>
	   <td>&nbsp;</td>
	   <td>
	    <br/>
		<input type="hidden" name="id" value="<% $id %>">
		<input type="hidden" name="submit" value="1">
		<input type="submit">
		</td>
	  </tr>
	</table>
</form>

<p>
	<a href="/mod/link/link_attrs.html">Back</a>
</p>

<& /comp/movefocus, "AddAttrTypeForm", "attrname" &>
<& /comp/footer &>

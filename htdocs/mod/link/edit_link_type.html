%# vi: set ts=4 sw=4 ft=mason :
<%args>
$type => ""
$id => ""
$linktypename => ""
$linkphrase => ""
$rlinkphrase => ""
$desc => ""
$submit=>0
</%args>
<%perl>

MusicBrainz::TrimInPlace($linktypename);
MusicBrainz::TrimInPlace($linkphrase);
MusicBrainz::TrimInPlace($rlinkphrase);
MusicBrainz::TrimInPlace($desc);

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");
my $link = MusicBrainz::Server::LinkType->newFromPackedTypes($mb->{DBH}, $type)
	or return $m->comp("/comp/redirect", "/mod/link/link_type_roots.html");

my $node = $link->newFromMBId($id)
	or $m->comp(
		"/comp/redirect",
		"/mod/link/link_types.html?type=$type"
	);

my $attrtext = "";
my $attrok = 1;
foreach my $key (keys %ARGS)
{
    if ($key =~ /^attr_([A-Za-z0-9]+)$/)
	{
        my $mn = $ARGS{"attr_$1_min"};
        my $mx = $ARGS{"attr_$1_max"};
		if ($mn eq '' || ($mn eq '' && $mx ne '') || ($mx ne '' && $mn ne '' && $mx < $mn))
		{
			$attrok = 0;
			last;
		}
	    $attrtext .= "$1=";
		$attrtext .= "$mn-" if ($mn ne '');
		$attrtext .= "$mx" if ($mx ne '');
		$attrtext .= " ";
	}
}

if ($linktypename =~ /\S/ && $linkphrase =~ /\S/ && $rlinkphrase =~ /\S/ && $desc =~ /\S/ && $attrok)
{
	my $r = $m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_EDIT_LINK_TYPE,
				# --
				node        => $node,
				name        => $linktypename,
				linkphrase  => $linkphrase,
				rlinkphrase => $rlinkphrase,
				description => $desc,
				attribute   => $attrtext,
			);
		},
	) or return;
	
	my $newid;
	$newid = $r->[0]->GetRowId if @$r;

	$m->comp(
		"/comp/redirect",
		"/mod/link/link_types.html?type=$type"
			. "&new=$newid",
	);
}

my @p = $node->PathFromRoot;
my ($ent0, $ent1) = split /-/, $type;

my $attr = MusicBrainz::Server::LinkAttr->new($mb->{DBH});
my $root = $attr->Root;
my @children = $root->Children;

$m->comp("/comp/sidebar", title => 'Edit Link Type');

if ($submit) 
{
     if (!$linktypename) {
       $m->out('<p style="color: red;">Error: You must provide a link name.</p>');
     }
     if (!$linkphrase) {
       $m->out('<p style="color: red;">Error: You must provide a link phrase.</p>');
     }
     if (!$rlinkphrase) {
       $m->out('<p style="color: red;">Error: You must provide a reverse link phrase.</p>');
     }
     if (!$desc) {
       $m->out('<p style="color: red;">Error: You must provide a description.</p>');
     }
     if (!$attrok) {
       $m->out('<p style="color: red;">Error: One or more of the given attribute\'s min/max figures is incorrect. Please make sure that min is smaller or equal to max and that at least a minimum value is given for each attribute.</p>');
     }
} else 
{
     $linktypename = $node->GetName;
     $linkphrase = $node->GetLinkPhrase;
     $rlinkphrase = $node->GetReverseLinkPhrase;
     $desc = $node->GetDescription;
     my @pairs = split ' ', $node->GetAttributes;
	 foreach my $pair (@pairs)
	 {
		 if ($pair =~ /([A-Za-z0-9]+)=/)
		 {
			 my $name = $1;
             $ARGS{"attr_$name"} = 1;
     	     $ARGS{"attr_" . $name . "_min"} = ($pair =~ /[A-Za-z0-9]+=(\d+)/) ? $1 : '';
     	     $ARGS{"attr_" . $name . "_max"} = ($pair =~ /[A-Za-z0-9]+=\d+-(\d+)/) ? $1 : '';
         }
	 }
}

if ($linktypename eq 'ROOT') 
{
  $m->out("This link type cannot be edited.");
  $m->comp("/comp/footer");
  return undef;
}

</%perl>

<table>
<tr>
  <td>Parent path:</td><td> <% join " / ", map { encode_entities($_->GetName) } @p %></td>
</tr>
<tr>
  <td>Link type:</td><td><% $type %></td>
</tr>
</table>
</p>

<form method="post" action="edit_link_type.html"
	name="EditLinkTypeForm"
	>

	<p>
	For the link phrase and reverse link phrase, spell out the relationship as if you would use it in a full sentence: 
	</p>
	<blockquote>
	   link phrase: <i>[Band A] has/had member(s) [John Doe, Jim Smith]</i><br>
	   reverse link phrase: <i>[John Doe] is/was member of [Band A]</i>
	</blockquote>
	<p>Notes:</p>
	<ul>
	<li>Please use parenthesized plural forms where there can be more than one of these relationships (e.g. member(s) ).</li>
	<li>The name of the link will be used in the RDF that the web service emits. This means that the name
	will be turned to mixed case (e.g. MemberOf) when used by the web service.</li>
	<li>All attributes are optional. To select a link attribute click the checkbox in front of it and 
	specify the number of times the attribute can be used in one link. (e.g. 0 - = zero or more times, 0 - 1 =
	zero or one times, 2-4 = two to four times.)</li>
	</ul>

	<table>
	<tr>
	   <td>Name:</td>
	   <td>&nbsp;</td>
	   <td>
		<input type="text" name="linktypename"
			maxlength="255" size="40"
			value="<% $linktypename %>"
			>
	   </td>
	   <td>&nbsp;</td>
     </tr>
	 <tr>
	   <td>Link phrase:</td>
	   <td align="right"><% $ent0 %></td>
	   <td>
		<input type="text" name="linkphrase"
			maxlength="255" size="40"
			value="<% $linkphrase %>"
			>
	   </td>
	   <td><% $ent1 %></td>
     </tr>
	 <tr>
	   <td><nobr>Reverse link phrase:</nobr></td>
	   <td align="right"><% $ent1 %></td>
	   <td>
	    <input type="text" name="rlinkphrase"
	    	maxlength="255" size="40"
	    	value="<% $rlinkphrase %>"
	    	>
	   </td>
	   <td><% $ent0 %></td>
	 </tr>
     </tr>
         <td valign="top">Description:</td>
         <td colspan="3"><textarea name="desc" rows="8" cols="50"><% $desc %></textarea></td>
     </tr>
    </tr>
        <td valign="top">Attributes:</td>
        <td colspan="3">
		<table>
		   <tr><td><i>Name:</i></td><td><i>Min:</i></td><td><i>Max:</i></td></tr>
%          my $count = 0;
%          foreach my $child (@children) {
	           <tr>
			   <td><input type="checkbox" name="attr_<% $child->GetName %>" value="1" <% ($ARGS{"attr_" . $child->GetName}) ? 'checked=""' : '' %> />
			   <% $child->GetName() %></td>
			   <td><input type="text" size="4" name="attr_<% $child->GetName %>_min" value="<% $ARGS{"attr_" . $child->GetName . "_min"} %>"/>-</td>
			   <td><input type="text" size="4" name="attr_<% $child->GetName %>_max" value="<% $ARGS{"attr_" . $child->GetName . "_max"} %>"/></td>
			   </tr>
%              $count++;
%          } 
        </table>
		</td>
    </tr>
	 <tr>
	   <td>&nbsp;</td>
	   <td>&nbsp;</td>
	   <td>
	    <br/>
		<input type="hidden" name="type" value="<% $type %>">
		<input type="hidden" name="id" value="<% $id %>">
		<input type="hidden" name="submit" value="1">
		<input type="submit" value="Edit link type">
		</td>
	   <td>&nbsp;</td>
	  </tr>
	</table>
</form>

<p>
	<a href="/mod/link/link_types.html?type=<% $type %>">Back</a>
</p>

<& /comp/movefocus, "EditLinkTypeForm", "linktypename" &>
<& /comp/footer &>

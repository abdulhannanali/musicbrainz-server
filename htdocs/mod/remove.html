%# vi: set ts=2 sw=2 ft=mason :
<%args>
	$modid => 0
	$confirm => ""
	$url => "/mod/search/pre/moderator.html"
</%args>
<%perl>
	# start page output.

	# sanitize modid argument
	if ($modid < 1)
	{
		$m->comp("/comp/badargs");
		return undef;
	}

	# get database handle
	my $mb = $m->comp("/comp/dblogin");

	# load moderation from given $modid argument
	my $mod = Moderation->new($mb->{DBH});
	$mod = $mod->CreateFromId($modid);
	if (not defined $mod)
	{
		$m->comp("/comp/error", "The edit #$modid was not found.");
		return undef;
	}
	if ($mod->GetStatus != &ModDefs::STATUS_OPEN)
	{
		$m->comp("/comp/error", "The edit #$modid is not in a status that allows removal.");
		return undef;
	}


	# form was submitted, see which button it was.
	if ($confirm ne "")
	{
		if ($confirm =~ m/YES/)
		{
		    my $sql = Sql->new($mb->{DBH});
			eval
			{
				$sql->Begin;
				$mod->RemoveModeration($session{uid});
				$sql->Commit;
			};
			if ($@)
			{
				my $err = $@;
				$sql->Rollback;
				$m->out("<b>A database error occurred.</b><pre>($err)</pre>");
				$m->comp("/comp/footer");
				return undef;
		    }
		}

		# forward to $url
		$r->method("GET");
		$r->headers_in->unset("Content-length");
		$r->content_type("text/html; charset=UTF-8");
		$r->header_out(Location => $url);
		$r->status(302);
		return undef;
	}


	$m->comp("/comp/sidebar-notitle", pagetitle => "Confirm Remove Moderation");
	$m->comp("/comp/tablebegin", title => "Confirm Moderation Removal");

</%perl>

	<form method="post" action="/mod/remove.html" id="ConfirmForm">

		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>Do you want to remove this moderation?</li>
					</ul>
				</td>
			</tr>
			<tr class="top">
				<td class="label">
					<label>Edit Type:</label>
				</td>
				<td>
					<%perl>
						$mod->ShowModType($m);
					</%perl></td>
			</tr>
			<tr class="top">
				<td class="label">
					<label>Previous Value:</label>
				</td>
				<td>
				<%perl>
					$mod->ShowPreviousValue($m);
				</%perl></td>
			</tr>
			<tr class="top">
				<td class="label">
					<label>New Value:</label>
				</td>
				<td>
				<%perl>
					$mod->ShowNewValue($m);
				</%perl></td>
			</tr>
			<tr>
				<td class="label">Confirm:</td>
				<td class="formsection">
					<input type="submit" class="button" name="confirm" value="&laquo; NO" />
					<input type="submit" class="button" name="confirm" value="YES &raquo;" />
					<& /comp/args-to-hidden-fields.inc, %ARGS &>
				</td>
			</tr>
		</table>
		<& /comp/movefocus, id => "ConfirmForm" &>
	</form>

	<& /comp/tableend &>

<& /comp/footer &>

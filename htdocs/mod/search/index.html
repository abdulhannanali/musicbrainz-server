%# vi: set ts=2 sw=2 ft=mason :
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my (undef, undef, $filter) = $m->comp("setquery.inc", %ARGS);

my %all_status = reverse %{ ModDefs->status_as_hashref };

my %all_votes = reverse %{ ModDefs->vote_as_hashref };
delete $all_votes{&ModDefs::VOTE_UNKNOWN};

my %all_types = reverse %{ ModDefs->type_as_hashref };

</%perl>
<& /comp/sidebar, title => "Search Moderations" &>

<div class="LinksRow">
	[ <a href="?">Clear this form</a> ]
</div>

<p>
	You can use these filters to control which moderations are shown.&nbsp;
	When you're done, click "Query" to show the matching moderations.
</p>

<p>
	The "select" lists accept multiple selections (e.g. you can search for
	"Failed dependency or Failed prerequisite") - in most modern browsers
	you can select more than one entry by holding down the "control" key.
</p>

<form method="get" action="/mod/search/results.html" name="SearchMods">

	<table class="TopAlignCells SpacedColumns">
		<tr>
			<td>

				<h2>Status</h2>
				<select name="mod_status" multiple>
					<%perl>
					$m->comp(
						"/comp/options",
						[
							map { [ $_, Moderation::GetChangeName({ status => $_}) ] }
								sort { $a<=>$b }
								keys %all_status
						],
						$filter->{"mod_status"},
					);
					</%perl>
				</select>

				<h2>Automoderations</h2>
				<p>
% my $am = $filter->{"automod"};
					<input type="radio" name="automod" value="" <% ($am eq "") ? "checked" : "" %>> Any<br>
					<input type="radio" name="automod" value="1" <% ($am eq "1") ? "checked" : "" %>> Automoderations<br>
					<input type="radio" name="automod" value="0" <% ($am eq "0") ? "checked" : "" %>> Non-automoderations<br>
				</p>

			</td><td>

				<h2>Moderation Type</h2>
				<select name="mod_type" multiple size="18">
					<%perl>
					$m->comp(
						"/comp/options",
						[
							sort { $a->[1] cmp $b->[1] }
								map { [ $_, Moderation->ClassFromType($_)->Name ] }
								keys %all_types
						],
						$filter->{"mod_type"},
					);
					</%perl>
				</select>

			</td>
		</tr>
		<tr>
			<td>
	<h2>Moderator</h2>

	<p>
% my $mt = $filter->{"moderator_type"};
		<input type="radio" name="moderator_type" value="0" <% ($mt eq "0") ? "checked" : "" %>> Any moderator<br>
		<input type="radio" name="moderator_type" value="1" <% ($mt eq "1") ? "checked" : "" %>> FreeDB only<br>
		<input type="radio" name="moderator_type" value="2" <% ($mt eq "2") ? "checked" : "" %>> Any except FreeDB<br>
% if (my $id = $filter->{"moderator_id"}) {
		<input type="hidden" name="moderator_id" value="<% $id %>">
		<input type="radio" name="moderator_type" value="3" <% ($mt eq "3") ? "checked" : "" %>> Only
			<a href="/user/view.html?uid=<% $id %>"><% $filter->{"moderator_name"} %></a>
% } else {
		<input type="radio" name="moderator_type" disabled> Only
			<i>(no moderator selected)</i>
% }
			&nbsp; [ <a href="/mod/search/select-moderator.html?<% scalar $r->args %>">Change ...</a> ]<br>
		<input type="radio" name="moderator_type" value="4" <% ($mt eq "4") ? "checked" : "" %>> Me<br>
		<input type="radio" name="moderator_type" value="5" <% ($mt eq "5") ? "checked" : "" %>> Not me<br>
		<input type="radio" name="moderator_type" value="6" <% ($mt eq "6") ? "checked" : "" %>> Not me and not FreeDB<br>
	</p>
			</td>
			<td>
				<h2>Vote Cast</h2>

% my $vt = $filter->{"voter_type"};
		<input type="radio" name="voter_type" value="0" <% ($vt eq "0") ? "checked" : "" %>> My vote<br>
% if (my $id = $filter->{"voter_id"}) {
		<input type="hidden" name="voter_id" value="<% $id %>">
		<input type="radio" name="voter_type" value="1" <% ($vt eq "1") ? "checked" : "" %>>
			<a href="/user/view.html?uid=<% $id %>"><% $filter->{"voter_name"} %></a>'s vote
% } else {
		<input type="radio" name="voter_type" disabled>
			<i>(no moderator selected)</i>
% }
			&nbsp; [ <a href="/mod/search/select-moderator.html?is_voter=1&<% scalar $r->args %>">Change ...</a> ]<br>

				<br><select name="vote_cast" multiple>
					<%perl>
					$m->comp(
						"/comp/options",
						[
							map { [ $_, MusicBrainz::Server::Vote->GetVoteName($_) ] }
								sort { $a<=>$b }
								keys %all_votes
						],
						$filter->{"vote_cast"},
					);
					</%perl>
				</select>
			</td>
		</tr>
		<tr>
			<td>
	<h2>Artist</h2>

	<p>
% my $at = $filter->{"artist_type"};
		<input type="radio" name="artist_type" value="0" <% ($at eq "0") ? "checked" : "" %>> Any artist<br>
		<input type="radio" name="artist_type" value="1" <% ($at eq "1") ? "checked" : "" %>> "Various Artists" only<br>
		<input type="radio" name="artist_type" value="2" <% ($at eq "2") ? "checked" : "" %>> Any except "Various Artists"<br>
% if (my $id = $filter->{"artist_id"}) {
		<input type="hidden" name="artist_id" value="<% $id %>">
		<input type="radio" name="artist_type" value="3" <% ($at eq "3") ? "checked" : "" %>> Only
			<a href="/showartist.html?artistid=<% $id %>"><% $filter->{"artist_name"} %></a>
% } else {
		<input type="radio" name="artist_type" disabled> Only
			<i>(no artist selected)</i>
% }
			&nbsp; [ <a href="/mod/search/select-artist.html?<% scalar $r->args %>">Change ...</a> ]<br>
		<input type="radio" name="artist_type" value="4" <% ($at eq "4") ? "checked" : "" %>> My subscribed artists<br>
	</p>
			</td>
			<td>
	<h2>Sorting Order</h2>
	<p>
% my $o = $filter->{"orderby"};
		<input type="radio" name="orderby" value="asc" <% ($o eq "asc") ? "checked" : "" %>> Oldest first<br>
		<input type="radio" name="orderby" value="desc" <% ($o eq "desc") ? "checked" : "" %>> Newest first<br>
	</p>

			</td>
		</tr>

% my $object_type = $filter->{"object_type"};
% my $object_id = $filter->{"object_id"};
% if ($object_type and $object_id) {
		<tr>
			<td colspan="2">
				<h2>Specific Object</h2>
				<p>
					<input type="hidden" name="object_type" value="<% $object_type %>">
					<input type="radio" name="object_id" value="<% $object_id %>" checked> Only
					<%perl>
					if ($object_type eq "album") {
						$m->out("<a href='/showalbum.html?albumid=$object_id'>this album</a>");
					} elsif ($object_type eq "track") {
						$m->out("<a href='/showtrack.html?trackid=$object_id'>this track</a>");
					} else {
						$m->out("$object_type #$object_id");
					}
					</%perl><br>
					<input type="radio" name="object_id" value="0"> Anything<br>
				</p>
			</td>
		</tr>
% }

		<tr>
			<td colspan="2">
				<h2>Limit by Moderation ID</h2>
				<p>
					You can limit your search to a range of moderation IDs.&nbsp;
					This can be useful if your moderation query
					keeps getting cancelled because it's taking too long -
					you can make the range smaller.
				</p>
				<p>
					Not before
					#<input type="text" name="minid" size="8" maxlength="12"
						value="<% $filter->{'minid'}||'' %>">
					and not after
					#<input type="text" name="maxid" size="8" maxlength="12"
						value="<% $filter->{'maxid'}||'' %>">
				</p>
			</td>
		</tr>
		<tr>
			<td colspan="2" align="center">
				<br><br>
				<input type="submit" value="Query" style="padding: 0 3em">
			</td>
		</tr>
	</table>

</form>

<& /comp/footer &>

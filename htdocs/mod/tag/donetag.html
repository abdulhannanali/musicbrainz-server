<& /comp/sidebar, title=>'Done Tagging Albums', expand=>'moderate' &>

<%perl>

my ($mb, $id, $ar, $artist); 

$mb = new MusicBrainz;
$mb->Login();

if (!defined $session{user} || $session{user} eq '') {
</%perl>
    You must be logged in to edit the database.<p>
    <& /comp/tablebegin, title=>'Login' &>
    <& /comp/loginbox &>
    <& /comp/tableend &>
<%perl>
} 
else 
{
    my (@albums, @objs, $albumid, $al, $ar, $vartist);

    $vartist = 0;
    @albums = split / /, $session{tagged_albums};

    if (scalar(@albums) == 0)
    {
        mc_out("You have not tagged any albums.");
        return undef;
    }

    foreach $albumid (@albums)
    {
       $al = Album->new($mb->{DBH});
       $al->SetId($albumid);
       if (defined $al->LoadFromId())
       {
           $vartist++ if ($al->GetArtist() == Artist::VARTIST_ID);
           push @objs, $al;
       }
       else
       {
           mc_out("Count not load album " . $al->GetId() . ".");
       }
    }


</%perl>

    Now that you've selected the albums below, you can:
    <table>
% if ($vartist > 0 && $vartist !=  scalar(@objs)) {
    <tr>
      <td align="center">
      <font color="red">Merge Album<br>Not available</font>
      </td>
      <td>
      Merge albums is not available -- in order to merge tagged albums, the
      tagged albums must all be single artist albums or all multiple 
      artist albums.
    </tr>
% } elsif (scalar(@objs) == 1) {
    <tr>
      <td align="center">
      <font color="red">Merge Album<br>Not available</font>
      </td>
      <td>
      Merge albums is not available -- you must select multiple albums to
      merge.
    </tr>
% } else {
    <tr>
      <td>
      <form method="POST" action="/mod/tag/merge.html" name="Merge"
            enctype="application/x-www-form-urlencoded">
      <input type="submit" NAME="Submit" VALUE="Merge Albums">
%     my $ind = 0;
%     foreach $al (@objs) {
          <input type="hidden" name="key<% $ind %>" value="AlbumId<% $ind %>">
          <input type="hidden" name="value<% $ind++ %>" 
                 value="<% $al->GetId() %>">
%     }
      <input type="hidden" name="type"
             value="<% ModDefs::MOD_MERGE_ALBUM %>">
      <input type="hidden" name="artist" value="<% $objs[0]->GetArtist() %>">
      <input type="hidden" name="prev" value="N/A">
      <input type="hidden" name="table" value="Album">
      <input type="hidden" name="column" value="id">
      <input type="hidden" name="id" value="<% $objs[0]->GetId() %>">
      <input type="hidden" 
             name="url" value="/showalbum.html?albumid=<% $objs[0]->GetId() %>">
      </form>

      </td>
      <td>
      Merge all the tagged albums into one album, preserving all
      TRM ids and CD Index ids.
      </td>
    </tr>
% }
     <tr>
      <td>
      <form method="POST" action="/bare/enter_kv_mod.html" name="AddArtist"
            enctype="application/x-www-form-urlencoded">
      <input type="submit" NAME="Submit" VALUE="Delete Albums">
      </form>
      </td>
      <td>
      Delete all the tagged albums.
      </td>
    </tr>

    </form>
    </table>

    <hr>
    You tagged the following albums (shown in the order in which they
    were tagged):
    <p>

<%perl>

    # Sort by artist so that all the artists are sequential
    @objs = sort { $a->GetArtist() <=> $b->GetArtist()} @objs;

    $ar = Artist->new($mb->{DBH});
    foreach $al (@objs)
    {
       if ($ar->GetId() != $al->GetArtist())
       {
           $ar->SetId($al->GetArtist());
           if (not defined $ar->LoadFromId())
           {
              mc_out("Could not load artist " . $ar->GetId() . ".");
              next;
           }
           mc_comp("/comp/artisttitle", artist=>$ar, nomod=>1);
       }
       mc_comp("/comp/album", album=>$al, artist=>$ar, nomod=>1);
    }
</%perl>

% }
% $mb->Logout();

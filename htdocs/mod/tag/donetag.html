%# vi: set ts=4 sw=4 ft=mason :
<%args>
$reset=>0
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");

my $referer = $r->headers_in->{'Referer'} || "";

my @albums = split / /, $session{tagged_albums};
@albums = () if $reset;

push @albums, map { /AlbumId(\d+)/ } keys %ARGS;

# Remove dupes
my %temp = ();
@albums = grep { not $temp{$_}++ } @albums;

$session{tagged_albums} = join " ", @albums;

if (not @albums)
{
	return $m->comp(
		"/comp/error",
		"You have not selected any albums. Please go back"
		. " to the artist page and select some albums by clicking"
		. " on the checkbox on the right hand side in the album title.",
		1, 1,
	);
}

my @objs = map {
	my $albumid = $_;
	my $al = Album->new($mb->{DBH});
 	$al->SetId($albumid);

	$al->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Album #$albumid not found.",
			1, 1,
		);

	$al;
} @albums;

my %artist_ids;
++$artist_ids{$_->GetArtist} for @objs;
my $artist_id = ((keys(%artist_ids) == 1) ? $objs[0]->GetArtist : undef);

my $more_albums_url = "/search.html";
$more_albums_url = "/showartist.html?artistid=$artist_id" if $artist_id;

</%perl>

<& /comp/sidebar, title => 'Batch Operation on Albums' &>

<div style="width: 420px">

<p>
	You've selected the albums shown below, and now you can:
<p>

    <table bgcolor="black" cellpadding="5" cellspacing="1">
    <tr>
      <td valign="top" bgcolor="#f0efff">
      Merge all the selected albums into one album, preserving all
      TRM ids and CD Index ids.
% if (@objs < 2) {
	  <p>		
		<span style="color: red">
		Merge albums is not available - you must select
		multiple albums to merge.</span>&nbsp;
  		<a href="<% $more_albums_url %>">Select more albums ...</a>
	  </p>
% }
      </td>
      <td valign="top" bgcolor="#f0efff">
		<form method="post" action="/mod/tag/merge.html">
% for (@albums) {
			<input type="hidden" name="album" value="<% $_ %>">
% }
			<input type="hidden" name="mac" value="0">
			<input type="submit" value="Select" <% (@objs<2) ? "disabled" : "" %>>
		</form>
      </td>
    </tr>
     <tr>
      <td valign="top" bgcolor="#f0efff">
      Merge all the selected albums into one <b>various artist</b> album, 
      preserving all TRM ids and CD Index ids.
% if (@objs < 2) {
	  <p>		
		<span style="color: red">
		Merge albums is not available - you must select
		multiple albums to merge.</span>&nbsp;
  		<a href="<% $more_albums_url %>">Select more albums ...</a>
	  </p>
% }
      </td>
      <td valign="top" bgcolor="#f0efff">
		<form method="post" action="/mod/tag/merge.html">
% for (@albums) {
			<input type="hidden" name="album" value="<% $_ %>">
% }
			<input type="hidden" name="mac" value="1">
			<input type="submit" value="Select" <% (@objs<2) ? "disabled" : "" %>>
		</form>
      </td>
    </tr>
     <tr>
      <td valign="top" bgcolor="#f0efff">
      Remove all the selected albums.<br>
      </td>
      <td valign="top" bgcolor="#f0efff">
		<form method="post" action="/mod/tag/remove.html">
% for (@albums) {
			<input type="hidden" name="album" value="<% $_ %>">
% }
			<input type="submit" value="Select">
		</form>
      </td>
    </tr>
     <tr>
      <td valign="top" bgcolor="#f0efff">
      Apply album attributes to all selected albums.<br>
      </td>
      <td valign="top" bgcolor="#f0efff">
		<form method="post" action="/editalbumattrs.html">
% for (@albums) {
			<input type="hidden" name="id" value="<% $_ %>">
% }
			<input type="hidden" name="untag" value="1">
			<input type="submit" value="Select">
		</form>
      </td>
    </tr>
    <tr>
      <td valign="top" bgcolor="#f0efff">
      Change your mind and deselect all albums.<br>
      </td>
      <td valign="top" align="center" bgcolor="#f0efff">
      <form method="POST" action="/mod/tag/canceltag.html" name="AddArtist"
            enctype="application/x-www-form-urlencoded">
      <input type="submit" NAME="Submit" VALUE="Select">
      <input type="hidden" NAME="url" VALUE="<% $referer %>">

      </form>
      </td>
    </tr>
    </table>

<p>
	Alternatively, you don't have to do anything yet.&nbsp; You can
	<a href="<% $more_albums_url %>">go and tag more albums</a>
	and then return here to perform
	one of the operations above on all the selected albums.
<p>

<center>
      [ <a href="<% $referer %>">Go back</a> |
        <a href="/search.html">Search</a> ]
</center>

<hr>

<p>
    You selected the albums shown below.&nbsp; To remove one or more albums from
    this list, deselect the checkbox in the album title and click on
    the "Update" button at the bottom of this form:
</p>

<form method="post" action="/mod/tag/donetag.html">

	<%perl>

    # Sort by artist so that all the artists are sequential
    @objs = sort { $a->GetArtist() <=> $b->GetArtist()} @objs;

    my $ar = Artist->new($mb->{DBH});
	$ar->SetId(0);

	for my $al (@objs)
	{
		if ($ar->GetId != $al->GetArtist)
		{
			$ar->SetId($al->GetArtist);

			if (not $ar->LoadFromId)
			{
				$m->out("<p>Could not load artist #" . $ar->GetId() . "!</p>");
			   	next;
			}

			$m->comp(
				"/comp/artisttitle",
				artist => $ar,
				showmodlinks => 0,
			);
		}
		
	 	$m->comp(
			"/comp/album",
			album => $al,
			artist => $ar,
			showids => 1, 
			showtag => 1,
			tagchecked => 1,
			showmodlinks => 1,
		);
    }

	</%perl>
	
    <center>
		<input type="submit" NAME="Submit" VALUE="Update">
		<input type="hidden" NAME="url" VALUE="<% $referer %>">
		<input type="hidden" NAME="reset" VALUE="1">
	</center>

</form>

</div>

<& /comp/footer &>

<& /comp/sidebar, title=>'Done Tagging Albums', expand=>'moderate' &>

<%perl>

my ($mb, $id, $ar, $artist); 

$mb = new MusicBrainz;
$mb->Login();

if (!defined $session{user} || $session{user} eq '') {
</%perl>
    You must be logged in to edit the database.<p>
    <& /comp/tablebegin, title=>'Login' &>
    <& /comp/loginbox &>
    <& /comp/tableend &>
<%perl>
} 
else 
{
    my (@albums, @objs, $albumid, $al, $ar);

    @albums = split / /, $session{tagged_albums};

    if (scalar(@albums) == 0)
    {
        mc_out("You have not tagged any albums.");
        return undef;
    }

    foreach $albumid (@albums)
    {
       $al = Album->new($mb->{DBH});
       $al->SetId($albumid);
       if (defined $al->LoadFromId())
       {
           push @objs, $al;
       }
       else
       {
           mc_out("Count not load album " . $al->GetId() . ".");
       }
    }

</%perl>

    Now that you've selected the albums below, you can:<p>
    <table>
% if (scalar(@objs) == 1) {
    <tr>
      <td valign="top">
      <font color="red">Merge Album<br>Not available</font>
      </td>
      <td valign="top">
      Merge albums is not available -- you must select multiple albums to
      merge.<br>
      </td>
    </tr>
% } else {
    <tr>
      <td valign="top">
      <& comp/mergeform, type=>ModDefs::MOD_MERGE_ALBUM, 
                         link=>"/mod/tag/merge.html", 
                         objs=>\@objs &>
      </td>
      <td valign="top">
      Merge all the tagged albums into one album, preserving all
      TRM ids and CD Index ids.<br>
      </td>
    </tr>
     <tr>
      <td valign="top">
      <& comp/mergeform, type=>ModDefs::MOD_MERGE_ALBUM_MAC, 
                         link=>"/mod/tag/merge.html", 
                         objs=>\@objs &>
      </td>
      <td valign="top">
      Merge all the tagged albums into one <b>various artist</b> album, 
      preserving all TRM ids and CD Index ids.<br>
      </td>
    </tr>
% }
     <tr>
      <td valign="top">
      <& comp/mergeform, type=>ModDefs::MOD_REMOVE_ALBUMS, 
                         link=>"/mod/tag/remove.html", 
                         objs=>\@objs &>
      </td>
      <td valign="top">
      Remove all the tagged albums.<br>
      </td>
    </tr>
    <tr>
      <td valign="top" align="center">
      <form method="POST" action="/mod/tag/canceltag.html" name="AddArtist"
            enctype="application/x-www-form-urlencoded">
      <input type="submit" NAME="Submit" VALUE="Cancel">
      </form>
      </td>
      <td valign="top">
      Change your mind and stop tagging.<br>
      </td>
    </tr>

    </form>
    </table>

    <hr>
    You tagged the following albums (shown in the order in which they
    were tagged):
    <p>

<%perl>

    # Sort by artist so that all the artists are sequential
    @objs = sort { $a->GetArtist() <=> $b->GetArtist()} @objs;

    $ar = Artist->new($mb->{DBH});
    foreach $al (@objs)
    {
       if ($ar->GetId() != $al->GetArtist())
       {
           $ar->SetId($al->GetArtist());
           if (not defined $ar->LoadFromId())
           {
              mc_out("Could not load artist " . $ar->GetId() . ".");
              next;
           }
           mc_comp("/comp/artisttitle", artist=>$ar, nomod=>1);
       }
       mc_comp("/comp/album", album=>$al, artist=>$ar, nomod=>1);
    }
</%perl>

% }
% $mb->Logout();

<& /comp/footer &>

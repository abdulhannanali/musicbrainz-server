<%args>
$type
</%args>

% if ($type == ModDefs::MOD_MERGE_ALBUM) {
    <& /comp/sidebar, title=>'Confirm Merging Albums', expand=>'moderate' &>
% } else {
    <& /comp/sidebar, title=>'Confirm Merging Albums into Various Artist Album', expand=>'moderate' &>
% }

<%perl>

sub SwapItems
{
    my ($ref, $i, $j) = @_;
    my (@list, $temp);

    @list = @{$ref};
    $temp = $list[$i];
    $list[$i] = $list[$j];
    $list[$j] = $temp;

    return \@list;
}

my ($mb, $id, $ar, $artist); 
my (%merged, @id_numtracks);

$mb = mc_comp("/comp/dblogin");

if (!defined $session{user} || $session{user} eq '') {
</%perl>
    You must be logged in to edit the database.<p>
    <& /comp/tablebegin, title=>'Login' &>
    <& /comp/loginbox &>
    <& /comp/tableend &>
<%perl>
} 
else 
{
    my ($i, $key, $al, @tracks, $tr, @objs, @ids, $di);

    foreach $key (keys %ARGS)
    {
       if ($ARGS{$key} =~ /^AlbumId/ && $key =~ m/^key(\d+)/)
       {
           $al = Album->new($mb->{DBH});
           $al->SetId($ARGS{"value$1"});
           push @objs, $al if (defined $al->LoadFromId())
       }
    }

    $ar = Artist->new($mb->{DBH});
    $di = Discid->new($mb->{DBH});
    $i = 0;
    foreach $al (@objs)
    {
       @tracks = $al->LoadTracks();
       foreach $tr (@tracks)
       {
           $merged{$tr->GetSequence()}++;
       }

       @ids = $di->GetDiscidFromAlbum($al->GetId());
       foreach $id (@ids)
       {
           if ($id->{toc} =~ /^\d* (\d*)/)
           {
               push @id_numtracks, $1;
           }
       }
       
       if ($i == 0)
       {
           </%perl>
           Please review the proposed album merge moderation and then
           confirm this moderation at the bottom of this page.<p>
           All of the albums below this one will be merged into this album:<p>
           <%perl>
       }
       if ($i == 1)
       {
           </%perl>
           All of the albums below will be merged into the above album:<p>
           <%perl>
       }
       if ($ar->GetId() != $al->GetArtist())
       {
           $ar->SetId($al->GetArtist());
           if (not defined $ar->LoadFromId())
           {
              mc_out("Could not load artist " . $ar->GetId() . ".");
              next;
           }
           mc_comp("/comp/artisttitle", artist=>$ar, nomod=>1);
       }

       </%perl>
       <table>
       <tr>
         <td width="420"><& /comp/album, album=>$al, artist=>$ar, nomod=>1 &></td>
         <td valign="top" align="center">
%            if ($i > 0) {
                 <& comp/mergeform, type=>$type,
                                    link=>"/mod/tag/merge.html",
                                    objs=>SwapItems(\@objs, $i, $i -1),
                                    text=>"Move Up" &>
                 <br>
%            }
%            if ($i < scalar(@objs) - 1) {
             <& comp/mergeform, type=>$type,
                                link=>"/mod/tag/merge.html",
                                objs=>SwapItems(\@objs, $i, $i + 1),
                                text=>"Move Down" &>
%            }
          </td>
       </tr>
       </table>
       <%perl>

       $i++;
    }
}

my $final = scalar(keys %merged);
my $merge_ok = 1;

foreach (@id_numtracks)
{
   if ($_ != $final)
   {   
      $merge_ok = 0;
      last;
   }
}
</%perl>

<br>
<p>
% if (!$merge_ok) {
      <font size="+1" color="red">Error:</font> these albums cannot be merged together, 
      since they have CD Index ids that belong to albums that have more or fewer than
      the <% $final %> tracks that the merged album would have.
%     $mb->Logout();
      <& /comp/footer &>
%     return undef;
% }


<blockquote>

% if ($type == ModDefs::MOD_MERGE_ALBUM) {
    <& /comp/tablebegin, title=>'Confirm Merging Albums' &>
% } else {
    <& /comp/tablebegin, title=>'Confirm Merging Albums into Various Artist Album' &>
% }

<FORM METHOD="POST" ACTION="/bare/enter_kv_mod.html" NAME="MergeConfirm"
      ENCTYPE="application/x-www-form-urlencoded">  

<table width="100%">
  <tr>
    <td colspan="2">
% if ($type == ModDefs::MOD_MERGE_ALBUM) {
    Are you sure you want to merge the albums above?
% } else {
    Are you sure you want to merge the albums above into one 
    Various Artist album?
% }
    </td>
  </tr>
  <tr>
    <td>
    &nbsp;
    </td>
    <td>
    <INPUT TYPE="radio" NAME="confirm0" SIZE=25 value="yes"
        ondblclick="this.form.submit()"
        > Yes
    </td>
  </tr>
  <tr>
    <td>
    &nbsp;
    </td>
    <td>
    <INPUT TYPE="radio" NAME="confirm0" SIZE=25 value="no" CHECKED
        ondblclick="this.form.submit()"
        > No
    </td>
  </tr>
  <tr>
    <td colspan=2>
    <INPUT TYPE="submit" NAME="Submit" VALUE="Submit">    
    </td>
  </tr>
</table>

% my $key;
% foreach $key (keys %ARGS) {
    <input type="hidden" name="<% $key %>" value="<% $ARGS{$key} %>">
% }

</form>
<& /comp/tableend &>
</blockquote>

% $mb->Logout();

<& /comp/movefocus, "MergeConfirm", "confirm0", 0 &>
<& /comp/footer &>

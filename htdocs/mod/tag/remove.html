%# vi: set ts=4 sw=4 ft=mason :
<%args>
@album => ()
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

for my $album (@album)
{
	MusicBrainz::IsNonNegInteger($album) && $album
		or return $m->comp("/comp/badargs", 1, 1);
}

my $mb = $m->comp("/comp/dblogin");

my @objs;
my %artists;

for my $album (@album)
{
	my $al = Album->new($mb->{DBH});
	$al->SetId($album);

	$al->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Album #$album does not exist",
			1, 1,
		);

	push @objs, $al;

	# TODO move this method to somewhere more suitable
	$al->{_name_} = Moderation->_normalise_strings($al->GetName);

	my $artist = $al->GetArtist;

	unless ($artists{$artist})
	{
		my $ar = Artist->new($mb->{DBH});
		$ar->SetId($artist);

		$ar->LoadFromId
			or return $m->comp(
				"/comp/error",
				"Artist #$artist does not exist",
				1, 1,
			);

		$artists{$artist} = $ar;
		$ar->{_sortname_} = Moderation->_normalise_strings($ar->GetSortName);
	}

	push @{ $artists{$artist}{_albums_} }, $al;
}

my $url = "/search.html";

if ($ARGS{confirm})
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_REMOVE_ALBUMS,
				# --
				albums => \@objs,
			);

			delete $session{'tagged_albums'};
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title => 'Confirm Remove Albums' &>

<h2>Confirm Remove Albums</h2>

<p>
    Please review the list of albums to be deleted, and then
	confirm this moderation at the bottom of this page.
</p>

<p>
	All of these albums will be removed:
</p>

<%perl>
for my $ar (sort { $a->{_name_} cmp $b->{_name_} } values %artists)
{
	$m->comp(
		"/comp/artisttitle",
		artist => $ar,
		nomod => 1,
	);

	for my $al (sort { $a->{_name_} cmp $b->{_name_} } @{ $ar->{_albums_} })
    {
		$m->comp(
			"/comp/album",
			album => $al,
			artist => $ar,
			nomod => 1,
		);
    }
}
</%perl>

<h2>Confirm Album Removal</h2>

<p>
	Are you sure you want to remove the above albums?
</p>

<form method="get" action="<% $url %>"
	name="ModFormNo"
	onsubmit="history.go(-1); return false"
	style="float: left; margin-right: 2em; margin-top: 0"
	>
	<div>
		<input type="submit" value="&lt;&lt; NO">
	</div>
</form>

<form method="post" action="/mod/tag/remove.html"
	name="ModFormYes"
	style="margin: 0"
	>
	<div>
% for my $album (@album) {
		<input type="hidden" name="album" value="<% $album %>">
% }
		<input type="hidden" name="confirm" value="1">
		<input type="submit" value="YES &gt;&gt;">
	</div>
</form>

<& /comp/movefocus, "ModFormNo", 0 &>
<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$uid=>0
$user=>""
$update=>0
$password1=>""
$password2=>""
$bio=>""
$email=>""
$weburl=>""
</%args>

<& /comp/sidebar, title=>'Moderator Profile' &>

<%perl>

my $mb = $m->comp("/comp/dblogin");
my $ui = UserStuff->new($mb->{DBH});

if ($user ne "")
{
    (undef, $uid) = $ui->GetUserPasswordAndId($user);
}

if (!defined $uid || $uid == 0) 
{
    </%perl>
    <form METHOD="POST" ACTION="/moderator.html"
          ENCTYPE="application/x-www-form-urlencoded">
       Lookup a moderator by name:<br>
       <input type="text" name="user" size="20">
       <INPUT TYPE="submit" NAME="Submit" VALUE="Lookup">
    </form>
    <& /comp/footer &>
    <%perl>
    $mb->Logout();
    return undef;
}

if ($update && $session{uid} != $uid)
{
    $m->out("You can't update someone else's configuration, smartass!");
    $mb->Logout();
    return undef;
}

my $info = $ui->newFromId($uid);

if (!defined $info)
{
     $m->out("User $uid was not found.");
     $m->comp("/comp/footer");
     $mb->Logout();
     return undef;
}

if ($update > 1)
{ 
    $bio =~ s/<.*?>//g;
    $bio =~ s/\r//g;
    $bio =~ s/\n/<p>/g;
    if ($password1 ne $password2)
    {
        </%perl>
        The given passwords do not match. Please go back and re-enter
        the passwords.
        <& /comp/footer &>
        <%perl>
        $mb->Logout();
        return undef;
    }
    if ($email =~ /\S/ and !$ui->CheckEMailAddress($email))
    {
        </%perl>
        The email address you entered is not a valid email address. Please go back
        and enter a valid email address, or leave the email field blank for no email 
        address.
        <& /comp/footer &>
        <%perl>
        $mb->Logout();
        return undef;
    }
	if ($info->GetEmail ne $email)
    {
		if ($email =~ /\S/)
		{
			my $ret = $info->SendVerificationEmail($email);
			if ($ret)
			{
				</%perl>
				<p>
				The email verification mail could not be sent: <b><% $ret %></b>.
				Your email address has not been updated.
				</p>
				<%perl>
			}
			else
			{
				</%perl>
				<p>
				The email verification mail has been sent to <b><% $email %></b>.
				Please check your mailbox and click on the link in the email to 
				verify the new email address.
				</p>
				<%perl>
			}

			# Reset the email address to the old one since this one has
			# not been verified yet.
			$email = $info->GetEmail;
		} else {
			# The user wants to blank out their email address.
			$email = "";

			</%perl>
			<p>
				Your e-mail address has been removed.&nbsp;
				Please note that if you add it in again in the future,
				you will be asked to verify it again.
			</p>
			<%perl>
		}
    }
    $ui->SetUserInfo($uid, $email, $password1, $weburl, $bio);

    $m->out("Your information was updated.<p>");
    $update = 0;
}


my $membersince = $m->comp("/comp/datetime", $info->GetMemberSince);

if ($info->GetMemberSince eq "1970-01-01 00:00:00 UTC")
{
    $membersince = '<font class="bold">Charter Member</font>';
} 
if ($info->GetName eq "rob")
{
    $membersince = '<font class="bold">the dawn of this project</font>';
} 
$mb->Logout();

</%perl>

<FORM METHOD="POST" ACTION="/moderator.html"
      ENCTYPE="application/x-www-form-urlencoded">
<table>
<tr>
    <td colspan="2"><b>General information:</b></td>
</tr>
<tr>
    <td width="15%" valign="top" align="right">Name:</td>
    <td><% $info->GetName %></td>
</tr>
<tr>
    <td width="15%" valign="top" align="right">User type:</td>
    <td><% $info->GetUserType %></td>
</tr>
% if ($session{uid} == $uid && $update) {
<tr>
    <td valign="top" align="right">Password:</td>
    <td><input type="password" name="password1" size="40"></td>
</tr>
<tr>
    <td valign="top" align="right">Verify password:</td>
    <td><input type="password" name="password2" size="40"><br>
        (Leave the two fields above blank to not change your password)</td>
</tr>
<tr>
    <td colspan="2">&nbsp;</td>
</tr>
% }
<tr>
    <td valign="top" align="right">EMail:</td>
% if ($session{uid} == $uid) {
%     if ($update) {
        <td><input type="text" name="email" size="40" 
                   value="<% $info->GetEmail %>"><br>
            (If you enter a new email address, you will be required to
            verify the new email address)
        </td>
%     } else {
        <td><% $info->GetEmail || "[none specified/not verified]" %></td>
%     }
% } else {
    <td><% $info->GetEmail ne '' ? "[not shown]" : "[none specified]" %></td>
% }
</tr>

<tr>
    <td valign="top" align="right">Homepage:</td>
% if ($update) {
    <td><input type="text" name="weburl" size="40" 
               value="<% $info->GetWebURL %>">
    </td>
% } else {
%   if ($info->GetWebURL ne "") {    
		<td><a href="<% $info->GetWebURL %>"><% $info->GetWebURL %></a></td>
%   } else {
       <td>[none specified]</td>
%   }
% }
</tr>
<tr>
    <td valign="top" align="right">Bio:</td>
% if ($update) {
%   (my $t = $info->GetBio) =~ s/<p>/\n/g;
    <td><textarea name="bio" cols=40 rows=10><% $t %></textarea><br>
    (No HTML tags, please!)
    </td>
% } else {
    <td><% ($info->GetBio || "[none specified]") |n %></td>
% }
% if (!$update) {
<tr>
    <td colspan="2">&nbsp;</td>
</tr>
<tr>
    <td colspan="2"><b>User statistics:</b></td>
</tr>
<tr>
    <td valign="top" align="right">Member Since:</td>
    <td valign="top"><% $membersince |n %></td>
</tr>
<tr>
    <td valign="top" align="right">Mods Accepted:</td>
	<td valign="top"><% $info->GetModsAccepted %></td>
</tr>
<tr>
    <td valign="top" align="right">Mods Rejected:</td>
    <td valign="top"><% $info->GetModsRejected %></td>
</tr>
<tr>
	<td></td>
	<td valign="top">[ 
    <a href="/user/mod_email.html?uid=<% $uid %>&url=<% "/moderator.html?uid=$uid" %>">Send email</a> | 
    <a href="/moderate.html?type=<% &ModDefs::TYPE_MODERATOR %>&amp;moderator=<% $uid %>">List Moderations</a> |
	<a href="/moderate.html?type=<% &ModDefs::TYPE_MODERATOR_FAILED %>&amp;moderator=<% $uid %>">List Failed Moderations</a>
% if ($session{uid} == $uid) {
	| <a href="/user/subscriptions.html">Subscriptions</a>
% }
	]</td>
</tr>
% }
% if ($session{uid} == $uid) {
<tr>
    <td colspan="2">&nbsp;</td>
</tr>
<tr>
    <td>&nbsp;</td>
    <td>
        <INPUT TYPE="hidden" NAME="uid" VALUE="<% $uid %>">
% if ($update == 1) {
        <INPUT TYPE="hidden" NAME="update" VALUE="2">
        <INPUT TYPE="submit" NAME="Submit" VALUE="Save Changes">
% } else {
        <INPUT TYPE="hidden" NAME="update" VALUE="1">
        <INPUT TYPE="submit" NAME="Submit" VALUE="Update Profile">
% }
    </td>
</tr>
% }

</table>
</FORM>

<hr>
<form METHOD="POST" ACTION="/moderator.html"
	name="ModeratorForm"
      ENCTYPE="application/x-www-form-urlencoded">
   Lookup a moderator by name:<br>
   <input type="text" name="user" size="20">
   <INPUT TYPE="submit" NAME="Submit" VALUE="Lookup">
</form>

<& /comp/movefocus, "ModeratorForm", "user" &>
<& /comp/footer &>

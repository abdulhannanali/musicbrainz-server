<%args>
$diskid=>""
$albumid=>0
$artistid=>0
$confirm=>0
</%args>

<& /comp/sidebar, title=>'Move Diskid', expand=>'moderate' &>

<%perl>

my ($mb, $ar, @albums, $albumname, $al, $di, $count);
my ($id, @diskid_refs, $ref, @tracks, $numtracks); 

if ($confirm)
{
    mc_comp("/comp/confirmmod", 
            title=>"Confirm Move Diskid",
            args=>{ %ARGS });
    return undef;
}

if ($diskid eq '' || $albumid == 0 || $artistid == 0)
{
    mc_comp("/comp/badargs");
    return undef;
}

$mb = new MusicBrainz;
$mb->Login();

$ar = Artist->new($mb->{DBH});
$al = Album->new($mb->{DBH});
$di = Diskid->new($mb->{DBH});

$al = Album->new($mb->{DBH});
$al->SetId($albumid);
$al->LoadFromId();

$ar->SetId($artistid);
@albums = $ar->GetAlbums();
if (scalar(@albums) == 0)
{
    mc_out("Cannot load albums for artist $artistid\n");
    return undef;
}
  
@diskid_refs = $di->GetDiskIdFromAlbum($albumid);
if (scalar(@diskid_refs) == 0)
{
    mc_out("Invalid diskid and album passed.\n");
    return undef;
}

$id = -1;
foreach $ref (@diskid_refs)
{
    if ($ref->{diskid} eq $diskid)
    {
        $id = $ref->{id};
        if ($ref->{toc} =~ /^\d+ (\d+)/)
        {
           $numtracks = $1;
        }
        last;
    }
}

if ($id < 0)
{
    mc_out("Invalid diskid and album passed.\n");
    return undef;
}

</%perl>

% if (!defined $session{user} || $session{user} eq '') {
    You must be logged in to edit the database.<p>
    <& /comp/tablebegin, title=>'Login' &>
    <& /comp/loginbox &>
    <& /comp/tableend &>
% } else {


%     $count = 0;
%     foreach $ref (@albums) {
%        next if ($ref->GetId() == $albumid);
%        next if ($ref->GetArtist() == Artist::VARTIST_ID);
%        @tracks = $ref->LoadTracks();
%        next if ($numtracks != scalar(@tracks));
%        if ($count == 0) {
            Select a new album for CD Index Id 
            <span class="bold"><% $diskid %></span>:<p>
%        }
%        $count++;
            <form method="POST" action="/movediskid.html"
                  enctype="application/x-www-form-urlencoded" class="formstyle">
              <table width="100%">
              <tr>
                <td width="100%">
                   <& /comp/album, artist=>$ar, album=>$ref, nomod=>1 &>
                </td>
                <td align="right" valign="top">
                   <input type="submit" value="Select <% $albumname %>>>"
                          name="Select">
                   <input type="hidden" name="confirm_message" 
                          value="Are you sure you want to move CD Index id <% '<font class="bold">' . $diskid . '</font>' |h %> to album <% '<font class="bold">' . $ref->GetName() .'</font>' |h %>?">


                   <input type="hidden" name="key0" value="NewAlbumId">
                   <input type="hidden" name="value0" 
                          value="<% $ref->GetId() %>">
                   <input type="hidden" name="key1" value="OldAlbumName">
                   <input type="hidden" name="value1" 
                          value="<% $al->GetName() %>">
                   <input type="hidden" name="key2" value="NewAlbumName">
                   <input type="hidden" name="value2" 
                          value="<% $ref->GetName() %>">
                   <input type="hidden" name="key3" value="DiskId">
                   <input type="hidden" name="value3" 
                          value="<% $diskid %>">
                   <input type="hidden" name="confirm" value="1">
                   <input type="hidden" name="artist" value="<% $artistid %>">
                   <input type="hidden" name="type"
                          value="<% ModDefs::MOD_MOVE_DISKID %>">
                   <input type="hidden" name="prev" value="<% $albumid %>">
                   <input type="hidden" name="table" value="Diskid">
                   <input type="hidden" name="column" value="Disk">
                   <input type="hidden" name="id" value="<% $id %>">
                   <input type="hidden" 
                          name="url" 
                          value="/showalbum.html?albumid=<% $albumid %>">
                </td>
              </tr>
              </table>
            </form>
%     }
%     if ($count == 0) {
      <p>This artist does not have any albums with <% $numtracks %> tracks
      and therefore the id <% $diskid %> cannot be moved.<p>
      <a href="/showalbum.html?albumid=<% $albumid %>">Back</a> to
      album <% $al->GetName() %>.
%     } else {
      NOTE: Only albums with the <% $numtracks %> tracks have been shown.
%     }
% }
% $mb->Logout();
<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$table => undef
$search => undef
$limit => 25
</%args>

<%perl>

use SearchEngine qw( :constants );

if ( defined $table && defined $search)
{
	my $mb = $m->comp("/comp/dblogin");

    my $engine = SearchEngine->new($mb->{DBH});
	$engine->Table($table);

	# TODO validate $limit

	$engine->Search(
		query => $search,
		limit => $limit,
	);

    if ($engine->Rows == 1) 
    {
        my ($row, $url);
        
        $row = $engine->NextRow;
        if ($engine->Table eq 'Album') 
        {
			$url = "/showalbum.html?albumid=$row->{'albumid'}";
        }
        elsif ($engine->Table eq 'Artist') 
        {
			$url = "/showartist.html?artistid=$row->{'artistid'}";
        }
        elsif ($engine->Table eq 'Track') 
        {
			$url = "/showtrack.html?trackid=$row->{'trackid'}";
        }
        if (defined $url)
        {
           $r->method('GET');
           $r->headers_in->unset('Content-length');
           $r->content_type('text/html');
           $r->header_out(Location=>$url);
           $r->status(302);
           $mb->Logout();
           return undef;
        }
    }
</%perl>

<& /comp/sidebar, title=>$table . ' Search Results: '.$search &>

    <& /comp/tablebegin, title=>"Found" &>
    <table border="0" cellspacing="0" cellpadding="4" id="SearchResults">
        <tr>
%    if ($table eq 'Album') {
		<th colspan="3">Summary</th>
		<th>Album Title</th>
		<th>Artist</th>
%    } elsif ($table eq 'Artist') {
        <th>Artist Name</th>
%    } elsif ($table eq 'Track') {
		<th>Track Title</th>
		<th>Artist Name</th>
		<th>Album</th>
%    }
        </tr>

%	if ($engine->Result == SEARCHRESULT_NOQUERY) {

		<tr><td align="center"><font class="bold"><p>Nothing to search for!</font><p></td></tr>
		<tr><td>
			Please enter a search phrase including
			letters and/or numbers.
		</td></tr>

%	} elsif ($engine->Result == SEARCHRESULT_TIMEOUT) {

		<tr><td align="center"><font class="bold"><p>Your search has been cancelled</font><p></td></tr>
		<tr><td>
			Your search has been cancelled because it was taking too
			long.&nbsp;
			Please try changing your search criteria, or try again later.
		</td></tr>

%   } elsif ($engine->Rows == 0) {

        <tr><td align="center"><font class="bold"><p>No matching <% $table %>s found.</font><p></td></tr>

        <tr><td>Please consider 
        <a href="/freedb/freedb.html?search=<% url_escape($search) %>">importing</a> 
        the artist/album/track(s) 
        you are looking for from freedb for insertion into MusicBrainz.
        </a></td></tr>

%    }

%   my $bgcolor= '#ffffff';
%   while ( my $row = $engine->NextRow ) {
        <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
%       if ($engine->Table eq 'Album') {
% if ($row->{tracks}) {
			<td class="trk"><% $row->{tracks} %>&nbsp;<img src="/images/notes.gif" alt="Tracks"></td>
% } else {
			<td></td>
% }
% if ($row->{discids}) {
			<td class="did"><% $row->{discids} %>&nbsp;<img src="/images/cd.gif" alt="disc ids"></td>
% } else {
			<td></td>
% }
% if ($row->{trmids}) {
			<td class="trm"><% $row->{trmids} %>&nbsp;<img src="/images/trm.gif" alt="TRM ids"></td>
% } else {
			<td></td>
% }
            <td><a href="/showalbum.html?albumid=<% $row->{'albumid'} %>"><% $row->{'albumname'} %></a></td> 
            <td><a href="/showartist.html?artistid=<% $row->{'artistid'} %>"><% $row->{'artistname'} %></a></td> 
%       } elsif ($engine->Table eq 'Artist') {
            <td><a href="/showartist.html?artistid=<% $row->{'artistid'} %>"><% $row->{'artistname'} %></a></td> 
%       } elsif ($engine->Table eq 'Track') {
            <td><a href="/showtrack.html?trackid=<% $row->{'trackid'} %>"><% $row->{'trackname'} %></a></td> 
            <td><a href="/showartist.html?artistid=<% $row->{'artistid'} %>"><% $row->{'artistname'} %></a></td> 
            <td><a href="/showalbum.html?albumid=<% $row->{'albumid'} %>"><% $row->{'albumname'} %></a></td> 
%       }
        </tr>
%   }
    </table>
    <& /comp/tableend &>
    <& /comp/tablebegin, title=>'Search Again', attrs=>"align=left", gattrs=>"width='100%'" &>
%   $mb->Logout();
% } else {
<& /comp/sidebar, title=>'Search' &>
    <& /comp/tablebegin, title=>'Search', attrs=>"align=left", 
                         attrs=>'width="300"' &>
% }
    <br>
    <& /comp/textsearch, default=>$table, text=>$search, limit => $limit &>
    <br>
    &nbsp;
  <& /comp/tableend &>

<& /comp/movefocus, "TextSearchForm", "search" &>
<& /comp/footer &>

<%args>
$table => undef
$search => undef
$limit => undef
$all_words => undef
</%args>

<%perl>
use SearchEngine;
if ( defined $table && defined $search)
{
    my $bgcolor= '#ffffff';
    my $mb = mc_comp("/comp/dblogin");
    my $engine = SearchEngine->new($mb->{DBH});
    $engine->Table($table);
    $engine->AllWords($all_words);
    $engine->Limit($limit) if $limit;
    $engine->Search($search);
    if ($engine->Rows == 1) 
    {
        my ($row, $url);
        
        $row = $engine->NextRow;
        if ($engine->Table eq 'Album') 
        {
           $url = "/showalbum.html?albumid=" . $row->[0];
        }
        elsif ($engine->Table eq 'Artist') 
        {
           $url = "/showartist.html?artistid=" . $row->[0];
        }
        elsif ($engine->Table eq 'Track') 
        {
           $url = "/showtrack.html?trackid=" . $row->[0];
        }
        if (defined $url)
        {
           $r->method('GET');
           $r->headers_in->unset('Content-length');
           $r->content_type('text/html');
           $r->header_out(Location=>$url);
           $r->status(302);
           $mb->Logout();
           return undef;
        }
    }
</%perl>

<& /comp/sidebar, title=>$table . ' Search Results: '.$search &>
    <& /comp/tablebegin, title=>"Found" &>
    <table border="0" cellspacing="0" cellpadding="4">
        <tr>
%    if ($table eq 'Album') {
        <th>Album Title</th> <th>Artist</th>
%    } elsif ($table eq 'Artist') {
        <th>Artist Name</th>
%    } elsif ($table eq 'Track') {
        <th>Track Title</th><th>Artist Name</th>
%    }
        </tr>

%    if ($engine->Rows == 0) {

        <tr><td>No matching <% $table %>s found.</td></tr>

%    }

%   while ( my $row = $engine->NextRow ) {
        <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
%       if ($engine->Table eq 'Album') {
            <td><a href="/showalbum.html?albumid=<% $row->[0] %>"><% $row->[1] %></a></td> 
            <td><a href="/showartist.html?artistid=<% $row->[2] %>"><% $row->[3] %></a></td> 
%       } elsif ($engine->Table eq 'Artist') {
            <td><a href="/showartist.html?artistid=<% $row->[0] %>"><% $row->[1] %></a></td> 
%       } elsif ($engine->Table eq 'Track') {
            <td><a href="/showtrack.html?trackid=<% $row->[0] %>"><% $row->[1] %></a></td> 
            <td><a href="/showartist.html?artistid=<% $row->[2] %>"><% $row->[3] %></a></td> 
%       }
        </tr>
%   }
    </table>
    <& /comp/tableend &>
    <& /comp/tablebegin, title=>'Search Again', attrs=>"align=left", gattrs=>"width=100%" &>
%   $mb->Logout();
% } else {
<& /comp/sidebar, title=>'Search' &>
    <& /comp/tablebegin, title=>'Search', attrs=>"align=left", 
                         attrs=>'width="300"' &>
% }
    <br>
    <& /comp/textsearch, default=>$table, text=>$search &>
    <br>
    &nbsp;
  <& /comp/tableend &>
<& /comp/footer &>

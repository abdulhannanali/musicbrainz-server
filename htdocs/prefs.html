%# vi: set ts=4 sw=4 ft=mason :
<%perl>

$m->comp("/comp/checkloggedin", 1, 1,
	"You must log in to change your preferences.",
	)
	or return;

my $saved = 0;

if ($ARGS{"SavePrefs"})
{
	# Insert zeroes for checkboxes which weren't submitted
	for (qw(
		mod_add_album_inline
		JSMoveFocus
		sitemenu_heavy
		sidebar_panel_search
		sidebar_panel_stats
		sidebar_panel_topmods
		nosidebar
	)) {
		$ARGS{$_} = 0 if not defined $ARGS{$_};
	}

	for my $key (UserPreference::valid_keys())
	{
		UserPreference::set($key, $ARGS{$key})
			if defined $ARGS{$key};
	}

	my $mb = $m->comp("/comp/dblogin");
	my $ui = UserStuff->new($mb->{DBH});

	$saved = eval { UserPreference::SaveForUser($ui->Current) };

	if (not $saved)
	{
		my $err = $@;
		</%perl>
		<& /comp/sidebar, title => "Error Saving Preferences" &>
		<p>
			An error occurred while trying to save your preferences.&nbsp;
			Sorry about that.
		</p>
		<& /comp/footer &>
		<%perl>
	}
}

require POSIX;
my $time = POSIX::mktime(24,56,13,31,11,101,0,0,0);

my @format_list = map {
	[ $_, $m->comp("/comp/datetime", { datetimeformat=> $_, tz=>'UTC' }, $time) ]
} UserPreference::allowed_datetime_formats();

$time = time();

</%perl>

<& /comp/sidebar, title=>'Preferences' &>

<p class="LinksRow">
	[
	<a href="/user/view.html">Profile &amp; Statistics</a>
	| <a href="/user/subscriptions.html">Subscriptions</a>
	]
</p>

% if ($saved) {
<p class="notice">
	Your preferences have been saved.
</p>
% }

<form method="post" action="/prefs.html" name="Preferences">
	<input type="hidden" name="SavePrefs" value="1">

	<h2>Moderation Pages</h2>

	<p>
		<input type="checkbox" name="mod_add_album_inline"
			<% UserPreference::get('mod_add_album_inline') ? "checked" : "" %>
			>
		For "Add Album" mods, show the whole album
	</p>

	<p>
		Show up to
		<input type="text" name="mods_per_page"
			size=3
			value="<% UserPreference::get('mods_per_page') %>"
			>
		mods per page (max: 25)
	</p>

	<h2>Artist Page (List of Releases)</h2>

	<p>
		Default to a "compact" listing when there are
		<input type="text" name="releases_show_compact"
			size=3
			value="<% UserPreference::get('releases_show_compact') %>"
			>
		releases or more.&nbsp;
		(allowed range: 1-100)
	</p>

	<h2>Date/Time Display</h2>

	<p>
		Your preferred date/time format:
		<select name="datetimeformat">
			<& /comp/options, \@format_list,
			UserPreference::get('datetimeformat') &>
		</select>
	</p>
	<p>
		Your preferred time zone:
		<select name="timezone">
			<& /comp/options, [ UserPreference::allowed_timezones() ],
			UserPreference::get('timezone') &>
		</select>
	</p>

	<p>
		The time now (using your preferences) is
		<b><% $m->comp("/comp/datetime", $time) %></b>
		and 180 days' time is
		<b><% $m->comp("/comp/datetime", $time+180*86400) %></b>
	</p>

	<h2>Use of Javascript</h2>

	<p>
		<input type="checkbox" name="JSMoveFocus"
			<% UserPreference::get('JSMoveFocus') ? "checked" : "" %>
			>
		Use Javascript to move the input focus when the page loads
	</p>

	<h2>HTML Features</h2>

	<p>
		<input type="checkbox" name="sitemenu_heavy"
			<% UserPreference::get('sitemenu_heavy') ? "checked" : "" %>
			>
		Load the full version of the "site menu" (more dynamic, but slower page loads)
	</p>

	<p>
		Sidebar panels:
	</p>

	<ul style="list-style: none">
		<li>
			<input type="checkbox" name="sidebar_panel_search"
				<% UserPreference::get('sidebar_panel_search') ? "checked" : "" %>
				> Quick Search
		</li>
		<li>
			<input type="checkbox" name="sidebar_panel_topmods"
				<% UserPreference::get('sidebar_panel_topmods') ? "checked" : "" %>
				> Top Moderators
		</li>
		<li>
			<input type="checkbox" name="sidebar_panel_stats"
				<% UserPreference::get('sidebar_panel_stats') ? "checked" : "" %>
				> Server Stats
		</li>
	</ul>

	<p>
		<input type="checkbox" name="nosidebar"
			<% UserPreference::get('nosidebar') ? "checked" : "" %>
			>
		Don't show the sidebar at all (even faster, but it makes it
		rather hard to navigate the site)
	</p>

	<p>
		<input type="submit" value="Update">
	</p>

</form>

<& /comp/movefocus, "Preferences", "mod_add_album_inline" &>
<& /comp/footer &>

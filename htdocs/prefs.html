%# vi: set ts=4 sw=4 ft=mason :
<%perl>

$m->comp("/comp/checkloggedin", 1, 1,
	"You must log in to change your preferences.",
	)
	or return;

$session{orig_privs} = $session{privs}
	if not exists $session{orig_privs};

my $saved = 0;

my $countries_menu = $m->comp("/mod/edit-releases/countries-menu.inc");
my $countries_menu_2 = [ [ 0, "[none]" ], @$countries_menu ];

my $mb = $m->comp("/comp/dblogin");
my $ui = UserStuff->new($mb->{DBH});

if ($ARGS{"SavePrefs"})
{
	# Insert zeroes for checkboxes which weren't submitted
	for (qw(
		mod_add_album_inline
		mod_add_album_link
		navbar_mod_show_select_page
		JSMoveFocus
		reveal_address_when_mailing
		show_amazon_coverart
		sitemenu_heavy
		sidebar_panel_search
		sidebar_panel_stats
		sidebar_panel_topmods
		nosidebar
		vote_abs_default
		vote_show_novote
		mail_notes_if_i_noted
		mail_notes_if_i_voted
		remove_recent_link_on_add
		show_inline_mods
		subscriptions_public
	)) {
		$ARGS{$_} = 0 if not defined $ARGS{$_};
	}

	for my $key (UserPreference::valid_keys())
	{
		UserPreference::set($key, $ARGS{$key})
			if defined $ARGS{$key};
	}

	$saved = eval { UserPreference::SaveForUser($ui->Current) };

	# Volatile debugging preferences
	if (&DBDefs::DB_STAGING_SERVER) {
		for (qw(
		)) {
			$session{$_} = $ARGS{$_} ? 1 : 0;
		}
	}

	# Other volatile preferences
	if (UserStuff->IsAutoMod($session{orig_privs}))
	{
		my $p = 0 + $session{privs};

		if ($ARGS{enable_automod_privs}) { $p ||= UserStuff->AUTOMOD_FLAG }
		else { $p &= ~(UserStuff->AUTOMOD_FLAG) }

		$session{privs} = $p;
	}

	if (not $saved)
	{
		my $err = $@;
		</%perl>
		<& /comp/sidebar, title => "Error Saving Preferences" &>
		<p>
			An error occurred while trying to save your preferences.&nbsp;
			Sorry about that.
		</p>
		<& /comp/footer &>
		<%perl>
	}
}

require POSIX;
my $time = POSIX::mktime(24,56,13,31,11,101,0,0,0);

my @format_list = map {
	[ $_, $m->comp("/comp/datetime", { datetimeformat=> $_, tz=>'UTC' }, $time) ]
} UserPreference::allowed_datetime_formats();

$time = time();

</%perl>

<& /comp/sidebar, title=>'Preferences' &>

<p class="LinksRow">
	[
	<a href="/user/view.html">Profile &amp; Statistics</a>
	| <a href="/user/edit.html">Edit</a>
	| <a href="/user/change-password.html">Change Password</a>
	| <a href="/user/subscriptions.html">Subscriptions</a>
	]
</p>

% if ($saved) {
<p class="notice">
	Your preferences have been saved.
</p>
% }

<form method="post" action="/prefs.html" id="PreferencesForm">
	<input type="hidden" name="SavePrefs" value="1">

	<h2>Moderation Pages</h2>

	<p>
		<label for="pref_mod_add_album_inline"><input type="checkbox" name="mod_add_album_inline" id="pref_mod_add_album_inline"
			<% UserPreference::get('mod_add_album_inline') ? "checked" : "" %>
			onclick="this.form.mod_add_album_link.disabled = !this.checked"
			>
		For "Add Album" mods, show the whole album</label> ...
		<br>
		&nbsp; &nbsp;
		<label for="pref_mod_add_album_link"><input type="checkbox" name="mod_add_album_link" id="pref_mod_add_album_link"
			<% UserPreference::get('mod_add_album_link') ? "checked" : "" %>
			>
		and show editing links</label>
	</p>

	<p>
		<label for="pref_navbar_mod_show_select_page"><input type="checkbox" name="navbar_mod_show_select_page" id="pref_navbar_mod_show_select_page"
			<% UserPreference::get('navbar_mod_show_select_page') ? "checked" : "" %>
			>
		Make the "Moderate" link in the navigation bar go to
		<a href="/mod/search/select-filter.html">this page</a>
		instead of the "New Mods" list</label>
	</p>

	<p>
		<label for="pref_mods_per_page">
		Show up to
		<input type="text" name="mods_per_page" id="pref_mods_per_page"
			size=3
			value="<% UserPreference::get('mods_per_page') %>"
			>
		mods per page (max: 25)
		</label>
	</p>

	<p>
		<label for="pref_vote_abs_default"><input type="checkbox" name="vote_abs_default" id="pref_vote_abs_default"
			<% UserPreference::get('vote_abs_default') ? "checked" : "" %>
			>
		Abstain by default</label>
	</p>

	<p>
		<label for="pref_vote_show_novote"><input type="checkbox" name="vote_show_novote" id="pref_vote_show_novote"
			<% UserPreference::get('vote_show_novote') ? "checked" : "" %>
			>
		Show the "No Vote" option</label>
	</p>

	<p>
		<label for="pref_mail_notes_if_i_noted"><input type="checkbox" name="mail_notes_if_i_noted" id="pref_mail_notes_if_i_noted"
			<% UserPreference::get('mail_notes_if_i_noted') ? "checked" : "" %>
			>
		When I add a note to a moderation, mail me all future notes for that moderation</label>
	</p>

	<p>
		<label for="pref_mail_notes_if_i_voted"><input type="checkbox" name="mail_notes_if_i_voted" id="pref_mail_notes_if_i_voted"
			<% UserPreference::get('mail_notes_if_i_voted') ? "checked" : "" %>
			>
		When I vote on a moderation, mail me all future notes for that moderation</label>
		<br>
		&nbsp; &nbsp;
		(Note: only takes effect when your most recent vote on a mod is either
		yes or no - not "abstain")
	</p>

% unless ($ui->Current->IsNewbie) {
	<p>
		<label for="pref_show_inline_mods"><input type="checkbox" name="show_inline_mods" id="pref_show_inline_mods"
			<% UserPreference::get('show_inline_mods') ? "checked" : "" %>
			>
		Show 'inline' moderations
	</p>
% }

	<p>
		<label for="pref_remove_recent_link_on_add"><input type="checkbox" name="remove_recent_link_on_add" id="pref_remove_recent_link_on_add"
			<% UserPreference::get('remove_recent_link_on_add') ? "checked" : "" %>
			>
		After creating a new relationship, remove the linked items from my
		"recently used" list
	</p>

	<h2>E-Mailing Other Moderators</h2>

	<p>
		<label for="pref_reveal_address_when_mailing"><input type="checkbox" name="reveal_address_when_mailing" id="pref_reveal_address_when_mailing"
			<% UserPreference::get('reveal_address_when_mailing') ? "checked" : "" %>
			>
		Reveal my e-mail address</label>
		[&nbsp;<a <& /comp/auto-popup-link,
			url => "/products/server/docs/20040103-1.html",
			&>>help</a>&nbsp;]
	</p>

	<h2>Artist Page (List of Releases)</h2>

	<p>
		<label for="pref_releases_show_compact">
		Default to a "compact" listing when there are
		<input type="text" name="releases_show_compact" id="pref_releases_show_compact"
			size=3
			value="<% UserPreference::get('releases_show_compact') %>"
			>
		releases or more.&nbsp;
		(allowed range: 1-100)
		</label>
	</p>

	<h2>Amazon.com Cover Art</h2>

	<p>
		<label for="pref_show_amazon_coverart"><input type="checkbox" name="show_amazon_coverart" id="pref_show_amazon_coverart"
			<% UserPreference::get('show_amazon_coverart') ? "checked" : "" %>
			>
		Show Amazon.com cover art and buy links</label>
	</p>

	<p>
		Your preferred Amazon Store:
		<select name="use_amazon_store">
			<& /comp/options, [ UserPreference::allowed_amazon_stores() ],
			UserPreference::get('use_amazon_store') &>
		</select>
	</p>

	<h2>Country</h2>

	<p>
		When adding a new release, pick this country by default:
			<select name="default_country"
				><& /comp/options, $countries_menu_2,
					UserPreference::get('default_country'),
					&></select>
	</p>

	<p>
		Your preferred Google domain:
			<select name="google_domain"
				><& /comp/options,
					[ UserPreference::allowed_google_domains() ],
					UserPreference::get('google_domain'),
					&></select>
	</p>

	<h2>Date/Time Display</h2>

	<p>
		Your preferred date/time format:
		<select name="datetimeformat">
			<& /comp/options, \@format_list,
			UserPreference::get('datetimeformat') &>
		</select>
	</p>
	<p>
		Your preferred time zone:
		<select name="timezone">
			<& /comp/options, [ UserPreference::allowed_timezones() ],
			UserPreference::get('timezone') &>
		</select>
	</p>

	<p>
		The time now (using your preferences) is
		<b><% $m->comp("/comp/datetime", $time) %></b>
		and 180 days' time is
		<b><% $m->comp("/comp/datetime", $time+180*86400) %></b>
	</p>

	<h2>Use of Javascript</h2>

	<p>
		<label for="pref_JSMoveFocus"><input type="checkbox" name="JSMoveFocus" id="pref_JSMoveFocus"
			<% UserPreference::get('JSMoveFocus') ? "checked" : "" %>
			>
		Use Javascript to move the input focus when the page loads</label>
	</p>

	<h2>HTML Features</h2>

	<p>
		<label for="pref_sitemenu_heavy"><input type="checkbox" name="sitemenu_heavy" id="pref_sitemenu_heavy"
			<% UserPreference::get('sitemenu_heavy') ? "checked" : "" %>
			>
		Load the full version of the "site menu" (more dynamic, but slower page loads)</label>
	</p>

	<p>
		Sidebar panels:
	</p>

	<ul style="list-style: none">
		<li>
			<label for="pref_sidebar_panel_search"><input type="checkbox" name="sidebar_panel_search" id="pref_sidebar_panel_search"
				<% UserPreference::get('sidebar_panel_search') ? "checked" : "" %>
				> Quick Search</label>
		</li>
		<li>
			<label for="pref_sidebar_panel_topmods"><input type="checkbox" name="sidebar_panel_topmods" id="pref_sidebar_panel_topmods"
				<% UserPreference::get('sidebar_panel_topmods') ? "checked" : "" %>
				> Top Moderators</label>
		</li>
		<li>
			<label for="pref_sidebar_panel_stats"><input type="checkbox" name="sidebar_panel_stats" id="pref_sidebar_panel_stats"
				<% UserPreference::get('sidebar_panel_stats') ? "checked" : "" %>
				> Server Stats</label>
		</li>
	</ul>

	<p>
		<label for="pref_nosidebar"><input type="checkbox" name="nosidebar" id="pref_nosidebar"
			<% UserPreference::get('nosidebar') ? "checked" : "" %>
			>
		Don't show the sidebar at all (even faster, but it makes it
		rather hard to navigate the site)</label>
	</p>

	<h2 id="privacy-settings">Privacy Settings</h2>

	<p>
		<label for="pref_subscriptions_public"><input type="checkbox" name="subscriptions_public" id="pref_subscriptions_public"
		<% UserPreference::get('subscriptions_public') ? "checked" : "" %>
			>
		Allow other users to see <a href="/user/subscriptions.html"
			>my subscribed artists</a></label>
		(see <a href="/docs/20050108-1.html">notes</a>)
	</p>

	<p>
		<input type="submit" value="Update">
	</p>

% if (UserStuff->IsAutoMod($session{orig_privs})) {
	<h1>Temporary Preferences</h1>

	<p>
		These preferences are not saved permanently; they are reset every time
		you log in.
	</p>

	<h2>Automoderator Privileges</h2>
	<p>
		<label for="pref_enable_automod_privs"><input type="checkbox" name="enable_automod_privs" id="pref_enable_automod_privs"
			<% UserStuff->IsAutoMod($session{privs}) ? "checked" : "" %>
			>
		Enable auto-moderator privileges</label>
	</p>

	<p>
		<input type="submit" value="Update">
	</p>
% }

</form>

<script type="text/javascript">
var f=document.forms.PreferencesForm;
f.mod_add_album_link.disabled = !(f.mod_add_album_inline.checked);
</script>
<& /comp/movefocus, "PreferencesForm", "mod_add_album_inline" &>
<& /comp/footer &>

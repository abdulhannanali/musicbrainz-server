<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows to select a mirror server for downloading a given file.
	#
	# $Id$
	#
</%perl>
<%args>

	$path => ""
	$site => ""

</%args>
<%perl>

	my $pref_cookie_name = "preferred_download_site";
	require CGI::Cookie;
	(my $basename) = (split '/', $path, -1)[-1];

	# Set up the data
	my @mirrors = (
		{
			KEYS => [qw( main )],
			URL => "ftp://ftp.musicbrainz.org/",
			NAME => "Primary server (FTP)",
			DEFAULT => 1,
		},
		{
			KEYS => [qw( mainhttp )],
			URL => "http://ftp.musicbrainz.org/",
			NAME => "Primary server (HTTP)",
		},
		{
			KEYS => [qw( uk )],
			URL => "http://ftp.uk.musicbrainz.org/",
			NAME => "United Kingdom (FTP)",
		},
	);

	my %mirrors_by_key;
	for my $mirror (@mirrors)
	{
		for (@{ $mirror->{KEYS} })
		{
			$mirrors_by_key{$_} = $mirror;
		}
	}

	(my $default_mirror) = grep { $_->{DEFAULT} } @mirrors;
	$default_mirror ||= $mirrors[0];

	# Work out which mirror is selected
	$site ||= $cookies{$pref_cookie_name};
	my $selected_mirror = $mirrors_by_key{$site};

	# If we've got all the info we need, go ahead and redirect to the file

	# If $dontask is true, a user with the cookie already set doesn't see the
	# form again - they just get redirected straight away to their download.
	# If false, they see the form again, but with their preferred mirror
	# pre-selected.
	my $dontask = 0;

	if ($path and $selected_mirror and ($ARGS{'go'} or $dontask))
	{
		{
			my $cookie = new CGI::Cookie (
				-name			=> $pref_cookie_name,
				-value		=> $site,
				-path			=> '/',
				-expires	=> '+12M',
				#-domain		=> '.musicbrainz.org',
			);
			$r->headers_out->add('Set-Cookie' => $cookie);
		}

		$path = $selected_mirror->{MUNGE}->($path)
			if $selected_mirror->{MUNGE};

		my $url = $selected_mirror->{URL} . $path;

		unless ($basename)
		{
			$r->status(303);
			$r->header_out(Location => $url);
			return;
		}

		$r->headers_out->add('Refresh' => "1; url=$url");

</%perl>

	<& /comp/sidebar, title => 'MusicBrainz Download' &>

	<p>
		Your download should start automatically.&nbsp;
		If it does not, please <a href="<% $url %>">download using this link</a>.
	</p>

	<& /comp/footer &>

<%perl>

		return;
	}

	$selected_mirror ||= $default_mirror;

</%perl>

<& /comp/sidebar, title => 'Select a download site' &>

	<p>
		Please select the site
% 	if ($basename)
%	{

		from which you would
		like to download the file <b><% $basename %></b>

% 	}
%	else
%	{

		you would like to browse

% 	}
		:
	</p>

	<form method="post" action="/ftpmirror/<% $path %>">
		<p>
			<% $basename ? "Download from" : "Browse" %>:
			<select name="site">

%			for (@mirrors)
%			{

			<option value="<% $_->{KEYS}[0] %>"

%				if ($selected_mirror and $selected_mirror->{URL} eq $_->{URL})
%				{

				selected

%				}

				><% $_->{NAME} %></option>

%			}

			</select>
			<input type="hidden" name="go" value="1">
			<input type="submit" value="Go">
		</p>

		<!--
		<p>
			<input type="checkbox" name="dontask"
				checked
				>
				Don't ask me again
		</p>
		-->

	</form>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

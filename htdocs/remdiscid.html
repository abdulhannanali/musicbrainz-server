%# vi: set ts=4 sw=4 ft=mason :
<%args>
$tocid => ""
$albumid => ""
$confirm => 0
$notetext => ""
</%args>
<%perl>

MusicBrainz::IsNonNegInteger($tocid) && $tocid
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($albumid) && $albumid
	or return $m->comp("/comp/badargs", 1, 1);

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

my $mb = $m->comp("/comp/dblogin");

my $al = Album->new($mb->{DBH});
$al->SetId($albumid);
$al->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Album not found in the database.",
		1, 1,
	);

# Get the cdtoc / album_cdtoc

my $alcdtoc = MusicBrainz::Server::AlbumCDTOC->newFromAlbumAndCDTOC($mb->{DBH}, $al, $tocid)
	or return $m->comp(
		"/comp/error",
		"No such CDTOC #$tocid, or it is not linked to album #$albumid",
		1, 1,
	);

my $cdtoc = $alcdtoc->GetCDTOC;
my $url = "/showalbum.html?albumid=$albumid";

if ($confirm)
{
	$m->comp(
		"/comp/entermods",
		DBH => $mb->{DBH},
		sub => sub {
			my @mods = Moderation->InsertModeration(
				DBH	=> $mb->{DBH},
				uid	=> $session{uid},
				privs => $session{privs},
				type => &ModDefs::MOD_REMOVE_DISCID,
				# --
				cdtoc => $cdtoc,
				album => $al,
			);

			$mods[0]->InsertNote($session{'uid'}, $notetext)
				if $mods[0]
				and $notetext =~ /\S/;
		},
		success_url => $url,
	) or return;

	die "Shouldn't get here";
}

</%perl>

<& /comp/sidebar, title =>' Remove Discid' &>

<h2>Remove Disc ID</h2>

<p>
	Are you sure you want to remove
	<a href="/showcdtoc.html?id=<% $cdtoc->GetId %>"
		>disc ID '<% $cdtoc->GetDiscID %>'</a>
	from album <a href="/showalbum.html?albumid=<% $albumid %>"><% $al->GetName %></a>?
</p>

<p>
	Please be sure you are certain that this CD Index Id is an error,
	since an album can have multiple valid CD Index Ids, and each CD Index Id
	can belong to more than one album.&nbsp;
	For more info, please see our
	<a href="/cd_submission.html">CD Submission</a> document.
</p>

<form method="get" action="<% $url %>"
	name="ModFormNo"
	onsubmit="history.go(-1); return false"
	style="float: left; margin-right: 2em; margin-top: 0"
	>
	<div>
		<input type="submit" value="&lt;&lt; NO">
	</div>
</form>

<form method="post" action="/remdiscid.html"
	name="ModFormYes"
	style="margin: 0"
	>
	<div>
		<input type="hidden" name="tocid" value="<% $tocid %>">
		<input type="hidden" name="albumid" value="<% $albumid %>">
		<input type="hidden" name="confirm" value="1">
		<input type="submit" value="YES &gt;&gt;">
	</div>

	<p>
		If YES, enter moderation note (optional):
	</p>

	<p>
		<textarea name="notetext" rows="3" cols="60"></textarea>
	</p>

</form>

<& /comp/movefocus, "ModFormNo", 0 &>
<& /comp/footer &>

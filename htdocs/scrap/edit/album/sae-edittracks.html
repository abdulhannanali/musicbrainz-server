%# vi: set ts=4 sw=4 ft=mason :
<%perl>

# Abort if session variable is missing
my $edit = $session{"editalbum"}
	or return $m->comp("/comp/redirect", "/search.html");

# Grab all attributes into the $ARGS array
while (my ($k, $v) = each %ARGS)
{
	delete $ARGS{$k}, next
		unless MusicBrainz::IsSingleLineString($v);
	$v =~ s/\A\s+//;
	$v =~ s/\s+\z//;
	$v =~ s/\s\s+/ /g;	#/# for vim
	$ARGS{$k} = $v;
}

# Update album name
# attention: property "name" in session variable, but
# "albumname" in form fields. this was added to allow
# carrying the albumid over in the URL (to avoid some
# level of proxy caching)
$edit->{"name"} = $ARGS{"albumname"}
	if exists $ARGS{"albumname"};

# Update release status
for (qw( type status ))
{
	my $v = $ARGS{"release_$_"};
	defined $v or next;

	$edit->{$_} = undef, next
		if $v eq "";

	MusicBrainz::IsNonNegInteger($v)
		or next;
	# TODO check range
	$edit->{$_} = $v;
}

# update tracklist with information from the formfields
# (reorder, edit)
my $tracks = $edit->{"tracks"};
for my $t (@$tracks)
{
	my $k = "track".$t->{id};
	$t->{"name"} = $ARGS{$k}
		if exists $ARGS{$k}
		and $ARGS{$k} ne "";

	my $seq = $ARGS{"trackseq".$t->{id}};
	if (MusicBrainz::IsNonNegInteger($seq))
	{
		$t->{"seq"} = $seq
			if $edit->{"can_add_remove"};
	}

	my $length = Track::UnformatTrackLength($ARGS{"tracklength".$t->{id}});
  $t->{"length"} = $length
    if $length >= 0;

	if (%ARGS and $edit->{"can_add_remove"})
	{
		$ARGS{"trackdel".$t->{id}}
			? $t->{"delete"} = 1
			: delete $t->{"delete"};
	}
}

# strip 'new and 'to be deleted' tracks from tracklist
@$tracks = grep {
	not $_->{'new'} or not $_->{"delete"}
} @$tracks;

# if a new track was added.
if ($ARGS{"AddATrack"} and $edit->{"can_add_remove"})
{
	my $new_id = 0;
	my $new_seq = 1;
	for (@$tracks)
	{
		$new_id = $_->{id} if $_->{id} < $new_id;
		++$new_seq if $_->{seq} == $new_seq;
	}
	--$new_id;

	push @$tracks, {
		new => 1,
		id => $new_id,
		name => "",
		seq => $new_seq,
	};
	delete $ARGS{'continue'};
}

# sort track listing
@$tracks = sort {
	$a->{seq} <=> $b->{seq}
	or
	$a->{name} cmp $b->{name}
} @$tracks;

# update session variable
$session{"editalbum"} = $edit;

# forward to review page if form was submitted
return $m->comp(
	"/comp/redirect",
	"/edit/album/sae-review.html?albumid=" . $edit->{"id"}
) if $ARGS{"continue"};


# prepare artist object
my $ar = Artist->new(undef);

$ar->SetId($edit->{"artist"}{"id"});
$ar->SetName($edit->{"artist"}{"name"});
$ar->SetSortName($edit->{"artist"}{"sortname"});

</%perl>
<& /comp/sidebar, title => "Album Editor: Edit Album and Track Names" &>

<& /comp/stylemenu &>

<p>
	You can edit the album and track names here.&nbsp;
	To re-order tracks, edit the track numbers on the left.&nbsp;
	To remove tracks, tick the boxes on the right.&nbsp;
	To add a track, click the "Add a Track" button; a new, empty track
	will appear.&nbsp; Please note that adding a track with the same
	track number as an existing track will not work, even if you
	mark the other track for removal.
</p>

<p>
	When you click "Continue" you'll be shown what changes you've made,
	together with a preview of how the album would look if all the
	changes were applied.&nbsp; However, please note that all the changes
	will be inserted as <b>separate moderations</b>, so it's perfectly
	possible that some, but not all, of your changes will get voted in.
</p>

<form method="post" name="EditAlbum" action="/edit/album/sae-edittracks.html">

	<& /comp/autofixmenu &>

	<fieldset>
		<legend>Edit Album and Track Names</legend>

% if (not $edit->{"can_add_remove"}) {
		<div class="discidmessage">
			Adding, removing and renumbering of tracks disabled because of valid Disc ID(s)
		</div>
% }

		<table class="SpacedColumns TopAlignCells">
			<col style="width: 2em">
			<col style="width: 4em">
			<col >
			<col style="width: 4em">
			<col style="width: 1em">
			<col style="width: 6em">

% if (!$edit->{"is_various"}) {
			<tr>
				<td colspan="2" align="right"><a href="/showartist.html?artistid=<% $ar->GetId %>">Artist</a>:</td>
				<td><% $ar->GetName %></td>
				<td colspan="2"></td>
				<td>
					<& /comp/form/jsbutton, id=>"BTN_ALL" &>
					</td>
			</tr>
% }
			<tr>
				<td colspan="2" align="right"><a href="/showalbum.html?albumid=<% $edit->{'id'} %>">Album</a>:</td>
				<td><input type="text" name="albumname" class="textfield"
					size="50"
					value="<% $edit->{'name'} %>"></td>
				<td colspan="2"></td>
				<td>
					<& /comp/form/jsbutton, id=>"BTN_ALBUM::albumname" &>
					</td>
			</tr>

			<tr><td colspan="6">&nbsp;</td></tr>
			<tr>
				<td>&nbsp;</td>
				<td><b>#:</b></td>
				<td><b>Name:</b></td>
				<td><b>Time:</b></td>
				<td colspan="2"></td>
			</tr>


% for my $t (@$tracks) {
%	if ($edit->{is_various}) {
			<tr>
				<td colspan="2">&nbsp;</td>
				<td colspan="3">Artist: <a href="/showartist.html?artistid=<% $t->{artist} %>"><% $t->{artist_name} %></a></td>
			</tr>
%	}
  			<tr>
				<td nowrap>
% unless ($t->{"new"}) {
				<a href="/showtrack.html?trackid=<% $t->{'id'} %>">Track</a>
% } else {
				Track
% }
				</td>
				<td><input type="text" name="trackseq<% $t->{"id"} %>" class="numberfield"
						<% $edit->{can_add_remove} ? '' : 'readonly="readonly" disabled' %>
						value="<% $t->{seq} %>" size="3"
						style="text-align: center"></td>
				<td><input type="text" name="track<% $t->{"id"} %>" class="textfield"
						size="50" maxlength="255"
						value="<% $t->{"name"} %>"></td>
				<td><input type="text" name="tracklength<% $t->{"id"} %>" class="numberfield"
						<% $edit->{can_add_remove} ? '' : 'readonly="readonly" disabled' %>
						value="<% Track::FormatTrackLength($t->{length}) %>" size="4"
						style="text-align: center"></td>
				<td align="center">
					<input type="checkbox" name="trackdel<% $t->{"id"} %>"
						value="1" <% $t->{'delete'} ? "checked" : "" %>
						<% $edit->{can_add_remove} ? '' : 'readonly="readonly" disabled' %>
						title="Remove this track?"></td>
				<td>
					<& /comp/form/jsbutton, id=>"BTN_TRACK::track".$t->{'id'} &>
					</td>
			</tr>
% }
			<tr>
				<td colspan="2"></td>
				<td colspan="2">
% if (!$edit->{is_various}) { # can't add track for VA album
					<input type="checkbox" name="AddATrack" value="1"
						<% $edit->{can_add_remove} ? "" : "disabled" %>>
					Add a track ...
% }
				</td>
				<td align="center"><img src="/images/remove.gif" alt="X"
					title="Tick the boxes above to remove tracks"></td>
				<td>
					<& /comp/form/jsbutton, id=>"BTN_ALL" &>
					</td>
			</tr>
			<tr><td colspan="6">&nbsp;</td></tr>
			<tr>
				<td colspan="2">Type/Status:</td>
				<td>
					<select name="release_type">
					<& /comp/options,
						do {
							[
								[ "", "[none]" ],
								map {
									[ $_, Album->GetAttributeName($_) ]
								} &Album::ALBUM_ATTR_SECTION_TYPE_START
									.. &Album::ALBUM_ATTR_SECTION_TYPE_END
							]
						},
						$edit->{"type"}
					&>
					</select>
					&nbsp;
					<select name="release_status">
					<& /comp/options,
						do {
							[
								[ "", "[none]" ],
								map {
									[ $_, Album->GetAttributeName($_) ]
								} &Album::ALBUM_ATTR_SECTION_STATUS_START
									.. &Album::ALBUM_ATTR_SECTION_STATUS_END
							]
						},
						$edit->{"status"}
					&>
					</select>
					&nbsp;[ <a href="/popup/ReleaseAttribute">help</a> ]
				</td>
			</tr>
			<tr><td colspan="6">&nbsp;</td></tr>
			<tr>
				<td colspan="2">&nbsp;</td>
				<td colspan="4">
					<input type="submit" value="Continue" class="button">
					<input type="hidden" name="continue" value="1">
				</td>
			</tr>
		</table>
	</fieldset>
</form>

<& /comp/movefocus, "EditAlbum", "albumname" &>

<& /comp/footer &>

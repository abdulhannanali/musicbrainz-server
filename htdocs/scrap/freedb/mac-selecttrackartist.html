%# vi: set ts=4 sw=4 ft=mason :
<%args>
$t => undef
$auto => undef
$selectedartist => ""
$newartistname => ""
$newartistsortname => ""
$search => ""
</%args>
<%perl>

$session{"freedb_ready"}
	or return $m->comp("/comp/redirect", "/freedb/freedb.html");

MusicBrainz::IsNonNegInteger($t) and $t < $session{"freedb_tracks"}
	or return $m->comp("/comp/redirect", "/freedb/mac-edittracks.html");

$auto=1;
my $url = (
	$auto
		? ($t+1 < $session{"freedb_tracks"})
			? "/freedb/mac-edittrack.html?t=".($t+1)."&auto=1"
			: "/freedb/mac-edittracks.html"
		: "/freedb/mac-edittracks.html"
);

if ($selectedartist ne "")
{
	MusicBrainz::IsNonNegInteger($selectedartist) && $selectedartist
		or return $m->comp("/comp/badargs", 1, 1);
	
	my $mb = $m->comp("/comp/dblogin");
	my $target = Artist->new($mb->{DBH});
	$target->SetId($selectedartist);
	$target->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Artist #$selectedartist not found.",
			1, 1,
		);

	$session{"freedb_artistid$t"} = $target->GetId;
	$session{"freedb_artistname$t"} = $target->GetName;
	$session{"freedb_sortname$t"} = $target->GetSortName;

	return $m->comp("/comp/redirect", $url);
}

if ($newartistname =~ /\S/ and $newartistsortname =~ /\S/)
{
	$session{"freedb_artistid$t"} = undef;
	$session{"freedb_artistname$t"} = $newartistname;
	$session{"freedb_sortname$t"} = $newartistsortname;

	return $m->comp("/comp/redirect", $url);
}

</%perl>

<& /comp/sidebar, title => 'FreeDB Import : Select Track Artist' &>

<& /comp/stylemenu &>

<fieldset>
	<legend>Select Artist for current track</legend>
	<div class="padleft">
		Please search for the artist to whom you'd like to move the current track:
	</div>
	<div class="padlefttop">
		<div class="oldtextfield"><% $session{"freedb_track$t"} %></div>
	</div>
</fieldset>

<& /comp/artistfilter,
	search => $search,
	allowcreate => 1,
	url => "/freedb/mac-selecttrackartist.html",
	arglist => {
		t => $t,
		auto => $auto ? 1 : 0,
	},
	&>

<& /comp/backtolisting, "/freedb/mac-edittracks.html" &>
<& /comp/footer &>

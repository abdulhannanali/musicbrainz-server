%# vi: set ts=4 sw=4 ft=mason :
<%args>
$query => ""
$limit => 25
$type => ""
$tport=>$session{'tport'}
$dur => 0
</%args>
<%perl>

UserStuff::EnsureSessionOpen(), $session{tport} = $tport
  if $tport;

$m->comp("/comp/sidebar", title=>'Search Results');

if ($query && $type)
{
    print STDERR "$type: $query\n";
    use URI::Escape qw( uri_escape );
    my $docurl = 'http://' . &DBDefs::LUCENE_SERVER . "/ws/1/$type/?query=" . 
                 uri_escape($query) . "&type=$type";
    $docurl .= "&max=$limit" if $limit > 0;
    $docurl .= "&tport=$tport" if $tport > 0;
    $docurl .= "&dur=$dur" if $dur > 0;

    require LWP::UserAgent;
    my $ua = LWP::UserAgent->new;
    my $response = $ua->get($docurl);
    if (!$response->is_success) 
    {
        if ($response->code == 404)
        {
            </%perl>
            <p>0 matches.<br/><br/>
            Your query <b><% $query |h %></b> did not match any <% $type %>s. Make sure that all words 
            are spelled correctly, use fewer words or use different words. For help on writing
            effective text search queries, please read the  
            <a href="http://wiki.musicbrainz.org/TextSearchSyntax">text search syntax</a> documentation.

% if ($type eq 'artist') {
            Alternatively, <a href="/browseartists.html">browse our list of artists</a>.
% }
            </p>
            <%perl>
        }
        elsif ($response->code == 403)
        {
            </%perl>
            <p><b>Error</b>: Your search query <b><% $query |h %></b> did not contain enough information to carry out a search.
               If you are attempting to find an artist that contains nothing but punctuation characters
               (e.g. !!!) then you should <a href="/browseartists.html?index=_">browse</a> for your
               artist, rather than search for it. 
               <br/><br/>
            For help on writing effective text search queries, please read the  
            <a href="http://wiki.musicbrainz.org/TextSearchSyntax">text search syntax</a> documentation.
            </p>
            <%perl>
        }
        elsif ($response->code == 500)
        {
            </%perl>
            <p><b>Error</b>: The search server could not fulfill your request due to an internal error.
            </p>
            <%perl>
        }
        else
        {
            $m->comp('/comp/error',
                 "Error: Could not execute search on search server. " .
                 "(URL $docurl received " . $response->status_line ." )", 0, 0);
        }
    }
    else
    {
        $m->print($response->content);
    }
}
else
{
    $m->print("<p>Error: You must provide query and type arguments to this page.</p>")
        if ($query || $type)
}

</%perl>

<div style="margin-top: 3em; padding: 1em; border: 1px solid #565656;">
<& /comp/lucenesearch, type=>$type, limit=>$limit, query=>$query &>
</div>

<& /comp/footer &>

<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# List all releases of an artist given by the artistid/mbid argument
	#
	# $Id: index.html 9143 2007-05-13 16:22:39Z luks $
	#
</%perl>
<%args>

	$artistid => undef
	$mbid => undef

	$ex => ""
    $short=>1

	$mbt => $session{'mbt'}
	$tport => $session{'tport'}

</%args>
<%perl>

	# check arguments
	if (defined($mbid))
	{
		MusicBrainz::Server::Validation::IsGUID($mbid)
			or return $m->comp("/comp/layout/badarguments",
				text => "Argument mbid is not a valid MBID.");
	} else {
		MusicBrainz::Server::Validation::IsNonNegInteger($artistid) && $artistid
			or return $m->comp("/comp/layout/badarguments",
				text => "You need to specify either a valid mbid or a artistid argument.");
	}

	# Instantiate MusicBrainz object, and load artist entity
	my $mb = $m->comp("/comp/dblogin");
	my $artist = $m->comp("/comp/loadartist", $mb, $mbid || $artistid);

	# Disallow viewing the DELETED_ARTIST.
	$artist->GetId == &ModDefs::DARTIST_ID
		and return $m->comp("/comp/layout/badarguments",
				text => "The special artist DELETED_ARTIST cannot be shown.");

	require MusicBrainz::Server::Link;
	my $link = MusicBrainz::Server::Link->new($mb->{DBH});

	my @albums = @{$link->FindLinkedAlbums("artist", $artist->GetId)};
	
	for my $album (@albums)
	{
		use Encode qw( decode );
		$album->{_name_sort_} = lc decode "utf-8", $album->{name};
		$album->{_disc_no_} = 0;

		# Attempt to sort "disc x" correctly
		if ($album->{_name_sort_} =~
			/^(.*)								# $1 <main title>
				(?:[(]disc\ (\d+)				# $2 (disc x
					(?::[^()]*					#    [: <disc title>
						(?:[(][^()]*[)][^()]*)* #     [<1 level of nested par.>]
					)?                          #    ]
					[)]							#    )
				)
				(.*)$							# $4 [<rest of main title>]
			/xi)
		{
			$album->{_name_sort_} = "$1 $3";
			$album->{_disc_no_} = $2;
		}
		$album->{date} = $album->{begindate};
		$album->{date} =~ s/\s+//;
		$album->{date} = $album->{firstreleasedate} if !$album->{date};
		$album->{_sort_date_} = ($album->{date} || "9999-99-99");
	}
	
	
	@albums = sort {
		$a->{linkphrase} cmp $b->{linkphrase}
		or
		($a->{_sort_date_} cmp $b->{_sort_date_})
		or
		$a->{_name_sort_} cmp $b->{_name_sort_}
		or
		$a->{_disc_no_} <=> $b->{_disc_no_}
	} @albums;

</%perl>

<& "/comp/sidebar-notitle", pagetitle => $artist->GetName() . " - Track and Release Relationships"  &>
<& "/comp/relmods", artistid => $artist->GetId &>

<& "/comp/artisttitle", artist => $artist &>

<p>
	All tracks and releases <& "/comp/linkartist", artist => $artist &> appears on.
	[
		<a href="/show/artist/relationships.html?artistid=<% $artist->GetId %>">View other relationships</a> |
		<a href="/show/artist/relationships.html?artistid=<% $artist->GetId %>&amp;expanded=1&amp;all=1">Edit relationships</a>
	]
</p>

<table id="CompactReleaseList" width="100%">
%
%	my $linkphrase;
%	my $lastyear;
%	my $lastalbumid;
%	my $rownum = 0;
%	my $numalbums = scalar(@albums);
%	my $i = 0;
%	while ($i < $numalbums) {
%		my $album = $albums[$i];
%		
%		my @tracks;
%		while ($album->{id} == $albums[$i]{id}) {
%			push @tracks, $albums[$i] if $albums[$i]{track_id};
%			$i++;
%		}
%
%		if ($album->{linkphrase} ne $linkphrase) {
%			$linkphrase = $album->{linkphrase};
%			$lastyear = undef;
			<tr><th colspan="<% 3 %>" align="left"><h2><% ucfirst($linkphrase) %></h2></th></tr>
			<tr>
				<th>Year</th>
				<th align="left">Artist</th>
				<th align="left">Title</th>
			</td>
%			$rownum = 0;
%		}
%
%		++$rownum;
<tr class="<% ('ev', 'od')[($rownum) % 2] %>">
%		my $year = substr($album->{date}, 0, 4) || '?';
%		if ($lastyear != $year) {
<td class="rdate"><% $year %></td>
%			$lastyear = $year if $year ne '?';
%		} else {
<td class="rtimeline">&nbsp;</td>
%		}
<td><& "/comp/linkartist", name => $album->{artist_name}, id => $album->{artist_id}, strong => 0 &></td>
<td><& "/comp/linkrelease", name => $album->{name}, id => $album->{id}, strong => 0 &></td>
</tr>
%		if (@tracks) {
<tr class="<% ('ev', 'od')[($rownum) % 2] %>">
<td>&nbsp;</td><td>&nbsp;</td><td>
%			foreach my $track (@tracks) {
<& "/comp/linktrack", name => $track->{track_name}, id => $track->{track_id}, strong => 0 &>
%			}
</td></tr>
%		}
%	}
</table>

<& "/comp/footer" &>

%# vi: set ts=4 sw=4 ft=mason :

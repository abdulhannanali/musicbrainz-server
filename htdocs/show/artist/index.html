<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# List all releases of an artist given by the artistid/mbid argument
	#
	# $Id$
	#
</%perl>
<%args>

	$artistid => ""
	$mbid => ""

	$ex => ""
    $short=>1

	$mbt => $session{'mbt'}
	$tport => $session{'tport'}

	$addrel => 0
	$remrel => -1
	$remtype => ""
	$arcancel => 0

</%args>
<%perl>

	# check arguments
	if ($mbid ne "")
	{
		MusicBrainz::Server::Validation::IsGUID($mbid)
			or return $m->comp("/comp/layout/badarguments",
				text => "Argument mbid is not a valid MBID.");
	} else {
		MusicBrainz::Server::Validation::IsNonNegInteger($artistid) && $artistid
			or return $m->comp("/comp/layout/badarguments",
				text => "You need to specify either a valid mbid or a artistid argument.");
	}

	# check tagger session stuff
	UserStuff::EnsureSessionOpen(), $session{mbt} = 1 if $mbt;
	UserStuff::EnsureSessionOpen(), $session{tport} = $tport if $tport;

	# Instantiate MusicBrainz object, and load artist entity
	my $mb = $m->comp("/comp/dblogin");
	my $artist = $m->comp("/comp/loadartist", $mb, $mbid || $artistid);

    my $fCompact = 1;
    my @albums;

    # We will use one of the following display modes:
    # 0 - short display mode, with albums eps single and comp shown.
    # 1 - short mode with all SA other than the above shown
    # 2 - short mode with all VA, no SA shown
    # 3 - full mode -- show everything
    my $dispmode = 0;
    my @dispinfo = (
        [ "album, EP, single, comp. releases", "all releases" ],
        [ "all single artist releases", "all releases" ],
        [ "all various artist releases", "all releases" ],
        [ "all releases", "albums, EP, single, comp. releases" ]
    );

	# Disallow viewing the DELETED_ARTIST.
	$artist->GetId == &ModDefs::DARTIST_ID
		and return $m->comp("/comp/layout/badarguments",
				text => "The special artist DELETED_ARTIST cannot be shown.");


	my $CheckAttributes = sub
	{
		my ($a) = @_;

		for my $attr ($a->GetAttributes)
		{
			$a->{_attr_type} = $attr if ($attr >= Album::ALBUM_ATTR_SECTION_TYPE_START &&
										 $attr <= Album::ALBUM_ATTR_SECTION_TYPE_END);
			$a->{_attr_status} = $attr if ($attr >= Album::ALBUM_ATTR_SECTION_STATUS_START &&
										   $attr <= Album::ALBUM_ATTR_SECTION_STATUS_END);
			$a->{_attr_type} = $attr if ($attr == Album::ALBUM_ATTR_NONALBUMTRACKS);
		}

		# The "actual values", used for display
		$a->{_actual_attr_type} = $a->{_attr_type};
		$a->{_actual_attr_status} = $a->{_attr_status};

		# Used for sorting
		$a->{_attr_type} = Album::ALBUM_ATTR_SECTION_TYPE_END + 1 if (not defined $a->{_attr_type});
		$a->{_attr_status} = Album::ALBUM_ATTR_SECTION_STATUS_END + 1 if (not defined $a->{_attr_status});
	};

	# Sort by:
	# 'Various' (non-VA, VA);
	# 'NonAlbum' (NonAlbum, Album)
	# 'Type' (album type)
	# 'ReleaseDate' (earliest release date first, no release date last)
	# 'Name' (lowercase)
	# 'Status' (release status)
	# track count
	# TRM count
	# PUID count
	# row id

	my $SortAlbums = sub
	{
		# Note: false ("") sorts before true (1)
		($a->{_is_va_} <=> $b->{_is_va_})
		or
		# Note: false ("") sorts before true (1)
		($b->{_is_nonalbum_} <=> $a->{_is_nonalbum_})
		or
		($a->{_attr_type} <=> $b->{_attr_type})
		or
		($a->{_firstreleasedate_} cmp $b->{_firstreleasedate_})
		or
		($a->{_name_sort_} cmp $b->{_name_sort_})
		or
		($a->{_disc_max_} <=> $b->{_disc_max_})
		or
		($a->{_disc_no_} <=> $b->{_disc_no_})
		or
		($a->{_attr_status} <=> $b->{_attr_status})
		or
		($a->{trackcount} cmp $b->{trackcount})
		or
		($b->{trmidcount} cmp $a->{trmidcount})
		or
		($b->{puidcount} cmp $a->{puidcount})
		or
		($a->GetId cmp $b->GetId)
	};

	$m->comp("/comp/sidebar-notitle",
		pagetitle => "Artist: " . $artist->GetName(),
	);

    # show any related moderations so people can vote on them
 	$m->comp("/comp/relmods", artistid => $artist->GetId);

    $m->comp("/comp/artisttitle", artist => $artist);

	$m->comp(
		"/edit/annotation/latest",
		artist => $artist,
		explain => 1,
	), $m->out("<br>")
		unless $artist->GetId == &ModDefs::VARTIST_ID;

	my $relations = $artist->GetRelations();

	my @links = map {
		'<a href="/show/artist/?artistid=' . $_->{'id'} .
		'">' . $_->{'name'} . '</a>'
	} @$relations;

	if (@links > 3) {
		@links = (@links[0..2], '<a href="/artistrel.html?artistid=' .
			$artist->GetId . '">more...</a>')
	}

	if (@links)
	{
		</%perl>
		<div class="RelatedArtists">
			Related artists:
		<% join ', ', @links | n %>
		</div>
		<%perl>
	}

    $m->comp("/comp/ar/AddRelationship", id => $artist->GetId, type => 'artist', name => $artist->GetName)
	    if ($addrel);
    $m->comp("/comp/ar/ClearRelationships")
	    if ($arcancel);

    $m->comp("/comp/ar/RemoveRelationship", id => $remrel, type => $remtype)
	    if ($remrel >= 0);

    $m->comp("/comp/ar/RelationshipBox", id => $artist->GetId, type => 'artist',
			                             name => $artist->GetName);

	if ($artist->GetId == &ModDefs::VARTIST_ID)
    {
        </%perl>

        <p>
        Please use the <a href="/search.html">search page</a> to look for a
        specific release, or browse the releases directly:
        </p>

        <& /comp/browsebox, page => "/browsevarious.html" &>

        <%perl>
    }
    else
    {
		@albums = $artist->GetAlbums($short, 1);

        # filter out non album, EP and single releases if in short listing
        if ($short)
        {
            my @shortlist;

            for my $album (@albums)
            {
                my ($type, $status) = $album->GetReleaseTypeAndStatus();
                push @shortlist, $album if ($type == &Album::ALBUM_ATTR_ALBUM ||
                                            $type == &Album::ALBUM_ATTR_EP ||
                                            $type == &Album::ALBUM_ATTR_COMPILATION ||
                                            $type == &Album::ALBUM_ATTR_SINGLE);
            }
            if (scalar(@shortlist))
            {
                @albums = @shortlist;
            }
            else
            {
                # no releases for our short mode. Set to all SAs, if possible.
                $dispmode = 1;
            }
        }
        else
        {
            # We're not in short mode, so display everything
            $dispmode = 3;
        }

        # if we netted no albums to show, fetch everything else.
        if (scalar(@albums) == 0)
        {
		    @albums = $artist->GetAlbums(0, 1) ;
            $dispmode = 3;
        }

		$fCompact = $ARGS{compact};
		$fCompact = (@albums >= UserPreference::get('releases_show_compact'))
			if not defined $fCompact;

        if (scalar(@albums) == 0)
        {
			</%perl>
			<center>
				<p>This artist has no releases.</p>
				<p>
					[
%	unless ($artist->InUse) {
					<a href="/edit/artist/remove.html?artist=<% $artist->GetId %>"
						>Remove this artist</a>
					|
%	}
					<a href="/edit/album/add.html?artistid=<% $artist->GetId() %>"
						>Add release</a>
					]
				</p>
			</center>
			<%perl>
        }
        else
        {
			my $exall = join ",", map { $_->GetId } @albums;
            my $hasnonalbum = 0;

            for my $album (@albums)
            {
                $hasnonalbum += $album->IsNonAlbumTracks();
                &$CheckAttributes($album);

				# todo, what is better - list albums with multiple
				# tracks per artist which are attributed to this artist
				# with the various artist appearances or separate?
				$album->{_is_va_} = ($album->GetArtist == &ModDefs::VARTIST_ID or
					   				 ($album->HasMultipleTrackArtists and $album->GetArtist != $artist->GetId()));
				$album->{_is_nonalbum_} = ($album->{_attr_type} == Album::ALBUM_ATTR_NONALBUMTRACKS);

				$album->{_section_key_} = (
					$album->{_is_va_} . " " . $album->{_attr_type}
				);

				# Munge name for sorting
				use Encode qw( decode );
				$album->{_name_sort_} = lc decode "utf-8", $album->GetName;
				$album->{_disc_max_} = 0;
				$album->{_disc_no_} = 0;

				# Attempt to sort "disc x [of y]" correctly
				if ($album->{_name_sort_} =~
					/^(.*)								# $1 <main title>
						(?:[(]disc\ (\d+)				# $2 (disc x
							(?:\ of\ (\d+))?			# $3 [of y]
							(?::[^()]*					#    [: <disc title>
								(?:[(][^()]*[)][^()]*)* #     [<1 level of nested par.>]
							)?                          #    ]
							[)]							#    )
						)
						(.*)$							# $4 [<rest of main title>]
					/xi)
				{
					$album->{_name_sort_} = "$1 $4";
					$album->{_disc_no_} = $2;
					$album->{_disc_max_} = $3 || 0;
				}

				# Sort albums with no release last
				$album->{_firstreleasedate_} = ($album->GetFirstReleaseDate || "9999-99-99");
            }

            @albums = sort $SortAlbums @albums;

            </%perl>


            <& /comp/framedboxbegin, width => "100%" &>
            <& /comp/modnotice &>

			<form method="post" action="/edit/albumbatch/done.html">
            <table width="100%">
            <tr>
% unless ($fCompact) {
            <td style="padding-right: 1em">
				<a href="/show/artist/?artistid=<% $artist->GetId() %>&amp;ex=<% $exall %>&amp;compact=0&amp;short=<% $short %>">
				<img src="/images/plus.gif" align="middle"
					 alt="Expand" title="Expand All Albums"
					 height="13" width="13" border="0"> Expand all</a>
            </td>
            <td style="padding-right: 1em">
				<a href="/show/artist/?artistid=<% $artist->GetId() %>&amp;compact=0&amp;short=<% $short %>">
				<img src="/images/minus.gif" align="middle"
					 alt="Collapse" title="Collapse All Albums"
					 height="13" width="13" border="0"> Collapse all</a>
            </td>
% }
            <td style="padding-right: 1em">
				<a href="/artist/<% $artist->GetMBId %>.html?compact=<%
					$fCompact ?  0 : 1
					%>&amp;short=<% $short %>&amp;mbt=<% $mbt?1:0 %>"
					>Change to <% $fCompact ? "full" : "compact" %> listing</a>
			</td>
            <td style="padding-right: 1em">
				Showing <b><% $dispinfo[$dispmode]->[0] %></b>. Show
				<a style="font-weight: bold;" href="/artist/<% $artist->GetMBId %>.html?short=<%
					$short ?  0 : 1
					%>&amp;compact=<% $fCompact %>&amp;mbt=<% $mbt?1:0 %>"
					><% $dispinfo[$dispmode]->[1] %></a>
			</td>

%			if ($session{uid}) {
			<td align="right"><input type="submit" value="Batch edit"/></td>
%			}

            </tr></table>
            <& /comp/framedboxend &>
			<br />

            <%perl>
			if ($fCompact)
			{
				</%perl>
				<table id="CompactReleaseList">
					<col style="text-align: right">
					<col style="text-align: right">
					<col style="text-align: right">
					<col style="text-align: center">
					<col style="text-align: center">
					<col style="text-align: center">
%	if ($session{uid}) {
					<col style="width: 3em">
%	}
					<col>
				<%perl>
			}

            my $last = "";
			my $rownum = 0;

            for my $album (@albums)
            {
                if ($last ne $album->{_section_key_})
                {
					my $va = $album->{_is_va_} ? "Various Artist" : "";
					my $name = $album->GetAttributeNamePlural($album->{_attr_type});
					$name = "Uncategorized Releases" if $name eq "";

					my $desc = ($name ? "$va $name" : $va ? $va."s" : "None");
					$m->comp("/comp/albumtype", text => $desc)
						unless $fCompact;

					if ($fCompact)
					{
						my $s = 8;
						++$s if $session{'uid'};
						</%perl><tr><th colspan='<% $s %>' align="left"><h2><% $desc %></h2></th></tr><%perl>
					}

                    $last = $album->{_section_key_};
					$rownum = 0;
                }

                my $id = $album->GetId();
				++$rownum;

				if ($fCompact)
				{
					my $amp = $album->GetAttributeModPending;
					my $nmp = $album->GetModPending;

					</%perl>
<tr class="<% ('ev', 'od')[$rownum % 2] %>">
%	if ($album->GetTrackCount) {
<td class="trk"><% $album->GetTrackCount %><img src="/images/notes.gif" hspace="3" alt="Tracks"></td>
%	} else {
<td></td>
%	}
%	if ($album->GetDiscidCount) {
<td class="did"><% $album->GetDiscidCount %><img src="/images/cd.gif" hspace="3" alt="disc IDs"></td>
%	} else {
<td></td>
%	}
%	if ($album->GetTrmidCount) {
<td class="trm"><% $album->GetTrmidCount %><img src="/images/trm.gif" hspace="3" alt="TRM IDs"></td>
%	} else {
<td></td>
%	}
%	if ($album->GetPuidCount) {
<td class="trm"><% $album->GetPuidCount %><img src="/images/puid.gif" hspace="3" alt="PUIDs"></td>
%	} else {
<td></td>
%	}
<td class="rst"><%perl>
	$m->out('<span class="mp">') if $amp;
	my $s = $album->{_actual_attr_status};
	$m->out($s ? ($album->GetAttributeName($s) || "?$s") : "None");
	$m->out('</span>') if $amp;
</%perl></td>
<td class="rdate"><& /comp/releasedate, $album->GetFirstReleaseDateYMD &></td>
<td class="lang"><& /comp/language, $album->GetLanguage, $album->GetScript &></td>
%	if ($session{uid}) {
<td class="rtag">
%	if (!$album->IsNonAlbumTracks) {
<input type="checkbox" name="releaseid<% $album->GetId %>"/>
%	}
</td>
%	}
<td class="rname"><%perl>
	if ($session{tport})
	{
		$m->out('<a href="http://127.0.0.1:' . $session{tport} . '/openalbum?id=' . $album->GetMBId . '&amp;t=' . time);
		$m->out('style="margin-right: 1ex"');
		$m->out('target="hiddeniframe" title="Open in Tagger" border="0"><img');
		$m->out('src="/images/mblookup-tagger.png" border="0" alt="Open in tagger"></a>');
	}
	$m->out('<span class="mp">') if $nmp;
	$m->out('<a href="/release/' . $album->GetMBId . '.html">');
	$m->out($m->interp->apply_escapes($album->GetName, 'h'));
	$m->out('</a>');
	$m->out('</span>') if $nmp;
</%perl></td>
</tr><%perl>
				}
                elsif ($ex =~ /(^|\D)$id(\D|$)/)
                {
                     $m->comp("/comp/album",
						 album => $album,
						 artist => $artist,
						 showmodlinks => 0,
						 showreleases => 1,
						 showrelationships => 0,
						 showcollapsed => 1,
						 showids => 0,
						 showtag => 1,
						 mbt => $mbt,
						 ex => $ex);
                }
                else
                {
                     $m->comp("/comp/albumcollapsed",
						 album => $album, artist => $artist,
						 ex => $ex, showids => 0, showtag => 1, short=>$short);
                }
            }

			$m->out("</table><br/><br/>") if $fCompact;

            </%perl>
            </form>
            <%perl>
        }


	 	if ($dispmode < 3)
		{

</%perl>

    <p style="margin-top: 2em;">
    	Displaying <b><% $dispinfo[$dispmode]->[0] %></b>.
    	Show <a style="font-weight: bold;" href="/artist/<% $artist->GetMBId %>.html?short=0&amp;compact=<% $fCompact %>&amp;mbt=<% $mbt?1:0 %>"><% $dispinfo[$dispmode]->[1] %></a>
    </p>


% 		}
%    }

	<& /comp/js/diffcollapse, JSCollapseToggleIcon => 0, JSCollapse => 0 &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

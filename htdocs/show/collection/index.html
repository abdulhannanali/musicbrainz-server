<%perl>
#____________________________________________________________________________
#
#	MusicBrainz -- the open music metadata database
#
#	Copyright (C) 2001 Robert Kaye
#
#	This program is free software; you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation; either version 2 of the License, or
#	(at your option) any later version.
#
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with this program; if not, write to the Free Software
#	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
#	$id: $
#____________________________________________________________________________
</%perl>

<%args>
	$removerelease => undef
</%args>


<%perl>
	
	# Set up page
	$m->comp("/comp/sidebar-notitle", pagetitle => 'Collection');
	
	# Make sure user is logged on
	$m->comp("/comp/checkloggedin", 1, 1, "You need to be logged in to view your collection.", 1) or return;
	
	# Log on to database
	require MusicBrainz;
	my $mbro = $m->comp("/comp/dblogin");
	my $mbraw = MusicBrainz->new();
	$mbraw->Login(db => 'RAWDATA');
	
	my $rawdbh = $mbraw->{DBH};
	my $rodbh = $mbro->{DBH};
	
	# make sure the user has a collection_info tuple
	MusicBrainz::Server::CollectionInfo::AssureCollection($session{uid}, $mbraw->{DBH});
	
	# get the collection id
	my $collectionId = MusicBrainz::Server::CollectionInfo::GetCollectionIdForUser($session{uid}, $mbraw->{DBH});


	# if a release id is specified in in the removerelease get variable remove this release from collection
	if(defined($removerelease))
	{
		MusicBrainz::Server::Collection::RemoveReleaseWithId($rawdbh, $removerelease, $collectionId);
	}
	
	
</%perl>
	
<& /comp/tablebegin, title => "Music in collection" &>
	
<%perl>
	
	
	# Get all releases in collection
	use MusicBrainz::Server::CollectionInfo;
	my $preferences = MusicBrainz::Server::CollectionPreference->new($rodbh, $rawdbh, $session{uid});
	my $collectionInfo = MusicBrainz::Server::CollectionInfo->new($session{uid}, $rodbh, $rawdbh, $preferences);
	my $releases = $collectionInfo->GetHasMBIDs();
	my $count = @$releases;
	
	if($count == 0) # Check if there are releases to display
	{		
		print 'This page displays releases that you own. You have not added any releases yet. To do so visit a release page and click the <i>Add release to collection</i> link. More information about what this is and how to use it is available in the wiki: <a href="http://wiki.musicbrainz.org/MusicCollectionIntroduction">http://wiki.musicbrainz.org/MusicCollectionIntroduction</a>';
	}
	else
	{
		my $rownum=0;
</%perl>


<table id="CompactReleaseList">
	<col style="text-align: right" />
	<col style="text-align: right" />
	<col style="text-align: right" />
	<col style="text-align: center" />
	<col style="text-align: center" />
	<col style="text-align: center" />
	<col />
	
	
	<tr>
		<td><b>Artist</b></td>
		<td><b>Release name</b></td>
		<td><b>Release date</b></td>
		<td><b>Track count</b></td>
		<td><b>Remove</b></td>
	</tr>


<%perl>


use MusicBrainz::Server::Release;


for my $mbid (@{$releases})
{
	# load Release object

        
	my $release = MusicBrainz::Server::Release->new($rodbh);
	$release->SetMBId($mbid);
	$release->LoadFromId();

	my $artist = MusicBrainz::Server::Artist->new($rodbh);
	$artist->SetId($release->GetArtist());
	$artist->LoadFromId();
	
	print '<tr class="'.('ev', 'od')[$rownum % 2].'">';
	print '<td><a href="/artist/'.$artist->GetMBId.'.html">'.$artist->GetName().'</a></td>';
	print '<td><a href="/release/'.$release->GetMBId.'.html">'. $release->GetName() .'</a></td>';
	
	# why do this following commented line print the release date further up in the document?
	#print '<td>'. $m->comp('/comp/releasedate', $release->GetFirstReleaseDateYMD) .'</td>';
</%perl>
	<td><& /comp/releasedate, $release->GetFirstReleaseDateYMD &></td>
<%perl>
	print '<td>'. $release->GetTrackCount() .'</td>';
	print '<td><a href="/show/collection/?removerelease=' . $release->GetId() . '">remove</a></td>';
	print '</tr>';

	$rownum++;
}


print '</table>';


}



</%perl>


<& /comp/tableend &>

<& /comp/footer &>

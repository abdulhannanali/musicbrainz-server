<%perl>
# vi: set ts=4 sw=4 :
#____________________________________________________________________________
#
#	MusicBrainz -- the open music metadata database
#
#	Copyright (C) 2001 Robert Kaye
#
#	This program is free software; you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation; either version 2 of the License, or
#	(at your option) any later version.
#
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with this program; if not, write to the Free Software
#	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
#	$id: $
#____________________________________________________________________________
</%perl>

<%args>
	$removerelease => undef

    $offset => 0
    $limit => 50
    $page => undef
</%args>


<%perl>
	
	# Set up page
	$m->comp("/comp/sidebar", pagetitle => 'My Music Collection');
	
	# Make sure user is logged on
	$m->comp("/comp/checkloggedin", 1, 1, "You need to be logged in to view your collection.", 1) or return;
	
	# validate "limit" parameter
	MusicBrainz::Server::Validation::IsNonNegInteger($limit)
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>limit</strong> is missing or has a wrong format.");

	# validate "offset" parameter
	$offset = ($page - 1) * $limit
		if (defined $page);
	MusicBrainz::Server::Validation::IsNonNegInteger($offset)
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>offset</strong> is missing or has a wrong format.");

	# Log on to database
	require MusicBrainz;
	my $mbro = $m->comp("/comp/dblogin");
	my $mbraw = MusicBrainz->new();
	$mbraw->Login(db => 'RAWDATA');
	
	my $rawdbh = $mbraw->{DBH};
	my $rodbh = $mbro->{DBH};
	
	# make sure the user has a collection_info tuple
	MusicBrainz::Server::CollectionInfo::AssureCollection($session{uid}, $mbraw->{DBH});
	
	# get the collection id
	my $collectionId = MusicBrainz::Server::CollectionInfo::GetCollectionIdForUser($session{uid}, $mbraw->{DBH});


	# if a release id is specified in in the removerelease get variable remove this release from collection
	if(defined($removerelease))
	{
		MusicBrainz::Server::Collection::RemoveReleaseWithId($rawdbh, $removerelease, $collectionId);
	}
	
	# Get all releases in collection
	use MusicBrainz::Server::CollectionInfo;
	my $preferences = MusicBrainz::Server::CollectionPreference->new($rodbh, $rawdbh, $session{uid});
	my $collectionInfo = MusicBrainz::Server::CollectionInfo->new($session{uid}, $rodbh, $rawdbh, $preferences);
	my $releases = $collectionInfo->GetHasReleases();
	MusicBrainz::Server::Rating::LoadUserRatingForEntities("release", $releases, $session{uid}) if ($session{uid} && UserPreference::get("show_ratings"));
	
</%perl>

<script type="text/javascript" src="/scripts/ratings.js"></script>

<p>This page displays releases that you own. To add releases, visit a release page and click the <i>Add release to collection</i> link.</p>
<p>More information about what this is and how to use it is available in our    
<& /comp/linkdoc, "MusicCollectionIntroduction", "documentation about Collection" &></p>

<h3 style="text-align: center;">
	<% (scalar(@$releases) == 0) ? "Your collection is empty." : "You have ". scalar(@$releases) ." releases in your collection" %>
</h3>

%	if(scalar(@$releases)) {

<h2>Releases</h2>

<table id="CompactReleaseList" style="width: 100%;">
	<tr>
		<th align="left">Artist</th>
		<th align="left">Release</th>
		<th align="left">Type</th>
		<th align="left">Date</th>
		<th align="left">Tracks</th>
%		if (UserPreference::get("show_ratings")) {
		<th align="left">Ratings</th>
%		}
		<th />
	</tr>

<%perl>

	my $rownum = 0;
	my $end = $offset + $limit > @$releases ? @$releases : $offset + $limit;

	for (my $row = $offset; $row < $end; $row++)
	{
		my $release = $releases->[$row];
		my $artist = MusicBrainz::Server::Artist->new($rodbh);
		$artist->SetId($release->GetArtist());
		$artist->LoadFromId();
		my ($release_type) = $release->GetReleaseTypeAndStatus;
		$release_type = $release->GetAttributeName($release_type);
	
</%perl>

	<tr class="<% ('ev', 'od')[$rownum % 2] %>">
	    <td> <& /comp/linkartist, artist => $artist &> </td>
        <td> <& /comp/linkrelease, release => $release &> </td>
    	<td> <% $release_type %> </td>
	    <td class="rdate"> <& /comp/releasedate, $release->GetFirstReleaseDateYMD &> </td>
    	<td style="text-align: center;"> <% $release->GetTrackCount() %> <img alt="Tracks" src="/images/notes.gif"/></td>

%		if (UserPreference::get("show_ratings")) {

    	<td style="text-align: center; padding: 0px; margin: 0px;"> <& /comp/ratingsbox, entity_type => 'release',
                entity_id => $release->GetId,
                small => 1,
                rating => $release->{rating},
                user_rating => $release->{user_rating},
            &></td>

%		}
    	<td> <a href="/show/collection/?removerelease=<% $release->GetId() %>">remove</a> </td>
    </tr>

%		$rownum++;
%	}

</table>

%	 if (scalar(@$releases) > $limit) {

	<& /comp/browse/pageselector, 
		numitems => scalar(@$releases),
		offset => $offset, 
		numlinks => 6,
		pagesize => $limit,
		url => "/show/collection/",
	&>

%	}
% }

<& /comp/footer &>

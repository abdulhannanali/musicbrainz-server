<%perl>
# vi: set ts=4 sw=4 :
#____________________________________________________________________________
#
#	MusicBrainz -- the open music metadata database
#
#	Copyright (C) 2001 Robert Kaye
#
#	This program is free software; you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation; either version 2 of the License, or
#	(at your option) any later version.
#
#	This program is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with this program; if not, write to the Free Software
#	Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#
#	$id: $
#____________________________________________________________________________
</%perl>

<%args>
	$removerelease => undef

    $offset => 0
    $limit => 25
    $page => undef
</%args>


<%perl>
	
	# Set up page
	$m->comp("/comp/sidebar-notitle", pagetitle => 'Collection');
	
	# Make sure user is logged on
	$m->comp("/comp/checkloggedin", 1, 1, "You need to be logged in to view your collection.", 1) or return;
	
	# validate "limit" parameter
	MusicBrainz::Server::Validation::IsNonNegInteger($limit)
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>limit</strong> is missing or has a wrong format.");

	# validate "offset" parameter
	$offset = ($page - 1) * $limit
		if (defined $page);
	MusicBrainz::Server::Validation::IsNonNegInteger($offset)
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>offset</strong> is missing or has a wrong format.");

	# Log on to database
	require MusicBrainz;
	my $mbro = $m->comp("/comp/dblogin");
	my $mbraw = MusicBrainz->new();
	$mbraw->Login(db => 'RAWDATA');
	
	my $rawdbh = $mbraw->{DBH};
	my $rodbh = $mbro->{DBH};
	
	# make sure the user has a collection_info tuple
	MusicBrainz::Server::CollectionInfo::AssureCollection($session{uid}, $mbraw->{DBH});
	
	# get the collection id
	my $collectionId = MusicBrainz::Server::CollectionInfo::GetCollectionIdForUser($session{uid}, $mbraw->{DBH});


	# if a release id is specified in in the removerelease get variable remove this release from collection
	if(defined($removerelease))
	{
		MusicBrainz::Server::Collection::RemoveReleaseWithId($rawdbh, $removerelease, $collectionId);
	}
	
	
</%perl>
	
<& /comp/tablebegin, title => "Music in collection" &>
	
<%perl>
	
	
	# Get all releases in collection
	use MusicBrainz::Server::CollectionInfo;
	my $preferences = MusicBrainz::Server::CollectionPreference->new($rodbh, $rawdbh, $session{uid});
	my $collectionInfo = MusicBrainz::Server::CollectionInfo->new($session{uid}, $rodbh, $rawdbh, $preferences);
	my $releases = $collectionInfo->GetHasReleases();
	MusicBrainz::Server::Rating::LoadUserRatingForEntities("release", $releases, $session{uid}) if ($session{uid} && UserPreference::get("show_ratings"));
	
	if(scalar(@$releases) == 0) # Check if there are releases to display
	{		
		print '<p>Your collection is empty.</p>';
		print 'This page displays releases that you own. To do so visit a release page and click the '.
			  '<i>Add release to collection</i> link. More information about what this is and how to use '.
			  'it is available in the wiki: '. 
			  '<a href="http://wiki.musicbrainz.org/MusicCollectionIntroduction">http://wiki.musicbrainz.org/MusicCollectionIntroduction</a></p>';
	}
	else
	{
		my $rownum=0;
</%perl>

<script type="text/javascript" src="/scripts/ratings.js"></script>

<& /comp/browse/pageselector, 
    numitems => scalar(@$releases),
	offset => $offset, 
	numlinks => 6,
	pagesize => $limit,
	url => "/show/collection/index.html",
&>

<table id="CompactReleaseList">
		<thead>
			<tr>
				<th>Artist</th>
				<th>Release</th>
				<th>Release date</th>
				<th>Tracks</th>
% 	if (UserPreference::get("show_ratings")) {
				<th>Ratings</th>
%	}
				<th></th>
			</tr>
		</thead>
	<!--
	<col style="text-align: right;" />
	<col style="text-align: right;" />
	<col style="text-align: right;" />
	<col style="text-align: center;" />
% 	if (UserPreference::get("show_ratings")) {
	<col style="text-align: center;" />
%	}
	<col style="text-align: center;" />
	
	
	<tr>
		<td><b>Artist</b></td>
		<td><b>Release name</b></td>
		<td><b>Release date</b></td>
		<td><b>Track count</b></td>
% 	if (UserPreference::get("show_ratings")) {
		<td><b>Rating</b></td>
%	}
		<td><b>Remove</b></td>
	</tr>
	-->


<%perl>

my $end = $offset + $limit > @$releases ? @$releases : $offset + $limit;
for (my $row = $offset; $row < $end; $row++)
{
    my $release = $releases->[$row];
	my $artist = MusicBrainz::Server::Artist->new($rodbh);
	$artist->SetId($release->GetArtist());
	$artist->LoadFromId();
	
</%perl>

	<tr class="<% ('ev', 'od')[$rownum % 2] %>">
	    <td> <& /comp/linkartist, artist => $artist &> </td>
        <td> <& /comp/linkrelease, release => $release &> </td>
	    <td> <& /comp/releasedate, $release->GetFirstReleaseDateYMD &> </td>
    	<td> <% $release->GetTrackCount() %> </td>
% 	if (UserPreference::get("show_ratings")) {
    	<td class=""> <& /comp/ratingsbox, entity_type => 'release',
                entity_id => $release->GetId,
                small => 1,
                rating => $release->{rating},
                user_rating => $release->{user_rating},
            &></td>
%	}
    	<td> <a href="/show/collection/?removerelease=<% $release->GetId() %>">remove</a> </td>
    </tr>

<%perl>

	$rownum++;
}

print '</table>';

}

</%perl>

<& /comp/tableend &>

<& /comp/footer &>

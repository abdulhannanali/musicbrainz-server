<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# List all releases of an label given by the labelid/mbid argument
	#
	# $Id$
	#
</%perl>
<%args>

	$labelid => ""
	$mbid => ""

	$ex => ""
    $short=>1

	$mbt => $session{'mbt'}
	$tport => $session{'tport'}

	$order => "date"
	$addrel => 0
	$remrel => -1
	$remtype => ""
	$arcancel => 0

</%args>
<%perl>

	# check arguments
	if ($mbid ne "")
	{
		MusicBrainz::Server::Validation::IsGUID($mbid)
			or return $m->comp("/comp/layout/badarguments",
				text => "Argument mbid is not a valid MBID.");
	} else {
		MusicBrainz::Server::Validation::IsNonNegInteger($labelid) && $labelid
			or return $m->comp("/comp/layout/badarguments",
				text => "You need to specify either a valid mbid or a labelid argument.");
	}

	# check tagger session stuff
	UserStuff::EnsureSessionOpen(), $session{mbt} = 1 if $mbt;
	UserStuff::EnsureSessionOpen(), $session{tport} = $tport if $tport;

	# Instantiate MusicBrainz object, and load label entity
	my $mb = $m->comp("/comp/dblogin");
	my $label = $m->comp("/comp/loadlabel", $mb, $mbid || $labelid);

	# Disallow viewing the DELETED_LABEL
	$label->GetId == &ModDefs::DLABEL_ID
		and return $m->comp("/comp/layout/badarguments",
				text => "The special label DELETED_LABEL cannot be shown.");

	my @albums = $label->GetReleases;
	MusicBrainz::Server::Rating::LoadUserRatingForEntities("release", \@albums, $session{uid}) if ($session{uid} && UserPreference::get("show_ratings"));
	
	my $CheckAttributes = sub
	{
		my ($a) = @_;

		for my $attr ($a->GetAttributes)
		{
			$a->{_attr_type} = $attr if ($attr >= MusicBrainz::Server::Release::RELEASE_ATTR_SECTION_TYPE_START &&
										 $attr <= MusicBrainz::Server::Release::RELEASE_ATTR_SECTION_TYPE_END);
			$a->{_attr_status} = $attr if ($attr >= MusicBrainz::Server::Release::RELEASE_ATTR_SECTION_STATUS_START &&
										   $attr <= MusicBrainz::Server::Release::RELEASE_ATTR_SECTION_STATUS_END);
			$a->{_attr_type} = $attr if ($attr == MusicBrainz::Server::Release::RELEASE_ATTR_NONALBUMTRACKS);
		}

		# The "actual values", used for display
		$a->{_actual_attr_type} = $a->{_attr_type};
		$a->{_actual_attr_status} = $a->{_attr_status};

		# Used for sorting
		$a->{_attr_type} = MusicBrainz::Server::Release::RELEASE_ATTR_SECTION_TYPE_END + 1 if (not defined $a->{_attr_type});
		$a->{_attr_status} = MusicBrainz::Server::Release::RELEASE_ATTR_SECTION_STATUS_END + 1 if (not defined $a->{_attr_status});
	};

	my $SortAlbums;

	if ($order eq "catno") {
		$SortAlbums = sub
		{
			($a->{catno} cmp $b->{catno})
			or
			($a->{_releasedate_} cmp $b->{_releasedate_})
			or
			($a->{_name_sort_} cmp $b->{_name_sort_})
			or
			($a->{_disc_max_} <=> $b->{_disc_max_})
			or
			($a->{_disc_no_} <=> $b->{_disc_no_})
			or
			($a->{_attr_status} <=> $b->{_attr_status})
			or
			($a->{trackcount} cmp $b->{trackcount})
			or
			($b->{puidcount} cmp $a->{puidcount})
			or
			($a->GetId cmp $b->GetId)
		};
	}
	elsif ($order eq "title") {
		$SortAlbums = sub
		{
			($a->{_name_sort_} cmp $b->{_name_sort_})
			or
			($a->{_releasedate_} cmp $b->{_releasedate_})
			or
			($a->{catno} cmp $b->{catno})
			or
			($a->{_disc_max_} <=> $b->{_disc_max_})
			or	
			($a->{_disc_no_} <=> $b->{_disc_no_})
			or
			($a->{_attr_status} <=> $b->{_attr_status})
			or
			($a->{trackcount} cmp $b->{trackcount})
			or
			($b->{puidcount} cmp $a->{puidcount})
			or
			($a->GetId cmp $b->GetId)
		};
	}
	elsif ($order eq "artist") {
		$SortAlbums = sub
		{
			($a->{artistname} cmp $b->{artistname})
			or
			($a->{_name_sort_} cmp $b->{_name_sort_})
			or
			($a->{_releasedate_} cmp $b->{_releasedate_})
			or
			($a->{catno} cmp $b->{catno})
			or
			($a->{_disc_max_} <=> $b->{_disc_max_})
			or
			($a->{_disc_no_} <=> $b->{_disc_no_})
			or
			($a->{_attr_status} <=> $b->{_attr_status})
			or
			($a->{trackcount} cmp $b->{trackcount})
			or
			($b->{puidcount} cmp $a->{puidcount})
			or
			($a->GetId cmp $b->GetId)
		};
	}
	else {
		$SortAlbums = sub
		{
			($a->{_releasedate_} cmp $b->{_releasedate_})
			or
			($a->{catno} cmp $b->{catno})
			or
			($a->{_name_sort_} cmp $b->{_name_sort_})
			or
			($a->{_disc_max_} <=> $b->{_disc_max_})
			or
			($a->{_disc_no_} <=> $b->{_disc_no_})
			or
			($a->{_attr_status} <=> $b->{_attr_status})
			or
			($a->{trackcount} cmp $b->{trackcount})
			or
			($b->{puidcount} cmp $a->{puidcount})
			or
			($a->GetId cmp $b->GetId)
		};
	}

	for my $album (@albums)
	{
		# Munge name for sorting
		use Encode qw( decode );
		$album->{_name_sort_} = lc decode "utf-8", $album->GetName;
		$album->{_disc_max_} = 0;
		$album->{_disc_no_} = 0;
		# Attempt to sort "disc x [of y]" correctly
		if ($album->{_name_sort_} =~
			/^(.*)								# $1 <main title>
				(?:[(]disc\ (\d+)				# $2 (disc x
					(?:\ of\ (\d+))?			# $3 [of y]
					(?::[^()]*					#    [: <disc title>
						(?:[(][^()]*[)][^()]*)* #     [<1 level of nested par.>]
					)?                          #    ]
					[)]							#    )
				)
				(.*)$							# $4 [<rest of main title>]
			/xi)
		{
			$album->{_name_sort_} = "$1 $4";
			$album->{_disc_no_} = $2;
			$album->{_disc_max_} = $3 || 0;
		}
		# Sort albums with no release last
		$album->{_releasedate_} = ($album->{releasedate} || "9999-99-99");
	}
	
	@albums = sort $SortAlbums @albums;

	$m->comp("/comp/sidebar-notitle",
		pagetitle => "Label: " . $label->GetName(),
	);

    # show any related moderations so people can vote on them
 	$m->comp("/comp/relmods", artistid => &ModDefs::VARTIST_ID);

    $m->comp("/comp/labeltitle", label => $label, showratings => 1);

	$m->comp(
		"/edit/annotation/latest",
		label => $label,
		explain => 1,
	), $m->out("<br/>");

    </%perl>
    <div class="TagsBox">
        Label tags: 
        <& /comp/toptags, type=>'label', id=>$label->GetId &>
    </div>
    <%perl>

    $m->comp("/comp/ar/AddRelationship", id => $label->GetId, type => 'label', name => $label->GetName)
	    if ($addrel);
    $m->comp("/comp/ar/ClearRelationships")
	    if ($arcancel);

    $m->comp("/comp/ar/RemoveRelationship", id => $remrel, type => $remtype)
	    if ($remrel >= 0);

    $m->comp("/comp/ar/RelationshipBox", id => $label->GetId, type => 'label',
			                             name => $label->GetName);

    </%perl>
	
%	my $labelurl = "/label/" . $label->GetMBId . ".html";
%	if (@albums)
%	{
		<table id="CompactReleaseList">
			<tr><th colspan="7" align="left"><h2>Releases</h2></th></tr>
			<tr>
				<th></th>
				<th>Status</th>
				<th>Language</th>
				<th><a href="<% $labelurl %>?order=date">Date</a></th>
				<th><a href="<% $labelurl %>?order=catno">Catalog #</a></th>
% 		if (UserPreference::get("show_ratings")) {
				<th><a href="<% $labelurl %>?order=catno">Rating</a></th>
%		}
				<th><a href="<% $labelurl %>?order=artist">Artist</a></th>
				<th><a href="<% $labelurl %>?order=title">Title</a></th>
			</td>
%			my $rownum = 0;
%			for my $album (@albums)
%			{
%				&$CheckAttributes($album);
<tr class="<% ('ev', 'od')[(++$rownum) % 2] %>">
%				my $amp = $album->GetAttributeModPending;
%				my $nmp = $album->GetModPending;
%				if ($album->GetTrackCount) {
<td class="trk"><% $album->GetTrackCount %>&nbsp;<img src="/images/notes.gif" alt="Tracks" /></td>
%				} else {
<td></td>
%				}
<td class="rst"><% 
					$amp ? "<span class='mp'>" : "" |n
					%><% do {
						my $s = $album->{_actual_attr_status};
						$s ? ($album->GetAttributeName($s)||"?$s") : "None"
					} %><%
						$amp ? "</span>" : "" |n
%></td>
<td class="lang"><& /comp/language, $album->GetLanguage, $album->GetScript &></td>
<td class="rdate"><& /comp/releasedate, $album->{releasedate} &></td>
<td class="catno"><% $album->{catno} %></td>
%				 	if (UserPreference::get("show_ratings")) {
<td class="">
	<& /comp/ratingsbox, 
		entity_id => $album->GetId, 
		entity_type => "release", 
		small => 1, 
		rating => $album->{rating},
		user_rating => $album->{user_rating},
	&>
</td>
%					}
<td class="rname"><a href="/show/artist/?artistid=<% $album->GetArtist %>"><% $album->{artistname} %></a></td>
<td class="rname">
%					if ($session{tport}) {
<a href="http://127.0.0.1:<% $session{tport} %>/openalbum?id=<% $album->GetMBId %>&amp;t=<% time %>"
style="margin-right: 1ex"
target="hiddeniframe" title="Open in Tagger" border="0"><img
src="/images/mblookup-tagger.png" border="0" alt="Open in tagger" /></a>
%					}
<% $nmp ? "<span class='mp'>" : "" |n %><a href="/release/<% $album->GetMBId %>.html"><% $album->GetName %></a><% $nmp ? "</span>" : "" |n	%></td>
</tr>
%			}
</table>
%	}
%	else
%	{
		<center>
			<p>This label has no releases.</p>
%			unless ($label->InUse) {
			<p>
				[
					<a href="/edit/label/remove.html?labelid=<% $label->GetId %>">Remove this label</a>
				]
			</p>
%			}
		</center>
%	}
		
<& /comp/js/diffcollapse, JSCollapseToggleIcon => 0, JSCollapse => 0 &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

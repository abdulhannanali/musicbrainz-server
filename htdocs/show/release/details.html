<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Show database details of a release.
	#
	# $URL$
	# $Id$
	#
</%perl>
<%args>
	$mbid => ""
	$albumid => ""
	$releaseid => undef

	$show => ""
</%args>
<%perl>
	$releaseid = $releaseid || $albumid;

	if ($mbid ne "")
	{
		MusicBrainz::IsGUID($mbid)
			or return $m->comp("/comp/badargs", 1, 1);
	}
	else
	{
		MusicBrainz::IsNonNegInteger($releaseid) && $releaseid
			or return $m->comp("/comp/badargs", 1, 1);
	}

	my $mb = $m->comp("/comp/dblogin");
	my $release = $m->comp("/comp/loadrelease", $mb, $mbid || $releaseid);
	my $artist = $m->comp("/comp/loadartist", $mb, $release->GetArtist);

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Release Details: " . $release->GetName &>

	<& /comp/artistinfo, artist => $artist, short => 1 &>

	<& /comp/albuminfo, album => $release &>

<%perl>
	# check if we have any Disc IDs to display.
	$release->GetDiscidCount;
	my @ids = @{ $release->GetDiscIDs };

	if (@ids)
	{
		# find out which discid has the most tracks
		use List::Util qw( max );
		my $maxtracks = max(map { $_->GetCDTOC->GetTrackCount } @ids);

		my $id = $release->GetId;

		# discid detail selector area
</%perl>

		<a name="discid"></a>
		<& /comp/tablebegin, title => "Disc IDs" &>

		Show <& /comp/linkdoc/, "DiscID", "Disc ID" &> details: [
		<a href="?releaseid=<% $id %>&amp;show=times#discid" title="Show track times">times</a> |
		<a href="?releaseid=<% $id %>&amp;show=sectors#discid" title="Show sector offsets">sectors</a> |
		<a href="?releaseid=<% $id %>&amp;show=both#discid" title="Show track times and sector offsets">both</a> |
		<a href="?releaseid=<% $id %>" title="Hide Disc ID details">none</a> ]


		<table border="0" style="margin: 8px 0px">
			<tr>
				<td><b>Disc ID</b></td>
				<td><b>Tracks</b></td>

<%perl>

		# if we are showing the details,
		# add additional header columns (total length/sectors, and columns for each track)
		if ($show)
		{
			$m->out(qq!<td><b>Total Length</b></td>!);
			for (1..$maxtracks)
			{
				$m->out(qq!<td style="text-align: center; padding: 0px 2px"><b> $_ </b></td>!);
			}
		}
		$m->out(qq!</tr>!);

		my $row = 0;
		for my $cdtoc (map { $_->GetCDTOC } @ids)
		{
			# alternate row background color,
			# and show discid (and freedb id as a title attribute on the link)

			my $style = (++$row % 2 ? "background-color: #eee" : "");
			$m->out(qq!<tr style="$style">!);
			$m->out(qq!<td style="padding: 0px 4px"><a href="/showcdtoc.html?id=!.$cdtoc->GetId);
			$m->out(qq!" title="FreeDB Id: ! . $cdtoc->GetFreeDBID);
			$m->out(qq!">! . $cdtoc->GetDiscID . qq!</a></td>!);
			$m->out(qq!<td style="text-align: center; padding: 0px 4px">! .$cdtoc->GetTrackCount . qq!</td>!);


			# if show times, or both is choosen, list
			# the track length of each track.
			if ($show =~ /(times|both)/)
			{
				my $len = Track::FormatTrackLength($cdtoc->GetLeadoutOffset/75*1000);
				$m->out(qq!<td style="text-align: center; padding: 0px 4px">$len</td>!);
				for (@{ $cdtoc->GetTrackLengths })
				{
					$len = Track::FormatTrackLength($_/75*1000);
					$m->out(qq!<td style="text-align: center; padding: 0px 4px">$len</td>!);
				}
			}

			if ($show =~ /(both)/)
			{
				$m->out("</tr>");
				$m->out(qq!<tr style="$style">!);
				$m->out(qq!<td align="right" colspan="2">&nbsp;</td>!);
			}

			# if show sectors, or both is choosen, list
			# the sector length of each track.
			if ($show =~ /(sectors|both)/)
			{
				my $offset = $cdtoc->GetLeadoutOffset;
				$m->out(qq!<td style="text-align: center; padding: 0px 4px">$offset</td>!);
				for (@{ $cdtoc->GetTrackOffsets })
				{
					$m->out(qq!<td style="text-align: center; padding: 0px 4px">$offset</td>!);
				}
			}
			$m->out("</tr>");
		}
		$m->out("</table>");
		$m->comp("/comp/tableend");
	}
</%perl>

<& /comp/footer &>
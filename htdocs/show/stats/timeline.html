<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# Groovy graphs for viewing database statistics
	#
	# $Id: permlink.html 8548 2006-10-19 07:41:02Z dave $
	#
</%perl>
<%args>
	$type => 'artist'
	$lines => '111111'
</%args>
<%perl>

my $mb = $m->comp("/comp/dblogin", quiet=>1);
my $stat = MusicBrainz::Server::Statistic->new($mb->{DBH});
my $time = $m->comp("/comp/datetime", $stat->LastRefreshed);

my $head = <<'EOT';
<script type="text/javascript" src="http://static.simile.mit.edu/timeplot/api/1.0/timeplot-api.js"></script>
<script language="javascript" type="text/javascript">
var timeplot = null;

var types = 
{
	artist   : [ "Artist and release", 
					[
						["artists", "count.artist"],
						["releases", "count.album"],
						["VA releases", "count.album.various"],
						["releases w/ discid", "count.album.has_discid"],
						["discids", "count.discid"],
						["cdstubs", "count.cdstub"]
					]
			   ],
	track    : [ "Track and PUID", 
					[
						[ "tracks", "count.track"],
						[ "puid ids", "count.puid"],
						[ "tracks w/ puid", "count.track.has_puid"],
						[ "trm ids", "count.trm"],
						[ "tracks w/ trm", "count.track.has_trm"]
					]
			   ],
	edit     : [ "Edit activity", 
					[
						[ "open edits", "count.moderation.open"],
						[ "edits per week", "count.moderation.perweek"],
						[ "votes per week", "count.vote.perweek"],
						[ "active editors per week", "count.moderator.editlastweek" ],
						[ "active voters per week", "count.moderator.votelastweek" ]
					]
               ],
	ar1      : [ "Artist & label relationships", 
					[
						[ "artist-artist", "count.ar.links.l_artist_artist"],
						[ "artist-url", "count.ar.links.l_artist_url"],
						[ "label-label", "count.ar.links.l_label_label"],
						[ "label-url", "count.ar.links.l_label_url"]
					]
			   ],
	ar2      : [ "Release & track relationships", 
					[
						[ "album-artist", "count.ar.links.l_album_artist"],
						[ "album-url", "count.ar.links.l_album_url"],
						[ "track-artist", "count.ar.links.l_artist_track"],
						[ "track-url", "count.ar.links.l_track_url"],
						[ "album-album", "count.ar.links.l_album_album"],
						[ "track-track", "count.ar.links.l_track_track"]
					]
			   ],
	tag      : [ "Tags", 
					[
						[ "artist tags", "count.tag.raw.artist"],
						[ "release tags", "count.tag.raw.release"],
						[ "track tags", "count.tag.raw.track"],
						[ "label tags", "count.tag.raw.label"]
					]
			   ],
	rating   : [ "Ratings", 
					[
						[ "artist ratings", "count.rating.raw.artist"],
						[ "release ratings", "count.rating.raw.release"],
						[ "track ratings", "count.rating.raw.track"],
						[ "label ratings", "count.rating.raw.label"]
					]
			   ]
};

var maxPlotLines = 6;
var colors = ['#F7A11A', '#846DA3', '#0CC92F', '#C90C19', '#45B6CE', '#FF00FF'];
var linesVisible = [1, 1, 1, 1, 1, 1];
var currentType = 0;

function loadGraph(type, showLines)
{
	if (showLines == null)
	{
		for(i = 0; i < maxPlotLines; i++)
			linesVisible[i] = 1;
	}
	else
	{
		for(i = 0; i < maxPlotLines; i++)
			linesVisible[i] = (showLines.charAt(i) == '1');
	}

	if (types[type] == null)
		type = 'artist';
	currentType = type;

	plotGraph();
}

function plotGraph()
{
	type = currentType;

	plots = types[type][1];
	title = types[type][0];
	series = [];
	for(i = 0; i < plots.length; i++)
	{
		series[i] = plots[i][1];
	}

	// set up the plot
	var eventSource = new Timeplot.DefaultEventSource();
	var historySource = new Timeplot.DefaultEventSource();

	var valueGeometry = new Timeplot.DefaultValueGeometry({
			gridColor: "#000000",
			axisLabelsPlacement: "left"
			});
	var timeGeometry = new Timeplot.DefaultTimeGeometry({
			gridColor: "#000000",
			axisLabelsPlacement: "top"
			});
	var plotInfo = [];
	var plotCount = 0;

	for(i = 0; i < series.length; i++)
	{
		if (linesVisible[i])
		{
		   plotInfo[plotCount++] = Timeplot.createPlotInfo({
			  id: "plot" + (i+1),
			  dataSource: new Timeplot.ColumnSource(eventSource,1+i),
			  valueGeometry: valueGeometry,
			  timeGeometry: timeGeometry,
			  lineColor: colors[i]
			});
		}
	}
	plotInfo[plotCount++] = Timeplot.createPlotInfo({
		      id: "hist_plot",
			  timeGeometry: timeGeometry,
			  eventSource: historySource,
		      lineColor: "#EDA5C2"});

	// Now create the actual plot
	timeplot = Timeplot.create(document.getElementById("stats-timeplot"), plotInfo);
	timeplot.loadText("timeline-data.html?series=" + series.join(","), ",", eventSource);
	timeplot.loadXML("mb_history.xml", historySource);

	textContent = document.getElementById('stats-timeplot-title');
	textContent.firstChild.data=title;

	// Update the legend
	var legend = "";
	for(i = 0; i < plots.length; i++)
	{
		node = document.getElementById('legend-color-' + i)
	    node.style.backgroundColor= colors[i];
		node = document.getElementById('legend-text-' + i)
	    node.firstChild.data= " " + plots[i][0] + " ";
		if (linesVisible[i])
		{
			node.style.color = '#000000';
		}
		else
		{
			node.style.color = '#999999';
		}
	}
	for(i = plots.length; i < maxPlotLines; i++)
	{
		node = document.getElementById('legend-color-' + i)
	    node.style.backgroundColor= '#FFFFFF';
		node = document.getElementById('legend-text-' + i)
	    node.firstChild.data= " ";
	}

	// Update the link to this link
	node = document.getElementById('stats-timeplot-link-to-this')
	href = "?type=" + type + "&lines=";
	for(i = 0; i < maxPlotLines; i++)
		href += linesVisible[i] ? '1' : '0';
	node.href = href
}

function toggle(plotNum)
{
	if (plotNum < 0 || plotNum >= maxPlotLines)
		return;

	linesVisible[plotNum] = !linesVisible[plotNum];
	plotGraph();
}

var resizeTimerID = null;
function onResize() {
    if (resizeTimerID == null) {
        resizeTimerID = window.setTimeout(function() {
            resizeTimerID = null;
            timeplot.repaint();
        }, 100);
    }
}
</script>
EOT
</%perl>

<& /comp/sidebar, pagetitle => "MusicBrainz Timeline", body=>'onload="loadGraph(\''.$type.'\', \''.$lines.'\');" onresize="onResize();"', head => $head &>


<p>
View [ <a href="#" onclick="loadGraph('artist');">artist/album</a> |
<a href="#" onclick="loadGraph('track');">track/puid</a> |
<a href="#" onclick="loadGraph('edit');">edit activity</a> |
<a href="#" onclick="loadGraph('ar1');">artist/label relationships</a> |
<a href="#" onclick="loadGraph('ar2');">release/track relationships</a> |
<a href="#" onclick="loadGraph('tag');">tags</a> |
<a href="#" onclick="loadGraph('rating');">ratings</a> ]
</p>
<br/>

<div id="stats-timeplot-title">&nbsp;</div>
<div class="lastupdated">last updated <% MusicBrainz::Server::DateTime::format_datetime_since($time) %></div>
<div id="stats-timeplot" style="height:200px;"></div>
<a id="stats-timeplot-link-to-this" href="#">link to this graph</a>
<div id="stats-timeplot-legend">
<span id="legend-color-0">&nbsp;</span><a id="legend-text-0" href="#" onclick="toggle(0);" class="shownplotline"> </a> 
<span id="legend-color-1">&nbsp;</span><a id="legend-text-1" href="#" onclick="toggle(1);" class="shownplotline"> </a> 
<span id="legend-color-2">&nbsp;</span><a id="legend-text-2" href="#" onclick="toggle(2);" class="shownplotline"> </a> 
<span id="legend-color-3">&nbsp;</span><a id="legend-text-3" href="#" onclick="toggle(3);" class="shownplotline"> </a> 
<span id="legend-color-4">&nbsp;</span><a id="legend-text-4" href="#" onclick="toggle(4);" class="shownplotline"> </a> 
<span id="legend-color-5">&nbsp;</span><a id="legend-text-5" href="#" onclick="toggle(5);" class="shownplotline"> </a> 
</div>
<br/>

<p style="font-size: x-small; color: #999999">
Tip: Click on the legend to show/hide plot lines and click the red vertical lines for information on events.
</p>
<p style="font-size: x-small; color: #999999">
This graph does not work well in IE. Please use Firefox to view this graph until the underlying graph package
release a bug fix update.
</p>


<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

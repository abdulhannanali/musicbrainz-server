<%args>
	$tag => ''
    $show => 'all'
    $offset => 0
</%args>

<%perl>

	MusicBrainz::Server::Validation::IsNonNegInteger($offset)
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>offset</strong> has wrong format.");

	($show eq 'all' || $show eq 'artist' || $show eq 'label' || $show eq 'track' || $show eq 'release')
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>show</strong> must be all, artist, label, track or release.");

	# Instantiate MusicBrainz object, and load entity
	my $mb = $m->comp("/comp/dblogin");
	my $t = MusicBrainz::Server::Tag->new($mb->{DBH});
	my ($entities, $numitems);

    if (!$tag)
    {
        </%perl>
        <& /comp/sidebar, pagetitle => "Find tag" &>

        <form method="post" action="/show/tag/index.html">
        <p>
        Enter a tag name to display:
        <input type="text" size="15" name="tag"/>
        </p>
        <br/>
        <input type="submit" value="Show details"/>
        </form>
        <& /comp/footer &>
        <%perl>
        return undef;
    }
</%perl>

<& /comp/sidebar, pagetitle => "Tag “$tag”" &>

<& /show/tag/tagheader.inc, tag => $tag, show => $show &>

%	my @types = ($show eq 'all') ? ("artist", "label", "release", "track") : ($show);
%	my $limit = ($show eq 'all') ? 10 : 100;
%	for my $type (@types) {
		<h2><% ucfirst($type) %>s</h2>
%		($entities, $numitems) = $t->GetEntitiesForTag($type, $tag, $limit, $offset);
%		if ($numitems) {
			<table>
%				for my $entity (@$entities) {
					<tr>
						<td><& "/comp/link".$type,
							id => $entity->{"id"},
							mbid => $entity->{"gid"},
							name => $entity->{"name"}
						&></td>
						<td><% $entity->{"count"} %></td>
						<td><a href="/show/tag/editors.html?id=<% $entity->{"id"} %>&tag=<% uri_escape($tag) %>&type=<% $type %>">Who tagged this?</a></td>
					</tr>
%				}
			</table>
%		}
%		if ($numitems > $limit) {
%			if ($show eq 'all') {
				<p><a href="/show/tag/?tag=<% uri_escape($tag) %>&show=<% $type %>">More...</a></p>
%			}
%			else {
				<& /comp/browse/pageselector, numitems => $numitems,
					offset=> $offset,
					numlinks => 6,
					pagesize=> $limit,
					url => "/show/tag/",
					args => { "tag" => $tag, "show" => $type }
				&>
%			}
%		}
%	}

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

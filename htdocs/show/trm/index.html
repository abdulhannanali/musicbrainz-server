<%perl>
	# -----------------------------------------------------------------------------
	#										 Musicbrainz.org
	#								Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License	 http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# List all releases with tracks that have the given TRM ID attached.
	#
	# $URL$
	# $Id$
	#
</%perl>
<%args>
	$trm => undef
	$matchesonly => 1
</%args>

<& /comp/sidebar-notitle, pagetitle => "Show TRM Id" &>

<%perl>
	my $showreleases = 0;
	my $showspecial = undef;

	my $mb = $m->comp("/comp/dblogin");
	my $artist = Artist->new($mb->{DBH});
	my $release = Album->new($mb->{DBH});
	my $gu = TRM->new($mb->{DBH});
	my $ids;

	unless (MusicBrainz::IsGUID($trm))
	{
		$showspecial = "The argument <strong>trm</strong> is missing or has an invalid format";
	}
	else
	{
		$trm = lc $trm;

		if ($trm eq &ModDefs::TRM_ID_SILENCE)
		{
			$showspecial = "This TRM Id represents silence";
		}
		elsif ($trm eq &ModDefs::TRM_TOO_SHORT)
		{
			$showspecial = "This TRM Id indicates that the source file is too short";
		}
		elsif ($trm eq &ModDefs::TRM_SIGSERVER_BUSY)
		{
			$showspecial = "This TRM Id gets returned when the TRM signature server is too busy to process the TRM calculation request";
		}
		else
		{
			$ids = $gu->GetTrackIdsFromTRM($trm);
			if (scalar(@$ids) == 0)
			{
				$showspecial = "This <strong>TRM Id</strong> was not found in the database";
			}
			else
			{
				$showreleases = 1;
			}
		}
	}

	if ($showreleases || $showspecial)
	{
		if ($matchesonly || $showspecial)
		{
</%perl>

	<& /comp/tablebegin, title => "Show TRM Id ".lc($trm) &>

		<table class="formstyle">
			<tr>
				<td class="instructions">
					<ul>

%			if ($matchesonly && $showreleases) {
						<li>
							Please note, that only tracks with the specified TRM
							are shown below. Click on <strong>Show all tracks</strong>
							to get the complete track listings.<br/>
							<form method="get" action="/show/trm/">
								<div style="margin-top: 5px">
									<input type="hidden" name="trm" value="<% $trm %>" />
									<input type="hidden" name="matchesonly" value="0" />
									<input type="submit" value="Show all tracks &raquo;" />
								</div>
							</form></li>
%			}
%			if ($showspecial) {
						<li>
							<% $showspecial |n %>.</li>
%			}
					</ul></td>
			</tr>
		</table>
	<& /comp/tableend &>

<%perl>
		}

		if ($showreleases)
		{

			my %artists;
			my %releases;

			for my $trackid (@$ids)
			{
				my @releases = $release->GetAlbumIdsFromTrackId($trackid);
				for my $releaseid (@releases)
				{
					$releases{$releaseid} ||= do {
						my $release = Album->new($mb->{DBH});
						$release->SetId($releaseid);
						$release->LoadFromId
							or $release = "0 but true"; # load failed
						$release;
					};
					ref(my $release = $releases{$releaseid})
						or next;

					$artists{$release->GetArtist} ||= do {
						my $artist = Artist->new($mb->{DBH});
						$artist->SetId($release->GetArtist);
						$artist->LoadFromId
							or $artist = "0 but true"; # load failed
						$artist;
					};
					ref(my $artist = $artists{$release->GetArtist})
						or next;

					$artist->{_my_releases_}{$releaseid} ||= $release;
					$release->{_my_tracks_}{$trackid} = 1;
				}
			}

			# For each artist in sortname order...
			my @artist = values %artists;
			@artist = map {
					$_->[0]
				} sort {
					$a->[1] cmp $b->[1]
				} map {
					my $n = MusicBrainz::NormaliseSortText($_->GetSortName);
					[ $_, $n ];
				} @artist;

			for my $artist (@artist)
			{
				$m->comp("/comp/artisttitle", artist => $artist, link => 0, showmodlinks => 0);

				# For releases in name order...
				my @release = values %{ $artist->{_my_releases_} };
				@release = map {
						$_->[0]
					} sort {
						$a->[1] cmp $b->[1]
					} map {
						my $n = MusicBrainz::NormaliseSortText($_->GetName);
						[ $_, $n ];
					} @release;

				for my $release (@release)
				{
					$m->comp( "/comp/album",
						album => $release, artist => $artist,
						showlinks => 0, showmodlinks => 0,
						highlighttracks	=> $release->{_my_tracks_}, highlightonly => $matchesonly,
					);
				}
			}
		}
	}
	$mb->Logout;

</%perl>

<& /comp/footer &>

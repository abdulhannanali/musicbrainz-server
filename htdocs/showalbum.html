%# vi: set ts=4 sw=4 ft=mason :
<%args>
$albumid => ""
$discid => undef
$mbid => ""
$mbt=>$session{'mbt'}
$tport=>$session{'tport'}
</%args>
<%perl>

UserStuff::EnsureSessionOpen(), $session{mbt} = 1
	if $mbt;

UserStuff::EnsureSessionOpen(), $session{tport} = $tport
   if $tport;

use URI::Escape qw( uri_escape );
return $m->comp("/comp/redirect", "/bare/cdlookup.html?id=" . uri_escape($discid))
	if defined $discid;

if ($mbid ne "")
{
	MusicBrainz::IsGUID($mbid)
		or return $m->comp("/comp/badargs", 1, 1);
} else {
	MusicBrainz::IsNonNegInteger($albumid) && $albumid
		or return $m->comp("/comp/badargs", 1, 1);
}

my $mb = $m->comp("/comp/dblogin");

my $album = Album->new($mb->{DBH});

if ($mbid ne "")
{
	$album->SetMBId($mbid);
} else {
	$album->SetId($albumid);
}

$album->LoadFromId(1)
	or return $m->comp(
		"/comp/error",
		"Album #".$album->GetId." not found in the database.",
		1, 1,
	);

my $artist = Artist->new($mb->{DBH});
$artist->SetId($album->GetArtist);
$artist->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);

</%perl>

<& /comp/sidebar, title => "", pagetitle => "Album: " . $album->GetName &>

%# show any related moderations so people can vote on them
<& /comp/relmods, artistid=>$album->GetArtist() &>

<& /comp/artisttitle, artist => $artist &>


	<& /comp/framedboxbegin, width=>"100%" &>

		<table width="100%">
			<tr>
				<td>
					<& /comp/modnotice &>
				</td>
%		       if ($session{uid}) {
					<td align="center">

               <form method="post" action="/mod/tag/donetag.html" id="BatchOp"
                   	enctype="application/x-www-form-urlencoded">

               <input type="hidden" name="AlbumId<% $album->GetId() %>" value="">
					<script type="text/javascript">
					document.writeln('<\input type="image" alt="Batch Operation" title="Moderate a batch of selected albums" src="/images/batch.gif" style="border: 0; height: 13px; width: 13px"\>');
					document.writeln('<\a href="#" onclick="document.forms.BatchOp.submit(); return false">Batch Operation<\/a>');
					</script>
               </form>
				</td>
%		       }
			</tr>
		</table>

	<& /comp/framedboxend &>

	<br>

	<& /mod/annotation/latest, album => $album, explain => 1 &>
	<br>

	<& /comp/album, album => $album, artist => $artist,
		mbtagger => $mbt,
		showids => 1,
		showtag => 1,
		showreleases => 1,
		&>

<& /comp/footer &>

<%args>
$mbt=>0
</%args>

<%perl>

my ($mb); 
my ($artist, $album, $albumid); 

$mb = mc_comp("/comp/dblogin");

if (exists $ARGS{discid} && $ARGS{discid} ne '')
{
    my ($di, $disc);

    $disc = $ARGS{discid};
    $disc =~ s/^\s*(.*?)\s*$/$1/;;
    $di = Discid->new($mb->{DBH});
    $albumid = $di->GetAlbumFromDiscid($disc);
    if (!defined $albumid)
    {
        mc_comp("/comp/sidebar", title=>"Error");
        mc_out("Discid $ARGS{discid} was not found in the database.");
        $mb->Logout();
        return undef;
    }
}

if (!defined $albumid && (!exists $ARGS{albumid} || $ARGS{albumid} eq ''))
{
    mc_comp("/comp/sidebar", title=>"Error");
    mc_comp("/comp/badargs");
    $mb->Logout();
    return undef;
}

$albumid = $ARGS{albumid} if (!defined $albumid);

$album = Album->new($mb->{DBH});
$album->SetId($albumid);

if (! $album->LoadFromId())
{
    mc_comp("/comp/sidebar", title=>"Error");
    mc_out("This Album (ID=$albumid) was not found<br>");
    $mb->Logout();
    return undef;
}
else
{
    $artist = Artist->new($mb->{DBH});
    $artist->SetId($album->GetArtist());
    if (!defined $artist->LoadFromId())
    {
        mc_comp("/comp/sidebar", title=>"Error");
        mc_out("Could not load album.");
    }
    else
    {
        mc_comp("/comp/sidebar", title=>'',
                pagetitle=>"Album: " . $album->GetName());
        mc_comp("/comp/artisttitle", artist=>$artist);
        mc_out("[ <a href=\"/showartist.html?artistid=");
        mc_out($artist->GetId());
        mc_out("\">View albums</a> | ");

        if ($artist->GetId() != ModDefs::VARTIST_ID)
        {
            mc_out("<a href=\"/moderate.html?type=4&artistid=" .
                   $artist->GetId()."\">");
            mc_out("View mods</a> | ");
        }

        mc_out("<a href=\"/addalbum.html?artistid=");
        mc_out($artist->GetId());
        mc_out("\">Add album</a> | ");

        </%perl>
        <a href="/freedb/freedb.html?search=<% $artist->GetName() |u %>">Import album</a> ]<p>
        <%perl>

        mc_comp("/comp/modnotice");
        mc_comp("/comp/album", album=>$album, artist=>$artist, 
                               showalbumdetail=>1, mbtagger=>$mbt, showids=>1);
    }
}
$mb->Logout();

</%perl>

<& /comp/footer &>

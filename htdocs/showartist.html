%# vi: set ts=4 sw=4 ft=mason :
<%args>
$artistid => ""
$mbid => ""
$ex=>""
$mbt=>$session{'mbt'}
$tport=>$session{'tport'}
$addrel=>0
$remrel=>-1
$remtype=>""
$arcancel=>0
</%args>
<%perl>

UserStuff::EnsureSessionOpen(), $session{mbt} = 1
	if $mbt;
UserStuff::EnsureSessionOpen(), $session{tport} = $tport
   if $tport;

if ($mbid ne "")
{
	MusicBrainz::IsGUID($mbid)
		or return $m->comp("/comp/badargs", 1, 1);
} else {
	MusicBrainz::IsNonNegInteger($artistid) && $artistid
		or return $m->comp("/comp/badargs", 1, 1);
}

my $mb = $m->comp("/comp/dblogin");

my $artist = Artist->new($mb->{DBH});
$artist->SetMBId($mbid) if $mbid;
$artist->SetId($artistid) unless $mbid;
$artist->LoadFromId()
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);

$artist->GetId == &ModDefs::DARTIST_ID
	and return $m->comp("/comp/badargs", 1, 1);

my $CheckAttributes = sub
{
    my ($a) = @_;

	for my $attr ($a->GetAttributes)
    {
        $a->{_attr_type} = $attr if ($attr >= Album::ALBUM_ATTR_SECTION_TYPE_START &&
                                     $attr <= Album::ALBUM_ATTR_SECTION_TYPE_END);
        $a->{_attr_status} = $attr if ($attr >= Album::ALBUM_ATTR_SECTION_STATUS_START &&
                                       $attr <= Album::ALBUM_ATTR_SECTION_STATUS_END);
        $a->{_attr_type} = $attr if ($attr == Album::ALBUM_ATTR_NONALBUMTRACKS);
    }

	# The "actual values", used for display
	$a->{_actual_attr_type} = $a->{_attr_type};
	$a->{_actual_attr_status} = $a->{_attr_status};

	# Used for sorting
    $a->{_attr_type} = Album::ALBUM_ATTR_SECTION_TYPE_END + 1 if (not defined $a->{_attr_type});
    $a->{_attr_status} = Album::ALBUM_ATTR_SECTION_STATUS_END + 1 if (not defined $a->{_attr_status});
};

# Sort by:
# 'Various' (non-VA, VA);
# 'NonAlbum' (NonAlbum, Album)
# 'Type' (album type)
# 'ReleaseDate' (earliest release date first, no release date last)
# 'Name' (lowercase)
# 'Status' (release status)
# track count
# TRM count
# row id

my $SortAlbums = sub
{
	# Note: false ("") sorts before true (1)
	($a->{_is_va_} <=> $b->{_is_va_})
	or
	# Note: false ("") sorts before true (1)
	($b->{_is_nonalbum_} <=> $a->{_is_nonalbum_})
	or
	($a->{_attr_type} <=> $b->{_attr_type})
	or
	($a->{_firstreleasedate_} cmp $b->{_firstreleasedate_})
	or
	($a->{_name_sort_} cmp $b->{_name_sort_})
	or
	($a->{_disc_max_} <=> $b->{_disc_max_})
	or
	($a->{_disc_no_} <=> $b->{_disc_no_})
	or
	($a->{_attr_status} <=> $b->{_attr_status})
	or
	($a->{trackcount} cmp $b->{trackcount})
	or
	($b->{trmidcount} cmp $a->{trmidcount})
	or
	($a->GetId cmp $b->GetId)
};

$m->comp(
	"/comp/sidebar",
	pagetitle => "Artist: " . $artist->GetName(),
	title => '',
);

    # show any related moderations so people can vote on them
 	$m->comp("/comp/relmods", artistid=>$artist->GetId);

    $m->comp("/comp/artisttitle", artist=>$artist);

	$m->comp(
		"/edit/annotation/latest",
		artist => $artist,
		explain => 1,
	), $m->out("<br>")
		unless $artist->GetId == &ModDefs::VARTIST_ID;

	my $relations = $artist->GetRelations();

	my @links = map {
		'<a href="/showartist.html?artistid=' . $_->{'id'} .
		'">' . $_->{'name'} . '</a>'
	} @$relations;

	if (@links > 3) {
		@links = (@links[0..2], '<a href="/artistrel.html?artistid=' .
			$artist->GetId . '">more...</a>')
	}

	if (@links)
	{
		</%perl>
		<div class="RelatedArtists">
			Related artists:
		<% join ', ', @links | n %>
		</div>
		<%perl>
	}

    $m->comp("/comp/ar/AddRelationship", id=>$artist->GetId, type=>'artist', name=>$artist->GetName)
	    if ($addrel);
    $m->comp("/comp/ar/ClearRelationships")
	    if ($arcancel);

    $m->comp("/comp/ar/RemoveRelationship", id=>$remrel, type=>$remtype)
	    if ($remrel >= 0);

    $m->comp("/comp/ar/RelationshipBox", id=>$artist->GetId, type=>'artist',
			                             name=>$artist->GetName);

	if ($artist->GetId == &ModDefs::VARTIST_ID)
    {
        </%perl>

        <p>Please use the <a href="search.html">Search Page</a>
         to look for a specific album,
         or browse the various artist albums:<p>

        <& /comp/browsebox, page=>"/browsevarious.html" &>

        <%perl>
    }
    else
    {
		my @albums = $artist->GetAlbums(0, 1);

		my $fCompact = $ARGS{compact};
		$fCompact = (@albums >= UserPreference::get('releases_show_compact'))
			if not defined $fCompact;

        if (scalar(@albums) == 0)
        {
			</%perl>
			<center>
				<p>This artist has no albums.</p>
				<p>
					[
% unless ($artist->InUse) {
					<a href="/edit/artist/remove.html?artist=<% $artist->GetId %>"
						>Remove this artist</a>
					|
% }
					<a href="/edit/album/add.html?artistid=<% $artist->GetId() %>"
						>Add album</a>
					]
				</p>
			</center>
			<%perl>
        }
        else
        {
			my $exall = join ",", map { $_->GetId } @albums;
            my $hasnonalbum = 0;

            for my $album (@albums)
            {
                $hasnonalbum += $album->IsNonAlbumTracks();
                &$CheckAttributes($album);

				# todo, what is better - list albums with multiple
				# tracks per artist which are attributed to this artist
				# with the various artist appearances or separate?
				$album->{_is_va_} = ($album->GetArtist == &ModDefs::VARTIST_ID or
					   				 ($album->HasMultipleTrackArtists and $album->GetArtist != $artist->GetId()));
				$album->{_is_nonalbum_} = ($album->{_attr_type} == Album::ALBUM_ATTR_NONALBUMTRACKS);

				$album->{_section_key_} = (
					$album->{_is_va_} . " " . $album->{_attr_type}
				);

				# Munge name for sorting
				use Encode qw( decode );
				$album->{_name_sort_} = lc decode "utf-8", $album->GetName;
				$album->{_disc_max_} = 0;
				$album->{_disc_no_} = 0;

				# Attempt to sort "disc x [of y]" correctly
				if ($album->{_name_sort_} =~ 
					/^(.*)								# $1 <main title>
						(?:[(]disc\ (\d+)				# $2 (disc x
							(?:\ of\ (\d+))?			# $3 [of y]
							(?::[^()]*					#    [: <disc title>
								(?:[(][^()]*[)][^()]*)* #     [<1 level of nested par.>]
							)?                          #    ]
							[)]							#    )
						)
						(.*)$							# $4 [<rest of main title>]
					/xi)
				{
					$album->{_name_sort_} = "$1 $4";
					$album->{_disc_no_} = $2;
					$album->{_disc_max_} = $3 || 0;
				}

				# Sort albums with no release last
				$album->{_firstreleasedate_} = ($album->GetFirstReleaseDate || "9999-99-99");
            }

            @albums = sort $SortAlbums @albums;

            </%perl>


            <& /comp/framedboxbegin, width=>"100%" &>
            <& /comp/modnotice &>

            <table width="100%">
            <tr>
% unless ($fCompact) {
            <td style="padding-right: 1em">
				<a href="/showartist.html?artistid=<% $artist->GetId() %>&amp;ex=<% $exall %>&amp;compact=0">
				<img src="/images/plus.gif" align="middle"
					 alt="Expand" title="Expand All Albums"
					 height="13" width="13" border="0"> Expand All</a>
            </td>
            <td style="padding-right: 1em">
				<a href="/showartist.html?artistid=<% $artist->GetId() %>&amp;compact=0">
				<img src="/images/minus.gif" align="middle"
					 alt="Collapse" title="Collapse All Albums"
					 height="13" width="13" border="0"> Collapse All</a>
            </td>
% }
            <td style="padding-right: 1em">
				<a href="/artist/<% $artist->GetMBId %>.html?compact=<%
					$fCompact ?  0 : 1
					%>&amp;mbt=<% $mbt?1:0 %>"
					>Change to <% $fCompact ? "full" : "compact" %> listing</a>
			</td>

%           if ($session{uid}) {
    	    <td align="center">

            <form method="post" action="/edit/albumbatch/done.html"
                  id="BatchOp"
                  enctype="application/x-www-form-urlencoded">
%            for my $album (@albums) {
                 <input type="hidden" name="AlbumId<% $album->GetId() %>" value="">
%            }

	          <script type="text/javascript">
   			  document.writeln('<\input type="image" alt="Batch Operation" title="Moderate a batch of selected albums" src="/images/batch.gif" style="border: 0; height: 13px; width: 13px"\>');
	          document.writeln('<\a href="#" onclick="document.forms.BatchOp.submit(); return false">Batch Operation<\/a>');
      	    </script>
       </form>

	    </td>
%           }

            </tr></table>
            <& /comp/framedboxend &>
			<br>

            <%perl>
			if ($fCompact)
			{
				</%perl>
				<table id="CompactReleaseList">
					<col style="text-align: right">
					<col style="text-align: right">
					<col style="text-align: right">
					<col style="text-align: center">
					<col style="text-align: center">
					<col style="text-align: center">
% if ($session{uid}) {
					<col style="width: 3em">
% }
					<col>
				<%perl>
			}

            my $last = "";
			my $rownum = 0;

            for my $album (@albums)
            {
                if ($last ne $album->{_section_key_})
                {
					my $va = $album->{_is_va_} ? "Various Artist" : "";
					my $name = $album->GetAttributeNamePlural($album->{_attr_type});
					$name = "Uncategorized Releases" if $name eq "";

					my $desc = ($name ? "$va $name" : $va ? $va."s" : "None");
					$m->comp("/comp/albumtype", text => $desc)
						unless $fCompact;

					if ($fCompact)
					{
						my $s = 7;
						++$s if $session{'uid'};
						</%perl>
						<tr><th colspan='<% $s %>' align="left"><h2><% $desc %></h2></th></tr>
						<%perl>
					}

                    $last = $album->{_section_key_};
					$rownum = 0;
                }

                my $id = $album->GetId();
				++$rownum;

				if ($fCompact)
				{
					my $amp = $album->GetAttributeModPending;
					my $nmp = $album->GetModPending;

					</%perl>
					<tr class="<% ('ev', 'od')[$rownum % 2] %>">
% if ($album->GetTrackCount) {
						<td class="trk" nowrap><% $album->GetTrackCount %><img src="/images/notes.gif" hspace="3" alt="Tracks"></td>
% } else {
						<td></td>
% }
% if ($album->GetDiscidCount) {
						<td class="did" nowrap><% $album->GetDiscidCount %><img src="/images/cd.gif" hspace="3" alt="disc IDs"></td>
% } else {
						<td></td>
% }
% if ($album->GetTrmidCount) {
						<td class="trm" nowrap><% $album->GetTrmidCount %><img src="/images/trm.gif" hspace="3" alt="TRM IDs"></td>
% } else {
						<td></td>
% }
						<td class="rst" nowrap><%
								$amp ? "<span class='mp'>" : "" |n
							%><% do {
								my $s = $album->{_actual_attr_status};
								$s ? ($album->GetAttributeName($s)||"?$s") : "None"
							} %><%
								$amp ? "</span>" : "" |n
						%></td>
						<td class="rdate" nowrap>
%							$m->comp('/comp/releasedate', $album->GetFirstReleaseDateYMD);
						</td>
						<td class="lang">
%							$m->comp('/comp/language', $album->GetLanguage, $album->GetScript);
						</td>
% if ($session{uid}) {
						<td class="rtag">
						  <form method="post" action="/edit/albumbatch/done.html"
								enctype="application/x-www-form-urlencoded">
							  <script type="text/javascript">
								  document.writeln('<\input type="checkbox" name="check" onchange="document.forms.BatchOp.AlbumId<% $album->GetId %>.value = this.form.check.checked ? \'on\' : \'\';">');
							  </script>
							  <noscript>
								  <input type="hidden" name="AlbumId<% $album->GetId %>" value="1">
								  <input type="submit" name="submit" value="Select">
							  </noscript>
						  </form>
						</td>
% }
						<td class="rname">
%            if ($session{tport}) {
						<a href="http://127.0.0.1:<% $session{tport} %>/openalbum?id=<% $album->GetMBId %>&amp;t=<% time %>"
							style="margin-right: 1ex"
							target="hiddeniframe" title="Open in Tagger" border="0"><img
								src="/images/mblookup-tagger.png" border="0" alt="Open in tagger"></a>
%            }
						<% $nmp ? "<span class='mp'>" : "" |n
							%><a href="/album/<% $album->GetMBId %>.html"><% $album->GetName %></a><%
								$nmp ? "</span>" : "" |n
						%></td>
					</tr>
					<%perl>
				}
                elsif ($ex =~ /(^|\D)$id(\D|$)/)
                {
                     $m->comp("/comp/album",
                             album=>$album,
                             artist=>$artist,
                             ex=>$ex,
                             showcollapsed=>1,
                             showids=>0,
                             mbtagger=>$mbt,
                             showtag=>1,
							 showmodlinks => 0,
							 showreleases => 1);
                }
                else
                {
                     $m->comp("/comp/albumcollapsed",
                             album=>$album,
                             artist=>$artist,
                             ex=>$ex,
                             showids=>0,
                             showtag=>1);
                }
            }

			$m->out("</table><br><br>") if $fCompact;

            </%perl>
            <%perl>
        }
    }

</%perl>

<& /comp/footer &>

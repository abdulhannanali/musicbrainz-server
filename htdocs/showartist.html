%# vi: set ts=4 sw=4 ft=mason :
<%args>
$ex=>""
$mbt=>0
</%args>

<%perl>

# TODO: Remove this if for release
my $show_related = eval {
	my $ip = $r->connection->remote_ip;
	return 1 if $ip =~ /^10\./;
	return 1 if $ip =~ /^127\./;
	return 1 if $ip =~ /^172\.(\d+)\./
		and $1>=16 and $1<32;
	return 1 if $ip =~ /^192\.168\./;
	0;
};

sub CheckAttributes
{
    my ($a) = @_;
    my ($attr, @aattr);

    @aattr = $a->GetAttributes();
    foreach $attr (@aattr)
    {  
        $a->{_attr_type} = $attr if ($attr >= Album::ALBUM_ATTR_SECTION_TYPE_START &&
                                     $attr <= Album::ALBUM_ATTR_SECTION_TYPE_END);
        $a->{_attr_status} = $attr if ($attr >= Album::ALBUM_ATTR_SECTION_STATUS_START &&
                                       $attr <= Album::ALBUM_ATTR_SECTION_STATUS_END);
        $a->{_attr_type} = $attr if ($attr == Album::ALBUM_ATTR_NONALBUMTRACKS);
    }
    $a->{_attr_type} = Album::ALBUM_ATTR_SECTION_TYPE_END + 1 if (not defined $a->{_attr_type});
    $a->{_attr_status} = Album::ALBUM_ATTR_SECTION_STATUS_END + 1 if (not defined $a->{_attr_status});
}

# Sort by:
# 'Various' (non-VA, VA);
# 'NonAlbum' (NonAlbum, Album)
# 'Type' (album type)
# 'Name' (lowercase)
# 'Status' (release status)

sub SortAlbums
{
	# Note: false ("") sorts before true (1)
	($a->{_is_va_} <=> $b->{_is_va_})
	or
	# Note: false ("") sorts before true (1)
	($b->{_is_nonalbum_} <=> $a->{_is_nonalbum_})
	or
	($a->{_attr_type} <=> $b->{_attr_type})
	or
	($a->{_name_sort_} cmp $b->{_name_sort_})
	or
	($a->{_attr_status} <=> $b->{_attr_status})
}

my ($mb); 
my (@albums, $artist, $album); 

if (!exists $ARGS{artistid} || $ARGS{artistid} eq '')
{
    mc_comp("/comp/sidebar", title=>"Error");
    mc_comp("/comp/badargs");
    return undef;
}

$mb = mc_comp("/comp/dblogin");
$artist = Artist->new($mb->{DBH});
$album = Album->new($mb->{DBH});

$artist->SetId($ARGS{artistid});
if (! $artist->LoadFromId())
{
    mc_comp("/comp/sidebar", title=>"Error");
    mc_out("This artist (id=$ARGS{artistid}) was not found in the database.");
}
else
{
    mc_comp("/comp/sidebar", title=>'',
            pagetitle=>"Artist: " . $artist->GetName());

    if ($ARGS{artistid} == ModDefs::DARTIST_ID)
    {
        mc_out("<font size=\"+2\">Deleted Artist</font><p>");
        mc_out("<table width=\"100%\"><tr><td align=\"center\">");
        mc_out("<font size=\"+1\">This artist is a placeholder for the ");
        mc_out("moderation system. Please do not use it.</font>");
        mc_out("</td></tr></table>");
        return undef;
    }


    mc_comp("/comp/artisttitle", artist=>$artist);
    
    mc_out("[ ");
    if (exists $session{uid})
    {
        </%perl>
        <a href="/addalbum.html?artistid=<% $artist->GetId() %>">Add 
           album</a> | 
        <a href="/freedb/freedb.html?search=<% $artist->GetName() |u %>">Import
           album</a> |
        <%perl>
    }
    else
    {
        </%perl>
        <a href="/mod_intro.html">Edit data</a> | 
        <%perl>
    }

    mc_out("<a href=\"/showaliases.html?artistid=");
    mc_out($artist->GetId());
    mc_out("\">Aliases</a> ");

    if ($show_related)
    {
	mc_out("| <a href=\"/artistrel.html?artistid=");
	mc_out($artist->GetId());
	mc_out("\">Related artists</a> ");
    }

    if ($artist->GetName() ne "Unknown" && 
        $artist->GetId() != ModDefs::VARTIST_ID && 
        $artist->GetId() != ModDefs::DARTIST_ID && 
        $artist->GetName() ne "Data CD")
    {
        if (exists $session{uid})
        {
            </%perl>
            | <a href="/moderate.html?type=4&amp;artistid=<% $artist->GetId() %>"
               >View mods</a>
            <%perl>
        }

        mc_out(" | ");
        mc_comp("/comp/googlelink", search=>($artist->GetName()), 
            text=>"Search Google"); 
    }
    mc_out("]<br>");

	my $relations = $artist->GetRelations();

	if (@$relations and $show_related)
	{
		splice(@$relations, 3) if @$relations > 3;
		</%perl>

		<p>
		<& /comp/framedboxbegin, width=>"100%" &>
		<div style="padding: 0.2em; position: relative">
			<font color="red">New!</font>&nbsp;
			Related artists:

%			for my $rel (@$relations) {
			<a href="/showartist.html?artistid=<% $rel->{id} %>"
				><% $rel->{name} %></a>,
%			}

		<a href="/artistrel.html?artistid=<% $artist->GetId %>">more...</a>
		<& /comp/framedboxend &>

		<%perl>
	}

    if ($ARGS{artistid} == ModDefs::VARTIST_ID)
    {
        </%perl>
        <table width="100%"><tr><td align="center">
        <font size="+1">There are too many albums to list.</font>
        <p>Please use the <a href="search.html">Search Page</a>
         to look for a specific album,<br>
         or browse the various artist albums:<p>
        <& /comp/browsebox, page=>"/browsevarious.html" &>
        </td></tr></table>
        <%perl>
    }
    else
    {
        @albums = $artist->GetAlbums(0, 1);
        if (scalar(@albums) == 0)
        {
            mc_out("<center>This artist has no albums.<br>");
            mc_out("[ <a href=\"remartist.html?artist=$ARGS{artistid}\">");
            mc_out("Remove this artist</a> ]</center><br>");
        }
        else
        {
            my ($count, $exall, $id, $hasnonalbum);


            $count = 0;
            $hasnonalbum = 0;
            foreach $album (@albums)
            {
                $id = $album->GetId();
                $exall .= "," if ($count > 0);
                $exall .= $id;
                $count++;

                $hasnonalbum += $album->IsNonAlbumTracks();
                CheckAttributes($album);

				$album->{_is_va_} = ($album->GetArtist == ModDefs::VARTIST_ID);
				$album->{_is_nonalbum_} = ($album->{_attr_type} == Album::ALBUM_ATTR_NONALBUMTRACKS);

				$album->{_section_key_} = (
					$album->{_is_va_} . " " . $album->{_attr_type}
				);

				# Munge name for sorting
				use Encode qw( decode );
				$album->{_name_sort_} = lc decode "utf-8", $album->GetName;
            }

            @albums = sort SortAlbums @albums;

            </%perl>

            <form method="post" action="/mod/tag/donetag.html" 
                  id="EditAlbumAttrsForm"
                  enctype="application/x-www-form-urlencoded"> 

            <& /comp/framedboxbegin, width=>"100%" &>
            <& /comp/modnotice &>

            <table width="100%">
            <tr>
            <td align="center">

            <a href="/showartist.html?artistid=<% $artist->GetId() %>&amp;ex=<% $exall %>">
            <img src="/images/plus.gif" align="middle"
                 alt="Expand" title="Expand All Albums"
                 height="13" width="13" border="0"> Expand All</a>
    
            </td>
            
            <td align="center">
            <a href="/showartist.html?artistid=<% $artist->GetId() %>">
            <img src="/images/minus.gif" align="middle"
                 alt="Collapse" title="Collapse All Albums"
                 height="13" width="13" border="0"> Collapse All</a>
            </td>

%           if (exists $session{user}) {
    	    <td align="center">

            <input name="submit" type="image" border="0" alt="Batch Operation" 
                   title="Moderate a batch of selected albums"
                   src="/images/batch.gif" height="13" width="13">

	    <script type="text/javascript">
	    document.writeln('<\a href="#" onclick="document.forms.EditAlbumAttrsForm.submit(); return false">Batch Operation<\/a>');
	    </script>
	    <noscript>
	    <input type="submit" value="Batch Operation">
	    </noscript>

	    </td>
%           }

            </tr></table>
            <& /comp/framedboxend &>
            <br>

            <%perl>
            my $last = "";
            foreach $album (@albums)
            {
                if ($last ne $album->{_section_key_})
                {
					my $va = $album->{_is_va_} ? "Various Artist" : "";
					my $name = $album->GetAttributeNamePlural($album->{_attr_type});
					$name = "Uncategorized Releases" if $name eq "";

					my $desc = ($name ? "$va $name" : $va ? $va."s" : "None");
                    mc_comp("/comp/albumtype", text => $desc);

                    $last = $album->{_section_key_};
                }

                $id = $album->GetId();
                $exall .= "," if ($count > 0);
                $exall .= $id;

                if ($ex =~ /(^|\D)$id(\D|$)/) 
                {
                     mc_comp("/comp/album", 
                             album=>$album, 
                             artist=>$artist, 
                             ex=>$ex,
                             showcollapsed=>1,
                             showids=>0,
                             mbtagger=>$mbt,
                             showtag=>1);
                }
                else
                {
                     mc_comp("/comp/albumcollapsed", 
                             album=>$album, 
                             artist=>$artist, 
                             ex=>$ex,
                             showids=>0,
                             showtag=>1);
                }
            }
            </%perl>
            </form>
            <%perl>
            if (!$hasnonalbum)
            {
                </%perl>
                <table width="100%"><tr><td align="center">[ 
                <a href="/addalbum.html?artistid=<% $artist->GetId() %>&amp;nonalbum=1">Add non-album 
                tracks</a> ]</td></tr></table>
                <%perl>
            }
        }
    }
}

$mb->Logout();

</%perl>
<& /comp/footer &>

<& /comp/sidebar, title=>'Show TRM Id' &>
<%perl>

my ($mb, $gu, $album, $artist); 
my ($albumid, $trackid, @albums, @ids); 

if (!exists $ARGS{guid})
{
    mc_out("This page needs a guid argument.");
}
else
{
   mc_out("<font size=+1><b>TRM Id: $ARGS{guid}</b></font><p>");

   if ($ARGS{guid} eq "7d154f52-b536-4fae-b58b-0666826c2bac")
   {
       mc_out("<p><br>This TRM Id represents silence.<p>");
   }
   else
   {
       $mb = new MusicBrainz;
       $mb->Login();
       $artist = Artist->new($mb->{DBH});
       $album = Album->new($mb->{DBH});
       $gu = GUID->new($mb->{DBH});
    
       @ids = $gu->GetTrackIdsFromGUID($ARGS{guid});
       if (scalar(@ids) == 0)
       {
           mc_out("<p>This TRM Id was not found in the main database.<p>");
       }
       else
       {
           foreach $trackid (@ids)
           {
              @albums = $album->GetAlbumIdsFromTrackId($trackid);
              foreach $albumid (@albums)
              {
                 $album->SetId($albumid);
                 if ($album->LoadFromId())
                 {
                    $artist->SetId($album->GetArtist());
                    if ($artist->LoadFromId())
                    {
                        mc_comp("comp/album", 
                                album=>$album, 
                                artist=>$artist,
                                hilitetrack=>$trackid);
                    }
                 }
              }
           }
       }

       mc_out("&nbsp;<p>");
       mc_comp("/comp/title", title=>'Pending Metadata');
       mc_comp("/comp/showpendingpage", offset=>0, guid=>$ARGS{guid});

       $mb->Logout;
   }
}

</%perl>

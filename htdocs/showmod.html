%# vi: set ts=4 sw=4 ft=mason :
<%args>
$modid=>0
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1)
	or return;

MusicBrainz::IsNonNegInteger($modid) && $modid
	or $modid = 0;

my $mb = $m->comp("/comp/dblogin");

my $mod = undef;

if ($modid)
{
	$mod = Moderation->new($mb->{DBH});
	$mod = $mod->CreateFromId($modid);
}

if (&DBDefs::DB_STAGING_SERVER and $mod)
{
	if ($ARGS{'ACCEPT'} or $ARGS{'REJECT'})
	{
		my $sql = Sql->new($mb->{DBH});

		eval {
			$sql->Begin;
			my $user = UserStuff->new($mb->{DBH});

			if ($ARGS{'ACCEPT'})
			{
				my $status = $mod->ApprovedAction;
				$mod->SetStatus($status);
				$user->CreditModerator($mod->GetModerator, $status);
				$mod->CloseModeration($status);
			} else {
				$mod->DeniedAction;
				$user->CreditModerator($mod->GetModerator, &ModDefs::STATUS_FAILEDVOTE);
				$mod->CloseModeration(&ModDefs::STATUS_FAILEDVOTE);
			}

			$sql->Commit;
		} or do {
			my $err = $@;
			$sql->Rollback;
			</%perl>
			<div style="color: red">
				<p>Error applying moderation:</p>
				<pre><% $err %></pre>
			</div>
			<%perl>
		};

		$mod = Moderation->new($mb->{DBH});
		$mod = $mod->CreateFromId($modid);
	}
}

</%perl>

<& /comp/sidebar, title => $mod ? "Moderation #$modid" : "Show Moderation" &>

% if ($modid and not $mod) {
<p>
	Moderation #<% $modid %> not found.
</p>
% }

% if ($mod) {
<& /comp/showmoddetail, $mod &>
% }

% if ($modid) {
<p>
	[
% if ($modid > 1) {
		<a href="/showmod.html?modid=<% $modid-1 %>">back one</a>
		|
% }
		<a href="/showmod.html?modid=<% $modid+1 %>">forward one</a>
		]
		<br>
		(note: there may be gaps in the sequence of moderation numbers)
</p>
% }

<& /comp/jumpmod, $modid &>

<& /comp/footer &>

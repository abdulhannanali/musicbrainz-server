%# vi: set ts=4 sw=4 ft=mason :
<%args>
$modid=>0
</%args>

<& /comp/sidebar, title=> "Moderation #$modid" &>

<%perl>

$m->comp("/comp/checkloggedin", 0, 1)
	or return;

MusicBrainz::IsNonNegInteger($modid) && $modid
	or return $m->comp("/comp/badargs", 0, 1);

my $mb = $m->comp("/comp/dblogin");

my $mod = Moderation->new($mb->{DBH});
$mod = $mod->CreateFromId($modid);

if (!defined $mod)
{
	$m->out("<p>Moderation $modid does not exist.</p>");
	$m->comp("/comp/jumpmod");
	$m->comp("/comp/movefocus", "JumpMod", "modid");
	$m->comp("/comp/footer");
    return undef;
}

my ($ref, $obj, $bold, $text, $voted);
my (@votes, $votelist);

if ($session{user} eq $mod->GetModeratorName()) 
{
   $text = "Your Moderation. Thanks!";
}
elsif (defined($voted = $mod->GetUserVote($session{uid})))
{
   $text = $mod->GetVoteText($voted);
}
else
{
   if ($mod->GetStatus() == ModDefs::STATUS_OPEN)
   {
      $text = "You haven't voted.";
   }
   else
   {
      $text = "You didn't vote.";
   }
   $voted = ModDefs::VOTE_NOTVOTED;
}

my $opentime = $mod->GetOpenTime();
$opentime = $opentime ? $m->comp("/comp/datetime", $opentime) : "?";

my $closetime = $mod->GetCloseTime();
$closetime = $closetime ? $m->comp("/comp/datetime", $closetime) : "-";

my $time = $mod->GetExpireTime();
$time = $m->comp("/comp/datetime", $time);

my $expired = ($mod->GetExpired() ? "d" : "s");

@votes = $mod->GetVoterList();
$votelist = "<table>";
foreach $ref (@votes)
{
    $votelist .= "<tr><td><a href=\"/moderator.html?uid=" . $ref->{modid} . "\"> " .
                 $ref->{moderator} . "</a></td><td>" . 
                 Moderation::GetVoteText(undef, $ref->{vote}) . "<td></tr>";
}
$votelist .= "</table>";

</%perl>

<& /comp/tablebegin, title=>'Moderation Information' &> 

<table>

<tr>
   <& /comp/tableline, name=>"Moderator:", 
                       text=>($mod->GetModeratorName()),
                       bold=>1 &>
   <& /comp/tableline, name=>"MB Id:", 
                       text=>$mod->GetId(),
                       bold=>0 &>
   <& /comp/tableline, name=>"Status:", 
                       text=>$mod->GetChangeName(),
                       bold=>0 &>
   <& /comp/tableline, name=>"Opened:", 
                       text=>$opentime,
                       bold=>0 &>
   <& /comp/tableline, name=>"Expire$expired:", 
                       text=>$time,
                       bold=>0 &>
   <& /comp/tableline, name=>"Closed:", 
                       text=>$closetime,
                       bold=>0 &>

   <tr><td colspan="2"><hr></td></tr>

   <& /comp/tableline, name=>"Type:", 
                       text=>$mod->ShowModType(),
                       bold=>0 &>

   <& /comp/tableline, name=>"Previous Value:", 
                       text=>$mod->ShowPreviousValue(),
                       bold=>0 &>

   <& /comp/tableline, name=>"New Value:", 
                       text=>$mod->ShowNewValue(),
                       bold=>0 &>

   <tr><td colspan="2"><hr></td></tr>

   <& /comp/tableline, name=>"Your vote:", 
                       text=>$text,
                       bold=>0 &>
%    if ($session{uid} == $mod->GetModerator() ||
%        $mod->GetStatus() != ModDefs::STATUS_OPEN ||
%        $voted != ModDefs::VOTE_NOTVOTED) {
       <& /comp/tableline, name=>"Yes Votes:", 
                           text=>$mod->GetYesVotes(),
                           bold=>0 &>

       <& /comp/tableline, name=>"No Votes:", 
                           text=>$mod->GetNoVotes(),
                           bold=>0 &>

%      if (scalar(@votes) > 0) {
           <tr><td colspan="2"><hr></td></tr>
           <& /comp/tableline, name=>"Vote history:", 
                               text=>$votelist,
                               bold=>0 &>
%      }
%  }

   <tr><td colspan="2"><hr></td></tr>

%  my $notes = $mod->LoadModerationNotes($modid, $modid);
     <tr>
        <td valign=top bgcolor=white class="body">
          Notes:
        </td>
        <td valign=top bgcolor=white class="body">
           <a href="#" onClick="MyWindow=window.open('mod/addnote.html?modid=<% $mod->GetId() %>&amp;uid=<% $session{uid} %>','AddNote','toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=400,height=150'); return false;">Add note</a>
        </td>
     </tr>
     <tr>
        <td colspan="2" valign=top bgcolor=white class="body">
%  if (exists $notes->{ $mod->GetId() }) {
%         $ref = $notes->{ $mod->GetId() };
%         foreach $obj (@$ref) {
             &nbsp;&nbsp;&nbsp;&nbsp;
%            $bold = ($obj->{user} eq $mod->GetModeratorName()) ?  'bold' : 'body';
             <font class="<% $bold %>"><% $obj->{user} %></font>:
             <% $obj->{text} |n %><br> 
%         }
%   } else {
          &nbsp;&nbsp;&nbsp;&nbsp; No notes.
%   }
        </td>
     </tr>

    </table>
    <& /comp/tableend &> 

    <& /comp/jumpmod &> 

<& /comp/movefocus, "JumpMod", "modid" &>
<& /comp/footer &>

<%perl>

my ($mb); 
my ($track, $artist, $album, $trackid, @info, $gu, @guid, $id); 

if ((!exists $ARGS{trackid} || $ARGS{trackid} eq '') &&
    (!exists $ARGS{albumjoinid} || $ARGS{albumjoinid} eq ''))
{
    mc_comp("/comp/sidebar", title=>"Error");
    mc_comp("/comp/badargs");
    return undef;
}

$mb = new MusicBrainz;
$mb->Login();
$track = Track->new($mb->{DBH});

if (exists $ARGS{trackid})
{
    $trackid = $ARGS{trackid};
    $track->SetId($trackid);
    if (! $track->LoadFromId())
    {
        mc_comp("/comp/sidebar", title=>"Error");
        mc_out("This track (ID=$trackid) was not found<br>");
        return undef;
    }
}
else
{
    if (! $track->LoadFromAlbumJoin($ARGS{albumjoinid}))
    {
        mc_comp("/comp/sidebar", title=>"Error");
        mc_out("This track (AlbumJoinID=$ARGS{albumjoinid}) was not found<br>");
        return undef;
    }
}

$gu = GUID->new($mb->{DBH});
@guid = $gu->GetGUIDFromTrackId($track->GetId());

$artist = Artist->new($mb->{DBH});
$artist->SetId($track->GetArtist());
if (!defined $artist->LoadFromId())
{
    mc_comp("/comp/sidebar", title=>"Error");
    mc_out("Could not load artist.");
}
else
{
    mc_comp("/comp/sidebar", title=>"Track Details: " . $track->GetName());
}

</%perl>

    <& /comp/tablebegin, title=>'Track Information' &> 
    <table>
    <tr>
    <td valign="top" align="right">Title:</td>
    <td valign="top"><% $track->GetName() %></td>
    </tr><tr>
    <td valign="top" align="right">Track MB Id:</td>
    <td valign="top"><% $track->GetMBId() %></td>
    </tr><tr>
    <td valign="top" align="right"><a href="/MM/index.html">MM/RDF</a></td>
    <td valign="top"><a 
       href="http://mm.musicbrainz.org/track/<% $track->GetMBId() %>">
       http://mm.musicbrainz.org/track/<% $track->GetMBId() %></a></td>
    </tr><tr>
% if (exists $session{user}) {
    <td valign="top" align="right">Track RowId:</td>
    <td valign="top"><% $track->GetId() %></td>
    </tr><tr>
% }
% foreach $id (@guid) {
    <td valign="top" align="right">Track TRM Id:</td>
    <td valign="top"><% $id %></td>
    </tr><tr>
% }
    </table>
    <& /comp/tableend &> 
    <& /comp/tablebegin, title=>'Artist Information' &> 
    <table>
    <tr>
    <td valign="top" align="right">Artist:</td>
    <td valign="top"><a href="/showartist.html?artistid=<% $artist->GetId() %>"><% $artist->GetName() %></a></td>
    </tr><tr>
    <td valign="top" align="right">Artist MB Id:</td>
    <td valign="top"><% $artist->GetMBId() %></a></td>
    </tr><tr>
    <td valign="top" align="right"><a href="/MM/index.html">MM/RDF</a></td>
    <td valign="top"><a 
       href="http://mm.musicbrainz.org/artist/<% $artist->GetMBId() %>">
       http://mm.musicbrainz.org/artist/<% $artist->GetMBId() %></a></td>
    </tr><tr>
% if (exists $session{user}) {
    <td valign="top" align="right">Artist RowId:</td>
    <td valign="top"><% $artist->GetId() %></a></td>
    </tr><tr>
% }


    </tr>
    </table>
    <& /comp/tableend &> 

<%perl>

    @info = $track->GetAlbumInfo();
    if (scalar(@info) == 0)
    {
        mc_out("Could not load albums.");
    }
    else
    {
        foreach $album (@info)
        {
</%perl>
            <& /comp/tablebegin, title=>"Album: $$album[1]", 
                                 gattrs=>'width="100%"' &>
            <table>
            <tr>
            <td valign="top" align="right">Title:</td>
            <td valign="top"><a href="/showalbum.html?albumid=<% $$album[0] %>"><% $$album[1] %></a></td>
            </tr><tr>
            <td valign="top" align="right">Album MB Id:</td>
            <td valign="top"><% $$album[3] %></td>
            </tr><tr>

            <td valign="top" align="right"><a 
                href="/MM/index.html">MM/RDF</a></td>
            <td valign="top"><a 
              href="http://mm.musicbrainz.org/album/<% $$album[3] %>">
              http://mm.musicbrainz.org/album/<% $$album[3] %></a></td>

% if (exists $session{user}) {
            </tr><tr>
            <td valign="top" align="right">Album RowId:</td>
            <td valign="top"><% $$album[0] %></td>
% }
            </tr>
            </table>
            <center>
            This track appears as track number <% $$album[2] %> on this album.
            <& /comp/tableend &>
<%perl>
        }
    }

$mb->Logout();

</%perl>


%# vi: set ts=4 sw=4 ft=mason :
<%args>
$trackid => ""
</%args>
<%perl>

MusicBrainz::IsNonNegInteger($trackid) && $trackid
	or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");

my $track = Track->new($mb->{DBH});
$track->SetId($trackid);
$track->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Track #$trackid not found in the database.",
		1, 1,
	);

my @TRM = TRM->new($mb->{DBH})->GetTRMFromTrackId($track->GetId);

my $artist = Artist->new($mb->{DBH});
$artist->SetId($track->GetArtist);
$artist->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);

</%perl>

<& /comp/sidebar, title => "Track Details: " . $track->GetName &>

<& /comp/trackinfo, track => $track, TRM => \@TRM &>

<& /comp/artistinfo, artist => $artist &>

<%perl>

my @info = $track->GetAlbumInfo;

if (@info)
{
	for (@info)
	{
		my $album = Album->new($mb->{DBH});
		$album->SetId($_->[0]);
		$album->SetName($_->[1]);
		$album->SetMBId($_->[3]);

		$m->comp(
			"/comp/albuminfo",
			album => $album,
			track => $_->[2],
		);
	}
} else {
	$m->out("Could not load albums.");
}

</%perl>

<& /comp/footer &>

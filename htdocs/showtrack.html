%# vi: set ts=4 sw=4 ft=mason :
<%args>
$trackid => ""
$mbid => ""
$albumjoinid => ""
$tport=>$session{'tport'}
$addrel=>0
$remrel=>-1
$remtype=>""
$arcancel=>0
</%args>
<%perl>

if ($trackid ne "") {
	MusicBrainz::IsNonNegInteger($trackid) && $trackid
		or return $m->comp("/comp/badargs", 1, 1);
} elsif ($mbid ne "") {
	MusicBrainz::IsGUID($mbid)
		or return $m->comp("/comp/badargs", 1, 1);
} else {
	MusicBrainz::IsNonNegInteger($albumjoinid) && $albumjoinid
		or return $m->comp("/comp/badargs", 1, 1);
}
UserStuff::EnsureSessionOpen(), $session{tport} = $tport
  if $tport;

my $mb = $m->comp("/comp/dblogin");

my $track = Track->new($mb->{DBH});

if ($trackid) {
	$track->SetId($trackid);
	$track->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Track #$trackid not found in the database.",
			1, 1,
		);
} elsif ($mbid) {
	$track->SetMBId($mbid);
	$track->LoadFromId
		or return $m->comp(
			"/comp/error",
			"Track $mbid not found in the database.",
			1, 1,
		);
} else {
	$track->LoadFromAlbumJoin($albumjoinid)
		or return $m->comp(
			"/comp/error",
			"Track #$albumjoinid not found in the database.",
			1, 1,
		);
}

my @TRM = TRM->new($mb->{DBH})->GetTRMFromTrackId($track->GetId);
my @PUID = PUID->new($mb->{DBH})->GetPUIDFromTrackId($track->GetId);

my $artist = Artist->new($mb->{DBH});
$artist->SetId($track->GetArtist);
$artist->LoadFromId
	or return $m->comp(
		"/comp/error",
		"Artist not found in the database.",
		1, 1,
	);

</%perl>

<& /comp/sidebar, title => "Track Details: " . $track->GetName &>

<div class="LinksRow"> [
	<& /comp/googlelink, search => [ $artist->GetName, $track->GetName ], text => "Search Google" &>
	| <a href="/mod/search/pre/track.html?trackid=<% $track->GetId %>&amp;artistid=<% $artist->GetId %>">View track mods under current artist</a>
	| <a href="/mod/search/pre/track.html?trackid=<% $track->GetId %>">View all track mods</a>
] </div>

%# show any related moderations so people can vote on them
<& /comp/relmods, artistid => $artist->GetId &>

%# Show the relationships for this track

% if ($addrel) {
    <& /comp/ar/AddRelationship, id=>$track->GetId, type=>'track', name=>$track->GetName &>
% }

% if ($arcancel) {
     <& /comp/ar/ClearRelationships &>
% }

% if ($remrel >= 0) {
     <& /comp/ar/RemoveRelationship, id=>$remrel, type=>$remtype &>
% }

<& /comp/ar/RelationshipBox, id=>$track->GetId, type=>'track', name=>$track->GetName &>

<& /comp/trackinfo, track => $track, TRM => \@TRM, PUID => \@PUID &>

<& /comp/artistinfo, artist => $artist &>

<%perl>

my @info = $track->GetAlbumInfo;

if (@info)
{
	for (@info)
	{
		my $album = Album->new($mb->{DBH});
		$album->SetId($_->[0]);
		$album->SetName($_->[1]);
		$album->SetMBId($_->[3]);
		# FIXME need API in Album.pm
		$album->{attrs} = [ $_->[4] =~ /(\d+)/g ];

		$m->comp(
			"/comp/albuminfo",
			album => $album,
			track => $_->[2],
		);
	}
} else {
	$m->out("Could not load albums.");
}

</%perl>

<& /comp/footer &>

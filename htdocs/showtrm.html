%# vi: set ts=4 sw=4 ft=mason :
<& /comp/sidebar, title=>'Show TRM Id' &>
<%perl>

my ($mb, $gu, $album, $artist); 
my ($albumid, $trackid, @albums, @ids); 

if (!exists $ARGS{trm})
{
    $m->out("This page needs a trm argument.");
}
else
{
	# TODO HTML-encode
   $m->out("<font size='+1'><b>TRM Id: $ARGS{trm}</b></font><p>");

   if ($ARGS{trm} eq "7d154f52-b536-4fae-b58b-0666826c2bac")
   {
       $m->out("<p><br>This TRM Id represents silence.<p>");
   }
   else
   {
       $mb = $m->comp("/comp/dblogin");
       $artist = Artist->new($mb->{DBH});
       $album = Album->new($mb->{DBH});
       $gu = TRM->new($mb->{DBH});
    
       @ids = $gu->GetTrackIdsFromTRM($ARGS{trm});
       if (scalar(@ids) == 0)
       {
           $m->out("<p>This TRM Id was not found in the main database.<p>");
       }
       else
       {
           foreach $trackid (@ids)
           {
              @albums = $album->GetAlbumIdsFromTrackId($trackid);
              foreach $albumid (@albums)
              {
                 $album->SetId($albumid);
                 if ($album->LoadFromId())
                 {
                    $artist->SetId($album->GetArtist());
                    if ($artist->LoadFromId())
                    {
						$m->comp("/comp/artisttitle", artist => $artist);
                        $m->comp("comp/album", 
                                album=>$album, 
                                artist=>$artist,
                                hilitetrack=>$trackid);
                    }
                 }
              }
           }
       }

       $mb->Logout;
   }
}

</%perl>
<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$trm => undef
</%args>
<& /comp/sidebar, title=>'Show TRM Id' &>
<%perl>

unless (MusicBrainz::IsGUID($trm))
{
    $m->out("This page needs a trm argument.");
}
else
{
	$trm = lc $trm;

	</%perl>
	<h2><b>TRM Id: <% $trm %></b></h2>
	<%perl>

   if ($trm eq &ModDefs::TRM_ID_SILENCE)
   {
       $m->out("<p><br>This TRM Id represents silence.<p>");
   }
   elsif ($trm eq &ModDefs::TRM_TOO_SHORT)
   {
       $m->out("<p><br>This TRM Id indicates that the source file is too short.<p>");
   }
   elsif ($trm eq &ModDefs::TRM_SIGSERVER_BUSY)
   {
       $m->out("<p><br>This TRM Id gets returned when the TRM signature server is too busy to process the TRM calculation request.<p>");
   }
   else
   {
       my $mb = $m->comp("/comp/dblogin");
       my $artist = Artist->new($mb->{DBH});
       my $album = Album->new($mb->{DBH});
       my $gu = TRM->new($mb->{DBH});
    
       my $ids = $gu->GetTrackIdsFromTRM($trm);
       if (scalar(@$ids) == 0)
       {
           $m->out("<p>This TRM Id was not found in the database.<p>");
       }
       else
       {
			my %artists;
			my %albums;

			for my $trackid (@$ids)
			{
				my @albums = $album->GetAlbumIdsFromTrackId($trackid);
				for my $albumid (@albums)
				{
					$albums{$albumid} ||= do {
						my $al = Album->new($mb->{DBH});
						$al->SetId($albumid);
						$al->LoadFromId
							or $al = "0 but true"; # load failed
						$al;
					};
					ref(my $al = $albums{$albumid})
						or next;

					$artists{$al->GetArtist} ||= do {
						my $ar = Artist->new($mb->{DBH});
						$ar->SetId($al->GetArtist);
						$ar->LoadFromId
							or $ar = "0 but true"; # load failed
						$ar;
					};
					ref(my $ar = $artists{$al->GetArtist})
						or next;

					$ar->{_my_albums_}{$albumid} ||= $al;
					$al->{_my_tracks_}{$trackid} = 1;
				}
			}

			# For each artist in sortname order...
			my @ar = values %artists;
			@ar = map {
					$_->[0]
				} sort {
					$a->[1] cmp $b->[1]
				} map {
					my $n = MusicBrainz::NormaliseSortText($_->GetSortName);
					[ $_, $n ];
				} @ar;

			for my $ar (@ar)
			{
				$m->comp("/comp/artisttitle", artist => $ar);

				# For albums in name order...
				my @al = values %{ $ar->{_my_albums_} };
				@al = map {
						$_->[0]
					} sort {
						$a->[1] cmp $b->[1]
					} map {
						my $n = MusicBrainz::NormaliseSortText($_->GetName);
						[ $_, $n ];
					} @al;

				for my $al (@al)
				{
					$m->comp(
						"/comp/album", 
						album		=> $al, 
						artist		=> $ar,
						hilitetrack	=> $al->{_my_tracks_},
					);
				}
			}
       }

       $mb->Logout;
   }
}

</%perl>
<& /comp/footer &>

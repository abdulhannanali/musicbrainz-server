%# vi: set ts=4 sw=4 ft=mason :
<%args>
$trm => undef
</%args>
<& /comp/sidebar, title=>'Show TRM Id' &>
<%perl>

unless (MusicBrainz::IsGUID($trm))
{
    $m->out("This page needs a trm argument.");
}
else
{
	</%perl>
	<h2><b>TRM Id: <% $ARGS{trm} %></b></h2>
	<%perl>

   if ($ARGS{trm} eq &ModDefs::TRM_ID_SILENCE)
   {
       $m->out("<p><br>This TRM Id represents silence.<p>");
   }
   else
   {
       my $mb = $m->comp("/comp/dblogin");
       my $artist = Artist->new($mb->{DBH});
       my $album = Album->new($mb->{DBH});
       my $gu = TRM->new($mb->{DBH});
    
       my @ids = $gu->GetTrackIdsFromTRM($ARGS{trm});
       if (scalar(@ids) == 0)
       {
           $m->out("<p>This TRM Id was not found in the database.<p>");
       }
       else
       {
           for my $trackid (@ids)
           {
              my @albums = $album->GetAlbumIdsFromTrackId($trackid);
              for my $albumid (@albums)
              {
                 $album->SetId($albumid);
                 if ($album->LoadFromId())
                 {
                    $artist->SetId($album->GetArtist());
                    if ($artist->LoadFromId())
                    {
						$m->comp("/comp/artisttitle", artist => $artist);
                        $m->comp("comp/album", 
                                album=>$album, 
                                artist=>$artist,
                                hilitetrack=>$trackid);
                    }
                 }
              }
           }
       }

       $mb->Logout;
   }
}

</%perl>
<& /comp/footer &>

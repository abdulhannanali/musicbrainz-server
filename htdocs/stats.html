<& /comp/sidebar, title=>'Database Stats', expand=>'information' &>

<%perl>
my $result = $m->cache(action=>'retrieve');
#$result = undef;
if (!defined($result)) 
{
    my $mb = mc_comp("/comp/dblogin");

    my @current = gmtime(time());
    my $t = sprintf "%d-%02d-%02d %02d:%02d:%02d",
              $current[5] + 1900,
              $current[4]+1,
              $current[3],
              $current[2], $current[1], $current[0];
   
    $result = "<tr><td>Generated on: $t</td></tr>";

    $result .= '<tr><td>&nbsp;<br><font class="bold">';
    $result .= 'Basic Metadata Statistics</font></td></tr>';

    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Artist", 
                       title=>"Artists:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Album", 
                       title=>"Albums:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Track", 
                       title=>"Tracks:");

    $result .= '<tr><td>&nbsp;<br><font class="bold">';
    $result .= 'Metadata Identifier Statistics</font></td></tr>';

    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from TRM", 
                       title=>"TRM Ids:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Discid", 
                       title=>"Discids:");

    $result .= '<tr><td>&nbsp;<br><font class="bold">';
    $result .= 'User Statistics</font></td></tr>';

    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Moderator", 
                       title=>"Users:");
    $result .= mc_comp("/comp/tablestat", 
                       mb=>$mb,
                       query=>qq|select Moderator.name, 
                                        count(Moderator.id) as num 
                                   from Moderation,Moderator 
                                  where Moderation.Moderator = Moderator.id 
                                        and Moderator.id != | .
                                        ModDefs::FREEDB_MODERATOR . qq|
                                        and ExpireTime - interval '| .
                                        DBDefs::MOD_PERIOD . qq| seconds' > 
                                            now() - interval '1 week' 
                               group by Moderator.ModsAccepted, Moderator.name 
                               order by num desc limit 10|,
                       title=>"Most active moderators in the last week:<br>".
                              "(Open and accepted moderations)",
                       numcols=>2,
                       coltitles=>["User", "Moderations"]);

    $result .= mc_comp("/comp/tablestat", 
                       mb=>$mb,
                       query=>qq|select name, modsaccepted 
                                   from Moderator
                                        where Moderator.id != | .
                                        ModDefs::FREEDB_MODERATOR . qq|
                               order by modsaccepted desc limit 10|,
                       title=>"Most active moderators overall:<br>".
                              "(Accepted moderations only)",
                       numcols=>2,
                       coltitles=>["User", "Moderations"]);

    $result .= mc_comp("/comp/tablestat", 
                       mb=>$mb,
                       query=>qq|select Moderator.name, count(Votes.id) 
                                        as num 
                                   from Votes,Moderator 
                                  where Votes.Uid = Moderator.id 
                               group by Moderator.id, Moderator.name 
                               order by num desc limit 10|,
                       title=>"Most active voters overall:",
                       numcols=>2,
                       coltitles=>["User", "Votes"]);

    $result .= '<tr><td>&nbsp;<br><font class="bold">';
    $result .= 'Moderation Statistics</font></td></tr>';

    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Moderation", 
                       title=>"Mods:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Moderation where status = " .
                               ModDefs::STATUS_OPEN, 
                       title=>"&nbsp;&nbsp;&nbsp;Open Mods:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Moderation where status != " .
                               ModDefs::STATUS_OPEN ." and YesVotes >= NoVotes", 
                       title=>"&nbsp;&nbsp;&nbsp;Accepted Mods:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Moderation where status != " .
                               ModDefs::STATUS_OPEN ." and NoVotes > YesVotes", 
                       title=>"&nbsp;&nbsp;&nbsp;Rejected Mods:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Votes", 
                       title=>"Votes:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Votes where vote = 1", 
                       title=>"&nbsp;&nbsp;&nbsp;Yes Votes:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Votes where vote = 0", 
                       title=>"&nbsp;&nbsp;&nbsp;No Votes:");
    $result .= mc_comp("/comp/simplestat", 
                       mb=>$mb,
                       query=>"select count(*) from Votes where vote = -1", 
                       title=>"&nbsp;&nbsp;&nbsp;Abstain Votes:");
    $result .= '<tr><td>&nbsp;<br><font class="bold">';
    $result .= 'Last 30 Days Graph</font></td></tr>';
    $result .= '<tr><td><br><img src="/images/stats_30_days.png"></td></tr>';

    $mb->Logout();
    $m->cache(action=>'store', expire_next=>'hour', value=>$result);
}
</%perl>

<table cellpadding="10" cellspacing="0" border="0">
<tr>
   <td>
      <table width=100%>
      <% $result |n %>
      </table>
   </td>
</tr>
</table>  
<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$artist=>""
$artistid=>""
$album=>""
$albumid=>""
$track=>""
$trackid=>""
$tracknum=>""
$filename=>""
$trmid=>""
$duration=>0
$mbt=>$session{'mbt'}
</%args>

%###############################################################################
%# Subcomponents for displaying matches & forms
%###############################################################################

<%def .OutputArtist>
<%perl>
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId();
   }

	$m->comp(
		"/comp/artisttitle",
		artist => $ts->{artist},
	);
</%perl>
</%def>

<%def .OutputAlbum>
<%perl>
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId();
   }
   if (not exists $ts->{album})
   {
       $ts->{album} = Album->new($ts->{DBH});
       $ts->{album}->SetMBId($data->{albumid});
       $ts->{album}->LoadFromId();
   }

	$m->comp(
		"/comp/album",
		artist	=> $ts->{artist},
		album	=> $ts->{album},
		mbtagger=> $data->{mbt},
		showids	=> 1,
	);
</%perl>
</%def>

<%def .OutputTrack>
<%perl>
   my ($ts, $data) = @_;
   my (@albums, $saved);

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   if (not exists $ts->{track})
   {
       $ts->{track} = Track->new($ts->{DBH});
       $ts->{track}->SetMBId($data->{trackid});
       $ts->{track}->LoadFromId()
   }
   if (exists $data->{albumid} && $data->{albumid} ne '')
   {
       if (not exists $ts->{album})
       {
           $ts->{album} = Album->new($ts->{DBH});
           $ts->{album}->SetMBId($data->{albumid});
           $ts->{album}->LoadFromId()
       }
       $saved = $ts->{album};
       push @albums, $saved->GetId();
   }
   else
   {
       $ts->{album} = Album->new($ts->{DBH});
       @albums = $ts->{album}->GetAlbumIdsFromTrackId($ts->{track}->GetId());
   }

   foreach my $id (@albums)
   {
		my $al;
       if (defined $saved && $id == $saved->GetId())
       {
           $al = $saved;
       }
       else
       {
           $al = Album->new($ts->{DBH});
           $al->SetId($id);
           $al->LoadFromId();
       }

		$m->comp(
			"/comp/album",
			artist		=> $ts->{artist},
			album		=> $al,
			mbtagger	=> $data->{mbt},
			showids		=> 1,
			hilitetrack	=> $ts->{track}->GetId,
		);
   }
</%perl>
</%def>

<%def .OutputForm>
%	my ($data, $submit) = @_;
	<form method="post" action="/taglookup.html"
         enctype="application/x-www-form-urlencoded" class="formstyle">
     <input type="hidden" name="artist" value="<% $data->{artist} %>">
     <input type="hidden" name="artistid" value="<% $data->{artistid} %>">
     <input type="hidden" name="album" value="<% $data->{album} %>">
     <input type="hidden" name="albumid" value="<% $data->{albumid} %>">
     <input type="hidden" name="track" value="<% $data->{track} %>">
     <input type="hidden" name="trackid" value="<% $data->{trackid} %>">
     <input type="hidden" name="tracknum" value="<% $data->{tracknum} %>">
     <input type="hidden" name="filename" value="<% $data->{filename} %>">
     <input type="hidden" name="trmid" value="<% $data->{trmid} %>">
     <input type="hidden" name="duration" value="<% $data->{duration} %>">
     <input type="hidden" name="mbt" value="<% $data->{mbt} %>">
     <input type="submit" name="submit" value="<% $submit || 'Submit' %>">
	</form>
</%def>

<%def .OutputEditForm>
%	my ($data) = @_;
   <form method="post" action="/taglookup.html"
		id="TagLookupForm"
         enctype="application/x-www-form-urlencoded" class="formstyle">
     <table>
     <tr>
      <td align="right" NOWRAP>
        Artist:
      </td>
      <td>
        <INPUT TYPE="text" NAME="artist" SIZE="30" VALUE="<% $data->{artist} %>">
      </td>
     </tr>
     <tr>
      <td align="right" NOWRAP>
        Album:
      </td>
      <td>
        <INPUT TYPE="text" NAME="album" SIZE="30" VALUE="<% $data->{album} %>">
      </td>
     </tr>
     <tr>
      <td align="right" NOWRAP>
        Track:
      </td>
      <td>
        <INPUT TYPE="text" NAME="track" SIZE="30" VALUE="<% $data->{track} %>">
      </td>
     </tr>
     <tr>
      <td align="right" NOWRAP>
        Track Num:
      </td>
      <td>
        <INPUT TYPE="text" NAME="tracknum" SIZE="2" VALUE="<% $data->{tracknum} %>">
      </td>
     </tr>
     <tr>
      <td colspan="2" align="right" NOWRAP>
        <INPUT TYPE="submit" NAME="submit" SIZE="30" VALUE="Lookup">
        <INPUT TYPE="hidden" NAME="mbt" SIZE="2" VALUE="<% $data->{mbt} %>">
      </td>
     </tr>
   </table>
   </form>
   <& /comp/movefocus, "TagLookupForm", "artist" &>
</%def>

%###############################################################################
%# Start of main component code
%###############################################################################

<%perl>

if ($ARGS{"embedded_form"})
{
	</%perl>
	<& /comp/tablebegin, title => 'Advanced Search', gattrs=>'width="100%"' &>
	<div style="text-align: center; margin: 0.2em 0">
		[&nbsp;<a <& /comp/auto-popup-link,
			url => "/products/server/docs/20031226-1.html",
			&>>help</a>&nbsp;]
	</p>
	<& .OutputEditForm, +{} &>
    <& /comp/tableend &>
	<%perl>
	return;
}

my $bgcolor= '#ffffff';

my $mb = $m->comp("/comp/dblogin");
my $ts = TaggerSupport->new($mb->{DBH});

my %data;
$data{artist} = $artist;
$data{artistid} = $artistid;
$data{album} = $album;
$data{albumid} = $albumid;
$data{track} = $track;
$data{trackid} = $trackid;
$data{tracknum} = $tracknum;
$data{trmid} = $trmid;
$data{duration} = $duration;
$data{filename} = $filename;
$data{mbt} = $mbt;

# Save the original data for use in the lookup dialog later
my %orig_data = %data;

$m->comp("/comp/sidebar", title=>'Track Lookup', expand=>'moderate');

################################################################################
# If a TRM is specified, and if it resolves to multiple tracks, show the
# matching tracks, and also a "search anyway" form.
################################################################################

my @coll_list;
@coll_list = $ts->LookupTRMCollisions($trmid) if $trmid;

if (scalar(@coll_list) > 1)
{
    </%perl>
    TRM Id: <b><% $data{trmid} %></b><p> 
    <table width="420"><tr><td>
    More than one track has the same TRM Id shown above. The highlighted tracks
    shown in the albums below are the possible matches for the track
    you're matching. If none of the tracks below apply, click on 
    the lookup button at the bottom of this page:
    </td></tr></table>
    <p>
    <%perl>

	# Retrieve artist info, then sort on artist

    foreach my $ref (@coll_list)
    {
        my $al = Album->new($ts->{DBH});
        $al->SetId($ref->{album});
        if ($al->LoadFromId())
        {
            my $ar = Artist->new($ts->{DBH});
            $ar->SetId($al->GetArtist());
            if ($ar->LoadFromId())
            {
				use Encode qw( decode );
				$ref->{_name1_} = lc decode "utf-8", $ar->GetName;
				$ref->{_name2_} = lc decode "utf-8", $al->GetName;

				$ref->{al} = $al;
				$ref->{ar} = $ar;
			}
		}
	}

	@coll_list = grep { $_->{_name1_} } @coll_list;
	@coll_list = sort {
		$a->{_name1_} cmp $b->{_name1_}
		or
		$a->{_name2_} cmp $b->{_name2_}
	} @coll_list;

	# Now show albums with tracks highlighted, indicating the artist name
	# whenever it changes.

	my $last_artist = 0;

	for my $ref (@coll_list)
	{
		my $artist_id = $ref->{ar}->GetId;

		unless ($last_artist == $artist_id)
		{
			$m->comp("/comp/artisttitle", artist => $ref->{ar}, showmodlinks => 0);
			$last_artist = $artist_id;
		}

		$m->comp(
			"/comp/album",
			album		=> $ref->{al},
			artist		=> $ref->{ar},
			hilitetrack	=> $ref->{track},
			mbtagger	=> $mbt,
		);
	}

    my %data_copy = %data;
    $data_copy{trmid} = "";

    </%perl>
    <table width="420"><tr><td>
    If none of the albums above apply, click on lookup to ignore
    these albums and continue with your lookup:<p>
    <center>
    <& .OutputForm, \%data_copy, "Lookup" &>
    </center>
    </td></tr></table>
    <& /comp/footer &>
    <%perl>

    return undef;
}

################################################################################
# Default page: show a blank form
################################################################################

if ($artist eq '' && $artistid eq '' && $album eq '' && $albumid eq '' && 
    $track eq '' && $trackid eq '' && $filename eq '' && $filename eq '')
{
    </%perl>

    <table width="420"><tr><td>
    Fill out as much as you know about the track in the box below:<p>

    <& /comp/tablebegin, title=>'Tag Lookup' &>
    <& .OutputEditForm, \%orig_data &>
    <& /comp/tableend &>
    </td></tr></table>
    <& /comp/footer &>

    <%perl>
    return undef;
}

################################################################################
# No artist information, but album/track search specified.  Error!
################################################################################

if ($artist eq '' && $artistid eq '' && $filename eq '' && $filename eq '' &&
    ($album ne '' || $albumid ne '' || $track ne '' || $trackid ne ''))
{
    </%perl>

    <table width="420"><tr><td>
    <font color="red">Error:</font> You need to provide an artist name
    in order to lookup a track. Please enter the artist name below and
    try the lookup again: <p>

    <& /comp/tablebegin, title=>'Modify Lookup' &>
    <& .OutputEditForm, \%orig_data &>
    <& /comp/tableend &>
    </td></tr></table>
    <& /comp/footer &>

    <%perl>
    return undef;
}

################################################################################
# Perform the requested search using the TaggerSupport module
################################################################################

#use Data::Dumper;
#$m->out("<pre>");
#$m->out( Data::Dumper->Dump([ \%data ],[ '*data' ]) );
my ($error, $result, $flags, $list) = $ts->Lookup(\%data, 25);
#$m->out( Data::Dumper->Dump([ $error, $result, $flags, $list ],[ 'error', 'result', 'flags', 'list' ]) );
#$m->out("</pre><br>");

#$m->out "Debug: [ ";
#$m->out "ArtistId " if ($flags & TaggerSupport::ARTISTID);
#$m->out "ArtistList " if ($flags & TaggerSupport::ARTISTLIST);
#$m->out "AlbumId " if ($flags & TaggerSupport::ALBUMID);
#$m->out "AlbumList " if ($flags & TaggerSupport::ALBUMLIST);
#$m->out "TrackId " if ($flags & TaggerSupport::TRACKID);
#$m->out "AlbumTrackId " if ($flags & TaggerSupport::ALBUMTRACKID);
#$m->out "AlbumTrackList " if ($flags & TaggerSupport::ALBUMTRACKLIST);
#$m->out "Fuzzy " if ($flags & TaggerSupport::FUZZY);
#$m->out "]<br>";

# Copy over some results of the filename parse
$orig_data{artist} = $data{artist} if ($orig_data{artist} eq '');
$orig_data{album} = $data{album} if ($orig_data{album} eq '');
$orig_data{track} = $data{track} if ($orig_data{track} eq '');
$orig_data{tracknum} = $data{tracknum} if ($orig_data{tracknum} == 0);

################################################################################
# Display one of several mututally exclusive types of results:
################################################################################

# List of matching artists
if ($flags & TaggerSupport::ARTISTLIST)
{
   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
	   <p><b>Found matching artists</b>:</p>
       <& /comp/framedboxbegin, width=>"420" &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center"><b>Artist</b></td>
             <td align="center"><b>Relevance</b></td>
          </tr>
%      foreach my $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top">&nbsp;<a href="/showartist.html?artistid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int(($id->{sim} * 100) + .5) %>%</td>
             <td valign="top" align="right">
%               $copy{artistid} = $id->{mbid};
%               $copy{artist} = $id->{name};
				<& .OutputForm, \%copy, "" &>
             </td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>
      

       <%perl>
   }
   else
   {
       </%perl>
	   <p><b>Found no matching artists.</b></p>
       <%perl>
   }

   $m->comp("/comp/lookupoptions", artist=>$artist, artistobj=>$ts->{artist}, 
                                  album=>$album, albumobj=>$ts->{album}, data=>\%data);
}

# List of matching albums
elsif ($flags & TaggerSupport::ALBUMLIST)
{
	$m->comp(".OutputArtist", $ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
	   <p><b>Found matching albums</b>:</p>
       <& /comp/framedboxbegin &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center" NOWRAP><b>Album</b></td>
             <td align="center" NOWRAP>&nbsp;</td>
             <td align="center" colspan="3" NOWRAP><b>Album Info</b></td>
             <td align="center" NOWRAP><b>Relevance</b></td>
             <td align="center" NOWRAP>&nbsp;</td>
          </tr>
%      foreach my $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top" width="50%">
             <a href="/showalbum.html?albumid=<% $id->{id} %>" ><% $id->{name} %></a></td>
             <td width="10">&nbsp;</td>
             <td valign="top" NOWRAP>
             <% $id->{album_tracks} %>
             <img src="/images/notes.gif" align="middle" alt="Tracks" 
                  width="13" height="13"
                  title="This album has <% $id->{album_tracks} %> Tracks">
             </td>
             <td valign="top" NOWRAP>
             &nbsp;
             <% $id->{album_discids} %>
             <img src="/images/cd.png" align="middle" alt="CD" 
                  width="13" height="13"
                  title="This album has <% $id->{album_discids} %> CD Index Ids">
             </td>
             <td valign="top" NOWRAP>
             &nbsp;
             <% $id->{album_trmids} %>
             <img src="/images/trm.gif" align="middle" alt="TRM" 
                  width="30" height="11"
                  title="This album has <% $id->{album_trmids} %> TRM Ids">&nbsp;
             </td>
             <td valign="top" align="center"><% int(($id->{sim} * 100) + .5) %>%</td>
             <td valign="top" align="right">
%               $copy{albumid} = $id->{mbid};
%               $copy{album} = $id->{name};
				<& .OutputForm, \%copy, "" &>
             </td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>

       <%perl>
   }
   else
   {
       </%perl>
	   <p><b>Found no matching albums.</b></p>
       <%perl>
   }

   $m->comp("/comp/lookupoptions", artist=>$artist, artistobj=>$ts->{artist}, 
                                  album=>$album, albumobj=>$ts->{album}, data=>\%data);
}

# List of matching tracks
elsif ($flags & TaggerSupport::ALBUMTRACKLIST)
{
	$m->comp(".OutputArtist", $ts, $result);

	for (@$list)
	{
		my @attrs = ($_->{album_attrs} =~ /(\d+)/g);

		(my $type) = grep {
			$_ >= Album::ALBUM_ATTR_SECTION_TYPE_START
			and
			$_ <= Album::ALBUM_ATTR_SECTION_TYPE_END
		} @attrs;

		(my $status) = grep {
			$_ >= Album::ALBUM_ATTR_SECTION_STATUS_START
			and
			$_ <= Album::ALBUM_ATTR_SECTION_STATUS_END
		} @attrs;
		
		my $is_va = ($_->{album_artist} == &ModDefs::VARTIST_ID);
		
		my $va = $is_va ? "Various Artist" : "";
		my $name = Album->GetAttributeName($type);
		my $statname = Album->GetAttributeName($status);

		my $desc = join " ", grep {$_}
			$statname,
			$va,
			$name;

		$_->{attr_desc} = $desc || "Uncategorized Release";
	}

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
	   <p><b>Found matching albums/tracks</b>:</p>
       <& /comp/framedboxbegin &>
       <table cellspacing="0" width="100%" id="TagLookupTrackResults">
          <tr>
             <td align="center" NOWRAP><b>Album</b></td>
             <td align="center" colspan="3" NOWRAP><b>Album Info</b></td>
% if ($mbt) {
             <td align="center" NOWRAP><b>Tag</b></td>
% }
             <td align="center" NOWRAP><b>Track</b></td>
             <td align="center" NOWRAP><b>Length</b></td>
             <td align="center" NOWRAP><b>Relevance</b></td>
             <td align="center" NOWRAP>&nbsp;</td>
          </tr>
%      foreach my $id (@$list) {
<%perl>
my $tracklenclass = "";
if ($duration and $id->{tracklen})
{
	my $diff = abs($duration - $id->{tracklen});
	$tracklenclass = (
		($diff < 5000) ? "good"
		: ($diff < 15000) ? "ok"
		: "bad"
	);
}
</%perl>
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top" width="40%" rowspan="2"
                 style="padding-right: 1em"
                  >&nbsp;<a href="/showalbum.html?albumid=<% $id->{albumid} %>"><% $id->{album} %></a></td>
             <td valign="top" align="right" style="padding-right: 4px" NOWRAP>
             <% $id->{album_tracks} %>
             <img src="/images/notes.gif" align="middle" alt="Tracks" 
                  width="13" height="13"
                  title="This album has <% $id->{album_tracks} %> Tracks">
             </td>
             <td valign="top" align="right" style="padding-right: 4px" NOWRAP>
             &nbsp;
             <% $id->{album_discids} %>
             <img src="/images/cd.png" align="middle" alt="CD" 
                  width="13" height="13"
                  title="This album has <% $id->{album_discids} %> CD Index Ids">
             </td>
             <td valign="top" align="right" style="padding-right: 1em" NOWRAP>
             &nbsp;
             <% $id->{album_trmids} %>
             <img src="/images/trm.gif" align="middle" alt="TRM" 
                  width="30" height="11"
                  title="This album has <% $id->{album_trmids} %> TRM Ids">&nbsp;
             </td>
% if ($mbt) {
			 <td valign="top" align="center" rowspan="2" style="padding: 4px 0.5em 4px 0">
				 <a href="tag:<% $id->{mbid} %>:<% $id->{albummbid} %>"><img src="/images/mblookup-tag.gif" 
					alt="Tag" title="Tag the current track" height="13" width="28"
					align="middle" border="0"></a>
			 </td>
% }
             <td valign="top" width="40%" rowspan="2"><a href="/showtrack.html?trackid=<% $id->{id} %>"><% $id->{name} %></a></td>
             <td valign="top" align="center" rowspan="2" class="tlen <% $tracklenclass %>"><% Track::FormatTrackLength($id->{tracklen}) %></td>
             <td valign="top" align="center" rowspan="2"><% int(($id->{sim}*100) + .5) %>%</td>
             <td valign="top" align="right" rowspan="2">
%               $copy{trackid} = $id->{mbid};
%               $copy{albumid} = $id->{albummbid};
%               $copy{track} = $id->{name};
				<& .OutputForm, \%copy, "" &>
             </td>
          </tr>
          <tr bgcolor="<% $bgcolor %>">
              <td colspan="3" style="color: #666"><% $id->{attr_desc} %></td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>
      
       <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, 
                               album=>$album, albumobj=>$ts->{album}, data=>\%data &>
   
       <%perl>

   }
   else
   {
       </%perl>
	   <p><b>Found no matching albums or tracks.</b></p>
       <%perl>
   }
}

# Exactly one matching track
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::TRACKID))
{
   </%perl>
   <p><b>Found matching track:</b></p>
   <& .OutputArtist, $ts, $result &>
   <& .OutputTrack, $ts, $result &>
   <%perl>
}

# Exactly one matching track (err, not used - caught by the case above)
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID) && 
       ($flags & TaggerSupport::TRACKID))
{
   </%perl>
   <p><b>Found matching track:</b></p>
   <& .OutputArtist, $ts, $result &>
   <& .OutputTrack, $ts, $result &>
   <%perl>
}

# Exactly one matching track (huh? again?)
elsif ($flags & TaggerSupport::TRACKID)
{
   </%perl>
   <p><b>Found matching track:</b></p>
   <& .OutputArtist, $ts, $result &>
   <& .OutputTrack, $ts, $result &>
   <%perl>
}

# Exactly one matching album
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID))
{
   </%perl>
   <p><b>Found matching album:</b></p>
   <& .OutputArtist, $ts, $result &>
   <& .OutputAlbum, $ts, $result &>
   <%perl>
}

# Exactly one matching artist
elsif ($flags & TaggerSupport::ARTISTID)
{
   </%perl>
   <p><b>Found matching artist:</b></p>
   <& .OutputArtist, $ts, $result &>
   <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, 
                           album=>$album, albumobj=>$ts->{album}, data=>\%data &>
   <%perl>
}

# None of the above.
else
{
   </%perl>
   <p><b>No matching artists found.</b></p>
   <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, 
                           album=>$album, albumobj=>$ts->{album}, data=>\%orig_data &>
   <%perl>
}

</%perl>

<center>
<& /comp/tablebegin, title=>'Modify Lookup' &>
<& .OutputEditForm, \%orig_data &>
<& /comp/tableend &>
</center>

<& /comp/footer &>

<%args>

	$artist => ""
	$release => ""
	$album => ""
	$track => ""

	$tracknum => ""
	$filename => ""
	$duration => ""

	$puid => ""

	$tport => $session{'tport'}
	$mbt => $session{'mbt'}

</%args>
<%perl>

	UserStuff::EnsureSessionOpen(), $session{tport} = $tport
	   if $tport;
	UserStuff::EnsureSessionOpen(), $session{mbt} = $mbt
	   if $mbt;

	$release = $album if $album;

	MusicBrainz::Server::Validation::TrimInPlace(
		$artist,
		$release,
		$track,
		$tracknum,
		$duration,
	);

	$m->comp("/comp/sidebar-notitle", pagetitle => "Lookup Results");
	$m->comp("/comp/nagpanel");

	require TaggerSupport;
	my $mb = $m->comp("/comp/dblogin");
	my $ts = TaggerSupport->new($mb->{DBH});
	if ($filename)
	{
		my %data = (artist => "", album => "", track => "", tracknum => 0);
		$ts->ParseFileName($filename, \%data);
		$artist = $data{artist} if (exists $data{artist} && !$artist);
		$release = $data{album} if (exists $data{album} && !$release);
		$track = $data{track} if (exists $data{track} && !$track);
		$tracknum = $data{tracknum} if (exists $data{tracknum} && !$tracknum);
	}

	my $_duration = 0;
	if ($duration =~ /(\d+):(\d+)/)
	{
		$_duration = (($1 * 60) + $2) * 1000;
	}
	elsif ($duration =~ /(\d+)/)
	{
		$_duration = $1;
	}

	# Do the same for PUIDs
	my @pcoll_list;
	@pcoll_list = $ts->LookupPUIDCollisions($puid) if $puid;

	if (scalar(@pcoll_list) > 1)
	{

</%perl>

    PUID: <b><% $puid %></b>

    <p>
		<table width="420">$
			<tr>
				<td>
					More than one track has the same PUID shown above. The highlighted tracks
					shown in the releases below are the possible matches for the track
					you're matching. If none of the tracks below apply, click on
					the lookup button at the bottom of this page:
				</td>
			</tr>
		</table>
    </p>

<%perl>

		# Retrieve artist info, then sort on artist
		foreach my $ref (@pcoll_list)
		{
			my $al = MusicBrainz::Server::Release->new($ts->{DBH});
			$al->SetId($ref->{album});
			if ($al->LoadFromId())
			{
				my $ar = MusicBrainz::Server::Artist->new($ts->{DBH});
				$ar->SetId($al->GetArtist());
				if ($ar->LoadFromId())
				{
					use Encode qw( decode );
					$ref->{_name1_} = lc decode "utf-8", $ar->GetName;
					$ref->{_name2_} = lc decode "utf-8", $al->GetName;

					$ref->{al} = $al;
					$ref->{ar} = $ar;
				}
			}
		}

		@pcoll_list = grep { $_->{_name1_} } @pcoll_list;
		@pcoll_list = sort {
			$a->{_name1_} cmp $b->{_name1_}
			or
			$a->{_name2_} cmp $b->{_name2_}
		} @pcoll_list;

		# Now show releases with tracks highlighted, indicating the artist name
		# whenever it changes.
		my $last_artist = 0;
		for my $ref (@pcoll_list)
		{
			my $artist_id = $ref->{ar}->GetId;

			unless ($last_artist == $artist_id)
			{
				$m->comp("/comp/artisttitle", artist => $ref->{ar}, showmodlinks => 0);
				$last_artist = $artist_id;
			}

			$m->comp("/comp/album",
				album => $ref->{al},
				artist => $ref->{ar},
				highlighttracks => { $ref->{track} => 1 },
				mbtagger => $mbt,
			);
		}

</%perl>

    <p>
		If none of the releases above apply, click on lookup to ignore
		these releases and continue with your lookup:
	</p>

<%perl>

	}
	elsif ($artist)
	{
		use MusicBrainz::Server::LuceneSearch qw( TagLookupQuery );
		my ($query, $type) = TagLookupQuery($artist, $release, $track, $tracknum, $_duration);

# print "Sorry, the search server is down.";
# return;
		use URI::Escape qw( uri_escape );
		my $docurl = 'http://' . &DBDefs::LUCENE_SERVER . "/ws/1/$type/?query=" .
					 uri_escape($query) . "&type=$type";
		$docurl .= "&tport=$tport" if $tport;
		$docurl .= "&dur=$_duration" if $_duration;
		$docurl .= "&mbt=1" if $mbt;

		require LWP::UserAgent;
		my $ua = LWP::UserAgent->new;
        $ua->env_proxy;
		$ua->timeout(2);
		my $response = $ua->get($docurl);
		if (!$response->is_success)
		{
			if ($response->code == 404)
			{
				</%perl>
				<p>0 matches.<br/><br/>
				Your lookup did not match any tracks. Please make sure that the lookup information
				is correct and that any unrelated information has been removed from the lookup
				data. Adjust the data in the lookup box below and try again.
				</p>
				<%perl>
			}
			elsif ($response->code == 403)
			{
				</%perl>
				<p><b>Error</b>: Your lookup query did not contain enough information to carry out a lookup.
				Please make sure that the lookup information
				is correct and that any unrelated information has been removed from the lookup
				data. Adjust the data in the lookup box below and try again.
				</p>
				<%perl>
			}
			elsif ($response->code == 500)
			{
				</%perl>
				<p><b>Error</b>: The search server could not fulfill your request due to an internal error.
				</p>
				<%perl>
			}
			else
			{
				$m->comp('/comp/error',
					 "Error: Could not execute search on search server. " .
					 "(URL $docurl received " . $response->status_line ." )", 0, 0);
			}
		}
		else
		{
			$m->comp("/comp/tablebegin", title => 'Lookup results');
			$m->print($response->content);
			$m->comp("/comp/tableend");
		}
	}
	else
	{
		</%perl>
		<p><b>Error</b>: You must provide an artist.
		</p>
		<%perl>
	}

</%perl>

	<& /comp/lookup,
		artist => $artist,
		release => $release,
		track => $track,
		tracknum => $tracknum,
		duration => $_duration
	&>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

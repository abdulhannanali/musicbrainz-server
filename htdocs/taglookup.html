%# vi: set ts=4 sw=4 ft=mason :
<& /comp/sidebar, title=>'Track Lookup', expand=>'moderate' &>

<%args>
$artist=>""
$artistid=>""
$album=>""
$albumid=>""
$track=>""
$trackid=>""
$tracknum=>""
$filename=>""
$trmid=>""
$duration=>0
$mbt=>0
</%args>

<%perl>
#% if (!defined $session{user} || $session{user} eq '') {
#    You must be logged in to edit the database.<p>
#    <& /comp/tablebegin, title=>'Login' &>
#    <& /comp/loginbox &>
#    <& /comp/tableend &>
#    <& /comp/footer &>
#%   return undef;
#% }

use Data::Dumper;
use URI::Escape;

sub OutputArtist
{
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   $m->out("<a href=\"/showartist.html?artistid=" . $ts->{artist}->GetId());
   $m->out("\"><font size=\"+2\">" . $ts->{artist}->GetName . "</font></a><p>");
}

sub OutputAlbum
{
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   if (not exists $ts->{album})
   {
       $ts->{album} = Album->new($ts->{DBH});
       $ts->{album}->SetMBId($data->{albumid});
       $ts->{album}->LoadFromId()
   }
   $m->comp("/comp/album", artist=>$ts->{artist}, album=>$ts->{album},
           showalbumdetail=>1, mbtagger=>$data->{mbt}, showids=>1);
}

sub OutputTrack
{
   my ($ts, $data) = @_;
   my ($tr, @albums, $al, $id, $saved);

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   if (not exists $ts->{track})
   {
       $ts->{track} = Track->new($ts->{DBH});
       $ts->{track}->SetMBId($data->{trackid});
       $ts->{track}->LoadFromId()
   }
   if (exists $data->{albumid} && $data->{albumid} ne '')
   {
       if (not exists $ts->{album})
       {
           $ts->{album} = Album->new($ts->{DBH});
           $ts->{album}->SetMBId($data->{albumid});
           $ts->{album}->LoadFromId()
       }
       $saved = $ts->{album};
       push @albums, $saved->GetId();
   }
   else
   {
       $ts->{album} = Album->new($ts->{DBH});
       @albums = $ts->{album}->GetAlbumIdsFromTrackId($ts->{track}->GetId());
   }

   foreach $id (@albums)
   {
       if (defined $saved && $id == $saved->GetId())
       {
           $al = $saved;
       }
       else
       {
           $al = Album->new($ts->{DBH});
           $al->SetId($id);
           $al->LoadFromId();
       }
       $m->comp("/comp/album", artist=>$ts->{artist}, album=>$al,
               showalbumdetail=>1, mbtagger=>$data->{mbt}, showids=>1, 
               hilitetrack=>$ts->{track}->GetId());
   }
}

sub OutputForm
{
   my ($data, $submit) = @_;

   $submit = "Select" unless defined $submit;

   my $ret = qq|<FORM METHOD="POST" ACTION="/taglookup.html"
         ENCTYPE="application/x-www-form-urlencoded" class="formstyle">
     <INPUT TYPE="hidden" NAME="artist" VALUE="$data->{artist}">
     <INPUT TYPE="hidden" NAME="artistid" VALUE="$data->{artistid}">
     <INPUT TYPE="hidden" NAME="album" VALUE="$data->{album}">
     <INPUT TYPE="hidden" NAME="albumid" VALUE="$data->{albumid}">
     <INPUT TYPE="hidden" NAME="track" VALUE="$data->{track}">
     <INPUT TYPE="hidden" NAME="trackid" VALUE="$data->{trackid}">
     <INPUT TYPE="hidden" NAME="tracknum" VALUE="$data->{tracknum}">
     <INPUT TYPE="hidden" NAME="filename" VALUE="$data->{filename}">
     <INPUT TYPE="hidden" NAME="trmid" VALUE="$data->{trmid}">
     <INPUT TYPE="hidden" NAME="duration" VALUE="$data->{duration}">
     <INPUT TYPE="hidden" NAME="mbt" VALUE="$data->{mbt}">
     <INPUT TYPE="submit" NAME="submit" VALUE="$submit">
   </form>|;

   return $ret;
}

sub OutputEditForm
{
   my ($data) = @_;

   # TODO html-encoding ($m->out the content, don't return it)
   my $ret = qq|<FORM METHOD="POST" ACTION="/taglookup.html"
         ENCTYPE="application/x-www-form-urlencoded" class="formstyle">
     <table>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Artist:
      </td>
      <td>
        <INPUT TYPE="text" NAME="artist" SIZE="30" VALUE="$data->{artist}">
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Album:
      </td>
      <td>
        <INPUT TYPE="text" NAME="album" SIZE="30" VALUE="$data->{album}">
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Track:
      </td>
      <td>
        <INPUT TYPE="text" NAME="track" SIZE="30" VALUE="$data->{track}">
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Track Num:
      </td>
      <td>
        <INPUT TYPE="text" NAME="tracknum" SIZE="2" VALUE="$data->{tracknum}">
      </td>
     </tr>
     <tr>
      <td colspan="2" align="right" valign="top" NOWRAP>
        <INPUT TYPE="submit" NAME="submit" SIZE="30" VALUE="Lookup">
        <INPUT TYPE="hidden" NAME="mbt" SIZE="2" VALUE="$data->{mbt}">
      </td>
     </tr>
   </table>
   </form>|;
   return $ret;
}

sub format_tracklen
{
	my $ms = shift()
		or return "?:??";
	return "$ms ms" if $ms < 1000;
	my $s = $ms / 1000;
	sprintf "%d:%02d", int($s / 60), ($s % 60);
}

my ($mb, $ts, $result, $flags, $list, $error, $id, %data, %orig_data); 
my $bgcolor= '#ffffff';

$mb = $m->comp("/comp/dblogin");
$ts = TaggerSupport->new($mb->{DBH});

$data{artist} = $artist;
$data{artistid} = $artistid;
$data{album} = $album;
$data{albumid} = $albumid;
$data{track} = $track;
$data{trackid} = $trackid;
$data{tracknum} = $tracknum;
$data{trmid} = $trmid;
$data{duration} = $duration;
$data{filename} = $filename;
$data{mbt} = $mbt;

# Save the original data for use in the lookup dialog later
%orig_data = %data;

my (@coll_list) = $ts->LookupTRMCollisions($trmid); 
if (scalar(@coll_list) > 1)
{
    my ($ar, $al, $ref, %data_copy);

    </%perl>
    TRM Id: <b><% $data{trmid} %></b><p> 
    <table width="420"><tr><td>
    More than one track has the same TRM Id shown above. The highlighted tracks
    shown in the albums below are the possible matches for the track
    you're matching. If none of the tracks below apply, click on 
    the lookup button at the bottom of this page:
    </td></tr></table>
    <p>
    <%perl>

	# Retrieve artist info, then sort on artist

    foreach $ref (@coll_list)
    {
        $al = Album->new($ts->{DBH});
        $al->SetId($ref->{album});
        if ($al->LoadFromId())
        {
            $ar = Artist->new($ts->{DBH});
            $ar->SetId($al->GetArtist());
            if ($ar->LoadFromId())
            {
				use Encode qw( decode );
				$ref->{_name1_} = lc decode "utf-8", $ar->GetName;
				$ref->{_name2_} = lc decode "utf-8", $al->GetName;

				$ref->{al} = $al;
				$ref->{ar} = $ar;
			}
		}
	}

	@coll_list = grep { $_->{_name1_} } @coll_list;
	@coll_list = sort {
		$a->{_name1_} cmp $b->{_name1_}
		or
		$a->{_name2_} cmp $b->{_name2_}
	} @coll_list;

	# Now show albums with tracks highlighted, indicating the artist name
	# whenever it changes.

	my $last_artist = 0;

	for $ref (@coll_list)
	{
		my $artist_id = $ref->{ar}->GetId;

		unless ($last_artist == $artist_id)
		{
			$m->comp("/comp/artisttitle", artist => $ref->{ar}, nomod => 1);
			$last_artist = $artist_id;
		}

		$m->comp(
			"/comp/album",
			album => $ref->{al},
			artist => $ref->{ar},
			hilitetrack => $ref->{track},
			mbtagger => $mbt,
		);
	}

    %data_copy = %data;
    $data_copy{trmid} = "";

    </%perl>
    <table width="420"><tr><td>
    If none of the albums above apply, click on lookup to ignore
    these albums and continue with your lookup:<p>
    <center>
    <% OutputForm(\%data_copy, "Lookup") |n %>
    </center>
    </td></tr></table>
    <& /comp/footer &>
    <%perl>

    $mb->Logout();
    return undef;
}

if ($artist eq '' && $artistid eq '' && $album eq '' && $albumid eq '' && 
    $track eq '' && $trackid eq '' && $filename eq '' && $filename eq '')
{
    </%perl>

    <table width="420"><tr><td>
    Fill out as much as you know about the track in the box below:<p>

    <& /comp/tablebegin, title=>'Tag Lookup', bgcolor=>"#f0efff" &>
    <% OutputEditForm(\%orig_data) |n %>
    <& /comp/tableend &>
    </td></tr></table>
    <& /comp/footer &>
    <%perl>
    $mb->Logout();
    return undef;
}

if ($artist eq '' && $artistid eq '' && $filename eq '' && $filename eq '' &&
    ($album ne '' || $albumid ne '' || $track ne '' || $trackid ne ''))
{
    </%perl>

    <table width="420"><tr><td>
    <font color="red">Error:</font> You need to provide an artist name
    in order to lookup a track. Please enter the artist name below and
    try the lookup again: <p>

    <& /comp/tablebegin, title=>'Modify Lookup', bgcolor=>"#f0efff" &>
    <% OutputEditForm(\%orig_data) |n %>
    <& /comp/tableend &>
    </td></tr></table>
    <& /comp/footer &>
    <%perl>
    $mb->Logout();
    return undef;
}

($error, $result, $flags, $list) = $ts->Lookup(\%data, 25);
#$m->out "Debug: [ ";
#$m->out "ArtistId " if ($flags & TaggerSupport::ARTISTID);
#$m->out "ArtistList " if ($flags & TaggerSupport::ARTISTLIST);
#$m->out "AlbumId " if ($flags & TaggerSupport::ALBUMID);
#$m->out "AlbumList " if ($flags & TaggerSupport::ALBUMLIST);
#$m->out "TrackId " if ($flags & TaggerSupport::TRACKID);
#$m->out "AlbumTrackId " if ($flags & TaggerSupport::ALBUMTRACKID);
#$m->out "AlbumTrackList " if ($flags & TaggerSupport::ALBUMTRACKLIST);
#$m->out "Fuzzy " if ($flags & TaggerSupport::FUZZY);
#$m->out "]<br>";

# Copy over some results of the filename parse
$orig_data{artist} = $data{artist} if ($orig_data{artist} eq '');
$orig_data{album} = $data{album} if ($orig_data{album} eq '');
$orig_data{track} = $data{track} if ($orig_data{track} eq '');
$orig_data{tracknum} = $data{tracknum} if ($orig_data{tracknum} == 0);

if ($flags & TaggerSupport::ARTISTLIST)
{
   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching artists</b>:<p>
       <& /comp/framedboxbegin, width=>"420" &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center"><b>Artist</b></td>
             <td align="center"><b>Relevance</b></td>
          </tr>
%      foreach $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top">&nbsp;<a href="/showartist.html?artistid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top" align="right">
%               $copy{artistid} = $id->{mbid};
%               $copy{artist} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>
      

       <%perl>
   }
   else
   {
       </%perl>
       <br>
       <b>Found no matching artists.</b><p>
       <%perl>
   }

   $m->comp("/comp/lookupoptions", artist=>$artist, artistobj=>$ts->{artist}, 
                                  album=>$album, albumobj=>$ts->{album}, data=>\%data);
}
elsif ($flags & TaggerSupport::ALBUMLIST)
{
   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching albums</b>:<p>
       <& /comp/framedboxbegin &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center" NOWRAP><b>Album</b></td>
             <td align="center" NOWRAP>&nbsp;</td>
             <td align="center" colspan="3" NOWRAP><b>Album Info</b></td>
             <td align="center" NOWRAP><b>Relevance</b></td>
             <td align="center" NOWRAP>&nbsp;</td>
          </tr>
%      foreach $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top" width="50%">
             <a href="/showalbum.html?albumid=<% $id->{id} %>" ><% $id->{name} %></a></td>
             <td width="10">&nbsp;</td>
             <td valign="top" NOWRAP>
             <% $id->{album_tracks} %>
             <img src="/images/notes.gif" align="middle" alt="Tracks" 
                  width="13" height="13"
                  title="This album has <% $id->{album_tracks} %> Tracks">
             </td>
             <td valign="top" NOWRAP>
             &nbsp;
             <% $id->{album_discids} %>
             <img src="/images/cd.png" align="middle" alt="CD" 
                  width="13" height="13"
                  title="This album has <% $id->{album_discids} %> CD Index Ids">
             </td>
             <td valign="top" NOWRAP>
             &nbsp;
             <% $id->{album_trmids} %>
             <img src="/images/trm.gif" align="middle" alt="TRM" 
                  width="30" height="11"
                  title="This album has <% $id->{album_trmids} %> TRM Ids">&nbsp;
             </td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top" align="right">
%               $copy{albumid} = $id->{mbid};
%               $copy{album} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>

       <%perl>
   }
   else
   {
       </%perl>
       <br>
       <b>Found no matching albums.</b><p>
       <%perl>
   }

   $m->comp("/comp/lookupoptions", artist=>$artist, artistobj=>$ts->{artist}, 
                                  album=>$album, albumobj=>$ts->{album}, data=>\%data);
}
elsif ($flags & TaggerSupport::ALBUMTRACKLIST)
{

   OutputArtist($ts, $result);

	for (@$list)
	{
		my @attrs = ($_->{album_attrs} =~ /(\d+)/g);

		(my $type) = grep {
			$_ >= Album::ALBUM_ATTR_SECTION_TYPE_START
			and
			$_ <= Album::ALBUM_ATTR_SECTION_TYPE_END
		} @attrs;

		(my $status) = grep {
			$_ >= Album::ALBUM_ATTR_SECTION_STATUS_START
			and
			$_ <= Album::ALBUM_ATTR_SECTION_STATUS_END
		} @attrs;
		
		my $is_va = ($_->{album_artist} == ModDefs::VARTIST_ID);
		
		my $va = $is_va ? "Various Artist" : "";
		my $name = Album->GetAttributeName($type);
		my $statname = Album->GetAttributeName($status);

		my $desc = join " ", grep {$_}
			$statname,
			$va,
			$name;

		$_->{attr_desc} = $desc || "Uncategorized Release";
	}

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching albums/tracks</b>:<p>
       <& /comp/framedboxbegin &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center" NOWRAP><b>Album</b></td>
             <td align="center" colspan="3" NOWRAP><b>Album Info</b></td>
             <td align="center" NOWRAP><b>Track</b></td>
             <td align="center" NOWRAP><b>Length</b></td>
             <td align="center" NOWRAP><b>Relevance</b></td>
             <td align="center" NOWRAP>&nbsp;</td>
          </tr>
%      foreach $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top" width="40%" rowspan="2"
                 style="padding-right: 1em"
                  >&nbsp;<a href="/showalbum.html?albumid=<% $id->{albumid} %>"><% $id->{album} %></a></td>
             <td valign="top" align="right" style="padding-right: 4px" NOWRAP>
             <% $id->{album_tracks} %>
             <img src="/images/notes.gif" align="middle" alt="Tracks" 
                  width="13" height="13"
                  title="This album has <% $id->{album_tracks} %> Tracks">
             </td>
             <td valign="top" align="right" style="padding-right: 4px" NOWRAP>
             &nbsp;
             <% $id->{album_discids} %>
             <img src="/images/cd.png" align="middle" alt="CD" 
                  width="13" height="13"
                  title="This album has <% $id->{album_discids} %> CD Index Ids">
             </td>
             <td valign="top" align="right" style="padding-right: 1em" NOWRAP>
             &nbsp;
             <% $id->{album_trmids} %>
             <img src="/images/trm.gif" align="middle" alt="TRM" 
                  width="30" height="11"
                  title="This album has <% $id->{album_trmids} %> TRM Ids">&nbsp;
             </td>
             <td valign="top" width="40%" rowspan="2"><a href="/showtrack.html?trackid=<% $id->{id} %>"><% $id->{name} %></a></td>
             <td valign="top" align="center" rowspan="2"><% format_tracklen($id->{tracklen}) %></td>
             <td valign="top" align="center" rowspan="2"><% int($id->{sim} * 100) %>%</td>
             <td valign="top" align="right" rowspan="2">
%               $copy{trackid} = $id->{mbid};
%               $copy{albumid} = $id->{albummbid};
%               $copy{track} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
          <tr bgcolor="<% $bgcolor %>">
              <td colspan="3" style="color: #666"><% $id->{attr_desc} %></td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>
      
       <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, 
                               album=>$album, albumobj=>$ts->{album}, data=>\%data &>
   
       <%perl>

   }
   else
   {
       </%perl>
       <br>
       <b>Found no matching albums or tracks.</b><p>
       <%perl>
   }
}
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::TRACKID))
{
   </%perl>
   <b>Found matching track:</b><p>
   <%perl>
   OutputArtist($ts, $result);
   OutputTrack($ts, $result);
}
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID) && 
       ($flags & TaggerSupport::TRACKID))
{
   </%perl>
   <b>Found matching track:</b><p>
   <%perl>
   OutputArtist($ts, $result);
   OutputTrack($ts, $result);
}
elsif ($flags & TaggerSupport::TRACKID)
{
   </%perl>
   <b>Found matching track:</b><p>
   <%perl>
   OutputArtist($ts, $result);
   OutputTrack($ts, $result);
}
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID))
{
   </%perl>
   <b>Found matching album:</b><p>
   <%perl>
   OutputArtist($ts, $result);
   OutputAlbum($ts, $result);
}
elsif ($flags & TaggerSupport::ARTISTID)
{
   </%perl>
   <b>Found matching artist:</b><p>
%  OutputArtist($ts, $result);
   <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, 
                           album=>$album, albumobj=>$ts->{album}, data=>\%data &>
   <%perl>
}
else
{
   </%perl>
   <b>No matching artists found.</b><p>
   <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, 
                           album=>$album, albumobj=>$ts->{album}, data=>\%data &>
   <%perl>
}

</%perl>

<br>
<p>
<center>
<& /comp/tablebegin, title=>'Modify Lookup', bgcolor=>"#f0efff" &>
<% OutputEditForm(\%orig_data) |n %>
<& /comp/tableend &>
</center>

% $mb->Logout();
<& /comp/footer &>

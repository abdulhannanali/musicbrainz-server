<& /comp/sidebar, title=>'Track Lookup', expand=>'moderate' &>

<%args>
$artist=>""
$artistid=>""
$album=>""
$albumid=>""
$track=>""
$trackid=>""
$tracknum=>""
$filename=>""
$trmid=>""
$duration=>0
</%args>

% if (!defined $session{user} || $session{user} eq '') {
    You must be logged in to edit the database.<p>
    <& /comp/tablebegin, title=>'Login' &>
    <& /comp/loginbox &>
    <& /comp/tableend &>
    <& /comp/footer &>
%   return undef;
% }


<%perl>

use Data::Dumper;

# TODO: Add nicer error handleing
sub OutputArtist
{
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   mc_comp("/comp/artisttitle", artist=>$ts->{artist}, nomod=>1);
}

sub OutputAlbum
{
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   if (not exists $ts->{album})
   {
       $ts->{album} = Album->new($ts->{DBH});
       $ts->{album}->SetMBId($data->{albumid});
       $ts->{album}->LoadFromId()
   }
   mc_comp("/comp/album", artist=>$ts->{artist}, album=>$ts->{album},
           showalbumdetail=>1, mbtagger=>0, showids=>1);
}

sub OutputTrack
{
   my ($ts, $data) = @_;
   my ($tr);

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   if (not exists $ts->{album})
   {
       $ts->{album} = Album->new($ts->{DBH});
       $ts->{album}->SetMBId($data->{albumid});
       $ts->{album}->LoadFromId()
   }
   if (not exists $ts->{track})
   {
       $ts->{track} = Track->new($ts->{DBH});
       $ts->{track}->SetMBId($data->{trackid});
       $ts->{track}->LoadFromId()
   }

   mc_comp("/comp/album", artist=>$ts->{artist}, album=>$ts->{album},
           showalbumdetail=>1, mbtagger=>0, showids=>1, hilitetrack=>$ts->{track}->GetId());
}

sub OutputForm
{
   my ($data) = @_;

   my $ret = qq|<FORM METHOD="POST" ACTION="/taglookup.html"
         ENCTYPE="application/x-www-form-urlencoded" class="formstyle">
     <INPUT TYPE="hidden" NAME="artist" VALUE="$data->{artist}">
     <INPUT TYPE="hidden" NAME="artistid" VALUE="$data->{artistid}">
     <INPUT TYPE="hidden" NAME="album" VALUE="$data->{album}">
     <INPUT TYPE="hidden" NAME="albumid" VALUE="$data->{albumid}">
     <INPUT TYPE="hidden" NAME="track" VALUE="$data->{track}">
     <INPUT TYPE="hidden" NAME="trackid" VALUE="$data->{trackid}">
     <INPUT TYPE="hidden" NAME="tracknum" VALUE="$data->{tracknum}">
     <INPUT TYPE="hidden" NAME="filename" VALUE="$data->{filename}">
     <INPUT TYPE="hidden" NAME="trmid" VALUE="$data->{trmid}">
     <INPUT TYPE="hidden" NAME="duration" VALUE="$data->{duration}">
     <INPUT TYPE="submit" NAME="submit" VALUE="Continue &gt;&gt;">
   </form>|;

   return $ret;
}

my ($mb, $ts, $result, $flags, $list, $error, $id, %data); 

$mb = mc_comp("/comp/dblogin");
$ts = TaggerSupport->new($mb->{DBH});

$data{artist} = $artist;
$data{artistid} = $artistid;
$data{album} = $album;
$data{albumid} = $albumid;
$data{track} = $track;
$data{trackid} = $trackid;
$data{tracknum} = $tracknum;
$data{tmid} = $trmid;
$data{duration} = $duration;
$data{filename} = $filename;

($error, $result, $flags, $list) = $ts->Lookup(\%data, 25);
if ($error ne '')
{
   </%perl>
   <b>Error:</b> <% $error %>
   <%perl>

   $mb->Logout();
   return undef;
}

if ($flags & TaggerSupport::ARTISTLIST)
{
   OutputArtist($ts, $result);

   if (scalar($list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching artists</b>:<p>
       <table>
          <tr>
             <th>Artist</th>
             <th>Relevance</th>
          </tr>
%      foreach $id (@$list) {
          <tr>
             <td valign="top"><a href="/showartist.html?artistid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top">
%               $copy{artistid} = $id->{mbid};
%               $copy{artist} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>

       <%perl>
   }
   else
   {
       </%perl>
       <b>Error:</b> Nothing is known about artist <b><% $artist %></b>. 
       <%perl>
   }
}
elsif ($flags & TaggerSupport::ALBUMLIST)
{
   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching albums</b>:<p>
       <table>
          <tr>
             <th>Album</th>
             <th>Relevance</th>
          </tr>
%      foreach $id (@$list) {
          <tr>
             <td valign="top"><a href="/showalbum.html?albumid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top">
%               $copy{albumid} = $id->{mbid};
%               $copy{album} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>

       <%perl>
   }

}
elsif ($flags & TaggerSupport::TRACKLIST)
{
   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching tracks</b>:<p>
       <table>
          <tr>
             <th>Track</th>
             <th>Relevance</th>
          </tr>
%      foreach $id (@$list) {
          <tr>
             <td valign="top"><a href="/showtrack.html?trackid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top">
%               $copy{trackid} = $id->{mbid};
%               $copy{track} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>

       <%perl>
   }
}
elsif ($flags & TaggerSupport::ALBUMTRACKLIST)
{
   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching albums/tracks</b>:<p>
       <table>
          <tr>
             <th>Album</th>
             <th>Track</th>
             <th>Relevance</th>
          </tr>
%      foreach $id (@$list) {
          <tr>
             <td valign="top"><a href="/showalbum.html?albumid=<% $id->{albumid} %>"
                 ><% $id->{album} %></a></td>
             <td valign="top"><a href="/showtrack.html?trackid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top">
%               $copy{trackid} = $id->{mbid};
%               $copy{albumid} = $id->{albummbid};
%               $copy{track} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>

       <%perl>
   }
}
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID) && 
       ($flags & TaggerSupport::TRACKID))
{
   OutputArtist($ts, $result);
   OutputTrack($ts, $result);
}
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID))
{
   OutputArtist($ts, $result);
   OutputAlbum($ts, $result);
}
elsif ($flags & TaggerSupport::ARTISTID)
{
   OutputArtist($ts, $result);
}
else
{
   </%perl>
   Unknown lookup response.<br>
   flags: <% $flags %><br>
   list: 
%  mc_out(Dumper($list));
   <br>
   list: 
%  mc_out(Dumper($result));
   <br>
   <%perl>
}
</%perl>

<p>
<b>Input:</a> (for debugging)
<table>
<tr><td>Artist:</td><td><% $artist %></td></tr>
<tr><td>Album:</td><td><% $album %></td></tr>
<tr><td>Track:</td><td><% $track %></td></tr>
<tr><td>ArtistId:</td><td><% $artistid %></td></tr>
<tr><td>AlbumId:</td><td><% $albumid %></td></tr>
<tr><td>TrackId:</td><td><% $trackid %></td></tr>
<tr><td>TrackNum:</td><td><% $tracknum %></td></tr>
<tr><td>File Name:</td><td><% $filename %></td></tr>
<tr><td>Duration:</td><td><% $duration %></td></tr>
</table>
<p><br>
    
% $mb->Logout();
<& /comp/footer &>

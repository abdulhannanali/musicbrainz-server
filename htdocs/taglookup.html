%# vi: set ts=4 sw=4 ft=mason :
<%args>
$artist=>""
$release=>""
$album
$track=>""
$tracknum=>""
$filename=>""
$duration=>""
$tport=>$session{'tport'}
$mbt=>0
</%args>

<%perl>
UserStuff::EnsureSessionOpen(), $session{tport} = $tport
   if $tport;

$release = $album if $album;

MusicBrainz::TrimInPlace(
	$artist,
	$release,
	$track,
	$tracknum,
);

$m->comp("/comp/sidebar", title=>'Lookup Results');

my $_artist = MusicBrainz::normalize($artist);
my $_release = MusicBrainz::normalize($release);
my $_track = MusicBrainz::normalize($track);
my $_duration = 0;

if ($duration =~ /(\d+):(\d+)/)
{
    $_duration = (($1 * 60) + $2) * 1000;
}
elsif ($duration =~ /(\d+)/)
{
    $_duration = $1;
}

my $_tracknum = MusicBrainz::normalize($tracknum);

if ($_artist && $_track)
{
    my $query = "(artist:$artist) (track:$_track)";
    
    $query .= " (release:$_release)" if $_release;
    $query .= " tnum:$_tracknum" if $_tracknum;
    if ($_duration)
    {
        my $qdur = $_duration / 2000;
        $query .= " qdur:$qdur qdur:" . ($qdur - 1) . " qdur:" . ($qdur + 1) if ($qdur);
    }

    use URI::Escape qw( uri_escape );
    my $docurl = 'http://' . &DBDefs::LUCENE_SERVER . "/ws/1/track/?query=" . 
                 uri_escape($query) . "&type=track";
    $docurl .= "&tport=$tport" if $tport;
    $docurl .= "&dur=$_duration" if $_duration;
    $docurl .= "&mbt=1" if $mbt;

    require LWP::UserAgent;
    my $ua = LWP::UserAgent->new;
    my $response = $ua->get($docurl);
    if (!$response->is_success) 
    {
        if ($response->code == 404)
        {
            </%perl>
            <p>0 matches.<br/><br/>
            Your query <b><% $query |h %></b> did not match any tracks. Make sure that all words 
            are spelled correctly, use fewer words or use different words. For help on writing
            effective text search queries, please read the  
            <a href="http://wiki.musicbrainz.org/TextSearchSyntax">text search syntax</a> documentation.
            </p>
            <%perl>
        }
        elsif ($response->code == 403)
        {
            </%perl>
            <p><b>Error</b>: Your search query <b><% $query |h %></b> did not contain enough information to carry out a search.
               If you are attempting to find an artist that contains nothing but punctuation characters
               (e.g. !!!) then you should <a href="/browseartists.html?index=_">browse</a> for your
               artist, rather than search for it. 
               <br/><br/>
            For help on writing effective text search queries, please read the  
            <a href="http://wiki.musicbrainz.org/TextSearchSyntax">text search syntax</a> documentation.
            </p>
            <%perl>
        }
        elsif ($response->code == 500)
        {
            </%perl>
            <p><b>Error</b>: The search server could not fulfill your request due to an internal error.
            </p>
            <%perl>
        }
        else
        {
            $m->comp('/comp/error',
                 "Error: Could not execute search on search server. " .
                 "(URL $docurl received " . $response->status_line ." )", 0, 0);
        }
    }
    else
    {
        $m->print($response->content);
    }
}

</%perl>

<div style="margin-top: 3em; padding: 1em; border: 1px solid #565656;">
<& /comp/lookup, artist=>$artist, release=>$release, track=>$track, tracknum=>$tracknum, duration=>$_duration &>
</div>

<& /comp/footer &>

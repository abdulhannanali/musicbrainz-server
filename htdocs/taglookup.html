<& /comp/sidebar, title=>'Track Lookup', expand=>'moderate' &>

<%args>
$artist=>""
$artistid=>""
$album=>""
$albumid=>""
$track=>""
$trackid=>""
$tracknum=>""
$filename=>""
$trmid=>""
$duration=>0
$mbt=>0
</%args>

<%perl>
#% if (!defined $session{user} || $session{user} eq '') {
#    You must be logged in to edit the database.<p>
#    <& /comp/tablebegin, title=>'Login' &>
#    <& /comp/loginbox &>
#    <& /comp/tableend &>
#    <& /comp/footer &>
#%   return undef;
#% }

use Data::Dumper;
use URI::Escape;

# TODO: Add nicer error handling
sub OutputArtist
{
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   mc_out("<a href=\"/showartist.html?artistid=" . $ts->{artist}->GetId());
   mc_out("\"><font size=\"+2\">" . $ts->{artist}->GetName . "</font></a><p>");
}

sub OutputAlbum
{
   my ($ts, $data) = @_;

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   if (not exists $ts->{album})
   {
       $ts->{album} = Album->new($ts->{DBH});
       $ts->{album}->SetMBId($data->{albumid});
       $ts->{album}->LoadFromId()
   }
   mc_comp("/comp/album", artist=>$ts->{artist}, album=>$ts->{album},
           showalbumdetail=>1, mbtagger=>$data->{mbt}, showids=>1);
}

sub OutputTrack
{
   my ($ts, $data) = @_;
   my ($tr);

   if (not exists $ts->{artist})
   {
       $ts->{artist} = Artist->new($ts->{DBH});
       $ts->{artist}->SetMBId($data->{artistid});
       $ts->{artist}->LoadFromId()
   }
   if (not exists $ts->{album})
   {
       $ts->{album} = Album->new($ts->{DBH});
       $ts->{album}->SetMBId($data->{albumid});
       $ts->{album}->LoadFromId()
   }
   if (not exists $ts->{track})
   {
       $ts->{track} = Track->new($ts->{DBH});
       $ts->{track}->SetMBId($data->{trackid});
       $ts->{track}->LoadFromId()
   }

   mc_comp("/comp/album", artist=>$ts->{artist}, album=>$ts->{album},
           showalbumdetail=>1, mbtagger=>$data->{mbt}, showids=>1, hilitetrack=>$ts->{track}->GetId());
}

sub OutputForm
{
   my ($data) = @_;

   my $ret = qq|<FORM METHOD="POST" ACTION="/taglookup.html"
         ENCTYPE="application/x-www-form-urlencoded" class="formstyle">
     <INPUT TYPE="hidden" NAME="artist" VALUE="$data->{artist}">
     <INPUT TYPE="hidden" NAME="artistid" VALUE="$data->{artistid}">
     <INPUT TYPE="hidden" NAME="album" VALUE="$data->{album}">
     <INPUT TYPE="hidden" NAME="albumid" VALUE="$data->{albumid}">
     <INPUT TYPE="hidden" NAME="track" VALUE="$data->{track}">
     <INPUT TYPE="hidden" NAME="trackid" VALUE="$data->{trackid}">
     <INPUT TYPE="hidden" NAME="tracknum" VALUE="$data->{tracknum}">
     <INPUT TYPE="hidden" NAME="filename" VALUE="$data->{filename}">
     <INPUT TYPE="hidden" NAME="trmid" VALUE="$data->{trmid}">
     <INPUT TYPE="hidden" NAME="duration" VALUE="$data->{duration}">
     <INPUT TYPE="hidden" NAME="mbt" VALUE="$data->{mbt}">
     <INPUT TYPE="submit" NAME="submit" VALUE="Select">
   </form>|;

   return $ret;
}

sub OutputEditForm
{
   my ($data) = @_;

   my $ret = qq|<FORM METHOD="POST" ACTION="/taglookup.html"
         ENCTYPE="application/x-www-form-urlencoded" class="formstyle">
     <table>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Artist:
      </td>
      <td>
        <INPUT TYPE="text" NAME="artist" SIZE="30" VALUE="$data->{artist}">
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Album:
      </td>
      <td>
        <INPUT TYPE="text" NAME="album" SIZE="30" VALUE="$data->{album}">
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Track:
      </td>
      <td>
        <INPUT TYPE="text" NAME="track" SIZE="30" VALUE="$data->{track}">
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Track Num:
      </td>
      <td>
        <INPUT TYPE="text" NAME="tracknum" SIZE="2" VALUE="$data->{tracknum}">
      </td>
     </tr>
     <tr>
      <td colspan="2" align="right" valign="top" NOWRAP>
        <INPUT TYPE="submit" NAME="submit" SIZE="30" VALUE="Lookup">
        <INPUT TYPE="hidden" NAME="mbt" SIZE="2" VALUE="$data->{mbt}">
      </td>
     </tr>
     <tr>
      <td colspan="2">
        <b>Debug info:</b>
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Artist Id:
      </td>
      <td>
        $data->{artistid}
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Album Id:
      </td>
      <td>
        $data->{albumid}
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Track Id:
      </td>
      <td>
        $data->{trackid}
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        Duration:
      </td>
      <td>
        $data->{duration}
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        TRM Id:
      </td>
      <td>
        $data->{trmid}
      </td>
     </tr>
     <tr>
      <td align="right" valign="top" NOWRAP>
        MBTagger:
      </td>
      <td>
        $data->{mbt}
      </td>
     </tr>
   </table>
   </form>|;

   return $ret;
}

my ($mb, $ts, $result, $flags, $list, $error, $id, %data); 
my $bgcolor= '#ffffff';

$mb = mc_comp("/comp/dblogin");
$ts = TaggerSupport->new($mb->{DBH});

$data{artist} = $artist;
$data{artistid} = $artistid;
$data{album} = $album;
$data{albumid} = $albumid;
$data{track} = $track;
$data{trackid} = $trackid;
$data{tracknum} = $tracknum;
$data{trmid} = $trmid;
$data{duration} = $duration;
$data{filename} = $filename;
$data{mbt} = $mbt;

($error, $result, $flags, $list) = $ts->Lookup(\%data, 25);
if ($flags & TaggerSupport::ARTISTLIST)
{
   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching artists</b>:<p>
       <& /comp/framedboxbegin, width=>"420" &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center"><b>Artist</b></td>
             <td align="center"><b>Relevance</b></td>
          </tr>
%      foreach $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top">&nbsp;<a href="/showartist.html?artistid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top" align="right">
%               $copy{artistid} = $id->{mbid};
%               $copy{artist} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>
      

       <%perl>
   }
   else
   {
       </%perl>
       <br>
       <b>Found no matching artists.</b><p>
       <%perl>
   }

   mc_comp("/comp/lookupoptions", artist=>$artist, artistobj=>$ts->{artist}, 
                                  album=>$album, albumobj=>$ts->{album});
}
elsif ($flags & TaggerSupport::ALBUMLIST)
{
   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching albums</b>:<p>
       <& /comp/framedboxbegin, width=>"420" &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center"><b>Album</b></td>
             <td align="center"><b>Relevance</b></td>
          </tr>
%      foreach $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top"><a href="/showalbum.html?albumid=<% $id->{id} %>"
                 ><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top" align="right">
%               $copy{albumid} = $id->{mbid};
%               $copy{album} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>

       <%perl>
   }
   else
   {
       </%perl>
       <br>
       <b>Found no matching albums.</b><p>
       <%perl>
   }

   mc_comp("/comp/lookupoptions", artist=>$artist, artistobj=>$ts->{artist}, 
                                  album=>$album, albumobj=>$ts->{album});
}
elsif ($flags & TaggerSupport::ALBUMTRACKLIST)
{

   OutputArtist($ts, $result);

   if (scalar(@$list) > 0)
   {
       my %copy = %data;

       </%perl>
       <b>Found matching albums/tracks</b>:<p>
       <& /comp/framedboxbegin, width=>"420" &>
       <table cellspacing="0" width="100%">
          <tr>
             <td align="center"><b>Album</td>
             <td align="center">&nbsp;</b></td>
             <td align="center"><b>Track</b></td>
             <td align="center"><b>Relevance</b></td>
             <td align="center">&nbsp;</td>
          </tr>
%      foreach $id (@$list) {
          <tr bgcolor="<% $bgcolor = ( $bgcolor eq '#ffffff' ? '#ffe1b7' : '#ffffff' ) %>">
             <td valign="top">&nbsp;<a href="/showalbum.html?albumid=<% $id->{albumid} %>"><% $id->{album} %></a></td>
             <td width="10">&nbsp;</td>
             <td valign="top"><a href="/showtrack.html?trackid=<% $id->{id} %>"><% $id->{name} %></a></td>
             <td valign="top" align="center"><% int($id->{sim} * 100) %>%</td>
             <td valign="top" align="right">
%               $copy{trackid} = $id->{mbid};
%               $copy{albumid} = $id->{albummbid};
%               $copy{track} = $id->{name};
                <% OutputForm(\%copy) |n %>         
             </td>
          </tr>
%      }
       </table>
       <& /comp/framedboxend &>
      
       <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, album=>$album, albumobj=>$ts->{album} &>
   
       <%perl>

   }
   else
   {
       </%perl>
       <br>
       <b>Found no matching albums or tracks.</b><p>
       <%perl>
   }
}
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID) && 
       ($flags & TaggerSupport::TRACKID))
{
   </%perl>
   <b>Found matching track:</b><p>
   <%perl>
   OutputArtist($ts, $result);
   OutputTrack($ts, $result);
}
elsif (($flags & TaggerSupport::ARTISTID) && 
       ($flags & TaggerSupport::ALBUMID))
{
   </%perl>
   <b>Found matching album:</b><p>
   <%perl>
   OutputArtist($ts, $result);
   OutputAlbum($ts, $result);
}
elsif ($flags & TaggerSupport::ARTISTID)
{
   </%perl>
   <b>Found matching artist:</b><p>
   <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, album=>$album, albumobj=>$ts->{album} &>
   <%perl>
   OutputArtist($ts, $result);
}
else
{
   </%perl>
   <b>No matching artists found.</b><p>
   <& /comp/lookupoptions, artist=>$artist, artistobj=>$ts->{artist}, album=>$album, albumobj=>$ts->{album} &>
   <%perl>
}
</%perl>

<br>
<p>
<center>
<& /comp/tablebegin, title=>'Modify Lookup', bgcolor=>"#f0efff" &>
<% OutputEditForm($result) |n %>
<& /comp/tableend &>
</center>

% $mb->Logout();
<& /comp/footer &>

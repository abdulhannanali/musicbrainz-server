<%perl>
# -----------------------------------------------------------------------------
#                               Musicbrainz.org
#                        Copyright (c) 2001 Robert Kaye
# -----------------------------------------------------------------------------
#  This software is provided "as is", without warranty of any kind, express or
#  implied, including  but not limited  to the warranties of  merchantability,
#  fitness for a particular purpose and noninfringement. In no event shall the
#  authors or  copyright  holders be  liable for any claim,  damages or  other
#  liability, whether  in an  action of  contract, tort  or otherwise, arising
#  from,  out of  or in  connection with  the software or  the  use  or  other
#  dealings in the software.
#
#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
#  Permits anyone the right to use and modify the software without limitations
#  as long as proper  credits are given  and the original  and modified source
#  code are included. Requires  that the final product, software derivate from
#  the original  source or any  software  utilizing a GPL  component, such  as
#  this, is also licensed under the GPL license.
# -----------------------------------------------------------------------------
#
# Summary:
# -----------------------------------------------------------------------------
# Render top editors and voters statistics.
#
# $Id$
#
</%perl>

<%def .ShowTop>
% my ($data, $usertitle, $numtitle) = @_;

	<table class="topmods">
		<tr class="header">
			<td class="topmodsname"><% $usertitle || "Editor" %></td>
			<td class="topmodsnum"><% $numtitle || 'Count' %></td>
			<td></td>
		</tr>

%		local $. = 0;
%		for my $d (@$data)
%		{

		<tr class="topmods<% ("odd", "even")[++$. % 2] %>">
			<td class="topmodsname"
				<% ($d->{name} eq $d->{nametrunc}) ? "" : 'title="'.encode_entities($d->{name}).'"' |n %>
				><a href="/show/user/?userid=<% $d->{id} %>"><% $d->{nametrunc} %></a></td>
			<td class="topmodsnum"><% $d->{num} %></td>
			<td>[ <a href="/mod/search/pre/editor-open.html?userid=<% $d->{id} %>">open edits</a> ]</td>
		</tr>

%		}
%		if (not @$data)
%		{

		<tr class="topmods<% ("odd", "even")[++$. % 2] %>">
			<td class="topmodsnone" colspan="3">(no data to show)</td>
		</tr>

%		}

	</table>
</%def>

<%def .GetData>
<%perl>

    my $mb = $m->comp("/comp/dblogin");
	my $mod = Moderation->new($mb->{DBH});
	my $vote = MusicBrainz::Server::Vote->new($mb->{DBH});
	my @opts = (rowlimit => 25, namelimit => 20);

</%perl>

	<h2>Most active editors in the last week (open and accepted edits)</h2>
	<& .ShowTop, $mod->TopModerators(@opts), "Editor", "Edits", &>


	<h2>Most active editors overall (accepted edits only)</h2>
	<& .ShowTop, $mod->TopAcceptedModeratorsAllTime(@opts), "Editor", "Edits", &>


	<h2>Most active voters in the last week (yes and no votes only)</h2>
	<& .ShowTop, $vote->TopVoters(@opts, interval => "1 week"), "Voter", "Votes", &>


	<h2>Most active voters overall (yes and no votes only)</h2>
	<& .ShowTop, $vote->TopVoters(@opts, interval => "10 years"), "Voter", "Votes", &>


</%def>
<%perl>

	$m->clear_buffer;
	$m->comp("/comp/sidebar-notitle", pagetitle => "Top Editors & Voters");

	my $result = $m->cache->get("anyoldkey");
	if (!defined($result))
	{
		$result = $m->scomp(".GetData");
		$result = { HTML=> $result, TIME=>time() };
		$m->cache->set("anyoldkey", $result, "3 hours");
	}

</%perl>

	<% $result->{HTML} |n %>
	Statistics last updated: <% $m->comp("/comp/datetime", $result->{TIME}) %>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

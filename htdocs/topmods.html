<& /comp/sidebar, title=>'Top Moderators', expand=>'information' &>

<%perl>

my $result = $m->cache->get("anyoldkey");

if (!defined($result)) 
{
    my $mb = $m->comp("/comp/dblogin");

    $result = "";

    $result .= $m->comp("/comp/tablestat", 
                       mb=>$mb,
                       query=>qq|select Moderator.name, 
                                        count(Moderator.id) as num 
                                   from moderation_all m, Moderator 
                                  where m.Moderator = Moderator.id 
                                        and Moderator.id != | .  &ModDefs::FREEDB_MODERATOR . qq|
                                        and Moderator.id != | .  &ModDefs::MODBOT_MODERATOR . qq|
                                        and opentime > now() - interval '1 week' 
                               group by Moderator.name 
                               order by num desc limit 25|,
                       title=>"Most active moderators in the last week:<br>".
                              "(Open and accepted moderations)",
                       numcols=>2,
                       coltitles=>["User", "Moderations"]);

    $result .= $m->comp("/comp/tablestat", 
                       mb=>$mb,
                       query=>qq|select name, modsaccepted+automodsaccepted 
                                   from Moderator
                                        where Moderator.id != | .
                                        &ModDefs::FREEDB_MODERATOR . qq|
                                        and Moderator.id != | .
                                        &ModDefs::MODBOT_MODERATOR . qq|
                               order by 2 desc limit 25|,
                       title=>"Most active moderators overall:<br>".
                              "(Accepted moderations only)",
                       numcols=>2,
                       coltitles=>["User", "Moderations"]);

    $result .= $m->comp("/comp/tablestat", 
                       mb=>$mb,
                       query=>qq|select Moderator.name, count(v.id) as num
                                   from vote_all v, Moderator
                                  where v.moderator = Moderator.id and 
                                        (v.vote = 0 or v.vote = 1) and
                                        votetime > now() - interval '1 week' 
                               group by Moderator.id, Moderator.name
                               order by num desc limit 25|,
                       title=>"Most active voters in the last week:<br>" .
                              "(Yes and No votes only)",
                       numcols=>2,
											 coltitles=>["User", "Votes"]);

    $result .= $m->comp("/comp/tablestat", 
                       mb=>$mb,
                       query=>qq|select Moderator.name, count(v.id) 
                                        as num 
                                   from vote_all v, Moderator 
                                  where v.moderator = Moderator.id and
                                        (v.vote = 0 or v.vote = 1)
                               group by Moderator.id, Moderator.name 
                               order by num desc limit 25|,
                       title=>"Most active voters overall:<br>" .
                              "(Yes and No votes only)",
                       numcols=>2,
											 coltitles=>["User", "Votes"]);

    $mb->Logout();

		$result = { HTML=>$result, TIME=>time() };

		$m->cache->set('anyoldkey', $result, '3 hours');
}

</%perl>

<table>
	<tr><td>
			Generated:
			<% $m->comp("/comp/datetime", $result->{TIME}) %>
	</td></tr>
	<% $result->{HTML} |n %>
</table>

<& /comp/footer &>
%# vi: set ts=2 sw=2 ft=mason :

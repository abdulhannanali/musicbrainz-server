<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows a user to change their password.
	#
	# $Id$
	#
</%perl>
<%args>

	$password0 => ""
	$password1 => ""
	$password2 => ""
	$submitvalue => ""

</%args>
<%perl>

	my $changepw;
	@$changepw = ();

	# if user is not logged in, show login form.
	$m->comp("/comp/checkloggedin", 1, 1) or return;

	# prepare page output.
	$m->comp("/comp/sidebar-notitle", pagetitle => "Change Password");
	$m->comp("/comp/tablebegin", title => "Change Password");


	# we got a form submission to handle
	if ($submitvalue ne "")
	{
		if ($submitvalue =~ m/cancel/i)
		{
			return $m->comp("/comp/redirect", "/user/view.html");
		}
		else
		{
			my $uid = $session{"uid"} or return;

			my $mb = $m->comp("/comp/dblogin");
			my $ui = UserStuff->new($mb->{DBH});
			my $user = $ui->newFromId($uid)
				or return;

			$changepw = $user->ChangePassword($password0, $password1, $password2)
		}
	}

	if ($submitvalue ne "" && @$changepw == 0)
	{
		$m->out(qq!<div style="margin: 20px">Your password was updated.</diV>!);
		$m->out(qq!<div style="margin: 20px"><a href="/user/view.html">Continue</a></diV>!);
	}
	else
	{

</%perl>

	<form method="post" action="/user/change-password.html" id="ChangePassword">

		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>Your new password <% UserStuff->DescribePasswordConditions %></li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="formstyle">
% 	if (@$changepw != 0) {
			<tr>
				<td></td>
				<td class="error">
					<ul>
						<li><%perl> $m->out(join("</li><li>", @$changepw)); </%perl></li>
					</ul></td>
			</tr>
% 	}

			<tr>
				<td class="label">
					<label for="id_oldpassword">Old Password:</label></td>
				<td>
					<input type="password" name="password0" name="id_oldpassword" size="40" value="<% $password0 %>" style="width: 180px" /></td>
			</tr>
			<tr>
				<td class="label">
					<label for="id_newpassword">New Password:</label></td>
				<td><input type="password" name="password1" id="id_newpassword" size="40" value="<% $password1 %>" style="width: 180px" /></td>
			</tr>
			<tr>
				<td class="label">
					<label for="id_verifypassword">Verify Password:</label></td>
				<td>
					<input type="password" name="password2" id="id_verifypassword" size="40" value="<% $password2 %>" style="width: 180px" /></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td>
					<input type="submit" name="submitvalue" value="Cancel" />
					<input type="submit" name="submitvalue" value="Change password &raquo;" /></td>
			</tr>
		</table>
	</form>

	<& /comp/movefocus, id => "id_oldpassword" &>

%	}

<& /comp/tableend &>
<& /comp/footer &>

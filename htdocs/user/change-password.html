%# vi: set ts=4 sw=4 ft=mason :
<%args>
$password0=>""
$password1=>""
$password2=>""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1) or return;

$m->comp(
	"/comp/sidebar",
	title => 'Change My Password',
);

my $error;

if (%ARGS)
{ 
	my $uid = $session{uid} or return;

	my $mb = $m->comp("/comp/dblogin");
	my $ui = UserStuff->new($mb->{DBH});

	my $user = $ui->newFromId($uid)
		or return;

	if ($user->ChangePassword($password0, $password1, $password2))
	{	
		</%perl>
		<p class="notice">
			Your password was updated.
		</p>
		<p>
			<a href="/user/view.html">Continue</a>
		</p>
		<& /comp/footer &>
		<%perl>
	}

	$error = $@;
}

</%perl>

<p class="LinksRow">
	[
	<a href="/user/view.html">Profile &amp; Statistics</a>
	| <a href="/user/edit.html">Edit</a>
	| <a href="/prefs.html">Preferences</a>
	| <a href="/user/subscriptions.html">Subscriptions</a>
	]
</p>

% if ($error) {
<p class="error"><% $error %></p>
% } else {
<p>
	Your new password <% UserStuff->DescribePasswordConditions %>
</p>
% }

<form method="post" action="/user/change-password.html" id="ChangePassword">

	<table>
		<tr>
			<td align="right">Old Password:</td>
			<td><input type="password" name="password0" size="40"></td>
		</tr>
		<tr>
			<td align="right">New Password:</td>
			<td><input type="password" name="password1" size="40"></td>
		</tr>
		<tr>
			<td align="right">Verify password:</td>
			<td><input type="password" name="password2" size="40"></td>
		</tr>
		<tr>
			<td colspan="2">&nbsp;</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td>
				<input type="submit" value="Change Password">
			</td>
		</tr>
	</table>

</form>

<& /comp/movefocus, "ChangePassword", "password0" &>
<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :
<%args>

	$password0 => ""
	$password1 => ""
	$password2 => ""
	$submitvalue => ""

</%args>
<%perl>

	my $changepw;
	@$changepw = ();

	# if user is not logged in, show login form.
	$m->comp("/comp/checkloggedin", 1, 1) or return;

	# prepare page output.
	$m->comp("/comp/sidebar-notitle", pagetitle => "Change Password");
	$m->comp("/comp/tablebegin", title => "Change Password");


	# we got a form submission to handle
	if ($submitvalue ne "")
	{
		if ($submitvalue =~ m/cancel/i)
		{
			return $m->comp("/comp/redirect", "/user/view.html");
		}
		else
		{
			my $uid = $session{"uid"} or return;

			my $mb = $m->comp("/comp/dblogin");
			my $ui = UserStuff->new($mb->{DBH});
			my $user = $ui->newFromId($uid)
				or return;

			$changepw = $user->ChangePassword($password0, $password1, $password2)
		}
	}

	if ($submitvalue ne "" && @$changepw == 0)
	{
		$m->out(qq!<div style="margin: 20px">Your password was updated.</diV>!);
		$m->out(qq!<div style="margin: 20px"><a href="/user/view.html">Continue</a></diV>!);
	}
	else
	{

</%perl>

	<form method="post" action="/user/change-password.html" id="ChangePassword">

		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>Your new password <% UserStuff->DescribePasswordConditions %></li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="formstyle">
% 	if (@$changepw != 0) {
			<tr>
				<td></td>
				<td class="error">
					<ul>
						<li><%perl> $m->out(join("</li><li>", @$changepw)); </%perl></li>
					</ul></td>
			</tr>
% 	}

			<tr>
				<td class="label">
					<label for="id_oldpassword">Old Password:</label></td>
				<td>
					<input type="password" name="password0" name="id_oldpassword" size="40" value="<% $password0 %>" style="width: 180px" /></td>
			</tr>
			<tr>
				<td class="label">
					<label for="id_newpassword">New Password:</label></td>
				<td><input type="password" name="password1" id="id_newpassword" size="40" value="<% $password1 %>" style="width: 180px" /></td>
			</tr>
			<tr>
				<td class="label">
					<label for="id_verifypassword">Verify Password:</label></td>
				<td>
					<input type="password" name="password2" id="id_verifypassword" size="40" value="<% $password2 %>" style="width: 180px" /></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td>
					<input type="submit" name="submitvalue" value="Cancel" />
					<input type="submit" name="submitvalue" value="Change password &raquo;" /></td>
			</tr>
		</table>
	</form>

	<& /comp/movefocus, id => "id_oldpassword" &>

%	}

<& /comp/tableend &>
<& /comp/footer &>

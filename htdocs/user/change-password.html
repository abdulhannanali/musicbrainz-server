%# vi: set ts=4 sw=4 ft=mason :
<%args>
	$password0 => ""
	$password1 => ""
	$password2 => ""
	$submit => ""
</%args>
<%perl>
	my $changepw;
	@$changepw = ();

	# if user is not logged in, show login form.
	$m->comp("/comp/checkloggedin", 1, 1) or return;

	# prepare page output.
	$m->comp("/comp/sidebar-notitle", pagetitle => "Change Password");
	$m->comp("/comp/tablebegin", title => "Change Password");


	# if the form was submitted, call the backend function.
	if ($submit ne "")
	{
		my $uid = $session{uid} or return;

		my $mb = $m->comp("/comp/dblogin");
		my $ui = UserStuff->new($mb->{DBH});
		my $user = $ui->newFromId($uid)
			or return;

		$changepw = $user->ChangePassword($password0, $password1, $password2)
	}

	if ($submit ne "" && @$changepw == 0)
	{
		$m->out(qq!<div style="margin: 20px">Your password was updated.</diV>!);
		$m->out(qq!<div style="margin: 20px"><a href="/user/view.html">Continue</a></diV>!);
	}
	else
	{

</%perl>

	<form method="post" action="/user/change-password.html" id="ChangePassword">

		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>Your new password <% UserStuff->DescribePasswordConditions %></li>
					</ul>
				</td>
			</tr>

% 	if (@$changepw != 0) {
			<tr>
				<td></td>
				<td class="error">
					<ul>
						<li><%perl> $m->out(join("</li><li>", @$changepw)); </%perl></li>
					</ul></td>
			</tr>
% 	}

			<tr>
				<td class="label">
					<label for="id_password0">Old Password:</label></td>
				<td>
					<input class="textfield" type="password" name="password0" name="id_password0" size="40" value="<% $password0 %>" /></td>
			</tr>
			<tr>
				<td class="label">
					<label for="id_password">New Password:</label></td>
				<td><input class="textfield" type="password" name="password1" id="id_password1" size="40" value="<% $password1 %>" /></td>
			</tr>
			<tr>
				<td class="label">
					<label for="id_password2">Verify password:</label></td>
				<td>
					<input class="textfield" type="password" name="password2" id="id_password2" size="40" value="<% $password2 %>" /></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td>
					<input type="submit" name="submit" value="Submit" /></td>
			</tr>
		</table>
	</form>

	<& /comp/movefocus, "ChangePassword", "password0" &>

%	}

<& /comp/tableend &>
<& /comp/footer &>

<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows a user to confirm their e-mail address.
	#
	# $Id$
	#
</%perl>
<%args>

	$uid => -1
	$email => ""
	$time => -1
	$chk => ""

</%args>
<%perl>

if (&DBDefs::DB_READ_ONLY) {
  </%perl>
  <table>
  <tr>
    <td>
       &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
    </td>
    <td>
       <% &DBDefs::DB_READ_ONLY_MESSAGE %>
    </td>
    <td>
    &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
  </td>
  </tr>
  </table>
  <%perl>

} else {

MusicBrainz::IsNonNegInteger($uid) && $uid
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($time) && $time
  or return $m->comp("/comp/badargs", 1, 1);

$email or return $m->comp("/comp/badargs", 1, 1);
$chk or return $m->comp("/comp/badargs", 1, 1);

my $mb = $m->comp("/comp/dblogin");
my $ui = UserStuff->new($mb->{DBH});

$ui->GetVerifyChecksum($email, $uid, $time) eq $chk
    or return $m->comp("/comp/badargs", 1, 1);

if ($time + &DBDefs::EMAIL_VERIFICATION_TIMEOUT() < time())
{
    $m->comp("/comp/sidebar", title => 'Verify EMail Address');
    </%perl>
    This email address change verification expired. Please
    <a href="/login.html">Log in</a> and request the
    email change again.
    <& /comp/footer &>
    <%perl>
    return undef;
}

my $me = $ui->newFromId($uid);
if (not $me)
{
    $m->comp("/comp/sidebar", title => 'Verify EMail Address');
    </%perl>
    Cannot find user with user id <% $uid %>.
    <& /comp/footer &>
    <%perl>
    return undef;
}

if ($me->SetUserInfo(email => $email))
{
		$me->SetSession;
    $m->comp("/comp/sidebar", title => 'Verify EMail Address');
    </%perl>
    Your new email address has been saved. Thank you!<p>
    [ <a href="/user/view.html">View Profile</a> ]
    <%perl>
}
else
{
    $m->comp("/comp/sidebar", title => 'Verify EMail Address');
    </%perl>
    Failed to update user information.
    <%perl>
}

</%perl>

% }

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

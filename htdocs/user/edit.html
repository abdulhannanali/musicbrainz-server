%# vi: set ts=4 sw=4 ft=mason :
<%args>
$update=>0
$bio=>""
$email=>""
$weburl=>""
</%args>
<%perl>

$m->comp("/comp/checkloggedin", 1, 1) or return;
my $uid = $session{uid} or return;

my $mb = $m->comp("/comp/dblogin");
my $ui = UserStuff->new($mb->{DBH});

my $info = $ui->newFromId($uid)
	or return;

$m->comp(
	"/comp/sidebar",
	title => 'Edit My Profile',
);

if ($update)
{ 
    if ($email =~ /\S/ and !$ui->CheckEMailAddress($email))
    {
		</%perl>

		<p class="error">
			The email address you entered is not a valid email address.&nbsp;
			Please go back and enter a valid email address.&nbsp;
			If you would like to remove your address from the system,
			just enter a blank address.
		</p>

        <& /comp/footer &>

        <%perl>
        return undef;
    }

	my %opts;

	if ($info->GetEmail ne $email)
    {
		if ($email =~ /\S/)
		{
			my $ret = $info->SendVerificationEmail($email);
			if ($ret)
			{
				</%perl>
				<p class="error">
					The email verification mail could not be sent: <b><% $ret %></b>.&nbsp;
					Your email address has not been updated.
				</p>
				<%perl>
			}
			else
			{
				</%perl>
				<p class="notice">
					The email verification mail has been sent to <b><% $email %></b>.&nbsp;
					Please check your mailbox and click on the link in the email to 
					verify the new email address.
				</p>
				<%perl>
			}

			# Reset the email address to the old one since this one has
			# not been verified yet.
			$email = $info->GetEmail;
		} else {
            my ($mod, $count);

            $mod = Moderation->new($mb->{DBH});
            $count = $mod->OpenModCountByModerator($info->GetId);
            if ($count)
            {
                </%perl>
                <p class="notice">
                    You have <% $count %> moderations open. You cannot remove your email address
                    when you have open moderations. Please wait until all these moderations pass or
                    delete your moderations before you remove your email address.
                </p>
                <%perl>
            } 
            else
            {
                # The user wants to blank out their email address.
                $opts{email} = "";

                </%perl>
                <p class="notice">
                    Your e-mail address has been removed.&nbsp;
                    Please note that if you add it in again in the future,
                    you will be asked to verify it again.
                </p>
                <%perl>
            } 
		}
    }

    $info->SetUserInfo(
		%opts,
		weburl => $weburl,
		bio => $bio,
	);

	</%perl>

	<p class="notice">
		Your information was updated.
	</p>

	<p>
		<a href="/user/view.html">Continue</a>
	</p>

	<& /comp/footer &>

	<%perl>

	return;
}

my $membersince = $m->comp("/comp/datetime", $info->GetMemberSince);

if ($info->GetMemberSince eq "1970-01-01 00:00:00 UTC")
{
    $membersince = '<font class="bold">Charter Member</font>';
} 
if ($info->GetName eq "rob")
{
    $membersince = '<font class="bold">the dawn of this project</font>';
} 

</%perl>

<p class="LinksRow">
	[
	<a href="/user/view.html">Profile &amp; Statistics</a>
	| <a href="/user/change-password.html">Change Password</a>
	| <a href="/prefs.html">Preferences</a>
	| <a href="/user/subscriptions.html">Subscriptions</a>
	]
</p>

<form method="post" action="/user/edit.html" id="EditUser">

<table>
<tr>
    <td width="15%" align="right">Name:</td>
    <td><% $info->GetName %></td>
</tr>
<tr>
    <td width="15%" align="right">User type:</td>
    <td><% $info->GetUserType %></td>
</tr>

<tr>
    <td colspan="2">&nbsp;</td>
</tr>

<tr>
    <td align="right">EMail:</td>
	<td><input type="text" name="email" size="40" value="<% $info->GetEmail %>"></td>
</tr>
<tr>
	<td></td>
	<td>
		(If you enter a new email address, you will be required to
		verify the new email address)
	</td>
</tr>

<tr>
    <td colspan="2">&nbsp;</td>
</tr>

<tr>
    <td align="right">Homepage:</td>
    <td><input type="text" name="weburl" size="40" 
               value="<% $info->GetWebURL %>">
    </td>
</tr>
<tr>
    <td valign="top" align="right">Bio:</td>
%   (my $t = $info->GetBio) =~ s/<p>/\n/g;
    <td><textarea name="bio" cols=40 rows=10><% $t %></textarea></td>
<tr>
    <td colspan="2">&nbsp;</td>
</tr>
<tr>
    <td>&nbsp;</td>
    <td>
        <INPUT TYPE="hidden" NAME="update" VALUE="1">
        <INPUT TYPE="submit" NAME="Submit" VALUE="Save Changes">
    </td>
</tr>

</table>
</form>

<p>
	See also <a href="/prefs.html#privacy-settings">your preferences page</a>,
	which includes your privacy settings.
</p>

<p>
	If you would like to delete your account, please see
	<a href="http://wiki.musicbrainz.org/wiki.pl?GeneralFAQ">"How do I delete
		my account?"</a>
</p>

<& /comp/movefocus, "EditUser", "email" &>
<& /comp/footer &>

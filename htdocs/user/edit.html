<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows an user to edit their profile.
	#
	# $Id$
	#
</%perl>
<%args>

	$bio => ""
	$email => ""
	$weburl => ""
	$submitvalue => ""

</%args>
<%perl>

	# overloaded case of the checkloggedin component:
	# if the user visits this page to confirm his e-mail
	# address, he of course can edit his account without
	# having a confirmed e-mail address set.
	$m->comp("/comp/checkloggedin", 1, 1, undef, 1) or return;
	my $userid = $session{"uid"} or return;

	my $mb = $m->comp("/comp/dblogin");
	my $ui = UserStuff->new($mb->{DBH});

	my $info = $ui->newFromId($userid)
		or return;

	$m->comp("/comp/sidebar-notitle", pagetitle => "Edit Account");
	$m->comp("/comp/tablebegin", title => "Edit Account");

	my ($messages, $sentmail, $sentaddress, $removedmail, %opts);
	@$messages = ();
	$sentmail = 0;
	$sentaddress = $email;
	$removedmail = 0;

	if ($submitvalue ne "")
	{
		if ($submitvalue =~ m/cancel/i)
		{
			return $m->comp("/comp/redirect", "/user/view.html");
		}
		if ($email =~ /\S/ and !$ui->CheckEMailAddress($email))
		{
			push @$messages, "The email address you entered is not a valid email address.
							  If you would like to remove your address from the system,
							  just enter a blank address.";
		}
		else
		{
			if ($info->GetEmail ne $email)
			{
				if ($email =~ /\S/)
				{
					my $ret = $info->SendVerificationEmail($email);
					if ($ret)
					{
						push @$messages, "The email verification mail could not be sent:
										 <i>$ret</i>. Your email address has not been updated.";
					}
					else
					{
						$sentmail = 1;
					}

					# Reset the email address to the old one since this one has
					# not been verified yet.
					$email = $info->GetEmail;
				}
				else
				{
					my ($mod, $count);
					$mod = Moderation->new($mb->{DBH});
					$count = $mod->OpenModCountByModerator($info->GetId);
					if ($count)
					{
						push @$messages, "You have $count open edits. You cannot remove
										  your e-mail address while you have open edits.
										  Please wait until all these edits pass or delete
										  them before you remove your e-mail address.";
					}
					else
					{
						# The user wants to blank out their e-mail address.
						$opts{email} = "";
						$removedmail = 1;
					}
				}
			}
		}

		if (@$messages == 0)
		{
			$info->SetUserInfo(
				%opts,
				weburl => $weburl,
				bio => $bio,
			);

			if ($sentmail)
			{
				$m->out(qq!<div style="margin-top: 20px"> !);
				$m->out(qq! The email verification mail has been sent to <strong>$sentaddress</strong>.
							Please check your mailbox and click on the link in the email to
							verify the new email address.!);
				$m->out(qq!</div>!);
			}
			elsif ($removedmail)
			{
				$m->out(qq!<div style="margin-top: 20px"> !);
				$m->out(qq! Your e-mail address has been removed.&nbsp;
							Please note that if you add it in again in the future,
							you will be asked to verify it again.!);
				$m->out(qq!</div>!);
			}
			else
			{
				$m->out(qq!Your Account Settings were updated. !);
			}

			$m->out(qq!<div style="margin-top: 20px"> !);
			$m->out(qq!  <a href="/user/view.html">Click here to continue</a>. !);
			$m->out(qq!</div>!);

			$m->comp("/comp/tableend");
			$m->comp("/comp/footer");
			return undef;
		}
	}

	my $membersince = $m->comp("/comp/datetime", $info->GetMemberSince);

	if ($info->GetMemberSince eq "1970-01-01 00:00:00 UTC")
	{
	    $membersince = '<strong>Charter Member</strong>';
	}
	if ($info->GetName eq "rob")
	{
	    $membersince = '<strong>The dawn of this project</strong>';
	}

</%perl>


	<form method="post" action="/user/edit.html" id="EditUser">
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							See also <a href="/user/preferences.html#privacy-settings">your preferences page</a>,
							which includes your privacy settings.</li>
						<li>
							If you would like to delete your account, please see the FAQ entry
							<a href="/doc/AccountFAQ">How do I delete my account?</a></li>
					</ul></td>
			</tr>


%			if (@$messages > 0)
%			{

			<tr>
				<td>&nbsp;</td>
				<td class="error">
					<ul>
						<li><%perl> $m->out(join("</li><li>", @$messages)); </%perl></li>
					</ul>
				</td>
			</tr>

%			}

			<tr>
				<td class="label">
					<label>Name:</label></td>
				<td class="field">
					<% $info->GetName %></td>
			</tr>
			<tr>
				<td class="label">
					<label>User type:</label></td>
				<td class="field">
					<% $info->GetUserType | n %></td>
			</tr>
			<tr class="spaced">
				<td class="label">&nbsp;</td>
				<td class="formsection">
					Please Note: If you enter or modify your e-mail
					address, you will be required to verify it.
				</td>
			</tr>
			<tr>
				<td class="label">
					<label>E-mail address:</label></td>
				<td class="field">
					<input type="text" name="email" size="40" value="<% $info->GetEmail %>" /></td>
			</tr>

			<tr class="spaced">
				<td>&nbsp;</td>
				<td class="formsection">
					Additional Information:</td>
			</tr>
			<tr>
				<td class="label">Homepage:</td>
				<td class="field">
					<input type="text" name="weburl" size="40" value="<% $info->GetWebURL %>" /></td>
			</tr>
			<tr class="top">
				<td class="label">Bio:</td>

%					(my $t = $info->GetBio) =~ s/<p>/\n/g;

				<td class="field">
					<textarea name="bio" cols="40" rows="10"><% $t %></textarea></td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td class="field">
					<input type="submit" name="submitvalue" value="Save Changes &raquo;" />
					<input type="submit" name="submitvalue" value="Cancel" /></td>
			</tr>
		</table>
	</form>

	<& /comp/tableend &>
	<& /comp/movefocus, "EditUser", "email" &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$id => undef
</%args>
<%perl>

MusicBrainz::IsNonNegInteger($id)
	or return $m->comp("/comp/redirect", "/user/election/");

my $mb = $m->comp("/comp/dblogin");
my $sql = Sql->new($mb->{DBH});
my $el = MusicBrainz::Server::AutomodElection->new($mb->{DBH});
$el->DoCloseElections;

# Lazy shortcut: set up an object containing just an ID, since the class will
# re-read the election data anyway
my $election = $el;
$el->SetId($id);

my $error = undef;

eval {
	$sql->AutoTransaction(
		sub {
			$el->Cancel($session{uid})
				or $error = $@;
		},
	);
};
return $m->comp("/comp/error", "Error: $@", 1, 1)
	if $@;

return $m->comp("/comp/redirect", "/user/election/show.html?id=$id")
	if not $error;

return $m->comp("/comp/error", "No such election #$id", 1, 1)
	if $error eq "NO_SUCH_ELECTION";

return $m->comp("/comp/error", "This election was not proposed by you", 1, 1)
	if $error eq "NOT_PROPOSED_BY_YOU";

return $m->comp("/comp/error", "This election is closed", 1, 1)
	if $error eq "VOTING_CLOSED";

# Hmmm.  What happened?
return $m->comp("/comp/redirect", "/user/election/show.html?id=$id");

</%perl>

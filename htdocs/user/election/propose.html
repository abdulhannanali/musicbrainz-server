<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page shows a notice if there are pending autoeditor elections
	#
	# $Id$
	#
</%perl>
<%args>

	$username => undef
	$submitvalue => ""

</%args>
<%perl>

	MusicBrainz::IsSingleLineString($username)
		or return $m->comp("/comp/redirect", "/user/election/");

	UserStuff->IsAutoMod($session{privs})
		or return $m->comp("/comp/error",
			"Only existing autoeditors can propose new autoeditors",
			1, 1,
		);

	my $mb = $m->comp("/comp/dblogin");
	my $sql = Sql->new($mb->{DBH});
	my $el = MusicBrainz::Server::AutomodElection->new($mb->{DBH});
	# $el->DoCloseElections;

	if ($submitvalue eq "")
	{
		return $m->comp("propose-confirm.inc", username => $username);
	}
	elsif ($submitvalue =~ m/Cancel/i)
	{
		return $m->comp("/comp/redirect", "/show/user/?username=$username");
	}
	else
	{
		my $error = undef;
		my $new_election = undef;

		eval {
			$sql->AutoTransaction(
				sub {
					my $us = UserStuff->new($mb->{DBH});
					my $candidate = $us->newFromName($username)
						or $error = "NO_SUCH_CANDIDATE", return;
					$new_election = $el->Propose($session{uid}, $candidate)
						or $error = $@;
				},
			);
		};

		my $title = "Could not create Autoeditor Election";

		return $m->comp("/comp/layout/error", title => $title, text => "Error: $@", 1, 1)
			if $@;

		return $m->comp("/comp/redirect", "/user/election/show.html?id=" . $new_election->GetId)
			if not $error;

		return $m->comp("/comp/layout/error",, title => $title, text => "User '$username' was not found", 1, 1)
			if $error eq "NO_SUCH_CANDIDATE";

		return $m->comp("/comp/layout/error",, title => $title, text => "'$username' is already an autoeditor", 1, 1)
			if $error eq "ALREADY_AN_AUTOMOD";

		return $m->comp("/comp/layout/error",, title => $title, text => "'$username' is ineligible for autoeditor status", 1, 1)
			if $error eq "INELIGIBLE";

		my ($id) = $error =~ /^EXISTING_ELECTION (\d+)$/ or die;

</%perl>

<& /comp/sidebar-notitle, pagetitle => "Propose a Candiate for autoeditor" &>

	<& /comp/tablebegin, title => "Propose a Candiate for autoeditor" &>

		There is already an election open for this candidate.
		<a href="show.html?id=<% $id %>">Show details</a>.

	<& /comp/tableend &>

<& /comp/footer &>

%	}

%# vi: set ts=4 sw=4 ft=mason :

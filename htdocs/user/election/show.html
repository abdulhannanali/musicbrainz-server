<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page shows details of an autoeditor election.
	#
	# $Id$
	#
</%perl>
<%args>

	$id => undef

</%args>
<%perl>

	MusicBrainz::Server::Validation::IsNonNegInteger($id)
		or return $m->comp("/comp/redirect", "/user/election/");

	my $mb = $m->comp("/comp/dblogin");
	my $el = MusicBrainz::Server::AutomodElection->new($mb->{DBH});
	# $el->DoCloseElections;

	my $election = $el->newFromId($id)
		or return $m->comp("/comp/error",
			"No such election", 1, 1,
		);

	my %c;
	my $us = UserStuff->new($mb->{DBH});

	my $drawuser = sub {
		my $uid = shift;
		my $obj = $c{$uid} ||= $us->newFromId($uid);
		$obj or return;
		$m->comp("/comp/linkuser", user => $obj, shorten => 0);

		"";
	};

	my $propsec = grep { (($election->$_)||0) == $session{uid} }
		qw( GetProposer GetSeconder1 GetSeconder2 );

	my $do_seconder = sub {
		my ($key, $status) = @_;

		if (my $uid = $election->$key)
		{
			&$drawuser($uid);

		}
		elsif ($election->GetStatus == $status and not $propsec)
		{
			</%perl>
			<form method="post" action="second.html">
				<input type="hidden" name="id" value="<% $id %>" />
				<input type="submit" value="Second this candidate" />
			</form>
			<%perl>
		}
		else
		{
			$m->out("-");
		}

		"";
	};

	# Do we show the tally of votes cast so far?
	my $show_vote_count;

	if ($election->GetStatus =~ /[456]/
		or $propsec
		or $session{uid} == $election->GetCandidate)
	{
		$show_vote_count = "YES";
	}
	elsif ($election->GetStatus == 3)
	{
		$show_vote_count = "LATER";
	}
	else
	{
		$show_vote_count = 0;
	}

</%perl>

<& /comp/sidebar-notitle, pagetitle => "AutoEditor Election Details" &>

	<form action="index.html" method="get">
		<div style="margin-bottom: 15px">
			<input type="submit" value="Back to List of Elections" />
		</div>
	</form>

	<& /comp/tablebegin, title => "AutoEditor Election Details" &>

		<table class="formstyle">
			<tr>
				<td class="label">Candidate:</td>
				<td><% &$drawuser($election->GetCandidate) %></td>
			</tr>
			<tr>
				<td class="label">Proposer:</td>
				<td>
					<form method="post" action="cancel.html">
						<% &$drawuser($election->GetProposer) %>

% 	if ($session{uid} == $election->GetProposer and $election->GetStatus =~ /[123]/)
%	{

						&nbsp; &nbsp; &nbsp; &nbsp;
						<input type="hidden" name="id" value="<% $id %>">
						<input type="submit" value="Cancel the Election">
% 	}
					</form>
				</td class="label">
			</tr>
			<tr>
				<td class="label">Proposal Submitted:</td>
				<td><% $m->comp("/comp/datetime", $election->GetProposeTime) %></td>
			</tr>
			<tr>
				<td class="label">1st Seconder:</td>
				<td><% &$do_seconder('GetSeconder1', '1') %></td>
			</tr>
			<tr>
				<td class="label">2nd Seconder:</td>
				<td><% &$do_seconder('GetSeconder2', '2') %></td>
			</tr>

% 	if ($show_vote_count eq "LATER")
%	{

			<tr>
				<td class="label">Votes For/Against:</td>
				<td>The tally of votes cast will only be shown when the election is complete</td>

% 	}
%	elsif ($show_vote_count eq "YES")
%	{

			<tr>
				<td class="label">Votes For:</td>
				<td><% $election->GetYesVotes %></td>
			</tr>
			<tr>
				<td class="label">Votes Against:</td>
				<td><% $election->GetNoVotes %></td>
			</tr>

% 	}

			<tr>
				<td class="label">Status:</td>
				<td>
					<% $election->GetStatusName %>

% 	if ($election->GetStatus == 3)
%	{
					since <% $m->comp("/comp/datetime", $election->GetOpenTime) %>

% 	}
%	elsif ($election->GetStatus =~ /[456]/)
%	{

					at <% $m->comp("/comp/datetime", $election->GetCloseTime) %>
% 	}
				</td>
			</tr>
		</table>
	<& /comp/tableend &>


	<& /comp/tablebegin, title => "Voting Information" &>

% 	if ($election->GetStatus =~ /[12]/)
%	{

		Voting is not yet open.&nbsp;
		If you would like to support this candidate, you can second their
		nomination. If you do not support this candidate, please note that you cannot cast a
		"No" vote (or abstain) until two seconders have been found.

%	}
%	elsif ($election->GetStatus == 3)
%	{

% 		if (UserStuff->IsAutoEditor($session{privs}))
%		{
% 			if (not $propsec)
%			{

	<p>You may vote for this candidate.</p>

	<form method="post" action="vote.html">
		<p>
			<input type="hidden" name="id" value="<% $id %>">
			<input type="submit" name="vote" value="Vote YES">
			&nbsp; &nbsp; &nbsp; &nbsp;
			<input type="submit" name="vote" value="Vote NO">
			&nbsp; &nbsp; &nbsp; &nbsp;
			<input type="submit" name="vote" value="Abstain">
		</p>
	</form>

% 			}
%			else
%			{

		You cannot vote for this candidate, because you proposed / seconded them.

% 			}
% 		}
%		elsif (not $session{uid})
%		{

		To find out if you can vote for this candidate, please <a href="/login.html">log in</a>.

% 		}
%		else
%		{

		You cannot vote for this candidate, because you are not an AutoEditor.

% 		}

% 	}
%	else
%	{

		Voting is closed.

% 	}

	<& /comp/tableend &>

% 	# show voting history
% 	if ($election->GetStatus =~ /[3456]/)
%	{
% 		my $votes = $election->GetVotes;

	<& /comp/tablebegin, title => "Votes Cast" &>

% 		if (@$votes)
%		{

		<table class="SpacedColumns">
			<tr>
				<th>Voter</th>
				<th>Vote</th>
				<th>Date/Time</th>
			</tr>

% 			for my $vote (@$votes)
% 			{

			<tr>
				<td><% &$drawuser($vote->GetVoter) %></td>
				<td><% $vote->GetVoter == $session{uid} ? $vote->GetVoteName : "(private)" %></td>
				<td><% $m->comp("/comp/datetime", $vote->GetVoteTime) %></td>
			</tr>

% 			}

		</table>

% 		}
%		else
%		{

		No votes <% $election->GetStatus == 3 ? "have been" : "were" %> cast.

% 		}

	<& /comp/tableend &>

%	}

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

%# vi: set ts=2 sw=2 ft=mason :
<%args>
$username => ""
</%args>
<%perl>

if (&DBDefs::DB_IS_REPLICATED) 
{
	  </%perl>
    <& /comp/sidebar, title => "Forgotten Password" &>
  	<p style="margin: 1em">
      This is a mirror server -- you cannot retrieve your password from this server.
	  </p>
  	<p style="margin: 1em">
  	If you would like to retrieve your password, please go to the 
  	<a href="http://musicbrainz.org/user/forgot-password.html">main server</a>.
  	</p>
    <& /comp/footer &>
	  <%perl>
    return
}

return $m->comp("forgot-password-loggedin.inc")
	if $session{uid};

my $error = "";

if (MusicBrainz::IsSingleLineString($username)
	and $username =~ /\S/)
{
	my $mb = $m->comp("/comp/dblogin");

	require UserStuff;
	my $user = UserStuff->new($mb->{DBH})->newFromName($username);

	if ($user)
	{
		$error = $user->SendPasswordReminder;
		return $m->comp("forgot-password-done.inc", $user)
			if $error eq "";
	} else {
		$error = "Sorry, there is no user by that name.";
	}
}

</%perl>
<& /comp/sidebar, title => "Forgotten Password" &>

<p>
	If you know your user name, and you've already
	entered and confirmed your e-mail address, then we can send you
	your password.
</p>

% if ($error) {
<p class="notice"><% $error %></p>
% }

<form method="post" action="forgot-password.html" name="ForgotPass">
	<p>
		User Name:
		<input type="text" name="username" size="20">
		<input type="submit" value="Go">
	</p>
</form>

<p>
	If you can't remember your user name, please
	<a href="/support/contact.html">contact us</a>,
	and we'll see if we can help you.
</p>

<& /comp/movefocus, "ForgotPass", "username" &>
<& /comp/footer &>

%# vi: set ts=4 sw=2 ft=mason :
<%args>
	$username => ""
	$email => ""
	$submit => ""
</%args>
<%perl>
	my $error = "";

	$m->comp("/comp/sidebar-notitle", pagetitle => "Forgotten Password");
	$m->comp("/comp/tablebegin", title => "Forgotten Password");

	if (&DBDefs::REPLICATION_TYPE == RT_SLAVE)
	{
		$m->out(qq!<div style="margin: 1em">!);
		$m->out(qq!  This is a mirror server -- you cannot retrieve your password from this server. !);
		$m->out(qq!</div>!);
		$m->out(qq!<div style="margin: 1em">!);
		$m->out(qq!  If you would like to retrieve your password, please go to the!);
		$m->out(qq!  <img src="/images/icon/extlink.gif" alt="" /> !);
		$m->out(qq!  <a href="http://musicbrainz.org/user/forgot-password.html">main server</a>.!);
		$m->out(qq!</div>!);
	}
	else
	{
		if ($session{uid})
		{
			return $m->comp("forgot-password-loggedin.inc")
		}
		else
		{
			if ($submit ne "")
			{
				if ($username eq "" && $email eq "")
				{
					$error = "Please fill either the user name or the e-mail address field.";
				}
				else
				{
					require UserStuff;
					my $mb = $m->comp("/comp/dblogin");
					my $user = UserStuff->new($mb->{DBH});

					if (MusicBrainz::IsSingleLineString($email)
						and $email =~ /\S/)
					{
						$username = $user->LookupNameByEmail($email);
						if (!$username)
						{
							$error = "No account found with this e-mail address";
						}
					}

					if ($error eq "" &&
						MusicBrainz::IsSingleLineString($username)
						and $username =~ /\S/)
					{
						$user = $user->newFromName($username);
						if ($user)
						{
							$error = $user->SendPasswordReminder;
							return $m->comp("forgot-password-done.inc", $user)
								if $error eq "";

						} else {
							$error = "Sorry, there is no user by that name.";
						}
					}
				}
			}
		}
</%perl>

	<form method="post" action="forgot-password.html" id="ForgotPass">
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							If you know your user name, and you've already entered and
							confirmed your e-mail address, then we can send you
							your password.</li>

						<li>If you can't remember your user name, but can remember the
							e-mail address you used when you created your MusicBrainz
							account please enter the e-mail address into the field.</li>

						<li>If neither of the options work, you may <a href="/doc/ContactUs">contact us</a>,
							and we'll see if we can help you.</li>
					</ul>
				</td>
			</tr>

% 		if ($error ne "") {
			<tr>
				<td>&nbsp;</td>
				<td class="error">
					<ul><li><% $error %></li></ul></td>
			</tr>
% 		}
			<tr>
				<td class="label">
					<label for="id_username">User Name:</label></td>
				<td class="field">
					<input type="text" name="username" id="id_username" size="20" value="<% $username %>" /></td>
			</tr>
				<td class="label">
					<label for="id_email">E-mail address:</label></td>
				<td class="field">
					<input type="text" name="email" id="id_email" size="20" value="<% $email %>" /></td>
			<tr>
				<td>&nbsp;</td>
				<td class="field">
					<input type="submit" name="submit" value="Submit" /></td>
			</tr>
		</table>
	</form>
	<& /comp/movefocus, "ForgotPass", "username" &>

%	}

<& /comp/tableend &>
<& /comp/footer &>


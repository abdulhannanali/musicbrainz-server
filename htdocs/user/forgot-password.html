%# vi: set ts=4 sw=2 ft=mason :
<%args>
	$username => ""
</%args>
<%perl>
	my $error = "";

	$m->comp("/comp/sidebar", noh1 => 1);
	$m->comp("/comp/tablebegin", title => "Forgotten Password");

	if (&DBDefs::REPLICATION_TYPE == RT_SLAVE)
	{
		$m->out(qq!<div style="margin: 1em">!);
		$m->out(qq!  This is a mirror server -- you cannot retrieve your password from this server. !);
		$m->out(qq!</div>!);
		$m->out(qq!<div style="margin: 1em">!);
		$m->out(qq!  If you would like to retrieve your password, please go to the!);
		$m->out(qq!  <img src="/images/icon/extlink.gif" alt="" /> !);
		$m->out(qq!  <a href="http://musicbrainz.org/user/forgot-password.html">main server</a>.!);
		$m->out(qq!</div>!);
	}
	else
	{
		if ($session{uid})
		{
			return $m->comp("forgot-password-loggedin.inc")
		}
		else
		{
			if (MusicBrainz::IsSingleLineString($username)
				and $username =~ /\S/)
			{
				my $mb = $m->comp("/comp/dblogin");

				require UserStuff;
				my $user = UserStuff->new($mb->{DBH})->newFromName($username);
				if ($user)
				{
					$error = $user->SendPasswordReminder;
					return $m->comp("forgot-password-done.inc", $user)
						if $error eq "";

				} else {
					$error = "Sorry, there is no user by that name.";
				}
			}
		}
	}
</%perl>

	<form method="post" action="forgot-password.html" id="ForgotPass">
		<div class="fillfields">
			<ul>
				<li>
					If you know your user name, and you've already
					entered and confirmed your e-mail address, then we can send you
					your password.</li>

				<li>If you can't remember your user name, please
					<a href="/wd/ContactUs">contact us</a>,
					and we'll see if we can help you.</li>
			</ul>
		</div>

		<table class="loginform">

% 	if ($error) {
			<tr>
				<td></td>
				<td class="err">
					<ul><li><% $error %></li></ul>
					</td>
			</tr>
% }
			<tr>
				<td class="label">
					User Name:</td>
				<td>
					<input type="text" name="username" size="20" value="<% $username %>" /></td>
			</tr>
			<tr>
				<td></td>
				<td>
					<input type="submit" value="Submit" /></td>
			</tr>
		</table>
	</form>

<& /comp/tableend &>
<& /comp/movefocus, "ForgotPass", "username" &>
<& /comp/footer &>

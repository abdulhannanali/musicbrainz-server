<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows an user to request their password.
	#
	# $Id$
	#
</%perl>
<%args>

	$username => ""
	$email => ""
	$submitvalue => ""

</%args>
<%perl>

	# if user is logged in, redirect to profile page.
	return $m->comp("/comp/redirect", "/show/user/") if ($session{uid});

	my $error = "";

	$m->comp("/comp/sidebar-notitle", pagetitle => "Forgotten password");
	$m->comp("/comp/tablebegin", title => "Forgotten password");

	if (&DBDefs::REPLICATION_TYPE == RT_SLAVE)
	{
		$m->out(qq!<div style="margin: 1em">!);
		$m->out(qq!  This is a mirror server - you cannot retrieve your password from this server. !);
		$m->out(qq!</div>!);
		$m->out(qq!<div style="margin: 1em">!);
		$m->out(qq!  If you would like to retrieve your password, please go to the!);
		$m->out(qq!  <img src="/images/icon/extlink.gif" alt="" /> !);
		$m->out(qq!  <a href="http://musicbrainz.org/user/forgot-password.html">main server</a>.!);
		$m->out(qq!</div>!);
	}
	else
	{
		if ($session{"uid"})
		{
			return $m->comp("forgot-password-loggedin.inc")
		}
		if ($submitvalue ne "")
		{
			if ($submitvalue =~ m/cancel/i)
			{
				return $m->comp("/comp/redirect", "/login.html");
			}
			if ($username eq "" && $email eq "")
			{
				$error = "Please fill either the user name or the e-mail address field.";
			}
			else
			{
				require UserStuff;
				my $mb = $m->comp("/comp/dblogin");
				my $user = UserStuff->new($mb->{DBH});

				if (MusicBrainz::Server::Validation::IsSingleLineString($email)
					and $email =~ /\S/)
				{
					my $usernames = $user->LookupNameByEmail($email);
					if (scalar(@$usernames))
                    {
                        foreach $username (@$usernames)
                        {
                            $user = $user->newFromName($username);
                            if ($user)
                            {
                                $error = $user->SendPasswordReminder;
                                last if ($error ne "");
                            }
                        }
                        return $m->comp("forgot-password-done.inc", $user) if ($error eq '');
                    }
                    else
					{
						$error = "No account found with this e-mail address";
					}
				}

				if ($error eq "" &&
					MusicBrainz::Server::Validation::IsSingleLineString($username)
					and $username =~ /\S/)
				{
					$user = $user->newFromName($username);
					if ($user)
					{
						$error = $user->SendPasswordReminder;
						return $m->comp("forgot-password-done.inc", $user)
							if $error eq "";

					}
					else
					{
						$error = "Sorry, there is no user with this name.";
					}
				}
			}
		}

</%perl>

	<form method="post" action="forgot-password.html" id="ForgotPass">
		<table class="formstyle">
			<tr>
				<td colspan="2" class="instructions">
					<ul>
						<li>
							If you know your user name, and you've already entered and
							confirmed your e-mail address, then we can send you
							your password.</li>

						<li>If you can't remember your user name, but can remember the
							e-mail address you used when you created your MusicBrainz
							account, please enter the e-mail address into the field.</li>

						<li>If neither of the options work, you may <& /comp/linkdoc, "ContactUs",
							"contact us" &>, and we'll see if we can help you.</li>
					</ul>
				</td>
			</tr>
		</table>

		<table class="formstyle">

% 		if ($error ne "")
%		{

			<tr>
				<td>&nbsp;</td>
				<td class="error">
					<ul><li><% $error %></li></ul></td>
			</tr>

% 		}

			<tr>
				<td class="label">
					<label for="id_username">User name:</label></td>
				<td class="field">
					<input type="text" name="username" id="id_username" value="<% $username %>" style="width: 180px" /></td>
			</tr>
				<td class="label">
					<label for="id_email">E-mail address:</label></td>
				<td class="field">
					<input type="text" name="email" id="id_email" value="<% $email %>" style="width: 180px" /></td>
			<tr>
				<td>&nbsp;</td>
				<td class="submitbuttons">
					<input type="submit" name="submitvalue" value="Send Password &raquo;" />
					<input type="submit" name="submitvalue" value="Cancel" />
					<& /comp/form/focusfield, "id_username" &>
				</td>
			</tr>
		</table>
	</form>

%	}

<& /comp/tableend &>
<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

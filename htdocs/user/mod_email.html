<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page allows to send an e-mail to another editor.
	#
	# $Id$
	#
</%perl>
<%args>

	$uid => -1
	$modid => 0

	$revealaddress => 0
	$subject => ""
	$text => ""
	$url => ""

	$submitvalue => ""

</%args>
<%perl>

	$m->comp("/comp/checkloggedin", 1, 1,
		"You must be logged in to send a message to another moderator.",
	) or return;

	return if $m->comp("/comp/dbreadonly", 1, 1);

	MusicBrainz::IsNonNegInteger($uid) && $uid
		or return $m->comp("/comp/badargs", 1, 1);

	MusicBrainz::IsNonNegInteger($modid) && $modid
		or $modid = 0;

	$m->comp("/comp/sidebar-notitle", pagetitle => "Send email to editor");
	$m->comp("/comp/tablebegin", title => "Send email to editor");

	my $mb = $m->comp("/comp/dblogin");
	my $ui = UserStuff->new($mb->{DBH});
	my $me = $ui->newFromId($session{uid});
	my $you = $ui->newFromId($uid);

	my @messages = ();
	my $disableform = 0;

	if (not $me)
	{
		push @messages, qq!Cannot find editor with <strong>userid</strong> $session{"uid"}!;
		$disableform = 1;
	}
	if (not $you)
	{
		push @messages, qq!Cannot find editor with <strong>userid</strong> $uid!;
		$disableform = 1;
	}
	if ($you and !$you->CheckEMailAddress)
	{
		push @messages, qq!The editor !.$you->GetName.qq!has declined to give an e-mail
							address, which means you can't mail them. :-(!;
		$disableform = 1;
	}

	if ($submitvalue ne "")
	{
		if ($subject and $text)
		{
			if ($modid)
			{
				$text = "Edit: http://" . &DBDefs::WEB_SERVER .
						"/show/edit/?editid=$modid\n\n" . $text;
			}
			my $ret = $me->SendMessageToUser(
					to => $you,
					revealaddress => $revealaddress,
					subject => $subject,
					body => $text);
			if ($ret)
			{
				push @messages, qq!Error while sending e-mail: $ret!;

			}

			if (@messages == 0)
			{

				$m->out(qq!E-mail has been sent to $you->GetName!);
				if ($url)
				{
					$m->out(qq!<p>[ <a href="$url">Continue</a> ]!);
				}
				$m->comp("/comp/tableend");
				$m->comp("/comp/footer");
				return undef;
			}
		}
		else
		{
			push @messages, qq!Please enter a subject and a text.!;
		}
	}
	else
	{
		$subject ||= "About edit #$modid" if $modid;
	}

</%perl>

		<form method="post" action="/user/mod_email.html" id="EMailForm">


%	if ($modid)
%	{
			<div style="border: 1px solid #000; padding: 5px; margin-bottom: 15px">
				<strong>Please note:</strong> Please use the moderation notes system
				to communicate with fellow editors. others might be interested in
				what you have to say, too!
			</div>

%	}

			<table class="formstyle">

%	if (@messages > 0)
%	{
				<tr>
					<td>&nbsp;</td>
					<td class="error">
						<ul>
							<li><%perl> $m->out(join("</li><li>", @messages)); </%perl></li>
						</ul>
					</td>
				</tr>
%	}
				<tr>
					<td class="label">
						To:</td>
					<td>
						<% $you ? $you->GetName : "?" %></td>
				</tr>
				<tr>
					<td class="label">Subject:</td>
					<td>
						<input type="text" name="subject" size="40" value="<% $subject %>"
% 	$m->out(qq! readonly="readonly" !) if ($disableform);
						/></td>
				</tr>
				<tr class="top">
					<td class="label">Message:</td>
					<td>
						<textarea name="text" cols="60" rows="20"
% 	$m->out(qq! readonly="readonly" !) if ($disableform);
% 	$m->out(qq! style="width: 100%" !) if ($pnotes{'ispopup'});

						></textarea>
						<input type="hidden" name="uid" value="<% $uid %>" />
						<input type="hidden" name="url" value="<% $url %>" />
						<input type="hidden" name="modid" value="<% $modid %>" />
						<input type="hidden" name="ispopup" value="<% $pnotes{'ispopup'} %>" /></td>
				</tr>
%	if ($me->GetEmail)
%	{
				<tr>
					<td class="label"></td>
					<td>
						<input type="checkbox" name="revealaddress" <%
							UserPreference::get('reveal_address_when_mailing')
							? "checked" : "" %>
						/> Reveal my e-mail address [&nbsp;<a href="/popup/RevealMyEmailAddress" title="POPUP::Reveal_My_Email_Address::400::400">help</a>&nbsp;]</td>
				</tr>
%	}
				<tr>
					<td></td>
					<td>
						<input type="submit" name="submitvalue" value="Send Message &raquo;"
% 	$m->out(qq! disabled="disabled" !) if ($disableform);
						/></td>
				</tr>
			</table>
		</form>

		<& /comp/movefocus, "EMailForm", $subject ? "text" : "subject" &>

	<& /comp/tableend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

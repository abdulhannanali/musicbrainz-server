%# vi: set ts=2 sw=2 ft=mason :
<%args>
$uid=>-1
$modid=>0
$revealaddress=>0
$subject=>""
$text=>""
$url=>""
</%args>
<%perl>

$m->comp(
	"/comp/checkloggedin", 1, 1,
	"You must be logged in to send a message to another moderator.",
) or return;

return if $m->comp("/comp/dbreadonly", 1, 1);

MusicBrainz::IsNonNegInteger($uid) && $uid
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($modid) && $modid
	or $modid = 0;

$m->comp("/comp/sidebar", title => 'Send email to moderator');

my $mb = $m->comp("/comp/dblogin");
my $ui = UserStuff->new($mb->{DBH});
my $me = $ui->newFromId($session{uid});
my $you = $ui->newFromId($uid);

if (not $me)
{
		</%perl>
		<p>Cannot find user with user id <% $session{uid} %>.</p>
		<& /comp/footer &>
		<%perl>
		return undef;
}

if (not $you)
{
		</%perl>
		<p>Cannot find user with user id <% $uid %>.</p>
		<& /comp/footer &>
		<%perl>
		return undef;
}

if (not $you->CheckEMailAddress)
{
		</%perl>
		<p>
			Moderator <% $you->GetName %> has declined to give an email
			address, which means you can't mail this moderator. :-(
		</p>
		<%perl>

		if ($url)
		{
				</%perl>
				<p>[ <a href="<% $url %>">Continue</a> ]</p>
				<%perl>
		}

		$m->comp("/comp/footer");
		return undef;
}

if ($subject and $text)
{
	if ($modid)
	{
		$text = "Moderation: http://" . &DBDefs::WEB_SERVER .
			"/showmod.html?modid=$modid\n\n" . $text;
	}

	my $ret = $me->SendMessageToUser(
		to						=> $you,
		revealaddress => $revealaddress,
		subject				=> $subject,
		body					=> $text,
	);

	if ($ret)
	{
		</%perl>
		<p>Could not send email: <% $ret %></p>
		<%perl>
	}
	else
	{
		</%perl>
		<p>Mail has been sent to <% $you->GetName %>.</p>
		<%perl>
	}

	if ($url)
	{
		</%perl>
		<p>[ <a href="<% $url %>">Continue</a> ]</p>
		<%perl>
	}
}
else
{
	$subject ||= "About moderation #$modid" if $modid;
		</%perl>

		<form METHOD="POST" ACTION="/user/mod_email.html" ID="EMailForm"
					ENCTYPE="application/x-www-form-urlencoded" class="formstyle"
					style="padding: 0 0.5em"
					>

			<p style="margin: 0.5em">
				 <span class="font-style: bold">To:</span>
				 <% $you->GetName %>
			</p>

% if ($me->GetEmail) {
			<p style="margin: 0.5em">
				<input type="checkbox" name="revealaddress" <%
					UserPreference::get('reveal_address_when_mailing')
					? "checked" : ""
					%>>
				Reveal my e-mail address
				[&nbsp;<a href="/products/server/docs/20040103-1.html" id="POPUP::Reveal_My_E-mail_Adress::400::400">help</a>&nbsp;]

			</p>
% }

			<p style="margin: 0.5em">
				Subject:<br>
				<INPUT TYPE="text" NAME="subject" SIZE="40" VALUE="<% $subject %>">
			</p>

			<p style="margin: 0.5em">
				Message Text:<br>
				<TEXTAREA NAME="text" COLS="60" ROWS="20"
% if ($pnotes{'ispopup'}) {
					style="width: 100%"
% }
					></TEXTAREA>
				<INPUT TYPE="hidden" NAME="uid" VALUE="<% $uid %>">
				<INPUT TYPE="hidden" NAME="url" VALUE="<% $url %>">
				<INPUT TYPE="hidden" NAME="modid" VALUE="<% $modid %>">
				<input type="hidden" name="ispopup" value="<% $pnotes{'ispopup'} %>">
			</p>

			<p style="text-align: center">
				<INPUT TYPE="submit" NAME="Send" VALUE="Send">
			</p>

		</form>

		<& /comp/movefocus, "EMailForm", $subject ? "text" : "subject" &>
		<%perl>
}

</%perl>

<& /comp/footer &>

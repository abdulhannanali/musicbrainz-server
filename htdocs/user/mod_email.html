%# vi: set ts=2 sw=2 ft=mason :
<%args>
$uid=>-1
$modid=>0
$subject=>""
$text=>""
$url=>""
</%args>
<%perl>

return if $m->comp("/comp/dbreadonly", 1, 1);

MusicBrainz::IsNonNegInteger($uid) && $uid
	or return $m->comp("/comp/badargs", 1, 1);

MusicBrainz::IsNonNegInteger($modid) && $modid
	or $modid = 0;

$m->comp("/comp/sidebar", title => 'Send email to moderator');

my $mb = $m->comp("/comp/dblogin");
my $ui = UserStuff->new($mb->{DBH});
my $me = $ui->newFromId($session{uid});
my $you = $ui->newFromId($uid);

if (not $me)
{
		</%perl>
		<p>Cannot find user with user id <% $session{uid} %>.</p>
		<& /comp/footer &>
		<%perl>
		return undef;
}

if (not $you)
{
		</%perl>
		<p>Cannot find user with user id <% $uid %>.</p>
		<& /comp/footer &>
		<%perl>
		return undef;
}

if (not $you->CheckEMailAddress)
{
		</%perl>
		<p>
			Moderator <% $you->GetName %> has declined to give an email 
			address, which means you can't mail this moderator. :-(
		</p>
		<%perl>
	 
		if ($url)
		{
				</%perl>
				<p>[ <a href="<% $url %>">Continue</a> ]</p>
				<%perl>
		}

		$m->comp("/comp/footer");
		return undef;
}

if ($text)
{
	if ($modid)
	{
		$text = "Moderation: http://" . &DBDefs::WEB_SERVER . 
			"/showmod.html?modid=$modid\n\n" . $text;
	}

	my $ret = $me->SendMessageToUser($subject, $text, $you);

	if ($ret)
	{
		</%perl>
		<p>Could not send email: <% $ret %></p>
		<%perl>
	}
	else
	{
		</%perl>
		<p>Mail has been sent to <% $you->GetName %>.</p>
		<%perl>
	}

	if ($url)
	{
		</%perl>
		<p>[ <a href="<% $url %>">Continue</a> ]</p>
		<%perl>
	}
}
else
{
		</%perl>

		<form METHOD="POST" ACTION="/user/mod_email.html" ID="EMailForm"
					ENCTYPE="application/x-www-form-urlencoded" class="formstyle"
					style="padding: 0 0.5em"
					>

			<p style="margin: 0.5em">
				 <span class="font-style: bold">To:</span>
				 <% $you->GetName %>
			</p>

			<p style="margin: 0.5em">
				Subject:<br>
%           if ($modid > 0) {
						<INPUT TYPE="text" NAME="subject" SIZE="40" VALUE="About moderation #<% $modid %>">
%           } else {
						<INPUT TYPE="text" NAME="subject" SIZE="40">
%           }
			</p>

			<p style="margin: 0.5em">
				Message Text:<br>
				<TEXTAREA NAME="text" COLS="60" ROWS="20"></TEXTAREA>
				<INPUT TYPE="hidden" NAME="uid" VALUE="<% $uid %>">
				<INPUT TYPE="hidden" NAME="url" VALUE="<% $url %>">
				<INPUT TYPE="hidden" NAME="modid" VALUE="<% $modid %>">
			</p>

			<p style="text-align: center">
				<INPUT TYPE="submit" NAME="Send" VALUE="Send">
			</p>
			
		</form>

		<& /comp/movefocus, "EMailForm", "Subject" &>
		<%perl>
}

</%perl>

<& /comp/footer &>

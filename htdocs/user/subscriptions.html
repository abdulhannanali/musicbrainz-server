<%perl>
	# -----------------------------------------------------------------------------
	#                               Musicbrainz.org
	#                        Copyright (c) 2001 Robert Kaye
	# -----------------------------------------------------------------------------
	#  This software is provided "as is", without warranty of any kind, express or
	#  implied, including  but not limited  to the warranties of  merchantability,
	#  fitness for a particular purpose and noninfringement. In no event shall the
	#  authors or  copyright  holders be  liable for any claim,  damages or  other
	#  liability, whether  in an  action of  contract, tort  or otherwise, arising
	#  from,  out of  or in  connection with  the software or  the  use  or  other
	#  dealings in the software.
	#
	#  GPL - The GNU General Public License    http://www.gnu.org/licenses/gpl.txt
	#  Permits anyone the right to use and modify the software without limitations
	#  as long as proper  credits are given  and the original  and modified source
	#  code are included. Requires  that the final product, software derivate from
	#  the original  source or any  software  utilizing a GPL  component, such  as
	#  this, is also licensed under the GPL license.
	# -----------------------------------------------------------------------------
	#
	# Summary:
	# -----------------------------------------------------------------------------
	# This page shows the subscribed artists of a given user.
	#
	# $Id$
	#
</%perl>
<%args>

	$user => undef

</%args>
<%perl>

	my $mb = $m->comp("/comp/dblogin");

	if (defined $user)
	{
		# make sure we got a valid user parameter
		MusicBrainz::Server::Validation::IsNonNegInteger($user)
			or return $m->comp("/comp/layout/badarguments",
				text => "The argument <strong>user</strong> is missing or has a wrong format.");
	}
	else
	{
		# only logged in users can view their own subscriptions. interesting enough :)
		$m->comp("/comp/checkloggedin", 1, 1,
			"You must log in to manage your subscriptions.",
		) or return;
		$user = $session{uid};
	}

	# load current user.
	my $is_me = ($user == $session{uid});
	my $them = UserStuff->newFromId($mb->{DBH}, $user)
		or return $m->comp("/comp/error", "There is no user #$user", 1, 1);

	# see if other users has their subscriptions public.
	unless ($is_me)
	{
		UserPreference::get_for_user("subscriptions_public", $them)
			or return $m->comp("subscriptions.inc", user => $them, private => 1);
	}

	# load subscriptions
	my $subs = UserSubscription->new($mb->{DBH});
	$subs->SetUser($user);
	my $info = $subs->GetSubscribedArtists;
	@$info = grep { defined $_->{name} } @$info;

	# show public subscriptions of another user if the user we're
	# are displaying the subscriptions of is not the current user.
	return $m->comp("subscriptions.inc", user => $them, info => $info)
		unless $is_me;

</%perl>


<& /comp/sidebar-notitle, pagetitle => "Your Artist subscriptions" &>

	<& /comp/tablebegin, title => "Your Artist subscriptions" &>

		<table class="formstyle">
			<tr class="top">
				<td class="label">Profile:</td>
				<td>
					[
					<a href="/show/user/">Profile &amp; Statistics</a>
					| <a href="/user/edit.html">Edit</a>
					| <a href="/user/change-password.html">Change Password</a>
					| <a href="/user/preferences.html">Preferences</a>
					]
				</td>
			</tr>

% 		unless ($session{has_confirmed_email})
%		{

			<tr class="spaced">
				<td>&nbsp;</td>
				<td>
					<& /comp/form/feedbackbox, "warning", "You have not provided an e-mail address!",
						qq!	To receive notice of when edits are entered against your
							subscribed artists, please <a href="/user/edit.html">edit
							your profile</a> and provide an e-mail address.! &>
				</td>
			</tr>

% 		}


			<tr class="spaced top">
				<td class="label">Subscriptions:</td>
				<td>

% 	if (not @$info)
%	{

					You are not currently subscribed to any artists.&nbsp;
					To subscribe to an artist, click the "Subscribe" link
					on the artist's page.

% 	}
%	else
%	{

					You are currently subscribed to <% (@$info == 1) ? "this artist" :
					"these <strong>".scalar(@$info)."</strong> artists" |n %>. To
					unsubscribe, activate the checkbox next to the artists you would
					like to unsubscribe from, then click the button below. To subscribe
					to an artist, use the "Subscribe" link on the artist's page.
%	}


				</td>
			</tr>


% 	if (@$info)
%	{

			<tr>
				<td colspan="2">&nbsp;</td>
			</tr>
			<tr>
				<td>&nbsp;</td>
				<td>

%		my $row = 0;
%		my @colours = ('#fff', '#ffe1b7');

					<form method="post" action="/user/subscribe.html">
						<table class="artistfilter-listing">

% 		for my $artist (@$info)
%		{

							<tr class="row<% $row++ % 2 %>">
								<td><input type="checkbox" name="artistid" value="<% $artist->{artist} %>" /></td>
								<td class="padright">
									<& /comp/linkartist, id => $artist->{artist},
										name => $artist->{name}, resolution =>  $artist->{resolution},
										strong => 0 &></td>
								<td>[ <a href="/mod/search/pre/artist.html?artistid=<% $artist->{artist} %>">View edits</a> ]</td>
							</tr>
% 		}

							<tr>
								<td colspan="3">&nbsp;</td>
							</tr>
							<tr>
								<td colspan="3">
									<input type="hidden" name="unsubscribe" value="1" />
									<input type="submit" value="Unsubcribe selected artists &raquo;" />
								</td>
							</tr>
						</table>
					</form>
				</td>
			</tr>

% 	}

		</table>

	<& /comp/tableend &>

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

%# vi: set ts=4 sw=4 ft=mason :
<%args>
$user => undef
</%args>
<%perl>

my $mb = $m->comp("/comp/dblogin");

if (defined $user)
{
	MusicBrainz::IsNonNegInteger($user)
		or return $m->comp("/comp/badargs", 1, 1);
} else {
	$m->comp(
		"/comp/checkloggedin", 1, 1,
		"You must log in to manage your subscriptions.",
	) or return;
	$user = $session{uid};
}

my $is_me = ($user == $session{uid});

my $them = UserStuff->newFromId($mb->{DBH}, $user)
	or return $m->comp("/comp/error", "There is no user #$user", 1, 1);

unless ($is_me)
{
	UserPreference::get_for_user("subscriptions_public", $them)
		or return $m->comp("subscriptions-private.inc", user => $them);
}

my $subs = UserSubscription->new($mb->{DBH});
$subs->SetUser($user);

my $info = $subs->GetSubscribedArtists;
@$info = grep { defined $_->{name} } @$info;

return $m->comp("subscriptions-public.inc", user => $them, info => $info)
	unless $is_me;


$m->comp("/comp/sidebar", title => 'Artist Subscriptions');

</%perl>

<p class="LinksRow">
	[
	<a href="/user/view.html">Profile &amp; Statistics</a>
	| <a href="/user/edit.html">Edit</a>
	| <a href="/user/change-password.html">Change Password</a>
	| <a href="/prefs.html">Preferences</a>
	]
</p>

% unless ($session{has_confirmed_email}) {
	<p class="notice">
		<span class="red">You have not provided an e-mail address!</span>
		<br />
		To receive notice of when moderations are added to your
		subscribed artists, please
		<a href="/user/edit.html">edit your profile</a>
		and provide an e-mail address.
   </p>
% }

% if (not @$info) {

	<p>
		You are not currently subscribed to any artists.&nbsp;
		To subscribe to an artist, click the "Subscribe" link
		on the artist's page.
	</p>

% } else {

	<p>
		You are currently subscribed to
		<% (@$info == 1) ? "this artist" : "these ".scalar(@$info)." artists" %>.&nbsp;
		To unsubscribe, tick the "unsubscribe" box next to the
		subscriptions you want to delete,
		then click the button below.&nbsp;
		To subscribe to an artist, click the "Subscribe" link
		on the artist's page.
	</p>

% my $row = 0;
% my @colours = ('#fff', '#ffe1b7');

	<form class="Subs" method="post" action="/user/subscribe.html">
		<table class="Subs">
			<caption>Subscribed Artists</caption>
			<col class="c1" />
			<col class="c2" />
			<col class="c3" />
% for my $artist (@$info) {
<tr class="r<% $row++ % 2 %>">
<td><input type="checkbox" name="artistid" value="<% $artist->{artist} %>" /></td>
<td class="a"><a href="/showartist.html?artistid=<% $artist->{artist} %>"><% $artist->{name} %></a> <% $artist->{resolution} ? "($artist->{resolution})" : "" %></td>
<td>[ <a href="/mod/search/pre/artist.html?artistid=<% $artist->{artist} %>">Edits</a> ]</td>
</tr>
% }
		</table>
		<p>
			<input type="hidden" name="unsubscribe" value="1" />
			<input type="submit" value="Delete selected subscriptions" />
		</p>
	</form>

% }

<& /comp/footer &>

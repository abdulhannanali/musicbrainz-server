<%args>
	$tag => ''
    $show => 'all'
    $offset => 0
	$userid => $session{uid}
</%args>

<%perl>

	MusicBrainz::Server::Validation::IsNonNegInteger($offset)
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>offset</strong> has wrong format.");

	($show eq 'all' || $show eq 'artist' || $show eq 'label' || $show eq 'track' || $show eq 'release')
		or return $m->comp("/comp/layout/badarguments",
			text => "The argument <strong>show</strong> must be all, artist, label, track or release.");

	# Instantiate MusicBrainz object, and load entity
	my $mb = $m->comp("/comp/dblogin");
	$m->comp("/comp/checkloggedin", 1, 1, undef, 1)
		or return;

	my $user;
	my $is_me = ($userid == $session{uid});
	if (!$is_me) {
		$user = UserStuff->newFromId($mb->{DBH}, $userid)
			or return $m->comp("/comp/error", "There is no user with id #$userid", 1, 1);
	}

	my $t = MusicBrainz::Server::Tag->new($mb->{DBH});
	my ($entities, $numitems);

    if (!$tag)
    {
        </%perl>
        <& /comp/sidebar, pagetitle => "Tag details" &>

        <form method="post" action="/show/tag/index.html">
        <p>
        Enter a tag name to display:
        <input type="text" size="15" name="tag"/>
        </p>
        <br/>
        <input type="submit" value="Show details"/>
        </form>
        <& /comp/footer &>
        <%perl>
        return undef;
    }
</%perl>

<& /comp/sidebar, pagetitle => ($is_me ? "My" : $user->GetName . "'s") . " Tag Details: $tag" &>

[ <a href="/show/tag/all.html">Show all tags</a> | <a href="/user/tags/?userid=<% $userid %>">Show <% ($is_me ? "my" : $user->GetName . "'s") %> tags</a> |
 show tag <% $tag %> for:
% if ($show ne 'all') {
    <a href="/user/tags/tag.html?userid=<% $userid %>&amp;tag=<% uri_escape($tag) %>&amp;show=all">all</a> |
% }
% if ($show eq 'artist') {
    artists |
% } else {
    <a href="/user/tags/tag.html?userid=<% $userid %>&amp;tag=<% uri_escape($tag) %>&amp;show=artist">artists</a> |
% }
% if ($show eq 'label') {
    labels |
% } else {
    <a href="/user/tags/tag.html?userid=<% $userid %>&amp;tag=<% uri_escape($tag) %>&amp;show=label">labels</a> |
% }
% if ($show eq 'release') {
    releases |
% } else {
    <a href="/user/tags/tag.html?userid=<% $userid %>&amp;tag=<% uri_escape($tag) %>&amp;show=release">releases</a> |
% }
% if ($show eq 'track') {
    tracks ]
% } else {
    <a href="/user/tags/tag.html?userid=<% $userid %>&amp;tag=<% uri_escape($tag) %>&mp;show=track">tracks</a> ]
% }

%	my @types = ($show eq 'all') ? ("artist", "label", "release", "track") : ($show);
%	my $limit = ($show eq 'all') ? 10 : 100;
%	for my $type (@types) {
		<h2><% ucfirst($type) %>s</h2>
%		($entities, $numitems) = $t->GetEntitiesForRawTag($type, $tag, $userid, $limit, $offset);
%		if ($numitems) {
			<table>
%				for my $entity (@$entities) {
					<tr>
						<td><& "/comp/link".$type,
							id => $entity->{"id"},
							mbid => $entity->{"gid"},
							name => $entity->{"name"}
						&></td>
						<td><% $entity->{"count"} %></td>
					</tr>
%				}
			</table>
%		}
%		if ($numitems > $limit) {
%			if ($show eq 'all') {
				<p><a href="/show/tag/?tag=<% uri_escape($tag) %>&show=<% $type %>">More...</a></p>
%			}
%			else {
				<& /comp/browse/pageselector, numitems => $numitems,
					offset=> $offset,
					numlinks => 6,
					pagesize=> $limit,
					url => "/user/tags/tag.html",
					args => { "tag" => $tag, "show" => $type, "userid" => $userid }
				&>
%			}
%		}
%	}

<& /comp/footer &>

%# vi: set ts=4 sw=4 ft=mason :

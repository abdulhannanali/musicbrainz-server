%# vi: set ts=4 sw=4 ft=mason :
<%args>
$uid => ($session{uid} || undef)
$modname => undef
</%args>
<%def .JumpForm>

<form method="get" action="/user/view.html" id="ModeratorForm">
	<p>
		Look up a moderator by name:
		<input type="text" name="modname" size="20">
		<input type="submit" value="Go">
	</p>
</form>

<& /comp/movefocus, "ModeratorForm", "modname" &>

</%def>
<%def .ShowError>
% my $error = shift;

		<& /comp/sidebar, title => 'Enter name of moderator to view' &>

% if ($error) {
		<p class="notice"><% $error %></p>
% }

		<& .JumpForm &>
		<& /comp/footer &>

</%def>
<%perl>

# /moderator.html used to do about three different things:
# - view a user
# - show a user-edit form
# - process that form and show responses
# This page now just does the "view" bit.

my $user;

if (MusicBrainz::IsSingleLineString($modname) and $modname ne "")
{
	my $mb = $m->comp("/comp/dblogin");
	my $ui = UserStuff->new($mb->{DBH});

	$user = $ui->newFromName($modname)
		or return $m->comp(".ShowError", "Moderator '$modname' not found");
}
elsif (MusicBrainz::IsNonNegInteger($uid) and $uid)
{
	my $mb = $m->comp("/comp/dblogin");
	my $ui = UserStuff->new($mb->{DBH});

	$user = $ui->newFromId($uid)
		or return $m->comp(".ShowError", "Moderator #$uid not found");
}

$user or return $m->comp(".ShowError", undef);

my $membersince;

if ($user->GetId == &ModDefs::ANON_MODERATOR
	or $user->GetId == &ModDefs::FREEDB_MODERATOR
	or $user->GetId == &ModDefs::MODBOT_MODERATOR)
{
    $membersince = 'n/a';
} elsif ($user->GetMemberSince =~ /^1970-01-01 /) {
    $membersince = '<font class="bold">Charter Member</font>';
} elsif ($user->GetName eq "rob") {
    $membersince = '<font class="bold">the dawn of this project</font>';
} else {
	$membersince = $m->comp("/comp/datetime", $user->GetMemberSince);
}
	
$uid = $user->GetId;

my $my_uid = $session{uid} || 0;
my $is_me = ($uid == $my_uid);

my $can_nominate = (
	not $is_me
	and UserStuff->IsAutoMod($session{privs})
	and not UserStuff->IsAutoMod($user->GetPrivs)
	and not MusicBrainz::Server::AutomodElection->is_user_ineligible($user)
);

</%perl>

<& /comp/sidebar, title => 'Moderator "' . $user->GetName . '"' &>

<p class="LinksRow">
	[
% unless ($is_me) {
	<a href="/user/mod_email.html?uid=<% $uid %>&amp;url=<% uri_escape("/user/view.html?uid=$uid") %>">Send email</a> | 
% }
    <a href="/mod/search/pre/voted.html?moderator=<% $uid %>">List Votes</a> |
	<a href="/mod/search/pre/moderator.html?moderator=<% $uid %>">List Moderations</a> |
	<a href="/mod/search/pre/moderator-failed.html?moderator=<% $uid %>">List Failed Moderations</a>
% if ($can_nominate) {
	| <a href="/user/election/propose.html?modname=<% $user->GetName |nuh %>">Nominate for Auto-Mod</a>
% }
	]
</p>

% if ($is_me) {
<p class="LinksRow">
	[
	<a href="/user/edit.html">Edit</a>
	| <a href="/user/change-password.html">Change Password</a>
	| <a href="/prefs.html">Preferences</a>
	| <a href="/user/subscriptions.html">Subscriptions</a>
	]
</p>
% }

<table>
	<tr>
		<td colspan="2"><b>General information:</b></td>
	</tr>
	<tr>
		<td width="15%" valign="top" align="right">Name:</td>
		<td><% $user->GetName %></td>
	</tr>
	<tr>
		<td width="15%" valign="top" align="right">User type:</td>
		<td><% $user->GetUserType %></td>
	</tr>
	<tr>
		<td valign="top" align="right">EMail:</td>
% if ($is_me) {
		<td><% $user->GetEmail || "[none]" %></td>
% } else {
		<td><% $user->GetEmail ne '' ? "[email address stored, but not shown]" : "[none]" %></td>
% }
	</tr>

	<tr>
		<td valign="top" align="right">Homepage:</td>
%   if (my $url = $user->GetWebURLComplete) {
			<td><a href="<% $url %>"><% $url %></a></td>
%   } else {
			<td>[none]</td>
%   }
	</tr>

	<tr>
		<td valign="top" align="right">Bio:</td>
		<td><%perl>
			my $bio = $user->GetBio;

			if ($bio)
			{
				$bio =~ s/<p>/\n/g;
				$bio = encode_entities($bio);
				$bio = join "",
					map { "<p>$_</p>" }
					split /\n/, $bio;
			} else {
				$bio = "[none]";
			}

			$m->out($bio);
		</%perl></td>
	</tr>

	<tr>
		<td colspan="2">&nbsp;</td>
	</tr>
	<tr>
		<td colspan="2"><b>User statistics:</b></td>
	</tr>
	<tr>
		<td valign="top" align="right">Member Since:</td>
		<td valign="top"><% $membersince |n %></td>
	</tr>
	<tr>
		<td valign="top" align="right"><% $user->GetModsAccepted %></td>
		<td valign="top">moderations accepted (excludes automods)</td>
	</tr>
	<tr>
		<td valign="top" align="right"><% $user->GetAutoModsAccepted %></td>
		<td valign="top">automods entered</td>
	</tr>
	<tr>
		<td valign="top" align="right"><% $user->GetModsRejected %></td>
		<td valign="top">moderations voted down</td>
	</tr>
	<tr>
		<td valign="top" align="right"><% $user->GetModsFailed %></td>
		<td valign="top">moderations failed for other reasons</td>
	</tr>

	<tr>
		<td colspan="2">&nbsp;</td>
	</tr>

<%perl>

# Retrieve vote statistics
my $votes = MusicBrainz::Server::Vote->new($user->{DBH});

my $allvotes = $votes->AllVotesForUser_as_hashref($uid);
my $recentvotes = $votes->RecentVotesForUser_as_hashref($uid);

for ($allvotes, $recentvotes)
{
	my $t = 0;
	$t += $_ for values %$_;
	$_->{"TOTAL"} = $t;
}

</%perl>

	<tr>
		<td valign="top"><b>Votes:</b></td>
		<td valign="top">
			<table>
				<tr>
					<td></td>
					<td style="font-weight: bold; text-align: center" colspan="2">Last 28 days</td>
					<td style="font-weight: bold; text-align: center" colspan="2">All time</td>
				</tr>
				<%perl>
				for (
					[ "Yes", &ModDefs::VOTE_YES ],
					[ "No", &ModDefs::VOTE_NO ],
					[ "Abstain", &ModDefs::VOTE_ABS ],
					[ "Total", "TOTAL" ],
				) {
					my ($name, $vote) = @$_;

					$m->out("<tr><td>$name</td>");

					for my $h ($recentvotes, $allvotes)
					{
						my $c = $h->{$vote} || 0;
						my $pc = 100 * $c / ($h->{"TOTAL"}||1);
						$pc = int($pc + 0.5);
						$m->out("<td align='right'>&nbsp; $c</td><td align='right'>&nbsp; ($pc\%)</td>");
					}

					$m->out("</tr>");
				}

				</%perl>
			</table>
		</td>
	</tr>

</table>

<h2>Find Moderator by Name</h2>
<& .JumpForm &>

<& /comp/footer &>
